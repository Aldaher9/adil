// --- Ø§Ù„ØªÙƒÙˆÙŠÙ† ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
const firebaseConfig = {
  apiKey: "AIzaSyC4NddjijF29YNhowy4SqgRaMPn01oSSEg",
  authDomain: "school-9416e.firebaseapp.com",
  projectId: "school-9416e",
  storageBucket: "school-9416e.firebasestorage.app",
  messagingSenderId: "680872052240",
  appId: "1:680872052240:web:96d2e544166ab5f8096c95"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
let currentUser = null;
let data = { teachers: {}, classes: {}, subjects: {}, lessons: [], periods: [] };
let phones = {};
let tasks = [];
let visits = [];
let isSim = false, sDay = 1, sTime = "08:00";

// --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Auth) ---
auth.onAuthStateChanged(user => {
    if (user) {
        currentUser = user;
        document.getElementById('login-screen').style.display = 'none';
        document.body.style.display = 'block';
        document.getElementById('mainNav').style.display = 'flex';
        document.getElementById('welcomeMsg').innerText = "ğŸ‘¤ Ù…Ø±Ø­Ø¨Ø§Ù‹: " + user.displayName;
        loadUserData();
    } else {
        document.body.style.display = 'block'; // Body visible for login screen
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('mainNav').style.display = 'none';
    }
});

async function handleGoogleLogin() {
    const btn = document.getElementById('loginBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...";
    
    try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
        // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ÙŠØªÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ø¨Ø± onAuthStateChanged
    } catch (error) {
        console.error(error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

function handleLogout() {
    if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
        auth.signOut().then(() => location.reload());
    }
}

// --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data Sync) ---
async function loadUserData() {
    try {
        const doc = await db.collection("users").doc(currentUser.uid).get();
        if(doc.exists) {
            const cloud = doc.data();
            data = cloud.schoolData || data;
            phones = cloud.phones || {};
            tasks = cloud.tasks || [];
            visits = cloud.visits || [];
            
            refreshUI();
        }
    } catch (e) { console.log("New user or load error"); }
}

async function syncToCloud() {
    if(!currentUser) return;
    await db.collection("users").doc(currentUser.uid).set({
        schoolData: data,
        phones: phones,
        tasks: tasks,
        visits: visits,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
}

function refreshUI() {
    refreshSchedule();
    updateDashboard();
    renderStaff();
    renderTasks();
    renderVisits();
}

// --- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Dashboard) ---
function updateDashboard() {
    document.getElementById('statTeachers').innerText = Object.keys(data.teachers || {}).length;
    document.getElementById('statClasses').innerText = Object.keys(data.classes || {}).length;
    document.getElementById('statVisits').innerText = visits.length;
    document.getElementById('statTasks').innerText = tasks.length;
}

// --- Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø­ØµØµ (Schedule) ---
function refreshSchedule() {
    const now = new Date();
    const d = isSim ? sDay : (now.getDay() === 0 ? 1 : now.getDay() + 1);
    const t = isSim ? sTime : now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0');
    
    document.getElementById('dashDate').innerText = t;
    document.getElementById('simBadge').style.display = isSim ? "block" : "none";

    const p = (data.periods || []).find(period => {
        const cur = toM(t), s = toM(period.s), e = toM(period.e);
        return cur >= s && cur <= e;
    });

    const list = document.getElementById('lessons-list');
    let infoText = "Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¯ÙˆØ§Ù…";

    if (p && data.lessons) {
        infoText = "Ø§Ù„Ø­ØµØ©: " + p.id;
        const currentLessons = data.lessons.filter(l => l.d == d && l.p == p.id);
        
        if (currentLessons.length > 0) {
            list.innerHTML = currentLessons.map(l => {
                const teacherName = data.teachers[l.t] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                const className = data.classes[l.c] || "..";
                const phone = (phones[teacherName] || "").replace(/\s+/g, '');
                const msg = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… Ø£Ø³ØªØ§Ø° ${teacherName}ØŒ Ù†Ø±Ø¬Ùˆ Ø§Ù„ØªÙˆØ§Ø¬Ø¯ ÙÙŠ Ø­ØµØ© ${className}.`;
                
                return `
                <div class="lesson-card">
                    <div class="class-badge">${className}</div>
                    <div style="flex:1; padding-right:15px;">
                        <div style="font-weight:bold;">${teacherName}</div>
                        <div style="font-size:12px; color:#64748b;">${data.subjects[l.s] || ''}</div>
                    </div>
                    <button onclick="window.open('https://wa.me/${phone}?text=${encodeURIComponent(msg)}')" class="msg-btn">ğŸ’¬</button>
                </div>`;
            }).join('');
        } else {
            list.innerHTML = `<div style="text-align:center; padding:30px; color:#94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</div>`;
        }
    } else {
        list.innerHTML = `<div style="text-align:center; padding:30px; color:#94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù†</div>`;
    }
    document.getElementById('dashPeriod').innerText = infoText;
}

// --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† (Staff) ---
function renderStaff() {
    const list = document.getElementById('staff-list');
    const allTeachers = Object.values(data.teachers || {}).sort();
    
    list.innerHTML = allTeachers.map(name => {
        const ph = phones[name] || "";
        return `
        <div class="staff-card filter-item">
            <div>
                <div style="font-weight:bold;">${name}</div>
                <div style="font-size:12px; color:#64748b;">${ph || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…'}</div>
            </div>
            <div style="display:flex; gap:5px;">
                <button onclick="updatePhone('${name}')" style="border:none; background:#f1f5f9; padding:5px; border-radius:5px;">âœï¸</button>
                <a href="tel:${ph}" style="text-decoration:none; font-size:20px;">ğŸ“</a>
            </div>
        </div>`;
    }).join('');
}

function updatePhone(name) {
    const p = prompt(`Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ: ${name}`, phones[name] || "");
    if(p !== null) { phones[name] = p; renderStaff(); syncToCloud(); }
}

function filterStaff() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('.filter-item').forEach(el => {
        el.style.display = el.innerText.toLowerCase().includes(q) ? 'flex' : 'none';
    });
}

// --- Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø´Ø±Ø§ÙÙŠØ© (Visits) ---
function renderVisits() {
    const list = document.getElementById('visits-list');
    list.innerHTML = visits.map(v => `
        <div class="staff-card" style="display:block;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <b>${v.teacher}</b>
                <span style="font-size:12px; color:#64748b;">${new Date(v.date).toLocaleDateString('ar-EG')}</span>
            </div>
            <div style="font-size:13px; color:#334155;">${v.notes}</div>
        </div>
    `).join('');
}

function openVisitModal() {
    const sel = document.getElementById('visitTeacher');
    sel.innerHTML = Object.values(data.teachers).map(t => `<option value="${t}">${t}</option>`).join('');
    openModal('visitModal');
}

function saveVisit() {
    const t = document.getElementById('visitTeacher').value;
    const n = document.getElementById('visitNotes').value;
    if(t && n) {
        visits.unshift({ teacher: t, notes: n, date: new Date().toISOString() }); // Add to top
        syncToCloud();
        renderVisits();
        updateDashboard();
        closeModal('visitModal');
        document.getElementById('visitNotes').value = "";
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
function printFullReport() {
    if (visits.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù„Ø·Ø¨Ø§Ø¹ØªÙ‡Ø§");

    const printWindow = window.open('', '_blank');
    let html = `
    <html dir="rtl">
    <head>
        <title>Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø´Ø±Ø§ÙÙŠØ©</title>
        <style>
            body { font-family: 'Tajawal', sans-serif; padding: 20px; }
            h2 { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #999; padding: 10px; text-align: right; }
            th { background-color: #f3f4f6; }
            tr:nth-child(even) { background-color: #f9fafb; }
        </style>
    </head>
    <body>
        <h2>Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø´Ø±Ø§ÙÙŠØ©</h2>
        <table>
            <thead>
                <tr>
                    <th width="5%">#</th>
                    <th width="15%">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th width="25%">Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                    <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª / Ø§Ù„ØªÙˆØµÙŠØ§Øª</th>
                </tr>
            </thead>
            <tbody>`;
    
    visits.forEach((v, i) => {
        html += `
            <tr>
                <td>${i + 1}</td>
                <td>${new Date(v.date).toLocaleDateString('ar-EG')}</td>
                <td>${v.teacher}</td>
                <td>${v.notes}</td>
            </tr>`;
    });

    html += `</tbody></table>
    <script>window.onload = function() { window.print(); }</script>
    </body></html>`;
    
    printWindow.document.write(html);
    printWindow.document.close();
}

// Ø¯Ø§Ù„Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON Ù„Ù„Ø²ÙŠØ§Ø±Ø§Øª (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
function importVisitsJSON(input) {
    const file = input.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const json = JSON.parse(e.target.result);
            if(Array.isArray(json)) {
                // Ø¯Ù…Ø¬ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                visits = [...json, ...visits];
                await syncToCloud();
                renderVisits();
                updateDashboard();
                alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${json.length} Ø²ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­!`);
                closeModal('settingsModal');
            } else {
                alert("ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† JSON Array.");
            }
        } catch (err) {
            console.error(err);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ Ù…Ù„Ù JSON ØµØ§Ù„Ø­.");
        }
    };
    reader.readAsText(file);
}

// --- Ø§Ù„Ø£Ø¬Ù†Ø¯Ø© ÙˆØ§Ù„Ù…Ù‡Ø§Ù… ---
function addTask() {
    const inp = document.getElementById('taskInput');
    if(inp.value.trim()) {
        tasks.push({ id: Date.now(), text: inp.value.trim(), done: false });
        inp.value = "";
        renderTasks();
        syncToCloud();
        updateDashboard();
    }
}
function renderTasks() {
    document.getElementById('tasks-list').innerHTML = tasks.map(t => `
        <div class="lesson-card" style="padding:10px;">
            <span style="${t.done ? 'text-decoration:line-through;opacity:0.6' : ''}">${t.text}</span>
            <button onclick="removeTask(${t.id})" style="border:none; background:none; color:red;">âœ•</button>
        </div>
    `).join('');
}
function removeTask(id) {
    tasks = tasks.filter(t => t.id !== id);
    renderTasks(); syncToCloud(); updateDashboard();
}

// --- XML & Excel Imports (Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†) ---
function handleXML(input) {
    const reader = new FileReader();
    reader.onload = async (e) => {
        const parser = new DOMParser();
        const xml = parser.parseFromString(e.target.result, "text/xml");
        
        let newData = { teachers: {}, classes: {}, subjects: {}, lessons: [], periods: [] };
        
        // Parsing Logic (aSc Timetables XML format)
        Array.from(xml.getElementsByTagName('teacher')).forEach(t => newData.teachers[t.getAttribute('id')] = t.getAttribute('name'));
        Array.from(xml.getElementsByTagName('class')).forEach(c => newData.classes[c.getAttribute('id')] = c.getAttribute('short'));
        Array.from(xml.getElementsByTagName('subject')).forEach(s => newData.subjects[s.getAttribute('id')] = s.getAttribute('name'));
        Array.from(xml.getElementsByTagName('period')).forEach(p => newData.periods.push({
            id: p.getAttribute('period'), s: p.getAttribute('starttime'), e: p.getAttribute('endtime')
        }));
        
        Array.from(xml.getElementsByTagName('TimeTableSchedule')).forEach(l => {
            newData.lessons.push({
                d: l.getAttribute('DayID'), p: l.getAttribute('Period'), 
                c: l.getAttribute('ClassID'), t: l.getAttribute('TeacherID'), s: l.getAttribute('SubjectGradeID')
            });
        });

        data = newData;
        await syncToCloud();
        refreshUI();
        alert("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­");
        closeModal('settingsModal');
    };
    reader.readAsText(input.files[0]);
}

function importFromExcel(input) {
    const reader = new FileReader();
    reader.onload = async (e) => {
        const wb = XLSX.read(e.target.result, { type: 'binary' });
        const sheet = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        sheet.forEach(row => {
            const name = row['Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…'] || row['Name'];
            const phone = row['Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ'] || row['Phone'];
            if(name) phones[name] = String(phone || "");
        });
        await syncToCloud();
        renderStaff();
        alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†");
    };
    reader.readAsBinaryString(input.files[0]);
}

function exportToExcel() {
    const rows = Object.keys(data.teachers || {}).map(id => {
        const name = data.teachers[id];
        return { "Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…": name, "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ": phones[name] || "" };
    });
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†");
    XLSX.writeFile(wb, "Staff_Data.xlsx");
}

// --- Helpers ---
function openModal(id) { document.getElementById(id).style.display = 'flex'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function switchTab(id, btn) {
    document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    btn.classList.add('active');
}
function toM(t) { const [h, m] = t.split(':'); return parseInt(h) * 60 + parseInt(m); }
function doSim() { isSim = true; sDay = 1; sTime = "08:00"; closeModal('settingsModal'); refreshSchedule(); }
function resetTime() { isSim = false; closeModal('settingsModal'); refreshSchedule(); }

// Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±ÙŠ
setInterval(() => { if(currentUser && !isSim) refreshSchedule(); }, 60000);
