<!-- Header (Top Fixed) -->
<header class="bg-indigo-900 text-white shadow-md sticky top-0 z-40">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <!-- Title & Status -->
        <h1 class="text-lg font-bold flex items-center gap-2">
            <i class="fas fa-university text-yellow-400 text-xl"></i>
            <div class="flex flex-col">
                <span class="leading-none">مدير المدرسة</span>
                @if (store.cloudStatus() === 'connected') {
                    <span class="text-[9px] mt-1 bg-green-500/20 text-green-300 px-1.5 py-0.5 rounded-full border border-green-500/30 w-fit flex items-center gap-1">
                        <i class="fas fa-circle text-[5px] animate-pulse"></i> متصل
                    </span>
                } @else if (store.cloudStatus() === 'saving') {
                    <span class="text-[9px] mt-1 bg-amber-500/20 text-amber-300 px-1.5 py-0.5 rounded-full border border-amber-500/30 w-fit flex items-center gap-1">
                        <i class="fas fa-sync fa-spin text-[6px]"></i> حفظ...
                    </span>
                } @else {
                    <span class="text-[9px] mt-1 bg-red-500/20 text-red-300 px-1.5 py-0.5 rounded-full border border-red-500/30 w-fit flex items-center gap-1">
                        <i class="fas fa-wifi-slash"></i> غير متصل
                    </span>
                }
            </div>
        </h1>

        <!-- Clock & Controls -->
        <div class="flex gap-2 items-center">
            <div class="bg-black/20 px-3 py-1.5 rounded-lg border border-white/10 backdrop-blur-sm flex items-center gap-2">
                <i class="fas fa-clock text-indigo-300 text-xs"></i>
                <span class="font-mono font-bold text-green-400 dir-ltr text-sm">
                    {{ store.currentTime() | date:'HH:mm:ss' }}
                </span>
            </div>
            <button (click)="store.addSimulationHour()" class="text-xs bg-white/10 hover:bg-white/20 w-8 h-8 flex items-center justify-center rounded-lg transition text-indigo-200 hover:text-white" title="تقديم ساعة">
                <i class="fas fa-forward"></i>
            </button>
        </div>
    </div>
</header>

<!-- Main Content (Padded for Bottom Nav) -->
<main class="container mx-auto p-4 md:p-6 pb-28">
    @switch (currentView()) {
        @case ('now') {
            <app-current-classes (onAction)="openModal($event)" />
        }
        @case ('teachers') {
            <app-teacher-manager (onAction)="openModal($event)" />
        }
        @case ('reports') {
            <app-reports />
        }
    }
</main>

<!-- Bottom Navigation Bar -->
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-40 pb-safe">
    <div class="flex justify-around items-center h-16 px-2">
        <!-- Tab: Current Classes -->
        <button 
            (click)="setView('now')" 
            [class]="currentView() === 'now' ? 'text-indigo-700' : 'text-slate-400 hover:text-slate-600'"
            class="flex-1 flex flex-col items-center justify-center gap-1 py-1 transition-all duration-300 group">
            <div [class]="currentView() === 'now' ? 'bg-indigo-50' : 'bg-transparent group-hover:bg-slate-50'" 
                 class="w-10 h-8 flex items-center justify-center rounded-xl transition-colors">
                <i class="fas fa-chalkboard text-xl mb-0.5"></i>
            </div>
            <span class="text-[10px] font-bold">الحصص</span>
        </button>
        
        <!-- Tab: Teachers -->
        <button 
            (click)="setView('teachers')" 
            [class]="currentView() === 'teachers' ? 'text-indigo-700' : 'text-slate-400 hover:text-slate-600'"
            class="flex-1 flex flex-col items-center justify-center gap-1 py-1 transition-all duration-300 group">
            <div [class]="currentView() === 'teachers' ? 'bg-indigo-50' : 'bg-transparent group-hover:bg-slate-50'" 
                 class="w-10 h-8 flex items-center justify-center rounded-xl transition-colors">
                <i class="fas fa-users-cog text-xl mb-0.5"></i>
            </div>
            <span class="text-[10px] font-bold">المعلمين</span>
        </button>
        
        <!-- Tab: Reports -->
        <button 
            (click)="setView('reports')" 
            [class]="currentView() === 'reports' ? 'text-indigo-700' : 'text-slate-400 hover:text-slate-600'"
            class="flex-1 flex flex-col items-center justify-center gap-1 py-1 transition-all duration-300 group">
            <div [class]="currentView() === 'reports' ? 'bg-indigo-50' : 'bg-transparent group-hover:bg-slate-50'" 
                 class="w-10 h-8 flex items-center justify-center rounded-xl transition-colors">
                <i class="fas fa-file-invoice text-xl mb-0.5"></i>
            </div>
            <span class="text-[10px] font-bold">التقارير</span>
        </button>

        <!-- Tab: Settings (Action) -->
        <button (click)="showSettings.set(true)" class="flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group">
             <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors">
                <i class="fas fa-cog text-xl mb-0.5"></i>
             </div>
            <span class="text-[10px] font-bold">الإعدادات</span>
        </button>
    </div>
</nav>

<!-- Modals -->
<app-action-modal 
    [teacher]="selectedTeacher()" 
    [className]="selectedClassName()"
    (close)="closeModal()" 
/>

@if (showSettings()) {
    <app-settings-modal (close)="showSettings.set(false)" />
}
<script>
(function() {
  const AI_FUNCTION_URL = "https://us-central1-school-9416e.cloudfunctions.net/improveText";
  const COOLDOWN_MS = 15000; // 15 seconds
  const MAX_PER_DAY = 50;

  function ready(fn) { if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }

  function todayKey() {
    const d = new Date();
    return 'ai_count_' + d.getFullYear() + '-' + (d.getMonth()+1) + '-' + d.getDate();
  }

  function getCount() {
    return parseInt(localStorage.getItem(todayKey()) || '0', 10);
  }

  function incCount() {
    localStorage.setItem(todayKey(), String(getCount()+1));
  }

  ready(function() {
    const textarea = document.getElementById('visitNotes') || document.querySelector('textarea');
    const btn = document.getElementById('aiImproveBtn') || document.querySelector('[data-ai-improve]');
    if (!textarea || !btn) return;

    // Role selector (Manager / Supervisor)
    let roleSelect = document.getElementById('aiRole');
    if (!roleSelect) {
      roleSelect = document.createElement('select');
      roleSelect.id = 'aiRole';
      roleSelect.innerHTML = `
        <option value="manager">مدير مدرسة</option>
        <option value="supervisor">مشرف تربوي</option>
      `;
      roleSelect.style.margin = '0 0 10px 0';
      btn.parentNode.insertBefore(roleSelect, btn);
    }

    let lastClick = 0;

    btn.addEventListener('click', async function() {
      const now = Date.now();
      if (now - lastClick < COOLDOWN_MS) {
        alert('يرجى الانتظار قليلًا قبل إعادة الاستخدام');
        return;
      }
      if (getCount() >= MAX_PER_DAY) {
        alert('تم الوصول إلى الحد اليومي لاستخدام الذكاء الاصطناعي');
        return;
      }

      const originalText = textarea.value.trim();
      if (originalText.length < 5) {
        alert('يرجى كتابة ملاحظة أطول قبل التحسين');
        return;
      }

      lastClick = now;
      btn.disabled = true;
      const oldText = btn.textContent;
      btn.textContent = 'جارٍ التحسين بالذكاء الاصطناعي...';

      const role = roleSelect.value;
      const prefix = role === 'manager'
        ? 'حسّن العبارة التالية بصياغة إدارية رسمية مناسبة لمدير مدرسة:'
        : 'حسّن العبارة التالية بصياغة إشرافية تربوية مناسبة لمشرف تربوي:';

      try {
        const res = await fetch(AI_FUNCTION_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: prefix + "\n\n" + originalText })
        });
        const data = await res.json();
        if (data && data.result) {
          textarea.value = data.result;
          incCount();
        } else {
          alert('لم يتم توليد نص');
        }
      } catch(e) {
        alert('حدث خطأ أثناء الاتصال بالخدمة');
      } finally {
        btn.disabled = false;
        btn.textContent = oldText || '✨ تحسين بالذكاء الاصطناعي (Gemini)';
      }
    });
  });
})();
</script>
