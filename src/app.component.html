<!-- Header (Top Fixed) -->
<header class="bg-indigo-900 text-white shadow-md sticky top-0 z-40">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <!-- Title & Status -->
        <h1 class="text-lg font-bold flex items-center gap-2">
            <i class="fas fa-university text-yellow-400 text-xl"></i>
            <div class="flex flex-col">
                <span class="leading-none">مدير المدرسة</span>
                @if (store.cloudStatus() === 'connected') {
                    <span class="text-[9px] mt-1 bg-green-500/20 text-green-300 px-1.5 py-0.5 rounded-full border border-green-500/30 w-fit flex items-center gap-1">
                        <i class="fas fa-circle text-[5px] animate-pulse"></i> متصل
                    </span>
                } @else if (store.cloudStatus() === 'saving') {
                    <span class="text-[9px] mt-1 bg-amber-500/20 text-amber-300 px-1.5 py-0.5 rounded-full border border-amber-500/30 w-fit flex items-center gap-1">
                        <i class="fas fa-sync fa-spin text-[6px]"></i> حفظ...
                    </span>
                } @else {
                    <span class="text-[9px] mt-1 bg-red-500/20 text-red-300 px-1.5 py-0.5 rounded-full border border-red-500/30 w-fit flex items-center gap-1">
                        <i class="fas fa-wifi-slash"></i> غير متصل
                    </span>
                }
            </div>
        </h1>

        <!-- Clock & Controls -->
        <div class="flex gap-2 items-center">
            <div class="bg-black/20 px-3 py-1.5 rounded-lg border border-white/10 backdrop-blur-sm flex items-center gap-2">
                <i class="fas fa-clock text-indigo-300 text-xs"></i>
                <span class="font-mono font-bold text-green-400 dir-ltr text-sm">
                    {{ store.currentTime() | date:'HH:mm:ss' }}
                </span>
            </div>
            <button (click)="store.addSimulationHour()" class="text-xs bg-white/10 hover:bg-white/20 w-8 h-8 flex items-center justify-center rounded-lg transition text-indigo-200 hover:text-white" title="تقديم ساعة">
                <i class="fas fa-forward"></i>
            </button>
        </div>
    </div>
</header>

<!-- Main Content (Padded for Bottom Nav) -->
<main class="container mx-auto p-4 md:p-6 pb-28">
    @switch (currentView()) {
        @case ('now') {
            <app-current-classes (onAction)="openModal($event)" />
        }
        @case ('teachers') {
            <app-teacher-manager (onAction)="openModal($event)" />
        }
        @case ('reports') {
            <app-reports />
        }
    }
</main>

<!-- Bottom Navigation Bar -->
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-40 pb-safe">
    <div class="flex justify-around items-center h-16 px-2">
        <!-- Tab: Current Classes -->
        <button 
            (click)="setView('now')" 
            [class]="currentView() === 'now' ? 'text-indigo-700' : 'text-slate-400 hover:text-slate-600'"
            class="flex-1 flex flex-col items-center justify-center gap-1 py-1 transition-all duration-300 group">
            <div [class]="currentView() === 'now' ? 'bg-indigo-50' : 'bg-transparent group-hover:bg-slate-50'" 
                 class="w-10 h-8 flex items-center justify-center rounded-xl transition-colors">
                <i class="fas fa-chalkboard text-xl mb-0.5"></i>
            </div>
            <span class="text-[10px] font-bold">الحصص</span>
        </button>
        
        <!-- Tab: Teachers -->
        <button 
            (click)="setView('teachers')" 
            [class]="currentView() === 'teachers' ? 'text-indigo-700' : 'text-slate-400 hover:text-slate-600'"
            class="flex-1 flex flex-col items-center justify-center gap-1 py-1 transition-all duration-300 group">
            <div [class]="currentView() === 'teachers' ? 'bg-indigo-50' : 'bg-transparent group-hover:bg-slate-50'" 
                 class="w-10 h-8 flex items-center justify-center rounded-xl transition-colors">
                <i class="fas fa-users-cog text-xl mb-0.5"></i>
            </div>
            <span class="text-[10px] font-bold">المعلمين</span>
        </button>
        
        <!-- Tab: Reports -->
        <button 
            (click)="setView('reports')" 
            [class]="currentView() === 'reports' ? 'text-indigo-700' : 'text-slate-400 hover:text-slate-600'"
            class="flex-1 flex flex-col items-center justify-center gap-1 py-1 transition-all duration-300 group">
            <div [class]="currentView() === 'reports' ? 'bg-indigo-50' : 'bg-transparent group-hover:bg-slate-50'" 
                 class="w-10 h-8 flex items-center justify-center rounded-xl transition-colors">
                <i class="fas fa-file-invoice text-xl mb-0.5"></i>
            </div>
            <span class="text-[10px] font-bold">التقارير</span>
        </button>

        <!-- Tab: Settings (Action) -->
        <button (click)="showSettings.set(true)" class="flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group">
             <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors">
                <i class="fas fa-cog text-xl mb-0.5"></i>
             </div>
            <span class="text-[10px] font-bold">الإعدادات</span>
        </button>
    </div>
</nav>

<!-- Modals -->
<app-action-modal 
    [teacher]="selectedTeacher()" 
    [className]="selectedClassName()"
    (close)="closeModal()" 
/>

@if (showSettings()) {
    <app-settings-modal (close)="showSettings.set(false)" />
}
<!-- ===== AI Gemini Enhancement (Auto Added) ===== -->
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<script type="module">
  import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  const auth = getAuth();
  const AI_URL = "https://us-central1-school-9416e.cloudfunctions.net/improveText";

  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById("aiImproveBtn");
    const textarea = document.getElementById("visitNotes");
    const roleSel = document.getElementById("aiRole");
    if (!btn || !textarea || !roleSel) return;

    btn.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) {
        alert("يجب تسجيل الدخول أولاً");
        return;
      }
      const text = textarea.value.trim();
      if (text.length < 5) {
        alert("اكتب ملاحظة أطول");
        return;
      }
      const token = await user.getIdToken();
      btn.disabled = true;

      const res = await fetch(AI_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({
          text,
          role: roleSel.value
        })
      });

      const data = await res.json();
      if (data.error) {
        alert(data.error);
      } else {
        textarea.value = data.result;
        alert("المتبقي اليوم: " + data.remaining);
      }
      btn.disabled = false;
    });
  });
</script>
