<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدير المدرسة الذكي</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        brand: { 50:'#eff6ff', 100:'#dbeafe', 500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8', 900:'#1e3a8a' }
                    }
                }
            }
        }
    </script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    
    <!-- Excel Export/Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-view { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        /* Ensure modal content is clickable */
        .modal-content { z-index: 60; position: relative; }
        .modal-backdrop { z-index: 50; }
    </style>
<script type="importmap">
{
  "imports": {
    "rxjs": "https://esm.sh/rxjs@^7.8.2?conditions=es2015",
    "rxjs/operators": "https://esm.sh/rxjs@^7.8.2/operators?conditions=es2015",
    "rxjs/ajax": "https://esm.sh/rxjs@^7.8.2/ajax?conditions=es2015",
    "rxjs/webSocket": "https://esm.sh/rxjs@^7.8.2/webSocket?conditions=es2015",
    "rxjs/testing": "https://esm.sh/rxjs@^7.8.2/testing?conditions=es2015",
    "rxjs/fetch": "https://esm.sh/rxjs@^7.8.2/fetch?conditions=es2015",
    "@angular/common": "https://esm.sh/@angular/common@^21.0.6?external=rxjs",
    "@angular/compiler": "https://esm.sh/@angular/compiler@^21.0.6?external=rxjs",
    "@angular/forms": "https://esm.sh/@angular/forms@^21.0.6?external=rxjs",
    "@angular/platform-browser": "https://esm.sh/@angular/platform-browser@^21.0.6?external=rxjs",
    "@angular/core": "https://esm.sh/@angular/core@^21.0.6?external=rxjs"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-50 text-slate-800 antialiased selection:bg-brand-100 selection:text-brand-900 pb-20">

    <!-- Header -->
    <header class="bg-indigo-900 text-white shadow-xl sticky top-0 z-40">
        <div class="container mx-auto px-4">
            <!-- Top Bar -->
            <div class="flex justify-between items-center py-3 border-b border-indigo-800/50">
                <h1 class="text-xl font-bold flex items-center gap-3">
                    <i class="fas fa-university text-yellow-400"></i>
                    <span class="hidden sm:inline">مدير المدرسة الذكي</span>
                    <span id="cloudStatusBadge" class="text-[10px] bg-red-500/20 text-red-300 px-2 py-0.5 rounded-full border border-red-500/30 flex items-center gap-1">
                        <i class="fas fa-circle text-[6px]"></i> جاري الاتصال...
                    </span>
                </h1>

                <div class="flex gap-3 items-center">
                    <div class="bg-black/20 px-3 py-1 rounded-lg border border-white/10 backdrop-blur-sm flex items-center gap-2">
                        <i class="fas fa-clock text-indigo-300 text-xs"></i>
                        <span id="clockDisplay" class="font-mono font-bold text-green-400 dir-ltr">00:00:00</span>
                    </div>
                    <button onclick="window.app.addSimulationHour()" class="text-xs bg-white/10 hover:bg-white/20 p-2 rounded transition text-indigo-200 hover:text-white" title="تقديم ساعة">
                        <i class="fas fa-forward"></i>
                    </button>
                </div>
            </div>
            
            <!-- Navigation -->
            <nav class="flex gap-1 overflow-x-auto pt-2 pb-0 scrollbar-hide">
                <button onclick="window.app.setView('now')" id="btn-now" class="nav-btn bg-indigo-800 text-yellow-400 border-b-2 border-yellow-400 px-4 py-3 rounded-t-lg transition-all flex items-center gap-2 whitespace-nowrap">
                    <i class="fas fa-chalkboard"></i> الحصص الحالية
                </button>
                <button onclick="window.app.setView('teachers')" id="btn-teachers" class="nav-btn text-indigo-200 hover:text-white hover:bg-indigo-800/50 px-4 py-3 rounded-t-lg transition-all flex items-center gap-2 whitespace-nowrap">
                    <i class="fas fa-users-cog"></i> المعلمون
                </button>
                <button onclick="window.app.setView('reports')" id="btn-reports" class="nav-btn text-indigo-200 hover:text-white hover:bg-indigo-800/50 px-4 py-3 rounded-t-lg transition-all flex items-center gap-2 whitespace-nowrap">
                    <i class="fas fa-file-invoice"></i> التقارير
                </button>
                <div class="mr-auto self-center pb-2">
                    <button onclick="window.app.openSettings()" class="text-sm bg-white/10 hover:bg-white/20 text-indigo-100 hover:text-white px-3 py-1.5 rounded-lg font-bold transition flex items-center gap-2">
                        <i class="fas fa-cog"></i> <span class="hidden md:inline">الإعدادات</span>
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Views -->
    <main class="container mx-auto p-4 md:p-6">
        
        <!-- View: Current Classes -->
        <section id="view-now" class="fade-in space-y-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-3 bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-100 text-indigo-700 w-10 h-10 rounded-full flex items-center justify-center text-lg">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">الحصص القائمة الآن</h2>
                    </div>
                </div>
                <div id="currentPeriodInfo"></div>
            </div>
            <!-- Increased columns and reduced gap for moderation -->
            <div id="activeClassesGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-2"></div>
        </section>

        <!-- View: Teachers -->
        <section id="view-teachers" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col md:flex-row justify-between gap-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">سجل المعلمين</h2>
                    <p class="text-slate-500 text-sm">إدارة بيانات التواصل والتقييمات</p>
                </div>
                <div class="relative w-full md:w-96">
                    <input type="text" id="teacherSearch" onkeyup="window.app.renderTeachers()" placeholder="بحث عن معلم..." class="w-full pl-4 pr-10 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all outline-none bg-slate-50 focus:bg-white">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                </div>
            </div>
            <div id="teachersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
        </section>

        <!-- View: Reports -->
        <section id="view-reports" class="fade-in space-y-6 hidden-view">
            <div class="flex justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">تقارير الأداء</h2>
                    <p class="text-sm text-slate-500">نظرة عامة على انضباط المعلمين</p>
                </div>
                <button onclick="window.app.exportReports()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 transition shadow-lg shadow-emerald-200">
                    <i class="fas fa-file-excel"></i> <span>تصدير Excel</span>
                </button>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead class="bg-slate-50 border-b border-slate-100 text-slate-500 text-sm uppercase">
                            <tr>
                                <th class="p-5 font-bold">المعلم</th>
                                <th class="p-5 font-bold text-center">التقييم</th>
                                <th class="p-5 font-bold text-center">الهاتف</th>
                                <th class="p-5 font-bold text-center">الحالة</th>
                            </tr>
                        </thead>
                        <tbody id="reportsBody" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <!-- Modals -->
    
    <!-- Action Modal -->
    <div id="modal-action" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden-view">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm modal-backdrop" onclick="window.app.closeModal('modal-action')"></div>
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-scale-in modal-content">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-start">
                <div>
                    <h3 class="text-lg font-bold flex items-center gap-2" id="actionModalTitle"></h3>
                    <p id="actionModalSubtitle" class="text-slate-300 text-xs mt-1"></p>
                </div>
                <button type="button" onclick="window.app.closeModal('modal-action')" class="text-white/50 hover:text-white"><i class="fas fa-times text-lg"></i></button>
            </div>
            
            <div class="p-4 space-y-4 max-h-[70vh] overflow-y-auto custom-scrollbar">
                <!-- Communication Buttons -->
                <div class="space-y-2">
                     <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">التواصل</label>
                     <div class="grid grid-cols-2 gap-2">
                         <button type="button" onclick="window.app.sendWhatsApp('summon')" class="bg-emerald-50 hover:bg-emerald-100 text-emerald-700 border border-emerald-200 p-3 rounded-lg font-bold text-xs flex flex-col items-center gap-2 transition cursor-pointer">
                            <i class="fab fa-whatsapp text-xl"></i><span>استدعاء</span>
                         </button>
                         <button type="button" id="btn-remind" onclick="window.app.sendWhatsApp('remind')" class="bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-200 p-3 rounded-lg font-bold text-xs flex flex-col items-center gap-2 transition cursor-pointer">
                            <i class="fas fa-bell text-xl"></i><span>تذكير</span>
                         </button>
                     </div>
                </div>
                <div class="h-px bg-slate-100"></div>
                <!-- Dynamic Violation Buttons -->
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">المخالفات</label>
                    <div id="violationButtonsContainer" class="space-y-2"></div>
                </div>
            </div>
             <div class="bg-slate-50 p-3 text-center border-t border-slate-200 flex justify-between items-center px-6">
                <span class="text-xs text-slate-500">التقييم الحالي</span>
                <span class="text-lg font-bold text-slate-800" id="currentScoreDisplay"></span>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="modal-settings" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden-view">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm modal-backdrop" onclick="window.app.closeModal('modal-settings')"></div>
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden animate-scale-in flex flex-col max-h-[90vh] modal-content">
            <div class="bg-slate-800 text-white p-5 flex justify-between items-center shrink-0">
                <h3 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-cog"></i> الإعدادات</h3>
                <button type="button" onclick="window.app.closeModal('modal-settings')" class="text-white/70 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scrollbar space-y-8">
                <!-- Violation Management -->
                <div class="space-y-4">
                     <div class="flex items-center justify-between pb-2 border-b border-slate-100">
                        <h4 class="font-bold text-slate-800 text-sm flex items-center gap-2"><i class="fas fa-gavel text-red-500"></i> إدارة المخالفات</h4>
                    </div>
                    <!-- Add Form -->
                    <div class="flex gap-2 bg-slate-50 p-3 rounded-lg border border-slate-200 items-end">
                        <div class="flex-1 space-y-1">
                            <label class="text-[10px] font-bold text-slate-500">اسم المخالفة</label>
                            <input type="text" id="newViolationLabel" placeholder="مثلاً: عدم تحضير" class="w-full text-sm p-2 rounded border border-slate-300 focus:border-indigo-500 outline-none">
                        </div>
                        <div class="w-24 space-y-1">
                            <label class="text-[10px] font-bold text-slate-500">الخصم</label>
                            <input type="number" id="newViolationPoints" value="5" class="w-full text-sm p-2 rounded border border-slate-300 focus:border-indigo-500 outline-none text-center">
                        </div>
                        <button type="button" onclick="window.app.addViolation()" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded h-[38px] w-10 flex items-center justify-center transition cursor-pointer"><i class="fas fa-plus"></i></button>
                    </div>
                    <!-- List -->
                    <div id="violationsList" class="space-y-2"></div>
                </div>

                <!-- Imports -->
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                        <h4 class="font-bold text-indigo-900 mb-2 flex items-center gap-2 text-sm"><i class="fas fa-calendar-alt"></i> جدول الحصص (XML)</h4>
                        <button type="button" onclick="document.getElementById('xmlInput').click()" class="w-full bg-white hover:bg-indigo-100 text-indigo-700 border border-indigo-200 py-2 rounded-lg font-bold text-xs transition cursor-pointer">رفع ملف XML</button>
                        <input type="file" id="xmlInput" accept=".xml" class="hidden" onchange="window.app.handleXml(event)">
                    </div>
                    <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                        <h4 class="font-bold text-emerald-900 mb-2 flex items-center gap-2 text-sm"><i class="fas fa-users"></i> بيانات المعلمين (Excel)</h4>
                        <div class="flex gap-2">
                            <button type="button" onclick="window.app.exportTeacherTemplate()" class="flex-1 bg-white border border-emerald-200 text-emerald-700 hover:bg-emerald-100 py-2 rounded-lg font-bold text-xs transition cursor-pointer"><i class="fas fa-download"></i> تصدير</button>
                            <button type="button" onclick="document.getElementById('excelInput').click()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg font-bold text-xs transition cursor-pointer"><i class="fas fa-upload"></i> استيراد</button>
                        </div>
                        <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden" onchange="window.app.handleExcel(event)">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- App Logic -->
    <script>
        class SchoolApp {
            constructor() {
                this.state = {
                    teachers: [],
                    periods: [],
                    classes: {},
                    violationTypes: [
                        { id: 'late', label: 'تأخر عن الحصة', points: 5, icon: 'fa-clock' },
                        { id: 'absent', label: 'غياب عن الحصة', points: 15, icon: 'fa-user-slash' }
                    ],
                    simulationOffset: 0,
                    selectedTeacherId: null,
                    selectedClassName: null
                };
                this.db = null;
                
                // Initialize
                this.loadLocalData();
                this.startClock();
                this.initFirebase();
            }

            initFirebase() {
                const firebaseConfig = {
                    apiKey: "AIzaSyC4NddjijF29YNhowy4SqgRaMPn01oSSEg",
                    authDomain: "school-9416e.firebaseapp.com",
                    projectId: "school-9416e",
                    storageBucket: "school-9416e.firebasestorage.app",
                    messagingSenderId: "680872052240",
                    appId: "1:680872052240:web:96d2e544166ab5f8096c95",
                    measurementId: "G-5EBTV0MV83"
                };
                
                try {
                    if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    if(typeof firebase !== 'undefined') {
                        this.db = firebase.firestore();
                        this.db.collection("school_settings").doc("timetable")
                            .onSnapshot((doc) => {
                                if(doc.exists) {
                                    const data = doc.data();
                                    this.state.teachers = data.teachers || [];
                                    this.state.periods = data.periods || [];
                                    this.state.classes = data.classes || {};
                                    if(data.violationTypes) this.state.violationTypes = data.violationTypes;
                                    
                                    this.renderAll();
                                    this.saveToLocal();
                                    this.updateCloudStatus('connected');
                                }
                            }, (error) => {
                                console.error("Cloud Error:", error);
                                this.updateCloudStatus('error');
                            });
                    }
                } catch (e) {
                    console.error("Firebase Init Error:", e);
                    this.updateCloudStatus('error');
                }
            }

            loadLocalData() {
                const local = localStorage.getItem('school_data_v1');
                if(local) {
                    try {
                        const parsed = JSON.parse(local);
                        this.state.teachers = parsed.teachers || [];
                        this.state.periods = parsed.periods || [];
                        this.state.classes = parsed.classes || {};
                        if(parsed.violationTypes) this.state.violationTypes = parsed.violationTypes;
                        this.renderAll();
                    } catch(e) { console.error("Local Load Error", e); }
                }
            }

            saveToLocal() {
                localStorage.setItem('school_data_v1', JSON.stringify({
                    teachers: this.state.teachers,
                    periods: this.state.periods,
                    classes: this.state.classes,
                    violationTypes: this.state.violationTypes,
                    lastSync: new Date()
                }));
            }

            async saveData() {
                this.saveToLocal();
                this.renderAll();

                if(!this.db) return;
                
                this.updateCloudStatus('saving');
                try {
                    await this.db.collection("school_settings").doc("timetable").set({
                        teachers: this.state.teachers,
                        periods: this.state.periods,
                        classes: this.state.classes,
                        violationTypes: this.state.violationTypes,
                        lastSync: new Date()
                    }, { merge: true });
                } catch(e) { 
                    console.error("Save Error:", e);
                    this.updateCloudStatus('error'); 
                }
            }

            updateCloudStatus(status) {
                const badge = document.getElementById('cloudStatusBadge');
                if(!badge) return;
                if(status === 'connected') {
                    badge.innerHTML = '<i class="fas fa-circle text-[6px] animate-pulse"></i> متصل';
                    badge.className = "text-[10px] bg-green-500/20 text-green-300 px-2 py-0.5 rounded-full border border-green-500/30 flex items-center gap-1";
                } else if(status === 'saving') {
                    badge.innerHTML = '<i class="fas fa-sync fa-spin text-[8px]"></i> حفظ...';
                    badge.className = "text-[10px] bg-amber-500/20 text-amber-300 px-2 py-0.5 rounded-full border border-amber-500/30 flex items-center gap-1";
                } else {
                    badge.innerHTML = '<i class="fas fa-wifi-slash"></i>';
                    badge.className = "text-[10px] bg-red-500/20 text-red-300 px-2 py-0.5 rounded-full border border-red-500/30 flex items-center gap-1";
                }
            }

            startClock() {
                setInterval(() => {
                    const now = new Date(new Date().getTime() + this.state.simulationOffset);
                    const el = document.getElementById('clockDisplay');
                    if(el) el.innerText = now.toLocaleTimeString('en-US', {hour12:false});
                    this.renderCurrentPeriod(now);
                }, 1000);
            }

            addSimulationHour() {
                this.state.simulationOffset += 3600000;
                const now = new Date(new Date().getTime() + this.state.simulationOffset);
                const el = document.getElementById('clockDisplay');
                if(el) el.innerText = now.toLocaleTimeString('en-US', {hour12:false});
                this.renderCurrentPeriod(now);
            }

            setView(viewName) {
                ['now', 'teachers', 'reports'].forEach(v => {
                    const el = document.getElementById(`view-${v}`);
                    if(el) el.classList.add('hidden-view');
                    const btn = document.getElementById(`btn-${v}`);
                    if(btn) btn.className = v === viewName 
                        ? "nav-btn bg-indigo-800 text-yellow-400 border-b-2 border-yellow-400 px-4 py-3 rounded-t-lg transition-all flex items-center gap-2 whitespace-nowrap"
                        : "nav-btn text-indigo-200 hover:text-white hover:bg-indigo-800/50 px-4 py-3 rounded-t-lg transition-all flex items-center gap-2 whitespace-nowrap";
                });
                const view = document.getElementById(`view-${viewName}`);
                if(view) view.classList.remove('hidden-view');
                if(viewName === 'teachers') this.renderTeachers();
                if(viewName === 'reports') this.renderReports();
            }

            renderAll() {
                const btn = document.querySelector('.nav-btn.bg-indigo-800');
                if(!btn) return;
                const currentView = btn.id.replace('btn-', '');
                if(currentView === 'now') {
                     const now = new Date(new Date().getTime() + this.state.simulationOffset);
                     this.renderCurrentPeriod(now);
                } else if (currentView === 'teachers') {
                    this.renderTeachers();
                } else if (currentView === 'reports') {
                    this.renderReports();
                }
            }

            renderCurrentPeriod(now) {
                const mins = now.getHours() * 60 + now.getMinutes();
                const currentPeriod = this.state.periods.find(p => {
                    const [sh, sm] = p.start.split(':').map(Number);
                    const [eh, em] = p.end.split(':').map(Number);
                    return mins >= (sh*60+sm) && mins <= (eh*60+em);
                });

                const infoDiv = document.getElementById('currentPeriodInfo');
                if(infoDiv) {
                    if(currentPeriod) {
                        infoDiv.innerHTML = `
                            <div class="flex items-center gap-3 bg-indigo-50 px-4 py-2 rounded-lg border border-indigo-100 shadow-sm">
                                <span class="text-indigo-900 font-bold">الحصة ${currentPeriod.id}</span>
                                <span class="text-indigo-300">|</span>
                                <span class="text-indigo-600 font-mono text-sm">${currentPeriod.start} - ${currentPeriod.end}</span>
                            </div>`;
                    } else {
                        infoDiv.innerHTML = `<div class="bg-amber-50 text-amber-700 px-4 py-2 rounded-lg border border-amber-100 font-bold text-sm">لا توجد حصص نشطة</div>`;
                    }
                }

                this.renderActiveClasses(now, currentPeriod);
            }

            renderActiveClasses(now, period) {
                const grid = document.getElementById('activeClassesGrid');
                if(!grid) return;
                
                if(!period) {
                    grid.innerHTML = `<div class="col-span-full py-16 text-center text-slate-400 bg-slate-50 rounded-xl border-2 border-dashed border-slate-200"><i class="fas fa-coffee text-3xl mb-3 text-slate-300"></i><p class="text-sm">لا توجد حصص في الوقت الحالي</p></div>`;
                    return;
                }

                const dayId = now.getDay() + 1;
                const pId = parseInt(period.id);
                
                let active = [];
                this.state.teachers.forEach(t => {
                    const l = t.lessons.find(ls => ls.day === dayId && ls.period === pId);
                    if(l) active.push({ t, className: l.className });
                });
                
                active.sort((a, b) => {
                    const getGrade = (name) => {
                        const n = name.trim();
                        if (n.match(/(الثاني|ثاني)\s*عشر/)) return 12;
                        if (n.match(/(الحادي|حادي)\s*عشر/)) return 11;
                        if (n.match(/العاشر|عاشر/)) return 10;
                        if (n.match(/التاسع|تاسع/)) return 9;
                        if (n.match(/الثامن|ثامن/)) return 8;
                        if (n.match(/السابع|سابع/)) return 7;
                        if (n.match(/السادس|سادس/)) return 6;
                        if (n.match(/الخامس|خامس/)) return 5;
                        if (n.match(/الرابع|رابع/)) return 4;
                        if (n.match(/الثالث|ثالث/)) return 3;
                        if (n.match(/الثاني|ثاني/)) return 2;
                        if (n.match(/الاول|الأول|اول|أول/)) return 1;
                        const match = n.match(/\d+/);
                        return match ? parseInt(match[0]) : 999;
                    };
                    const gA = getGrade(a.className);
                    const gB = getGrade(b.className);
                    if (gA !== gB) return gA - gB;
                    
                    const getSection = (str) => {
                         const nums = str.match(/\d+/g);
                         return nums ? parseInt(nums[nums.length-1]) : 0;
                    };
                    const sA = getSection(a.className);
                    const sB = getSection(b.className);
                    if (sA !== sB) return sA - sB;
                    return a.className.localeCompare(b.className, 'ar');
                });

                grid.innerHTML = active.map(item => `
                    <div class="group bg-white rounded-lg shadow-sm hover:shadow-md transition-all duration-300 border border-slate-200 overflow-hidden relative flex flex-col">
                        <div class="h-1 w-full bg-indigo-500"></div>
                        <div class="p-2 flex-1 flex flex-col">
                            <div class="flex justify-between items-center mb-1">
                                <span class="bg-slate-100 text-slate-800 px-2 py-0.5 rounded text-xs font-bold border border-slate-200 truncate max-w-[70%]">
                                    ${item.className}
                                </span>
                                <div class="w-5 h-5 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center text-[9px] font-bold border border-indigo-100">
                                   ${item.t.short[0] || '?'}
                                </div>
                            </div>
                            <h3 class="font-bold text-xs text-slate-700 mb-1 truncate">${item.t.name}</h3>
                            <div class="flex items-center gap-1 text-[9px] text-slate-400 mb-2"><i class="fas fa-star text-yellow-400"></i> <span>${item.t.score}%</span></div>
                            <button type="button" onclick="window.app.openActionModal('${item.t.id}', '${item.className}')" class="mt-auto w-full py-1 rounded bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-bold text-[10px] transition-colors flex justify-center items-center gap-1 cursor-pointer"><i class="fas fa-cog"></i> إجراء</button>
                        </div>
                    </div>
                `).join('');
            }

            renderTeachers() {
                const termInput = document.getElementById('teacherSearch');
                const term = termInput ? termInput.value.toLowerCase() : '';
                const grid = document.getElementById('teachersGrid');
                if(!grid) return;
                
                let filtered = this.state.teachers.filter(t => t.name.toLowerCase().includes(term));
                filtered.sort((a,b) => a.name.localeCompare(b.name, 'ar'));

                grid.innerHTML = filtered.map(t => {
                    let scoreColor = t.score >= 90 ? "bg-emerald-50 text-emerald-600 border-emerald-100" : (t.score >= 70 ? "bg-yellow-50 text-yellow-600 border-yellow-100" : "bg-red-50 text-red-600 border-red-100");
                    return `
                    <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition border border-slate-100 p-5 flex flex-col gap-4">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3">
                                 <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white flex items-center justify-center font-bold shadow-sm">${t.short[0] || '?'}</div>
                                <div><h3 class="font-bold text-slate-800 line-clamp-1">${t.name}</h3><span class="text-xs text-slate-500">${t.short}</span></div>
                            </div>
                            <div class="font-bold text-sm px-2 py-1 rounded-md border ${scoreColor}">${t.score}%</div>
                        </div>
                        <div class="relative group/input">
                             <i class="fas fa-phone absolute right-3 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within/input:text-indigo-500 transition-colors"></i>
                            <input type="tel" value="${t.phone || ''}" onchange="window.app.updatePhone('${t.id}', this.value)" placeholder="أضف رقم الهاتف" class="w-full pr-9 pl-3 py-2 text-sm rounded-lg border border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all dir-rtl">
                        </div>
                        <div class="flex gap-2 mt-auto pt-2 border-t border-slate-50">
                            <button type="button" onclick="window.app.openActionModal('${t.id}')" class="flex-1 bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 py-2 rounded-lg text-xs font-bold transition cursor-pointer">خيارات</button>
                             <button type="button" onclick="window.app.openWhatsApp('${t.id}')" class="w-10 flex items-center justify-center bg-green-50 hover:bg-green-100 text-green-600 border border-green-200 rounded-lg transition cursor-pointer"><i class="fab fa-whatsapp"></i></button>
                        </div>
                    </div>`;
                }).join('');
            }

            renderReports() {
                const tbody = document.getElementById('reportsBody');
                if(!tbody) return;
                tbody.innerHTML = this.state.teachers.map(t => {
                    let badge = t.score >= 90 ? "bg-green-100 text-green-700" : (t.score >= 70 ? "bg-yellow-100 text-yellow-700" : "bg-red-100 text-red-700");
                    let status = t.score < 80 ? '<span class="text-xs text-red-500 font-bold bg-red-50 px-2 py-1 rounded">يحتاج متابعة</span>' : '<span class="text-xs text-green-500 font-bold bg-green-50 px-2 py-1 rounded">ممتاز</span>';
                    return `
                        <tr class="hover:bg-slate-50/50 transition-colors">
                            <td class="p-5 font-semibold text-slate-700"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded bg-indigo-50 text-indigo-600 flex items-center justify-center text-xs font-bold">${t.short[0] || '?'}</div>${t.name}</div></td>
                            <td class="p-5 text-center"><span class="inline-block px-3 py-1 rounded-full text-xs font-bold ${badge}">${t.score}%</span></td>
                            <td class="p-5 text-center text-slate-500 font-mono text-sm">${t.phone || '-'}</td>
                            <td class="p-5 text-center">${status}</td>
                        </tr>`;
                }).join('');
            }

            // --- Actions ---
            updatePhone(id, val) {
                const t = this.state.teachers.find(x => x.id === id);
                if(t) { t.phone = val; this.saveData(); }
            }

            openActionModal(tId, className = null) {
                this.state.selectedTeacherId = tId;
                this.state.selectedClassName = className;
                const t = this.state.teachers.find(x => x.id === tId);
                
                if(!t) return;

                document.getElementById('actionModalTitle').innerHTML = `<i class="fas fa-user-edit text-yellow-400"></i> ${t.name}`;
                document.getElementById('actionModalSubtitle').innerText = className && className !== 'undefined' ? `الحصة الحالية: ${className}` : 'قائمة الإدارة';
                document.getElementById('currentScoreDisplay').innerText = t.score + '%';

                const remindBtn = document.getElementById('btn-remind');
                if(className && className !== 'undefined') {
                    remindBtn.disabled = false;
                    remindBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    remindBtn.disabled = true;
                    remindBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                
                // Render Dynamic Violation Buttons
                const container = document.getElementById('violationButtonsContainer');
                if(container) {
                    container.innerHTML = this.state.violationTypes.map(v => `
                        <button type="button" onclick="window.app.dockScore('${v.id}')" class="w-full bg-slate-50 hover:bg-red-50 text-slate-700 hover:text-red-700 border border-slate-200 hover:border-red-200 p-3 rounded-lg flex items-center justify-between transition group cursor-pointer">
                            <span class="flex items-center gap-3 font-bold text-sm">
                                <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-400 group-hover:text-red-500 group-hover:border-red-200 transition">
                                    <i class="fas ${v.icon}"></i>
                                </div>
                                ${v.label}
                            </span>
                            <span class="bg-white px-2 py-1 rounded text-xs font-bold text-red-500 border border-slate-200 group-hover:border-red-200 shadow-sm">
                                -${v.points}
                            </span>
                        </button>
                    `).join('');
                }

                document.getElementById('modal-action').classList.remove('hidden-view');
            }

            closeModal(id) { 
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden-view'); 
            }
            
            openSettings() { 
                this.renderViolationsSettings();
                document.getElementById('modal-settings').classList.remove('hidden-view'); 
            }

            renderViolationsSettings() {
                const list = document.getElementById('violationsList');
                if(!list) return;
                list.innerHTML = this.state.violationTypes.map(v => `
                    <div class="flex items-center justify-between bg-white p-3 rounded-lg border border-slate-100 shadow-sm group hover:border-red-100 transition">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded bg-slate-100 text-slate-500 flex items-center justify-center"><i class="fas ${v.icon}"></i></div>
                            <span class="font-bold text-sm text-slate-700">${v.label}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="bg-red-50 text-red-600 text-xs font-bold px-2 py-1 rounded border border-red-100">-${v.points}</span>
                            <button type="button" onclick="window.app.removeViolation('${v.id}')" class="text-slate-300 hover:text-red-500 transition px-2 cursor-pointer"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                `).join('');
            }

            addViolation() {
                const labelIn = document.getElementById('newViolationLabel');
                const pointsIn = document.getElementById('newViolationPoints');
                if(!labelIn || !pointsIn) return;

                const label = labelIn.value;
                const points = parseInt(pointsIn.value);
                
                if(label && points) {
                    this.state.violationTypes.push({ id: Date.now().toString(), label, points, icon: 'fa-exclamation-circle' });
                    labelIn.value = '';
                    this.saveData();
                    this.renderViolationsSettings();
                }
            }

            removeViolation(id) {
                this.state.violationTypes = this.state.violationTypes.filter(v => v.id !== id);
                this.saveData();
                this.renderViolationsSettings();
            }

            sendWhatsApp(type) {
                const t = this.state.teachers.find(x => x.id === this.state.selectedTeacherId);
                if(!t) return; 
                
                if(!t.phone) return alert('أضف الهاتف أولاً');
                
                let msg = type === 'summon' 
                    ? `السلام عليكم أستاذ ${t.name}، يرجى التكرم بزيارة مكتب الإدارة.` 
                    : `السلام عليكم أستاذ ${t.name}، تذكير بموعد حصتكم الحالية في الصف ${this.state.selectedClassName}.`;
                window.open(`https://wa.me/${t.phone}?text=${encodeURIComponent(msg)}`, '_blank');
            }

            openWhatsApp(id) {
                const t = this.state.teachers.find(x => x.id === id);
                if(t && t.phone) window.open(`https://wa.me/${t.phone}`, '_blank');
                else alert('أضف الهاتف أولاً');
            }

            dockScore(violationId) {
                const v = this.state.violationTypes.find(x => x.id === violationId);
                if(!v) return;

                if(confirm(`تأكيد خصم ${v.points} نقاط بسبب: ${v.label}؟`)) {
                    const t = this.state.teachers.find(x => x.id === this.state.selectedTeacherId);
                    if(t) {
                        t.score = Math.max(0, t.score - v.points);
                        this.saveData();
                        this.closeModal('modal-action');
                    }
                }
            }

            // --- Imports/Exports ---
            handleXml(e) {
                const reader = new FileReader();
                reader.readAsText(e.target.files[0], "windows-1256");
                reader.onload = (evt) => {
                    try {
                        const xml = new DOMParser().parseFromString(evt.target.result, "text/xml");
                        this.state.periods = Array.from(xml.querySelectorAll('periods period')).map(p => ({
                            id: p.getAttribute('period'), start: p.getAttribute('starttime'), end: p.getAttribute('endtime')
                        }));
                        const classes = {};
                        xml.querySelectorAll('classes class').forEach(c => classes[c.getAttribute('id')] = c.getAttribute('name'));
                        this.state.classes = classes;
                        
                        this.state.teachers = Array.from(xml.querySelectorAll('teachers teacher')).map(t => ({
                            id: t.getAttribute('id'), name: t.getAttribute('name'), short: t.getAttribute('short'),
                            score: 100, phone: '', lessons: []
                        }));
                        
                        xml.querySelectorAll('TimeTableSchedules TimeTableSchedule').forEach(sch => {
                            const t = this.state.teachers.find(x => x.id === sch.getAttribute('TeacherID'));
                            if(t) t.lessons.push({ day: parseInt(sch.getAttribute('DayID')), period: parseInt(sch.getAttribute('Period')), className: classes[sch.getAttribute('ClassID')] || 'نشاط' });
                        });

                        this.saveData();
                        this.closeModal('modal-settings');
                        alert('تم استيراد الجدول بنجاح');
                        this.renderAll();
                    } catch(err) { alert('خطأ في الملف'); console.error(err); }
                };
            }

            exportTeacherTemplate() {
                const data = this.state.teachers.map(t => ({ 'Teacher_ID': t.id, 'Short_Name': t.short, 'Full_Name': t.name, 'Phone': t.phone }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Teachers_Data");
                XLSX.writeFile(wb, "Teachers_Data.xlsx");
            }

            handleExcel(e) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    let updated = false;
                    this.state.teachers.forEach(t => {
                        const row = json.find(r => r['Teacher_ID'] == t.id);
                        if(row) { t.name = row['Full_Name'] || t.name; t.phone = row['Phone'] ? String(row['Phone']) : t.phone; updated = true; }
                    });
                    if(updated) { this.saveData(); this.renderAll(); alert('تم التحديث بنجاح'); }
                    this.closeModal('modal-settings');
                };
                reader.readAsArrayBuffer(e.target.files[0]);
            }

            exportReports() {
                const data = this.state.teachers.map(t => ({ 'المعلم': t.name, 'التقييم': t.score+'%', 'الهاتف': t.phone||'-' }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Reports");
                XLSX.writeFile(wb, "School_Report.xlsx");
            }
        }

        // Attach to window explicitly
        window.app = new SchoolApp();
    </script>
</body>
</html>