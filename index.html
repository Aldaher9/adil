<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مدير المدرسة الذكي</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        brand: { 50:'#eff6ff', 100:'#dbeafe', 500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8', 900:'#1e3a8a' }
                    }
                }
            }
        }
    </script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    
    <!-- Excel Export/Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-view { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        /* Ensure modal content is clickable */
        .modal-content { z-index: 60; position: relative; }
        .modal-backdrop { z-index: 50; }
        /* Safe area for mobile bottom nav */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Supervision Radio Styles */
        .sup-radio:checked + div { background-color: #eff6ff; border-color: #6366f1; }
        .sup-radio:checked + div .check-icon { display: block; }
        .print-only { display: none; }
        @media print {
            body * { visibility: hidden; }
            #view-supervision-report, #view-supervision-report * { visibility: visible; }
            #view-supervision-report { position: absolute; left: 0; top: 0; width: 100%; display: block !important; padding: 0; margin: 0; }
            .no-print { display: none !important; }
            .print-only { display: block; }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "rxjs": "https://esm.sh/rxjs@^7.8.2?conditions=es2015",
    "rxjs/operators": "https://esm.sh/rxjs@^7.8.2/operators?conditions=es2015",
    "rxjs/ajax": "https://esm.sh/rxjs@^7.8.2/ajax?conditions=es2015",
    "rxjs/webSocket": "https://esm.sh/rxjs@^7.8.2/webSocket?conditions=es2015",
    "rxjs/testing": "https://esm.sh/rxjs@^7.8.2/testing?conditions=es2015",
    "rxjs/fetch": "https://esm.sh/rxjs@^7.8.2/fetch?conditions=es2015",
    "@angular/common": "https://esm.sh/@angular/common@^21.0.6?external=rxjs",
    "@angular/compiler": "https://esm.sh/@angular/compiler@^21.0.6?external=rxjs",
    "@angular/forms": "https://esm.sh/@angular/forms@^21.0.6?external=rxjs",
    "@angular/platform-browser": "https://esm.sh/@angular/platform-browser@^21.0.6?external=rxjs",
    "@angular/core": "https://esm.sh/@angular/core@^21.0.6?external=rxjs",
    "@google/genai": "https://esm.sh/@google/genai"
  }
}
</script>
<script type="module">
    import { GoogleGenAI } from "@google/genai";
    window.GoogleGenAI = GoogleGenAI;
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-50 text-slate-800 antialiased selection:bg-brand-100 selection:text-brand-900 pb-28">

    <!-- Header (Fixed Top) -->
    <header class="bg-indigo-900 text-white shadow-xl sticky top-0 z-40 no-print">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-lg font-bold flex items-center gap-2">
                <i class="fas fa-university text-yellow-400 text-xl"></i>
                <div class="flex flex-col">
                    <span class="leading-none">مدير المدرسة</span>
                    <span id="cloudStatusBadge" class="text-[9px] mt-1 bg-red-500/20 text-red-300 px-1.5 py-0.5 rounded-full border border-red-500/30 w-fit flex items-center gap-1">
                        <i class="fas fa-circle text-[5px]"></i> جاري الاتصال...
                    </span>
                </div>
            </h1>

            <div class="flex gap-2 items-center">
                <div class="bg-black/20 px-3 py-1.5 rounded-lg border border-white/10 backdrop-blur-sm flex items-center gap-2">
                    <i class="fas fa-clock text-indigo-300 text-xs"></i>
                    <span id="clockDisplay" class="font-mono font-bold text-green-400 dir-ltr text-sm">00:00:00</span>
                </div>
                <button onclick="window.app.addSimulationHour()" class="text-xs bg-white/10 hover:bg-white/20 w-8 h-8 flex items-center justify-center rounded-lg transition text-indigo-200 hover:text-white" title="تقديم ساعة">
                    <i class="fas fa-forward"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Views -->
    <main class="container mx-auto p-4 md:p-6">
        
        <!-- View: Current Classes -->
        <section id="view-now" class="fade-in space-y-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-3 bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-100 text-indigo-700 w-10 h-10 rounded-full flex items-center justify-center text-lg">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">الحصص القائمة الآن</h2>
                    </div>
                </div>
                <div id="currentPeriodInfo"></div>
            </div>
            <!-- Compact Grid -->
            <div id="activeClassesGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-2"></div>
        </section>

        <!-- View: Teachers -->
        <section id="view-teachers" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col md:flex-row justify-between gap-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">سجل المعلمين</h2>
                    <p class="text-slate-500 text-sm">إدارة بيانات التواصل والتقييمات</p>
                </div>
                <div class="relative w-full md:w-96">
                    <input type="text" id="teacherSearch" onkeyup="window.app.renderTeachers()" placeholder="بحث عن معلم..." class="w-full pl-4 pr-10 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all outline-none bg-slate-50 focus:bg-white">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                </div>
            </div>
            <div id="teachersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
        </section>

        <!-- View: Reports -->
        <section id="view-reports" class="fade-in space-y-6 hidden-view">
            <div class="flex justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">تقارير الأداء</h2>
                    <p class="text-sm text-slate-500">نظرة عامة على انضباط المعلمين</p>
                </div>
                <button onclick="window.app.exportReports()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 transition shadow-lg shadow-emerald-200">
                    <i class="fas fa-file-excel"></i> <span>تصدير Excel</span>
                </button>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead class="bg-slate-50 border-b border-slate-100 text-slate-500 text-sm uppercase">
                            <tr>
                                <th class="p-5 font-bold">المعلم</th>
                                <th class="p-5 font-bold text-center">التقييم</th>
                                <th class="p-5 font-bold text-center">الهاتف</th>
                                <th class="p-5 font-bold text-center">الحالة</th>
                            </tr>
                        </thead>
                        <tbody id="reportsBody" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- View: Supervision History -->
        <section id="view-supervision-history" class="fade-in space-y-6 hidden-view">
            <div class="flex justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">سجل الزيارات الإشرافية</h2>
                    <p class="text-sm text-slate-500">أرشيف الزيارات السابقة والتقارير</p>
                </div>
            </div>
            <div id="supervisionHistoryGrid" class="space-y-3"></div>
        </section>

        <!-- View: Supervision Form -->
        <section id="view-supervision" class="fade-in space-y-6 hidden-view pb-20">
            <div class="flex items-center gap-2 mb-4 text-sm text-slate-500 cursor-pointer hover:text-indigo-600 transition" onclick="window.app.setView('now')">
                <i class="fas fa-arrow-right"></i> عودة
            </div>
            
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                    <i class="fas fa-clipboard-check text-indigo-500"></i> زيارة إشرافية ذكية
                </h2>
                
                <!-- Info Fields -->
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">المعلم</label>
                        <input type="text" id="supTeacherName" readonly class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-slate-700 font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">الصف</label>
                        <input type="text" id="supClassName" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-slate-700 focus:border-indigo-500 outline-none">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-slate-500 mb-1">عنوان الدرس</label>
                        <input type="text" id="supLessonTopic" placeholder="أدخل عنوان الدرس..." class="w-full bg-white border border-slate-200 rounded-lg p-2 text-slate-700 focus:border-indigo-500 outline-none">
                    </div>
                </div>

                <!-- Criteria List -->
                <div id="supervisionCriteriaList" class="space-y-6"></div>

                <button onclick="window.app.generateReport()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 transition mt-8 flex items-center justify-center gap-2 cursor-pointer">
                    <i class="fas fa-magic"></i> توليد التقرير الذكي
                </button>
            </div>
        </section>

        <!-- View: Supervision Report -->
        <section id="view-supervision-report" class="fade-in space-y-6 hidden-view bg-white p-8 rounded-none md:rounded-2xl shadow-none md:shadow-lg min-h-screen md:min-h-0 print:min-h-0">
            <!-- Header -->
            <div class="border-b-2 border-slate-800 pb-6 mb-6 flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-900 mb-2">تقرير زيارة إشرافية</h1>
                    <p class="text-slate-500 text-sm">نظام الإدارة المدرسية الذكي</p>
                </div>
                <div class="text-left text-sm text-slate-500">
                    <p id="reportDate" class="font-mono"></p>
                </div>
            </div>

            <!-- Basic Info -->
            <div class="bg-slate-50 rounded-xl p-6 border border-slate-200 mb-8">
                <div class="grid grid-cols-2 gap-y-4 text-sm">
                    <div><span class="text-slate-400 ml-2">المعلم:</span> <span id="repTeacherName" class="font-bold text-slate-800 text-lg"></span></div>
                    <div><span class="text-slate-400 ml-2">الصف:</span> <span id="repClassName" class="font-bold text-slate-800"></span></div>
                    <div class="col-span-2"><span class="text-slate-400 ml-2">الدرس:</span> <span id="repLessonTopic" class="font-bold text-slate-800"></span></div>
                </div>
            </div>

            <!-- Strengths -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-emerald-700 mb-4 flex items-center gap-2 bg-emerald-50 w-fit px-3 py-1 rounded-lg border border-emerald-100">
                    <i class="fas fa-star"></i> جوانب الإجادة
                </h3>
                <ul id="repStrengths" class="space-y-3 pr-4 list-disc marker:text-emerald-500 text-slate-700 text-sm leading-relaxed"></ul>
            </div>

            <!-- Improvements -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-amber-700 mb-4 flex items-center gap-2 bg-amber-50 w-fit px-3 py-1 rounded-lg border border-amber-100">
                    <i class="fas fa-wrench"></i> جوانب التحسين
                </h3>
                <ul id="repImprovements" class="space-y-3 pr-4 list-disc marker:text-amber-500 text-slate-700 text-sm leading-relaxed"></ul>
            </div>

            <!-- Recommendations -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-indigo-700 flex items-center gap-2 bg-indigo-50 w-fit px-3 py-1 rounded-lg border border-indigo-100">
                        <i class="fas fa-lightbulb"></i> التوصيات
                    </h3>
                    <button onclick="window.app.enhanceReportWithAI()" class="text-xs bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-3 py-1.5 rounded-full flex items-center gap-1 shadow-md hover:shadow-lg transition cursor-pointer no-print">
                        <i class="fas fa-wand-magic-sparkles"></i> تحسين بالذكاء الاصطناعي
                    </button>
                </div>
                <div class="bg-indigo-50/50 p-6 rounded-xl border border-indigo-100 text-slate-700 text-sm leading-relaxed relative">
                    <p class="mb-4 font-bold">شكراً لكم أستاذ <span id="repTeacherNameSmall"></span> على جهودكم المبذولة في الحصة الدراسية.</p>
                    <ul id="repRecommendations" class="space-y-2 list-decimal pr-4"></ul>
                    <!-- Loading Overlay for AI -->
                    <div id="aiLoadingOverlay" class="absolute inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-10 hidden-view">
                        <i class="fas fa-spinner fa-spin text-3xl text-indigo-600 mb-2"></i>
                        <span class="text-xs font-bold text-indigo-800">جاري صياغة التوصيات سياقياً...</span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex gap-4 mt-12 no-print">
                <button onclick="window.print()" class="flex-1 bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 cursor-pointer">
                    <i class="fas fa-print"></i> طباعة / PDF
                </button>
                <button onclick="window.app.saveVisit()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 cursor-pointer">
                    <i class="fas fa-save"></i> حفظ في السجل
                </button>
                <button onclick="window.app.setView('supervision')" class="flex-1 bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 py-3 rounded-xl font-bold transition cursor-pointer">
                    تعديل
                </button>
                <button onclick="window.app.setView('supervision-history')" class="flex-1 bg-red-50 border border-red-200 text-red-600 hover:bg-red-100 py-3 rounded-xl font-bold transition cursor-pointer">
                    إغلاق
                </button>
            </div>
        </section>

    </main>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-40 pb-safe no-print">
        <div class="flex justify-around items-center h-16 px-2">
            <button onclick="window.app.setView('now')" id="btn-now" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-indigo-700 transition-all duration-300 group">
                <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-indigo-50 group-hover:bg-indigo-100 transition-colors">
                    <i class="fas fa-chalkboard text-xl mb-0.5"></i>
                </div>
                <span class="text-[10px] font-bold">الحصص</span>
            </button>
            
            <button onclick="window.app.setView('teachers')" id="btn-teachers" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group">
                 <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors">
                    <i class="fas fa-users-cog text-xl mb-0.5"></i>
                 </div>
                <span class="text-[10px] font-bold">المعلمين</span>
            </button>
            
            <button onclick="window.app.setView('reports')" id="btn-reports" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group">
                 <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors">
                    <i class="fas fa-file-invoice text-xl mb-0.5"></i>
                 </div>
                <span class="text-[10px] font-bold">التقارير</span>
            </button>
            
            <button onclick="window.app.setView('supervision-history')" id="btn-supervision-history" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group">
                 <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors">
                    <i class="fas fa-history text-xl mb-0.5"></i>
                 </div>
                <span class="text-[10px] font-bold">السجل</span>
            </button>
            
            <button onclick="window.app.openSettings()" class="flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group">
                 <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors">
                    <i class="fas fa-cog text-xl mb-0.5"></i>
                 </div>
                <span class="text-[10px] font-bold">الإعدادات</span>
            </button>
        </div>
    </nav>

    <!-- Modals -->
    
    <!-- Action Modal -->
    <div id="modal-action" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden-view">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm modal-backdrop" onclick="window.app.closeModal('modal-action')"></div>
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-scale-in modal-content mb-20">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-start">
                <div>
                    <h3 class="text-lg font-bold flex items-center gap-2" id="actionModalTitle"></h3>
                    <p id="actionModalSubtitle" class="text-slate-300 text-xs mt-1"></p>
                </div>
                <button type="button" onclick="window.app.closeModal('modal-action')" class="text-white/50 hover:text-white"><i class="fas fa-times text-lg"></i></button>
            </div>
            
            <div class="p-4 space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar">
                <!-- Evaluation Button -->
                <button type="button" id="btn-evaluate" class="w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-700 border border-indigo-200 p-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition cursor-pointer mb-2">
                    <i class="fas fa-clipboard-list text-xl"></i>
                    <span>تقييم زيارة إشرافية</span>
                </button>

                <div class="h-px bg-slate-100 mb-2"></div>

                <!-- Communication Buttons -->
                <div class="space-y-2">
                     <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">التواصل</label>
                     <div class="grid grid-cols-2 gap-2">
                         <button type="button" onclick="window.app.sendWhatsApp('summon')" class="bg-emerald-50 hover:bg-emerald-100 text-emerald-700 border border-emerald-200 p-3 rounded-lg font-bold text-xs flex flex-col items-center gap-2 transition cursor-pointer">
                            <i class="fab fa-whatsapp text-xl"></i><span>استدعاء</span>
                         </button>
                         <button type="button" id="btn-remind" onclick="window.app.sendWhatsApp('remind')" class="bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-200 p-3 rounded-lg font-bold text-xs flex flex-col items-center gap-2 transition cursor-pointer">
                            <i class="fas fa-bell text-xl"></i><span>تذكير</span>
                         </button>
                     </div>
                </div>
                <div class="h-px bg-slate-100"></div>
                <!-- Dynamic Violation Buttons -->
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">المخالفات</label>
                    <div id="violationButtonsContainer" class="space-y-2"></div>
                </div>
            </div>
             <div class="bg-slate-50 p-3 text-center border-t border-slate-200 flex justify-between items-center px-6">
                <span class="text-xs text-slate-500">التقييم الحالي</span>
                <span class="text-lg font-bold text-slate-800" id="currentScoreDisplay"></span>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="modal-settings" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden-view">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm modal-backdrop" onclick="window.app.closeModal('modal-settings')"></div>
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden animate-scale-in flex flex-col max-h-[80vh] modal-content mb-16">
            <div class="bg-slate-800 text-white p-5 flex justify-between items-center shrink-0">
                <h3 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-cog"></i> الإعدادات</h3>
                <button type="button" onclick="window.app.closeModal('modal-settings')" class="text-white/70 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scrollbar space-y-8">
                <!-- Violation Management -->
                <div class="space-y-4">
                     <div class="flex items-center justify-between pb-2 border-b border-slate-100">
                        <h4 class="font-bold text-slate-800 text-sm flex items-center gap-2"><i class="fas fa-gavel text-red-500"></i> إدارة المخالفات</h4>
                    </div>
                    <!-- Add Form -->
                    <div class="flex gap-2 bg-slate-50 p-3 rounded-lg border border-slate-200 items-end">
                        <div class="flex-1 space-y-1">
                            <label class="text-[10px] font-bold text-slate-500">اسم المخالفة</label>
                            <input type="text" id="newViolationLabel" placeholder="مثلاً: عدم تحضير" class="w-full text-sm p-2 rounded border border-slate-300 focus:border-indigo-500 outline-none">
                        </div>
                        <div class="w-24 space-y-1">
                            <label class="text-[10px] font-bold text-slate-500">الخصم</label>
                            <input type="number" id="newViolationPoints" value="5" class="w-full text-sm p-2 rounded border border-slate-300 focus:border-indigo-500 outline-none text-center">
                        </div>
                        <button type="button" onclick="window.app.addViolation()" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded h-[38px] w-10 flex items-center justify-center transition cursor-pointer"><i class="fas fa-plus"></i></button>
                    </div>
                    <!-- List -->
                    <div id="violationsList" class="space-y-2"></div>
                </div>

                <!-- Imports -->
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                        <h4 class="font-bold text-indigo-900 mb-2 flex items-center gap-2 text-sm"><i class="fas fa-calendar-alt"></i> جدول الحصص (XML)</h4>
                        <button type="button" onclick="document.getElementById('xmlInput').click()" class="w-full bg-white hover:bg-indigo-100 text-indigo-700 border border-indigo-200 py-2 rounded-lg font-bold text-xs transition cursor-pointer">رفع ملف XML</button>
                        <input type="file" id="xmlInput" accept=".xml" class="hidden" onchange="window.app.handleXml(event)">
                    </div>
                    <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                        <h4 class="font-bold text-emerald-900 mb-2 flex items-center gap-2 text-sm"><i class="fas fa-users"></i> بيانات المعلمين (Excel)</h4>
                        <div class="flex gap-2">
                            <button type="button" onclick="window.app.exportTeacherTemplate()" class="flex-1 bg-white border border-emerald-200 text-emerald-700 hover:bg-emerald-100 py-2 rounded-lg font-bold text-xs transition cursor-pointer"><i class="fas fa-download"></i> تصدير</button>
                            <button type="button" onclick="document.getElementById('excelInput').click()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg font-bold text-xs transition cursor-pointer"><i class="fas fa-upload"></i> استيراد</button>
                        </div>
                        <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden" onchange="window.app.handleExcel(event)">
                    </div>
                    
                    <!-- Criteria Import -->
                    <div class="bg-purple-50 p-4 rounded-xl border border-purple-100 md:col-span-2">
                        <h4 class="font-bold text-purple-900 mb-2 flex items-center gap-2 text-sm"><i class="fas fa-clipboard-list"></i> معايير التقييم (JSON)</h4>
                        <button type="button" onclick="document.getElementById('jsonInput').click()" class="w-full bg-white hover:bg-purple-100 text-purple-700 border border-purple-200 py-2 rounded-lg font-bold text-xs transition cursor-pointer">رفع ملف معايير الزيارات (JSON)</button>
                        <input type="file" id="jsonInput" accept=".json" class="hidden" onchange="window.app.handleCriteriaJson(event)">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- App Logic -->
    <script>
        class SchoolApp {
            constructor() {
                this.state = {
                    teachers: [],
                    periods: [],
                    classes: {},
                    violationTypes: [
                        { id: 'late', label: 'تأخر عن الحصة', points: 5, icon: 'fa-clock' },
                        { id: 'absent', label: 'غياب عن الحصة', points: 15, icon: 'fa-user-slash' }
                    ],
                    simulationOffset: 0,
                    selectedTeacherId: null,
                    selectedClassName: null,
                    
                    // Supervision State
                    supervisionData: {
                        ratings: {}
                    },
                    supervisionHistory: [],
                    evaluationCriteria: []
                };
                this.db = null;
                
                // Initialize FULL default criteria
                this.initDefaultCriteria();
                
                // Initialize
                this.loadLocalData();
                this.startClock();
                this.initFirebase();
            }
            
            initDefaultCriteria() {
                // Populating with the full 13 items provided
                this.state.evaluationCriteria = [
                    { id: 1, title: "التحصيل الدراسي", items: {
                        1: { desc: "اكتسب جميع الطلبة المهارات الأساسية والمعارف في ضوء أهداف الدرس بصورة فعالة، بدليل تحسين النطق واللفظ والكتابة لدى جميع الطلبة بدرجة عالية.", rec: "تنفيذ مبادرة تربوية تعزز من اكتساب الطلبة للمهارات والمعارف مثل مبادرة المدقق اللغوي الصغير." },
                        2: { desc: "يكتسب معظم الطلبة المهارات الأساسية والمعارف في ضوء أهداف الدرس بصورة فاعلة، بدليل تحسين النطق واللفظ والكتابة لدى معظم الطلبة بدرجة جيدة.", rec: "تكثيف الأنشطة الإثرائية التي تستهدف الطلبة ذوي المستوى المرتفع لضمان استمرار تقدمهم وتحقيق نتائج أعلى." },
                        3: { desc: "يكتسب أغلب الطلبة المهارات الأساسية والمعارف في ضوء أهداف الدرس بصورة ملائمة أو مقبولة، بدليل تحقيق المستوى الأساسي من المهارات لدى أغلب الطلبة.", rec: "التركيز على تصميم أنشطة صفية متمايزة تضمن اكتساب جميع الطلبة للمهارات الأساسية المطلوبة." },
                        4: { desc: "اكتسب قلة من الطلبة المهارات الأساسية والمعارف في ضوء أهداف الدرس بصورة محدودة، بدليل انخفاض المستوى التحصيلي لمعظم الطلبة.", rec: "تنفيذ حصص تقوية للطلبة واستغلال حصص الاحتياط لتكثيف الخطط العلاجية والإثرائية." },
                        5: { desc: "يكتسب عدد نادر من الطلبة المهارات الأساسية والمعارف... بصورة محدودة جداً/نادرة.", rec: "وضع خطة علاجية فورية وشاملة، والعمل على حصر المهارات الأساسية المتأخرة لدى الطلبة." }
                    }},
                    { id: 2, title: "التقدم الدراسي", items: {
                        1: { desc: "يتقدم جميع الطلبة في المعارف والمفاهيم والمهارات مقارنة ببداية الحصة بصورة متميزة.", rec: "تنفيذ قراءة موجهة لزملاء العمل لآلية تطبيق هرم بلوم للأهداف في الانتقال من البسيط إلى الأعلى." },
                        2: { desc: "يتقدم معظم الطلبة دراسياً أثناء الحصة بصورة فاعلة، بدليل إنجاز معظم الطلاب للأعمال الفردية والجماعية.", rec: "الحرص على مراجعة آليات تفريد التعليم المقدمة للطلبة ذوي الاحتياجات التعليمية." },
                        3: { desc: "يتقدم أغلب الطلبة دراسياً أثناء الحصة بصورة ملائمة، بدليل إنجاز أغلب الطلاب للأعمال بصورة ملائمة.", rec: "ضمان توظيف هرم بلوم للأهداف بفاعلية في صياغة أسئلة الحصة والانتقال بالطلبة لمستويات التفكير العليا." },
                        4: { desc: "اكتسب بعض الطلبة المعارف والمفاهيم والمهارات مقارنة ببداية الحصة بصورة محدودة.", rec: "تطبيق مشروع تفريد التعلم وتنفيذ الخطط الفردية بما يتناسب مع جميع الطلبة." },
                        5: { desc: "يتقدم عدد نادر من الطلبة دراسياً أثناء الحصة بصورة محدودة جداً.", rec: "البدء فوراً في تنفيذ الخطط الفردية وتفريد التعلم لتلبية احتياجات جميع الطلبة." }
                    }},
                    { id: 3, title: "مهارات التعلم", items: {
                        1: { desc: "يطبق جميع الطلبة مهارات التعلم الذاتي والتعاوني والرقمي ومهارات التفكير العليا بصورة متميزة.", rec: "تنفيذ قراءة موجهة لآلية طرح أسئلة مثيرة للتفكير وتوجيه الطلبة للتعلم الذاتي دون توجيه المعلم." },
                        2: { desc: "يطبق معظم الطلبة مهارات التعلم الذاتي والتعاوني والرقمي بمستوى فاعل.", rec: "تعزيز توظيف المنصات الرقمية لتدريب الطلبة على التعلم الذاتي بشكل أوسع وأكثر عمقاً." },
                        3: { desc: "يطبق أغلب الطلبة مهارات التعلم بمستوى ملائم أو مناسب.", rec: "إدراج أنشطة صفية محددة تهدف لتنمية مهارات التفكير الناقد والابتكاري لدى الطلبة." },
                        4: { desc: "اكتسب بعض الطلبة مهارات التعلم الذاتي والتعاوني والرقمي بصورة محدودة.", rec: "تنفيذ مشروع يهدف إلى تنمية مهارات التعلم الذاتي والرقمي لدى الطلبة مثل تفعيل إحدى المنصات الرقمية." },
                        5: { desc: "يطبق عدد نادر من الطلبة مهارات التعلم بمستوى محدود جداً.", rec: "التركيز على تدريب الطلبة على أبسط مهارات التعلم (مثل مهارات البحث والتعاون)." }
                    }},
                    { id: 4, title: "القيم والسلوك", items: {
                        1: { desc: "يدرك جميع الطلبة للحقوق والواجبات ويعتزون بهويتهم العمانية بدرجة عالية.", rec: "تعزيز وتحفيز الطلبة بنماذج وملصقات تعبر عن الهوية العمانية وتغرس القيم والاتجاهات الإيجابية." },
                        2: { desc: "يلتزم معظم الطلبة بالقيم الإنسانية المشتركة بمستوى فاعل.", rec: "تصميم أنشطة إثرائية لتعزيز القيم الإيجابية لدى الطلبة، والعمل على تكريم السلوكيات الإيجابية." },
                        3: { desc: "يلتزم أغلب الطلبة بالقيم الإنسانية المشتركة بمستوى ملائم.", rec: "توفير فرص للطلبة لممارسة التعبير عن الذات والحوار بثقة واحترام." },
                        4: { desc: "يدرك بعض الطلبة الحقوق والواجبات بصورة محدودة، بدليل عدم انضباط بعض الطلبة ذاتياً.", rec: "تنفيذ مشروع يهدف إلى تنمية القيم والسلوك وتعزيز الهوية العمانية لدى الطلبة." },
                        5: { desc: "يلتزم عدد محدود جداً من الطلبة بالقيم الإنسانية... بدليل وجود حالات انفلات.", rec: "وضع خطة سلوكية مركزة لعلاج حالات عدم الانضباط في الحصة، والتنسيق مع الأخصائي الاجتماعي." }
                    }},
                    { id: 5, title: "جودة بيئة التعلم", items: {
                        1: { desc: "يتابع جميع جوانب الأمن والسلامة والنظافة في الصف الدراسي بصورة متميزة.", rec: "تنفيذ حصة تطبيقية حول جوانب الأمن والسلامة في البيئة الصفية." },
                        2: { desc: "يتابع المعلم جوانب الأمن والسلامة والنظافة بصورة جيدة.", rec: "توثيق الممارسات المتميزة في جوانب الأمن والسلامة والنظافة وتعميمها." },
                        3: { desc: "يتابع المعلم جوانب الأمن والسلامة والنظافة بصورة مناسبة.", rec: "التأكد من تطبيق سياسات الأمن والسلامة في جميع الأنشطة الصفية." },
                        4: { desc: "يتابع بعض جوانب الأمن والسلامة والنظافة في البيئة الصفية بصورة محدودة.", rec: "الالتزام بتدابير الأمن والسلامة في البيئة الصفية (أسلاك مكشوفة، تنبيهات تحذيرية)." },
                        5: { desc: "يتابع المعلم جوانب الأمن والسلامة بصورة نادرة منعدمة، بدليل وجود مخاطر واضحة.", rec: "اتخاذ إجراءات تصحيحية فورية لضمان سلامة الطلبة والالتزام الصارم بقواعد الأمن والسلامة." }
                    }},
                    { id: 6, title: "تخطيط المنهاج الدراسي", items: {
                        1: { desc: "يخطط لجميع دروسه متسلسلاً في تنوع الأهداف مرتبطاً بالخطة الفصلية ومحققاً لنواتج التعلم بصورة متميزة.", rec: "تنفيذ ورشة تدريبية لكيفية التخطيط للدرس بما يتوافق مع الخطة الفصلية كما هو مرسوم لها." },
                        2: { desc: "يخطط المعلم معظم دروسه بصورة جيدة، بدليل تحقق معظم نواتج التعلم.", rec: "تطوير التخطيط اليومي عبر إضافة أنشطة إثرائية وخطط علاجية واضحة ومحددة." },
                        3: { desc: "يخطط المعلم أغلب دروسه بصورة مناسبة، بدليل تحقق أغلب نواتج التعلم.", rec: "مراجعة التخطيط للتأكد من ربط الأهداف بنواتج التعلم المحددة في الخطة الفصلية." },
                        4: { desc: "يخطط لبعض دروسه متسلسلاً في تنوع الأهداف بصورة محدودة، بدليل تأخر في الخطة الفصلية.", rec: "الالتزام بتوافق أهداف خطة الدرس مع الخطة الفصلية كما هو مرسوم لها." },
                        5: { desc: "يخطط المعلم عدد محدود جداً من دروسه بصورة نادرة، بدليل وجود تأخر كبير في الخطة الفصلية.", rec: "الالتزام الفوري بإعداد خطط الدروس اليومية بشكل متكامل وتضمينها أهدافاً واضحة." }
                    }},
                    { id: 7, title: "إدارة الصف", items: {
                        1: { desc: "يقوم بإدارة زمن التعلم وسلوكيات جميع الطلبة ويثير دافعيتهم للتعلم بصورة فعالة.", rec: "العمل على تحليل نتائج الطلبة نهاية الفصل وتوثيق الأسئلة العاصفة للذهن." },
                        2: { desc: "يقوم المعلم بإدارة زمن التعلم وسلوك طلبته ويثير دافعيتهم بصورة جيدة.", rec: "إدراج استراتيجيات مبتكرة لإدارة سلوكيات الطلبة وتعزيز دافعيتهم للتعلم." },
                        3: { desc: "يقوم المعلم بإدارة زمن التعلم وسلوك طلبته ويثير دافعيتهم بصورة ملائمة.", rec: "الاستمرار في الإدارة الجيدة للحصة، مع التركيز على توظيف استراتيجيات تحويل السلوكيات السلبية." },
                        4: { desc: "يقوم بإدارة زمن التعلم وسلوكيات قلة من الطلبة بصورة محدودة.", rec: "الالتزام بزمن التعلم والعمل على إدارة وقت الحصة بشكل فعال من حيث تقسيم المراحل." },
                        5: { desc: "يقوم المعلم بإدارة زمن التعلم وسلوك طلبته بصورة نادرة، بدليل فقدان السيطرة.", rec: "تطبيق قواعد صارمة لإدارة الصف والالتزام بالخطة الزمنية للحصة." }
                    }},
                    { id: 8, title: "فاعلية التدريس", items: {
                        1: { desc: "يوظف استراتيجيات التدريس والتقنيات الحديثة بصورة فعالة (التعلم النشط) مما أدى إلى تعميق التعلم.", rec: "تصميم دليل رقمي لبعض المنصات الرقمية وبرامج الذكاء الاصطناعي التي يمكن توظيفها." },
                        2: { desc: "يوظف المعلم استراتيجيات تدريس فعالة بحيث يستفيد منها معظم الطلبة بمستوى فاعل.", rec: "توسيع نطاق توظيف برامج الذكاء الاصطناعي في تصميم الأنشطة المتمايزة." },
                        3: { desc: "يوظف المعلم استراتيجيات تدريس فعالة بحيث يستفيد منها أغلب الطلبة بمستوى ملائم.", rec: "التنويع في استراتيجيات التدريس لضمان تلبية احتياجات جميع الطلبة والابتعاد عن التلقين." },
                        4: { desc: "يوظف استراتيجيات التدريس والتقنيات الحديثة بصورة محدودة (مثل التلقين).", rec: "العمل على التنويع من مصادر التعلم وتحديدها وفقاً لاحتياجات جميع الطلبة." },
                        5: { desc: "يوظف المعلم استراتيجيات تدريس فعالة بمستوى نادر، بدليل عدم وجود تعلم فعلي.", rec: "استبدال استراتيجيات التلقين باستراتيجيات التعلم النشط وتحديد مصادر متنوعة." }
                    }},
                    { id: 9, title: "تفعيل المصادر والموارد", items: {
                        1: { desc: "يفعل المعلم التقنيات الرقمية بحيث يستفيد منها جميع الطلبة في تعميق تعلمهم بمستوى متميز.", rec: "توثيق أفضل ممارسات توظيف التقنيات الرقمية والذكاء الاصطناعي في الحصة وتعميمها." },
                        2: { desc: "يفعل المعلم التقنيات الرقمية بحيث يستفيد منها معظم الطلبة بمستوى جيد.", rec: "تشجيع الطلبة على استخدام التقنيات الرقمية كأداة للإنتاج المعرفي وليس فقط للاستهلاك." },
                        3: { desc: "يفعل المعلم التقنيات الرقمية بحيث يستفيد منها أغلب الطلبة بمستوى ملائم.", rec: "العمل على دمج المصادر الرقمية والتقليدية في خطة الدرس بطريقة واضحة وفعالة." },
                        4: { desc: "يفعل المعلم التقنيات الرقمية بحيث يستفيد منها قليل من الطلبة بمستوى محدود.", rec: "العمل على تنويع المصادر والموارد التعليمية المستخدمة (الرقمية وغير الرقمية)." },
                        5: { desc: "يفعل المعلم التقنيات الرقمية بمستوى نادر منعدم.", rec: "البدء فوراً في تفعيل المصادر والموارد التعليمية المتاحة ودمجها في الأنشطة الصفية." }
                    }},
                    { id: 10, title: "التقويم ومساندة التقدم", items: {
                        1: { desc: "يوظف أساليب تقويم متنوعة تراعي التمايز بين جميع الطلبة بدرجة عالية.", rec: "تشكيل فريق عمل لصياغة مجموعة أنشطة صفية فردية وجماعية ضمن خطة المنهج." },
                        2: { desc: "يوظف المعلم أساليب تقويم متنوعة تراعي التمايز بين معظم الطلبة بمستوى فاعل.", rec: "تعميم تجربة توظيف أساليب التقويم المتنوعة على الزملاء كأفضل ممارسة." },
                        3: { desc: "يوظف المعلم أساليب تقويم متنوعة تراعي التمايز بين أغلب الطلبة بمستوى ملائم.", rec: "مراجعة أدوات التقويم المستخدمة للتأكد من أنها تغطي المستويات المعرفية الثلاثة." },
                        4: { desc: "يوظف المعلم أساليب تقويم متنوعة تراعي التمايز بين قليل من الطلبة بمستوى محدود.", rec: "التنويع من أساليب تقويم تراعي التمايز بين جميع الطلبة والتنويع في الأسئلة." },
                        5: { desc: "يوظف المعلم أساليب تقويم متنوعة تراعي التمايز بمستوى نادر (الاعتماد الكلي على أسلوب واحد).", rec: "التنويع الفوري في أساليب التقويم (الشفوي، الكتابي، الأداء) وتصحيح الأدوات المستخدمة." }
                    }},
                    { id: 11, title: "قيادة التغيير", items: {
                        1: { desc: "يُجري تقويماً لأدائه ذاتياً ويوظفه في تحسين تعلم جميع الطلبة بمستوى متميز.", rec: "تنفيذ مشغل تدريبي لزملائه حول أحد جوانب الإجادة التي تميز بها." },
                        2: { desc: "يُجري المعلم تقويماً لأدائه ذاتياً ويوظفه في تحسين تعلم معظم الطلبة بمستوى فاعل.", rec: "تشجيع الزملاء على تبني ممارساته المتميزة في التقويم الذاتي وتطوير الأداء." },
                        3: { desc: "يُجري المعلم تقويماً لأدائه ذاتياً ويوظفه في تحسين تعلم أغلب الطلبة بمستوى مناسب.", rec: "الالتزام ببرامج التطوير المهني المتاحة والعمل على تطبيق المكتسب منها." },
                        4: { desc: "يُجري تقويماً لأدائه ذاتياً بشكل محدود (قلة المشاركات المهنية).", rec: "الالتزام بالمشاركة المهنية وفقاً لاحتياجاته كحضور الورش والمحاضرات." },
                        5: { desc: "يُجري المعلم تقويماً لأدائه ذاتياً ويوظفه بمستوى نادر (عدم إجراء أي تقويم ذاتي).", rec: "الالتزام بحضور الورش والمحاضرات المهنية وحلقات النقاش والبدء في توثيق ممارساته." }
                    }},
                    { id: 12, title: "الحوكمة", items: {
                        1: { desc: "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة فعالة (المحافظة على زمن التعلم).", rec: "الاستمرار بتطبيق اللوائح والأنظمة المنظمة للعمل ومتابعة أثر الانضباط على التحصيل." },
                        2: { desc: "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة فاعلة.", rec: "توثيق الممارسات المتميزة في تطبيق الأنظمة واللوائح وتأثيرها على البيئة المدرسية." },
                        3: { desc: "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة مناسبة.", rec: "التأكد من أن الالتزام باللوائح والأنظمة ينعكس إيجاباً على أداء الطلبة." },
                        4: { desc: "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة محدودة.", rec: "الالتزام باللوائح والأنظمة وضرورة المحافظة على زمن التعلم والانضباط الوظيفي." },
                        5: { desc: "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة نادرة (إخلال واضح).", rec: "الالتزام التام بالدوام الرسمي وضبط زمن التعلم وتطبيق كافة الأنظمة واللوائح." }
                    }},
                    { id: 13, title: "المبادرات والأنشطة", items: {
                        1: { desc: "يقدم مبادرات فعالة لدعم وتحسين العملية التعليمية ويتميز بالتفاعل الإيجابي.", rec: "توثيق مبادرة التحصيل الدراسي بطريقة علمية للمشاركة بها ضمن مبادرات الإجادة." },
                        2: { desc: "يقدم مبادرات فاعلة ويتميز بالتفاعل الإيجابي في معظم الأنشطة التربوية.", rec: "التوسع في مجال المبادرة والعمل على توثيق أثرها بشكل دقيق وعلمي." },
                        3: { desc: "يقدم مبادرات ملائمة ويتفاعل إيجابياً في أغلب الأنشطة التربوية.", rec: "الاستمرار في تقديم المبادرات والتفاعل الإيجابي وقيادة فريق عمل." },
                        4: { desc: "يقدم مبادرات محدودة ويتميز بالتفاعل المحدود في الأنشطة التربوية.", rec: "الالتزام بحضور الاجتماعات والورش والبرامج الإنمائية المنفذة بالمدرسة." },
                        5: { desc: "نادراً ما يقدم مبادرات وتفاعله محدود جداً، مما أدى إلى جمود في الأداء.", rec: "الالتزام التام بحضور الاجتماعات والبرامج والمبادرة فوراً بتقديم مقترح لمبادرة تربوية." }
                    }}
                ];
            }

            initFirebase() {
                const firebaseConfig = {
                    apiKey: "AIzaSyC4NddjijF29YNhowy4SqgRaMPn01oSSEg",
                    authDomain: "school-9416e.firebaseapp.com",
                    projectId: "school-9416e",
                    storageBucket: "school-9416e.firebasestorage.app",
                    messagingSenderId: "680872052240",
                    appId: "1:680872052240:web:96d2e544166ab5f8096c95",
                    measurementId: "G-5EBTV0MV83"
                };
                
                try {
                    if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    if(typeof firebase !== 'undefined') {
                        this.db = firebase.firestore();
                        this.db.collection("school_settings").doc("timetable")
                            .onSnapshot((doc) => {
                                if(doc.exists) {
                                    const data = doc.data();
                                    this.state.teachers = data.teachers || [];
                                    this.state.periods = data.periods || [];
                                    this.state.classes = data.classes || {};
                                    if(data.violationTypes) this.state.violationTypes = data.violationTypes;
                                    if(data.supervisionHistory) this.state.supervisionHistory = data.supervisionHistory;
                                    if(data.evaluationCriteria) this.state.evaluationCriteria = data.evaluationCriteria;
                                    
                                    this.renderAll();
                                    this.saveToLocal();
                                    this.updateCloudStatus('connected');
                                }
                            }, (error) => {
                                console.error("Cloud Error:", error);
                                this.updateCloudStatus('error');
                            });
                    }
                } catch (e) {
                    console.error("Firebase Init Error:", e);
                    this.updateCloudStatus('error');
                }
            }

            loadLocalData() {
                const local = localStorage.getItem('school_data_v1');
                if(local) {
                    try {
                        const parsed = JSON.parse(local);
                        this.state.teachers = parsed.teachers || [];
                        this.state.periods = parsed.periods || [];
                        this.state.classes = parsed.classes || {};
                        if(parsed.violationTypes) this.state.violationTypes = parsed.violationTypes;
                        if(parsed.supervisionHistory) this.state.supervisionHistory = parsed.supervisionHistory;
                        if(parsed.evaluationCriteria) this.state.evaluationCriteria = parsed.evaluationCriteria;
                        this.renderAll();
                    } catch(e) { console.error("Local Load Error", e); }
                }
            }

            saveToLocal() {
                localStorage.setItem('school_data_v1', JSON.stringify({
                    teachers: this.state.teachers,
                    periods: this.state.periods,
                    classes: this.state.classes,
                    violationTypes: this.state.violationTypes,
                    supervisionHistory: this.state.supervisionHistory,
                    evaluationCriteria: this.state.evaluationCriteria,
                    lastSync: new Date()
                }));
            }

            async saveData() {
                this.saveToLocal();
                this.renderAll();

                if(!this.db) return;
                
                this.updateCloudStatus('saving');
                try {
                    await this.db.collection("school_settings").doc("timetable").set({
                        teachers: this.state.teachers,
                        periods: this.state.periods,
                        classes: this.state.classes,
                        violationTypes: this.state.violationTypes,
                        supervisionHistory: this.state.supervisionHistory,
                        evaluationCriteria: this.state.evaluationCriteria,
                        lastSync: new Date()
                    }, { merge: true });
                } catch(e) { 
                    console.error("Save Error:", e);
                    this.updateCloudStatus('error'); 
                }
            }

            updateCloudStatus(status) {
                const badge = document.getElementById('cloudStatusBadge');
                if(!badge) return;
                if(status === 'connected') {
                    badge.innerHTML = '<i class="fas fa-circle text-[5px] animate-pulse"></i> متصل';
                    badge.className = "text-[9px] mt-1 bg-green-500/20 text-green-300 px-1.5 py-0.5 rounded-full border border-green-500/30 w-fit flex items-center gap-1";
                } else if(status === 'saving') {
                    badge.innerHTML = '<i class="fas fa-sync fa-spin text-[6px]"></i> حفظ...';
                    badge.className = "text-[9px] mt-1 bg-amber-500/20 text-amber-300 px-1.5 py-0.5 rounded-full border border-amber-500/30 w-fit flex items-center gap-1";
                } else {
                    badge.innerHTML = '<i class="fas fa-wifi-slash"></i>';
                    badge.className = "text-[9px] mt-1 bg-red-500/20 text-red-300 px-1.5 py-0.5 rounded-full border border-red-500/30 w-fit flex items-center gap-1";
                }
            }

            startClock() {
                setInterval(() => {
                    const now = new Date(new Date().getTime() + this.state.simulationOffset);
                    const el = document.getElementById('clockDisplay');
                    if(el) el.innerText = now.toLocaleTimeString('en-US', {hour12:false});
                    this.renderCurrentPeriod(now);
                }, 1000);
            }

            addSimulationHour() {
                this.state.simulationOffset += 3600000;
                const now = new Date(new Date().getTime() + this.state.simulationOffset);
                const el = document.getElementById('clockDisplay');
                if(el) el.innerText = now.toLocaleTimeString('en-US', {hour12:false});
                this.renderCurrentPeriod(now);
            }

            setView(viewName) {
                ['now', 'teachers', 'reports', 'supervision', 'supervision-report', 'supervision-history'].forEach(v => {
                    const el = document.getElementById(`view-${v}`);
                    if(el) el.classList.add('hidden-view');
                    const btn = document.getElementById(`btn-${v}`);
                    
                    if(btn) {
                        // Reset to inactive state (Bottom Nav style)
                        btn.className = "nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group";
                        const iconContainer = btn.querySelector('div');
                        if(iconContainer) {
                             iconContainer.className = "w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors";
                        }
                    }
                });
                
                // Show View
                const view = document.getElementById(`view-${viewName}`);
                if(view) view.classList.remove('hidden-view');
                
                // Set Active State
                const activeBtn = document.getElementById(`btn-${viewName}`);
                if(activeBtn) {
                     activeBtn.className = "nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-indigo-700 transition-all duration-300 group";
                     const iconContainer = activeBtn.querySelector('div');
                     if(iconContainer) {
                         iconContainer.className = "w-10 h-8 flex items-center justify-center rounded-xl bg-indigo-50 group-hover:bg-indigo-100 transition-colors";
                     }
                }

                if(viewName === 'teachers') this.renderTeachers();
                if(viewName === 'reports') this.renderReports();
                if(viewName === 'supervision-history') this.renderHistory();
            }

            renderAll() {
                // Find active button to determine current view
                let currentView = 'now';
                const nowBtn = document.getElementById('btn-now');
                if(nowBtn && nowBtn.classList.contains('text-indigo-700')) currentView = 'now';
                else {
                    const teachBtn = document.getElementById('btn-teachers');
                    if(teachBtn && teachBtn.classList.contains('text-indigo-700')) currentView = 'teachers';
                    else {
                        const repBtn = document.getElementById('btn-reports');
                        if(repBtn && repBtn.classList.contains('text-indigo-700')) currentView = 'reports';
                    }
                }
                
                if(currentView === 'now') {
                     const now = new Date(new Date().getTime() + this.state.simulationOffset);
                     this.renderCurrentPeriod(now);
                } else if (currentView === 'teachers') {
                    this.renderTeachers();
                } else if (currentView === 'reports') {
                    this.renderReports();
                }
            }

            renderCurrentPeriod(now) {
                const mins = now.getHours() * 60 + now.getMinutes();
                const currentPeriod = this.state.periods.find(p => {
                    const [sh, sm] = p.start.split(':').map(Number);
                    const [eh, em] = p.end.split(':').map(Number);
                    return mins >= (sh*60+sm) && mins <= (eh*60+em);
                });

                const infoDiv = document.getElementById('currentPeriodInfo');
                if(infoDiv) {
                    if(currentPeriod) {
                        infoDiv.innerHTML = `
                            <div class="flex items-center gap-3 bg-indigo-50 px-4 py-2 rounded-lg border border-indigo-100 shadow-sm">
                                <span class="text-indigo-900 font-bold">الحصة ${currentPeriod.id}</span>
                                <span class="text-indigo-300">|</span>
                                <span class="text-indigo-600 font-mono text-sm">${currentPeriod.start} - ${currentPeriod.end}</span>
                            </div>`;
                    } else {
                        infoDiv.innerHTML = `<div class="bg-amber-50 text-amber-700 px-4 py-2 rounded-lg border border-amber-100 font-bold text-sm">لا توجد حصص نشطة</div>`;
                    }
                }

                this.renderActiveClasses(now, currentPeriod);
            }

            renderActiveClasses(now, period) {
                const grid = document.getElementById('activeClassesGrid');
                if(!grid) return;
                
                if(!period) {
                    grid.innerHTML = `<div class="col-span-full py-16 text-center text-slate-400 bg-slate-50 rounded-xl border-2 border-dashed border-slate-200"><i class="fas fa-coffee text-3xl mb-3 text-slate-300"></i><p class="text-sm">لا توجد حصص في الوقت الحالي</p></div>`;
                    return;
                }

                const dayId = now.getDay() + 1;
                const pId = parseInt(period.id);
                
                let active = [];
                this.state.teachers.forEach(t => {
                    const l = t.lessons.find(ls => ls.day === dayId && ls.period === pId);
                    if(l) active.push({ t, className: l.className });
                });
                
                active.sort((a, b) => {
                    const getGrade = (name) => {
                        const n = name.trim();
                        if (n.match(/(الثاني|ثاني)\s*عشر/)) return 12;
                        if (n.match(/(الحادي|حادي)\s*عشر/)) return 11;
                        if (n.match(/العاشر|عاشر/)) return 10;
                        if (n.match(/التاسع|تاسع/)) return 9;
                        if (n.match(/الثامن|ثامن/)) return 8;
                        if (n.match(/السابع|سابع/)) return 7;
                        if (n.match(/السادس|سادس/)) return 6;
                        if (n.match(/الخامس|خامس/)) return 5;
                        if (n.match(/الرابع|رابع/)) return 4;
                        if (n.match(/الثالث|ثالث/)) return 3;
                        if (n.match(/الثاني|ثاني/)) return 2;
                        if (n.match(/الاول|الأول|اول|أول/)) return 1;
                        const match = n.match(/\d+/);
                        return match ? parseInt(match[0]) : 999;
                    };
                    const gA = getGrade(a.className);
                    const gB = getGrade(b.className);
                    if (gA !== gB) return gA - gB;
                    
                    const getSection = (str) => {
                         const nums = str.match(/\d+/g);
                         return nums ? parseInt(nums[nums.length-1]) : 0;
                    };
                    const sA = getSection(a.className);
                    const sB = getSection(b.className);
                    if (sA !== sB) return sA - sB;
                    return a.className.localeCompare(b.className, 'ar');
                });

                grid.innerHTML = active.map(item => `
                    <div class="group bg-white rounded-lg shadow-sm hover:shadow-md transition-all duration-300 border border-slate-200 overflow-hidden relative flex flex-col">
                        <div class="h-1 w-full bg-indigo-500"></div>
                        <div class="p-2 flex-1 flex flex-col">
                            <div class="flex justify-between items-center mb-1">
                                <span class="bg-slate-100 text-slate-800 px-2 py-0.5 rounded text-xs font-bold border border-slate-200 truncate max-w-[70%]">
                                    ${item.className}
                                </span>
                                <div class="w-5 h-5 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center text-[9px] font-bold border border-indigo-100">
                                   ${item.t.short[0] || '?'}
                                </div>
                            </div>
                            <h3 class="font-bold text-xs text-slate-700 mb-1 truncate">${item.t.name}</h3>
                            <div class="flex items-center gap-1 text-[9px] text-slate-400 mb-2"><i class="fas fa-star text-yellow-400"></i> <span>${item.t.score}%</span></div>
                            <button type="button" onclick="window.app.openActionModal('${item.t.id}', '${item.className}')" class="mt-auto w-full py-1 rounded bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-bold text-[10px] transition-colors flex justify-center items-center gap-1 cursor-pointer"><i class="fas fa-cog"></i> إجراء</button>
                        </div>
                    </div>
                `).join('');
            }

            renderTeachers() {
                const termInput = document.getElementById('teacherSearch');
                const term = termInput ? termInput.value.toLowerCase() : '';
                const grid = document.getElementById('teachersGrid');
                if(!grid) return;
                
                let filtered = this.state.teachers.filter(t => t.name.toLowerCase().includes(term));
                filtered.sort((a,b) => a.name.localeCompare(b.name, 'ar'));

                grid.innerHTML = filtered.map(t => {
                    let scoreColor = t.score >= 90 ? "bg-emerald-50 text-emerald-600 border-emerald-100" : (t.score >= 70 ? "bg-yellow-50 text-yellow-600 border-yellow-100" : "bg-red-50 text-red-600 border-red-100");
                    return `
                    <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition border border-slate-100 p-5 flex flex-col gap-4">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3">
                                 <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white flex items-center justify-center font-bold shadow-sm">${t.short[0] || '?'}</div>
                                <div><h3 class="font-bold text-slate-800 line-clamp-1">${t.name}</h3><span class="text-xs text-slate-500">${t.short}</span></div>
                            </div>
                            <div class="font-bold text-sm px-2 py-1 rounded-md border ${scoreColor}">${t.score}%</div>
                        </div>
                        <div class="relative group/input">
                             <i class="fas fa-phone absolute right-3 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within/input:text-indigo-500 transition-colors"></i>
                            <input type="tel" value="${t.phone || ''}" onchange="window.app.updatePhone('${t.id}', this.value)" placeholder="أضف رقم الهاتف" class="w-full pr-9 pl-3 py-2 text-sm rounded-lg border border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all dir-rtl">
                        </div>
                        <div class="flex gap-2 mt-auto pt-2 border-t border-slate-50">
                            <button type="button" onclick="window.app.openActionModal('${t.id}')" class="flex-1 bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 py-2 rounded-lg text-xs font-bold transition cursor-pointer">خيارات</button>
                             <button type="button" onclick="window.app.openWhatsApp('${t.id}')" class="w-10 flex items-center justify-center bg-green-50 hover:bg-green-100 text-green-600 border border-green-200 rounded-lg transition cursor-pointer"><i class="fab fa-whatsapp"></i></button>
                        </div>
                    </div>`;
                }).join('');
            }

            renderReports() {
                const tbody = document.getElementById('reportsBody');
                if(!tbody) return;
                tbody.innerHTML = this.state.teachers.map(t => {
                    let badge = t.score >= 90 ? "bg-green-100 text-green-700" : (t.score >= 70 ? "bg-yellow-100 text-yellow-700" : "bg-red-100 text-red-700");
                    let status = t.score < 80 ? '<span class="text-xs text-red-500 font-bold bg-red-50 px-2 py-1 rounded">يحتاج متابعة</span>' : '<span class="text-xs text-green-500 font-bold bg-green-50 px-2 py-1 rounded">ممتاز</span>';
                    return `
                        <tr class="hover:bg-slate-50/50 transition-colors">
                            <td class="p-5 font-semibold text-slate-700"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded bg-indigo-50 text-indigo-600 flex items-center justify-center text-xs font-bold">${t.short[0] || '?'}</div>${t.name}</div></td>
                            <td class="p-5 text-center"><span class="inline-block px-3 py-1 rounded-full text-xs font-bold ${badge}">${t.score}%</span></td>
                            <td class="p-5 text-center text-slate-500 font-mono text-sm">${t.phone || '-'}</td>
                            <td class="p-5 text-center">${status}</td>
                        </tr>`;
                }).join('');
            }

            renderHistory() {
                const grid = document.getElementById('supervisionHistoryGrid');
                if(!grid) return;
                
                const history = this.state.supervisionHistory || [];
                if(history.length === 0) {
                    grid.innerHTML = '<div class="text-center p-10 text-slate-400 bg-slate-50 rounded-xl border border-dashed border-slate-200">لا يوجد سجل زيارات حتى الآن</div>';
                    return;
                }

                // Sort by date desc
                history.sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime());

                grid.innerHTML = history.map((visit, index) => `
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center gap-4 hover:border-indigo-200 transition">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-slate-800 text-lg">${visit.teacherName}</span>
                                <span class="bg-slate-100 text-slate-600 text-xs px-2 py-0.5 rounded border border-slate-200">${visit.className}</span>
                            </div>
                            <p class="text-sm text-slate-500 mb-1"><i class="fas fa-book-open ml-1"></i> ${visit.topic || 'بدون عنوان'}</p>
                            <span class="text-xs text-slate-400 font-mono">${visit.date}</span>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                            <button onclick="window.app.loadVisit(${index})" class="flex-1 md:flex-none bg-indigo-50 text-indigo-700 hover:bg-indigo-100 px-4 py-2 rounded-lg font-bold text-xs transition cursor-pointer">
                                <i class="fas fa-eye"></i> عرض
                            </button>
                            <button onclick="window.app.deleteVisit(${index})" class="md:flex-none text-red-400 hover:text-red-600 px-3 py-2 rounded-lg transition cursor-pointer" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            // --- Actions ---
            updatePhone(id, val) {
                const t = this.state.teachers.find(x => x.id === id);
                if(t) { t.phone = val; this.saveData(); }
            }

            openActionModal(tId, className = null) {
                this.state.selectedTeacherId = tId;
                this.state.selectedClassName = className;
                const t = this.state.teachers.find(x => x.id === tId);
                
                if(!t) return;

                document.getElementById('actionModalTitle').innerHTML = `<i class="fas fa-user-edit text-yellow-400"></i> ${t.name}`;
                document.getElementById('actionModalSubtitle').innerText = className && className !== 'undefined' ? `الحصة الحالية: ${className}` : 'قائمة الإدارة';
                document.getElementById('currentScoreDisplay').innerText = t.score + '%';

                const remindBtn = document.getElementById('btn-remind');
                const evaluateBtn = document.getElementById('btn-evaluate');
                
                if(className && className !== 'undefined') {
                    remindBtn.disabled = false;
                    remindBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    
                    // Setup Evaluate Button
                    evaluateBtn.onclick = () => {
                        this.closeModal('modal-action');
                        this.startSupervision(tId, className);
                    };
                    evaluateBtn.style.display = 'flex';
                } else {
                    remindBtn.disabled = true;
                    remindBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    
                    // Allow evaluation even if not in class (general eval)
                    evaluateBtn.onclick = () => {
                        this.closeModal('modal-action');
                        this.startSupervision(tId, 'زيارة عامة');
                    };
                }
                
                // Render Dynamic Violation Buttons (Existing logic)
                const container = document.getElementById('violationButtonsContainer');
                if(container) {
                    container.innerHTML = this.state.violationTypes.map(v => `
                        <button type="button" onclick="window.app.dockScore('${v.id}')" class="w-full bg-slate-50 hover:bg-red-50 text-slate-700 hover:text-red-700 border border-slate-200 hover:border-red-200 p-3 rounded-lg flex items-center justify-between transition group cursor-pointer">
                            <span class="flex items-center gap-3 font-bold text-sm">
                                <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-400 group-hover:text-red-500 group-hover:border-red-200 transition">
                                    <i class="fas ${v.icon}"></i>
                                </div>
                                ${v.label}
                            </span>
                            <span class="bg-white px-2 py-1 rounded text-xs font-bold text-red-500 border border-slate-200 group-hover:border-red-200 shadow-sm">
                                -${v.points}
                            </span>
                        </button>
                    `).join('');
                }

                document.getElementById('modal-action').classList.remove('hidden-view');
            }

            closeModal(id) { 
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden-view'); 
            }
            
            // --- Supervision Logic ---
            startSupervision(teacherId, className) {
                const t = this.state.teachers.find(x => x.id === teacherId);
                if(!t) return;

                document.getElementById('supTeacherName').value = t.name;
                document.getElementById('supClassName').value = className;
                document.getElementById('supLessonTopic').value = '';
                
                // Reset Ratings
                this.state.supervisionData = { ratings: {} };
                
                // Render Criteria Form with Radio Buttons & Description
                const list = document.getElementById('supervisionCriteriaList');
                list.innerHTML = this.state.evaluationCriteria.map((criterion, index) => `
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <h3 class="font-bold text-slate-800 text-base mb-4 border-b border-slate-200 pb-2 flex items-center gap-2">
                            <span class="bg-indigo-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">${index + 1}</span>
                            ${criterion.title}
                        </h3>
                        <div class="space-y-3">
                            ${[1,2,3,4,5].map(rating => {
                                const desc = criterion.items[rating] ? criterion.items[rating].desc : '';
                                return `
                                <label class="relative flex items-start gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer bg-white hover:bg-slate-50 transition-colors group">
                                    <input type="radio" name="criteria_${criterion.id}" value="${rating}" 
                                        onchange="window.app.setRating(${criterion.id}, ${rating})" class="sup-radio peer mt-1 accent-indigo-600">
                                    
                                    <!-- Custom Radio UI (Optional enhancement can be added via CSS, keeping it simple native for reliability) -->
                                    
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="font-bold text-indigo-700 bg-indigo-50 px-2 rounded text-xs">مستوى ${rating}</span>
                                        </div>
                                        <p class="text-xs text-slate-600 leading-relaxed">${desc}</p>
                                    </div>
                                    
                                    <!-- Checked Indicator -->
                                    <div class="check-icon hidden text-indigo-600 absolute top-3 left-3">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </label>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `).join('');

                this.setView('supervision');
            }

            setRating(criteriaId, rating) {
                this.state.supervisionData.ratings[criteriaId] = rating;
                
                // Add styling to selected parent (handled via CSS :checked)
            }

            generateReport(isLoad = false, existingData = null) {
                const ratings = existingData ? existingData.ratings : this.state.supervisionData.ratings;
                
                if(!isLoad && Object.keys(ratings).length < this.state.evaluationCriteria.length) {
                    alert('يرجى استكمال تقييم جميع البنود');
                    return;
                }

                const tName = isLoad ? existingData.teacherName : document.getElementById('supTeacherName').value;
                const cName = isLoad ? existingData.className : document.getElementById('supClassName').value;
                const lTopic = isLoad ? existingData.topic : document.getElementById('supLessonTopic').value || '-';
                const rDate = isLoad ? existingData.date : new Date().toLocaleDateString('ar-EG');

                // Fill Report Info
                document.getElementById('repTeacherName').innerText = tName;
                document.getElementById('repTeacherNameSmall').innerText = tName;
                document.getElementById('repClassName').innerText = cName;
                document.getElementById('repLessonTopic').innerText = lTopic;
                document.getElementById('reportDate').innerText = rDate;

                // Analyze Ratings
                const analysis = [];
                this.state.evaluationCriteria.forEach(c => {
                    const r = ratings[c.id];
                    if(r) {
                        analysis.push({
                            id: c.id,
                            title: c.title,
                            rating: r,
                            desc: c.items[r].desc,
                            rec: c.items[r].rec
                        });
                    }
                });

                const strengths = [...analysis].sort((a,b) => a.rating - b.rating).slice(0, 3);
                
                const improvements = [...analysis]
                    .filter(a => a.rating > 2)
                    .sort((a,b) => b.rating - a.rating)
                    .slice(0, 4);

                // Render Lists
                document.getElementById('repStrengths').innerHTML = strengths.map(s => `<li><span class="font-bold text-emerald-700">${s.title}:</span> ${s.desc}</li>`).join('');

                if(improvements.length > 0) {
                    document.getElementById('repImprovements').innerHTML = improvements.map(s => `<li><span class="font-bold text-amber-700">${s.title}:</span> ${s.desc}</li>`).join('');
                } else {
                    document.getElementById('repImprovements').innerHTML = '<li class="text-slate-400 italic">لا توجد جوانب تحسين ملحوظة (أداء متميز).</li>';
                }

                // If loading existing data, use saved recommendations if available
                if (isLoad && existingData.finalRecommendations) {
                     document.getElementById('repRecommendations').innerHTML = existingData.finalRecommendations;
                } else {
                    // Default Recommendations
                    const recSource = improvements.length > 0 ? improvements : strengths; 
                    document.getElementById('repRecommendations').innerHTML = recSource.map(s => `<li>${s.rec}</li>`).join('');
                }

                this.setView('supervision-report');
            }

            saveVisit() {
                const tName = document.getElementById('repTeacherName').innerText;
                const cName = document.getElementById('repClassName').innerText;
                const lTopic = document.getElementById('repLessonTopic').innerText;
                const rDate = document.getElementById('reportDate').innerText;
                const recHtml = document.getElementById('repRecommendations').innerHTML;

                const visitData = {
                    id: Date.now().toString(),
                    teacherName: tName,
                    className: cName,
                    topic: lTopic,
                    date: rDate,
                    ratings: {...this.state.supervisionData.ratings},
                    finalRecommendations: recHtml // Save potentially AI-enhanced text
                };

                // Add to history
                if(!this.state.supervisionHistory) this.state.supervisionHistory = [];
                this.state.supervisionHistory.push(visitData);
                
                this.saveData();
                alert('تم حفظ الزيارة في السجل بنجاح');
            }

            loadVisit(index) {
                // We need to sort the history first to match the display index
                const sortedHistory = [...this.state.supervisionHistory].sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime());
                const visit = sortedHistory[index];
                if(visit) {
                    this.state.supervisionData = { ratings: visit.ratings };
                    this.generateReport(true, visit);
                }
            }

            deleteVisit(index) {
                if(confirm('هل أنت متأكد من حذف هذا التقرير؟')) {
                    // Match sorting logic to find correct index in original array
                    const sortedHistory = [...this.state.supervisionHistory].sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime());
                    const targetId = sortedHistory[index].id;
                    
                    this.state.supervisionHistory = this.state.supervisionHistory.filter(v => v.id !== targetId);
                    this.saveData();
                    this.renderHistory();
                }
            }

            // --- AI Enhancement ---
            async enhanceReportWithAI() {
                const topic = document.getElementById('repLessonTopic').innerText;
                const recContainer = document.getElementById('repRecommendations');
                const currentRecs = recContainer.innerText;
                
                if(!topic || topic === '-') {
                    alert('يرجى تحديد عنوان الدرس أولاً للحصول على صياغة سياقية.');
                    return;
                }

                // Show Loading
                document.getElementById('aiLoadingOverlay').classList.remove('hidden-view');

                try {
                    // --- API Key Retrieval Logic ---
                    let apiKey = '';
                    
                    // 1. Try process.env (Node-like environments/Bundlers)
                    if (typeof process !== 'undefined' && process.env && process.env.API_KEY) {
                        apiKey = process.env.API_KEY;
                    } 
                    
                    if (!apiKey) {
                        throw new Error("API Key is missing. Environment variable process.env.API_KEY not found.");
                    }

                    if (typeof window.GoogleGenAI === 'undefined') {
                         throw new Error("SDK not loaded from esm.sh");
                    }

                    const ai = new window.GoogleGenAI({ apiKey: apiKey });
                    
                    const response = await ai.models.generateContent({
                        model: 'gemini-2.5-flash',
                        config: {
                            systemInstruction: "أنت خبير تربوي وموجه فني متخصص في صياغة التوصيات التربوية للمعلمين."
                        },
                        contents: `
                        عنوان الدرس: ${topic}
                        الصف: ${document.getElementById('repClassName').innerText}
                        
                        التوصيات الحالية (عامة):
                        ${currentRecs}

                        المطلوب:
                        إعادة صياغة هذه التوصيات لتكون "سياقية" ومرتبطة تحديداً بموضوع الدرس "${topic}".
                        اجعلها عملية وقابلة للتطبيق داخل الحصة.
                        أعد القائمة كنقاط HTML (li tags) فقط.
                        `
                    });

                    const text = response.text;
                    
                    if (!text) {
                        throw new Error("Empty response from AI");
                    }

                    // Clean markdown if present
                    const cleanHtml = text.replace(/```html/g, '').replace(/```/g, '');
                    recContainer.innerHTML = cleanHtml;
                    
                } catch (error) {
                    console.error("AI Error Full Details:", error);
                    let msg = "تعذر الاتصال بخدمة الذكاء الاصطناعي.";
                    if (error.message.includes("API Key")) {
                        msg += "\nالسبب: مفتاح API غير موجود في البيئة.";
                    } else if (error.message.includes("SDK")) {
                        msg += "\nالسبب: مكتبة Google GenAI لم يتم تحميلها.";
                    } else {
                        msg += "\nالسبب: " + error.message;
                    }
                    alert(msg);
                } finally {
                    document.getElementById('aiLoadingOverlay').classList.add('hidden-view');
                }
            }

            // --- JSON Import for Criteria ---
            handleCriteriaJson(e) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const json = JSON.parse(evt.target.result);
                        // Basic validation
                        if (Array.isArray(json) && json[0]?.items) {
                            this.state.evaluationCriteria = json;
                            this.saveData();
                            alert('تم تحديث معايير التقييم بنجاح!');
                            this.closeModal('modal-settings');
                        } else {
                            alert('صيغة الملف غير متوافقة.');
                        }
                    } catch(err) {
                        console.error(err);
                        alert('خطأ في ملف JSON');
                    }
                };
                reader.readAsText(e.target.files[0]);
            }

            openSettings() { 
                this.renderViolationsSettings();
                document.getElementById('modal-settings').classList.remove('hidden-view'); 
            }

            renderViolationsSettings() {
                const list = document.getElementById('violationsList');
                if(!list) return;
                list.innerHTML = this.state.violationTypes.map(v => `
                    <div class="flex items-center justify-between bg-white p-3 rounded-lg border border-slate-100 shadow-sm group hover:border-red-100 transition">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded bg-slate-100 text-slate-500 flex items-center justify-center"><i class="fas ${v.icon}"></i></div>
                            <span class="font-bold text-sm text-slate-700">${v.label}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="bg-red-50 text-red-600 text-xs font-bold px-2 py-1 rounded border border-red-100">-${v.points}</span>
                            <button type="button" onclick="window.app.removeViolation('${v.id}')" class="text-slate-300 hover:text-red-500 transition px-2 cursor-pointer"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                `).join('');
            }

            addViolation() {
                const labelIn = document.getElementById('newViolationLabel');
                const pointsIn = document.getElementById('newViolationPoints');
                if(!labelIn || !pointsIn) return;

                const label = labelIn.value;
                const points = parseInt(pointsIn.value);
                
                if(label && points) {
                    this.state.violationTypes.push({ id: Date.now().toString(), label, points, icon: 'fa-exclamation-circle' });
                    labelIn.value = '';
                    this.saveData();
                    this.renderViolationsSettings();
                }
            }

            removeViolation(id) {
                this.state.violationTypes = this.state.violationTypes.filter(v => v.id !== id);
                this.saveData();
                this.renderViolationsSettings();
            }

            sendWhatsApp(type) {
                const t = this.state.teachers.find(x => x.id === this.state.selectedTeacherId);
                if(!t) return; 
                
                if(!t.phone) return alert('أضف الهاتف أولاً');
                
                let msg = type === 'summon' 
                    ? `السلام عليكم أستاذ ${t.name}، يرجى التكرم بزيارة مكتب الإدارة.` 
                    : `السلام عليكم أستاذ ${t.name}، تذكير بموعد حصتكم الحالية في الصف ${this.state.selectedClassName}.`;
                window.open(`https://wa.me/${t.phone}?text=${encodeURIComponent(msg)}`, '_blank');
            }

            openWhatsApp(id) {
                const t = this.state.teachers.find(x => x.id === id);
                if(t && t.phone) window.open(`https://wa.me/${t.phone}`, '_blank');
                else alert('أضف الهاتف أولاً');
            }

            dockScore(violationId) {
                const v = this.state.violationTypes.find(x => x.id === violationId);
                if(!v) return;

                if(confirm(`تأكيد خصم ${v.points} نقاط بسبب: ${v.label}؟`)) {
                    const t = this.state.teachers.find(x => x.id === this.state.selectedTeacherId);
                    if(t) {
                        t.score = Math.max(0, t.score - v.points);
                        this.saveData();
                        this.closeModal('modal-action');
                    }
                }
            }

            // --- Imports/Exports ---
            handleXml(e) {
                const reader = new FileReader();
                reader.readAsText(e.target.files[0], "windows-1256");
                reader.onload = (evt) => {
                    try {
                        const xml = new DOMParser().parseFromString(evt.target.result, "text/xml");
                        this.state.periods = Array.from(xml.querySelectorAll('periods period')).map(p => ({
                            id: p.getAttribute('period'), start: p.getAttribute('starttime'), end: p.getAttribute('endtime')
                        }));
                        const classes = {};
                        xml.querySelectorAll('classes class').forEach(c => classes[c.getAttribute('id')] = c.getAttribute('name'));
                        this.state.classes = classes;
                        
                        this.state.teachers = Array.from(xml.querySelectorAll('teachers teacher')).map(t => ({
                            id: t.getAttribute('id'), name: t.getAttribute('name'), short: t.getAttribute('short'),
                            score: 100, phone: '', lessons: []
                        }));
                        
                        xml.querySelectorAll('TimeTableSchedules TimeTableSchedule').forEach(sch => {
                            const t = this.state.teachers.find(x => x.id === sch.getAttribute('TeacherID'));
                            if(t) t.lessons.push({ day: parseInt(sch.getAttribute('DayID')), period: parseInt(sch.getAttribute('Period')), className: classes[sch.getAttribute('ClassID')] || 'نشاط' });
                        });

                        this.saveData();
                        this.closeModal('modal-settings');
                        alert('تم استيراد الجدول بنجاح');
                        this.renderAll();
                    } catch(err) { alert('خطأ في الملف'); console.error(err); }
                };
            }

            exportTeacherTemplate() {
                const data = this.state.teachers.map(t => ({ 'Teacher_ID': t.id, 'Short_Name': t.short, 'Full_Name': t.name, 'Phone': t.phone }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Teachers_Data");
                XLSX.writeFile(wb, "Teachers_Data.xlsx");
            }

            handleExcel(e) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    let updated = false;
                    this.state.teachers.forEach(t => {
                        const row = json.find(r => r['Teacher_ID'] == t.id);
                        if(row) { t.name = row['Full_Name'] || t.name; t.phone = row['Phone'] ? String(row['Phone']) : t.phone; updated = true; }
                    });
                    if(updated) { this.saveData(); this.renderAll(); alert('تم التحديث بنجاح'); }
                    this.closeModal('modal-settings');
                };
                reader.readAsArrayBuffer(e.target.files[0]);
            }

            exportReports() {
                const data = this.state.teachers.map(t => ({ 'المعلم': t.name, 'التقييم': t.score+'%', 'الهاتف': t.phone||'-' }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Reports");
                XLSX.writeFile(wb, "School_Report.xlsx");
            }
        }

        // Attach to window explicitly
        window.app = new SchoolApp();
    </script>
</body>
</html>