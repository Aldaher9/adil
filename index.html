<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ - Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { font-family: 'Tajawal', sans-serif; box-sizing: border-box; }
        body { background: #f1f5f9; margin: 0; padding-bottom: 80px; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±Ø³Ù…ÙŠ */
        #reportModal { display: none; position: fixed; inset: 0; background: white; z-index: 2000; overflow-y: auto; padding: 20px; }
        .pdf-page { background: white; padding: 30px; border: 2px solid #000; margin-bottom: 20px; direction: rtl; position: relative; }
        
        .report-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .score-badge { background: #000; color: #fff; padding: 10px 20px; border-radius: 8px; font-size: 1.2rem; font-weight: 800; }
        
        .info-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .info-table td { border: 1px solid #000; padding: 10px; font-weight: bold; background: #f9f9f9; }
        
        .section-title { background: #eeeeee; padding: 8px; border: 1px solid #000; font-weight: 800; margin-top: 15px; border-right: 8px solid #000; }
        .content-list { margin: 10px 0; padding-right: 25px; }
        .content-list li { margin-bottom: 8px; line-height: 1.4; }

        .footer-note { margin-top: 20px; font-weight: 800; text-align: center; border-top: 1px dashed #000; padding-top: 10px; }

        /* Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¹Ø§Ù…Ø© */
        .no-print { display: block; }
        .btn-action { padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; width: 100%; }
        .btn-save { background: #10b981; color: white; }
    </style>
</head>
<body>

<div id="view-visits" style="padding: 20px;">
    <div style="background:white; padding:20px; border-radius:20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h3>ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø© ØµÙÙŠØ©</h3>
        <input type="text" id="v_teacher" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;">
        <input type="text" id="v_lesson" placeholder="Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø³" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;">
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <input type="text" id="v_class" placeholder="Ø§Ù„ØµÙ" style="flex:1; padding:12px; border:1px solid #ddd; border-radius:8px;">
            <input type="text" id="v_period" placeholder="Ø§Ù„Ø­ØµØ©" style="flex:1; padding:12px; border:1px solid #ddd; border-radius:8px;">
        </div>
        <div id="criteriaList"></div>
        <button class="btn-action btn-save" onclick="generateReport()">Ø­ÙØ¸ ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±Ø³Ù…ÙŠ</button>
    </div>
</div>

<div id="reportModal">
    <div id="pdfContainer"></div>
    <div style="display:flex; gap:10px; margin-top:20px;" class="no-print">
        <button onclick="downloadPDF()" style="flex:1; padding:15px; background:#1e293b; color:white; border-radius:10px; border:none; font-weight:bold;">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ PDF</button>
        <button onclick="closeModal()" style="flex:1; padding:15px; background:#94a3b8; color:white; border-radius:10px; border:none; font-weight:bold;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>
// Ù…Ø­Ø§ÙƒØ§Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ù† Firebase/JSON)
let phrasesDB = []; // Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ù…Ù† Ù…Ù„ÙÙƒ
let visitHistory = [];

// ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± ÙÙŠ Ø§Ù„ØµÙØ­Ø©
function initForm() {
    // Ù‡Ø°Ù‡ Ø¹ÙŠÙ†Ø© ÙÙ‚Ø·ØŒ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ Ø³ÙŠÙ‚Ø±Ø£ Ù…Ù† phrasesDB Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
    const sampleCriteria = ["Ø§Ù„ØªÙ…Ù‡ÙŠØ¯ Ù„Ù„Ø¯Ø±Ø³", "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆØ³Ø§Ø¦Ù„", "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ", "Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø§Ø¨", "Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø®ØªØ§Ù…ÙŠ"];
    document.getElementById('criteriaList').innerHTML = sampleCriteria.map(c => `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee;">
            <span>${c}</span>
            <select class="score-input" data-criteria="${c}" style="padding:5px; border-radius:5px;">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
            </select>
        </div>
    `).join('');
}

function generateReport() {
    const t = document.getElementById('v_teacher').value;
    const l = document.getElementById('v_lesson').value;
    if(!t || !l) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

    const scores = Array.from(document.querySelectorAll('.score-input')).map(s => ({
        m: s.dataset.criteria,
        v: parseInt(s.value)
    }));

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ© (Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª)
    const totalSum = scores.reduce((a, b) => a + b.v, 0);
    const finalGrade = (totalSum / scores.length).toFixed(1);

    // Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:
    // 1. Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¯Ø©: Ø£ÙØ¶Ù„ 4 ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ù† Ø§Ù„ÙØ¦Ø© (1 Ùˆ 2)
    const igada = scores
        .filter(s => s.v === 1 || s.v === 2)
        .sort((a,b) => a.v - b.v) // ØªØ±ØªÙŠØ¨ ØªØµØ§Ø¹Ø¯ÙŠ Ù„Ø£Ù† 1 Ø£ÙØ¶Ù„ Ù…Ù† 2
        .slice(0, 4);

    // 2. Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„ØªØ­Ø³ÙŠÙ†: Ø£Ø³ÙˆØ£ 4 ØªÙ‚ÙŠÙŠÙ…Ø§Øª (Ø£ÙƒØ¨Ø± Ù…Ù† 2)
    const improvement = scores
        .filter(s => s.v > 2)
        .sort((a,b) => b.v - a.v) // ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙƒØ¨ÙŠØ±Ø© (Ø§Ù„ØªÙŠ ØªØ¹Ù†ÙŠ Ø¶Ø¹Ù)
        .slice(0, 4);

    const reportData = {
        teacher: t,
        lesson: l,
        class: document.getElementById('v_class').value,
        period: document.getElementById('v_period').value,
        grade: finalGrade,
        date: new Date().toLocaleDateString('ar-EG'),
        igada: igada.map(i => findPhrase(i.m, i.v)),
        improvement: improvement.map(i => ({
            criteria: i.m,
            desc: findPhrase(i.m, i.v),
            rec: findRecommendation(i.m, i.v)
        }))
    };

    renderPDF(reportData);
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø¨Ø­Ø« ÙÙŠ phrasesDB
function findPhrase(m, v) {
    const found = phrasesDB.find(p => p["Ø§Ù„Ù…Ø¹ÙŠØ§Ø± / Ø§Ù„Ø¨Ù†Ø¯"] === m && p["Ø§Ù„Ø­ÙƒÙ…"].includes(`(${v})`));
    return found ? found["Ø§Ù„ÙˆØµÙ Ø§Ù„Ø³Ù„ÙˆÙƒÙŠ Ù„Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¯Ø© / Ø£ÙˆÙ„ÙˆÙŠØ§Øª Ø§Ù„ØªØ·ÙˆÙŠØ±"] : m;
}

function findRecommendation(m, v) {
    const found = phrasesDB.find(p => p["Ø§Ù„Ù…Ø¹ÙŠØ§Ø± / Ø§Ù„Ø¨Ù†Ø¯"] === m && p["Ø§Ù„Ø­ÙƒÙ…"].includes(`(${v})`));
    return found ? found["Ø§Ù„ØªÙˆØµÙŠØ§Øª"] : "Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ·ÙˆÙŠØ±";
}

function renderPDF(data) {
    const container = document.getElementById('pdfContainer');
    container.innerHTML = `
        <div class="pdf-page">
            <div class="report-header">
                <div>
                    <h2 style="margin:0;">ØªÙ‚Ø±ÙŠØ± Ø²ÙŠØ§Ø±Ø© ÙÙ†ÙŠØ©</h2>
                    <p style="margin:5px 0;">Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</p>
                </div>
                <div class="score-badge">Ø§Ù„Ø¯Ø±Ø¬Ø©: ${data.grade}</div>
            </div>

            <table class="info-table">
                <tr><td>Ø§Ù„Ù…Ø¹Ù„Ù…: ${data.teacher}</td><td>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${data.date}</td></tr>
                <tr><td>Ø§Ù„ØµÙ: ${data.class}</td><td>Ø§Ù„Ø­ØµØ©: ${data.period}</td></tr>
                <tr><td colspan="2">Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø³: ${data.lesson}</td></tr>
            </table>

            <div class="section-title">âœ… Ø£ÙˆÙ„Ø§Ù‹: Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¯Ø©</div>
            <ul class="content-list">
                ${data.igada.map(s => `<li>${s}</li>`).join('') || "<li>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©</li>"}
            </ul>

            <div class="section-title">âš ï¸ Ø«Ø§Ù†ÙŠØ§Ù‹: Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„ØªØ­Ø³ÙŠÙ† ÙˆØ§Ù„ØªØ·ÙˆÙŠØ±</div>
            <ul class="content-list">
                ${data.improvement.map(i => `<li><b>${i.criteria}:</b> ${i.desc}</li>`).join('') || "<li>Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±</li>"}
            </ul>

            <div class="footer-note">Ù†Ø´ÙƒØ± Ø§Ù„Ù…Ø¹Ù„Ù… Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­ØµØ©</div>

            <div class="section-title">ğŸ’¡ Ø«Ø§Ù„Ø«Ø§Ù‹: Ø§Ù„ØªÙˆØµÙŠØ§Øª</div>
            <ol class="content-list">
                ${data.improvement.map(i => `<li>${i.rec}</li>`).join('') || "<li>Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø¹Ø·Ø§Ø¡ Ø§Ù„Ù…ØªÙ…ÙŠØ²</li>"}
            </ol>

            <div style="margin-top:40px; text-align:left; padding-left:40px;">
                <p>ØªÙˆÙ‚ÙŠØ¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© / Ø§Ù„Ø²Ø§Ø¦Ø±</p>
                <p>..........................</p>
            </div>
        </div>
    `;
    document.getElementById('reportModal').style.display = 'block';
}

function closeModal() { document.getElementById('reportModal').style.display = 'none'; }

function downloadPDF() {
    const element = document.getElementById('pdfContainer');
    html2pdf().from(element).set({
        margin: 10,
        filename: 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±_Ø§Ù„ÙÙ†ÙŠ.pdf',
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).save();
}

window.onload = initForm;
</script>
</body>
</html>
