<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุตุฉ ุงููุงุฆุฏ - ูุธุงู ุงูุฅุฏุงุฑุฉ ุงููุชูุงูู</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body style="display: block;">

<!-- Login Screen -->
<div id="login-screen" style="position:fixed; inset:0; background:#f1f5f9; z-index:1000; display:none; align-items:center; justify-content:center; padding:20px;">
    <div style="background:white; padding:40px; border-radius:30px; text-align:center; box-shadow:0 4px 6px rgba(0,0,0,0.1); width:100%; max-width:400px;">
        <h1 style="color:#0f172a; margin-bottom: 20px;">ููุตุฉ ุงููุงุฆุฏ โก</h1>
        <button id="loginBtn" style="width:100%; padding:15px; background:white; border:2px solid #f1f5f9; border-radius:15px; cursor:pointer; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:12px;">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> ุงูุฏุฎูู ุนุจุฑ ุฌูุฌู
        </button>
        <div style="margin-top: 20px;">
            <button onclick="skipLogin()" style="padding:10px 20px; background:#10b981; color:white; border:none; border-radius:10px; cursor:pointer;">ุชุฎุทู (ููุชุฌุฑุจุฉ)</button>
        </div>
    </div>
</div>

<!-- Header -->
<div class="header">
    <div class="user-welcome" id="welcomeMsg">๐ค ูุฑุญุจ ุจุงููุงุฆุฏ</div>
    <div class="header-top">
        <h1>ููุตุฉ ุงููุงุฆุฏ โก</h1>
        <div class="header-actions">
            <button class="header-btn" onclick="openModal()">โ๏ธ ุถุจุท</button>
            <button class="header-btn logout-btn" onclick="handleLogout()">๐ช ุฎุฑูุฌ</button>
        </div>
    </div>
</div>

<!-- Dashboard View -->
<div id="view-dashboard" class="container active">
    <h3 style="margin-top:0;">๐ ููุญุฉ ุงููุนูููุงุช</h3>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">๐ฅ</div>
            <div class="stat-value" id="statTeachers">0</div>
            <div class="stat-label">ุนุฏุฏ ุงููุนูููู</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">๐</div>
            <div class="stat-value" id="statClasses">0</div>
            <div class="stat-label">ุนุฏุฏ ุงููุตูู</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">๐๏ธ</div>
            <div class="stat-value" id="statVisits">0</div>
            <div class="stat-label">ุงูุฒูุงุฑุงุช ูุฐุง ุงูุฃุณุจูุน</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">๐</div>
            <div class="stat-value" id="statTasks">0</div>
            <div class="stat-label">ุงูููุงู ุงููุดุทุฉ</div>
        </div>
    </div>

    <div class="card">
        <h4>๐ ุฅุญุตุงุฆูุงุช ุงูุฒูุงุฑุงุช ุงูุฅุดุฑุงููุฉ</h4>
        <canvas id="visitsChart"></canvas>
    </div>

    <div class="card">
        <h4>โฐ ุงูุญุตุฉ ุงูุญุงููุฉ</h4>
        <div class="status-card">
            <div>
                <div id="dashDate">--:--</div>
                <div id="dashPeriod" style="font-weight:800; font-size:1.1rem; color: #0f172a;">ุฌุงุฑู ุงููุฒุงููุฉ..</div>
            </div>
            <div id="dashSimBadge" style="display:none; background:#fee2e2; color:#ef4444; padding:5px 10px; border-radius:10px; font-weight:bold;">ูุถุน ุงููุญุงูุงุฉ</div>
        </div>
    </div>
</div>

<!-- Schedule View -->
<div id="view-schedule" class="container">
    <div class="status-card">
        <div>
            <div id="infoDate">--:--</div>
            <div id="infoPeriod" style="font-weight:800; font-size:1.1rem; color: #0f172a;">ุฌุงุฑู ุงููุฒุงููุฉ..</div>
        </div>
        <div id="simBadge" style="display:none; background:#fee2e2; color:#ef4444; padding:5px 10px; border-radius:10px; font-weight:bold;">ูุถุน ุงููุญุงูุงุฉ</div>
    </div>
    <div id="lessons-list"></div>
</div>

<!-- Staff View -->
<div id="view-staff" class="container">
    <input type="text" id="searchInput" placeholder="๐ ุงุจุญุซ ุนู ูุนูู..." onkeyup="filterStaff()" style="width:100%; padding:15px; border-radius:12px; border:2px solid #ddd; margin-bottom:15px;">
    <div id="staff-list"></div>
</div>

<!-- Visits View -->
<div id="view-visits" class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin:0;">๐๏ธ ุงูุฒูุงุฑุงุช ุงูุฅุดุฑุงููุฉ</h3>
        <button onclick="openVisitModal()" class="btn-primary">+ ุฒูุงุฑุฉ ุฌุฏูุฏุฉ</button>
    </div>
    
    <div class="filter-section">
        <select id="visitFilter" onchange="filterVisits()" class="filter-select">
            <option value="all">ุฌููุน ุงูุฒูุงุฑุงุช</option>
            <option value="today">ุงูููู</option>
            <option value="week">ูุฐุง ุงูุฃุณุจูุน</option>
            <option value="month">ูุฐุง ุงูุดูุฑ</option>
        </select>
    </div>
    
    <div id="visits-list"></div>
</div>

<!-- Reports View -->
<div id="view-reports" class="container">
    <h3 style="margin-top:0;">๐ ุงูุชูุงุฑูุฑ</h3>
    
    <div class="report-options">
        <div class="card report-card" onclick="generateTeacherReport()">
            <div class="report-icon">๐ฅ</div>
            <h4>ุชูุฑูุฑ ุงููุนูููู</h4>
            <p>ุชูุฑูุฑ ุดุงูู ุนู ุฌููุน ุงููุนูููู ูุฃุฑูุงููู</p>
        </div>
        
        <div class="card report-card" onclick="generateVisitsReport()">
            <div class="report-icon">๐๏ธ</div>
            <h4>ุชูุฑูุฑ ุงูุฒูุงุฑุงุช</h4>
            <p>ููุฎุต ุงูุฒูุงุฑุงุช ุงูุฅุดุฑุงููุฉ ูุงูุชููููุงุช</p>
        </div>
        
        <div class="card report-card" onclick="generateScheduleReport()">
            <div class="report-icon">๐</div>
            <h4>ุชูุฑูุฑ ุงูุฌุฏูู</h4>
            <p>ุชุญููู ุชูุฒูุน ุงูุญุตุต ูุงูููุงุฏ</p>
        </div>
        
        <div class="card report-card" onclick="generatePerformanceReport()">
            <div class="report-icon">๐</div>
            <h4>ุชูุฑูุฑ ุงูุฃุฏุงุก</h4>
            <p>ุชูููู ุดุงูู ููุฃุฏุงุก ุงูุนุงู</p>
        </div>
    </div>
</div>

<!-- Agenda View -->
<div id="view-agenda" class="container">
    <h3 style="margin-top:0;">๐ ุฃุฌูุฏุฉ ุงูููุงู</h3>
    <div style="display:flex; gap:10px; margin-bottom:20px;">
        <input type="text" id="taskInput" style="flex:1; padding:12px; border-radius:12px; border:2px solid #ddd;" placeholder="ุงูุชุจ ูููุฉ ุฌุฏูุฏุฉ...">
        <button onclick="addTask()" class="btn-primary">ุฅุถุงูุฉ</button>
    </div>
    <div id="tasks-list"></div>
</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
    <button class="nav-item active" onclick="switchTab('view-dashboard', this)">
        <span>๐</span> ุงูุฑุฆูุณูุฉ
    </button>
    <button class="nav-item" onclick="switchTab('view-schedule', this)">
        <span>๐</span> ุงูุญุตุต
    </button>
    <button class="nav-item" onclick="switchTab('view-staff', this)">
        <span>๐ฅ</span> ุงููุนูููู
    </button>
    <button class="nav-item" onclick="switchTab('view-visits', this)">
        <span>๐๏ธ</span> ุงูุฒูุงุฑุงุช
    </button>
    <button class="nav-item" onclick="switchTab('view-reports', this)">
        <span>๐</span> ุงูุชูุงุฑูุฑ
    </button>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
    <div class="modal-content">
        <h3>โ๏ธ ุฅุนุฏุงุฏุงุช ุงูููุตุฉ</h3>
        <p style="font-size:12px; font-weight:bold;">1. ููู ุงูุฌุฏูู (XML)</p>
        <input type="file" id="xmlFile" accept=".xml" onchange="handleXML(this)" style="width:100%; margin-bottom:15px;">
        
        <p style="font-size:12px; font-weight:bold;">2. ุจูุงูุงุช ุงููุนูููู (Excel)</p>
        <div class="grid-2" style="margin-bottom:15px;">
            <button onclick="exportToExcel()" style="padding:10px; background:#10b981; color:white; border:none; border-radius:10px;">๐ฅ ุชุตุฏูุฑ</button>
            <button onclick="document.getElementById('excelFile').click()" style="padding:10px; background:#3b82f6; color:white; border:none; border-radius:10px;">๐ค ุงุณุชูุฑุงุฏ</button>
            <input type="file" id="excelFile" accept=".xlsx, .xls" style="display:none" onchange="importFromExcel(this)">
        </div>
        
        <p style="font-size:12px; font-weight:bold;">3. ุงูุชุญูู ุจุงูููุช</p>
        <div class="grid-2">
            <button onclick="doSim()" style="padding:10px; background:#0f172a; color:white; border:none; border-radius:10px;">๐ฒ ูุญุงูุงุฉ</button>
            <button onclick="resetTime()" style="padding:10px; background:#ef4444; color:white; border:none; border-radius:10px;">โป๏ธ ุฅุนุงุฏุฉ</button>
        </div>
        
        <button onclick="closeModal()" style="width:100%; margin-top:20px; padding:12px; background:#94a3b8; color:white; border:none; border-radius:10px;">ุฅุบูุงู</button>
    </div>
</div>

<!-- Visit Modal -->
<div id="visitModal" class="modal">
    <div class="modal-content">
        <h3>๐๏ธ ุฒูุงุฑุฉ ุฅุดุฑุงููุฉ ุฌุฏูุฏุฉ</h3>
        
        <div class="form-group">
            <label>ุงุณู ุงููุนูู</label>
            <select id="visitTeacher" class="form-control"></select>
        </div>
        
        <div class="form-group">
            <label>ุงูุชุงุฑูุฎ ูุงูููุช</label>
            <input type="datetime-local" id="visitDate" class="form-control">
        </div>
        
        <div class="form-group">
            <label>ุงููุตู</label>
            <input type="text" id="visitClass" class="form-control" placeholder="ูุซุงู: 3/1">
        </div>
        
        <div class="form-group">
            <label>ุงููุงุฏุฉ</label>
            <input type="text" id="visitSubject" class="form-control" placeholder="ูุซุงู: ุงูุฑูุงุถูุงุช">
        </div>
        
        <div class="form-group">
            <label>ุงูุชูููู ุงูุนุงู</label>
            <div class="rating-section">
                <button class="rating-btn" onclick="setVisitRating(5)">โญโญโญโญโญ ููุชุงุฒ</button>
                <button class="rating-btn" onclick="setVisitRating(4)">โญโญโญโญ ุฌูุฏ ุฌุฏุงู</button>
                <button class="rating-btn" onclick="setVisitRating(3)">โญโญโญ ุฌูุฏ</button>
                <button class="rating-btn" onclick="setVisitRating(2)">โญโญ ููุจูู</button>
                <button class="rating-btn" onclick="setVisitRating(1)">โญ ูุญุชุงุฌ ุชุญุณูู</button>
            </div>
        </div>
        
        <div class="form-group">
            <label>ููุงุท ุงูููุฉ</label>
            <textarea id="visitStrengths" class="form-control" rows="3" placeholder="ุงุฐูุฑ ููุงุท ุงูููุฉ ุงูููุงุญุธุฉ..."></textarea>
        </div>
        
        <div class="form-group">
            <label>ููุงุท ุงูุชุญุณูู</label>
            <textarea id="visitWeaknesses" class="form-control" rows="3" placeholder="ุงุฐูุฑ ููุงุท ุงูุชุญุณูู ุงูููุชุฑุญุฉ..."></textarea>
        </div>
        
        <div class="form-group">
            <label>ููุงุญุธุงุช ุฅุถุงููุฉ</label>
            <textarea id="visitNotes" class="form-control" rows="3" placeholder="ุฃู ููุงุญุธุงุช ุฃุฎุฑู..."></textarea>
        </div>
        
        <div class="grid-2" style="margin-top:20px;">
            <button onclick="saveVisit()" class="btn-primary">๐พ ุญูุธ ุงูุฒูุงุฑุฉ</button>
            <button onclick="closeVisitModal()" style="padding:12px; background:#94a3b8; color:white; border:none; border-radius:10px;">ุฅูุบุงุก</button>
        </div>
    </div>
</div>

<script>
// Global Variables
let currentUser = { uid: 'demo-user', displayName: 'ูุฏูุฑ ุชุฌุฑูุจู', email: 'demo@school.com' };
let data = { teachers: {}, classes: {}, subjects: {}, lessons: [], periods: [] };
let phones = {};
let tasks = [];
let visits = [];
let isSim = false, sDay = 1, sTime = "08:00";
let selectedRating = 0;
let visitsChart = null;
let useFirebase = false;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('ุชุญููู ุงููููุน...');
    loadFromLocalStorage();
    updateDashboard();
    renderStaff();
    renderTasks();
    renderVisits();
    refresh();
    
    // Check if we should show login
    if (localStorage.getItem('skipLogin') === 'true') {
        skipLogin();
    }
});

// Skip Login (Demo Mode)
function skipLogin() {
    localStorage.setItem('skipLogin', 'true');
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('welcomeMsg').innerText = '๐ค ูุฑุญุจุงู ' + currentUser.displayName;
    loadFromLocalStorage();
    updateDashboard();
}

// Handle Logout
function handleLogout() {
    if (confirm('ูู ุชุฑูุฏ ุชุณุฌูู ุงูุฎุฑูุฌุ')) {
        localStorage.removeItem('skipLogin');
        location.reload();
    }
}

// Local Storage Functions
function saveToLocalStorage() {
    try {
        localStorage.setItem('schoolData', JSON.stringify({
            data, phones, tasks, visits,
            updated: new Date().toISOString()
        }));
    } catch (e) {
        console.error('ุฎุทุฃ ูู ุงูุญูุธ:', e);
    }
}

function loadFromLocalStorage() {
    try {
        const stored = localStorage.getItem('schoolData');
        if (stored) {
            const parsed = JSON.parse(stored);
            data = parsed.data || data;
            phones = parsed.phones || phones;
            tasks = parsed.tasks || tasks;
            visits = parsed.visits || visits;
        }
    } catch (e) {
        console.error('ุฎุทุฃ ูู ุงูุชุญููู:', e);
    }
}

// Update Dashboard
function updateDashboard() {
    document.getElementById('statTeachers').innerText = Object.keys(data.teachers).length;
    document.getElementById('statClasses').innerText = Object.keys(data.classes).length;
    document.getElementById('statTasks').innerText = tasks.filter(t => !t.done).length;
    
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    const weekVisits = visits.filter(v => new Date(v.date) >= weekAgo);
    document.getElementById('statVisits').innerText = weekVisits.length;
    
    updateVisitsChart();
    updateDashboardTime();
}

// Update Dashboard Time
function updateDashboardTime() {
    const now = new Date();
    const days = ['ุงูุฃุญุฏ', 'ุงูุงุซููู', 'ุงูุซูุงุซุงุก', 'ุงูุฃุฑุจุนุงุก', 'ุงูุฎููุณ', 'ุงูุฌูุนุฉ', 'ุงูุณุจุช'];
    let d = days[now.getDay()];
    let t = now.toLocaleTimeString('ar-SA', {hour: '2-digit', minute:'2-digit', hour12: false});
    
    if (isSim) {
        d = ['ุงูุฃุญุฏ', 'ุงูุงุซููู', 'ุงูุซูุงุซุงุก', 'ุงูุฃุฑุจุนุงุก', 'ุงูุฎููุณ'][sDay - 1];
        t = sTime;
    }
    
    document.getElementById('dashDate').innerText = t;
    document.getElementById('dashSimBadge').style.display = isSim ? "block" : "none";
    
    const p = (data.periods || []).find(p => {
        const cur = toM(t), s = toM(p.s), e = toM(p.e);
        return cur >= s && cur <= e;
    });
    
    if (p) {
        document.getElementById('dashPeriod').innerText = "ุงูุญุตุฉ ุงููุดุทุฉ: " + p.id;
    } else {
        document.getElementById('dashPeriod').innerText = "ุฎุงุฑุฌ ุงูุฏูุงู";
    }
}

// Update Visits Chart
function updateVisitsChart() {
    const ctx = document.getElementById('visitsChart');
    if (!ctx) return;
    
    const last7Days = [];
    const visitCounts = [];
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        last7Days.push(date.toLocaleDateString('ar-SA', {weekday: 'short'}));
        
        const count = visits.filter(v => v.date && v.date.startsWith(dateStr)).length;
        visitCounts.push(count);
    }
    
    if (visitsChart) {
        visitsChart.destroy();
    }
    
    visitsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: last7Days,
            datasets: [{
                label: 'ุนุฏุฏ ุงูุฒูุงุฑุงุช',
                data: visitCounts,
                borderColor: '#0f172a',
                backgroundColor: 'rgba(15, 23, 42, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// Refresh schedule
function refresh() {
    const now = new Date();
    const days = ['ุงูุฃุญุฏ', 'ุงูุงุซููู', 'ุงูุซูุงุซุงุก', 'ุงูุฃุฑุจุนุงุก', 'ุงูุฎููุณ', 'ุงูุฌูุนุฉ', 'ุงูุณุจุช'];
    let d = days[now.getDay()];
    let t = now.toLocaleTimeString('ar-SA', {hour: '2-digit', minute:'2-digit', hour12: false});
    
    if (isSim) {
        d = ['ุงูุฃุญุฏ', 'ุงูุงุซููู', 'ุงูุซูุงุซุงุก', 'ุงูุฃุฑุจุนุงุก', 'ุงูุฎููุณ'][sDay - 1];
        t = sTime;
    }
    
    document.getElementById('infoDate').innerText = t;
    document.getElementById('simBadge').style.display = isSim ? "block" : "none";
    
    const p = (data.periods || []).find(p => {
        const cur = toM(t), s = toM(p.s), e = toM(p.e);
        return cur >= s && cur <= e;
    });
    
    const list = document.getElementById('lessons-list');
    if (p && data.lessons && data.lessons.length > 0) {
        document.getElementById('infoPeriod').innerText = "ุงูุญุตุฉ ุงููุดุทุฉ: " + p.id;
        const current = data.lessons.filter(l => l.d == d && l.p == p.id).sort((a,b)=> {
            const numA = parseInt((data.classes[a.c]||'').match(/\d+/)) || 0;
            const numB = parseInt((data.classes[b.c]||'').match(/\d+/)) || 0;
            return numA - numB;
        });
        
        list.innerHTML = current.map(l => {
            let n = data.teachers[l.t], ph = (phones[n] || "").replace(/\s+/g, '');
            let className = data.classes[l.c] || '..';
            let msg = encodeURIComponent(`ุงูุณูุงู ุนููููุ ุฃุณุชุงุฐ ${n}. ููุงุญุธ ุชุฃุฎุฑูู ุนู ุงูุญุตุฉ ${p.id} ูู ุตู ${className}. ูุฑุฌู ุงูุชูุงุฌุฏ ููุฃูููุฉ.`);
            return `<div class="lesson-card">
                <div class="class-badge">${className}</div>
                <div style="flex:1; padding-right:15px;"><b>${n}</b><br><small>${data.subjects[l.s] || ''}</small></div>
                <button onclick="window.open('https://wa.me/${ph}?text=${msg}')" style="border:none; background:#10b981; color:white; width:35px; height:35px; border-radius:50%; cursor:pointer;">๐ฌ</button>
            </div>`;
        }).join('');
    } else {
        document.getElementById('infoPeriod').innerText = "ุฎุงุฑุฌ ุงูุฏูุงู";
        list.innerHTML = `<div style="text-align:center; padding:50px; color:#94a3b8;">ูุง ุชูุฌุฏ ุญุตุต ุญุงููุงู</div>`;
    }
}

// Render Staff
function renderStaff() {
    const list = document.getElementById('staff-list');
    const sorted = Array.from(new Set([...Object.values(data.teachers), ...Object.keys(phones)])).sort();
    
    if (sorted.length === 0) {
        list.innerHTML = '<div style="text-align:center; padding:50px; color:#94a3b8;">ูุง ููุฌุฏ ูุนูููู. ูู ุจุงุณุชูุฑุงุฏ ุงูุฌุฏูู ุฃู ุจูุงูุงุช ุงููุนูููู</div>';
        return;
    }
    
    list.innerHTML = sorted.map((name, i) => {
        const ph = phones[name] || "";
        const teacherVisits = visits.filter(v => v.teacher === name);
        const avgRating = teacherVisits.length > 0 
            ? (teacherVisits.reduce((sum, v) => sum + v.rating, 0) / teacherVisits.length).toFixed(1)
            : 'ูุง ููุฌุฏ';
        
        return `<div class="staff-card filter-item">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span style="font-weight:bold; color: #0f172a;">${name}</span>
                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="font-size:12px; color:#64748b;">${ph || 'ูุง ููุฌุฏ'}</span>
                    <button class="edit-phone-btn" onclick="updatePhone('${name}')">โ๏ธ</button>
                </div>
            </div>
            <div style="background:#f8fafc; padding:8px; border-radius:8px; margin-bottom:10px; font-size:12px;">
                <span>๐ ุงูุชูููู: ${avgRating}</span> | 
                <span>๐๏ธ ุงูุฒูุงุฑุงุช: ${teacherVisits.length}</span>
            </div>
            <select class="msg-select" id="sel_${i}">
                <option value="" disabled selected>๐ฝ ุงุฎุชุฑ ุชูุฌููุงู ุณุฑูุนุงู...</option>
                <option value="ุงูุฑุฌุงุก ุงูุชูุฌู ุฅูู ููุชุจ ุงูุฅุฏุงุฑุฉ ููุฃูููุฉ.">ุงูุฑุฌุงุก ุงูุชูุฌู ุฅูู ููุชุจ ุงูุฅุฏุงุฑุฉ ููุฃูููุฉ.</option>
                <option value="ุงูุฑุฌุงุก ุงูุชูุงุฌุฏ ูู ููุงู ุงูููุงูุจุฉ.">ุงูุฑุฌุงุก ุงูุชูุงุฌุฏ ูู ููุงู ุงูููุงูุจุฉ.</option>
                <option value="ุงูุฑุฌุงุก ูุชุงุจุนุฉ ุญุตุฉ ุงูุงุญุชูุงุท ูุฏูู.">ุงูุฑุฌุงุก ูุชุงุจุนุฉ ุญุตุฉ ุงูุงุญุชูุงุท ูุฏูู.</option>
            </select>
            <div class="grid-2" style="margin-top:10px;">
                <button onclick="sendStaffMsg('${name}', 'sel_${i}')" class="action-btn" style="background:#10b981">โ๏ธ ูุงุชุณุงุจ</button>
                <a href="tel:${ph}" class="action-btn" style="background:#3b82f6; text-decoration:none;">๐ ุงุชุตุงู</a>
            </div>
        </div>`;
    }).join('');
}

// Visits Functions
function openVisitModal() {
    const modal = document.getElementById('visitModal');
    const teacherSelect = document.getElementById('visitTeacher');
    
    const teachers = Array.from(new Set([...Object.values(data.teachers), ...Object.keys(phones)])).sort();
    
    if (teachers.length === 0) {
        alert('ูุง ููุฌุฏ ูุนูููู. ูู ุจุงุณุชูุฑุงุฏ ุจูุงูุงุช ุงููุนูููู ุฃููุงู');
        return;
    }
    
    teacherSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุนูู...</option>' + 
        teachers.map(t => `<option value="${t}">${t}</option>`).join('');
    
    const now = new Date();
    const dateString = now.toISOString().slice(0, 16);
    document.getElementById('visitDate').value = dateString;
    
    selectedRating = 0;
    document.querySelectorAll('.rating-btn').forEach(btn => btn.classList.remove('selected'));
    
    modal.style.display = 'block';
}

function closeVisitModal() {
    document.getElementById('visitModal').style.display = 'none';
    document.getElementById('visitTeacher').value = '';
    document.getElementById('visitClass').value = '';
    document.getElementById('visitSubject').value = '';
    document.getElementById('visitStrengths').value = '';
    document.getElementById('visitWeaknesses').value = '';
    document.getElementById('visitNotes').value = '';
    selectedRating = 0;
}

function setVisitRating(rating) {
    selectedRating = rating;
    document.querySelectorAll('.rating-btn').forEach(btn => btn.classList.remove('selected'));
    event.target.classList.add('selected');
}

function saveVisit() {
    const teacher = document.getElementById('visitTeacher').value;
    const date = document.getElementById('visitDate').value;
    const className = document.getElementById('visitClass').value;
    const subject = document.getElementById('visitSubject').value;
    const strengths = document.getElementById('visitStrengths').value;
    const weaknesses = document.getElementById('visitWeaknesses').value;
    const notes = document.getElementById('visitNotes').value;
    
    if (!teacher || !date || selectedRating === 0) {
        alert('ุงูุฑุฌุงุก ููุก ุงูุญููู ุงููุทููุจุฉ (ุงููุนููุ ุงูุชุงุฑูุฎุ ุงูุชูููู)');
        return;
    }
    
    const visit = {
        id: Date.now(),
        teacher,
        date,
        class: className,
        subject,
        rating: selectedRating,
        strengths,
        weaknesses,
        notes,
        createdAt: new Date().toISOString()
    };
    
    visits.push(visit);
    saveToLocalStorage();
    renderVisits();
    updateDashboard();
    closeVisitModal();
    alert('ุชู ุญูุธ ุงูุฒูุงุฑุฉ ุจูุฌุงุญ โ');
}

function renderVisits() {
    const list = document.getElementById('visits-list');
    const sortedVisits = [...visits].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (sortedVisits.length === 0) {
        list.innerHTML = '<div style="text-align:center; padding:50px; color:#94a3b8;">ูุง ุชูุฌุฏ ุฒูุงุฑุงุช ูุณุฌูุฉ</div>';
        return;
    }
    
    list.innerHTML = sortedVisits.map(v => {
        const dateObj = new Date(v.date);
        const dateStr = dateObj.toLocaleDateString('ar-SA');
        const timeStr = dateObj.toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'});
        const stars = 'โญ'.repeat(v.rating);
        
        return `<div class="visit-card">
            <div class="visit-header">
                <div>
                    <h4>${v.teacher}</h4>
                    <div class="visit-meta">
                        <span>๐ ${dateStr}</span>
                        <span>๐ ${timeStr}</span>
                        ${v.class ? `<span>๐ ${v.class}</span>` : ''}
                    </div>
                </div>
                <div class="visit-rating">${stars}</div>
            </div>
            
            ${v.subject ? `<div class="visit-detail"><strong>ุงููุงุฏุฉ:</strong> ${v.subject}</div>` : ''}
            ${v.strengths ? `<div class="visit-detail"><strong>โ ููุงุท ุงูููุฉ:</strong> ${v.strengths}</div>` : ''}
            ${v.weaknesses ? `<div class="visit-detail"><strong>โ๏ธ ููุงุท ุงูุชุญุณูู:</strong> ${v.weaknesses}</div>` : ''}
            ${v.notes ? `<div class="visit-detail"><strong>๐ ููุงุญุธุงุช:</strong> ${v.notes}</div>` : ''}
            
            <div style="margin-top:10px; display:flex; gap:10px;">
                <button onclick="deleteVisit(${v.id})" style="flex:1; padding:8px; background:#ef4444; color:white; border:none; border-radius:8px; cursor:pointer;">๐๏ธ ุญุฐู</button>
            </div>
        </div>`;
    }).join('');
}

function filterVisits() {
    renderVisits();
}

function deleteVisit(id) {
    if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงูุฒูุงุฑุฉุ')) {
        visits = visits.filter(v => v.id !== id);
        saveToLocalStorage();
        renderVisits();
        updateDashboard();
    }
}

// Reports Functions
function generateTeacherReport() {
    const teachers = Array.from(new Set([...Object.values(data.teachers), ...Object.keys(phones)])).sort();
    
    if (teachers.length === 0) {
        alert('ูุง ููุฌุฏ ูุนูููู ูุฅูุดุงุก ุชูุฑูุฑ');
        return;
    }
    
    const reportData = teachers.map(name => {
        const teacherVisits = visits.filter(v => v.teacher === name);
        const avgRating = teacherVisits.length > 0
            ? (teacherVisits.reduce((sum, v) => sum + v.rating, 0) / teacherVisits.length).toFixed(1)
            : 'N/A';
        
        return {
            'ุงุณู ุงููุนูู': name,
            'ุฑูู ุงููุงุชู': phones[name] || '',
            'ุนุฏุฏ ุงูุฒูุงุฑุงุช': teacherVisits.length,
            'ูุชูุณุท ุงูุชูููู': avgRating
        };
    });
    
    const ws = XLSX.utils.json_to_sheet(reportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ุชูุฑูุฑ ุงููุนูููู");
    XLSX.writeFile(wb, `ุชูุฑูุฑ_ุงููุนูููู_${new Date().toLocaleDateString('ar-SA')}.xlsx`);
}

function generateVisitsReport() {
    if (visits.length === 0) {
        alert('ูุง ุชูุฌุฏ ุฒูุงุฑุงุช ูุฅูุดุงุก ุชูุฑูุฑ');
        return;
    }
    
    const reportData = visits.map(v => ({
        'ุงููุนูู': v.teacher,
        'ุงูุชุงุฑูุฎ': new Date(v.date).toLocaleDateString('ar-SA'),
        'ุงูููุช': new Date(v.date).toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'}),
        'ุงููุตู': v.class || '',
        'ุงููุงุฏุฉ': v.subject || '',
        'ุงูุชูููู': v.rating,
        'ููุงุท ุงูููุฉ': v.strengths || '',
        'ููุงุท ุงูุชุญุณูู': v.weaknesses || '',
        'ููุงุญุธุงุช': v.notes || ''
    }));
    
    const ws = XLSX.utils.json_to_sheet(reportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ุชูุฑูุฑ ุงูุฒูุงุฑุงุช");
    XLSX.writeFile(wb, `ุชูุฑูุฑ_ุงูุฒูุงุฑุงุช_${new Date().toLocaleDateString('ar-SA')}.xlsx`);
}

function generateScheduleReport() {
    if (!data.lessons || data.lessons.length === 0) {
        alert('ูุง ููุฌุฏ ุฌุฏูู ูุฅูุดุงุก ุชูุฑูุฑ');
        return;
    }
    
    const reportData = data.lessons.map(l => ({
        'ุงูููู': l.d,
        'ุงูุญุตุฉ': l.p,
        'ุงููุนูู': data.teachers[l.t] || '',
        'ุงููุตู': data.classes[l.c] || '',
        'ุงููุงุฏุฉ': data.subjects[l.s] || ''
    }));
    
    const ws = XLSX.utils.json_to_sheet(reportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ุงูุฌุฏูู ุงูุฏุฑุงุณู");
    XLSX.writeFile(wb, `ุชูุฑูุฑ_ุงูุฌุฏูู_${new Date().toLocaleDateString('ar-SA')}.xlsx`);
}

function generatePerformanceReport() {
    const teachers = Array.from(new Set([...Object.values(data.teachers), ...Object.keys(phones)])).sort();
    
    if (teachers.length === 0) {
        alert('ูุง ููุฌุฏ ูุนูููู ูุฅูุดุงุก ุชูุฑูุฑ');
        return;
    }
    
    const reportData = teachers.map(name => {
        const teacherVisits = visits.filter(v => v.teacher === name);
        const avgRating = teacherVisits.length > 0
            ? (teacherVisits.reduce((sum, v) => sum + v.rating, 0) / teacherVisits.length).toFixed(1)
            : 'N/A';
        
        const lessons = data.lessons ? data.lessons.filter(l => data.teachers[l.t] === name).length : 0;
        
        const performance = avgRating !== 'N/A' && parseFloat(avgRating) >= 4 ? 'ููุชุงุฒ' : 
                          avgRating !== 'N/A' && parseFloat(avgRating) >= 3 ? 'ุฌูุฏ' : 
                          avgRating !== 'N/A' ? 'ูุญุชุงุฌ ุชุญุณูู' : 'ุบูุฑ ูุญุฏุฏ';
        
        return {
            'ุงุณู ุงููุนูู': name,
            'ุนุฏุฏ ุงูุญุตุต': lessons,
            'ุนุฏุฏ ุงูุฒูุงุฑุงุช': teacherVisits.length,
            'ูุชูุณุท ุงูุชูููู': avgRating,
            'ุงูุฃุฏุงุก ุงูุนุงู': performance
        };
    });
    
    const ws = XLSX.utils.json_to_sheet(reportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ุชูุฑูุฑ ุงูุฃุฏุงุก");
    XLSX.writeFile(wb, `ุชูุฑูุฑ_ุงูุฃุฏุงุก_${new Date().toLocaleDateString('ar-SA')}.xlsx`);
}

// Tasks Functions
function addTask() {
    const input = document.getElementById('taskInput');
    if(input.value) {
        tasks.push({id: Date.now(), text: input.value, done: false});
        input.value = "";
        renderTasks();
        saveToLocalStorage();
        updateDashboard();
    }
}

function renderTasks() {
    const l = document.getElementById('tasks-list');
    if (tasks.length === 0) {
        l.innerHTML = '<div style="text-align:center; padding:50px; color:#94a3b8;">ูุง ุชูุฌุฏ ููุงู</div>';
        return;
    }
    
    l.innerHTML = tasks.map(t => `
        <div class="task-card ${t.done ? 'done' : ''}">
            <div style="display:flex; align-items:center; gap:10px; flex:1;">
                <input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleTask(${t.id})" style="width:20px; height:20px; cursor:pointer;">
                <span style="${t.done ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${t.text}</span>
            </div>
            <button onclick="deleteTask(${t.id})" style="border:none; color:#ef4444; background:none; cursor:pointer; font-size:20px;">๐๏ธ</button>
        </div>
    `).join('');
}

function toggleTask(id) {
    const task = tasks.find(t => t.id === id);
    if (task) {
        task.done = !task.done;
        renderTasks();
        saveToLocalStorage();
        updateDashboard();
    }
}

function deleteTask(id) {
    tasks = tasks.filter(t => t.id !== id);
    renderTasks();
    saveToLocalStorage();
    updateDashboard();
}

// XML Import
function handleXML(input) {
    const reader = new FileReader();
    reader.readAsText(input.files[0], "windows-1256");
    reader.onload = (e) => {
        const xml = new DOMParser().parseFromString(e.target.result, "text/xml");
        const newData = { teachers: {}, classes: {}, subjects: {}, lessons: [], periods: [] };
        
        Array.from(xml.getElementsByTagName('teacher')).forEach(t => 
            newData.teachers[t.getAttribute('id')] = t.getAttribute('name'));
        Array.from(xml.getElementsByTagName('class')).forEach(c => 
            newData.classes[c.getAttribute('id')] = c.getAttribute('short'));
        Array.from(xml.getElementsByTagName('subject')).forEach(s => 
            newData.subjects[s.getAttribute('id')] = s.getAttribute('name'));
        Array.from(xml.getElementsByTagName('period')).forEach(p => 
            newData.periods.push({
                id: p.getAttribute('period'),
                s: p.getAttribute('starttime'),
                e: p.getAttribute('endtime')
            }));
        
        newData.lessons = Array.from(xml.getElementsByTagName('TimeTableSchedule')).map(l => ({
            d: l.getAttribute('DayID'),
            p: l.getAttribute('Period'),
            c: l.getAttribute('ClassID'),
            t: l.getAttribute('TeacherID'),
            s: l.getAttribute('SubjectGradeID')
        }));
        
        data = newData;
        saveToLocalStorage();
        closeModal();
        refresh();
        updateDashboard();
        renderStaff();
        alert('ุชู ุงุณุชูุฑุงุฏ ุงูุฌุฏูู ุจูุฌุงุญ โ');
    };
}

// Excel Import/Export
function importFromExcel(input) {
    const reader = new FileReader();
    reader.onload = (e) => {
        const wb = XLSX.read(e.target.result, { type: 'binary' });
        const sheet = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        sheet.forEach(row => {
            if(row["ุงุณู ุงููุนูู"]) {
                phones[row["ุงุณู ุงููุนูู"]] = String(row["ุฑูู ุงููุงุชู"] || "");
            }
        });
        saveToLocalStorage();
        renderStaff();
        alert('ุชู ุงุณุชูุฑุงุฏ ุจูุงูุงุช ุงููุนูููู ุจูุฌุงุญ โ');
    };
    reader.readAsBinaryString(input.files[0]);
}

function exportToExcel() {
    const teachers = Array.from(new Set([...Object.values(data.teachers), ...Object.keys(phones)])).sort();
    
    if (teachers.length === 0) {
        alert('ูุง ููุฌุฏ ูุนูููู ููุชุตุฏูุฑ');
        return;
    }
    
    const list = teachers.map(name => ({
        "ุงุณู ุงููุนูู": name,
        "ุฑูู ุงููุงุชู": phones[name] || ""
    }));
    const ws = XLSX.utils.json_to_sheet(list);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ุงููุนูููู");
    XLSX.writeFile(wb, "ุงููุนูููู.xlsx");
}

// Utility Functions
function filterStaff() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('.filter-item').forEach(el => 
        el.style.display = el.innerText.toLowerCase().includes(q) ? 'block' : 'none');
}

function sendStaffMsg(n, id) {
    const ph = (phones[n] || "").replace(/\s+/g, '');
    const m = document.getElementById(id).value;
    if(ph && m) window.open(`https://wa.me/${ph}?text=${encodeURIComponent(m)}`);
    else if (!ph) alert('ูุง ููุฌุฏ ุฑูู ูุงุชู ููุฐุง ุงููุนูู');
    else alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุฑุณุงูุฉ');
}

function updatePhone(name) {
    const newPhone = prompt(`ุชุญุฏูุซ ุฑูู ${name}:`, phones[name] || "");
    if (newPhone !== null) {
        phones[name] = newPhone;
        saveToLocalStorage();
        renderStaff();
    }
}

function doSim() {
    isSim = true;
    sDay = 1;
    sTime = data.periods[0]?.s || "08:00";
    closeModal();
    refresh();
    updateDashboard();
}

function resetTime() {
    isSim = false;
    closeModal();
    refresh();
    updateDashboard();
}

function openModal() {
    document.getElementById('settingsModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('settingsModal').style.display = 'none';
}

function toM(t) {
    if(!t) return 0;
    const [h, m] = t.split(':');
    return parseInt(h) * 60 + parseInt(m);
}

function switchTab(t, b) {
    document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
    document.getElementById(t).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    b.classList.add('active');
    
    if(t === 'view-staff') renderStaff();
    if(t === 'view-visits') renderVisits();
    if(t === 'view-dashboard') updateDashboard();
}

// Auto-refresh
setInterval(() => {
    if(!isSim) {
        refresh();
        updateDashboardTime();
    }
}, 30000);
</script>

</body>
</html>
