<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #0f172a;
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --blue-grad: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * {
            font-family: 'Tajawal', sans-serif !important;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--bg);
            margin: 0;
            padding: 0;
            color: var(--text);
            padding-bottom: 80px;
            display: none; /* Ø³ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø±Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© JS */
        }

        /* Login Screen */
        #login-screen {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            color: var(--primary);
            margin-bottom: 30px;
        }

        .google-btn {
            width: 100%;
            padding: 15px;
            background: white;
            border: 2px solid #f1f5f9;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .google-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Layout Elements */
        .header {
            background: var(--blue-grad);
            color: white;
            padding: 20px;
            border-radius: 0 0 25px 25px;
            box-shadow: 0 10px 25px -5px rgba(15, 23, 42, 0.3);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .user-welcome { font-size: 0.85rem; opacity: 0.8; margin-bottom: 8px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .header-actions { display: flex; gap: 8px; }
        .header-btn { background: rgba(255,255,255,0.15); border: none; color: white; padding: 8px 12px; border-radius: 12px; font-size: 14px; cursor: pointer; }
        .logout-btn { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); }

        .container { padding: 20px; display: none; }
        .container.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Dashboard & Stats */
        .card { background: var(--card); padding: 20px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 16px; box-shadow: var(--shadow); text-align: center; }
        .stat-value { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 0.8rem; color: #64748b; }

        /* UI Components */
        .status-card { background: var(--card); padding: 15px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 20px; border-right: 6px solid var(--accent); display: flex; justify-content: space-between; align-items: center; }
        .lesson-card { background: var(--card); border-radius: 16px; padding: 15px; margin-bottom: 12px; box-shadow: var(--shadow); display: flex; align-items: center; justify-content: space-between; border: 1px solid #f1f5f9; }
        .class-badge { background: var(--primary); color: white; padding: 10px; border-radius: 12px; font-weight: 800; min-width: 60px; text-align: center; }
        .staff-card { background: var(--card); border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: var(--shadow); }
        .msg-select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0; margin-top: 10px; }
        .action-btn { border: none; padding: 12px; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; display: block; width: 100%; text-decoration: none; text-align: center; }

        /* Navigation */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 100; border-top: 1px solid #eee; }
        .nav-item { text-align: center; color: #94a3b8; background: none; border: none; font-size: 10px; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--primary); font-weight: 800; }
        .nav-item span { display: block; font-size: 20px; }

        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; backdrop-filter: blur(5px); padding: 20px; overflow-y: auto; }
        .modal-content { background: white; margin: 20px auto; width: 100%; max-width: 500px; padding: 25px; border-radius: 25px; }
        .form-group { margin-bottom: 15px; }
        .form-control { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h1>Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ âš¡</h1>
        <button class="google-btn" onclick="handleGoogleLogin()" id="loginBtn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
            <span id="loginText">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ø¬ÙˆØ¬Ù„</span>
        </button>
    </div>
</div>

<div class="header" id="mainHeader" style="display: none;">
    <div class="user-welcome" id="welcomeMsg">ğŸ‘¤ Ù†Ø±Ø­Ø¨ Ø¨Ø§Ù„Ù‚Ø§Ø¦Ø¯...</div>
    <div class="header-top">
        <h1>Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ âš¡</h1>
        <div class="header-actions">
            <button class="header-btn" onclick="openModal()">âš™ï¸ Ø¶Ø¨Ø·</button>
            <button class="header-btn logout-btn" onclick="handleLogout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>
</div>

<div id="view-dashboard" class="container active">
    <h3>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h3>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="statTeachers">0</div>
            <div class="stat-label">Ù…Ø¹Ù„Ù…</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statClasses">0</div>
            <div class="stat-label">ÙØµÙ„</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statVisits">0</div>
            <div class="stat-label">Ø²ÙŠØ§Ø±Ø© (Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statTasks">0</div>
            <div class="stat-label">Ù…Ù‡Ù…Ø© Ù†Ø´Ø·Ø©</div>
        </div>
    </div>
    <div class="card">
        <canvas id="visitsChart"></canvas>
    </div>
    <div class="status-card">
        <div>
            <div id="dashDate">--:--</div>
            <div id="dashPeriod" style="font-weight:800; color: var(--primary);">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©..</div>
        </div>
    </div>
</div>

<div id="view-schedule" class="container">
    <div class="status-card">
        <div>
            <div id="infoDate">--:--</div>
            <div id="infoPeriod" style="font-weight:800; color: var(--primary);">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©..</div>
        </div>
        <div id="simBadge" style="display:none; background:#fee2e2; color:#ef4444; padding:5px 10px; border-radius:10px;">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</div>
    </div>
    <div id="lessons-list"></div>
</div>

<div id="view-staff" class="container">
    <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ù„Ù…..." onkeyup="filterStaff()" class="form-control" style="margin-bottom:15px;">
    <div id="staff-list"></div>
</div>

<div id="view-visits" class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin:0;">ğŸ‘ï¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø´Ø±Ø§ÙÙŠØ©</h3>
        <button onclick="openVisitModal()" class="action-btn" style="background:var(--primary); width:auto; padding:10px 15px;">+ Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>
    <div id="visits-list"></div>
</div>

<div id="view-agenda" class="container">
    <h3>ğŸ“ Ø£Ø¬Ù†Ø¯Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</h3>
    <div style="display:flex; gap:10px; margin-bottom:20px;">
        <input type="text" id="taskInput" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©...">
        <button onclick="addTask()" class="action-btn" style="background:var(--primary); width:80px;">Ø¥Ø¶Ø§ÙØ©</button>
    </div>
    <div id="tasks-list"></div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØµØ©</h3>
        <div class="form-group">
            <label>1. Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ (XML)</label>
            <input type="file" id="xmlFile" accept=".xml" onchange="handleXML(this)" class="form-control">
        </div>
        <div class="form-group">
            <label>2. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† (Excel)</label>
            <div class="grid-2">
                <button onclick="exportToExcel()" style="background:#10b981;" class="action-btn">ğŸ“¥ ØªØµØ¯ÙŠØ±</button>
                <button onclick="document.getElementById('excelFile').click()" style="background:#3b82f6;" class="action-btn">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
                <input type="file" id="excelFile" style="display:none" onchange="importFromExcel(this)">
            </div>
        </div>
        <div class="grid-2">
            <button onclick="doSim()" style="background:var(--primary);" class="action-btn">ğŸ² Ù…Ø­Ø§ÙƒØ§Ø©</button>
            <button onclick="resetTime()" style="background:#64748b;" class="action-btn">ğŸ• Ø§Ù„Ø¢Ù†</button>
        </div>
        <button onclick="closeModal()" class="action-btn" style="background:#f1f5f9; color:var(--text); margin-top:20px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="visitModal" class="modal">
    <div class="modal-content">
        <h3>ğŸ‘ï¸ Ø²ÙŠØ§Ø±Ø© Ø¥Ø´Ø±Ø§ÙÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… *</label>
            <select id="visitTeacher" class="form-control"></select>
        </div>
        <div class="form-group">
            <label>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
            <textarea id="visitNotes" class="form-control" rows="3"></textarea>
        </div>
        <div class="grid-2">
            <button onclick="saveVisit()" style="background:var(--success);" class="action-btn">ğŸ’¾ Ø­ÙØ¸</button>
            <button onclick="closeVisitModal()" style="background:var(--danger);" class="action-btn">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<div class="bottom-nav" id="mainNav" style="display: none;">
    <button class="nav-item active" onclick="switchTab('view-dashboard', this)"><span>ğŸ“Š</span> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button class="nav-item" onclick="switchTab('view-schedule', this)"><span>ğŸ“…</span> Ø§Ù„Ø­ØµØµ</button>
    <button class="nav-item" onclick="switchTab('view-staff', this)"><span>ğŸ‘¥</span> Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</button>
    <button class="nav-item" onclick="switchTab('view-visits', this)"><span>ğŸ‘ï¸</span> Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</button>
    <button class="nav-item" onclick="switchTab('view-agenda', this)"><span>ğŸ“</span> Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyC4NddjijF29YNhowy4SqgRaMPn01oSSEg",
    authDomain: "school-9416e.firebaseapp.com",
    projectId: "school-9416e",
    storageBucket: "school-9416e.firebasestorage.app",
    messagingSenderId: "680872052240",
    appId: "1:680872052240:web:96d2e544166ab5f8096c95"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null, phones = {}, tasks = [], visits = [], isSim = false, sDay, sTime;
let data = { teachers: {}, classes: {}, subjects: {}, lessons: [], periods: [] };

// --- Auth Handling ---
auth.onAuthStateChanged(user => {
    document.body.style.display = "block";
    if (user) {
        currentUser = user;
        showMainApp();
        loadUserData();
    } else {
        showLoginScreen();
    }
});

function showLoginScreen() {
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('mainHeader').style.display = 'none';
    document.getElementById('mainNav').style.display = 'none';
}

function showMainApp() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('mainHeader').style.display = 'block';
    document.getElementById('mainNav').style.display = 'flex';
    document.getElementById('welcomeMsg').innerText = "ğŸ‘¤ Ù†Ø±Ø­Ø¨ Ø¨Ø§Ù„Ù‚Ø§Ø¦Ø¯ " + (currentUser.displayName || '');
}

async function handleGoogleLogin() {
    const btn = document.getElementById('loginBtn');
    btn.disabled = true;
    try {
        await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    } catch (e) {
        alert("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
        btn.disabled = false;
    }
}

function handleLogout() {
    if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) auth.signOut().then(() => location.reload());
}

// --- Data & Sync ---
async function loadUserData() {
    const doc = await db.collection("users").doc(currentUser.uid).get();
    if(doc.exists) {
        const cloud = doc.data();
        phones = cloud.phones || {};
        data = cloud.schoolData || data;
        tasks = cloud.tasks || [];
        visits = cloud.visits || [];
        refresh(); renderTasks(); renderStaff(); updateDashboard();
    }
}

async function syncToCloud() {
    if(currentUser) {
        await db.collection("users").doc(currentUser.uid).set({
            phones, schoolData: data, tasks, visits,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }
}

// --- Core Logic ---
function refresh() {
    const now = new Date();
    const d = isSim ? sDay : (now.getDay() === 0 ? 1 : now.getDay() + 1);
    const t = isSim ? sTime : now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0');
    
    document.getElementById('infoDate').innerText = t;
    document.getElementById('dashDate').innerText = t;
    
    const p = (data.periods || []).find(p => {
        const cur = toM(t), s = toM(p.s), e = toM(p.e);
        return cur >= s && cur <= e;
    });

    const list = document.getElementById('lessons-list');
    if (p && data.lessons) {
        const label = "Ø§Ù„Ø­ØµØ© Ø§Ù„Ù†Ø´Ø·Ø©: " + p.id;
        document.getElementById('infoPeriod').innerText = label;
        document.getElementById('dashPeriod').innerText = label;
        
        const current = data.lessons.filter(l => l.d == d && l.p == p.id);
        list.innerHTML = current.map(l => {
            const n = data.teachers[l.t], ph = (phones[n] || "").replace(/\s+/g, '');
            const msg = encodeURIComponent(`Ø§Ù„Ø£Ø³ØªØ§Ø° ${n}ØŒ Ù†Ù„Ø§Ø­Ø¸ ØªØ£Ø®Ø±ÙƒÙ… Ø¹Ù† Ø­ØµØ© ${data.classes[l.c]}. Ù†Ø±Ø¬Ùˆ Ø§Ù„ØªÙˆØ§Ø¬Ø¯.`);
            return `<div class="lesson-card">
                <div class="class-badge">${data.classes[l.c] || '..'}</div>
                <div style="flex:1; padding-right:15px;"><b>${n}</b></div>
                <button onclick="window.open('https://wa.me/${ph}?text=${msg}')" style="background:#10b981; border:none; color:white; border-radius:50%; width:35px; height:35px;">ğŸ’¬</button>
            </div>`;
        }).join('');
    } else {
        const label = "Ø®Ø§Ø±Ø¬ ÙˆÙ‚Øª Ø§Ù„Ø¯ÙˆØ§Ù…";
        document.getElementById('infoPeriod').innerText = label;
        document.getElementById('dashPeriod').innerText = label;
        list.innerHTML = `<div style="text-align:center; padding:50px; color:#94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;
    }
}

function updateDashboard() {
    document.getElementById('statTeachers').innerText = Object.keys(data.teachers).length;
    document.getElementById('statClasses').innerText = Object.keys(data.classes).length;
    document.getElementById('statTasks').innerText = tasks.length;
    document.getElementById('statVisits').innerText = visits.length;
}

// --- UI Actions ---
function switchTab(id, btn) {
    document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    btn.classList.add('active');
}

function openModal() { document.getElementById('settingsModal').style.display = 'block'; }
function closeModal() { document.getElementById('settingsModal').style.display = 'none'; }
function toM(t) { const [h, m] = t.split(':'); return parseInt(h) * 60 + parseInt(m); }

// --- Helpers ---
function handleXML(input) {
    const reader = new FileReader(); reader.readAsText(input.files[0], "windows-1256");
    reader.onload = async (e) => {
        const xml = new DOMParser().parseFromString(e.target.result, "text/xml");
        const newData = { teachers: {}, classes: {}, subjects: {}, lessons: [], periods: [] };
        Array.from(xml.getElementsByTagName('teacher')).forEach(t => newData.teachers[t.getAttribute('id')] = t.getAttribute('name'));
        Array.from(xml.getElementsByTagName('class')).forEach(c => newData.classes[c.getAttribute('id')] = c.getAttribute('short'));
        Array.from(xml.getElementsByTagName('period')).forEach(p => newData.periods.push({id: p.getAttribute('period'), s: p.getAttribute('starttime'), e: p.getAttribute('endtime')}));
        newData.lessons = Array.from(xml.getElementsByTagName('TimeTableSchedule')).map(l => ({ d: l.getAttribute('DayID'), p: l.getAttribute('Period'), c: l.getAttribute('ClassID'), t: l.getAttribute('TeacherID') }));
        data = newData; await syncToCloud(); closeModal(); refresh(); updateDashboard();
    };
}

function renderTasks() {
    document.getElementById('tasks-list').innerHTML = tasks.map(t => `<div class="card" style="display:flex; justify-content:space-between; padding:15px;"><span>${t.text}</span><button onclick="tasks=tasks.filter(x=>x.id!=${t.id});renderTasks();syncToCloud();" style="border:none; color:red; background:none;">ğŸ—‘ï¸</button></div>`).join('');
}
function addTask() {
    const input = document.getElementById('taskInput');
    if(input.value) { tasks.push({id:Date.now(), text:input.value}); input.value=""; renderTasks(); syncToCloud(); updateDashboard(); }
}

function openVisitModal() {
    const sel = document.getElementById('visitTeacher');
    sel.innerHTML = Object.values(data.teachers).map(t => `<option>${t}</option>`).join('');
    document.getElementById('visitModal').style.display = 'block';
}
function closeVisitModal() { document.getElementById('visitModal').style.display = 'none'; }
async function saveVisit() {
    visits.push({ teacher: document.getElementById('visitTeacher').value, notes: document.getElementById('visitNotes').value, date: new Date().toLocaleDateString() });
    await syncToCloud(); closeVisitModal(); updateDashboard();
}

function doSim() { isSim = true; sDay = 1; sTime = "08:00"; closeModal(); refresh(); }
function resetTime() { isSim = false; closeModal(); refresh(); }

setInterval(() => { if(currentUser && !isSim) refresh(); }, 30000);
</script>
</body>
</html>
