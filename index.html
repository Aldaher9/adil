<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مدير المدرسة الذكي</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        brand: { 50:'#eff6ff', 100:'#dbeafe', 500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8', 900:'#1e3a8a' }
                    }
                }
            }
        }
    </script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    
    <!-- Excel Export/Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --color-primary-50: 239 246 255; /* indigo-50 */
            --color-primary-100: 219 234 254; /* indigo-100 */
            --color-primary-200: 199 210 254; /* indigo-200 */
            --color-primary-500: 99 102 241; /* indigo-500 */
            --color-primary-600: 79 70 229; /* indigo-600 */
            --color-primary-700: 67 56 202; /* indigo-700 */
            --color-primary-900: 49 46 129; /* indigo-900 */
            
            --color-bg-base: 248 250 252; /* slate-50 */
            --color-text-base: 30 41 59; /* slate-800 */
            --color-text-muted: 100 116 139; /* slate-500 */
            --color-surface-base: 255 255 255; /* white */
            --color-border-base: 241 245 249; /* slate-100 */
            --color-border-muted: 226 232 240; /* slate-200 */
        }

        .theme-pink {
            --color-primary-50: 253 242 248; /* pink-50 */
            --color-primary-100: 252 231 243; /* pink-100 */
            --color-primary-200: 251 207 232; /* pink-200 */
            --color-primary-500: 236 72 153;  /* pink-500 */
            --color-primary-600: 219 39 119;  /* pink-600 */
            --color-primary-700: 190 24 93;   /* pink-700 */
            --color-primary-900: 131 24 67;   /* pink-900 */
        }

        .theme-green {
            --color-primary-50: 240 253 244; /* green-50 */
            --color-primary-100: 220 252 231; /* green-100 */
            --color-primary-200: 187 247 208; /* green-200 */
            --color-primary-500: 34 197 94;   /* green-500 */
            --color-primary-600: 22 163 74;   /* green-600 */
            --color-primary-700: 21 128 61;   /* green-700 */
            --color-primary-900: 20 83 45;    /* green-900 */
        }

        .theme-dark {
            --color-primary-50: 30 41 59; /* slate-800 */
            --color-primary-100: 51 65 85; /* slate-700 */
            --color-primary-200: 71 85 105; /* slate-600 */
            --color-primary-500: 99 102 241; /* indigo-500 */
            --color-primary-600: 129 140 248; /* indigo-400 */
            --color-primary-700: 165 180 252; /* indigo-300 */
            --color-primary-900: 49 46 129; /* indigo-900 */
            
            --color-bg-base: 15 23 42; /* slate-900 */
            --color-text-base: 226 232 240; /* slate-200 */
            --color-text-muted: 148 163 184; /* slate-400 */
            --color-surface-base: 30 41 59; /* slate-800 */
            --color-border-base: 51 65 85; /* slate-700 */
            --color-border-muted: 71 85 105; /* slate-600 */
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-view { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .modal-content { z-index: 60; position: relative; }
        .modal-backdrop { z-index: 50; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .sup-radio:checked + div { background-color: rgb(var(--color-primary-50)); border-color: rgb(var(--color-primary-600)); }
        .sup-radio:checked + div .check-icon { display: block; }
        .print-only { display: none; }
        [x-cloak] { display: none !important; }
        @media print {
            body * { visibility: hidden; }
            #view-supervision-report, #view-supervision-report * { visibility: visible; }
            #view-supervision-report { position: absolute; left: 0; top: 0; width: 100%; display: block !important; padding: 0; margin: 0; }
            .no-print { display: none !important; }
            .print-only { display: block; }
        }
        .task-checkbox:checked + div {
            text-decoration: line-through;
            color: rgb(var(--color-text-muted));
            opacity: 0.7;
        }
        .today-row {
            background-color: #fef9c3 !important; /* yellow-50 */
            border-right: 4px solid #facc15 !important; /* yellow-400 */
        }
        .today-row td {
            color: #854d0e !important; /* yellow-800 */
            font-weight: bold;
        }
        /* AI Report Styling */
        .ai-report-section h4 { font-weight: 800; color: rgb(var(--color-primary-700)); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; }
        .ai-report-section ul { list-style: disc; padding-right: 1.5rem; space-y: 0.5rem; }
        .ai-report-section li { margin-bottom: 0.5rem; line-height: 1.6; }
        .ai-report-section p { line-height: 1.8; text-align: justify; margin-bottom: 1rem; }
    </style>
<script type="importmap">
{
  "imports": {
    "rxjs": "https://esm.sh/rxjs@^7.8.2?conditions=es2015",
    "rxjs/operators": "https://esm.sh/rxjs@^7.8.2/operators?conditions=es2015",
    "rxjs/ajax": "https://esm.sh/rxjs@^7.8.2/ajax?conditions=es2015",
    "rxjs/webSocket": "https://esm.sh/rxjs@^7.8.2/webSocket?conditions=es2015",
    "rxjs/testing": "https://esm.sh/rxjs@^7.8.2/testing?conditions=es2015",
    "rxjs/fetch": "https://esm.sh/rxjs@^7.8.2/fetch?conditions=es2015",
    "@angular/common": "https://esm.sh/@angular/common@^21.0.6?external=rxjs",
    "@angular/compiler": "https://esm.sh/@angular/compiler@^21.0.6?external=rxjs",
    "@angular/forms": "https://esm.sh/@angular/forms@^21.0.6?external=rxjs",
    "@angular/platform-browser": "https://esm.sh/@angular/platform-browser@^21.0.6?external=rxjs",
    "@angular/core": "https://esm.sh/@angular/core@^21.0.6?external=rxjs",
    "@google/genai": "https://esm.sh/@google/genai"
  }
}
</script>
<script type="module">
    import { GoogleGenAI } from "@google/genai";
    window.GoogleGenAI = GoogleGenAI;
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-[rgb(var(--color-bg-base))] text-[rgb(var(--color-text-base))] antialiased selection:bg-brand-100 selection:text-brand-900 pb-28">

    <!-- Login View -->
    <div id="login-view" class="min-h-screen flex flex-col items-center justify-center bg-slate-100 p-4">
        <div class="w-full max-w-sm text-center">
            <i class="fas fa-university text-5xl text-indigo-500 mb-4"></i>
            <h1 class="text-3xl font-bold text-slate-800">مدير المدرسة الذكي</h1>
            <p class="text-slate-500 mt-2 mb-8">مساحتك الخاصة لإدارة مدرستك بفاعلية.</p>
            <button onclick="window.app.handleGoogleLogin()" class="w-full bg-white hover:bg-slate-50 text-slate-700 font-bold py-3 px-4 rounded-xl shadow-md border border-slate-200 flex items-center justify-center gap-3 transition">
                <img src="https://www.google.com/favicon.ico" class="w-5 h-5" alt="Google icon">
                تسجيل الدخول باستخدام جوجل
            </button>
        </div>
    </div>
    
    <!-- App View -->
    <div id="app-view" class="hidden-view">
    <!-- Header (Fixed Top) -->
    <header class="bg-[rgb(var(--color-primary-900))] text-white shadow-xl sticky top-0 z-40 no-print">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
             <div id="user-profile-container" class="flex items-center gap-3">
                <!-- User profile will be rendered here -->
            </div>

            <div class="flex gap-2 items-center">
                <div class="bg-black/20 px-3 py-1.5 rounded-lg border border-white/10 backdrop-blur-sm flex items-center gap-2">
                    <i class="fas fa-clock text-[rgb(var(--color-primary-200))] text-xs"></i>
                    <span id="clockDisplay" class="font-mono font-bold text-green-400 dir-ltr text-sm">00:00:00</span>
                </div>
                <button onclick="window.app.simulateRandomPeriod()" class="text-xs bg-white/10 hover:bg-white/20 w-8 h-8 flex items-center justify-center rounded-lg transition text-indigo-200 hover:text-white" title="محاكاة حصة عشوائية">
                    <i class="fas fa-wand-magic-sparkles"></i>
                </button>
                <button onclick="window.app.resetTimeToReal()" class="text-xs bg-white/10 hover:bg-white/20 w-8 h-8 flex items-center justify-center rounded-lg transition text-indigo-200 hover:text-white" title="الوقت الفعلي">
                    <i class="fas fa-clock-rotate-left"></i>
                </button>
                 <button onclick="window.app.openSettings()" class="text-xs bg-white/10 hover:bg-white/20 w-8 h-8 flex items-center justify-center rounded-lg transition text-indigo-200 hover:text-white" title="الإعدادات">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Views -->
    <main class="container mx-auto p-4 md:p-6">
        
        <!-- View: Current Classes -->
        <section id="view-now" class="fade-in space-y-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-3 bg-[rgb(var(--color-surface-base))] p-4 rounded-xl shadow-sm border border-[rgb(var(--color-border-base))]">
                <div class="flex items-center gap-3">
                    <div class="bg-[rgb(var(--color-primary-100))] text-[rgb(var(--color-primary-700))] w-10 h-10 rounded-full flex items-center justify-center text-lg">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-[rgb(var(--color-text-base))]">الحصص القائمة الآن</h2>
                    </div>
                </div>
                <div id="currentPeriodInfo"></div>
            </div>
            <!-- Compact Grid -->
            <div id="activeClassesGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-2"></div>
        </section>

        <!-- View: Teachers -->
        <section id="view-teachers" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col md:flex-row justify-between gap-4 bg-[rgb(var(--color-surface-base))] p-6 rounded-2xl shadow-sm border border-[rgb(var(--color-border-base))]">
                <div>
                    <h2 class="text-2xl font-bold text-[rgb(var(--color-text-base))]">سجل المعلمين</h2>
                    <p class="text-[rgb(var(--color-text-muted))] text-sm">إدارة بيانات التواصل والتخصصات</p>
                </div>
                <div class="relative w-full md:w-96">
                    <input type="text" id="teacherSearch" onkeyup="window.app.renderTeachers()" placeholder="بحث عن معلم..." class="w-full pl-4 pr-10 py-3 rounded-xl border border-[rgb(var(--color-border-muted))] focus:border-[rgb(var(--color-primary-500))] focus:ring-2 focus:ring-[rgb(var(--color-primary-200))] transition-all outline-none bg-[rgb(var(--color-bg-base))] focus:bg-[rgb(var(--color-surface-base))]">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                </div>
            </div>
            <div id="teachersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
        </section>

        <!-- View: Agenda -->
        <section id="view-agenda" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col md:flex-row justify-between gap-4 bg-[rgb(var(--color-surface-base))] p-6 rounded-2xl shadow-sm border border-[rgb(var(--color-border-base))]">
                <div class="flex items-center gap-3">
                    <div class="bg-amber-100 text-amber-700 w-12 h-12 rounded-xl flex items-center justify-center text-xl">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-[rgb(var(--color-text-base))]">الأجندة العامة</h2>
                        <p class="text-[rgb(var(--color-text-muted))] text-sm">أجندة مدارس السلطنة</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.app.verifyAdminAndImportAgenda()" class="bg-[rgb(var(--color-surface-base))] hover:bg-[rgb(var(--color-bg-base))] text-[rgb(var(--color-text-base))] border border-[rgb(var(--color-border-muted))] px-4 py-2 rounded-xl font-bold flex items-center gap-2 transition cursor-pointer">
                        <i class="fas fa-lock text-red-400"></i>
                        <span>استيراد (مسؤول)</span>
                    </button>
                    <input type="file" id="agendaInput" accept=".xlsx, .xls" class="hidden" onchange="window.app.handleAgendaExcel(event)">
                </div>
            </div>

            <!-- Agenda Table -->
            <div class="bg-[rgb(var(--color-surface-base))] rounded-2xl shadow-sm border border-[rgb(var(--color-border-base))] overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead class="bg-[rgb(var(--color-bg-base))] border-b border-[rgb(var(--color-border-base))] text-[rgb(var(--color-text-muted))] text-sm uppercase">
                            <tr>
                                <th class="p-4 w-16 text-center">#</th>
                                <th class="p-4 w-48">التاريخ</th>
                                <th class="p-4">الحدث</th>
                            </tr>
                        </thead>
                        <tbody id="agendaBody" class="divide-y divide-[rgb(var(--color-border-base))]">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- View: Tasks -->
        <section id="view-tasks" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col gap-4 bg-[rgb(var(--color-surface-base))] p-6 rounded-2xl shadow-sm border border-[rgb(var(--color-border-base))]">
                <div class="flex justify-between items-center">
                     <div>
                        <h2 class="text-2xl font-bold text-[rgb(var(--color-text-base))]">مهام المدير</h2>
                        <p class="text-[rgb(var(--color-text-muted))] text-sm">متابعة الأعمال اليومية والإدارية</p>
                    </div>
                    <div class="bg-[rgb(var(--color-primary-50))] px-3 py-1 rounded-lg border border-[rgb(var(--color-primary-100))]">
                        <span class="text-xs font-bold text-[rgb(var(--color-primary-700))]" id="tasksProgressText">0/0 مكتمل</span>
                    </div>
                </div>
                <!-- Progress Bar -->
                <div class="w-full h-2 bg-[rgb(var(--color-bg-base))] rounded-full overflow-hidden">
                    <div id="tasksProgressBar" class="h-full bg-[rgb(var(--color-primary-500))] transition-all duration-500 w-0"></div>
                </div>
                
                <!-- Add Task Form -->
                <div class="flex gap-2 items-center bg-[rgb(var(--color-bg-base))] p-2 rounded-xl border border-[rgb(var(--color-border-muted))]">
                     <input type="text" id="newTaskInput" placeholder="أضف مهمة جديدة..." class="flex-1 bg-transparent border-none outline-none px-2 text-sm text-[rgb(var(--color-text-base))]" onkeypress="if(event.key === 'Enter') window.app.addTask()">
                     <select id="newTaskPriority" class="text-xs bg-[rgb(var(--color-surface-base))] border border-[rgb(var(--color-border-muted))] rounded-lg px-2 py-2 outline-none text-[rgb(var(--color-text-base))]">
                         <option value="normal">عادي</option>
                         <option value="urgent">عاجل</option>
                     </select>
                     <button onclick="window.app.addTask()" class="bg-[rgb(var(--color-primary-600))] hover:bg-[rgb(var(--color-primary-700))] text-white w-10 h-10 rounded-lg flex items-center justify-center transition cursor-pointer">
                        <i class="fas fa-plus"></i>
                     </button>
                </div>
            </div>

            <!-- Tasks List -->
            <div id="tasksList" class="grid gap-3"></div>
        </section>

        <!-- View: Reports -->
        <section id="view-reports" class="fade-in space-y-6 hidden-view">
            <div class="flex justify-between items-center bg-[rgb(var(--color-surface-base))] p-6 rounded-2xl shadow-sm border border-[rgb(var(--color-border-base))]">
                <div>
                    <h2 class="text-2xl font-bold text-[rgb(var(--color-text-base))]">تقارير الأداء</h2>
                    <p class="text-sm text-[rgb(var(--color-text-muted))]">نظرة عامة على انضباط المعلمين</p>
                </div>
                <button onclick="window.app.exportReports()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 transition shadow-lg shadow-emerald-200">
                    <i class="fas fa-file-excel"></i> <span>تصدير Excel</span>
                </button>
            </div>
            <div class="bg-[rgb(var(--color-surface-base))] rounded-2xl shadow-sm border border-[rgb(var(--color-border-base))] overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead class="bg-[rgb(var(--color-bg-base))] border-b border-[rgb(var(--color-border-base))] text-[rgb(var(--color-text-muted))] text-sm uppercase">
                            <tr>
                                <th class="p-5 font-bold">المعلم</th>
                                <th class="p-5 font-bold text-center">التقييم</th>
                                <th class="p-5 font-bold text-center">الهاتف</th>
                                <th class="p-5 font-bold text-center">الحالة</th>
                            </tr>
                        </thead>
                        <tbody id="reportsBody" class="divide-y divide-[rgb(var(--color-border-base))]"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- View: Supervision History -->
        <section id="view-supervision-history" class="fade-in space-y-6 hidden-view">
            <div class="flex justify-between items-center bg-[rgb(var(--color-surface-base))] p-6 rounded-2xl shadow-sm border border-[rgb(var(--color-border-base))]">
                <div>
                    <h2 class="text-2xl font-bold text-[rgb(var(--color-text-base))]">سجل الزيارات الإشرافية</h2>
                    <p class="text-sm text-[rgb(var(--color-text-muted))]">أرشيف الزيارات السابقة والتقارير</p>
                </div>
            </div>
            <div id="supervisionHistoryGrid" class="space-y-3"></div>
        </section>

        <!-- View: Supervision Form -->
        <section id="view-supervision" class="fade-in space-y-6 hidden-view pb-20">
            <div class="flex items-center gap-2 mb-4 text-sm text-[rgb(var(--color-text-muted))] cursor-pointer hover:text-[rgb(var(--color-primary-600))] transition" onclick="window.app.setView('now')">
                <i class="fas fa-arrow-right"></i> عودة
            </div>
            
            <div class="bg-[rgb(var(--color-surface-base))] p-6 rounded-2xl shadow-sm border border-[rgb(var(--color-border-base))]">
                <h2 class="text-2xl font-bold text-[rgb(var(--color-text-base))] mb-6 flex items-center gap-2">
                    <i class="fas fa-clipboard-check text-[rgb(var(--color-primary-500))]"></i> زيارة إشرافية ذكية
                </h2>
                
                <!-- Info Fields -->
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-[rgb(var(--color-text-muted))] mb-1">المعلم</label>
                        <input type="text" id="supTeacherName" readonly class="w-full bg-[rgb(var(--color-bg-base))] border border-[rgb(var(--color-border-muted))] rounded-lg p-2 text-[rgb(var(--color-text-base))] font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-[rgb(var(--color-text-muted))] mb-1">تخصص المعلم</label>
                        <div class="relative">
                            <select id="supSpecialization" class="w-full bg-[rgb(var(--color-surface-base))] border border-[rgb(var(--color-border-muted))] rounded-lg p-2 text-[rgb(var(--color-text-base))] focus:border-[rgb(var(--color-primary-500))] outline-none appearance-none">
                                <option value="">اختر التخصص...</option>
                            </select>
                            <i class="fas fa-chevron-down absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-[rgb(var(--color-text-muted))] mb-1">الصف</label>
                        <input type="text" id="supClassName" class="w-full bg-[rgb(var(--color-surface-base))] border border-[rgb(var(--color-border-muted))] rounded-lg p-2 text-[rgb(var(--color-text-base))] focus:border-[rgb(var(--color-primary-500))] outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-[rgb(var(--color-text-muted))] mb-1">عنوان الدرس</label>
                        <input type="text" id="supLessonTopic" placeholder="أدخل عنوان الدرس..." class="w-full bg-[rgb(var(--color-surface-base))] border border-[rgb(var(--color-border-muted))] rounded-lg p-2 text-[rgb(var(--color-text-base))] focus:border-[rgb(var(--color-primary-500))] outline-none">
                    </div>
                </div>

                <!-- Criteria List -->
                <div id="supervisionCriteriaList" class="space-y-6"></div>

                <button onclick="window.app.generateReport()" class="w-full bg-[rgb(var(--color-primary-600))] hover:bg-[rgb(var(--color-primary-700))] text-white font-bold py-4 rounded-xl shadow-lg shadow-[rgb(var(--color-primary-200))] transition mt-8 flex items-center justify-center gap-2 cursor-pointer">
                    <i class="fas fa-magic"></i> توليد التقرير الذكي
                </button>
            </div>
        </section>

        <!-- View: Supervision Report -->
        <section id="view-supervision-report" class="fade-in space-y-6 hidden-view bg-[rgb(var(--color-surface-base))] p-8 rounded-none md:rounded-2xl shadow-none md:shadow-lg min-h-screen md:min-h-0 print:min-h-0">
            <!-- Header -->
            <div class="border-b-2 border-slate-800 pb-6 mb-6 flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-900 mb-2">تقرير زيارة إشرافية</h1>
                    <p class="text-[rgb(var(--color-text-muted))] text-sm">نظام الإدارة المدرسية الذكي</p>
                </div>
                <div class="text-left text-sm text-[rgb(var(--color-text-muted))]">
                    <p id="reportDate" class="font-mono"></p>
                </div>
            </div>

            <!-- Basic Info -->
            <div class="bg-[rgb(var(--color-bg-base))] rounded-xl p-6 border border-[rgb(var(--color-border-muted))] mb-8">
                <div class="grid grid-cols-2 gap-y-4 text-sm">
                    <div><span class="text-slate-400 ml-2">المعلم:</span> <span id="repTeacherName" class="font-bold text-[rgb(var(--color-text-base))] text-lg"></span></div>
                    <div><span class="text-slate-400 ml-2">التخصص:</span> <span id="repSpecialization" class="font-bold text-[rgb(var(--color-text-base))]"></span></div>
                    <div><span class="text-slate-400 ml-2">الصف:</span> <span id="repClassName" class="font-bold text-[rgb(var(--color-text-base))]"></span></div>
                    <div><span class="text-slate-400 ml-2">الدرس:</span> <span id="repLessonTopic" class="font-bold text-[rgb(var(--color-text-base))]"></span></div>
                </div>
            </div>

            <!-- Detailed Analysis Table -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-[rgb(var(--color-text-base))] mb-4 flex items-center gap-2 bg-[rgb(var(--color-bg-base))] w-fit px-3 py-1 rounded-lg border border-[rgb(var(--color-border-muted))]">
                    <i class="fas fa-list-ol text-[rgb(var(--color-primary-600))]"></i> تفاصيل التقييم
                </h3>
                <div class="overflow-hidden rounded-xl border border-[rgb(var(--color-border-muted))]">
                    <table class="w-full text-right text-sm">
                        <thead class="bg-[rgb(var(--color-bg-base))] text-[rgb(var(--color-text-muted))] font-bold border-b border-[rgb(var(--color-border-muted))]">
                            <tr>
                                <th class="p-3 w-1/2">البند</th>
                                <th class="p-3 text-center w-16">التقييم</th>
                                <th class="p-3">الملاحظات</th>
                            </tr>
                        </thead>
                        <tbody id="repDetailsBody" class="divide-y divide-[rgb(var(--color-border-base))] bg-[rgb(var(--color-surface-base))]">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- AI Enhanced Report Container -->
            <div class="mb-8 relative">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-[rgb(var(--color-primary-700))] flex items-center gap-2 bg-[rgb(var(--color-primary-50))] w-fit px-3 py-1 rounded-lg border border-[rgb(var(--color-primary-100))]">
                        <i class="fas fa-robot"></i> التحليل النوعي والتوصيات
                    </h3>
                    <button onclick="window.app.enhanceReportWithAI()" class="text-xs bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-2 rounded-full flex items-center gap-2 shadow-md hover:shadow-lg transition cursor-pointer no-print">
                        <i class="fas fa-wand-magic-sparkles"></i> 
                        <span class="font-bold">تحسين شامل بالذكاء الاصطناعي</span>
                    </button>
                </div>

                <!-- Dynamic AI Content Area -->
                <div id="aiReportContent" class="space-y-6">
                    <!-- Default content generated by JS will go here, then replaced by AI -->
                    
                    <!-- Strengths -->
                    <div class="ai-report-section">
                        <h4><i class="fas fa-star text-emerald-500"></i> أبرز جوانب الإجادة</h4>
                        <ul id="repStrengths" class="list-disc pr-5 text-sm text-[rgb(var(--color-text-base))]"></ul>
                    </div>

                    <!-- Weaknesses -->
                    <div class="ai-report-section">
                        <h4><i class="fas fa-chart-line text-orange-500"></i> نقاط تحتاج إلى تحسين</h4>
                        <ul id="repImprovements" class="list-disc pr-5 text-sm text-[rgb(var(--color-text-base))]"></ul>
                    </div>

                    <!-- Recommendations -->
                    <div class="ai-report-section bg-[rgb(var(--color-primary-50))]/50 p-4 rounded-xl border border-[rgb(var(--color-primary-100))]">
                        <h4><i class="fas fa-lightbulb text-yellow-500"></i> التوصيات والمقترحات الفنية</h4>
                        <ul id="repRecommendations" class="list-decimal pr-5 text-sm text-[rgb(var(--color-text-base))] space-y-2"></ul>
                    </div>
                </div>

                <!-- Loading Overlay for AI -->
                <div id="aiLoadingOverlay" class="absolute inset-0 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center z-10 hidden-view rounded-xl">
                    <i class="fas fa-spinner fa-spin text-4xl text-[rgb(var(--color-primary-600))] mb-3"></i>
                    <span class="text-sm font-bold text-[rgb(var(--color-primary-900))]">جاري صياغة التقرير الاحترافي...</span>
                    <span class="text-xs text-[rgb(var(--color-text-muted))] mt-1">يتم تحليل التخصص وعنوان الدرس وملاحظات الزيارة</span>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex gap-4 mt-12 no-print">
                <button onclick="window.print()" class="flex-1 bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 cursor-pointer">
                    <i class="fas fa-print"></i> طباعة / PDF
                </button>
                <button onclick="window.app.saveVisit()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 cursor-pointer">
                    <i class="fas fa-save"></i> حفظ في السجل
                </button>
                <button onclick="window.app.setView('supervision')" class="flex-1 bg-[rgb(var(--color-surface-base))] border border-slate-300 text-[rgb(var(--color-text-muted))] hover:bg-[rgb(var(--color-bg-base))] py-3 rounded-xl font-bold transition cursor-pointer">
                    تعديل
                </button>
                <button onclick="window.app.setView('supervision-history')" class="flex-1 bg-red-50 border border-red-200 text-red-600 hover:bg-red-100 py-3 rounded-xl font-bold transition cursor-pointer">
                    إغلاق
                </button>
            </div>
        </section>

    </main>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-[rgb(var(--color-surface-base))] border-t border-[rgb(var(--color-border-muted))] shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-40 pb-safe no-print">
        <div class="flex justify-around items-center h-16 px-2">
            <button onclick="window.app.setView('now')" id="btn-now" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-[rgb(var(--color-primary-700))] transition-all duration-300 group">
                <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-[rgb(var(--color-primary-50))] group-hover:bg-[rgb(var(--color-primary-100))] transition-colors">
                    <i class="fas fa-chalkboard text-xl mb-0.5"></i>
                </div>
                <span class="text-[10px] font-bold">الحصص</span>
            </button>
            
            <button onclick="window.app.setView('teachers')" id="btn-teachers" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-[rgb(var(--color-text-base))] transition-all duration-300 group">
                 <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-[rgb(var(--color-bg-base))] transition-colors">
                    <i class="fas fa-users-cog text-xl mb-0.5"></i>
                 </div>
                <span class="text-[10px] font-bold">المعلمين</span>
            </button>
            
             <!-- Agenda Button (New) -->
             <button onclick="window.app.setView('agenda')" id="btn-agenda" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-[rgb(var(--color-text-base))] transition-all duration-300 group">
                 <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-[rgb(var(--color-bg-base))] transition-colors">
                    <i class="fas fa-calendar-alt text-xl mb-0.5"></i>
                 </div>
                <span class="text-[10px] font-bold">الأجندة</span>
            </button>

             <!-- Tasks Button -->
             <button onclick="window.app.setView('tasks')" id="btn-tasks" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-[rgb(var(--color-text-base))] transition-all duration-300 group">
                 <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-[rgb(var(--color-bg-base))] transition-colors">
                    <i class="fas fa-check-square text-xl mb-0.5"></i>
                 </div>
                <span class="text-[10px] font-bold">المهام</span>
            </button>

            <button onclick="window.app.setView('reports')" id="btn-reports" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-[rgb(var(--color-text-base))] transition-all duration-300 group">
                 <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-[rgb(var(--color-bg-base))] transition-colors">
                    <i class="fas fa-file-invoice text-xl mb-0.5"></i>
                 </div>
                <span class="text-[10px] font-bold">التقارير</span>
            </button>
        </div>
    </nav>
    </div> <!-- End of #app-view -->

    <!-- Modals -->
    
    <!-- Action Modal -->
    <div id="modal-action" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden-view">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm modal-backdrop" onclick="window.app.closeModal('modal-action')"></div>
        <div class="bg-[rgb(var(--color-surface-base))] w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-scale-in modal-content mb-20">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-start">
                <div>
                    <h3 class="text-lg font-bold flex items-center gap-2" id="actionModalTitle"></h3>
                    <p id="actionModalSubtitle" class="text-slate-300 text-xs mt-1"></p>
                </div>
                <button type="button" onclick="window.app.closeModal('modal-action')" class="text-white/50 hover:text-white"><i class="fas fa-times text-lg"></i></button>
            </div>
            
            <div class="p-4 space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar">
                <!-- Evaluation Button -->
                <button type="button" id="btn-evaluate" class="w-full bg-[rgb(var(--color-primary-50))] hover:bg-[rgb(var(--color-primary-100))] text-[rgb(var(--color-primary-700))] border border-[rgb(var(--color-primary-200))] p-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition cursor-pointer mb-2">
                    <i class="fas fa-clipboard-list text-xl"></i>
                    <span>تقييم زيارة إشرافية</span>
                </button>

                <div class="h-px bg-[rgb(var(--color-border-base))] mb-2"></div>

                <!-- Communication Buttons -->
                <div class="space-y-2">
                     <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">التواصل</label>
                     <div class="grid grid-cols-2 gap-2">
                         <button type="button" onclick="window.app.sendWhatsApp('summon')" class="bg-emerald-50 hover:bg-emerald-100 text-emerald-700 border border-emerald-200 p-3 rounded-lg font-bold text-xs flex flex-col items-center gap-2 transition cursor-pointer">
                            <i class="fab fa-whatsapp text-xl"></i><span>استدعاء</span>
                         </button>
                         <button type="button" id="btn-remind" onclick="window.app.sendWhatsApp('remind')" class="bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-200 p-3 rounded-lg font-bold text-xs flex flex-col items-center gap-2 transition cursor-pointer">
                            <i class="fas fa-bell text-xl"></i><span>تذكير</span>
                         </button>
                     </div>
                </div>
                <div class="h-px bg-[rgb(var(--color-border-base))]"></div>
                <!-- Dynamic Violation Buttons -->
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">المخالفات</label>
                    <div id="violationButtonsContainer" class="space-y-2"></div>
                </div>
            </div>
             <div class="bg-[rgb(var(--color-bg-base))] p-3 text-center border-t border-[rgb(var(--color-border-muted))] flex justify-between items-center px-6">
                <span class="text-xs text-[rgb(var(--color-text-muted))]">التقييم الحالي</span>
                <span class="text-lg font-bold text-[rgb(var(--color-text-base))]" id="currentScoreDisplay"></span>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="modal-settings" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden-view">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm modal-backdrop" onclick="window.app.closeModal('modal-settings')"></div>
        <div class="bg-[rgb(var(--color-surface-base))] w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden animate-scale-in flex flex-col max-h-[80vh] modal-content mb-16">
            <div class="bg-slate-800 text-white p-5 flex justify-between items-center shrink-0">
                <h3 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-cog"></i> الإعدادات</h3>
                <button type="button" onclick="window.app.closeModal('modal-settings')" class="text-white/70 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scrollbar space-y-8">
                <!-- Theme Selection -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between pb-2 border-b border-[rgb(var(--color-border-base))]">
                        <h4 class="font-bold text-[rgb(var(--color-text-base))] flex items-center gap-2">
                            <i class="fas fa-palette text-sky-500"></i>
                            المظهر
                        </h4>
                    </div>
                    <div id="themeSelectorContainer" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <!-- Theme buttons will be rendered here by JS -->
                    </div>
                </div>

                <!-- API Key Section (Cleaned for Built-in feature) -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between pb-2 border-b border-[rgb(var(--color-border-base))]">
                        <h4 class="font-bold text-[rgb(var(--color-text-base))] flex items-center gap-2">
                            <i class="fas fa-robot text-purple-500"></i>
                            إعدادات الذكاء الاصطناعي
                        </h4>
                    </div>
                    <div class="bg-[rgb(var(--color-bg-base))] p-3 rounded-lg border border-[rgb(var(--color-border-muted))] space-y-2">
                        <p class="text-xs text-[rgb(var(--color-text-muted))] flex items-center gap-2">
                            <i class="fas fa-check-circle text-green-500"></i>
                            مفتاح API مفعل ومدمج في النظام.
                        </p>
                    </div>
                </div>

                <!-- Violation Management -->
                <div class="space-y-4">
                     <div class="flex items-center justify-between pb-2 border-b border-[rgb(var(--color-border-base))]">
                        <h4 class="font-bold text-[rgb(var(--color-text-base))] text-sm flex items-center gap-2"><i class="fas fa-gavel text-red-500"></i> إدارة المخالفات</h4>
                    </div>
                    <!-- Add Form -->
                    <div class="flex gap-2 bg-[rgb(var(--color-bg-base))] p-3 rounded-lg border border-[rgb(var(--color-border-muted))] items-end">
                        <div class="flex-1 space-y-1">
                            <label class="text-[10px] font-bold text-[rgb(var(--color-text-muted))]">اسم المخالفة</label>
                            <input type="text" id="newViolationLabel" placeholder="مثلاً: عدم تحضير" class="w-full text-sm p-2 rounded border border-slate-300 focus:border-[rgb(var(--color-primary-500))] outline-none bg-[rgb(var(--color-surface-base))] text-[rgb(var(--color-text-base))]">
                        </div>
                        <div class="w-24 space-y-1">
                            <label class="text-[10px] font-bold text-[rgb(var(--color-text-muted))]">الخصم</label>
                            <input type="number" id="newViolationPoints" value="5" class="w-full text-sm p-2 rounded border border-slate-300 focus:border-[rgb(var(--color-primary-500))] outline-none text-center bg-[rgb(var(--color-surface-base))] text-[rgb(var(--color-text-base))]">
                        </div>
                        <button type="button" onclick="window.app.addViolation()" class="bg-[rgb(var(--color-primary-600))] hover:bg-[rgb(var(--color-primary-700))] text-white p-2 rounded h-[38px] w-10 flex items-center justify-center transition cursor-pointer"><i class="fas fa-plus"></i></button>
                    </div>
                    <!-- List -->
                    <div id="violationsList" class="space-y-2"></div>
                </div>

                <!-- Imports -->
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-[rgb(var(--color-primary-50))] p-4 rounded-xl border border-[rgb(var(--color-primary-100))]">
                        <h4 class="font-bold text-[rgb(var(--color-primary-900))] mb-2 flex items-center gap-2 text-sm"><i class="fas fa-calendar-alt"></i> جدول الحصص (XML)</h4>
                        <button type="button" onclick="document.getElementById('xmlInput').click()" class="w-full bg-[rgb(var(--color-surface-base))] hover:bg-[rgb(var(--color-primary-100))] text-[rgb(var(--color-primary-700))] border border-[rgb(var(--color-primary-200))] py-2 rounded-lg font-bold text-xs transition cursor-pointer">رفع ملف XML</button>
                        <input type="file" id="xmlInput" accept=".xml" class="hidden" onchange="window.app.handleXml(event)">
                    </div>
                    <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                        <h4 class="font-bold text-emerald-900 mb-2 flex items-center gap-2 text-sm"><i class="fas fa-users"></i> بيانات المعلمين (Excel)</h4>
                        <div class="flex gap-2">
                            <button type="button" onclick="window.app.exportTeacherTemplate()" class="flex-1 bg-white border border-emerald-200 text-emerald-700 hover:bg-emerald-100 py-2 rounded-lg font-bold text-xs transition cursor-pointer"><i class="fas fa-download"></i> تصدير</button>
                            <button type="button" onclick="document.getElementById('excelInput').click()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg font-bold text-xs transition cursor-pointer"><i class="fas fa-upload"></i> استيراد</button>
                        </div>
                        <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden" onchange="window.app.handleExcel(event)">
                    </div>
                    
                    <!-- Criteria Import -->
                    <div class="bg-purple-50 p-4 rounded-xl border border-purple-100 md:col-span-2">
                        <h4 class="font-bold text-purple-900 mb-2 flex items-center gap-2 text-sm"><i class="fas fa-clipboard-list"></i> معايير التقييم (JSON)</h4>
                        <button type="button" onclick="document.getElementById('jsonInput').click()" class="w-full bg-white hover:bg-purple-100 text-purple-700 border border-purple-200 py-2 rounded-lg font-bold text-xs transition cursor-pointer">رفع ملف معايير الزيارات (JSON)</button>
                        <input type="file" id="jsonInput" accept=".json" class="hidden" onchange="window.app.handleCriteriaJson(event)">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <!-- App Logic -->
    <script>
        class SchoolApp {
            constructor() {
                this.state = {
                    currentUser: null,
                    teachers: [],
                    periods: [],
                    classes: {},
                    tasks: [], 
                    agenda: [], 
                    violationTypes: [
                        { id: 'late', label: 'تأخر عن الحصة', points: 5, icon: 'fa-clock' },
                        { id: 'absent', label: 'غياب عن الحصة', points: 15, icon: 'fa-user-slash' }
                    ],
                    simulationOffset: 0,
                    selectedTeacherId: null,
                    selectedClassName: null,
                    supervisionData: { ratings: {}, notes: {} },
                    supervisionHistory: [],
                    evaluationCriteria: [],
                    theme: 'default',
                    apiKey: localStorage.getItem('school_ai_key') || 'AIzaSyBUjKjCSH2bvqIn5oEqzE6-tjE1GgqGTtc',
                    cloudStatus: 'offline', 
                    unsubscribe: null,
                    aiReportData: null // Store generated AI data
                };
                this.db = null;
                this.auth = null;
                
                this.initDefaultCriteria();
                this.initFirebaseAndAuth();
                this.startClock();
            }

            // ... (Previous Init/Reset methods remain same) ...
            resetState() {
                this.state.teachers = [];
                this.state.periods = [];
                this.state.classes = {};
                this.state.tasks = [];
                this.state.agenda = [];
                this.state.violationTypes = [
                    { id: 'late', label: 'تأخر عن الحصة', points: 5, icon: 'fa-clock' },
                    { id: 'absent', label: 'غياب عن الحصة', points: 15, icon: 'fa-user-slash' }
                ];
                this.state.supervisionHistory = [];
                this.state.theme = 'default';
                this.renderAll();
                this.applyTheme();
            }

            initFirebaseAndAuth() {
                const firebaseConfig = {
                    apiKey: "AIzaSyC4NddjijF29YNhowy4SqgRaMPn01oSSEg",
                    authDomain: "school-9416e.firebaseapp.com",
                    projectId: "school-9416e",
                    storageBucket: "school-9416e.firebasestorage.app",
                    messagingSenderId: "680872052240",
                    appId: "1:680872052240:web:96d2e544166ab5f8096c95",
                    measurementId: "G-5EBTV0MV83"
                };
                try {
                    if (typeof firebase !== 'undefined' && !firebase.apps.length) firebase.initializeApp(firebaseConfig);
                    if (typeof firebase !== 'undefined') {
                        this.db = firebase.firestore();
                        this.auth = firebase.auth();
                        this.auth.onAuthStateChanged(user => {
                            if (user) {
                                this.state.currentUser = { uid: user.uid, name: user.displayName, photoURL: user.photoURL };
                                document.getElementById('login-view').classList.add('hidden-view');
                                document.getElementById('app-view').classList.remove('hidden-view');
                                this.renderUserProfile();
                                this.loadUserData();
                            } else {
                                this.state.currentUser = null;
                                if(this.state.unsubscribe) this.state.unsubscribe();
                                this.resetState();
                                document.getElementById('login-view').classList.remove('hidden-view');
                                document.getElementById('app-view').classList.add('hidden-view');
                            }
                        });
                    }
                } catch (e) { console.error("Firebase Init Error:", e); }
            }

            handleGoogleLogin() {
                const provider = new firebase.auth.GoogleAuthProvider();
                this.auth.signInWithPopup(provider).catch(e => alert("فشل تسجيل الدخول"));
            }
            handleLogout() { if(confirm('تسجيل الخروج؟')) this.auth.signOut(); }

            loadUserData() {
                if (!this.state.currentUser) return;
                if (this.state.unsubscribe) this.state.unsubscribe();
                this.updateCloudStatus('connecting');
                this.state.unsubscribe = this.db.collection("users").doc(this.state.currentUser.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        this.state.teachers = data.teachers || [];
                        this.state.periods = data.periods || [];
                        this.state.classes = data.classes || {};
                        this.state.tasks = data.tasks || [];
                        this.state.agenda = data.agenda || [];
                        if (data.violationTypes) this.state.violationTypes = data.violationTypes;
                        if (data.supervisionHistory) this.state.supervisionHistory = data.supervisionHistory;
                        if (data.evaluationCriteria) this.state.evaluationCriteria = data.evaluationCriteria;
                        if (data.theme) this.state.theme = data.theme;
                        this.applyTheme();
                        this.renderAll();
                        this.updateCloudStatus('connected');
                    } else { this.updateCloudStatus('connected'); this.renderAll(); }
                }, e => this.updateCloudStatus('error'));
            }

            async saveData() {
                if (!this.state.currentUser) return;
                this.updateCloudStatus('saving');
                try {
                    await this.db.collection("users").doc(this.state.currentUser.uid).set({
                        teachers: this.state.teachers,
                        periods: this.state.periods,
                        classes: this.state.classes,
                        tasks: this.state.tasks,
                        agenda: this.state.agenda,
                        violationTypes: this.state.violationTypes,
                        supervisionHistory: this.state.supervisionHistory,
                        evaluationCriteria: this.state.evaluationCriteria,
                        theme: this.state.theme,
                        lastSync: new Date(),
                        userName: this.state.currentUser.name 
                    }, { merge: true });
                } catch (e) { this.updateCloudStatus('error'); }
            }

            // ... (Default Criteria - Same as before) ...
            initDefaultCriteria() {
                this.state.evaluationCriteria = [
                    { id: 1, title: "التحصيل الدراسي", items: { 1: { desc: "اكتسب جميع الطلبة...", rec: "" }, 2: {desc:"يكتسب معظم...", rec:""}, 3:{desc:"يكتسب أغلب...", rec:""}, 4:{desc:"اكتسب قلة...", rec:""}, 5:{desc:"يكتسب نادر...", rec:""} }},
                    { id: 2, title: "التقدم الدراسي", items: { 1: { desc: "يتقدم جميع الطلبة...", rec: "" }, 2: {desc:"يتقدم معظم...", rec:""}, 3:{desc:"يتقدم أغلب...", rec:""}, 4:{desc:"اكتسب بعض...", rec:""}, 5:{desc:"يتقدم نادر...", rec:""} }},
                    { id: 3, title: "مهارات التعلم", items: { 1: { desc: "يطبق جميع الطلبة...", rec: "" }, 2: {desc:"يطبق معظم...", rec:""}, 3:{desc:"يطبق أغلب...", rec:""}, 4:{desc:"اكتسب بعض...", rec:""}, 5:{desc:"يطبق نادر...", rec:""} }},
                    { id: 4, title: "القيم والسلوك", items: { 1: { desc: "يدرك جميع الطلبة...", rec: "" }, 2: {desc:"يلتزم معظم...", rec:""}, 3:{desc:"يلتزم أغلب...", rec:""}, 4:{desc:"يدرك بعض...", rec:""}, 5:{desc:"يلتزم محدود...", rec:""} }},
                    { id: 5, title: "جودة بيئة التعلم", items: { 1: { desc: "يتابع جميع جوانب...", rec: "" }, 2: {desc:"يتابع المعلم...", rec:""}, 3:{desc:"يتابع المعلم...", rec:""}, 4:{desc:"يتابع بعض...", rec:""}, 5:{desc:"يتابع نادر...", rec:""} }},
                    { id: 6, title: "تخطيط المنهاج الدراسي", items: { 1: { desc: "يخطط لجميع...", rec: "" }, 2: {desc:"يخطط معظم...", rec:""}, 3:{desc:"يخطط أغلب...", rec:""}, 4:{desc:"يخطط لبعض...", rec:""}, 5:{desc:"يخطط نادر...", rec:""} }},
                    { id: 7, title: "إدارة الصف", items: { 1: { desc: "يقوم بإدارة...", rec: "" }, 2: {desc:"يقوم المعلم...", rec:""}, 3:{desc:"يقوم المعلم...", rec:""}, 4:{desc:"يقوم بإدارة...", rec:""}, 5:{desc:"يقوم المعلم...", rec:""} }},
                    { id: 8, title: "فاعلية التدريس", items: { 1: { desc: "يوظف استراتيجيات...", rec: "" }, 2: {desc:"يوظف المعلم...", rec:""}, 3:{desc:"يوظف المعلم...", rec:""}, 4:{desc:"يوظف استراتيجيات...", rec:""}, 5:{desc:"يوظف المعلم...", rec:""} }},
                    { id: 9, title: "تفعيل المصادر والموارد", items: { 1: { desc: "يفعل المعلم...", rec: "" }, 2: {desc:"يفعل المعلم...", rec:""}, 3:{desc:"يفعل المعلم...", rec:""}, 4:{desc:"يفعل المعلم...", rec:""}, 5:{desc:"يفعل المعلم...", rec:""} }},
                    { id: 10, title: "التقويم ومساندة التقدم", items: { 1: { desc: "يوظف أساليب...", rec: "" }, 2: {desc:"يوظف المعلم...", rec:""}, 3:{desc:"يوظف المعلم...", rec:""}, 4:{desc:"يوظف المعلم...", rec:""}, 5:{desc:"يوظف المعلم...", rec:""} }},
                    { id: 11, title: "قيادة التغيير", items: { 1: { desc: "يُجري تقويماً...", rec: "" }, 2: {desc:"يُجري المعلم...", rec:""}, 3:{desc:"يُجري المعلم...", rec:""}, 4:{desc:"يُجري تقويماً...", rec:""}, 5:{desc:"يُجري المعلم...", rec:""} }},
                    { id: 12, title: "الحوكمة", items: { 1: { desc: "يطبق السياسات...", rec: "" }, 2: {desc:"يطبق السياسات...", rec:""}, 3:{desc:"يطبق السياسات...", rec:""}, 4:{desc:"يطبق السياسات...", rec:""}, 5:{desc:"يطبق السياسات...", rec:""} }},
                    { id: 13, title: "المبادرات والأنشطة", items: { 1: { desc: "يقدم مبادرات...", rec: "" }, 2: {desc:"يقدم مبادرات...", rec:""}, 3:{desc:"يقدم مبادرات...", rec:""}, 4:{desc:"يقدم مبادرات...", rec:""}, 5:{desc:"نادراً ما يقدم...", rec:""} }}
                ];
            }

            // ... (Helper Methods) ...
            getUniqueSpecializations() {
                const specs = new Set();
                this.state.teachers.forEach(t => {
                    if (t.specialization) specs.add(t.specialization);
                });
                return Array.from(specs).sort();
            }

            startSupervision(teacherId, className) {
                const t = this.state.teachers.find(x => x.id === teacherId);
                if(!t) return;
                document.getElementById('supTeacherName').value = t.name;
                document.getElementById('supClassName').value = className;
                document.getElementById('supLessonTopic').value = '';
                
                // Populate Specialization Dropdown
                const specSelect = document.getElementById('supSpecialization');
                specSelect.innerHTML = '<option value="">اختر التخصص...</option>';
                const specs = this.getUniqueSpecializations();
                specs.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.text = s;
                    specSelect.add(opt);
                });
                if (t.specialization) specSelect.value = t.specialization;

                this.state.supervisionData = { ratings: {}, notes: {} };
                const list = document.getElementById('supervisionCriteriaList');
                // ... (Criteria rendering remains same) ...
                list.innerHTML = this.state.evaluationCriteria.map((criterion, index) => `
                    <div class="bg-[rgb(var(--color-bg-base))] p-4 rounded-xl border border-[rgb(var(--color-border-muted))]">
                        <h3 class="font-bold text-[rgb(var(--color-text-base))] text-base mb-4 border-b border-[rgb(var(--color-border-muted))] pb-2 flex items-center gap-2">
                            <span class="bg-[rgb(var(--color-primary-600))] text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">${index + 1}</span>
                            ${criterion.title}
                        </h3>
                        <div class="space-y-3">
                            ${[1,2,3,4,5].map(rating => {
                                const desc = criterion.items[rating] ? criterion.items[rating].desc : '';
                                return `
                                <label class="relative flex items-start gap-3 p-3 border border-[rgb(var(--color-border-muted))] rounded-lg cursor-pointer bg-[rgb(var(--color-surface-base))] hover:bg-[rgb(var(--color-bg-base))] transition-colors group">
                                    <input type="radio" name="criteria_${criterion.id}" value="${rating}" 
                                        onchange="window.app.setRating(${criterion.id}, ${rating})" class="sup-radio peer mt-1 accent-[rgb(var(--color-primary-600))]">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="font-bold text-[rgb(var(--color-primary-700))] bg-[rgb(var(--color-primary-50))] px-2 rounded text-xs">مستوى ${rating}</span>
                                        </div>
                                        <p class="text-xs text-[rgb(var(--color-text-muted))] leading-relaxed">${desc}</p>
                                    </div>
                                    <div class="check-icon hidden text-[rgb(var(--color-primary-600))] absolute top-3 left-3">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </label>
                                `;
                            }).join('')}
                        </div>
                        <div class="mt-3">
                             <input type="text" onchange="window.app.setNote(${criterion.id}, this.value)" placeholder="اكتب ملاحظة محددة حول هذا البند (اختياري)..." class="w-full text-xs p-2 rounded-lg border border-[rgb(var(--color-border-muted))] bg-[rgb(var(--color-surface-base))] focus:border-[rgb(var(--color-primary-500))] focus:bg-white outline-none transition">
                        </div>
                    </div>
                `).join('');
                this.setView('supervision');
            }

            setRating(criteriaId, rating) { this.state.supervisionData.ratings[criteriaId] = rating; }
            setNote(criteriaId, text) { if(!this.state.supervisionData.notes) this.state.supervisionData.notes = {}; this.state.supervisionData.notes[criteriaId] = text; }

            generateReport(isLoad = false, existingData = null) {
                const ratings = existingData ? existingData.ratings : this.state.supervisionData.ratings;
                const notes = existingData ? (existingData.notes || {}) : (this.state.supervisionData.notes || {});
                
                if(!isLoad && Object.keys(ratings).length < this.state.evaluationCriteria.length) {
                    alert('يرجى استكمال تقييم جميع البنود');
                    return;
                }
                const tName = isLoad ? existingData.teacherName : document.getElementById('supTeacherName').value;
                const spec = isLoad ? existingData.specialization : document.getElementById('supSpecialization').value;
                const cName = isLoad ? existingData.className : document.getElementById('supClassName').value;
                const lTopic = isLoad ? existingData.topic : document.getElementById('supLessonTopic').value || '-';
                const rDate = isLoad ? existingData.date : new Date().toLocaleDateString('ar-EG');
                
                document.getElementById('repTeacherName').innerText = tName;
                document.getElementById('repSpecialization').innerText = spec || 'عام';
                document.getElementById('repClassName').innerText = cName;
                document.getElementById('repLessonTopic').innerText = lTopic;
                document.getElementById('reportDate').innerText = rDate;
                
                const analysis = [];
                const detailsBody = document.getElementById('repDetailsBody');
                detailsBody.innerHTML = ''; 

                this.state.evaluationCriteria.forEach(c => {
                    const r = ratings[c.id];
                    const noteText = notes[c.id] || '-';
                    // Push to analysis array for sorting
                    analysis.push({
                        id: c.id, 
                        title: c.title, 
                        rating: r, 
                        desc: c.items[r].desc, 
                        note: notes[c.id] || ''
                    });
                    
                    // Populate Table
                    let ratingBadge = r === 1 ? 'text-emerald-700 bg-emerald-100' : (r === 2 ? 'text-green-600 bg-green-50' : (r === 3 ? 'text-yellow-600 bg-yellow-50' : (r === 4 ? 'text-orange-600 bg-orange-50' : 'text-red-600 bg-red-50')));
                    detailsBody.innerHTML += `
                        <tr class="hover:bg-[rgb(var(--color-bg-base))] transition-colors">
                            <td class="p-3 border-b border-[rgb(var(--color-border-muted))] font-bold text-[rgb(var(--color-text-base))]">${c.title}</td>
                            <td class="p-3 border-b border-[rgb(var(--color-border-muted))] text-center"><span class="font-bold px-2 py-1 rounded text-xs border border-transparent ${ratingBadge}">${r}/5</span></td>
                            <td class="p-3 border-b border-[rgb(var(--color-border-muted))] text-[rgb(var(--color-text-muted))] italic">${noteText}</td>
                        </tr>
                    `;
                });
                
                // Logic: Best 4 (Lowest Rating number = Best)
                const strengths = [...analysis].sort((a,b) => a.rating - b.rating).slice(0, 4);
                
                // Logic: Worst 4 (Highest Rating number = Worst). Filter so we don't show excellent items as bad if everything is excellent.
                // If rating is 1 or 2, consider it good. We want items > 2. If all are good, show none or "Needs improvement" logic.
                const improvements = [...analysis].filter(a => a.rating > 1).sort((a,b) => b.rating - a.rating).slice(0, 4);

                // Initial Static Render (Before AI)
                document.getElementById('repStrengths').innerHTML = strengths.map(s => `<li><span class="font-bold text-emerald-700">${s.title}:</span> ${s.desc}</li>`).join('');
                document.getElementById('repImprovements').innerHTML = improvements.length > 0 ? improvements.map(s => `<li><span class="font-bold text-orange-700">${s.title}:</span> ${s.desc}</li>`).join('') : '<li>لا توجد نقاط ضعف ملحوظة.</li>';
                document.getElementById('repRecommendations').innerHTML = improvements.length > 0 ? improvements.map(s => `<li>تحسين مستوى ${s.title} من خلال اتباع استراتيجيات حديثة.</li>`).join('') : '<li>الاستمرار في الأداء المتميز.</li>';

                // Check for saved AI data
                if(isLoad && existingData.aiReportContent) {
                    document.getElementById('aiReportContent').innerHTML = existingData.aiReportContent;
                }

                this.setView('supervision-report');
            }

            saveVisit() {
                const visitData = {
                    id: Date.now().toString(),
                    teacherName: document.getElementById('repTeacherName').innerText,
                    specialization: document.getElementById('repSpecialization').innerText,
                    className: document.getElementById('repClassName').innerText,
                    topic: document.getElementById('repLessonTopic').innerText,
                    date: document.getElementById('reportDate').innerText,
                    ratings: {...this.state.supervisionData.ratings},
                    notes: {...this.state.supervisionData.notes},
                    aiReportContent: document.getElementById('aiReportContent').innerHTML // Save the AI HTML
                };
                if(!this.state.supervisionHistory) this.state.supervisionHistory = [];
                this.state.supervisionHistory.push(visitData);
                this.saveData();
                alert('تم حفظ الزيارة في السجل بنجاح');
            }

            async enhanceReportWithAI() {
                const topic = document.getElementById('repLessonTopic').innerText;
                const specialization = document.getElementById('repSpecialization').innerText;
                const apiKey = this.state.apiKey;
                
                if (!apiKey) return alert('خطأ: لم يتم العثور على مفتاح API.');
                if(!topic || topic === '-') return alert('يرجى تحديد عنوان الدرس.');

                // Build detailed prompt context
                const analysisItems = [];
                this.state.evaluationCriteria.forEach(c => {
                    analysisItems.push({
                        title: c.title,
                        rating: this.state.supervisionData.ratings[c.id],
                        note: this.state.supervisionData.notes[c.id] || ''
                    });
                });

                // Top 4 & Bottom 4 logic for prompt
                const top4 = [...analysisItems].sort((a,b) => a.rating - b.rating).slice(0, 4);
                const bottom4 = [...analysisItems].sort((a,b) => b.rating - a.rating).slice(0, 4);

                document.getElementById('aiLoadingOverlay').classList.remove('hidden-view');
                
                try {
                    if (typeof window.GoogleGenAI === 'undefined') throw new Error("SDK error");
                    const ai = new window.GoogleGenAI({ apiKey: apiKey });
                    const response = await ai.models.generateContent({
                        model: 'gemini-2.5-flash',
                        config: { 
                            systemInstruction: "أنت خبير تربوي وموجه فني أول متخصص. مهمتك صياغة تقرير زيارة صفية احترافي وشامل بناءً على البيانات المقدمة."
                        },
                        contents: `
                        المعلم: تخصص (${specialization})
                        عنوان الدرس: ${topic}
                        
                        بيانات التقييم (من 1 ممتاز إلى 5 ضعيف):
                        ${JSON.stringify(analysisItems)}

                        المطلوب: قم بصياغة تقرير HTML (فقط div و ul و p) يحتوي على الأقسام التالية بدقة لغوية عالية وموجهة للتخصص:
                        1. فقرة "وصف الأداء العام": تصف سير الحصة بشكل سردي مهني.
                        2. قائمة "أبرز جوانب الإجادة": أعد صياغة أفضل 4 نقاط (${JSON.stringify(top4)}) لتكون عبارات وصفية قوية ومحددة للتخصص.
                        3. قائمة "نقاط تحتاج إلى تحسين": أعد صياغة أقل 4 نقاط (${JSON.stringify(bottom4)}) بلغة تربوية بناءة.
                        4. قائمة "التوصيات الفنية": قدم حلولاً عملية وعلمية دقيقة لنقاط التحسين المذكورة، مع ربطها بمادة ${specialization}.

                        تنسيق المخرجات المطلوب (HTML):
                        <div class="ai-report-section">
                            <h4><i class="fas fa-info-circle text-blue-500"></i> وصف الأداء العام</h4>
                            <p>...النص هنا...</p>
                        </div>
                        <div class="ai-report-section">
                            <h4><i class="fas fa-star text-emerald-500"></i> أبرز جوانب الإجادة</h4>
                            <ul><li>...</li></ul>
                        </div>
                        <div class="ai-report-section">
                            <h4><i class="fas fa-chart-line text-orange-500"></i> نقاط تحتاج إلى تحسين</h4>
                            <ul><li>...</li></ul>
                        </div>
                        <div class="ai-report-section bg-[rgb(var(--color-primary-50))]/50 p-4 rounded-xl border border-[rgb(var(--color-primary-100))]">
                            <h4><i class="fas fa-lightbulb text-yellow-500"></i> التوصيات والمقترحات الفنية</h4>
                            <ul class="list-decimal pr-5"><li>...</li></ul>
                        </div>
                        `
                    });
                    
                    const text = response.text;
                    if (!text) throw new Error("Empty AI response");
                    
                    // Clean markdown code blocks if present
                    const cleanHtml = text.replace(/```html/g, '').replace(/```/g, '');
                    document.getElementById('aiReportContent').innerHTML = cleanHtml;

                } catch (error) {
                    console.error(error);
                    alert("تعذر الاتصال بالذكاء الاصطناعي. " + error.message);
                } finally {
                    document.getElementById('aiLoadingOverlay').classList.add('hidden-view');
                }
            }

            // ... (Rest of the class methods: handleCriteriaJson, openSettings, etc. remain unchanged) ...
            handleCriteriaJson(e) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const json = JSON.parse(evt.target.result);
                        if (Array.isArray(json) && json[0]?.items) {
                            this.state.evaluationCriteria = json;
                            this.saveData();
                            alert('تم التحديث بنجاح!');
                            this.closeModal('modal-settings');
                        } else alert('الملف غير صالح');
                    } catch(err) { console.error(err); alert('خطأ JSON'); }
                };
                reader.readAsText(e.target.files[0]);
            }
            openSettings() { this.renderViolationsSettings(); this.renderThemeSelector(); document.getElementById('modal-settings').classList.remove('hidden-view'); }
            renderViolationsSettings() {
                const list = document.getElementById('violationsList');
                if(!list) return;
                list.innerHTML = this.state.violationTypes.map(v => `
                    <div class="flex items-center justify-between bg-[rgb(var(--color-surface-base))] p-3 rounded-lg border border-[rgb(var(--color-border-base))] shadow-sm group hover:border-red-100 transition">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded bg-[rgb(var(--color-bg-base))] text-[rgb(var(--color-text-muted))] flex items-center justify-center"><i class="fas ${v.icon}"></i></div>
                            <span class="font-bold text-sm text-[rgb(var(--color-text-base))]">${v.label}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="bg-red-50 text-red-600 text-xs font-bold px-2 py-1 rounded border border-red-100">-${v.points}</span>
                            <button type="button" onclick="window.app.removeViolation('${v.id}')" class="text-slate-300 hover:text-red-500 transition px-2 cursor-pointer"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                `).join('');
            }
            addViolation() {
                const label = document.getElementById('newViolationLabel').value;
                const points = parseInt(document.getElementById('newViolationPoints').value);
                if(label && points) { this.state.violationTypes.push({ id: Date.now().toString(), label, points, icon: 'fa-exclamation-circle' }); document.getElementById('newViolationLabel').value=''; this.saveData(); }
            }
            removeViolation(id) { this.state.violationTypes = this.state.violationTypes.filter(v => v.id !== id); this.saveData(); }
            setTheme(themeName) { this.state.theme = themeName; this.applyTheme(); this.saveData(); this.renderThemeSelector(); }
            applyTheme() { document.body.classList.remove('theme-pink', 'theme-green', 'theme-dark'); if (this.state.theme && this.state.theme !== 'default') document.body.classList.add(`theme-${this.state.theme}`); }
            renderThemeSelector() {
                const container = document.getElementById('themeSelectorContainer');
                if (!container) return;
                const themes = [{ id: 'default', name: 'أساسي', colorClass: 'bg-indigo-600', activeClass: 'border-indigo-500' }, { id: 'pink', name: 'زهري', colorClass: 'bg-pink-600', activeClass: 'border-pink-500' }, { id: 'green', name: 'أخضر', colorClass: 'bg-green-600', activeClass: 'border-green-500' }, { id: 'dark', name: 'داكن', colorClass: 'bg-slate-800 border border-slate-600', activeClass: 'border-slate-300' }];
                container.innerHTML = themes.map(theme => {
                    const isActive = this.state.theme === theme.id;
                    const borderClass = isActive ? theme.activeClass : 'border-transparent';
                    return `<button onclick="window.app.setTheme('${theme.id}')" class="p-2 rounded-lg border-2 transition ${borderClass}"><div class="w-full h-10 rounded ${theme.colorClass}"></div><span class="text-xs font-bold mt-2 block text-center text-[rgb(var(--color-text-muted))]">${theme.name}</span></button>`;
                }).join('');
            }
            // ... (Other existing methods: sendWhatsApp, openWhatsApp, dockScore, handleXml, exportTeacherTemplate, handleExcel, exportReports, renderAll, renderCurrentPeriod, renderActiveClasses, renderTeachers, renderAgenda, verifyAdminAndImportAgenda, handleAgendaExcel, renderReports, addTask, toggleTask, deleteTask, renderTasks, renderHistory, updatePhone, openActionModal, closeModal, loadVisit, deleteVisit - All retained) ...
            
            // Re-declaring key navigation/utility methods to ensure scope integrity in this compressed view
            renderAll() {
                const activeBtn = document.querySelector('.nav-btn.text-\\[rgb\\(var\\(--color-primary-700\\)\\)\\]');
                let currentView = activeBtn ? activeBtn.id.replace('btn-', '') : 'now';
                if(currentView === 'now') this.renderCurrentPeriod(new Date(new Date().getTime() + this.state.simulationOffset));
                else if (currentView === 'teachers') this.renderTeachers();
                else if (currentView === 'reports') this.renderReports();
                else if (currentView === 'tasks') this.renderTasks();
                else if (currentView === 'agenda') this.renderAgenda();
            }
            renderCurrentPeriod(now) {
                const mins = now.getHours() * 60 + now.getMinutes();
                const currentPeriod = this.state.periods.find(p => { const [sh, sm] = p.start.split(':').map(Number); const [eh, em] = p.end.split(':').map(Number); return mins >= (sh*60+sm) && mins <= (eh*60+em); });
                const infoDiv = document.getElementById('currentPeriodInfo');
                if(infoDiv) infoDiv.innerHTML = currentPeriod ? `<div class="flex items-center gap-3 bg-[rgb(var(--color-primary-50))] px-4 py-2 rounded-lg border border-[rgb(var(--color-primary-100))] shadow-sm"><span class="text-[rgb(var(--color-primary-900))] font-bold">الحصة ${currentPeriod.id}</span><span class="text-[rgb(var(--color-primary-300))]">|</span><span class="text-[rgb(var(--color-primary-600))] font-mono text-sm">${currentPeriod.start} - ${currentPeriod.end}</span></div>` : `<div class="bg-amber-50 text-amber-700 px-4 py-2 rounded-lg border border-amber-100 font-bold text-sm">لا توجد حصص نشطة</div>`;
                this.renderActiveClasses(now, currentPeriod);
            }
            renderActiveClasses(now, period) {
                const grid = document.getElementById('activeClassesGrid');
                if(!grid) return;
                if(!period) { grid.innerHTML = `<div class="col-span-full py-16 text-center text-slate-400 bg-[rgb(var(--color-bg-base))] rounded-xl border-2 border-dashed border-[rgb(var(--color-border-muted))]"><i class="fas fa-coffee text-3xl mb-3 text-slate-300"></i><p class="text-sm">لا توجد حصص في الوقت الحالي</p></div>`; return; }
                const dayId = now.getDay() + 1;
                const pId = parseInt(period.id);
                let active = [];
                this.state.teachers.forEach(t => { const l = t.lessons.find(ls => ls.day === dayId && ls.period === pId); if(l) active.push({ t, className: l.className }); });
                active.sort((a, b) => { const gA = (a.className.match(/\d+/) || [999])[0], gB = (b.className.match(/\d+/) || [999])[0]; return parseInt(gA) - parseInt(gB); });
                grid.innerHTML = active.map(item => `<div class="group bg-[rgb(var(--color-surface-base))] rounded-lg shadow-sm hover:shadow-md transition-all duration-300 border border-[rgb(var(--color-border-muted))] overflow-hidden relative flex flex-col"><div class="h-1 w-full bg-[rgb(var(--color-primary-500))]"></div><div class="p-2 flex-1 flex flex-col"><div class="flex justify-between items-center mb-1"><span class="bg-[rgb(var(--color-bg-base))] text-[rgb(var(--color-text-base))] px-2 py-0.5 rounded text-xs font-bold border border-[rgb(var(--color-border-muted))] truncate max-w-[70%]">${item.className}</span><div class="w-5 h-5 rounded-full bg-[rgb(var(--color-primary-50))] text-[rgb(var(--color-primary-600))] flex items-center justify-center text-[9px] font-bold border border-[rgb(var(--color-primary-100))]">${item.t.short[0] || '?'}</div></div><h3 class="font-bold text-xs text-[rgb(var(--color-text-base))] mb-1 truncate">${item.t.name}</h3><div class="flex items-center gap-1 text-[9px] text-slate-400 mb-2"><i class="fas fa-star text-yellow-400"></i> <span>${item.t.score}%</span></div><button type="button" onclick="window.app.openActionModal('${item.t.id}', '${item.className}')" class="mt-auto w-full py-1 rounded bg-[rgb(var(--color-primary-50))] hover:bg-[rgb(var(--color-primary-100))] text-[rgb(var(--color-primary-700))] font-bold text-[10px] transition-colors flex justify-center items-center gap-1 cursor-pointer"><i class="fas fa-cog"></i> إجراء</button></div></div>`).join('');
            }
            renderTeachers() {
                const term = document.getElementById('teacherSearch').value.toLowerCase();
                const grid = document.getElementById('teachersGrid');
                if(!grid) return;
                let filtered = this.state.teachers.filter(t => t.name.toLowerCase().includes(term));
                filtered.sort((a,b) => a.name.localeCompare(b.name, 'ar'));
                grid.innerHTML = filtered.map(t => {
                    let scoreColor = t.score >= 90 ? "bg-emerald-50 text-emerald-600 border-emerald-100" : (t.score >= 70 ? "bg-yellow-50 text-yellow-600 border-yellow-100" : "bg-red-50 text-red-600 border-red-100");
                    return `<div class="bg-[rgb(var(--color-surface-base))] rounded-xl shadow-sm hover:shadow-md transition border border-[rgb(var(--color-border-base))] p-5 flex flex-col gap-4"><div class="flex justify-between items-start"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-gradient-to-br from-[rgb(var(--color-primary-500))] to-purple-600 text-white flex items-center justify-center font-bold shadow-sm">${t.short[0] || '?'}</div><div><h3 class="font-bold text-[rgb(var(--color-text-base))] line-clamp-1">${t.name}</h3><p class="text-xs text-[rgb(var(--color-primary-600))] mt-0.5 font-bold">${t.specialization || 'معلم مادة'}</p><span class="text-[10px] text-[rgb(var(--color-text-muted))]">${t.short}</span></div></div><div class="font-bold text-sm px-2 py-1 rounded-md border ${scoreColor}">${t.score}%</div></div><div class="relative group/input"><i class="fas fa-phone absolute right-3 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within/input:text-[rgb(var(--color-primary-500))] transition-colors"></i><input type="tel" value="${t.phone || ''}" onchange="window.app.updatePhone('${t.id}', this.value)" placeholder="أضف رقم الهاتف" class="w-full pr-9 pl-3 py-2 text-sm rounded-lg border border-[rgb(var(--color-border-muted))] bg-[rgb(var(--color-bg-base))] focus:bg-[rgb(var(--color-surface-base))] focus:border-[rgb(var(--color-primary-500))] focus:ring-1 focus:ring-[rgb(var(--color-primary-500))] outline-none transition-all dir-rtl"></div><div class="flex gap-2 mt-auto pt-2 border-t border-[rgb(var(--color-border-base))]"><button type="button" onclick="window.app.openActionModal('${t.id}')" class="flex-1 bg-[rgb(var(--color-surface-base))] hover:bg-[rgb(var(--color-bg-base))] text-[rgb(var(--color-text-muted))] border border-[rgb(var(--color-border-muted))] py-2 rounded-lg text-xs font-bold transition cursor-pointer">خيارات</button><button type="button" onclick="window.app.openWhatsApp('${t.id}')" class="w-10 flex items-center justify-center bg-green-50 hover:bg-green-100 text-green-600 border border-green-200 rounded-lg transition cursor-pointer"><i class="fab fa-whatsapp"></i></button></div></div>`;
                }).join('');
            }
            renderAgenda() {
                const tbody = document.getElementById('agendaBody'); if(!tbody) return;
                const agenda = this.state.agenda || [];
                if(agenda.length === 0) { tbody.innerHTML = `<tr><td colspan="3" class="p-8 text-center text-slate-400 bg-[rgb(var(--color-bg-base))] rounded-lg border-2 border-dashed border-[rgb(var(--color-border-muted))]">لا توجد أحداث مسجلة.</td></tr>`; return; }
                agenda.sort((a,b) => new Date(a.date).getTime() - new Date(b.date).getTime());
                const todayStr = new Date().toISOString().split('T')[0];
                tbody.innerHTML = agenda.map((item, index) => {
                    const itemDateStr = new Date(item.date).toISOString().split('T')[0];
                    const isToday = itemDateStr === todayStr;
                    return `<tr class="${isToday ? 'today-row' : 'hover:bg-[rgb(var(--color-bg-base))]'} transition-colors border-b border-[rgb(var(--color-border-base))] last:border-0"><td class="p-4 text-center font-bold text-[rgb(var(--color-text-muted))]">${index + 1}</td><td class="p-4 font-mono text-sm text-[rgb(var(--color-primary-700))]">${item.date}</td><td class="p-4 font-bold text-[rgb(var(--color-text-base))]">${item.event}</td></tr>`;
                }).join('');
            }
            verifyAdminAndImportAgenda() { if(prompt('PIN:') === '1234') document.getElementById('agendaInput').click(); else alert('خطأ'); }
            handleAgendaExcel(e) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
                    const newAgenda = [];
                    for(let i = 1; i < json.length; i++) {
                        const row = json[i];
                        if(row && row.length >= 3) {
                            let dateVal = row[1];
                            if(typeof dateVal === 'number') dateVal = new Date(Math.round((dateVal - 25569)*86400*1000)).toISOString().split('T')[0];
                            newAgenda.push({ id: Date.now() + i, date: dateVal, event: row[2] });
                        }
                    }
                    if(newAgenda.length > 0) { this.state.agenda = newAgenda; this.saveData(); this.renderAgenda(); alert('تم'); } else alert('تنسيق غير صالح');
                };
                reader.readAsArrayBuffer(e.target.files[0]);
            }
            renderReports() {
                const tbody = document.getElementById('reportsBody'); if(!tbody) return;
                tbody.innerHTML = this.state.teachers.map(t => {
                    let badge = t.score >= 90 ? "bg-green-100 text-green-700" : (t.score >= 70 ? "bg-yellow-100 text-yellow-700" : "bg-red-100 text-red-700");
                    return `<tr class="hover:bg-[rgb(var(--color-bg-base))]/50 transition-colors"><td class="p-5 font-semibold text-[rgb(var(--color-text-base))]"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded bg-[rgb(var(--color-primary-50))] text-[rgb(var(--color-primary-600))] flex items-center justify-center text-xs font-bold">${t.short[0] || '?'}</div>${t.name}</div></td><td class="p-5 text-center"><span class="inline-block px-3 py-1 rounded-full text-xs font-bold ${badge}">${t.score}%</span></td><td class="p-5 text-center text-[rgb(var(--color-text-muted))] font-mono text-sm">${t.phone || '-'}</td><td class="p-5 text-center">${t.score < 80 ? '<span class="text-xs text-red-500 font-bold bg-red-50 px-2 py-1 rounded">يحتاج متابعة</span>' : '<span class="text-xs text-green-500 font-bold bg-green-50 px-2 py-1 rounded">ممتاز</span>'}</td></tr>`;
                }).join('');
            }
            addTask() { const text = document.getElementById('newTaskInput').value.trim(); if(text) { this.state.tasks.unshift({id:Date.now().toString(), text, priority: document.getElementById('newTaskPriority').value, completed:false}); this.saveData(); this.renderTasks(); document.getElementById('newTaskInput').value=''; } }
            toggleTask(id) { const t = this.state.tasks.find(x=>x.id===id); if(t) { t.completed=!t.completed; this.saveData(); this.renderTasks(); } }
            deleteTask(id) { if(confirm('حذف؟')) { this.state.tasks = this.state.tasks.filter(x=>x.id!==id); this.saveData(); this.renderTasks(); } }
            renderTasks() {
                const list = document.getElementById('tasksList'); if(!list) return;
                const completed = this.state.tasks.filter(t=>t.completed).length;
                document.getElementById('tasksProgressBar').style.width = (this.state.tasks.length ? Math.round((completed/this.state.tasks.length)*100) : 0) + '%';
                document.getElementById('tasksProgressText').innerText = `${completed}/${this.state.tasks.length} مكتمل`;
                list.innerHTML = this.state.tasks.length === 0 ? `<div class="text-center p-8 text-slate-400 bg-[rgb(var(--color-bg-base))] rounded-xl border border-dashed border-[rgb(var(--color-border-muted))]"><p class="text-xs">لا توجد مهام.</p></div>` : this.state.tasks.map(t => `<div class="flex items-center gap-3 bg-[rgb(var(--color-surface-base))] p-4 rounded-xl border border-[rgb(var(--color-border-muted))] shadow-sm transition hover:shadow-md group"><label class="relative flex items-center cursor-pointer"><input type="checkbox" class="task-checkbox sr-only peer" ${t.completed?'checked':''} onchange="window.app.toggleTask('${t.id}')"><div class="w-6 h-6 bg-[rgb(var(--color-bg-base))] border-2 border-[rgb(var(--color-border-muted))] rounded-full peer-checked:bg-green-500 peer-checked:border-green-500 transition-all flex items-center justify-center text-white"><i class="fas fa-check text-xs ${t.completed?'opacity-100':'opacity-0'}"></i></div></label><div class="flex-1 ${t.completed?'line-through text-slate-400':'text-[rgb(var(--color-text-base))]'}"><p class="text-sm font-bold">${t.text}</p></div><span class="text-[10px] px-2 py-0.5 rounded border ${t.priority==='urgent'?'bg-red-50 text-red-600 border-red-100':'bg-blue-50 text-blue-600 border-blue-100'} font-bold">${t.priority==='urgent'?'عاجل':'عادي'}</span><button onclick="window.app.deleteTask('${t.id}')" class="text-slate-300 hover:text-red-500 transition px-2 opacity-0 group-hover:opacity-100"><i class="fas fa-trash-alt"></i></button></div>`).join('');
            }
            renderHistory() {
                const grid = document.getElementById('supervisionHistoryGrid'); if(!grid) return;
                const history = this.state.supervisionHistory || [];
                if(history.length === 0) { grid.innerHTML = '<div class="text-center p-10 text-slate-400 bg-[rgb(var(--color-bg-base))] rounded-xl border border-dashed border-[rgb(var(--color-border-muted))]">لا يوجد سجل.</div>'; return; }
                history.sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime());
                grid.innerHTML = history.map((v, i) => `<div class="bg-[rgb(var(--color-surface-base))] p-4 rounded-xl border border-[rgb(var(--color-border-muted))] shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center gap-4 hover:border-[rgb(var(--color-primary-200))] transition"><div class="flex-1"><div class="flex items-center gap-2 mb-1"><span class="font-bold text-[rgb(var(--color-text-base))] text-lg">${v.teacherName}</span><span class="bg-[rgb(var(--color-bg-base))] text-[rgb(var(--color-text-muted))] text-xs px-2 py-0.5 rounded border border-[rgb(var(--color-border-muted))]">${v.className}</span></div><p class="text-sm text-[rgb(var(--color-text-muted))] mb-1"><i class="fas fa-book-open ml-1"></i> ${v.topic}</p><span class="text-xs text-slate-400 font-mono">${v.date}</span></div><div class="flex gap-2 w-full md:w-auto"><button onclick="window.app.loadVisit(${i})" class="flex-1 md:flex-none bg-[rgb(var(--color-primary-50))] text-[rgb(var(--color-primary-700))] hover:bg-[rgb(var(--color-primary-100))] px-4 py-2 rounded-lg font-bold text-xs transition cursor-pointer"><i class="fas fa-eye"></i> عرض</button><button onclick="window.app.deleteVisit(${i})" class="md:flex-none text-red-400 hover:text-red-600 px-3 py-2 rounded-lg transition cursor-pointer"><i class="fas fa-trash"></i></button></div></div>`).join('');
            }
            updatePhone(id, val) { const t = this.state.teachers.find(x => x.id === id); if(t) { t.phone = val; this.saveData(); } }
            openActionModal(tId, className = null) {
                this.state.selectedTeacherId = tId; this.state.selectedClassName = className;
                const t = this.state.teachers.find(x => x.id === tId); if(!t) return;
                document.getElementById('actionModalTitle').innerHTML = `<i class="fas fa-user-edit text-yellow-400"></i> ${t.name}`;
                document.getElementById('actionModalSubtitle').innerText = className && className !== 'undefined' ? `الحصة: ${className}` : 'قائمة الإدارة';
                document.getElementById('currentScoreDisplay').innerText = t.score + '%';
                const remind = document.getElementById('btn-remind'); const evalBtn = document.getElementById('btn-evaluate');
                if(className && className !== 'undefined') { remind.disabled=false; remind.classList.remove('opacity-50','cursor-not-allowed'); evalBtn.onclick=()=>{this.closeModal('modal-action');this.startSupervision(tId,className);}; } 
                else { remind.disabled=true; remind.classList.add('opacity-50','cursor-not-allowed'); evalBtn.onclick=()=>{this.closeModal('modal-action');this.startSupervision(tId,'زيارة عامة');}; }
                document.getElementById('violationButtonsContainer').innerHTML = this.state.violationTypes.map(v => `<button type="button" onclick="window.app.dockScore('${v.id}')" class="w-full bg-[rgb(var(--color-bg-base))] hover:bg-red-50 text-[rgb(var(--color-text-base))] hover:text-red-700 border border-[rgb(var(--color-border-muted))] hover:border-red-200 p-3 rounded-lg flex items-center justify-between transition group cursor-pointer"><span class="flex items-center gap-3 font-bold text-sm"><div class="w-8 h-8 rounded-full bg-[rgb(var(--color-surface-base))] border border-[rgb(var(--color-border-muted))] flex items-center justify-center text-slate-400 group-hover:text-red-500 group-hover:border-red-200 transition"><i class="fas ${v.icon}"></i></div>${v.label}</span><span class="bg-[rgb(var(--color-surface-base))] px-2 py-1 rounded text-xs font-bold text-red-500 border border-[rgb(var(--color-border-muted))] group-hover:border-red-200 shadow-sm">-${v.points}</span></button>`).join('');
                document.getElementById('modal-action').classList.remove('hidden-view');
            }
            closeModal(id) { document.getElementById(id)?.classList.add('hidden-view'); }
            loadVisit(index) { const sorted = [...this.state.supervisionHistory].sort((a,b)=>new Date(b.date).getTime()-new Date(a.date).getTime()); const visit=sorted[index]; if(visit){this.state.supervisionData={ratings:visit.ratings,notes:visit.notes||{}};this.generateReport(true,visit);} }
            deleteVisit(index) { if(confirm('حذف؟')) { const sorted = [...this.state.supervisionHistory].sort((a,b)=>new Date(b.date).getTime()-new Date(a.date).getTime()); const id=sorted[index].id; this.state.supervisionHistory=this.state.supervisionHistory.filter(x=>x.id!==id); this.saveData(); this.renderHistory(); } }
            
            sendWhatsApp(type) {
                const t = this.state.teachers.find(x => x.id === this.state.selectedTeacherId);
                if(!t || !t.phone) return alert('أضف الهاتف أولاً');
                let msg = type === 'summon' ? `السلام عليكم أستاذ ${t.name}، يرجى التكرم بزيارة مكتب الإدارة.` : `السلام عليكم أستاذ ${t.name}، تذكير بموعد حصتكم الحالية في الصف ${this.state.selectedClassName}.`;
                window.open(`https://wa.me/${t.phone}?text=${encodeURIComponent(msg)}`, '_blank');
            }
            openWhatsApp(id) { const t = this.state.teachers.find(x => x.id === id); if(t && t.phone) window.open(`https://wa.me/${t.phone}`, '_blank'); else alert('أضف الهاتف أولاً'); }
            dockScore(vId) { const v = this.state.violationTypes.find(x => x.id === vId); if(v && confirm(`خصم ${v.points}؟`)) { const t = this.state.teachers.find(x => x.id === this.state.selectedTeacherId); if(t) { t.score = Math.max(0, t.score - v.points); this.saveData(); this.closeModal('modal-action'); } } }
            handleXml(e) {
                const reader = new FileReader(); reader.readAsText(e.target.files[0], "windows-1256");
                reader.onload = (evt) => {
                    try {
                        const xml = new DOMParser().parseFromString(evt.target.result, "text/xml");
                        this.state.periods = Array.from(xml.querySelectorAll('periods period')).map(p => ({ id: p.getAttribute('period'), start: p.getAttribute('starttime'), end: p.getAttribute('endtime') }));
                        const classes = {}; xml.querySelectorAll('classes class').forEach(c => classes[c.getAttribute('id')] = c.getAttribute('name')); this.state.classes = classes;
                        this.state.teachers = Array.from(xml.querySelectorAll('teachers teacher')).map(t => ({ id: t.getAttribute('id'), name: t.getAttribute('name'), short: t.getAttribute('short'), score: 100, phone: '', lessons: [] }));
                        xml.querySelectorAll('TimeTableSchedules TimeTableSchedule').forEach(sch => { const t = this.state.teachers.find(x => x.id === sch.getAttribute('TeacherID')); if(t) t.lessons.push({ day: parseInt(sch.getAttribute('DayID')), period: parseInt(sch.getAttribute('Period')), className: classes[sch.getAttribute('ClassID')] || 'نشاط' }); });
                        this.saveData(); this.closeModal('modal-settings'); alert('تم');
                    } catch(err) { alert('خطأ'); }
                };
            }
            exportTeacherTemplate() { const data = this.state.teachers.map(t => ({ 'Teacher_ID': t.id, 'Short_Name': t.short, 'Full_Name': t.name, 'Phone': t.phone, 'Specialization': t.specialization || '' })); const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Teachers_Data"); XLSX.writeFile(wb, "Teachers_Data.xlsx"); }
            handleExcel(e) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    this.state.teachers.forEach(t => { const row = json.find(r => r['Teacher_ID'] == t.id); if(row) { t.name = row['Full_Name'] || t.name; t.phone = row['Phone'] ? String(row['Phone']) : t.phone; if(row['Specialization'] || row['التخصص']) t.specialization = row['Specialization'] || row['التخصص']; } });
                    this.saveData(); alert('تم'); this.closeModal('modal-settings');
                };
                reader.readAsArrayBuffer(e.target.files[0]);
            }
            exportReports() { const data = this.state.teachers.map(t => ({ 'المعلم': t.name, 'التقييم': t.score+'%', 'الهاتف': t.phone||'-' })); const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Reports"); XLSX.writeFile(wb, "School_Report.xlsx"); }
            setView(v) { ['now', 'teachers', 'reports', 'supervision', 'supervision-report', 'supervision-history', 'tasks', 'agenda'].forEach(x => { document.getElementById(`view-${x}`)?.classList.add('hidden-view'); const b = document.getElementById(`btn-${x}`); if(b) { b.classList.remove('text-[rgb(var(--color-primary-700))]'); b.classList.add('text-slate-400'); b.querySelector('div').classList.remove('bg-[rgb(var(--color-primary-50))]'); b.querySelector('div').classList.add('bg-transparent'); } }); document.getElementById(`view-${v}`)?.classList.remove('hidden-view'); const ab = document.getElementById(`btn-${v}`); if(ab) { ab.classList.add('text-[rgb(var(--color-primary-700))]'); ab.classList.remove('text-slate-400'); ab.querySelector('div').classList.add('bg-[rgb(var(--color-primary-50))]'); ab.querySelector('div').classList.remove('bg-transparent'); } if(v==='teachers') this.renderTeachers(); if(v==='reports') this.renderReports(); if(v==='supervision-history') this.renderHistory(); if(v==='tasks') this.renderTasks(); if(v==='agenda') this.renderAgenda(); }
            simulateRandomPeriod() { if(!this.state.periods.length) return alert('لا يوجد جدول'); const r = this.state.periods[Math.floor(Math.random()*this.state.periods.length)]; const [h,m] = r.start.split(':').map(Number); const t = new Date(); t.setHours(h,m,0,0); this.state.simulationOffset = t.getTime() - new Date().getTime(); this.renderCurrentPeriod(t); }
            resetTimeToReal() { this.state.simulationOffset = 0; this.renderCurrentPeriod(new Date()); }
            startClock() { setInterval(() => { const n = new Date(new Date().getTime() + this.state.simulationOffset); document.getElementById('clockDisplay').innerText = n.toLocaleTimeString('en-US',{hour12:false}); this.renderCurrentPeriod(n); }, 1000); }
        }

        window.app = new SchoolApp();
    </script>
</body>
</html>