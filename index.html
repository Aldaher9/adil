<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { 
            --primary: #0f172a; 
            --accent: #f59e0b; 
            --success: #10b981; 
            --danger: #ef4444;
            --bg: #f8fafc; 
            --card: #ffffff; 
            --text: #1e293b;
            --blue-grad: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { font-family: 'Tajawal', sans-serif !important; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body { background: var(--bg); margin: 0; padding: 0; color: var(--text); padding-bottom: 80px; display: none; /* ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø±Ù‡ Ø¹Ø¨Ø± JS */ }

        /* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 1000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 25px;
            text-align: center; box-shadow: var(--shadow); width: 100%; max-width: 400px;
        }
        .google-btn {
            width: 100%; padding: 15px; background: white; border: 2px solid #e2e8f0;
            border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px;
            display: flex; align-items: center; justify-content: center; gap: 12px;
            transition: 0.3s;
        }
        .google-btn:hover { border-color: var(--primary); background: #f8fafc; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header {
            background: var(--blue-grad); color: white; padding: 20px;
            border-radius: 0 0 25px 25px; box-shadow: 0 10px 20px rgba(15, 23, 42, 0.15);
            position: sticky; top: 0; z-index: 50;
        }
        .header h1 { margin: 0; font-size: 1.2rem; font-weight: 800; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .user-welcome { font-size: 0.85rem; opacity: 0.9; margin-bottom: 5px; }
        .header-actions { display: flex; gap: 8px; }
        .header-btn {
            background: rgba(255,255,255,0.2); border: none; color: white;
            padding: 6px 12px; border-radius: 8px; font-size: 13px; cursor: pointer;
        }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
        .container { padding: 20px; display: none; animation: fadeIn 0.4s ease; }
        .container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .status-card {
            background: var(--card); padding: 15px; border-radius: 16px;
            box-shadow: var(--shadow); margin-bottom: 20px; border-right: 5px solid var(--accent);
            display: flex; justify-content: space-between; align-items: center;
        }
        .badge-sim { background: #fee2e2; color: var(--danger); padding: 5px 10px; border-radius: 8px; font-weight: bold; font-size: 12px; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .stat-card { background: white; padding: 15px; border-radius: 15px; text-align: center; box-shadow: var(--shadow); }
        .stat-value { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 0.8rem; color: #64748b; }

        .lesson-card, .staff-card {
            background: var(--card); border-radius: 14px; padding: 15px; margin-bottom: 12px;
            box-shadow: var(--shadow); border: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;
        }
        .class-badge { background: var(--primary); color: white; padding: 8px 12px; border-radius: 10px; font-weight: bold; font-size: 14px; }
        .msg-btn { background: var(--success); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¹Ø§Ù…Ø© */
        .form-control {
            width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px;
            font-size: 14px; margin-top: 5px; transition: 0.3s;
        }
        .form-control:focus { border-color: var(--primary); }
        .form-group { margin-bottom: 15px; }

        .action-btn {
            border: none; padding: 12px; border-radius: 10px; color: white;
            font-weight: bold; cursor: pointer; width: 100%; text-align: center;
            background: var(--primary); margin-top: 10px; font-size: 14px;
        }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: white;
            display: flex; justify-content: space-around; padding: 10px 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 90;
            border-top: 1px solid #eee; display: none;
        }
        .nav-item { border: none; background: none; color: #94a3b8; font-size: 10px; cursor: pointer; flex: 1; }
        .nav-item span { display: block; font-size: 20px; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); font-weight: 800; }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 450px; padding: 25px; border-radius: 20px; max-height: 90vh; overflow-y: auto; }

        /* Ø·Ø¨Ø§Ø¹Ø© */
        @media print {
            body { background: white; padding: 0; display: block !important; }
            .no-print, .bottom-nav, .header-actions, .action-btn, #login-screen { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1>Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ âš¡</h1>
            <p style="color:#64748b; margin-bottom:20px;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ© Ø§Ù„Ø°ÙƒÙŠ</p>
            <button id="loginBtn" onclick="handleGoogleLogin()" class="google-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" alt="Google">
                <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ø¬ÙˆØ¬Ù„</span>
            </button>
        </div>
    </div>

    <div class="header" id="mainHeader">
        <div class="user-welcome" id="welcomeMsg">ğŸ‘¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        <div class="header-top">
            <h1>Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ âš¡</h1>
            <div class="header-actions">
                <button class="header-btn" onclick="openModal('settingsModal')">âš™ï¸ Ø¶Ø¨Ø·</button>
                <button class="header-btn logout-btn" onclick="handleLogout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </div>

    <div id="main-content">
        
        <div id="view-dashboard" class="container active">
            <div class="status-card">
                <div>
                    <div id="dashDate" style="font-size:0.9rem; color:#64748b">--:--</div>
                    <div id="dashPeriod" style="font-weight:800; color: var(--primary); font-size:1.1rem;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©..</div>
                </div>
                <div id="simBadge" style="display:none;" class="badge-sim">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statTeachers">0</div>
                    <div class="stat-label">Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statClasses">0</div>
                    <div class="stat-label">Ø§Ù„ÙØµÙˆÙ„</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statVisits">0</div>
                    <div class="stat-label">Ø²ÙŠØ§Ø±Ø©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statTasks">0</div>
                    <div class="stat-label">Ù…Ù‡Ø§Ù…</div>
                </div>
            </div>
        </div>

        <div id="view-schedule" class="container">
            <h3>ğŸ“… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
            <div id="lessons-list"></div>
        </div>

        <div id="view-staff" class="container">
            <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ù„Ù…..." onkeyup="filterStaff()" class="form-control" style="margin-bottom:15px;">
            <div id="staff-list"></div>
        </div>

        <div id="view-visits" class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin:0;">ğŸ‘ï¸ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø±Ø§ÙÙŠ</h3>
                <div style="display:flex; gap:5px;">
                    <button onclick="printFullReport()" class="action-btn" style="background:#475569; width:auto; font-size:12px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                    <button onclick="openVisitModal()" class="action-btn" style="background:var(--primary); width:auto; font-size:12px;">+ Ø¬Ø¯ÙŠØ¯</button>
                </div>
            </div>
            <div id="visits-list"></div>
        </div>

        <div id="view-agenda" class="container">
            <h3>ğŸ“ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="text" id="taskInput" class="form-control" placeholder="Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©...">
                <button onclick="addTask()" class="action-btn" style="width:80px; margin-top:0;">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div id="tasks-list"></div>
        </div>

    </div>

    <div class="bottom-nav" id="mainNav">
        <button class="nav-item active" onclick="switchTab('view-dashboard', this)"><span>ğŸ“Š</span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="nav-item" onclick="switchTab('view-schedule', this)"><span>ğŸ“…</span>Ø§Ù„Ø­ØµØµ</button>
        <button class="nav-item" onclick="switchTab('view-staff', this)"><span>ğŸ‘¥</span>Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</button>
        <button class="nav-item" onclick="switchTab('view-visits', this)"><span>ğŸ‘ï¸</span>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</button>
        <button class="nav-item" onclick="switchTab('view-agenda', this)"><span>ğŸ“</span>Ø§Ù„Ù…Ù‡Ø§Ù…</button>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
            
            <div class="form-group">
                <label>1. Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ (XML)</label>
                <input type="file" accept=".xml" onchange="handleXML(this)" class="form-control">
            </div>

            <div class="form-group">
                <label>2. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† (Excel)</label>
                <div class="grid-2">
                    <button onclick="document.getElementById('excelFile').click()" class="action-btn" style="background:#3b82f6;">Ø§Ø³ØªÙŠØ±Ø§Ø¯ ğŸ“¤</button>
                    <button onclick="exportToExcel()" class="action-btn" style="background:#10b981;">ØªØµØ¯ÙŠØ± ğŸ“¥</button>
                    <input type="file" id="excelFile" style="display:none" onchange="importFromExcel(this)" accept=".xlsx, .xls">
                </div>
            </div>

            <div class="form-group">
                <label>3. Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª (JSON)</label>
                <input type="file" accept=".json" onchange="importVisitsJSON(this)" class="form-control">
                <small style="color:#64748b">ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© JSON ØµØ­ÙŠØ­Ø©.</small>
            </div>

            <hr style="margin: 15px 0; border-color:#eee;">

            <div class="form-group">
                <label>Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙˆÙ‚Øª (Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©)</label>
                <div class="grid-2">
                    <button onclick="doSim()" class="action-btn" style="background:#f59e0b;">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© ğŸ²</button>
                    <button onclick="resetTime()" class="action-btn" style="background:#64748b;">Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ ğŸ•’</button>
                </div>
            </div>

            <button onclick="closeModal('settingsModal')" class="action-btn" style="background:#f1f5f9; color:#333; margin-top:20px;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="visitModal" class="modal">
        <div class="modal-content">
            <h3>ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <div class="form-group">
                <label>Ø§Ù„Ù…Ø¹Ù„Ù…</label>
                <select id="visitTeacher" class="form-control"></select>
            </div>
            <div class="form-group">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø© / Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                <textarea id="visitNotes" class="form-control" rows="3" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ù‡Ù†Ø§..."></textarea>
            </div>
            <div class="grid-2">
                <button onclick="saveVisit()" class="action-btn" style="background:var(--success);">Ø­ÙØ¸</button>
                <button onclick="closeModal('visitModal')" class="action-btn" style="background:var(--danger);">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script>
        // --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ---
        const firebaseConfig = {
          apiKey: "AIzaSyC4NddjijF29YNhowy4SqgRaMPn01oSSEg",
          authDomain: "school-9416e.firebaseapp.com",
          projectId: "school-9416e",
          storageBucket: "school-9416e.firebasestorage.app",
          messagingSenderId: "680872052240",
          appId: "1:680872052240:web:96d2e544166ab5f8096c95"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
        let currentUser = null;
        let data = { teachers: {}, classes: {}, subjects: {}, lessons: [], periods: [] };
        let phones = {};
        let tasks = [];
        let visits = [];
        let isSim = false, sDay = 1, sTime = "08:00";

        // --- 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Auth) ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.body.style.display = 'block';
                document.getElementById('mainNav').style.display = 'flex';
                document.getElementById('welcomeMsg').innerText = "ğŸ‘¤ Ù…Ø±Ø­Ø¨Ø§Ù‹: " + (user.displayName || "Ø§Ù„Ù‚Ø§Ø¦Ø¯");
                loadUserData();
            } else {
                document.body.style.display = 'block'; 
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('mainNav').style.display = 'none';
            }
        });

        async function handleGoogleLogin() {
            const btn = document.getElementById('loginBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...";
            
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠ
            } catch (error) {
                console.error(error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + error.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function handleLogout() {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
                auth.signOut().then(() => location.reload());
            }
        }

        // --- 4. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Sync) ---
        async function loadUserData() {
            try {
                const doc = await db.collection("users").doc(currentUser.uid).get();
                if(doc.exists) {
                    const cloud = doc.data();
                    data = cloud.schoolData || data;
                    phones = cloud.phones || {};
                    tasks = cloud.tasks || [];
                    visits = cloud.visits || [];
                    refreshUI();
                }
            } catch (e) { console.log("New user or load error"); }
        }

        async function syncToCloud() {
            if(!currentUser) return;
            await db.collection("users").doc(currentUser.uid).set({
                schoolData: data,
                phones: phones,
                tasks: tasks,
                visits: visits,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        function refreshUI() {
            refreshSchedule();
            updateDashboard();
            renderStaff();
            renderTasks();
            renderVisits();
        }

        // --- 5. Ø§Ù„Ù…Ù†Ø·Ù‚ (Logic) ---
        function updateDashboard() {
            document.getElementById('statTeachers').innerText = Object.keys(data.teachers || {}).length;
            document.getElementById('statClasses').innerText = Object.keys(data.classes || {}).length;
            document.getElementById('statVisits').innerText = visits.length;
            document.getElementById('statTasks').innerText = tasks.length;
        }

        function refreshSchedule() {
            const now = new Date();
            const d = isSim ? sDay : (now.getDay() === 0 ? 1 : now.getDay() + 1);
            const t = isSim ? sTime : now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0');
            
            document.getElementById('dashDate').innerText = t;
            document.getElementById('simBadge').style.display = isSim ? "block" : "none";

            const p = (data.periods || []).find(period => {
                const cur = toM(t), s = toM(period.s), e = toM(period.e);
                return cur >= s && cur <= e;
            });

            const list = document.getElementById('lessons-list');
            let infoText = "Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¯ÙˆØ§Ù…";

            if (p && data.lessons) {
                infoText = "Ø§Ù„Ø­ØµØ©: " + p.id;
                const currentLessons = data.lessons.filter(l => l.d == d && l.p == p.id);
                
                if (currentLessons.length > 0) {
                    list.innerHTML = currentLessons.map(l => {
                        const teacherName = data.teachers[l.t] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                        const className = data.classes[l.c] || "..";
                        const phone = (phones[teacherName] || "").replace(/\s+/g, '');
                        const msg = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… Ø£Ø³ØªØ§Ø° ${teacherName}ØŒ Ù†Ø±Ø¬Ùˆ Ø§Ù„ØªÙˆØ§Ø¬Ø¯ ÙÙŠ Ø­ØµØ© ${className}.`;
                        
                        return `
                        <div class="lesson-card">
                            <div class="class-badge">${className}</div>
                            <div style="flex:1; padding-right:15px;">
                                <div style="font-weight:bold;">${teacherName}</div>
                                <div style="font-size:12px; color:#64748b;">${data.subjects[l.s] || ''}</div>
                            </div>
                            <button onclick="window.open('https://wa.me/${phone}?text=${encodeURIComponent(msg)}')" class="msg-btn">ğŸ’¬</button>
                        </div>`;
                    }).join('');
                } else {
                    list.innerHTML = `<div style="text-align:center; padding:30px; color:#94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</div>`;
                }
            } else {
                list.innerHTML = `<div style="text-align:center; padding:30px; color:#94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù†</div>`;
            }
            document.getElementById('dashPeriod').innerText = infoText;
        }

        function renderStaff() {
            const list = document.getElementById('staff-list');
            const allTeachers = Object.values(data.teachers || {}).sort();
            
            list.innerHTML = allTeachers.map(name => {
                const ph = phones[name] || "";
                return `
                <div class="staff-card filter-item">
                    <div>
                        <div style="font-weight:bold;">${name}</div>
                        <div style="font-size:12px; color:#64748b;">${ph || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…'}</div>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="updatePhone('${name}')" style="border:none; background:#f1f5f9; padding:5px; border-radius:5px;">âœï¸</button>
                        <a href="tel:${ph}" style="text-decoration:none; font-size:20px;">ğŸ“</a>
                    </div>
                </div>`;
            }).join('');
        }

        function updatePhone(name) {
            const p = prompt(`Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ: ${name}`, phones[name] || "");
            if(p !== null) { phones[name] = p; renderStaff(); syncToCloud(); }
        }

        function filterStaff() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.filter-item').forEach(el => {
                el.style.display = el.innerText.toLowerCase().includes(q) ? 'flex' : 'none';
            });
        }

        // --- 6. Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© ---
        function renderVisits() {
            const list = document.getElementById('visits-list');
            list.innerHTML = visits.map(v => `
                <div class="staff-card" style="display:block;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <b>${v.teacher}</b>
                        <span style="font-size:12px; color:#64748b;">${new Date(v.date).toLocaleDateString('ar-EG')}</span>
                    </div>
                    <div style="font-size:13px; color:#334155;">${v.notes}</div>
                </div>
            `).join('');
        }

        function openVisitModal() {
            const sel = document.getElementById('visitTeacher');
            sel.innerHTML = Object.values(data.teachers).map(t => `<option value="${t}">${t}</option>`).join('');
            openModal('visitModal');
        }

        function saveVisit() {
            const t = document.getElementById('visitTeacher').value;
            const n = document.getElementById('visitNotes').value;
            if(t && n) {
                visits.unshift({ teacher: t, notes: n, date: new Date().toISOString() });
                syncToCloud();
                renderVisits();
                updateDashboard();
                closeModal('visitModal');
                document.getElementById('visitNotes').value = "";
            }
        }

        function printFullReport() {
            if (visits.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù„Ø·Ø¨Ø§Ø¹ØªÙ‡Ø§");

            const printWindow = window.open('', '_blank');
            let html = `
            <html dir="rtl">
            <head>
                <title>Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø´Ø±Ø§ÙÙŠØ©</title>
                <style>
                    body { font-family: 'Tajawal', sans-serif; padding: 20px; }
                    h2 { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #999; padding: 10px; text-align: right; }
                    th { background-color: #f3f4f6; }
                    tr:nth-child(even) { background-color: #f9fafb; }
                </style>
            </head>
            <body>
                <h2>Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø´Ø±Ø§ÙÙŠØ©</h2>
                <table>
                    <thead>
                        <tr>
                            <th width="5%">#</th>
                            <th width="15%">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th width="25%">Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                            <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª / Ø§Ù„ØªÙˆØµÙŠØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            visits.forEach((v, i) => {
                html += `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${new Date(v.date).toLocaleDateString('ar-EG')}</td>
                        <td>${v.teacher}</td>
                        <td>${v.notes}</td>
                    </tr>`;
            });

            html += `</tbody></table>
            <script>window.onload = function() { window.print(); }</script>
            </body></html>`;
            
            printWindow.document.write(html);
            printWindow.document.close();
        }

        function importVisitsJSON(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    if(Array.isArray(json)) {
                        visits = [...json, ...visits];
                        await syncToCloud();
                        renderVisits();
                        updateDashboard();
                        alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${json.length} Ø²ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­!`);
                        closeModal('settingsModal');
                    } else {
                        alert("ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† JSON Array.");
                    }
                } catch (err) {
                    console.error(err);
                    alert("Ù…Ù„Ù JSON ØºÙŠØ± ØµØ§Ù„Ø­.");
                }
            };
            reader.readAsText(file);
        }

        // --- 7. Ø§Ù„Ø£Ø¬Ù†Ø¯Ø© Ùˆ Ø§Ù„Ù…Ù‡Ø§Ù… ---
        function addTask() {
            const inp = document.getElementById('taskInput');
            if(inp.value.trim()) {
                tasks.push({ id: Date.now(), text: inp.value.trim(), done: false });
                inp.value = "";
                renderTasks();
                syncToCloud();
                updateDashboard();
            }
        }
        function renderTasks() {
            document.getElementById('tasks-list').innerHTML = tasks.map(t => `
                <div class="lesson-card" style="padding:10px;">
                    <span style="${t.done ? 'text-decoration:line-through;opacity:0.6' : ''}">${t.text}</span>
                    <button onclick="removeTask(${t.id})" style="border:none; background:none; color:red;">âœ•</button>
                </div>
            `).join('');
        }
        function removeTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            renderTasks(); syncToCloud(); updateDashboard();
        }

        // --- 8. Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª (XML/Excel) ---
        function handleXML(input) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const parser = new DOMParser();
                const xml = parser.parseFromString(e.target.result, "text/xml");
                
                let newData = { teachers: {}, classes: {}, subjects: {}, lessons: [], periods: [] };
                
                Array.from(xml.getElementsByTagName('teacher')).forEach(t => newData.teachers[t.getAttribute('id')] = t.getAttribute('name'));
                Array.from(xml.getElementsByTagName('class')).forEach(c => newData.classes[c.getAttribute('id')] = c.getAttribute('short'));
                Array.from(xml.getElementsByTagName('subject')).forEach(s => newData.subjects[s.getAttribute('id')] = s.getAttribute('name'));
                Array.from(xml.getElementsByTagName('period')).forEach(p => newData.periods.push({
                    id: p.getAttribute('period'), s: p.getAttribute('starttime'), e: p.getAttribute('endtime')
                }));
                
                Array.from(xml.getElementsByTagName('TimeTableSchedule')).forEach(l => {
                    newData.lessons.push({
                        d: l.getAttribute('DayID'), p: l.getAttribute('Period'), 
                        c: l.getAttribute('ClassID'), t: l.getAttribute('TeacherID'), s: l.getAttribute('SubjectGradeID')
                    });
                });

                data = newData;
                await syncToCloud();
                refreshUI();
                alert("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­");
                closeModal('settingsModal');
            };
            reader.readAsText(input.files[0]);
        }

        function importFromExcel(input) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const wb = XLSX.read(e.target.result, { type: 'binary' });
                const sheet = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                sheet.forEach(row => {
                    const name = row['Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…'] || row['Name'];
                    const phone = row['Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ'] || row['Phone'];
                    if(name) phones[name] = String(phone || "");
                });
                await syncToCloud();
                renderStaff();
                alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†");
            };
            reader.readAsBinaryString(input.files[0]);
        }

        function exportToExcel() {
            const rows = Object.keys(data.teachers || {}).map(id => {
                const name = data.teachers[id];
                return { "Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…": name, "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ": phones[name] || "" };
            });
            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†");
            XLSX.writeFile(wb, "Staff_Data.xlsx");
        }

        // --- Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function switchTab(id, btn) {
            document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            btn.classList.add('active');
        }
        function toM(t) { const [h, m] = t.split(':'); return parseInt(h) * 60 + parseInt(m); }
        function doSim() { isSim = true; sDay = 1; sTime = "08:00"; closeModal('settingsModal'); refreshSchedule(); }
        function resetTime() { isSim = false; closeModal('settingsModal'); refreshSchedule(); }

        setInterval(() => { if(currentUser && !isSim) refreshSchedule(); }, 60000);
    </script>
</body>
</html>
