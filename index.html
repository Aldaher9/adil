<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #1e3a5f; --accent: #e67e22; --success: #25d366; 
            --bg: #f4f7f6; --class-grad: linear-gradient(135deg, #2c3e50 0%, #1e3a5f 100%);
        }
        * { font-family: 'Tajawal', sans-serif !important; box-sizing: border-box; }
        body { background: var(--bg); margin: 0; padding: 10px; color: #333; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header { 
            background: var(--primary); color: white; padding: 15px; 
            border-radius: 12px; display: flex; justify-content: space-between; 
            align-items: center; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© */
        .status-bar { 
            background: white; padding: 12px; border-radius: 12px; 
            margin-bottom: 10px; border-right: 6px solid var(--accent);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .table-container { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 12px; font-size: 13px; color: #666; border-bottom: 2px solid #eee; }
        td { padding: 15px 5px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; }

        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØµÙ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
        .class-box {
            background: var(--class-grad); color: white; padding: 8px 4px; border-radius: 8px;
            font-weight: 700; font-size: 0.95rem; display: inline-block; min-width: 55px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1);
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ */
        .action-group { display: flex; flex-direction: column; gap: 4px; }
        .btn-wa { 
            text-decoration: none; color: white; padding: 6px; border-radius: 5px; 
            font-size: 11px; font-weight: bold; display: block;
        }
        .bg-office { background: #3498db; }
        .bg-duty { background: #f39c12; }
        .bg-lineup { background: #9b59b6; }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        .settings-btn { background: var(--accent); border: none; color: white; width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer; }
        
        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
        #modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: white; margin: 15% auto; padding: 20px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; }
        .phone-input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; text-align: center; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0; font-size: 1.1rem;">ğŸ“ Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø°ÙƒÙŠØ©</h2>
    <button class="settings-btn" onclick="openModal()">âš™ï¸</button>
</div>

<div class="status-bar">
    <div>
        <div id="info" style="font-size: 12px; color: #888;">--</div>
        <div id="txtPeriod" style="font-size: 18px; font-weight: bold; color: var(--accent);">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„..</div>
    </div>
    <button onclick="toggleEditMode()" id="editBtn" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--primary); background: none; font-weight: bold; color: var(--primary);">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</button>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th width="20%">Ø§Ù„ØµÙ</th>
                <th width="40%">Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                <th width="40%">ØªÙˆØ§ØµÙ„ Ø³Ø±ÙŠØ¹</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="3" style="padding:40px; color:#999;">Ø§Ø±ÙØ¹ Ù…Ù„Ù XML Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âš™ï¸</td></tr>
        </tbody>
    </table>
</div>

<div id="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØµØ©</h3>
        <div style="background:#f9f9f9; padding:10px; border-radius:10px; border:1px dashed #ccc; margin-bottom:10px;">
            <label style="font-size:12px; display:block; margin-bottom:5px;">Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ (XML)</label>
            <input type="file" id="xmlFile" accept=".xml" onchange="handleXML(this)" style="width:100%">
        </div>
        <button class="btn-wa" style="background:#8e44ad; width:100%; padding:12px; margin-bottom:5px; border:none;" onclick="doSim()">ğŸ² ØªØ¬Ø±Ø¨Ø© Ù…Ø­Ø§ÙƒØ§Ø©</button>
        <button class="btn-wa" style="background:var(--danger); width:100%; padding:12px; border:none;" onclick="doReset()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø©</button>
        <button class="btn-wa" style="background:#666; width:100%; padding:12px; margin-top:15px; border:none;" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>
let phones = JSON.parse(localStorage.getItem('teacherPhones')) || {};
let data = JSON.parse(localStorage.getItem('schoolData')) || { teachers: {}, classes: {}, subjects: {}, lessons: [], periods: [] };
let isSim = false, sDay, sTime, editMode = false;

function openModal() { document.getElementById('modal').style.display = 'block'; }
function closeModal() { document.getElementById('modal').style.display = 'none'; }
function toggleEditMode() { editMode = !editMode; refresh(); }

function handleXML(input) {
    const reader = new FileReader();
    reader.readAsText(input.files[0], "windows-1256");
    reader.onload = function(e) {
        const xml = new DOMParser().parseFromString(e.target.result, "text/xml");
        data.teachers = {}; data.periods = [];
        Array.from(xml.getElementsByTagName('teacher')).forEach(t => data.teachers[t.getAttribute('id')] = t.getAttribute('name'));
        Array.from(xml.getElementsByTagName('class')).forEach(c => data.classes[c.getAttribute('id')] = c.getAttribute('short'));
        Array.from(xml.getElementsByTagName('subject')).forEach(s => data.subjects[s.getAttribute('id')] = s.getAttribute('name'));
        Array.from(xml.getElementsByTagName('period')).forEach(p => data.periods.push({id: p.getAttribute('period'), s: p.getAttribute('starttime'), e: p.getAttribute('endtime')}));
        data.lessons = Array.from(xml.getElementsByTagName('TimeTableSchedule')).map(l => ({
            d: l.getAttribute('DayID'), p: l.getAttribute('Period'), c: l.getAttribute('ClassID'), t: l.getAttribute('TeacherID'), s: l.getAttribute('SubjectGradeID')
        }));
        localStorage.setItem('schoolData', JSON.stringify(data));
        closeModal(); refresh();
    };
}

function saveP(name, id) {
    phones[name] = document.getElementById(id).value;
    localStorage.setItem('teacherPhones', JSON.stringify(phones));
    alert("ØªÙ… Ø­ÙØ¸ Ø±Ù‚Ù… " + name);
}

function refresh() {
    const now = new Date(), days = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"];
    let d = isSim ? sDay : (now.getDay() === 0 ? 1 : now.getDay() + 1);
    let t = isSim ? sTime : now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0');
    document.getElementById('info').innerText = days[isSim ? (sDay==1?0:sDay-1) : now.getDay()] + " | " + t;

    const p = data.periods.find(p => { const cur = toM(t), s = toM(p.s), e = toM(p.e); return cur >= s && cur <= e; });
    const tbody = document.getElementById('tableBody');

    if (p && data.lessons.length > 0) {
        document.getElementById('txtPeriod').innerText = "Ø§Ù„Ø­ØµØ©: " + p.id;
        const current = data.lessons.filter(l => l.d == d && l.p == p.id).sort((a, b) => (data.classes[a.c] || "").localeCompare(data.classes[b.c] || "", 'ar', {numeric: true}));
        
        tbody.innerHTML = current.map((l, i) => {
            let n = data.teachers[l.t], ph = phones[n] || "";
            let cls = data.classes[l.c];
            
            if (editMode) {
                return `<tr>
                    <td><div class="class-box">${cls}</div></td>
                    <td><b>${n}</b></td>
                    <td><input type="tel" id="p${i}" value="${ph}" class="phone-input"><button onclick="saveP('${n}','p${i}')" style="font-size:10px">Ø­ÙØ¸</button></td>
                </tr>`;
            }

            const mOffice = encodeURIComponent(`Ø§Ù„Ø£Ø³ØªØ§Ø°/ ${n}\nÙ†Ø±Ø¬Ùˆ Ø­Ø¶ÙˆØ±ÙƒÙ… Ù„Ù„Ù…ÙƒØªØ¨ Ø§Ù„Ø¢Ù†.`);
            const mDuty = encodeURIComponent(`Ø§Ù„Ø£Ø³ØªØ§Ø°/ ${n}\nÙ†Ù„Ø§Ø­Ø¸ ØºÙŠØ§Ø¨ÙƒÙ… Ø¹Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© ÙÙŠ Ø§Ù„Ø­ØµØ© ${p.id}.`);
            const mLineup = encodeURIComponent(`Ø§Ù„Ø£Ø³ØªØ§Ø°/ ${n}\nÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§Ø¬Ø¯ Ù…Ø¹ ØµÙÙƒÙ… ${cls} ÙÙŠ Ø§Ù„Ø·Ø§Ø¨ÙˆØ±.`);

            return `<tr>
                <td><div class="class-box">${cls}</div></td>
                <td style="font-size:14px;"><b>${n}</b></td>
                <td>
                    <div class="action-group">
                        <a href="https://wa.me/${ph}?text=${mOffice}" class="btn-wa bg-office">ğŸ¢ Ù„Ù„Ù…ÙƒØªØ¨</a>
                        <a href="https://wa.me/${ph}?text=${mDuty}" class="btn-wa bg-duty">ğŸ“ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©</a>
                        <a href="https://wa.me/${ph}?text=${mLineup}" class="btn-wa bg-lineup">ğŸ“¢ Ø§Ù„Ø·Ø§Ø¨ÙˆØ±</a>
                    </div>
                </td>
            </tr>`;
        }).join('');
    } else {
        document.getElementById('txtPeriod').innerText = "Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¯ÙˆØ§Ù…";
        tbody.innerHTML = "<tr><td colspan='3' style='padding:40px'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>";
    }
}

function toM(time) { const [h, m] = time.split(':'); return parseInt(h) * 60 + parseInt(m); }
function doSim() { isSim = true; sDay = 1; sTime = data.periods[0]?.s || "08:00"; closeModal(); refresh(); }
function doReset() { if(confirm("Ù…Ø³Ø­ØŸ")) { localStorage.clear(); location.reload(); } }

window.onload = () => { if(data.lessons.length > 0) refresh(); setInterval(refresh, 30000); };
</script>
</body>
</html>
