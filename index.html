<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø°ÙƒÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #1e3a5f; --accent: #e67e22; --success: #25d366; 
            --bg: #f4f7f6; --class-grad: linear-gradient(135deg, #2c3e50 0%, #1e3a5f 100%);
        }
        * { font-family: 'Tajawal', sans-serif !important; box-sizing: border-box; }
        body { background: var(--bg); margin: 0; padding: 10px; color: #333; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header { 
            background: var(--primary); color: white; padding: 15px; border-radius: 12px; 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }

        /* Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .section-title { 
            font-size: 1.1rem; font-weight: bold; color: var(--primary); 
            margin: 15px 5px 10px; border-right: 4px solid var(--accent); padding-right: 10px;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© */
        .status-bar { 
            background: white; padding: 12px; border-radius: 12px; margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;
        }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .card-container { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 10px; font-size: 13px; color: #666; border-bottom: 2px solid #eee; }
        td { padding: 12px 5px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; }

        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØµÙ */
        .class-box {
            background: var(--class-grad); color: white; padding: 6px 4px; border-radius: 8px;
            font-weight: 700; font-size: 0.9rem; display: inline-block; min-width: 50px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.15);
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙˆØ§ØµÙ„ */
        .action-btns { display: flex; flex-direction: column; gap: 3px; }
        .btn-wa { 
            text-decoration: none; color: white; padding: 5px; border-radius: 4px; 
            font-size: 10px; font-weight: bold; display: block;
        }
        .bg-office { background: #3498db; }
        .bg-duty { background: #f39c12; }
        .bg-lineup { background: #9b59b6; }

        /* Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨Ø­Ø« */
        .search-box { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; margin-bottom: 10px; font-size: 14px; }

        /* Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        .settings-btn { background: var(--accent); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; cursor: pointer; }
        
        #modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: white; margin: 15% auto; padding: 20px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0; font-size: 1rem;">ğŸ“ Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h2>
    <button class="settings-btn" onclick="openModal()">âš™ï¸</button>
</div>

<div class="section-title">Ø§Ù„Ø­ØµØµ Ø§Ù„Ø¬Ø§Ø±ÙŠØ© (Ø§Ù„ØµÙÙˆÙ Ù…Ø±ØªØ¨Ø©)</div>
<div class="status-bar">
    <div id="info" style="font-size: 12px; color: #888;">--</div>
    <div id="txtPeriod" style="font-size: 16px; font-weight: bold; color: var(--accent);">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..</div>
</div>

<div class="card-container">
    <table>
        <thead>
            <tr>
                <th width="20%">Ø§Ù„ØµÙ</th>
                <th width="40%">Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                <th width="40%">ØªÙˆØ§ØµÙ„ Ø³Ø±ÙŠØ¹</th>
            </tr>
        </thead>
        <tbody id="currentLessonsTable">
            <tr><td colspan="3" style="padding:20px; color:#999;">Ø§Ø±ÙØ¹ Ù…Ù„Ù XML Ù„Ù„Ø¨Ø¯Ø¡ âš™ï¸</td></tr>
        </tbody>
    </table>
</div>

<hr style="border: 0; border-top: 1px solid #ddd; margin: 20px 0;">

<div class="section-title">Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ø´Ø§Ù…Ù„</div>
<input type="text" id="searchInput" class="search-box" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…..." onkeyup="filterAllTeachers()">

<div class="card-container">
    <table>
        <thead>
            <tr>
                <th width="45%">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                <th width="55%">ØªÙˆØ§ØµÙ„ / ØªØ¹Ø¯ÙŠÙ„</th>
            </tr>
        </thead>
        <tbody id="allTeachersTable">
            </tbody>
    </table>
</div>

<div id="modal">
    <div class="modal-content">
        <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØµØ©</h3>
        <input type="file" id="xmlFile" accept=".xml" onchange="handleXML(this)" style="width:100%; margin-bottom:10px;">
        <button style="width:100%; padding:12px; margin-bottom:5px; background:var(--primary); color:white; border:none; border-radius:5px;" onclick="doSim()">ğŸ² ØªØ¬Ø±Ø¨Ø© Ù…Ø­Ø§ÙƒØ§Ø©</button>
        <button style="width:100%; padding:12px; background:#e74c3c; color:white; border:none; border-radius:5px;" onclick="doReset()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø©</button>
        <button style="width:100%; padding:12px; margin-top:15px; border:none;" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>
let phones = JSON.parse(localStorage.getItem('teacherPhones')) || {
    "Ø£Ø­Ù…Ø¯ Ø§Ù„Ø¨Ù„ÙˆØ´ÙŠ": "96892959789", "Ø£Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„ÙˆÙ‡Ø§Ø¨": "96890128035", "Ø£Ø­Ù…Ø¯ Ø¹ÙŠØ³Ù‰ Ø¬Ù…Ø¹Ù‡ Ø§Ù„Ø¨ÙˆØµØ§ÙÙŠ": "96892876386",
    "Ø§Ø­Ù…Ø¯ Ø³Ø§Ù„Ù… Ù…Ø­Ù…Ø¯ Ø§Ù„ØºÙ…Ø§Ø±Ù‰": "96895500478", "Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„ØªÙˆØ§Ø¨": "96876609518", "Ø§Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¬Ù…Ø¹Ù‡ Ø§Ù„Ø¨ÙˆØµØ§ÙÙ‰": "96892923979"
};
let data = JSON.parse(localStorage.getItem('schoolData')) || { teachers: {}, classes: {}, subjects: {}, lessons: [], periods: [] };
let isSim = false, sDay, sTime;

function openModal() { document.getElementById('modal').style.display = 'block'; }
function closeModal() { document.getElementById('modal').style.display = 'none'; }

function handleXML(input) {
    const reader = new FileReader();
    reader.readAsText(input.files[0], "windows-1256");
    reader.onload = function(e) {
        const xml = new DOMParser().parseFromString(e.target.result, "text/xml");
        data.teachers = {}; data.periods = [];
        Array.from(xml.getElementsByTagName('teacher')).forEach(t => data.teachers[t.getAttribute('id')] = t.getAttribute('name'));
        Array.from(xml.getElementsByTagName('class')).forEach(c => data.classes[c.getAttribute('id')] = c.getAttribute('short'));
        Array.from(xml.getElementsByTagName('period')).forEach(p => data.periods.push({id: p.getAttribute('period'), s: p.getAttribute('starttime'), e: p.getAttribute('endtime')}));
        data.lessons = Array.from(xml.getElementsByTagName('TimeTableSchedule')).map(l => ({
            d: l.getAttribute('DayID'), p: l.getAttribute('Period'), c: l.getAttribute('ClassID'), t: l.getAttribute('TeacherID')
        }));
        localStorage.setItem('schoolData', JSON.stringify(data));
        closeModal(); refresh();
    };
}

function updatePhone(name, val) {
    phones[name] = val;
    localStorage.setItem('teacherPhones', JSON.stringify(phones));
    refresh();
}

function refresh() {
    const now = new Date(), days = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"];
    let d = isSim ? sDay : (now.getDay() === 0 ? 1 : now.getDay() + 1);
    let t = isSim ? sTime : now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0');
    document.getElementById('info').innerText = days[isSim ? (sDay==1?0:sDay-1) : now.getDay()] + " | " + t;

    const p = data.periods.find(p => { const cur = toM(t), s = toM(p.s), e = toM(p.e); return cur >= s && cur <= e; });

    // 1. ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­ØµØµ Ø§Ù„Ø¬Ø§Ø±ÙŠØ© (Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ)
    const currentTbody = document.getElementById('currentLessonsTable');
    if (p && data.lessons.length > 0) {
        document.getElementById('txtPeriod').innerText = "Ø§Ù„Ø­ØµØ©: " + p.id;
        const current = data.lessons.filter(l => l.d == d && l.p == p.id).sort((a, b) => (data.classes[a.c] || "").localeCompare(data.classes[b.c] || "", 'ar', {numeric: true}));
        currentTbody.innerHTML = current.map(l => {
            let n = data.teachers[l.t], ph = phones[n] || "";
            let cls = data.classes[l.c];
            return `<tr>
                <td><div class="class-box">${cls}</div></td>
                <td><b>${n}</b></td>
                <td><div class="action-btns">
                    <a href="https://wa.me/${ph}?text=${encodeURIComponent('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù„Ù…ÙƒØªØ¨')}" class="btn-wa bg-office">ğŸ¢ Ù„Ù„Ù…ÙƒØªØ¨</a>
                    <a href="https://wa.me/${ph}?text=${encodeURIComponent('Ø£ÙŠÙ† Ø£Ù†Øª Ø¹Ù† Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©ØŸ')}" class="btn-wa bg-duty">ğŸ“ Ù…Ù†Ø§ÙˆØ¨Ø©</a>
                </div></td>
            </tr>`;
        }).join('');
    } else {
        currentTbody.innerHTML = "<tr><td colspan='3' style='padding:20px'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>";
    }

    // 2. ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† (Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø³ÙÙ„ÙŠ)
    renderAllTeachers();
}

function renderAllTeachers() {
    const allTbody = document.getElementById('allTeachersTable');
    const sortedNames = Object.keys(phones).sort();
    allTbody.innerHTML = sortedNames.map((name, i) => `
        <tr class="teacher-row">
            <td style="text-align:right; padding-right:15px; font-size:13px;">${name}</td>
            <td>
                <input type="tel" value="${phones[name]}" onchange="updatePhone('${name}', this.value)" style="width:80px; font-size:11px; padding:4px;">
                <a href="https://wa.me/${phones[name]}" target="_blank" style="text-decoration:none; font-size:14px;"> ğŸ’¬</a>
            </td>
        </tr>
    `).join('');
}

function filterAllTeachers() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('.teacher-row');
    rows.forEach(r => r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none');
}

function toM(time) { const [h, m] = time.split(':'); return parseInt(h) * 60 + parseInt(m); }
function doSim() { isSim = true; sDay = 1; sTime = data.periods[0]?.s || "08:00"; closeModal(); refresh(); }
function doReset() { if(confirm("Ø­Ø°ÙØŸ")) { localStorage.clear(); location.reload(); } }

window.onload = () => { refresh(); setInterval(refresh, 30000); };
</script>
</body>
</html>
