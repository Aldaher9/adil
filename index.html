<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مدير المدرسة الذكي</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        brand: { 50:'#eff6ff', 100:'#dbeafe', 500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8', 900:'#1e3a8a' },
                        primary: { DEFAULT: '#4f46e5', 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
                        surface: { DEFAULT: '#ffffff', 50: '#f8fafc', 100: '#f1f5f9' }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(79, 70, 229, 0.3)'
                    }
                }
            }
        }
    </script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Excel Export/Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --color-primary-50: 238 242 255; --color-primary-100: 224 231 255; --color-primary-500: 99 102 241; --color-primary-600: 79 70 229; --color-primary-700: 67 56 202; --color-primary-900: 49 46 129;
            --bg-body: #f8fafc; --text-main: #0f172a; --text-muted: #475569;
        }
        .theme-pink { --color-primary-50: 253 242 248; --color-primary-100: 252 231 243; --color-primary-500: 236 72 153; --color-primary-600: 219 39 119; --color-primary-700: 190 24 93; --color-primary-900: 131 24 67; }
        .theme-green { --color-primary-50: 240 253 244; --color-primary-100: 220 252 231; --color-primary-500: 34 197 94; --color-primary-600: 22 163 74; --color-primary-700: 21 128 61; --color-primary-900: 20 83 45; }
        .theme-dark { --color-primary-50: 30 41 59; --color-primary-100: 51 65 85; --color-primary-500: 99 102 241; --color-primary-600: 129 140 248; --color-primary-700: 165 180 252; --color-primary-900: 49 46 129; --bg-body: #0f172a; --text-main: #f1f5f9; --text-muted: #94a3b8; }

        body { background-color: var(--bg-body); color: var(--text-main); transition: background-color 0.3s, color 0.3s; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .hidden-view { display: none !important; }
        .modal-content { z-index: 60; position: relative; }
        .modal-backdrop { z-index: 50; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        .sup-radio:checked + div { background-color: rgb(var(--color-primary-50)); border-color: rgb(var(--color-primary-600)); box-shadow: 0 0 0 1px rgb(var(--color-primary-600)); }
        .sup-radio:checked + div .check-icon { display: block; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        .theme-dark .glass-panel { background: rgba(30, 41, 59, 0.95); border-color: rgba(255, 255, 255, 0.1); }
        
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }

        .print-only { display: none; }
        @media print {
            body * { visibility: hidden; }
            #printable-substitution-sheet, #printable-substitution-sheet * { visibility: visible; }
            #printable-substitution-sheet { position: absolute; left: 0; top: 0; width: 100%; display: block !important; padding: 20px; background: white; z-index: 9999; }
            #view-supervision-report, #view-supervision-report * { visibility: visible; }
            #view-supervision-report { position: absolute; left: 0; top: 0; width: 100%; display: block !important; padding: 0; margin: 0; background: white; }
            .no-print { display: none !important; }
            .print-only { display: block; }
        }
        
        .task-checkbox:checked + div { text-decoration: line-through; color: var(--text-muted); opacity: 0.6; }
        
        .duty-table th, .duty-table td { white-space: nowrap; min-width: 120px; }
        .duty-cell { position: relative; }
        .duty-cell:hover .duty-actions { opacity: 1; pointer-events: auto; }
        .duty-actions { opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        @media (max-width: 768px) { .duty-actions { opacity: 1; pointer-events: auto; } }
        
        .ai-report-section h4 { font-weight: 800; color: rgb(var(--color-primary-700)); margin-bottom: 0.8rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1.15rem; }
        .ai-report-section ul { list-style: none; padding: 0; space-y: 0.8rem; }
        .ai-report-section li { position: relative; padding-right: 1.5rem; line-height: 1.7; }
        .ai-report-section li::before { content: "•"; position: absolute; right: 0; color: rgb(var(--color-primary-500)); font-weight: bold; font-size: 1.2rem; line-height: 1.5rem; }
    </style>
    <script type="importmap">
{
  "imports": {
    "rxjs": "https://esm.sh/rxjs@^7.8.2?conditions=es2015",
    "rxjs/operators": "https://esm.sh/rxjs@^7.8.2/operators?conditions=es2015",
    "rxjs/ajax": "https://esm.sh/rxjs@^7.8.2/ajax?conditions=es2015",
    "rxjs/webSocket": "https://esm.sh/rxjs@^7.8.2/webSocket?conditions=es2015",
    "rxjs/testing": "https://esm.sh/rxjs@^7.8.2/testing?conditions=es2015",
    "rxjs/fetch": "https://esm.sh/rxjs@^7.8.2/fetch?conditions=es2015",
    "@angular/core": "https://esm.sh/@angular/core@^21.0.8?external=rxjs",
    "@angular/common": "https://esm.sh/@angular/common@^21.0.8?external=rxjs",
    "@angular/forms": "https://esm.sh/@angular/forms@^21.0.8?external=rxjs"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="antialiased selection:bg-[rgb(var(--color-primary-100))] selection:text-[rgb(var(--color-primary-900))] pb-32">

    <!-- Login View -->
    <div id="login-view" class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-slate-100 to-slate-300 p-6 relative overflow-hidden">
        <!-- Decoration -->
        <div class="absolute top-0 left-0 w-64 h-64 bg-[rgb(var(--color-primary-500))] rounded-full mix-blend-multiply filter blur-3xl opacity-10 animate-blob"></div>
        <div class="absolute top-0 right-0 w-64 h-64 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-10 animate-blob animation-delay-2000"></div>
        
        <div class="w-full max-w-sm text-center relative z-10 bg-white/90 backdrop-blur-xl p-8 rounded-3xl shadow-2xl border border-white/40">
            <img src="data:image/png;base64,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" alt="شعار مدير المدرسة الذكي" class="w-20 h-20 rounded-3xl shadow-lg mx-auto mb-6">
            <h1 class="text-3xl font-extrabold text-slate-900 mb-3 tracking-tight">مدير المدرسة الذكي</h1>
            <p class="text-slate-600 font-medium text-sm mb-8 leading-relaxed">مساحتك الخاصة لإدارة مدرستك بفاعلية.</p>
            
            <button id="googleLoginBtn" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3.5 px-4 rounded-2xl shadow-lg border border-slate-700 flex items-center justify-center gap-3 transition-all duration-300 group cursor-pointer mb-3">
                <img src="https://www.google.com/favicon.ico" class="w-5 h-5 group-hover:scale-110 transition-transform" alt="Google icon">
                <span>تسجيل الدخول بواسطة جوجل</span>
            </button>
            <button id="guestLoginBtn" class="w-full bg-white hover:bg-slate-50 text-slate-700 font-bold py-3 px-4 rounded-2xl transition-colors text-sm cursor-pointer border border-slate-200 hover:border-slate-300 shadow-sm">
                الدخول كزائر (تجريبي)
            </button>
        </div>
        <div class="mt-8 text-xs text-slate-500 font-bold font-mono">الإصدار 3.1.0</div>
    </div>
    
    <!-- App View -->
    <div id="app-view" class="hidden-view">
    
    <!-- Modern Header -->
    <header class="glass-panel sticky top-0 z-40 shadow-sm no-print transition-all duration-300">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <!-- Brand & Profile (Right) -->
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 text-slate-800 select-none">
                        <img src="data:image/png;base64,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" alt="شعار مدير المدرسة الذكي" class="w-9 h-9 rounded-xl shadow-md">
                        <h1 class="font-extrabold text-lg hidden md:block tracking-tight text-slate-900">مدير المدرسة</h1>
                    </div>
                    
                    <div class="h-6 w-px bg-slate-300 hidden md:block"></div>

                    <div id="user-profile-container" class="flex items-center gap-3">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Controls (Left) -->
                <div class="flex gap-3 items-center">
                    <div class="hidden md:flex bg-slate-100 px-4 py-2 rounded-xl border border-slate-200 items-center gap-2 shadow-inner">
                        <i class="fas fa-clock text-slate-500 text-sm animate-pulse"></i>
                        <span id="clockDisplay" class="font-mono font-bold text-slate-900 dir-ltr text-sm tracking-widest">00:00:00</span>
                    </div>
                    
                    <div id="cloudStatusIndicator" class="hidden sm:flex items-center"></div>
                    
                    <div class="flex bg-slate-100 p-1 rounded-xl gap-1 border border-slate-200">
                        <button onclick="window.app.simulateRandomPeriod()" class="px-3 py-1.5 rounded-lg text-[10px] md:text-xs font-bold transition flex items-center gap-2 cursor-pointer bg-white text-indigo-700 shadow-sm hover:shadow hover:bg-indigo-50 border border-slate-200" title="تجربة حصة عشوائية">
                            <i class="fas fa-dice text-amber-500"></i>
                            <span class="hidden sm:inline">محاكاة</span>
                        </button>
                        
                        <button onclick="window.app.resetTimeToReal()" class="px-3 py-1.5 rounded-lg text-[10px] md:text-xs font-bold transition flex items-center gap-2 cursor-pointer text-slate-600 hover:text-slate-900 hover:bg-white/80" title="العودة للوقت الفعلي">
                            <i class="fas fa-sync-alt"></i>
                            <span class="hidden sm:inline">فعلي</span>
                        </button>
                    </div>

                    <button onclick="window.app.openSettings()" class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-800 text-white hover:bg-slate-700 transition shadow-lg shadow-slate-300 cursor-pointer" title="الإعدادات">
                        <i class="fas fa-cog fa-spin-hover"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-6 space-y-8 max-w-7xl">
        
        <!-- View: Current Classes -->
        <section id="view-now" class="fade-in space-y-6">
            <!-- Hero Card -->
            <div class="relative overflow-hidden bg-gradient-to-r from-[rgb(var(--color-primary-700))] to-[rgb(var(--color-primary-900))] p-6 md:p-8 rounded-3xl shadow-xl text-white">
                <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full -mr-16 -mt-16 blur-2xl"></div>
                <div class="absolute bottom-0 left-0 w-40 h-40 bg-[rgb(var(--color-primary-500))] opacity-20 rounded-full -ml-10 -mb-10 blur-xl"></div>
                
                <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="flex items-center gap-5">
                        <div class="bg-white/20 backdrop-blur-sm p-4 rounded-2xl shadow-inner border border-white/10">
                            <i class="fas fa-chalkboard-user text-3xl text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl md:text-3xl font-extrabold mb-1 text-white tracking-tight">لوحة القيادة المدرسية</h2>
                            <p class="text-white/90 text-sm font-bold">متابعة حية لسير اليوم الدراسي</p>
                        </div>
                    </div>
                    <div id="currentPeriodInfo" class="bg-white/10 backdrop-blur-md rounded-2xl p-2 border border-white/10">
                        <!-- Populated JS -->
                    </div>
                </div>
            </div>

            <!-- Active Classes Grid -->
            <div>
                <div class="flex items-center justify-between mb-4 px-2">
                    <h3 class="font-extrabold text-slate-800 text-lg flex items-center gap-2"><i class="fas fa-layer-group text-[rgb(var(--color-primary-600))]"></i> الحصص القائمة</h3>
                    <span class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-lg border border-slate-200">مباشر</span>
                </div>
                <div id="activeClassesGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
            </div>
            
            <!-- Daily Duty Widget -->
            <div id="dailyDutyWidget" class="bg-white rounded-3xl shadow-soft border border-slate-200 p-6 hidden-view">
                <h3 class="text-lg font-extrabold text-slate-900 mb-6 flex items-center gap-3">
                    <div class="w-9 h-9 rounded-xl bg-amber-100 text-amber-700 flex items-center justify-center shadow-sm"><i class="fas fa-user-shield"></i></div>
                    <div>
                        مناوبة اليوم
                        <span id="dailyDutyDate" class="block text-xs text-slate-500 font-bold mt-0.5"></span>
                    </div>
                </h3>
                <div id="dailyDutyGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
            </div>
        </section>

        <!-- View: Substitution -->
        <section id="view-reserve" class="fade-in space-y-6 hidden-view">
            <!-- Header Section -->
            <div class="flex flex-col md:flex-row justify-between gap-6 bg-white p-8 rounded-3xl shadow-soft border border-slate-200 items-center">
                <div class="flex items-center gap-5 w-full md:w-auto">
                    <div class="bg-gradient-to-br from-red-500 to-rose-600 text-white w-16 h-16 rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-red-200">
                        <i class="fas fa-user-clock"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-extrabold text-slate-900">إدارة الاحتياط</h2>
                        <p class="text-slate-600 font-medium text-sm mt-1">توزيع حصص الغياب بذكاء وعدالة</p>
                    </div>
                </div>
                <div class="relative w-full md:w-96 bg-slate-50 p-2 rounded-2xl border border-slate-200">
                    <label class="text-[10px] font-bold text-slate-500 block px-3 mb-1 uppercase tracking-wider">المعلم الغائب</label>
                    <select id="absentTeacherSelect" onchange="window.app.handleAbsentSelection(this.value)" class="w-full bg-white border-0 rounded-xl p-3 text-slate-800 font-extrabold outline-none focus:ring-2 focus:ring-[rgb(var(--color-primary-300))] shadow-sm cursor-pointer appearance-none">
                        <option value="">-- اختر من القائمة --</option>
                    </select>
                    <div class="absolute left-4 bottom-4 text-slate-500 pointer-events-none"><i class="fas fa-chevron-down"></i></div>
                </div>
            </div>

            <!-- Absent Schedule Container -->
            <div id="absentScheduleContainer" class="space-y-4 min-h-[300px]">
                <div class="flex flex-col items-center justify-center h-64 text-slate-400 bg-white rounded-3xl border-2 border-dashed border-slate-200">
                    <i class="fas fa-chalkboard-teacher text-5xl mb-4 opacity-50"></i>
                    <p class="text-sm font-bold text-slate-500">يرجى اختيار المعلم الغائب لعرض جدول حصصه لليوم</p>
                </div>
            </div>

            <!-- All Substitutions Table -->
            <div class="bg-white rounded-3xl shadow-soft border border-slate-200 overflow-hidden mt-8">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <h3 class="font-extrabold text-slate-800 text-lg flex items-center gap-2"><i class="fas fa-list-ol text-[rgb(var(--color-primary-600))]"></i> سجل الاحتياط اليومي</h3>
                    <button onclick="window.app.printSubstitutions()" class="bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 px-4 py-2 rounded-xl font-bold text-xs flex items-center gap-2 transition shadow-sm">
                        <i class="fas fa-print"></i> طباعة / PDF
                    </button>
                </div>
                <div id="dailySubstitutionsList" class="divide-y divide-slate-100">
                    <!-- Populated by JS -->
                </div>
            </div>
        </section>

        <!-- View: Teachers -->
        <section id="view-teachers" class="fade-in space-y-6 hidden-view">
            <div class="sticky top-24 z-30 bg-white/95 backdrop-blur-md p-4 rounded-2xl shadow-sm border border-slate-200 mb-6 flex flex-col md:flex-row gap-4 justify-between items-center">
                <div class="flex items-center gap-3">
                    <h2 class="text-xl font-extrabold text-slate-900">سجل المعلمين</h2>
                    <span class="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded-md border border-slate-200" id="teachersCountBadge">0</span>
                </div>
                <div class="relative w-full md:w-80 group">
                    <input type="text" id="teacherSearch" onkeyup="window.app.renderTeachers()" placeholder="بحث سريع..." class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-[rgb(var(--color-primary-500))] focus:ring-4 focus:ring-[rgb(var(--color-primary-100))] transition-all outline-none text-sm font-medium text-slate-800 placeholder:text-slate-400">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-[rgb(var(--color-primary-600))] transition-colors"></i>
                </div>
            </div>
            <div id="teachersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 pb-20"></div>
        </section>

        <!-- View: Duty Schedule -->
        <section id="view-duty" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col md:flex-row justify-between gap-4 bg-white p-8 rounded-3xl shadow-soft border border-slate-200">
                <div class="flex items-center gap-5">
                    <div class="bg-gradient-to-br from-amber-400 to-orange-500 text-white w-16 h-16 rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-orange-200">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-extrabold text-slate-900">جدول المناوبة الأسبوعي</h2>
                        <p class="text-slate-600 font-medium text-sm mt-1">توزيع ومتابعة نقاط المناوبة</p>
                    </div>
                </div>
                <button onclick="window.app.addDutyLocationPrompt()" class="bg-slate-800 hover:bg-slate-700 text-white px-5 py-3 rounded-xl font-bold flex items-center gap-2 transition shadow-lg cursor-pointer text-sm">
                    <i class="fas fa-plus"></i><span>موقع جديد</span>
                </button>
            </div>

            <div class="bg-white rounded-3xl shadow-soft border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-right duty-table">
                        <thead class="bg-slate-50 border-b border-slate-200 text-slate-600 text-xs font-bold uppercase tracking-wider">
                            <tr>
                                <th class="p-5 sticky right-0 bg-slate-50 z-10 w-24 border-l border-slate-200 text-slate-700">اليوم</th>
                                <!-- Dynamic Headers -->
                                <template id="dutyHeaderTemplate"></template>
                                <tr id="dutyHeaderRow"></tr>
                            </tr>
                        </thead>
                        <tbody id="dutyBody" class="divide-y divide-slate-100 text-sm font-bold text-slate-700">
                            <!-- Rows generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- View: Periods -->
        <section id="view-periods" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col md:flex-row justify-between gap-4 bg-white p-8 rounded-3xl shadow-soft border border-slate-200">
                <div class="flex items-center gap-5">
                    <div class="bg-gradient-to-br from-sky-400 to-blue-500 text-white w-16 h-16 rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-blue-200">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-extrabold text-slate-900">ضبط توقيت الحصص</h2>
                        <p class="text-slate-600 font-medium text-sm mt-1">تعديل أوقات بدء وانتهاء اليوم الدراسي</p>
                    </div>
                </div>
            </div>

            <div id="periodsListContainer" class="space-y-3">
                <!-- JS will render periods here -->
            </div>
            
            <div class="mt-6">
                 <button onclick="window.app.addPeriod()" class="w-full bg-slate-50 hover:bg-slate-100 text-slate-700 border-2 border-dashed border-slate-200 hover:border-slate-300 px-5 py-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition cursor-pointer text-sm">
                    <i class="fas fa-plus"></i><span>إضافة حصة جديدة</span>
                </button>
            </div>
        </section>

        <!-- View: Supervision Hub -->
        <section id="view-supervision-hub" class="fade-in space-y-8 hidden-view">
            <div class="flex flex-col md:flex-row justify-between gap-6 bg-white p-8 rounded-3xl shadow-soft border border-slate-200 items-center">
                <div class="flex items-center gap-5">
                    <div class="bg-gradient-to-br from-purple-500 to-indigo-600 text-white w-16 h-16 rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-purple-200">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-extrabold text-slate-900">مركز الإشراف الفني</h2>
                        <p class="text-slate-600 font-medium text-sm mt-1">إدارة الزيارات الصفية وتقارير الأداء</p>
                    </div>
                </div>
                <button onclick="window.app.startSupervision()" class="bg-[rgb(var(--color-primary-600))] hover:bg-[rgb(var(--color-primary-700))] text-white px-8 py-4 rounded-2xl font-bold flex items-center gap-3 transition shadow-xl hover:shadow-2xl hover:-translate-y-1 cursor-pointer">
                    <i class="fas fa-plus-circle text-xl"></i>
                    <span>بدء زيارة جديدة</span>
                </button>
            </div>

            <div class="grid md:grid-cols-3 gap-6">
                <!-- Stats Cards -->
                <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-between h-40 card-hover">
                    <div class="flex justify-between items-start">
                        <div class="bg-blue-50 text-blue-600 w-12 h-12 rounded-2xl flex items-center justify-center text-xl"><i class="fas fa-chart-pie"></i></div>
                        <span class="text-xs font-bold text-slate-500 bg-slate-50 px-2 py-1 rounded-lg border border-slate-100">تراكمي</span>
                    </div>
                    <div>
                        <div class="text-3xl font-extrabold text-slate-900" id="hubTotalVisits">0</div>
                        <span class="text-xs text-slate-500 font-bold">إجمالي الزيارات</span>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-between h-40 card-hover">
                    <div class="flex justify-between items-start">
                        <div class="bg-emerald-50 text-emerald-600 w-12 h-12 rounded-2xl flex items-center justify-center text-xl"><i class="fas fa-star"></i></div>
                        <span class="text-xs font-bold text-slate-500 bg-slate-50 px-2 py-1 rounded-lg border border-slate-100">متوسط</span>
                    </div>
                    <div>
                        <div class="text-3xl font-extrabold text-slate-900" id="hubAvgScore">0%</div>
                        <span class="text-xs text-slate-500 font-bold">الأداء العام</span>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-center gap-3 h-40">
                    <button onclick="window.app.setView('supervision-history')" class="w-full bg-slate-50 hover:bg-slate-100 text-slate-700 py-2.5 rounded-xl font-bold text-xs transition flex items-center justify-between px-4 cursor-pointer border border-slate-200 hover:border-slate-300">
                        <span>سجل الزيارات الكامل</span><i class="fas fa-arrow-left text-slate-400"></i>
                    </button>
                    <button onclick="window.app.setView('reports')" class="w-full bg-slate-50 hover:bg-slate-100 text-slate-700 py-2.5 rounded-xl font-bold text-xs transition flex items-center justify-between px-4 cursor-pointer border border-slate-200 hover:border-slate-300">
                        <span>تقارير الأداء العام</span><i class="fas fa-arrow-left text-slate-400"></i>
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-soft border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <h3 class="font-extrabold text-slate-800 text-lg">أحدث الزيارات المسجلة</h3>
                    <i class="fas fa-history text-slate-300"></i>
                </div>
                <div id="hubRecentList" class="divide-y divide-slate-100"></div>
            </div>
        </section>

        <!-- View: Tasks -->
        <section id="view-tasks" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col gap-6 bg-white p-8 rounded-3xl shadow-soft border border-slate-200">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-extrabold text-slate-900">مهام المدير</h2>
                        <p class="text-slate-500 font-medium text-sm">قائمة المهام اليومية</p>
                    </div>
                    <div class="bg-[rgb(var(--color-primary-50))] px-4 py-2 rounded-xl border border-[rgb(var(--color-primary-100))]">
                        <span class="text-sm font-bold text-[rgb(var(--color-primary-800))]" id="tasksProgressText">0/0</span>
                    </div>
                </div>
                
                <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden">
                    <div id="tasksProgressBar" class="h-full bg-gradient-to-r from-[rgb(var(--color-primary-500))] to-purple-500 transition-all duration-700 ease-out w-0 rounded-full"></div>
                </div>
                
                <div class="flex gap-3 items-center bg-slate-50 p-2 rounded-2xl border border-slate-200 focus-within:ring-2 focus-within:ring-[rgb(var(--color-primary-200))] focus-within:border-[rgb(var(--color-primary-400))] transition-all">
                    <input type="text" id="newTaskInput" placeholder="أضف مهمة جديدة..." class="flex-1 bg-transparent border-none outline-none px-4 text-sm text-slate-800 font-bold placeholder:text-slate-400" onkeypress="if(event.key === 'Enter') window.app.addTask()">
                    <select id="newTaskPriority" class="text-xs bg-white border border-slate-200 rounded-xl px-3 py-2.5 outline-none text-slate-700 font-bold shadow-sm">
                        <option value="normal">عادي</option>
                        <option value="urgent">عاجل</option>
                    </select>
                    <button onclick="window.app.addTask()" class="bg-[rgb(var(--color-primary-600))] hover:bg-[rgb(var(--color-primary-700))] text-white w-10 h-10 rounded-xl flex items-center justify-center transition cursor-pointer shadow-md">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div id="tasksList" class="grid gap-3"></div>
        </section>

        <!-- View: Reports -->
        <section id="view-reports" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-6 rounded-3xl shadow-soft border border-slate-200">
                <div class="flex items-center gap-4">
                    <div class="bg-indigo-50 text-indigo-600 w-12 h-12 rounded-2xl flex items-center justify-center text-xl"><i class="fas fa-file-invoice"></i></div>
                    <div>
                        <h2 class="text-2xl font-extrabold text-slate-900">تقارير الأداء</h2>
                        <p class="text-slate-500 font-medium text-sm">تحليل شامل لبيانات المعلمين</p>
                    </div>
                </div>
                <div class="flex gap-3 w-full md:w-auto">
                    <button onclick="window.app.setView('supervision-history')" class="flex-1 md:flex-none bg-white text-slate-700 hover:bg-slate-50 border border-slate-200 px-5 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition cursor-pointer text-sm shadow-sm">
                        <i class="fas fa-history text-slate-400"></i><span>السجل</span>
                    </button>
                    <button onclick="window.app.exportReports()" class="flex-1 md:flex-none bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition shadow-lg shadow-emerald-100 cursor-pointer text-sm">
                        <i class="fas fa-file-excel"></i><span>تصدير Excel</span>
                    </button>
                </div>
            </div>
            <div class="bg-white rounded-3xl shadow-soft border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead class="bg-slate-50 border-b border-slate-200 text-slate-600 text-xs font-extrabold uppercase tracking-wider">
                            <tr>
                                <th class="p-5">المعلم</th>
                                <th class="p-5 text-center">التقييم</th>
                                <th class="p-5 text-center">الهاتف</th>
                                <th class="p-5 text-center">الحالة</th>
                            </tr>
                        </thead>
                        <tbody id="reportsBody" class="divide-y divide-slate-100 text-sm font-bold text-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- View: Supervision History -->
        <section id="view-supervision-history" class="fade-in space-y-6 hidden-view">
            <div class="flex justify-between items-center bg-white p-6 rounded-3xl shadow-soft border border-slate-200">
                <div class="flex items-center gap-3">
                    <button onclick="window.app.setView('supervision-hub')" class="bg-slate-50 hover:bg-slate-100 text-slate-600 w-10 h-10 rounded-xl flex items-center justify-center transition cursor-pointer border border-slate-200"><i class="fas fa-arrow-right"></i></button>
                    <h2 class="text-xl font-extrabold text-slate-900">سجل الزيارات</h2>
                </div>
            </div>
            <div id="supervisionHistoryGrid" class="space-y-4"></div>
        </section>

        <!-- View: Supervision Form -->
        <section id="view-supervision" class="fade-in space-y-6 hidden-view pb-24">
            <div class="flex items-center gap-2 mb-4 text-sm text-slate-500 font-bold cursor-pointer hover:text-[rgb(var(--color-primary-600))] transition" onclick="window.app.setView('supervision-hub')"><i class="fas fa-arrow-right"></i> عودة لمركز الإشراف</div>
            <div class="bg-white p-8 rounded-3xl shadow-soft border border-slate-200">
                <h2 class="text-2xl font-extrabold text-slate-900 mb-8 flex items-center gap-3 pb-4 border-b border-slate-100">
                    <span class="bg-[rgb(var(--color-primary-50))] text-[rgb(var(--color-primary-700))] w-10 h-10 rounded-xl flex items-center justify-center text-lg border border-[rgb(var(--color-primary-100))]"><i class="fas fa-magic"></i></span>
                    زيارة إشرافية ذكية
                </h2>
                
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <!-- Form Fields -->
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-600 mr-1">المعلم</label>
                        <input type="text" id="supTeacherName" readonly class="hidden w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-slate-800 font-extrabold">
                        <div class="relative">
                            <select id="supTeacherSelect" onchange="window.app.onTeacherSelectChange()" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-slate-800 focus:border-[rgb(var(--color-primary-500))] focus:bg-white focus:ring-4 focus:ring-[rgb(var(--color-primary-50))] outline-none appearance-none font-extrabold transition-all cursor-pointer">
                                <option value="">اختر المعلم...</option>
                            </select>
                            <i class="fas fa-chevron-down absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-600 mr-1">التخصص</label>
                        <div class="relative">
                            <select id="supSpecialization" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-slate-800 focus:border-[rgb(var(--color-primary-500))] focus:bg-white focus:ring-4 focus:ring-[rgb(var(--color-primary-50))] outline-none appearance-none font-extrabold transition-all cursor-pointer">
                                <option value="">اختر التخصص...</option>
                            </select>
                            <i class="fas fa-chevron-down absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-600 mr-1">الصف</label>
                        <input type="text" id="supClassName" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-slate-800 focus:border-[rgb(var(--color-primary-500))] focus:bg-white focus:ring-4 focus:ring-[rgb(var(--color-primary-50))] outline-none font-extrabold transition-all">
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-600 mr-1">عنوان الدرس</label>
                        <input type="text" id="supLessonTopic" placeholder="أدخل عنوان الدرس..." class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-slate-800 focus:border-[rgb(var(--color-primary-500))] focus:bg-white focus:ring-4 focus:ring-[rgb(var(--color-primary-50))] outline-none font-extrabold transition-all">
                    </div>
                    
                    <div class="md:col-span-2 space-y-2">
                        <label class="text-xs font-bold text-slate-600 mr-1">نوع المدرسة (لضبط صياغة التقرير)</label>
                        <div class="flex gap-4 items-center bg-slate-50 border border-slate-200 rounded-xl p-2 w-fit">
                            <label class="flex items-center gap-2 cursor-pointer px-3 py-1 hover:bg-white rounded-lg transition">
                                <input type="radio" id="supGenderMale" name="supSchoolGender" value="male" class="accent-[rgb(var(--color-primary-600))]" checked>
                                <span class="text-sm font-bold text-slate-700">بنين</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer px-3 py-1 hover:bg-white rounded-lg transition">
                                <input type="radio" id="supGenderFemale" name="supSchoolGender" value="female" class="accent-pink-600">
                                <span class="text-sm font-bold text-slate-700">بنات</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div id="supervisionCriteriaList" class="space-y-6"></div>
                
                <button onclick="window.app.generateReport()" class="w-full bg-gradient-to-r from-[rgb(var(--color-primary-600))] to-indigo-600 hover:from-[rgb(var(--color-primary-700))] hover:to-indigo-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-indigo-200 transition-all transform hover:-translate-y-1 mt-10 flex items-center justify-center gap-2 cursor-pointer text-lg">
                    <i class="fas fa-wand-magic-sparkles"></i> توليد التقرير الذكي
                </button>
            </div>
        </section>

        <!-- View: Supervision Report -->
        <section id="view-supervision-report" class="fade-in space-y-6 hidden-view bg-white p-8 md:p-12 rounded-none md:rounded-3xl shadow-none md:shadow-2xl min-h-screen md:min-h-0 print:min-h-0 border border-slate-200">
            <div class="border-b-2 border-slate-800 pb-6 mb-8 flex justify-between items-start">
                <div>
                    <h1 class="text-4xl font-extrabold text-slate-900 mb-2 font-serif">تقرير زيارة إشرافية</h1>
                    <p class="text-slate-600 text-sm font-bold tracking-wide">نظام الإدارة المدرسية الذكي</p>
                </div>
                <div class="text-left text-sm text-slate-600 font-bold">
                    <p id="reportDate" class="font-mono bg-slate-100 px-3 py-1 rounded-lg border border-slate-200"></p>
                </div>
            </div>
            
            <!-- Report Meta -->
            <div class="bg-slate-50 rounded-2xl p-6 border border-slate-200 mb-10">
                <div class="grid grid-cols-2 gap-y-6 text-sm">
                    <div class="flex flex-col"><span class="text-slate-500 text-xs font-bold mb-1">المعلم/ة</span> <span id="repTeacherName" class="font-extrabold text-slate-900 text-lg"></span></div>
                    <div class="flex flex-col"><span class="text-slate-500 text-xs font-bold mb-1">التخصص</span> <span id="repSpecialization" class="font-bold text-slate-800"></span></div>
                    <div class="flex flex-col"><span class="text-slate-500 text-xs font-bold mb-1">الصف</span> <span id="repClassName" class="font-bold text-slate-800"></span></div>
                    <div class="flex flex-col"><span class="text-slate-500 text-xs font-bold mb-1">عنوان الدرس</span> <span id="repLessonTopic" class="font-bold text-slate-800"></span></div>
                    <div class="col-span-2 flex flex-col"><span class="text-slate-500 text-xs font-bold mb-1">نوع المدرسة</span> <span id="repSchoolGender" class="font-bold text-slate-800"></span></div>
                </div>
            </div>
            
            <div class="mb-10">
                <h3 class="text-lg font-extrabold text-slate-900 mb-4 flex items-center gap-2">
                    <span class="w-8 h-8 rounded-lg bg-[rgb(var(--color-primary-100))] text-[rgb(var(--color-primary-800))] flex items-center justify-center text-sm"><i class="fas fa-list-ol"></i></span>
                    تفاصيل التقييم
                </h3>
                <div class="overflow-hidden rounded-2xl border border-slate-200">
                    <table class="w-full text-right text-sm">
                        <thead class="bg-slate-100 text-slate-600 font-bold border-b border-slate-200">
                            <tr><th class="p-4 w-1/2">البند</th><th class="p-4 text-center w-24">التقييم</th><th class="p-4">الملاحظات</th></tr>
                        </thead>
                        <tbody id="repDetailsBody" class="divide-y divide-slate-100 bg-white"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="mb-8 relative">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h3 class="text-lg font-extrabold text-[rgb(var(--color-primary-800))] flex items-center gap-2">
                        <span class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-600 to-indigo-700 text-white flex items-center justify-center text-sm shadow-md"><i class="fas fa-robot"></i></span>
                        التحليل النوعي والتوصيات
                    </h3>
                    <div class="flex gap-2 w-full md:w-auto">
                        <button onclick="window.app.copyToClipboardPrompt()" class="flex-1 md:flex-none text-xs bg-white text-slate-700 border border-slate-200 px-4 py-2.5 rounded-xl flex items-center justify-center gap-2 shadow-sm hover:bg-slate-50 transition cursor-pointer no-print font-bold">
                            <i class="fas fa-copy"></i><span>نسخ للأداة الخارجية</span>
                        </button>
                        <button onclick="window.app.enhanceReportWithAI()" class="flex-1 md:flex-none text-xs bg-slate-900 text-white px-5 py-2.5 rounded-xl flex items-center justify-center gap-2 shadow-lg hover:bg-slate-800 transition cursor-pointer no-print font-bold">
                            <i class="fas fa-wand-magic-sparkles text-yellow-400"></i><span>تحسين بالذكاء الاصطناعي</span>
                        </button>
                    </div>
                </div>
                
                <div id="aiReportContent" class="space-y-6 text-slate-800 font-medium leading-relaxed"></div>
                
                <!-- AI Loading -->
                <div id="aiLoadingOverlay" class="absolute inset-0 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center z-10 hidden-view rounded-3xl">
                    <div class="relative w-16 h-16 mb-4">
                        <div class="absolute inset-0 rounded-full border-4 border-slate-100"></div>
                        <div class="absolute inset-0 rounded-full border-4 border-[rgb(var(--color-primary-600))] border-t-transparent animate-spin"></div>
                    </div>
                    <span class="text-sm font-bold text-slate-800">جاري صياغة التقرير الاحترافي...</span>
                    <span class="text-xs text-slate-500 mt-1">يتم الاتصال بالمعالج الذكي</span>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="flex gap-3 mt-12 no-print border-t border-slate-100 pt-8">
                <button onclick="window.print()" class="flex-1 bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 cursor-pointer shadow-lg">
                    <i class="fas fa-print"></i> طباعة / PDF
                </button>
                <button onclick="window.app.saveVisit()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 cursor-pointer shadow-lg shadow-emerald-100">
                    <i class="fas fa-save"></i> حفظ
                </button>
                <button onclick="window.app.setView('supervision')" class="flex-1 bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 py-3 rounded-xl font-bold transition cursor-pointer">
                    تعديل
                </button>
                <button onclick="window.app.setView('supervision-history')" class="flex-1 bg-red-50 border border-red-100 text-red-600 hover:bg-red-100 py-3 rounded-xl font-bold transition cursor-pointer">
                    إغلاق
                </button>
            </div>
        </section>

        <!-- View: Help -->
        <section id="view-help" class="fade-in space-y-6 hidden-view">
             <div class="bg-white p-8 rounded-3xl shadow-soft border border-slate-200 text-center">
                <i class="fas fa-question-circle text-5xl text-[rgb(var(--color-primary-500))] mb-4"></i>
                <h2 class="text-2xl font-extrabold text-slate-800">مركز التعليمات</h2>
                <p class="text-slate-500 text-sm mt-1 font-medium">دليل سريع لاستخدام أهم ميزات التطبيق</p>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-soft border border-slate-200 space-y-4">
                 <h3 class="text-lg font-extrabold text-slate-800 border-b border-slate-100 pb-3 mb-4 flex items-center gap-3"><i class="fas fa-rocket text-[rgb(var(--color-primary-600))]"></i>البدء السريع</h3>
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                    <h4 class="font-bold text-slate-700 mb-2 text-sm">1. استيراد الجدول (ملف XML)</h4>
                    <p class="text-xs text-slate-600">اذهب إلى <button onclick="window.app.openSettings()" class="font-bold text-[rgb(var(--color-primary-600))] hover:underline">الإعدادات</button> واضغط على "رفع ملف XML" لاستيراد جدول الحصص من برنامج aSc Timetables.</p>
                </div>
                 <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                    <h4 class="font-bold text-slate-700 mb-2 text-sm">2. استيراد بيانات المعلمين (ملف Excel)</h4>
                    <p class="text-xs text-slate-600">لإضافة أرقام الهواتف والتخصصات، اذهب إلى <button onclick="window.app.openSettings()" class="font-bold text-[rgb(var(--color-primary-600))] hover:underline">الإعدادات</button> واضغط على "استيراد Excel".</p>
                </div>
                 <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                    <h4 class="font-bold text-slate-700 mb-2 text-sm">3. إدارة الاحتياط</h4>
                    <p class="text-xs text-slate-600">من قسم <button onclick="window.app.setView('reserve')" class="font-bold text-[rgb(var(--color-primary-600))] hover:underline">الاحتياط</button>، اختر المعلم الغائب وسيتم عرض حصصه. اضغط على "إيجاد بديل" لاختيار معلم متاح.</p>
                </div>
            </div>
        </section>

    </main>

    <!-- Hidden Printable Substitution Sheet -->
    <div id="printable-substitution-sheet" class="hidden-view bg-white p-8">
        <div class="text-center mb-8 border-b-2 border-slate-800 pb-4">
            <h1 class="text-3xl font-extrabold text-slate-900 mb-2">كشف حصص الاحتياط اليومي</h1>
            <p id="printDate" class="text-lg font-bold text-slate-600"></p>
        </div>
        <table class="w-full text-right border-collapse border border-slate-300">
            <thead>
                <tr class="bg-slate-100 text-slate-800">
                    <th class="p-3 border border-slate-300 font-extrabold">الحصة</th>
                    <th class="p-3 border border-slate-300 font-extrabold">الصف</th>
                    <th class="p-3 border border-slate-300 font-extrabold">المعلم الغائب</th>
                    <th class="p-3 border border-slate-300 font-extrabold">المعلم البديل</th>
                    <th class="p-3 border border-slate-300 font-extrabold">التوقيع</th>
                </tr>
            </thead>
            <tbody id="printSubstitutionBody" class="text-sm font-bold text-slate-700">
                <!-- Rows populated by JS -->
            </tbody>
        </table>
        <div class="mt-12 flex justify-between px-10">
            <div class="text-center font-bold">
                <p>مدير المدرسة</p>
                <div class="h-16"></div>
            </div>
            <div class="text-center font-bold">
                <p>يعتمد،</p>
                <div class="h-16"></div>
            </div>
        </div>
    </div>

    <!-- Floating Bottom Navigation (Modern) -->
    <div class="fixed bottom-4 left-4 right-4 z-40 no-print flex justify-center pointer-events-none">
        <nav class="bg-white/90 backdrop-blur-xl border border-white/40 shadow-[0_8px_30px_rgb(0,0,0,0.12)] rounded-2xl pointer-events-auto max-w-lg w-full">
            <div class="flex justify-around items-center h-16 px-2">
                <button onclick="window.app.setView('now')" id="btn-now" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-[rgb(var(--color-primary-700))] transition-all duration-300 group relative">
                    <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-[rgb(var(--color-primary-50))] group-hover:scale-110 transition-transform">
                        <i class="fas fa-chalkboard text-lg"></i>
                    </div>
                    <span class="text-[10px] font-bold">الحصص</span>
                </button>
                
                <button onclick="window.app.setView('reserve')" id="btn-reserve" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group">
                    <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors">
                        <i class="fas fa-user-clock text-lg"></i>
                    </div>
                    <span class="text-[10px] font-bold">الاحتياط</span>
                </button>

                <button onclick="window.app.setView('teachers')" id="btn-teachers" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group">
                    <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors">
                        <i class="fas fa-users-cog text-lg"></i>
                    </div>
                    <span class="text-[10px] font-bold">المعلمين</span>
                </button>

                <button onclick="window.app.setView('supervision-hub')" id="btn-supervision-hub" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group">
                    <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors">
                        <i class="fas fa-clipboard-user text-lg"></i>
                    </div>
                    <span class="text-[10px] font-bold">الزيارات</span>
                </button>
                
                <button onclick="window.app.setView('duty')" id="btn-duty" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group">
                    <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors">
                        <i class="fas fa-user-shield text-lg"></i>
                    </div>
                    <span class="text-[10px] font-bold">المناوبة</span>
                </button>

                <button onclick="window.app.setView('help')" id="btn-help" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group">
                    <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors">
                        <i class="fas fa-question-circle text-lg"></i>
                    </div>
                    <span class="text-[10px] font-bold">التعليمات</span>
                </button>
                
                <button onclick="window.app.setView('reports')" id="btn-reports" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group">
                    <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors">
                        <i class="fas fa-file-invoice text-lg"></i>
                    </div>
                    <span class="text-[10px] font-bold">التقارير</span>
                </button>
            </div>
        </nav>
    </div>
    
    </div>

    <!-- Modals (Re-styled) -->
    
    <!-- Substitute Modal -->
    <div id="modal-substitute" class="fixed inset-0 z-[60] flex items-end md:items-center justify-center p-0 md:p-4 hidden-view">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm modal-backdrop transition-opacity" onclick="window.app.closeModal('modal-substitute')"></div>
        <div class="bg-white w-full md:max-w-md rounded-t-3xl md:rounded-3xl shadow-2xl overflow-hidden animate-scale-in modal-content">
            <div class="bg-indigo-900 p-5 text-white flex justify-between items-center">
                <div>
                    <h3 class="font-bold flex items-center gap-2 text-lg"><i class="fas fa-chalkboard-teacher text-yellow-400"></i> معلم احتياط</h3>
                    <p class="text-indigo-200 text-xs mt-0.5 font-bold">اختيار البديل الأنسب بناءً على النصاب</p>
                </div>
                <button type="button" onclick="window.app.closeModal('modal-substitute')" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5">
                <div class="text-xs font-bold text-slate-500 mb-3 flex justify-between items-center bg-slate-50 p-2 rounded-lg border border-slate-100">
                    <span>المعلمون المتاحون</span>
                    <span id="subModalPeriodInfo" class="text-indigo-700 bg-indigo-50 px-2 py-0.5 rounded"></span>
                </div>
                <div id="substituteList" class="space-y-2 max-h-[60vh] overflow-y-auto custom-scrollbar"></div>
            </div>
        </div>
    </div>

    <!-- Action Modal -->
    <div id="modal-action" class="fixed inset-0 z-50 flex items-end md:items-center justify-center p-0 md:p-4 hidden-view">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm modal-backdrop" onclick="window.app.closeModal('modal-action')"></div>
        <div class="bg-white w-full md:max-w-md rounded-t-3xl md:rounded-3xl shadow-2xl overflow-hidden animate-scale-in modal-content mb-0 md:mb-20">
            <div class="bg-slate-800 p-5 text-white flex justify-between items-start">
                <div>
                    <h3 class="text-xl font-bold flex items-center gap-2" id="actionModalTitle"></h3>
                    <p id="actionModalSubtitle" class="text-slate-300 text-xs mt-1 flex items-center gap-1 font-medium"></p>
                </div>
                <button type="button" onclick="window.app.closeModal('modal-action')" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5 space-y-5 max-h-[70vh] overflow-y-auto custom-scrollbar">
                <button type="button" id="btn-evaluate" class="w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-700 border border-indigo-200 p-4 rounded-2xl font-bold text-sm flex items-center justify-center gap-3 transition cursor-pointer group shadow-sm">
                    <span class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm group-hover:scale-110 transition"><i class="fas fa-clipboard-list text-lg"></i></span>
                    <span>بدء تقييم زيارة إشرافية</span>
                </button>
                
                <div class="space-y-2">
                    <label class="text-[10px] font-extrabold text-slate-400 uppercase tracking-wider px-1">التواصل السريع</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" onclick="window.app.sendWhatsApp('summon')" class="bg-emerald-50 hover:bg-emerald-100 text-emerald-700 border border-emerald-100 p-3 rounded-2xl font-bold text-xs flex flex-col items-center gap-2 transition cursor-pointer">
                            <i class="fab fa-whatsapp text-2xl"></i><span>استدعاء للإدارة</span>
                        </button>
                        <button type="button" id="btn-remind" onclick="window.app.sendWhatsApp('remind')" class="bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-100 p-3 rounded-2xl font-bold text-xs flex flex-col items-center gap-2 transition cursor-pointer disabled:opacity-50">
                            <i class="fas fa-bell text-2xl"></i><span>تذكير بالحصة</span>
                        </button>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <label class="text-[10px] font-extrabold text-slate-400 uppercase tracking-wider px-1">المخالفات الإدارية</label>
                    <div id="violationButtonsContainer" class="space-y-2"></div>
                </div>
            </div>
             <div class="bg-slate-50 p-4 text-center border-t border-slate-100 flex justify-between items-center px-6">
                 <span class="text-xs text-slate-500 font-bold">التقييم الحالي</span>
                 <span class="text-xl font-extrabold text-slate-800" id="currentScoreDisplay"></span>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="modal-settings" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden-view">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm modal-backdrop" onclick="window.app.closeModal('modal-settings')"></div>
        <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden animate-scale-in flex flex-col max-h-[85vh] modal-content">
            <div class="bg-slate-800 text-white p-6 flex justify-between items-center shrink-0">
                <h3 class="text-xl font-bold flex items-center gap-3"><i class="fas fa-cog text-slate-400"></i> الإعدادات</h3>
                <button type="button" onclick="window.app.closeModal('modal-settings')" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scrollbar space-y-8">
                <!-- Theme -->
                <div class="space-y-3">
                    <h4 class="font-extrabold text-slate-800 text-sm border-b border-slate-100 pb-2">المظهر العام</h4>
                    <div id="themeSelectorContainer" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                </div>
                
                <!-- Gender -->
                <div class="space-y-3">
                    <h4 class="font-extrabold text-slate-800 text-sm border-b border-slate-100 pb-2">نوع المدرسة الافتراضي</h4>
                    <div id="schoolGenderSelectorContainer" class="flex gap-4 items-center bg-slate-50 border border-slate-200 rounded-xl p-3">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="defaultSchoolGender" value="male" onchange="window.app.setDefaultSchoolGender('male')" class="accent-[rgb(var(--color-primary-600))]"><span class="text-sm font-bold text-slate-700">بنين</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="defaultSchoolGender" value="female" onchange="window.app.setDefaultSchoolGender('female')" class="accent-pink-600"><span class="text-sm font-bold text-slate-700">بنات</span></label>
                    </div>
                </div>

                <!-- Support Section -->
                <div class="space-y-3">
                    <h4 class="font-extrabold text-slate-800 text-sm border-b border-slate-100 pb-2">الدعم الفني</h4>
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-center">
                         <p class="text-sm text-slate-600 mb-3">تصميم وبرمجة: الأستاذ عادل الغزيلي</p>
                         <a href="https://wa.me/96598882855" target="_blank" class="inline-flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold text-sm transition shadow-md shadow-emerald-100">
                             <i class="fab fa-whatsapp"></i> تواصل عبر واتساب
                         </a>
                    </div>
                </div>
                
                <!-- Dev Settings -->
                <div id="developerSettingsSection" class="hidden-view space-y-4 bg-red-50 p-5 rounded-2xl border border-red-100 relative">
                    <div class="flex items-center justify-between pb-2 border-b border-red-200">
                        <h4 class="font-bold text-red-900 flex items-center gap-2 text-sm"><i class="fas fa-shield-alt text-red-500"></i> إعدادات المطور</h4>
                        <button onclick="window.app.enableDevEdit()" class="text-xs bg-white text-red-600 px-3 py-1 rounded-lg border border-red-200 hover:bg-red-50 transition cursor-pointer"><i class="fas fa-lock-open mr-1"></i> تعديل</button>
                    </div>
                    <div class="space-y-3">
                        <label class="text-[10px] font-bold text-red-800 uppercase tracking-wider">Cloud Function URL</label>
                        <input type="text" id="settingCloudUrl" disabled class="w-full text-xs p-3 rounded-xl border border-red-200 bg-white/50 text-slate-600 dir-ltr text-left disabled:opacity-70 font-mono">
                        
                        <button onclick="window.app.saveDevSettings()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 rounded-xl text-xs shadow-md transition cursor-pointer"><i class="fas fa-save mr-1"></i> حفظ</button>
                    </div>
                </div>

                <!-- Violations -->
                <div class="space-y-3">
                    <h4 class="font-extrabold text-slate-800 text-sm border-b border-slate-100 pb-2">إدارة المخالفات</h4>
                    <div class="flex gap-2 bg-slate-50 p-3 rounded-xl border border-slate-200 items-end">
                        <div class="flex-1 space-y-1">
                            <label class="text-[10px] font-bold text-slate-500">اسم المخالفة</label>
                            <input type="text" id="newViolationLabel" placeholder="مثلاً: عدم تحضير" class="w-full text-sm p-2 bg-white rounded-lg border border-slate-200 outline-none focus:border-[rgb(var(--color-primary-500))] font-bold text-slate-700">
                        </div>
                        <div class="w-20 space-y-1">
                            <label class="text-[10px] font-bold text-slate-500">الخصم</label>
                            <input type="number" id="newViolationPoints" value="5" class="w-full text-sm p-2 bg-white rounded-lg border border-slate-200 outline-none focus:border-[rgb(var(--color-primary-500))] text-center font-bold text-slate-700">
                        </div>
                        <button type="button" onclick="window.app.addViolation()" class="bg-slate-800 hover:bg-slate-900 text-white p-2 rounded-lg h-[38px] w-10 flex items-center justify-center transition cursor-pointer"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="violationsList" class="space-y-2"></div>
                </div>
                
                <!-- Specializations -->
                <div class="space-y-3">
                    <h4 class="font-extrabold text-slate-800 text-sm border-b border-slate-100 pb-2">إدارة التخصصات</h4>
                    <div class="flex gap-2 bg-slate-50 p-3 rounded-xl border border-slate-200 items-center">
                        <input type="text" id="newSpecInput" placeholder="أضف تخصص جديد..." class="flex-1 text-sm p-2 bg-white rounded-lg border border-slate-200 outline-none focus:border-[rgb(var(--color-primary-500))] font-bold text-slate-700">
                        <button type="button" onclick="window.app.addSpecialization()" class="bg-slate-800 hover:bg-slate-900 text-white p-2 rounded-lg h-[38px] w-10 flex items-center justify-center transition cursor-pointer"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="specializationsList" class="flex flex-wrap gap-2"></div>
                </div>
                
                <!-- Import/Export Tools -->
                <div class="space-y-3">
                    <h4 class="font-extrabold text-slate-800 text-sm border-b border-slate-100 pb-2">أدوات البيانات</h4>
                    
                    <!-- Supervisor Tools -->
                    <div class="bg-orange-50 p-4 rounded-2xl border border-orange-100">
                        <h5 class="text-xs font-bold text-orange-800 mb-2 flex items-center gap-2"><i class="fas fa-user-tie"></i> أدوات المشرف التربوي</h5>
                        <div class="flex gap-2">
                            <button type="button" onclick="window.app.exportTeacherTemplate()" class="flex-1 bg-white border border-orange-200 text-orange-700 hover:bg-orange-100 py-2 rounded-lg font-bold text-xs transition cursor-pointer"><i class="fas fa-download mr-1"></i> نموذج المشرف</button>
                            <button type="button" onclick="document.getElementById('excelInput').click()" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white py-2 rounded-lg font-bold text-xs transition cursor-pointer shadow-sm"><i class="fas fa-upload mr-1"></i> استيراد القائمة</button>
                        </div>
                    </div>
                    
                    <!-- Criteria DB -->
                    <div class="bg-purple-50 p-4 rounded-2xl border border-purple-100">
                        <h5 class="text-xs font-bold text-purple-800 mb-2 flex items-center gap-2"><i class="fas fa-database"></i> قاعدة بيانات الزيارات</h5>
                        <button type="button" onclick="document.getElementById('criteriaExcelInput').click()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-bold text-xs transition cursor-pointer shadow-sm">
                            <i class="fas fa-upload mr-1"></i> استيراد قاعدة المعايير (Excel)
                        </button>
                        <input type="file" id="criteriaExcelInput" accept=".xlsx, .xls" class="hidden" onchange="window.app.handleCriteriaExcel(event)">
                    </div>

                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-[rgb(var(--color-primary-50))] p-4 rounded-2xl border border-[rgb(var(--color-primary-100))]">
                            <h5 class="font-bold text-[rgb(var(--color-primary-900))] mb-2 flex items-center gap-2 text-xs"><i class="fas fa-calendar-alt"></i> جدول الحصص (XML)</h5>
                            <button type="button" onclick="document.getElementById('xmlInput').click()" class="w-full bg-white hover:bg-[rgb(var(--color-primary-50))] text-[rgb(var(--color-primary-700))] border border-[rgb(var(--color-primary-200))] py-2 rounded-lg font-bold text-xs transition cursor-pointer">رفع ملف XML</button>
                            <input type="file" id="xmlInput" accept=".xml" class="hidden" onchange="window.app.handleXml(event)">
                        </div>
                        <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                            <h5 class="font-bold text-emerald-900 mb-2 flex items-center gap-2 text-xs"><i class="fas fa-users"></i> بيانات المعلمين (Excel)</h5>
                            <button type="button" onclick="document.getElementById('excelInput').click()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg font-bold text-xs transition cursor-pointer shadow-sm"><i class="fas fa-upload mr-1"></i> استيراد Excel</button>
                            <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden" onchange="window.app.handleExcel(event)">
                        </div>
                    </div>
                </div>
                
                <!-- Danger Zone -->
                <div class="mt-8 pt-4 border-t border-slate-100">
                    <button onclick="window.app.deleteData()" class="w-full bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 py-3 rounded-xl font-bold text-xs transition flex items-center justify-center gap-2 cursor-pointer">
                        <i class="fas fa-trash-alt"></i> حذف جميع البيانات وإعادة تعيين
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        class SchoolApp {
            constructor() {
                this.state = {
                    currentUser: null, teachers: [], periods: [], classes: {}, tasks: [], agenda: [], 
                    violationTypes: [{ id: 'late', label: 'تأخر عن الحصة', points: 5, icon: 'fa-clock' }, { id: 'absent', label: 'غياب عن الحصة', points: 15, icon: 'fa-user-slash' }],
                    specializations: ["تربية اسلامية", "لغة عربية", "علوم", "أحياء", "كيمياء", "فيزياء", "الدراسات الاجتماعية", "اللغة الانجليزية", "المهارات الحياتية", "الرياضة المدرسية", "الفنون التشكيلية", "الفنون الموسيقية"],
                    simulationOffset: 0, selectedTeacherId: null, selectedClassName: null, supervisionData: { ratings: {}, notes: {}, gender: 'male' }, supervisionHistory: [], evaluationCriteria: [],
                    // Duty System Data
                    dutyLocations: ["البوابة الرئيسية", "الساحة الأمامية", "المقصف", "الممرات"],
                    dutySchedule: {}, 
                    substitutions: {}, // Key: "Date_Period_Class" -> Value: SubstituteTeacherID
                    selectedAbsentTeacherId: null, // Persist selection across re-renders
                    
                    theme: 'default', defaultSchoolGender: 'male', cloudStatus: 'offline', unsubscribe: null, aiReportData: null, cloudFunctionUrl: "https://improvetext-cewovb6fwq-uc.a.run.app"
                };
                this.db = null; this.auth = null;
                this.initDefaultCriteria();
                this.loadLocalData();
                this.initFirebaseAndAuth();
                this.startClock();
                this.bindAuthEvents();
            }

            bindAuthEvents() {
                document.getElementById('googleLoginBtn')?.addEventListener('click', () => this.handleGoogleLogin());
                document.getElementById('guestLoginBtn')?.addEventListener('click', () => this.skipLogin());
            }

            loadLocalData() {
                const stored = localStorage.getItem('school_data_v1');
                if (stored) {
                    try {
                        const data = JSON.parse(stored);
                        if (data.teachers) this.state.teachers = data.teachers;
                        if (data.periods) this.state.periods = data.periods;
                        if (data.classes) this.state.classes = data.classes;
                        if (data.tasks) this.state.tasks = data.tasks;
                        if (data.agenda) this.state.agenda = data.agenda;
                        if (data.violationTypes) this.state.violationTypes = data.violationTypes;
                        if (data.specializations) this.state.specializations = data.specializations;
                        if (data.supervisionHistory) this.state.supervisionHistory = data.supervisionHistory;
                        if (data.theme) this.state.theme = data.theme;
                        if (data.defaultSchoolGender) this.state.defaultSchoolGender = data.defaultSchoolGender;
                        if (data.cloudFunctionUrl) this.state.cloudFunctionUrl = data.cloudFunctionUrl;
                        if (data.evaluationCriteria && data.evaluationCriteria.length > 0) this.state.evaluationCriteria = data.evaluationCriteria;
                        if (data.dutyLocations) this.state.dutyLocations = data.dutyLocations;
                        if (data.dutySchedule) this.state.dutySchedule = data.dutySchedule;
                        if (data.substitutions) this.state.substitutions = data.substitutions;
                        this.applyTheme();
                    } catch(e) { console.error('Local Load Error', e); }
                }
            }

            initFirebaseAndAuth() {
                const firebaseConfig = { apiKey: "AIzaSyC4NddjijF29YNhowy4SqgRaMPn01oSSEg", authDomain: "school-9416e.firebaseapp.com", projectId: "school-9416e", storageBucket: "school-9416e.firebasestorage.app", messagingSenderId: "680872052240", appId: "1:680872052240:web:96d2e544166ab5f8096c95", measurementId: "G-5EBTV0MV83" };
                try {
                    if (typeof firebase !== 'undefined' && !firebase.apps.length) firebase.initializeApp(firebaseConfig);
                    if (typeof firebase !== 'undefined') {
                        this.db = firebase.firestore(); this.auth = firebase.auth();
                        this.auth.onAuthStateChanged(user => {
                            if (user) {
                                this.state.currentUser = { uid: user.uid, name: user.displayName, photoURL: user.photoURL, email: user.email };
                                document.getElementById('login-view')?.classList.add('hidden-view'); 
                                document.getElementById('app-view')?.classList.remove('hidden-view');
                                this.renderUserProfile(); this.loadUserData();
                            }
                        });
                    }
                } catch (e) { console.error("Firebase Init Error:", e); }
            }

            handleGoogleLogin() { const provider = new firebase.auth.GoogleAuthProvider(); this.auth.signInWithPopup(provider).catch(e => alert("فشل تسجيل الدخول")); }
            skipLogin() { document.getElementById('login-view')?.classList.add('hidden-view'); document.getElementById('app-view')?.classList.remove('hidden-view'); this.renderAll(); document.getElementById('user-profile-container').innerHTML = `<div class="flex items-center gap-3 bg-white/50 px-3 py-1.5 rounded-xl border border-slate-200"><div class="text-xs font-bold text-slate-600 flex items-center gap-2"><i class="fas fa-user-shield text-slate-500"></i><span>زائر</span></div><div class="h-4 w-px bg-slate-300 mx-1"></div><button onclick="window.app.handleLogout()" class="text-red-500 hover:text-red-700 transition cursor-pointer" title="خروج"><i class="fas fa-sign-out-alt"></i></button></div>`; }
            handleLogout() { if(confirm('هل تريد تسجيل الخروج؟')) { if(this.auth && this.state.currentUser) this.auth.signOut().catch(()=>{}); this.state.currentUser = null; document.getElementById('app-view')?.classList.add('hidden-view'); document.getElementById('login-view')?.classList.remove('hidden-view'); document.getElementById('user-profile-container').innerHTML = ''; } }
            
            renderUserProfile() {
                const container = document.getElementById('user-profile-container'); if(!container) return;
                if (this.state.currentUser) {
                    container.innerHTML = `
                        <div class="flex items-center gap-3 bg-slate-100 px-3 py-1.5 rounded-xl border border-slate-200">
                            <img src="${this.state.currentUser.photoURL || 'https://ui-avatars.com/api/?name='+this.state.currentUser.name}" class="w-8 h-8 rounded-full border-2 border-white shadow-sm">
                            <div class="hidden md:block text-xs text-slate-800 font-bold">
                                <div>${this.state.currentUser.name}</div>
                            </div>
                            <div class="h-4 w-px bg-slate-300 mx-1"></div>
                            <button onclick="window.app.handleLogout()" class="text-red-500 hover:text-red-700 transition cursor-pointer" title="تسجيل خروج">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>`;
                } else {
                    container.innerHTML = '';
                }
            }

            loadUserData() {
                if (!this.state.currentUser) return;
                if (this.state.unsubscribe) this.state.unsubscribe();
                this.updateCloudStatus('connecting');
                this.state.unsubscribe = this.db.collection("users").doc(this.state.currentUser.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        this.state.teachers = data.teachers || []; this.state.periods = data.periods || []; this.state.classes = data.classes || {}; this.state.tasks = data.tasks || []; this.state.agenda = data.agenda || [];
                        if (data.violationTypes) this.state.violationTypes = data.violationTypes; if (data.specializations) this.state.specializations = data.specializations; if (data.supervisionHistory) this.state.supervisionHistory = data.supervisionHistory;
                        if (data.theme) this.state.theme = data.theme; if (data.defaultSchoolGender) this.state.defaultSchoolGender = data.defaultSchoolGender;
                        if (data.evaluationCriteria) this.state.evaluationCriteria = data.evaluationCriteria;
                        if (data.dutyLocations) this.state.dutyLocations = data.dutyLocations;
                        if (data.dutySchedule) this.state.dutySchedule = data.dutySchedule;
                        if (data.substitutions) this.state.substitutions = data.substitutions;
                        this.applyTheme(); this.renderAll(); this.updateCloudStatus('connected'); this.saveDataToLocal();
                    } else { this.saveData(); }
                }, e => this.updateCloudStatus('error'));
            }

            saveDataToLocal() { localStorage.setItem('school_data_v1', JSON.stringify({ teachers: this.state.teachers, periods: this.state.periods, classes: this.state.classes, tasks: this.state.tasks, agenda: this.state.agenda, violationTypes: this.state.violationTypes, specializations: this.state.specializations, supervisionHistory: this.state.supervisionHistory, theme: this.state.theme, defaultSchoolGender: this.state.defaultSchoolGender, cloudFunctionUrl: this.state.cloudFunctionUrl, evaluationCriteria: this.state.evaluationCriteria, dutyLocations: this.state.dutyLocations, dutySchedule: this.state.dutySchedule, substitutions: this.state.substitutions })); }
            async saveData() {
                this.saveDataToLocal(); if (!this.state.currentUser) { this.updateCloudStatus('local'); return; }
                this.updateCloudStatus('saving');
                try { await this.db.collection("users").doc(this.state.currentUser.uid).set({ teachers: this.state.teachers, periods: this.state.periods, classes: this.state.classes, tasks: this.state.tasks, agenda: this.state.agenda, violationTypes: this.state.violationTypes, specializations: this.state.specializations, supervisionHistory: this.state.supervisionHistory, theme: this.state.theme, defaultSchoolGender: this.state.defaultSchoolGender, evaluationCriteria: this.state.evaluationCriteria, dutyLocations: this.state.dutyLocations, dutySchedule: this.state.dutySchedule, substitutions: this.state.substitutions, lastSync: new Date(), userName: this.state.currentUser.name }, { merge: true }); this.updateCloudStatus('connected'); } catch (e) { this.updateCloudStatus('error'); }
            }

            updateCloudStatus(status) { const el = document.getElementById('cloudStatusIndicator'); if(!el) return; if(status === 'connected') el.innerHTML = '<span class="text-emerald-600 bg-emerald-50 px-2 py-1 rounded-lg text-[10px] font-bold border border-emerald-100 flex items-center gap-1"><i class="fas fa-check-circle"></i> متصل</span>'; else if(status === 'saving') el.innerHTML = '<span class="text-amber-600 bg-amber-50 px-2 py-1 rounded-lg text-[10px] font-bold border border-amber-100 flex items-center gap-1"><i class="fas fa-sync fa-spin"></i> حفظ...</span>'; else if(status === 'local') el.innerHTML = '<span class="text-slate-600 bg-slate-50 px-2 py-1 rounded-lg text-[10px] font-bold border border-slate-200 flex items-center gap-1"><i class="fas fa-hdd"></i> محلي</span>'; else el.innerHTML = '<span class="text-red-600 bg-red-50 px-2 py-1 rounded-lg text-[10px] font-bold border border-red-100 flex items-center gap-1"><i class="fas fa-exclamation-triangle"></i> خطأ</span>'; }

            initDefaultCriteria() {
                this.state.evaluationCriteria = [
                    { id: 1, title: "التحصيل الدراسي", subtitle: "(تحصيل الطلبة في الأعمال الصفية وغير الصفية)", items: { 1: { desc: "اكتسب جميع الطلبة المهارات الأساسية والمعارف بصورة فعالة.", rec: "تنفيذ مبادرة تربوية تعزز من اكتساب الطلبة للمهارات والمعارف." }, 2: { desc: "يكتسب معظم الطلبة المهارات الأساسية والمعارف بصورة فاعلة.", rec: "تكثيف الأنشطة الإثرائية التي تستهدف الطلبة ذوي المستوى المرتفع." }, 3: { desc: "يكتسب أغلب الطلبة المهارات الأساسية بصورة ملائمة.", rec: "التركيز على تصميم أنشطة صفية متمايزة تضمن اكتساب جميع الطلبة للمهارات." }, 4: { desc: "اكتسب قلة من الطلبة المهارات الأساسية بصورة محدودة.", rec: "تنفيذ حصص تقوية للطلبة واستغلال حصص الاحتياطي لتكثيف الخطط العلاجية." }, 5: { desc: "يكتسب عدد نادر من الطلبة المهارات الأساسية.", rec: "وضع خطة علاجية فورية وشاملة وحصر المهارات المتأخرة." } } },
                    { id: 2, title: "التقدم الدراسي", subtitle: "(التقدم في المعارف والمهارات أثناء الحصة)", items: { 1: { desc: "يتقدم جميع الطلبة في المعارف والمفاهيم والمهارات بصورة متميزة.", rec: "تنفيذ قراءة موجهة لزملاء العمل لآلية تطبيق هرم بلوم." }, 2: { desc: "يتقدم معظم الطلبة دراسياً أثناء الحصة بصورة فاعلة.", rec: "الحرص على مراجعة آليات تفريد التعليم المقدمة للطلبة." }, 3: { desc: "يتقدم أغلب الطلبة دراسياً أثناء الحصة بصورة ملائمة.", rec: "ضمان توظيف هرم بلوم للأهداف بفاعلية في صياغة أسئلة الحصة." }, 4: { desc: "اكتسب بعض الطلبة المعارف والمفاهيم بصورة محدودة.", rec: "تطبيق مشروع تفريد التعلم وتنفيذ الخطط الفردية." }, 5: { desc: "يتقدم عدد نادر من الطلبة دراسياً بصورة محدودة جداً.", rec: "البدء فوراً في تنفيذ الخطط الفردية وتفريد التعلم." } } },
                    { id: 3, title: "مهارات التعلم", subtitle: "(التعلم الذاتي، التعاوني، والرقمي)", items: { 1: { desc: "يطبق جميع الطلبة مهارات التعلم الذاتي والتعاوني والرقمي بصورة متميزة.", rec: "تنفيذ قراءة موجهة لآلية طرح أسئلة مثيرة للتفكير." }, 2: { desc: "يطبق معظم الطلبة مهارات التعلم بمستوى فاعل.", rec: "تعزيز توظيف المنصات الرقمية لتدريب الطلبة على التعلم الذاتي." }, 3: { desc: "يطبق أغلب الطلبة مهارات التعلم بمستوى ملائم.", rec: "إدراج أنشطة صفية محددة تهدف لتنمية مهارات التفكير الناقد." }, 4: { desc: "اكتسب بعض الطلبة مهارات التعلم الذاتي بصورة محدودة.", rec: "تنفيذ مشروع يهدف إلى تنمية مهارات التعلم الذاتي والرقمي." }, 5: { desc: "يطبق عدد نادر من الطلبة مهارات التعلم بمستوى محدود جداً.", rec: "التركيز على تدريب الطلبة على أبسط مهارات التعلم ودمجها في الدرس." } } },
                    { id: 4, title: "القيم والسلوك", subtitle: "(الانضباط، الهوية الوطنية، القيم الإنسانية)", items: { 1: { desc: "يدرك جميع الطلبة للحقوق والواجبات ويعتزون بهويتهم العمانية.", rec: "تعزيز وتحفيز الطلبة بنماذج وملصقات تعبر عن الهوية العمانية." }, 2: { desc: "يلتزم معظم الطلبة بالقيم الإنسانية المشتركة بمستوى فاعل.", rec: "تصميم أنشطة إثرائية لتعزيز القيم الإيجابية لدى الطلبة." }, 3: { desc: "يلتزم أغلب الطلبة بالقيم الإنسانية المشتركة بمستوى ملائم.", rec: "توفير فرص للطلبة لممارسة التعبير عن الذات والحوار بثقة." }, 4: { desc: "يدرك بعض الطلبة الحقوق والواجبات بصورة محدودة.", rec: "تنفيذ مشروع يهدف إلى تنمية مهارات التعلم والسلوك وتعزيز الهوية." }, 5: { desc: "يلتزم عدد نادر من الطلبة بالقيم الإنسانية.", rec: "وضع خطة سلوكية مركزة لعلاج حالات عدم الانضباط في الحصة." } } },
                    { id: 5, title: "جودة بيئة التعلم", subtitle: "(الأمن والسلامة، النظافة، الجاذبية)", items: { 1: { desc: "يتابع المعلم جميع جوانب الأمن والسلامة والنظافة بصورة متميزة.", rec: "تنفيذ حصة تطبيقية حول جوانب الأمن والسلامة في البيئة الصفية." }, 2: { desc: "يتابع المعلم جوانب الأمن والسلامة بصورة جيدة.", rec: "توثيق الممارسات المتميزة في جوانب الأمن والسلامة وتعميمها." }, 3: { desc: "يتابع المعلم جوانب الأمن والسلامة بصورة مناسبة.", rec: "التأكد من تطبيق سياسات الأمن والسلامة في جميع الأنشطة الصفية." }, 4: { desc: "يتابع بعض جوانب الأمن والسلامة بصورة محدودة.", rec: "الالتزام بتدابير الأمن والسلامة في البيئة الصفية (أسلاك مكشوفة..)." }, 5: { desc: "يتابع المعلم جوانب الأمن والسلامة بصورة نادرة.", rec: "اتخاذ إجراءات تصحيحية فورية لضمان سلامة الطلبة." } } },
                    { id: 6, title: "تخطيط المنهاج الدراسي", subtitle: "(التسلسل، ارتباط الأهداف، النواتج)", items: { 1: { desc: "يخطط لجميع دروسه متسلسلاً في تنوع الأهداف بصورة متميزة.", rec: "تنفيذ ورشة تدريبية لكيفية التخطيط للدرس بما يتوافق مع الخطة الفصلية." }, 2: { desc: "يخطط المعلم معظم دروسه بصورة جيدة.", rec: "تطوير التخطيط اليومي عبر إضافة أنشطة إثرائية وخطط علاجية واضحة." }, 3: { desc: "يخطط المعلم أغلب دروسه بصورة مناسبة.", rec: "مراجعة التخطيط للتأكد من ربط الأهداف بنواتج التعلم المحددة." }, 4: { desc: "يخطط لبعض دروسه بصورة محدودة.", rec: "الالتزام بتوافق أهداف خطة الدرس مع الخطة الفصلية." }, 5: { desc: "يخطط المعلم عدد محدود جداً من دروسه بصورة نادرة.", rec: "الالتزام الفوري بإعداد خطط الدروس اليومية بشكل متكامل." } } },
                    { id: 7, title: "إدارة الصف", subtitle: "(إدارة الوقت، السلوك، الدافعية)", items: { 1: { desc: "يقوم بإدارة زمن التعلم وإدارة سلوكيات جميع الطلبة بصورة فعالة.", rec: "العمل على تحليل نتائج الطلبة وتوثيق الأسئلة العاصفة للذهن." }, 2: { desc: "يقوم المعلم بإدارة زمن التعلم بصورة جيدة.", rec: "إدراج استراتيجيات مبتكرة لإدارة سلوكيات الطلبة وتعزيز دافعيتهم." }, 3: { desc: "يقوم المعلم بإدارة زمن التعلم وسلوك طلبته بصورة ملائمة.", rec: "الاستمرار في الإدارة الجيدة للحصة والتركيز على تحويل السلوكيات السلبية." }, 4: { desc: "يقوم بإدارة زمن التعلم بصورة محدودة.", rec: "الالتزام بزمن التعلم والعمل على إدارة وقت الحصة بشكل فعال." }, 5: { desc: "يقوم المعلم بإدارة زمن التعلم وسلوك طلبته بصورة نادرة.", rec: "تطبيق قواعد صارمة لإدارة الصف والالتزام بالخطة الزمنية." } } },
                    { id: 8, title: "فاعلية التدريس", subtitle: "(استراتيجيات التدريس، التمايز، التعلم النشط)", items: { 1: { desc: "يوظف استراتيجيات التدريس والتقنيات الحديثة بصورة فعالة.", rec: "تصميم دليل رقمي لبعض المنصات الرقمية وبرامج الذكاء الاصطناعي." }, 2: { desc: "يوظف المعلم استراتيجيات تدريس فعالة يستفيد منها معظم الطلبة.", rec: "توسيع نطاق توظيف برامج الذكاء الاصطناعي في تصميم الأنشطة المتمايزة." }, 3: { desc: "يوظف المعلم استراتيجيات تدريس يستفيد منها أغلب الطلبة.", rec: "التنويع في استراتيجيات التدريس لضمان تلبية احتياجات جميع الطلبة." }, 4: { desc: "يوظف استراتيجيات التدريس بصورة محدودة (التلقين).", rec: "العمل على التنويع من مصادر التعلم وتحديدها وفقاً لاحتياجات الطلبة." }, 5: { desc: "يوظف استراتيجيات تدريس يستفيد منها عدد قليل جداً.", rec: "استبدال استراتيجيات التلقين باستراتيجيات التعلم النشط." } } },
                    { id: 9, title: "تفعيل المصادر والموارد", subtitle: "(التقنيات الرقمية، الوسائل التعليمية)", items: { 1: { desc: "يفعل المعلم التقنيات الرقمية بحيث يستفيد منها جميع الطلبة.", rec: "توثيق أفضل ممارسات توظيف التقنيات الرقمية والذكاء الاصطناعي." }, 2: { desc: "يفعل المعلم التقنيات الرقمية بحيث يستفيد منها معظم الطلبة.", rec: "تشجيع الطلبة على استخدام التقنيات الرقمية كأداة للإنتاج المعرفي." }, 3: { desc: "يفعل المعلم التقنيات الرقمية بحيث يستفيد منها أغلب الطلبة.", rec: "العمل على دمج المصادر الرقمية والتقليدية في خطة الدرس بطريقة فعالة." }, 4: { desc: "يفعل المعلم التقنيات الرقمية بصورة محدودة.", rec: "العمل على تنويع المصادر والموارد التعليمية ودمج المنصات." }, 5: { desc: "يفعل المعلم التقنيات الرقمية بصورة نادرة أو منعدمة.", rec: "البدء فوراً في تفعيل المصادر والموارد التعليمية المتاحة." } } },
                    { id: 10, title: "التقويم ومساندة التقدم", subtitle: "(تنوع الأساليب، التغذية الراجعة، مراعاة الفروق)", items: { 1: { desc: "يوظف أساليب تقويم متنوعة تراعي التمايز بين جميع الطلبة.", rec: "تشكيل فريق عمل لصياغة مجموعة أنشطة صفية تراعي المستويات الثلاثة." }, 2: { desc: "يوظف المعلم أساليب تقويم متنوعة تراعي التمايز بين معظم الطلبة.", rec: "تعميم تجربة توظيف أساليب التقويم المتنوعة على الزملاء." }, 3: { desc: "يوظف المعلم أساليب تقويم متنوعة تراعي التمايز بين أغلب الطلبة.", rec: "مراجعة أدوات التقويم المستخدمة للتأكد من تغطيتها المستويات المعرفية." }, 4: { desc: "يوظف المعلم أساليب تقويم تراعي التمايز بصورة محدودة.", rec: "التنويع من أساليب تقويم تراعي التمايز بين جميع الطلبة." }, 5: { desc: "يوظف المعلم أساليب تقويم تراعي التمايز بصورة نادرة.", rec: "التنويع الفوري في أساليب التقويم (الشفوي، الكتابي، الأداء)." } } },
                    { id: 11, title: "قيادة التغيير", subtitle: "(التقويم الذاتي، التنمية المهنية)", items: { 1: { desc: "يُجري تقويماً لأدائه ذاتياً ويوظفه في تحسين تعلم جميع الطلبة.", rec: "تنفيذ مشغل تدريبي للزملاء حول أحد جوانب الإجادة." }, 2: { desc: "يُجري المعلم تقويماً لأدائه ذاتياً ويوظفه بصورة جيدة.", rec: "تشجيع الزملاء على تبني ممارساته المتميزة في التقويم الذاتي." }, 3: { desc: "يُجري المعلم تقويماً لأدائه ذاتياً ويوظفه بصورة مقبولة.", rec: "الالتزام ببرامج التطوير المهني المتاحة وتطبيق المكتسب منها." }, 4: { desc: "يُجري تقويماً لأدائه ذاتياً بشكل محدود.", rec: "الالتزام بالمشاركة المهنية وحضور الورش والمحاضرات." }, 5: { desc: "يُجري المعلم تقويماً لأدائه ذاتياً بصورة نادرة.", rec: "الالتزام بحضور الورش والبدء في توثيق ممارساته المهنية." } } },
                    { id: 12, title: "الحوكمة", subtitle: "(الالتزام باللوائح والأنظمة والوقت)", items: { 1: { desc: "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة فعالة.", rec: "الاستمرار بتطبيق اللوائح ومتابعة أثر الانضباط على النتائج." }, 2: { desc: "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة فاعلة.", rec: "توثيق الممارسات المتميزة في تطبيق الأنظمة وتعميمها." }, 3: { desc: "يطبق السياسات والأنظمة واللوائح بصورة مناسبة.", rec: "التأكد من أن الالتزام باللوائح ينعكس إيجاباً على أداء الطلبة." }, 4: { desc: "يطبق السياسات والأنظمة بصورة محدودة.", rec: "الالتزام باللوائح والأنظمة وضرورة المحافظة على زمن التعلم." }, 5: { desc: "يطبق السياسات والأنظمة بصورة نادرة.", rec: "الالتزام التام بالدوام الرسمي وضبط زمن التعلم وتطبيق كافة الأنظمة." } } },
                    { id: 13, title: "المبادرات والأنشطة", subtitle: "(المشاريع، التفاعل مع المجتمع المدرسي)", items: { 1: { desc: "يقدم مبادرات فعالة ويتميز بالتفاعل الإيجابي في جميع الأنشطة.", rec: "توثيق مبادرة التحصيل الدراسي بطريقة علمية للمشاركة بها." }, 2: { desc: "يقدم مبادرات فاعلة ويتفاعل إيجابياً في معظم الأنشطة.", rec: "التوسع في مجال المبادرة والعمل على توثيق أثرها." }, 3: { desc: "يقدم مبادرات ملائمة ويتفاعل إيجابياً في أغلب الأنشطة.", rec: "الاستمرار في تقديم المبادرات وقيادة فريق عمل لتنفيذ إحداها." }, 4: { desc: "يقدم مبادرات محدودة ويتفاعل بصورة محدودة.", rec: "الالتزام بحضور الاجتماعات والبرامج والمبادرة بتقديم مقترح." }, 5: { desc: "نادراً ما يقدم مبادرات وتفاعله محدود جداً.", rec: "الالتزام التام بحضور الاجتماعات والأنشطة المدرسية." } } }
                ];
            }

            setView(v) { 
                ['now', 'teachers', 'reports', 'supervision', 'supervision-report', 'supervision-history', 'tasks', 'agenda', 'supervision-hub', 'duty', 'reserve', 'periods', 'help'].forEach(x => { 
                    document.getElementById(`view-${x}`)?.classList.add('hidden-view'); 
                    const b = document.getElementById(`btn-${x}`); 
                    if(b) { 
                        b.classList.remove('text-[rgb(var(--color-primary-700))]'); 
                        b.classList.add('text-slate-400'); 
                        const iconContainer = b.querySelector('div');
                        if (iconContainer) {
                            iconContainer.classList.remove('bg-[rgb(var(--color-primary-50))]'); 
                            iconContainer.classList.add('bg-transparent'); 
                        }
                    } 
                }); 
                document.getElementById(`view-${v}`)?.classList.remove('hidden-view'); 
                const ab = document.getElementById(`btn-${v}`); 
                if(ab) { 
                    ab.classList.add('text-[rgb(var(--color-primary-700))]'); 
                    ab.classList.remove('text-slate-400'); 
                    const iconContainer = ab.querySelector('div');
                    if(iconContainer) {
                        iconContainer.classList.add('bg-[rgb(var(--color-primary-50))]'); 
                        iconContainer.classList.remove('bg-transparent'); 
                    }
                } 
                if(v==='teachers') this.renderTeachers(); if(v==='reports') this.renderReports(); if(v==='supervision-history') this.renderHistory(); if(v==='tasks') this.renderTasks(); if(v==='agenda') this.renderAgenda(); if(v==='supervision-hub') this.renderSupervisionHub(); if(v==='duty') this.renderDutyTable(); if(v==='reserve') this.renderReserve(); if(v==='periods') this.renderPeriods();
                if(v==='now') { this.renderCurrentPeriod(new Date(new Date().getTime() + this.state.simulationOffset)); this.renderDailyDutyWidget(new Date(new Date().getTime() + this.state.simulationOffset)); } 
            }

            // --- Periods Management ---
            renderPeriods() {
                const container = document.getElementById('periodsListContainer');
                if (!container) return;
                
                const sortedPeriods = [...this.state.periods].sort((a, b) => parseInt(a.id) - parseInt(b.id));

                container.innerHTML = sortedPeriods.map(p => `
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col md:flex-row items-center justify-between gap-4">
                        <div class="font-extrabold text-slate-800 flex items-center gap-3">
                            <span class="bg-slate-100 text-slate-500 w-10 h-10 rounded-xl flex items-center justify-center font-black text-lg">${p.id}</span>
                            <span>الحصة ${p.id}</span>
                        </div>
                        <div class="flex items-center gap-2 bg-slate-50 border border-slate-200 p-2 rounded-xl">
                            <input type="time" value="${p.start}" onchange="window.app.updatePeriodTime('${p.id}', 'start', this.value)" class="bg-white p-2 rounded-lg border border-slate-200 text-sm font-bold text-slate-700 w-28 text-center">
                            <span class="font-bold text-slate-400">-</span>
                            <input type="time" value="${p.end}" onchange="window.app.updatePeriodTime('${p.id}', 'end', this.value)" class="bg-white p-2 rounded-lg border border-slate-200 text-sm font-bold text-slate-700 w-28 text-center">
                        </div>
                        <button onclick="window.app.deletePeriod('${p.id}')" class="text-red-300 hover:text-red-600 bg-red-50 hover:bg-red-100 w-10 h-10 rounded-xl flex items-center justify-center transition" title="حذف الحصة">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }

            updatePeriodTime(id, type, value) {
                const period = this.state.periods.find(p => p.id === id);
                if (period) {
                    if (type === 'start') period.start = value;
                    if (type === 'end') period.end = value;
                    this.saveData();
                }
            }

            addPeriod() {
                const sortedPeriods = [...this.state.periods].sort((a, b) => parseInt(a.id) - parseInt(b.id));
                const lastPeriod = sortedPeriods[sortedPeriods.length - 1];
                const newId = lastPeriod ? parseInt(lastPeriod.id) + 1 : 1;

                let newStart = "08:00";
                let newEnd = "08:45";

                if (lastPeriod && lastPeriod.end) {
                    const [h, m] = lastPeriod.end.split(':').map(Number);
                    const d = new Date();
                    d.setHours(h, m + 5, 0, 0); // Add 5 min break
                    newStart = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

                    d.setHours(d.getHours(), d.getMinutes() + 45, 0, 0); // Add 45 min duration
                    newEnd = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                }

                this.state.periods.push({ id: String(newId), start: newStart, end: newEnd });
                this.saveData();
                this.renderPeriods();
            }

            deletePeriod(id) {
                if (!confirm(`هل أنت متأكد من حذف الحصة رقم ${id}؟ سيتم إعادة ترقيم الحصص التالية.`)) return;
                
                this.state.periods = this.state.periods.filter(p => p.id !== id);
                
                // Re-number subsequent periods to maintain sequence
                this.state.periods.sort((a,b) => parseInt(a.id) - parseInt(b.id)).forEach((p, index) => {
                    p.id = String(index + 1);
                });

                this.saveData();
                this.renderPeriods();
            }

            // --- Reserve System Logic ---
            renderReserve() {
                const select = document.getElementById('absentTeacherSelect');
                if(!select) return;
                select.innerHTML = '<option value="">-- اختر من القائمة --</option>';
                const sortedTeachers = [...this.state.teachers].sort((a,b) => a.name.localeCompare(b.name, 'ar'));
                sortedTeachers.forEach(t => { const opt = document.createElement('option'); opt.value = t.id; opt.text = t.name; select.add(opt); });
                
                // Persist selection if exists
                if (this.state.selectedAbsentTeacherId) {
                    select.value = this.state.selectedAbsentTeacherId;
                    this.renderAbsentSchedule();
                } else {
                    document.getElementById('absentScheduleContainer').innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-400 bg-white rounded-3xl border-2 border-dashed border-slate-200"><i class="fas fa-chalkboard-teacher text-5xl mb-4 opacity-50"></i><p class="text-sm font-bold text-slate-500">يرجى اختيار المعلم الغائب لعرض جدول حصصه لليوم</p></div>`;
                }

                // Render Daily Substitutions List (Always)
                this.renderDailySubstitutions();
            }

            handleAbsentSelection(val) {
                this.state.selectedAbsentTeacherId = val;
                this.renderAbsentSchedule();
            }

            renderDailySubstitutions() {
                const container = document.getElementById('dailySubstitutionsList');
                if (!container) return;

                const simulatedDate = new Date(new Date().getTime() + this.state.simulationOffset);
                const dateKey = simulatedDate.toISOString().split('T')[0];
                
                const subs = this.state.substitutions || {};
                const todaySubs = [];

                // Filter subs for today
                Object.keys(subs).forEach(key => {
                    if(key.startsWith(dateKey)) {
                        const parts = key.split('_'); // Date_pPeriod_Class
                        // We need to find the absent teacher. 
                        // The structure is simple: Key -> SubstituteID.
                        // But we don't store "Who is Absent" in the value directly, only the Substitute.
                        // We have to infer or store better. 
                        // Current logic: We iterate teachers to find who originally had the class.
                        
                        const period = parseInt(parts[1].replace('p',''));
                        const className = parts[2];
                        const subId = subs[key];
                        const subTeacher = this.state.teachers.find(t => t.id === subId);
                        
                        // Find original teacher
                        const dayIndex = simulatedDate.getDay() + 1; 
                        const originalTeacher = this.state.teachers.find(t => 
                            t.lessons.some(l => l.day === dayIndex && l.period === period && l.className === className)
                        );

                        if(originalTeacher && subTeacher) {
                            todaySubs.push({
                                period: period,
                                className: className,
                                absent: originalTeacher.name,
                                sub: subTeacher.name,
                                key: key
                            });
                        }
                    }
                });

                if(todaySubs.length === 0) {
                    container.innerHTML = `<div class="p-8 text-center text-slate-400 text-sm">لا توجد حصص احتياط مسجلة لهذا اليوم.</div>`;
                    return;
                }

                // Sort by Period
                todaySubs.sort((a,b) => a.period - b.period);

                container.innerHTML = todaySubs.map(item => `
                    <div class="p-4 flex items-center justify-between hover:bg-slate-50 transition border-b border-slate-50 last:border-0">
                        <div class="flex items-center gap-4">
                            <div class="bg-[rgb(var(--color-primary-50))] text-[rgb(var(--color-primary-700))] w-10 h-10 rounded-xl flex flex-col items-center justify-center font-bold text-sm border border-[rgb(var(--color-primary-100))]">
                                <span class="text-[8px] uppercase text-[rgb(var(--color-primary-400))]">حصة</span>
                                ${item.period}
                            </div>
                            <div>
                                <div class="font-bold text-slate-800 text-sm flex items-center gap-2">
                                    <span class="text-slate-500 font-normal">الصف:</span> ${item.className}
                                </div>
                                <div class="text-xs text-slate-500 mt-1 flex items-center gap-2">
                                    <span class="bg-red-50 text-red-600 px-1.5 py-0.5 rounded border border-red-100">غ: ${item.absent}</span>
                                    <i class="fas fa-arrow-left text-slate-300 text-[10px]"></i>
                                    <span class="bg-emerald-50 text-emerald-600 px-1.5 py-0.5 rounded border border-emerald-100">ب: ${item.sub}</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="window.app.deleteSubstitution('${item.key}')" class="text-slate-300 hover:text-red-500 transition px-2" title="حذف">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `).join('');
            }

            deleteSubstitution(key) {
                if(confirm('هل أنت متأكد من إلغاء حصة الاحتياط هذه؟')) {
                    delete this.state.substitutions[key];
                    this.saveData();
                    this.renderReserve();
                }
            }

            printSubstitutions() {
                const simulatedDate = new Date(new Date().getTime() + this.state.simulationOffset);
                const dateKey = simulatedDate.toISOString().split('T')[0];
                const displayDate = simulatedDate.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                document.getElementById('printDate').innerText = displayDate;
                
                const tbody = document.getElementById('printSubstitutionBody');
                tbody.innerHTML = '';

                const subs = this.state.substitutions || {};
                const todaySubs = [];

                Object.keys(subs).forEach(key => {
                    if(key.startsWith(dateKey)) {
                        const parts = key.split('_');
                        const period = parseInt(parts[1].replace('p',''));
                        const className = parts[2];
                        const subId = subs[key];
                        const subTeacher = this.state.teachers.find(t => t.id === subId);
                        const dayIndex = simulatedDate.getDay() + 1; 
                        const originalTeacher = this.state.teachers.find(t => 
                            t.lessons.some(l => l.day === dayIndex && l.period === period && l.className === className)
                        );

                        if(originalTeacher && subTeacher) {
                            todaySubs.push({
                                period: period,
                                className: className,
                                absent: originalTeacher.name,
                                sub: subTeacher.name
                            });
                        }
                    }
                });

                todaySubs.sort((a,b) => a.period - b.period);

                if(todaySubs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center border border-slate-300">لا يوجد احتياط اليوم</td></tr>';
                } else {
                    todaySubs.forEach(item => {
                        tbody.innerHTML += `
                            <tr>
                                <td class="p-3 border border-slate-300 text-center bg-slate-50 font-extrabold">${item.period}</td>
                                <td class="p-3 border border-slate-300 text-center">${item.className}</td>
                                <td class="p-3 border border-slate-300 text-red-600">${item.absent}</td>
                                <td class="p-3 border border-slate-300 text-emerald-700">${item.sub}</td>
                                <td class="p-3 border border-slate-300"></td>
                            </tr>
                        `;
                    });
                }

                window.print();
            }

            renderAbsentSchedule() {
                const absentId = this.state.selectedAbsentTeacherId;
                const container = document.getElementById('absentScheduleContainer');
                if(!absentId) {
                    // Do not reset container if we are just re-rendering due to data update and id is missing (unlikely if flow is correct)
                    // But if user manually cleared it:
                    if(!document.getElementById('absentTeacherSelect').value) {
                         container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-400 bg-white rounded-3xl border-2 border-dashed border-slate-200"><i class="fas fa-chalkboard-teacher text-5xl mb-4 opacity-50"></i><p class="text-sm font-bold text-slate-500">يرجى اختيار المعلم الغائب لعرض جدول حصصه لليوم</p></div>`;
                    }
                    return;
                }

                const t = this.state.teachers.find(x => x.id === absentId);
                if(!t) return;

                const simulatedDate = new Date(new Date().getTime() + this.state.simulationOffset);
                const dayIndex = simulatedDate.getDay() + 1; 
                const dateKey = simulatedDate.toISOString().split('T')[0];
                
                if(dayIndex > 5) {
                    container.innerHTML = `<div class="text-center p-8 text-amber-600 bg-amber-50 rounded-2xl border border-amber-100 font-bold flex flex-col items-center justify-center gap-3 h-40"><i class="fas fa-coffee text-2xl"></i><span>اليوم عطلة نهاية الأسبوع</span></div>`;
                    return;
                }

                const todayLessons = t.lessons.filter(l => l.day === dayIndex).sort((a,b) => a.period - b.period);

                if(todayLessons.length === 0) {
                    container.innerHTML = `<div class="text-center p-8 text-emerald-600 bg-emerald-50 rounded-2xl border border-emerald-100 font-bold flex flex-col items-center justify-center gap-3 h-40"><i class="fas fa-check-circle text-2xl"></i><span>لا توجد حصص لهذا المعلم اليوم.</span></div>`;
                    return;
                }

                container.innerHTML = todayLessons.map(l => {
                    const periodInfo = this.state.periods.find(p => parseInt(p.id) === l.period);
                    const timeStr = periodInfo ? `<span class="text-xs font-mono text-slate-400 bg-slate-100 px-2 py-0.5 rounded-md ml-2">${periodInfo.start} - ${periodInfo.end}</span>` : '';
                    
                    // Check for existing substitute
                    const subKey = `${dateKey}_p${l.period}_${l.className}`;
                    const subId = this.state.substitutions[subKey];
                    const subTeacher = subId ? this.state.teachers.find(st => st.id === subId) : null;

                    return `
                    <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4 hover:shadow-md transition">
                        <div class="flex items-center gap-5 w-full md:w-auto">
                            <div class="bg-[rgb(var(--color-primary-50))] text-[rgb(var(--color-primary-600))] w-14 h-14 rounded-2xl flex flex-col items-center justify-center font-bold border border-[rgb(var(--color-primary-100))] shadow-inner">
                                <span class="text-[10px] uppercase opacity-70">الحصة</span>
                                <span class="text-xl leading-none font-black">${l.period}</span>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800 text-lg">${l.className}</h4>
                                <div class="flex items-center gap-2 mt-1">
                                    ${timeStr}
                                    <span class="bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-0.5 rounded-lg border border-slate-200">${t.specialization || 'عام'}</span>
                                    ${subTeacher ? `<span class="bg-amber-100 text-amber-700 text-[10px] font-bold px-2 py-0.5 rounded-lg border border-amber-200 flex items-center gap-1"><i class="fas fa-user-check"></i> بديل: ${subTeacher.name}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <button onclick="window.app.findSubstitutes('${absentId}', ${l.period}, '${l.className}')" class="w-full md:w-auto bg-white hover:bg-slate-50 text-[rgb(var(--color-primary-600))] border border-[rgb(var(--color-primary-100))] px-6 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition cursor-pointer shadow-sm hover:shadow">
                            <i class="fas fa-search"></i> <span>${subTeacher ? 'تغيير البديل' : 'إيجاد بديل'}</span>
                        </button>
                    </div>
                    `;
                }).join('');
            }

            calculateWeeklyLoad(teacher) {
                return teacher.lessons ? teacher.lessons.length : 0;
            }

            findSubstitutes(absentId, period, className) {
                const simulatedDate = new Date(new Date().getTime() + this.state.simulationOffset);
                const dayIndex = simulatedDate.getDay() + 1;
                const absentTeacher = this.state.teachers.find(t => t.id === absentId);

                let available = this.state.teachers.filter(t => {
                    if (t.id === absentId) return false; 
                    const hasClass = t.lessons.some(l => l.day === dayIndex && l.period === period);
                    return !hasClass;
                });

                available.sort((a,b) => this.calculateWeeklyLoad(a) - this.calculateWeeklyLoad(b));

                const list = document.getElementById('substituteList');
                document.getElementById('subModalPeriodInfo').innerText = `الحصة ${period} - ${className}`;
                
                list.innerHTML = available.map(t => {
                    const load = this.calculateWeeklyLoad(t);
                    let loadColor = load < 10 ? 'text-emerald-700 bg-emerald-50 border-emerald-100' : (load < 18 ? 'text-amber-700 bg-amber-50 border-amber-100' : 'text-rose-700 bg-rose-50 border-rose-100');
                    
                    return `
                    <div class="flex items-center justify-between p-3 bg-white rounded-xl border border-slate-100 shadow-sm hover:shadow transition group mb-2">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-sm font-bold text-slate-500 border-2 border-white shadow-sm">${t.short[0] || '?'}</div>
                            <div>
                                <div class="font-bold text-sm text-slate-800">${t.name}</div>
                                <div class="text-[10px] text-slate-400 font-medium">${t.specialization || 'غير محدد'}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="text-[10px] font-bold px-2 py-1 rounded-lg border ${loadColor}">نصاب: ${load}</div>
                            <button onclick="window.app.assignSubstitute('${t.id}', '${absentId}', ${period}, '${className}')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition shadow-sm" title="تثبيت البديل">
                                تثبيت
                            </button>
                            <button onclick="window.app.sendSubstituteMessage('${t.id}', ${period}, '${className}', '${absentTeacher.name}')" class="bg-emerald-50 hover:bg-emerald-100 text-emerald-600 border border-emerald-100 w-8 h-8 rounded-lg flex items-center justify-center transition shadow-sm" title="إرسال واتساب">
                                <i class="fab fa-whatsapp text-lg"></i>
                            </button>
                        </div>
                    </div>
                    `;
                }).join('');

                document.getElementById('modal-substitute').classList.remove('hidden-view');
            }

            assignSubstitute(subId, originalId, period, className) {
                if(!confirm('هل أنت متأكد من تعيين هذا المعلم كبديل؟')) return;
                
                const simulatedDate = new Date(new Date().getTime() + this.state.simulationOffset);
                const dateKey = simulatedDate.toISOString().split('T')[0];
                const key = `${dateKey}_p${period}_${className}`;
                
                if(!this.state.substitutions) this.state.substitutions = {};
                this.state.substitutions[key] = subId;
                
                this.saveData();
                this.closeModal('modal-substitute');
                this.renderAbsentSchedule(); // Force UI update immediately
                this.renderDailySubstitutions(); // Update daily list
            }

            sendSubstituteMessage(subId, period, className, absentName) {
                const t = this.state.teachers.find(x => x.id === subId);
                if(!t || !t.phone) return alert('يرجى إضافة رقم هاتف للمعلم البديل أولاً من سجل المعلمين.');

                const msg = `السلام عليكم أستاذ ${t.name}،\nنرجو التكرم بدخول حصة احتياط:\n📌 الحصة: ${period}\n🏫 الصف: ${className}\n👤 بدلاً من: الأستاذ ${absentName}\n\nشكراً لتعاونكم.`;
                window.open(`https://wa.me/${t.phone}?text=${encodeURIComponent(msg)}`, '_blank');
            }

            renderSupervisionHub() {
                const select = document.getElementById('supTeacherSelect');
                if(select) {
                    select.innerHTML = '<option value="">اختر المعلم...</option>';
                    const sortedTeachers = [...this.state.teachers].sort((a,b) => a.name.localeCompare(b.name, 'ar'));
                    sortedTeachers.forEach(t => { const opt = document.createElement('option'); opt.value = t.id; opt.text = t.name; select.add(opt); });
                }
                const history = this.state.supervisionHistory || [];
                document.getElementById('hubTotalVisits').innerText = history.length;
                let totalScore = 0; let count = 0;
                history.forEach(h => { let visitTotal = 0; let visitItems = 0; Object.values(h.ratings).forEach(r => { visitTotal += (6 - parseInt(r)); visitItems++; }); if(visitItems > 0) { totalScore += (visitTotal / visitItems) * 20; count++; } });
                document.getElementById('hubAvgScore').innerText = count > 0 ? Math.round(totalScore/count) + '%' : '0%';
                const list = document.getElementById('hubRecentList'); if(!list) return;
                const recent = [...history].sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime()).slice(0, 5);
                list.innerHTML = recent.length === 0 ? `<div class="p-8 text-center text-slate-400 text-sm flex flex-col items-center gap-2"><i class="fas fa-inbox text-2xl opacity-50"></i>لا توجد زيارات حديثة</div>` : recent.map(v => `<div class="p-4 flex justify-between items-center hover:bg-slate-50 transition border-b border-slate-50 last:border-0"><div><div class="font-bold text-slate-800 text-sm">${v.teacherName}</div><div class="text-[10px] text-slate-400 font-medium mt-0.5">${v.date} <span class="mx-1">•</span> ${v.topic}</div></div><button onclick="window.app.loadVisitByDate('${v.id}')" class="bg-white hover:bg-slate-50 text-[rgb(var(--color-primary-600))] border border-slate-200 px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition shadow-sm">عرض</button></div>`).join('');
            }
            
            loadVisitByDate(id) { const visit = this.state.supervisionHistory.find(v => v.id === id); if(visit) { this.state.supervisionData = { ratings: visit.ratings, notes: visit.notes || {}, gender: visit.gender || 'male' }; this.generateReport(true, visit); } }

            startSupervision(teacherId, className) {
                const nameInput = document.getElementById('supTeacherName');
                const selectParent = document.getElementById('supTeacherSelect')?.parentElement;
                
                if (!teacherId) {
                    this.state.supervisionData = { ratings: {}, notes: {}, gender: this.state.defaultSchoolGender };
                    this.renderSupervisionHub(); 
                    
                    nameInput?.classList.add('hidden'); 
                    selectParent?.classList.remove('hidden');
                    
                    const select = document.getElementById('supTeacherSelect');
                    if(select) select.value = "";
                    
                    const cName = document.getElementById('supClassName');
                    if(cName) cName.value = "";
                    
                    const topic = document.getElementById('supLessonTopic');
                    if(topic) topic.value = "";
                    
                    this.renderCriteria(); 
                    this.setView('supervision'); 
                    return;
                }
                
                const t = this.state.teachers.find(x => x.id === teacherId); 
                if(!t) return;
                
                selectParent?.classList.add('hidden'); 
                nameInput?.classList.remove('hidden'); 
                if(nameInput) nameInput.value = t.name;
                
                const cName = document.getElementById('supClassName');
                if(cName) cName.value = className || '';
                
                const topic = document.getElementById('supLessonTopic');
                if(topic) topic.value = '';
                
                if (this.state.defaultSchoolGender === 'female') {
                    const rf = document.getElementById('supGenderFemale');
                    if(rf) rf.checked = true;
                } else {
                    const rm = document.getElementById('supGenderMale');
                    if(rm) rm.checked = true;
                }
                
                const specSelect = document.getElementById('supSpecialization'); 
                if(specSelect) {
                    specSelect.innerHTML = '<option value="">اختر التخصص...</option>';
                    const specs = this.state.specializations || []; 
                    specs.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.text = s; specSelect.add(opt); }); 
                    if (t.specialization) specSelect.value = t.specialization;
                }
                
                this.state.supervisionData = { ratings: {}, notes: {}, gender: this.state.defaultSchoolGender }; 
                this.renderCriteria(); 
                this.setView('supervision');
            }

            renderCriteria() {
                const list = document.getElementById('supervisionCriteriaList');
                list.innerHTML = this.state.evaluationCriteria.map((criterion, index) => `<div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm"><div class="mb-5 border-b border-slate-50 pb-3"><h3 class="font-bold text-slate-800 text-lg flex items-center gap-3"><span class="bg-[rgb(var(--color-primary-100))] text-[rgb(var(--color-primary-700))] w-8 h-8 rounded-xl flex items-center justify-center text-sm font-bold shadow-inner">${index + 1}</span>${criterion.title}</h3><p class="text-xs text-slate-400 mr-11 mt-1 font-medium">${criterion.subtitle}</p></div><div class="space-y-3">${[1,2,3,4,5].map(rating => { const item = criterion.items[rating]; const desc = item ? item.desc : ''; return `<label class="relative flex items-start gap-4 p-4 border border-slate-100 rounded-2xl cursor-pointer bg-slate-50 hover:bg-white hover:border-[rgb(var(--color-primary-200))] transition-all group"><input type="radio" name="criteria_${criterion.id}" value="${rating}" onchange="window.app.setRating(${criterion.id}, ${rating})" class="sup-radio peer mt-1 accent-[rgb(var(--color-primary-600))]"><div class="flex-1"><div class="flex items-center gap-2 mb-1.5"><span class="font-bold text-[rgb(var(--color-primary-700))] bg-[rgb(var(--color-primary-50))] px-2.5 py-0.5 rounded-lg text-xs">مستوى ${rating}</span></div><p class="text-xs text-slate-500 leading-relaxed font-medium">${desc}</p></div><div class="check-icon hidden text-[rgb(var(--color-primary-600))] absolute top-4 left-4 text-lg"><i class="fas fa-check-circle"></i></div></label>`; }).join('')}</div><div class="mt-4"><input type="text" onchange="window.app.setNote(${criterion.id}, this.value)" placeholder="اكتب ملاحظة محددة حول هذا البند (اختياري)..." class="w-full text-xs p-3 rounded-xl border border-slate-200 bg-white focus:border-[rgb(var(--color-primary-500))] focus:ring-4 focus:ring-[rgb(var(--color-primary-50))] outline-none transition-all"></div></div>`).join('');
            }

            onTeacherSelectChange() {
                const select = document.getElementById('supTeacherSelect'); const tId = select.value; const t = this.state.teachers.find(x => x.id === tId);
                const specSelect = document.getElementById('supSpecialization'); specSelect.innerHTML = '<option value="">اختر التخصص...</option>';
                const specs = this.state.specializations || []; specs.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.text = s; specSelect.add(opt); });
                if(t && t.specialization) specSelect.value = t.specialization;
            }

            setRating(criteriaId, rating) { this.state.supervisionData.ratings[criteriaId] = rating; }
            setNote(criteriaId, text) { if(!this.state.supervisionData.notes) this.state.supervisionData.notes = {}; this.state.supervisionData.notes[criteriaId] = text; }

            generateReport(isLoad = false, existingData = null) {
                const ratings = existingData ? existingData.ratings : this.state.supervisionData.ratings; const notes = existingData ? (existingData.notes || {}) : (this.state.supervisionData.notes || {});
                if(!isLoad && Object.keys(ratings).length < this.state.evaluationCriteria.length) { alert('يرجى استكمال تقييم جميع البنود'); return; }
                let tName = ""; if(isLoad) { tName = existingData.teacherName; } else { const nameInput = document.getElementById('supTeacherName'); if (!nameInput.classList.contains('hidden')) { tName = nameInput.value; } else { const select = document.getElementById('supTeacherSelect'); tName = select.options[select.selectedIndex].text; } }
                const spec = isLoad ? existingData.specialization : document.getElementById('supSpecialization').value; const cName = isLoad ? existingData.className : document.getElementById('supClassName').value; const lTopic = isLoad ? existingData.topic : document.getElementById('supLessonTopic').value || '-';
                const schoolGender = isLoad ? existingData.gender : document.querySelector('input[name="supSchoolGender"]:checked').value; const rDate = isLoad ? existingData.date : new Date().toLocaleDateString('ar-EG');
                this.state.supervisionData.gender = schoolGender;
                document.getElementById('repTeacherName').innerText = tName; document.getElementById('repSpecialization').innerText = spec || 'عام'; document.getElementById('repClassName').innerText = cName; document.getElementById('repLessonTopic').innerText = lTopic; document.getElementById('reportDate').innerText = rDate; document.getElementById('repSchoolGender').innerText = schoolGender === 'male' ? 'بنين' : 'بنات';
                const analysis = []; const detailsBody = document.getElementById('repDetailsBody'); detailsBody.innerHTML = ''; 
                this.state.evaluationCriteria.forEach(c => { const r = ratings[c.id]; const noteText = notes[c.id] || '-'; const itemData = c.items[r] || { desc: "", rec: "" }; analysis.push({ id: c.id, title: c.title, rating: r, desc: itemData.desc, rec: itemData.rec, note: notes[c.id] || '' }); let ratingBadge = r === 1 ? 'text-emerald-700 bg-emerald-50' : (r === 2 ? 'text-green-600 bg-green-50' : (r === 3 ? 'text-amber-600 bg-amber-50' : (r === 4 ? 'text-orange-600 bg-orange-50' : 'text-red-600 bg-red-50'))); detailsBody.innerHTML += `<tr class="hover:bg-slate-50 transition-colors"><td class="p-4 border-b border-slate-100 align-top"><div class="font-bold text-slate-800 mb-1 text-sm">${c.title}</div><div class="text-[10px] text-slate-400 mb-2 font-bold">${c.subtitle}</div><div class="text-xs text-slate-500 leading-relaxed bg-slate-50 p-3 rounded-xl border border-slate-100">${itemData.desc}</div></td><td class="p-4 border-b border-slate-100 text-center align-top pt-5"><span class="font-bold px-3 py-1 rounded-lg text-xs border border-transparent ${ratingBadge}">${r}/5</span></td><td class="p-4 border-b border-slate-100 text-slate-500 italic text-xs align-top pt-5">${noteText}</td></tr>`; });
                if (isLoad && existingData.aiReportContent) { document.getElementById('aiReportContent').innerHTML = existingData.aiReportContent; } else {
                    const strengths = [...analysis].sort((a,b) => a.rating - b.rating).slice(0, 4); const improvements = [...analysis].filter(a => a.rating > 2).sort((a,b) => b.rating - a.rating).slice(0, 4);
                    const repStrengthsHTML = strengths.map(s => `<li><span class="font-bold text-emerald-700">${s.title}:</span> ${s.desc}</li>`).join(''); const repImprovementsHTML = improvements.length > 0 ? improvements.map(s => `<li><span class="font-bold text-orange-700">${s.title}:</span> ${s.desc}</li>`).join('') : '<li>لا توجد نقاط ضعف ملحوظة تستدعي التدخل العاجل.</li>'; const repRecommendationsHTML = improvements.length > 0 ? improvements.map(s => `<li>${s.rec || `تحسين مستوى ${s.title} من خلال اتباع استراتيجيات حديثة.`}</li>`).join('') : '<li>الاستمرار في الأداء المتميز ومشاركة الخبرات مع الزملاء.</li>';
                    document.getElementById('aiReportContent').innerHTML = `<div class="ai-report-section"><h4><i class="fas fa-star text-emerald-500"></i> أبرز جوانب الإجادة</h4><ul class="list-disc pr-5 text-sm text-slate-700">${repStrengthsHTML}</ul></div><div class="ai-report-section"><h4><i class="fas fa-chart-line text-orange-500"></i> نقاط تحتاج إلى تحسين</h4><ul class="list-disc pr-5 text-sm text-slate-700">${repImprovementsHTML}</ul></div><div class="ai-report-section bg-[rgb(var(--color-primary-50))]/50 p-5 rounded-2xl border border-[rgb(var(--color-primary-100))]"><h4><i class="fas fa-lightbulb text-yellow-500"></i> التوصيات والمقترحات الفنية</h4><ul class="list-decimal pr-5 text-sm text-slate-700 space-y-2">${repRecommendationsHTML}</ul></div>`;
                }
                this.setView('supervision-report');
            }

            saveVisit() {
                const visitData = { id: Date.now().toString(), teacherName: document.getElementById('repTeacherName').innerText, specialization: document.getElementById('repSpecialization').innerText, className: document.getElementById('repClassName').innerText, topic: document.getElementById('repLessonTopic').innerText, date: document.getElementById('reportDate').innerText, gender: this.state.supervisionData.gender, ratings: {...this.state.supervisionData.ratings}, notes: {...this.state.supervisionData.notes}, aiReportContent: document.getElementById('aiReportContent').innerHTML };
                if(!this.state.supervisionHistory) this.state.supervisionHistory = []; const existingIndex = this.state.supervisionHistory.findIndex(v => v.id === visitData.id); if (existingIndex > -1) { this.state.supervisionHistory[existingIndex] = visitData; } else { this.state.supervisionHistory.push(visitData); } this.saveData(); alert('تم حفظ الزيارة في السجل بنجاح');
            }

            buildPlainTextReport() {
                const topic = document.getElementById('repLessonTopic').innerText; const specialization = document.getElementById('repSpecialization').innerText; const gender = this.state.supervisionData.gender; const isMale = gender === 'male';
                const context = { teacher: isMale ? "المعلم" : "المعلمة", student: isMale ? "الطالب" : "الطالبة", students: isMale ? "الطلاب" : "الطالبات", address: isMale ? "مدرسة بنين" : "مدرسة بنات" };
                let reportText = `الدور: تصرف بصفتك موجه فني خبير لمادة ${specialization}. المهمة: كتابة تقرير زيارة صفية فني واحترافي. معلومات الزيارة: - المعلم: ${context.teacher} - عنوان الدرس: "${topic}" - نوع المدرسة: ${context.address}. التقييمات التفصيلية:\n`;
                this.state.evaluationCriteria.forEach(c => { const r = this.state.supervisionData.ratings[c.id]; const note = this.state.supervisionData.notes[c.id]; if (r) { const itemDesc = c.items[r]?.desc || ''; reportText += `- ${c.title}: مستوى ${r}/5. (${itemDesc}) ${note ? '- ملاحظة إضافية: ' + note : ''}\n`; } });
                reportText += `\nالمطلوب (HTML Format Only): يرجى صياغة التقرير بتنسيق HTML جاهز للعرض، يتضمن الأقسام التالية داخل divs بclass "ai-report-section": وصف عام للأداء، أبرز جوانب الإجادة، نقاط التحسين، توصيات فنية.`;
                return reportText;
            }

            async copyToClipboardPrompt() {
                const teacherName = document.getElementById('repTeacherName').innerText;
                const specialization = document.getElementById('repSpecialization').innerText;
                const className = document.getElementById('repClassName').innerText;
                const topic = document.getElementById('repLessonTopic').innerText;
                const schoolType = document.getElementById('repSchoolGender').innerText;
                const gender = this.state.supervisionData.gender;
                const isMale = gender === 'male';
                
                let prompt = `أعمل كموجه فني تربوي خبير لمادة ${specialization}.\n`;
                prompt += `المطلوب: صياغة تقرير زيارة صفية احترافي، تربوي، ومحفز بناءً على البيانات التالية:\n\n`;
                prompt += `--- بيانات الزيارة ---\n`;
                prompt += `- المعلم: ${teacherName}\n`;
                prompt += `- التخصص: ${specialization}\n`;
                prompt += `- الصف: ${className}\n`;
                prompt += `- عنوان الدرس: ${topic}\n`;
                prompt += `- نوع المدرسة: ${schoolType}\n\n`;
                prompt += `--- تفاصيل التقييم والملاحظات ---\n`;

                this.state.evaluationCriteria.forEach(c => {
                    const r = this.state.supervisionData.ratings[c.id];
                    const note = this.state.supervisionData.notes[c.id];
                    if (r) {
                        const itemDesc = c.items[r]?.desc || '';
                        prompt += `* المعيار: ${c.title}\n`;
                        prompt += `  - التقييم: ${r} من 5\n`;
                        prompt += `  - الوصف: ${itemDesc}\n`;
                        if(note && note.length > 1) prompt += `  - ملاحظات المشرف: ${note}\n`;
                    }
                });

                prompt += `\n--- هيكل التقرير المطلوب ---\n`;
                prompt += `يرجى كتابة التقرير بحيث يتضمن:\n`;
                prompt += `1. مقدمة عامة تصف سياق الحصة.\n`;
                prompt += `2. نقاط القوة (أبرز جوانب الإجادة).\n`;
                prompt += `3. فرص التحسين (نقاط الضعف إن وجدت).\n`;
                prompt += `4. توصيات فنية عملية للمعلم للارتقاء بالأداء.\n`;
                prompt += `5. خاتمة تشجيعية.\n`;

                try {
                    await navigator.clipboard.writeText(prompt);
                    alert("تم نسخ كافة تفاصيل الزيارة ومعايير التقييم إلى الحافظة بنجاح!\n\nيمكنك الآن التوجه إلى ChatGPT أو Gemini ولصق النص للحصول على التقرير.");
                } catch (err) {
                    console.error('Failed to copy: ', err);
                    alert("حدث خطأ أثناء النسخ. يرجى المحاولة مرة أخرى.");
                }
            }

            renderAIReport(content) { const cleanHtml = (content || "").replace(/```html/g, '').replace(/```/g, '').trim(); document.getElementById('aiReportContent').innerHTML = cleanHtml; }

            async enhanceReportWithAI() {
                const topic = document.getElementById('repLessonTopic').innerText; 
                const specialization = document.getElementById('repSpecialization').innerText; 
                
                if(!topic || topic === '-' || topic === 'عام') return alert('يرجى تحديد عنوان الدرس وتخصص المعلم بدقة للحصول على تقرير ذكي.');

                try {
                    document.getElementById('aiLoadingOverlay').classList.remove('hidden-view');
                    const reportText = this.buildPlainTextReport(); 
                    const gender = this.state.supervisionData.gender;

                    if (!this.auth || !this.auth.currentUser) {
                         throw new Error("يجب تسجيل الدخول لاستخدام الميزات السحابية المتقدمة.");
                    }

                    // الحصول على التوكن للمصادقة مع Cloud Function
                    const token = await this.auth.currentUser.getIdToken(true);
                    const url = this.state.cloudFunctionUrl || "https://improvetext-cewovb6fwq-uc.a.run.app";
                    
                    const response = await fetch(url, { 
                        method: "POST", 
                        headers: { 
                            "Content-Type": "application/json", 
                            "Authorization": `Bearer ${token}` 
                        }, 
                        body: JSON.stringify({ 
                            text: reportText, 
                            gender: gender, 
                            specialization: specialization, 
                            topic: topic 
                        }) 
                    });

                    if (!response.ok) { 
                        const errJson = await response.json().catch(() => ({}));
                        console.warn("Cloud Function Failed:", errJson);
                        throw new Error(errJson.message || errJson.error || "خطأ في الاتصال بالخدمة السحابية"); 
                    }
                    
                    const data = await response.json(); 
                    const resultHtml = data.result || data.text;

                    if (!resultHtml) throw new Error("لم يتم استلام أي نص من الذكاء الاصطناعي.");
                    
                    this.renderAIReport(resultHtml);

                } catch (e) { 
                    console.error("AI Process Error:", e); 
                    alert("فشل المعالجة السحابية: " + e.message); 
                } finally { 
                    document.getElementById('aiLoadingOverlay')?.classList.add('hidden-view'); 
                }
            }
            
            enableDevEdit() {
                const inputs = document.querySelectorAll('#developerSettingsSection input');
                inputs.forEach(input => input.disabled = false);
            }

            saveDevSettings() {
                this.state.cloudFunctionUrl = document.getElementById('settingCloudUrl').value;
                this.saveData();
                const inputs = document.querySelectorAll('#developerSettingsSection input');
                inputs.forEach(input => input.disabled = true);
                alert('تم تحديث الإعدادات الأمنية بنجاح.');
            }
            
            handleCriteriaExcel(e) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        // We use header:1 to get array of arrays (rows)
                        const json = XLSX.utils.sheet_to_json(ws, {header: 1});
                        
                        // Parse logic for structure: Criteria | DescCriteria | Rating | BehaviorDesc | Recs
                        const criteriaMap = {};
                        let importCount = 0;

                        // Skip header row (index 0), start from 1
                        for (let i = 1; i < json.length; i++) {
                            const row = json[i];
                            if (!row || row.length < 3) continue;

                            const title = row[0]; // Col A: المعيار
                            if (!title) continue;

                            const subtitle = row[1] || ""; // Col B: وصف المعيار
                            let ratingVal = row[2]; // Col C: الحكم (1-5)
                            const desc = row[3] || ""; // Col D: الوصف السلوكي
                            const rec = row[4] || ""; // Col E: التوصيات

                            // Extract number from rating (e.g., "مستوى 5" -> 5)
                            const ratingMatch = String(ratingVal).match(/\d+/);
                            const rating = ratingMatch ? parseInt(ratingMatch[0]) : 0;

                            if (!criteriaMap[title]) {
                                criteriaMap[title] = {
                                    id: Date.now() + i, // Unique ID gen
                                    title: title,
                                    subtitle: subtitle,
                                    items: {}
                                };
                            }

                            if (rating >= 1 && rating <= 5) {
                                criteriaMap[title].items[rating] = { desc, rec };
                                importCount++;
                            }
                        }

                        const newCriteriaList = Object.values(criteriaMap);
                        if (newCriteriaList.length > 0) {
                            this.state.evaluationCriteria = newCriteriaList;
                            this.saveData();
                            alert(`تم استيراد قاعدة البيانات بنجاح!\nعدد المعايير: ${newCriteriaList.length}\nعدد البنود: ${importCount}`);
                            this.closeModal('modal-settings');
                        } else {
                            alert("لم يتم العثور على بيانات صالحة في الملف. يرجى التأكد من ترتيب الأعمدة.");
                        }

                    } catch (err) {
                        console.error("Excel Import Error:", err);
                        alert("حدث خطأ أثناء قراءة الملف. تأكد من أنه ملف Excel صالح.");
                    }
                };
                reader.readAsArrayBuffer(e.target.files[0]);
            }

            deleteData() {
                if (confirm('تحذير: سيتم حذف جميع البيانات المخزنة (المعلمين، السجل، المهام) وإعادة التطبيق لحالة المصنع.\n\nهل أنت متأكد تماماً؟')) {
                    if (confirm('تأكيد نهائي: هل ترغب بحذف كل شيء؟')) {
                        localStorage.removeItem('school_data_v1');
                        if (this.state.currentUser && this.db) {
                            this.db.collection("users").doc(this.state.currentUser.uid).set({
                                teachers: [], periods: [], classes: {}, tasks: [], agenda: [],
                                violationTypes: this.state.violationTypes, 
                                supervisionHistory: [],
                                evaluationCriteria: [],
                                dutyLocations: [],
                                dutySchedule: {}
                            }, { merge: true });
                        }
                        alert('تم حذف البيانات بنجاح.');
                        location.reload();
                    }
                }
            }

            renderAll() { const activeBtn = document.querySelector('.nav-btn.text-\\[rgb\\(var\\(--color-primary-700\\)\\)\\]'); let currentView = activeBtn ? activeBtn.id.replace('btn-', '') : 'now'; if(currentView === 'now') { this.renderCurrentPeriod(new Date(new Date().getTime() + this.state.simulationOffset)); this.renderDailyDutyWidget(new Date(new Date().getTime() + this.state.simulationOffset)); } else if (currentView === 'teachers') this.renderTeachers(); else if (currentView === 'reports') this.renderReports(); else if (currentView === 'tasks') this.renderTasks(); else if (currentView === 'agenda') this.renderAgenda(); else if (currentView === 'supervision-hub') this.renderSupervisionHub(); else if (currentView === 'duty') this.renderDutyTable(); else if (currentView === 'reserve') this.renderReserve(); else if (currentView === 'periods') this.renderPeriods(); }
            
            renderCurrentPeriod(now) { 
                const mins = now.getHours() * 60 + now.getMinutes(); 
                const currentPeriod = this.state.periods.find(p => { 
                    const [sh, sm] = p.start.split(':').map(Number); 
                    const [eh, em] = p.end.split(':').map(Number); 
                    return mins >= (sh*60+sm) && mins <= (eh*60+em); 
                }); 
                const infoDiv = document.getElementById('currentPeriodInfo'); 
                if(infoDiv) {
                    if (currentPeriod) {
                        const [eh, em] = currentPeriod.end.split(':').map(Number);
                        const endTime = new Date(now);
                        endTime.setHours(eh, em, 0, 0);
                        const diff = Math.floor((endTime.getTime() - now.getTime()) / 1000);
                        const m = Math.floor(diff / 60);
                        const s = diff % 60;
                        const countdown = `${m}:${s < 10 ? '0'+s : s}`;
                        infoDiv.innerHTML = `<div class="flex items-center gap-3"><div class="flex flex-col"><span class="text-[rgb(var(--color-primary-100))] text-xs font-bold uppercase tracking-wider">الحصة الحالية</span><span class="text-white text-2xl font-bold font-mono leading-none">${currentPeriod.id}</span></div><div class="h-8 w-px bg-white/20 mx-1"></div><div class="flex flex-col items-end"><span class="text-white font-mono text-sm tracking-wide opacity-90">${currentPeriod.start} - ${currentPeriod.end}</span><span class="text-red-300 font-mono font-bold text-xs flex items-center gap-1 mt-0.5"><i class="fas fa-hourglass-end text-[10px]"></i> ${countdown}</span></div></div>`; 
                    } else {
                        infoDiv.innerHTML = `<div class="flex items-center gap-2 text-white/80 font-bold text-sm bg-white/10 px-3 py-1.5 rounded-lg"><i class="fas fa-coffee"></i> لا توجد حصص نشطة</div>`;
                    }
                } 
                this.renderActiveClasses(now, currentPeriod); 
            }
            
            renderActiveClasses(now, period) { 
                const grid = document.getElementById('activeClassesGrid'); 
                if(!grid) return; 
                
                if(!period) { 
                    grid.innerHTML = `<div class="col-span-full py-20 text-center text-slate-400 bg-slate-50/50 rounded-3xl border-2 border-dashed border-slate-200"><i class="fas fa-school text-4xl mb-4 text-slate-300"></i><p class="text-sm font-medium">لا توجد حصص في الوقت الحالي</p></div>`; 
                    return; 
                } 
                
                const dayId = now.getDay() + 1; 
                const pId = parseInt(period.id); 
                const dateKey = now.toISOString().split('T')[0];
                let active = []; 
                
                this.state.teachers.forEach(t => { 
                    const l = t.lessons.find(ls => ls.day === dayId && ls.period === pId); 
                    if(l) {
                        // Check Substitution
                        const subKey = `${dateKey}_p${pId}_${l.className}`;
                        const subId = this.state.substitutions[subKey];
                        
                        if (subId) {
                            const subTeacher = this.state.teachers.find(st => st.id === subId);
                            if (subTeacher) {
                                active.push({ t: subTeacher, className: l.className, isSub: true, original: t.name });
                            } else {
                                active.push({ t, className: l.className });
                            }
                        } else {
                            active.push({ t, className: l.className }); 
                        }
                    }
                }); 
                
                active.sort((a, b) => { 
                    const gA = (a.className.match(/\\d+/) || [999])[0], gB = (b.className.match(/\\d+/) || [999])[0]; 
                    return parseInt(gA) - parseInt(gB); 
                }); 
                
                grid.innerHTML = active.map(item => {
                    const badgeClass = item.isSub ? 'bg-amber-100 text-amber-700 border-amber-200' : 'bg-slate-50 text-slate-700 border-slate-100';
                    const iconClass = item.isSub ? 'bg-amber-500 text-white border-amber-400' : 'bg-[rgb(var(--color-primary-50))] text-[rgb(var(--color-primary-600))] border-[rgb(var(--color-primary-100))]';
                    const subLabel = item.isSub ? `<div class="text-[9px] text-amber-600 font-bold mt-1 bg-amber-50 w-fit px-1.5 rounded">بدلاً من: ${item.original}</div>` : '';

                    return `<div class="group bg-white rounded-2xl shadow-sm hover:shadow-lg transition-all duration-300 border border-slate-100 overflow-hidden relative flex flex-col card-hover">
                        <div class="h-1.5 w-full ${item.isSub ? 'bg-amber-500' : 'bg-gradient-to-r from-[rgb(var(--color-primary-500))] to-purple-500'}"></div>
                        <div class="p-4 flex-1 flex flex-col">
                            <div class="flex justify-between items-start mb-2">
                                <span class="${badgeClass} px-2.5 py-1 rounded-lg text-xs font-bold border truncate max-w-[70%]">${item.className}</span>
                                <div class="w-7 h-7 rounded-full ${iconClass} flex items-center justify-center text-[10px] font-bold border ring-2 ring-white">${item.t.short[0] || '?'}</div>
                            </div>
                            <h3 class="font-bold text-sm text-slate-800 mb-0 truncate" title="${item.t.name}">${item.t.name}</h3>
                            ${subLabel}
                            <div class="flex items-center gap-1 text-[10px] text-slate-400 font-medium mb-3 mt-1">
                                <i class="fas fa-star text-amber-400"></i> <span>${item.t.score}%</span>
                            </div>
                            <button type="button" onclick="window.app.openActionModal('${item.t.id}', '${item.className}')" class="mt-auto w-full py-2.5 rounded-xl bg-slate-50 hover:bg-[rgb(var(--color-primary-50))] text-slate-600 hover:text-[rgb(var(--color-primary-700))] font-bold text-xs transition-colors flex justify-center items-center gap-2 cursor-pointer border border-slate-100 hover:border-[rgb(var(--color-primary-100))]">
                                <i class="fas fa-sliders-h"></i> إجراء
                            </button>
                        </div>
                    </div>`; 
                }).join(''); 
            }
            renderTeachers() { 
                const term = document.getElementById('teacherSearch').value.toLowerCase(); 
                const grid = document.getElementById('teachersGrid'); 
                const countBadge = document.getElementById('teachersCountBadge');
                if(!grid) return; 
                let filtered = this.state.teachers.filter(t => t.name.toLowerCase().includes(term) || (t.school && t.school.toLowerCase().includes(term))); 
                filtered.sort((a,b) => a.name.localeCompare(b.name, 'ar')); 
                if(countBadge) countBadge.innerText = filtered.length;
                grid.innerHTML = filtered.map(t => { 
                    let scoreColor = t.score >= 90 ? "bg-emerald-50 text-emerald-600 border-emerald-100" : (t.score >= 70 ? "bg-amber-50 text-amber-600 border-amber-100" : "bg-rose-50 text-rose-600 border-rose-100"); 
                    const schoolBadge = t.school ? `<div class="text-[10px] text-slate-400 flex items-center gap-1 mt-1 bg-slate-50 px-2 py-0.5 rounded-md w-fit"><i class="fas fa-map-marker-alt text-slate-300"></i> ${t.school}</div>` : ''; 
                    return `<div class="bg-white rounded-2xl shadow-sm hover:shadow-md transition border border-slate-100 p-5 flex flex-col gap-4 group"><div class="flex justify-between items-start"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-[rgb(var(--color-primary-500))] to-indigo-600 text-white flex items-center justify-center font-bold text-lg shadow-md shadow-indigo-100">${t.short[0] || '?'}</div><div><h3 class="font-bold text-slate-800 line-clamp-1 text-base">${t.name}</h3><p class="text-xs text-[rgb(var(--color-primary-600))] mt-0.5 font-bold bg-[rgb(var(--color-primary-50))] px-2 py-0.5 rounded-md w-fit">${t.specialization || 'معلم مادة'}</p>${schoolBadge}</div></div><div class="font-black text-xs px-2.5 py-1.5 rounded-lg border ${scoreColor}">${t.score}%</div></div><div class="relative group/input"><i class="fas fa-phone-alt absolute right-3.5 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within/input:text-[rgb(var(--color-primary-500))] transition-colors text-xs"></i><input type="tel" value="${t.phone || ''}" onchange="window.app.updatePhone('${t.id}', this.value)" placeholder="أضف رقم الهاتف" class="w-full pr-9 pl-3 py-2.5 text-sm rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-[rgb(var(--color-primary-500))] focus:ring-4 focus:ring-[rgb(var(--color-primary-100))] transition-all outline-none text-sm font-medium text-slate-800 placeholder:text-slate-400"></div><div class="flex gap-2 mt-auto pt-3 border-t border-slate-50"><button type="button" onclick="window.app.openActionModal('${t.id}')" class="flex-1 bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 py-2.5 rounded-xl text-xs font-bold transition cursor-pointer shadow-sm">إدارة</button><button type="button" onclick="window.app.openWhatsApp('${t.id}')" class="w-10 flex items-center justify-center bg-emerald-50 hover:bg-emerald-100 text-emerald-600 border border-emerald-100 rounded-xl transition cursor-pointer shadow-sm hover:shadow"><i class="fab fa-whatsapp text-lg"></i></button></div></div>`; 
                }).join(''); 
            }
            renderAgenda() { const tbody = document.getElementById('agendaBody'); if(!tbody) return; const agenda = this.state.agenda || []; if(agenda.length === 0) { tbody.innerHTML = `<tr><td colspan="3" class="p-8 text-center text-slate-400 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200">لا توجد أحداث مسجلة.</td></tr>`; return; } agenda.sort((a,b) => new Date(a.date).getTime() - new Date(b.date).getTime()); const todayStr = new Date().toISOString().split('T')[0]; tbody.innerHTML = agenda.map((item, index) => { const itemDateStr = new Date(item.date).toISOString().split('T')[0]; const isToday = itemDateStr === todayStr; return `<tr class="${isToday ? 'bg-yellow-50 border-r-4 border-yellow