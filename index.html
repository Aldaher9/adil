<!DOCTYPE html>
<html lang="ar" dir="rtl" data-beasties-container>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
    <title>ูุฏูุฑ ุงููุฏุฑุณุฉ ุงูุฐูู</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap');
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        brand: { 50:'#eff6ff', 100:'#dbeafe', 500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8', 900:'#1e3a8a' },
                        primary: { DEFAULT: '#4f46e5', 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
                        surface: { DEFAULT: '#ffffff', 50: '#f8fafc', 100: '#f1f5f9' }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(79, 70, 229, 0.3)'
                    }
                }
            }
        }
    </script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    
    <!-- Excel Export/Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            /* Default Theme: Sky Blue */
            --color-primary-50: 224 242 254; --color-primary-100: 186 230 253; --color-primary-500: 14 165 233; --color-primary-600: 0 138 230; --color-primary-700: 3 105 161; --color-primary-900: 12 74 110;
            --bg-body: #f8fafc; --text-main: #0f172a; --text-muted: #475569;
        }
        .theme-pink { --color-primary-50: 253 242 248; --color-primary-100: 252 231 243; --color-primary-500: 236 72 153; --color-primary-600: 219 39 119; --color-primary-700: 190 24 93; --color-primary-900: 131 24 67; }
        .theme-green { --color-primary-50: 240 253 244; --color-primary-100: 220 252 231; --color-primary-500: 34 197 94; --color-primary-600: 22 163 74; --color-primary-700: 21 128 61; --color-primary-900: 20 83 45; }
        .theme-indigo { --color-primary-50: 238 242 255; --color-primary-100: 224 231 255; --color-primary-500: 99 102 241; --color-primary-600: 79 70 229; --color-primary-700: 67 56 202; --color-primary-900: 49 46 129; }
        .theme-dark { --color-primary-50: 30 41 59; --color-primary-100: 51 65 85; --color-primary-500: 99 102 241; --color-primary-600: 129 140 248; --color-primary-700: 165 180 252; --color-primary-900: 49 46 129; --bg-body: #0f172a; --text-main: #f1f5f9; --text-muted: #94a3b8; }

        body { background-color: var(--bg-body); color: var(--text-main); transition: background-color 0.3s, color 0.3s; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .animate-blob { animation: blob 7s infinite; }
        @keyframes blob { 0% { transform: translate(0px, 0px) scale(1); } 33% { transform: translate(30px, -50px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.9); } 100% { transform: translate(0px, 0px) scale(1); } }
        
        .hidden-view { display: none !important; }
        .modal-content { z-index: 60; position: relative; }
        .modal-backdrop { z-index: 50; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        .sup-radio:checked + div { background-color: rgb(var(--color-primary-50)); border-color: rgb(var(--color-primary-600)); box-shadow: 0 0 0 1px rgb(var(--color-primary-600)); }
        .sup-radio:checked + div .check-icon { display: block; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        .theme-dark .glass-panel { background: rgba(30, 41, 59, 0.95); border-color: rgba(255, 255, 255, 0.1); }
        
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }

        .print-only { display: none; }
        .page-break { page-break-before: always; }
        @media print {
            @page {
                margin: 0.5cm;
                size: auto;
            }
            body { background-color: #fff; }
            body * { visibility: hidden; }
            .no-print { display: none !important; }
            .print-only { display: block; }
            
            /* --- LOGIC SEPARATION FOR PRINTING --- */

            /* 1. SUPERVISION REPORT ONLY */
            body.printing-supervision #view-supervision-report { background-color: transparent !important; padding: 0 !important; margin: 0 !important; display: block !important; }
            body.printing-supervision #report-document-container, 
            body.printing-supervision #report-document-container * { visibility: visible; }
            body.printing-supervision #report-document-container { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none !important; border: none !important; border-radius: 0 !important; max-width: 100% !important; }
            body.printing-supervision #report-document-container > div { padding: 1.5rem !important; padding-top: 0 !important; }
            body.printing-supervision .page-break, 
            body.printing-supervision .page-break * { visibility: visible !important; }

            /* 2. SUBSTITUTION SHEET ONLY */
            body.printing-subs #printable-substitution-sheet,
            body.printing-subs #printable-substitution-sheet * { visibility: visible; }
            body.printing-subs #printable-substitution-sheet { position: absolute; left: 0; top: 0; width: 100%; display: block !important; padding: 20px; background: white; z-index: 9999; }

            /* 3. DUTY SHEET ONLY */
            body.printing-duty #printable-duty-sheet,
            body.printing-duty #printable-duty-sheet * { visibility: visible; }
            body.printing-duty #printable-duty-sheet { position: absolute; left: 0; top: 0; width: 100%; display: block !important; padding: 20px; background: white; z-index: 9999; }
        }
        
        .task-checkbox:checked + div { text-decoration: line-through; color: var(--text-muted); opacity: 0.6; }
        
        .duty-table th, .duty-table td { white-space: nowrap; }
        .duty-cell { position: relative; }
        .duty-cell:hover .duty-actions { opacity: 1; pointer-events: auto; }
        .duty-actions { opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        @media (max-width: 768px) { .duty-actions { opacity: 1; pointer-events: auto; } }
        
        .ai-report-section h4 { font-weight: 800; color: rgb(var(--color-primary-700)); margin-bottom: 0.8rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1.15rem; }
        .ai-report-section ul { list-style: none; padding: 0; space-y: 0.8rem; }
        .ai-report-section li { position: relative; padding-right: 1.5rem; line-height: 1.7; }
        .ai-report-section li::before { content: "โข"; position: absolute; right: 0; color: rgb(var(--color-primary-500)); font-weight: bold; font-size: 1.2rem; line-height: 1.5rem; }
        
        /* New report styling */
        .report-section h3 {
            font-size: 1.1rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .report-section ul {
            list-style-type: disc;
            padding-right: 1.5rem;
            space-y: 0.5rem;
            color: #334155;
            line-height: 1.8;
        }
        .custom-scrollbar-dark::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar-dark::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar-dark::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }

        /* Login Page Specifics */
        .login-split-bg {
            background-image: url('data:image/svg+xml,%3Csvg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 1.79 4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 1.79 4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 1.79 4 4 1.79 4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z" fill="%23ffffff" fill-opacity="0.05" fill-rule="evenodd"/%3E%3C/svg%3E');
        }

    </style>
    
    <script type="importmap">
{
  "imports": {
    "rxjs": "https://esm.sh/rxjs@^7.8.2?conditions=es2015",
    "rxjs/operators": "https://esm.sh/rxjs@^7.8.2/operators?conditions=es2015",
    "@angular/core": "https://esm.sh/@angular/core@^21.1.0?external=rxjs",
    "@angular/common": "https://esm.sh/@angular/common@^21.1.0?external=rxjs",
    "@angular/forms": "https://esm.sh/@angular/forms@^21.1.0?external=rxjs"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="antialiased selection:bg-[rgb(var(--color-primary-100))] selection:text-[rgb(var(--color-primary-900))] pb-32">

    <!-- Professional Login View (Split Screen) -->
    <div id="login-view" class="min-h-screen flex w-full">
        
        <!-- Left Section (Visuals - Hidden on Mobile) -->
        <div class="hidden lg:flex w-1/2 bg-slate-900 relative items-center justify-center overflow-hidden login-split-bg">
            <!-- Animated Background Blobs -->
            <div class="absolute top-0 left-0 w-96 h-96 bg-[rgb(var(--color-primary-600))] rounded-full mix-blend-multiply filter blur-[100px] opacity-20 animate-blob"></div>
            <div class="absolute bottom-0 right-0 w-96 h-96 bg-purple-600 rounded-full mix-blend-multiply filter blur-[100px] opacity-20 animate-blob animation-delay-2000"></div>
            
            <div class="relative z-10 text-center p-12 max-w-lg">
                <img src="/favicon_512x512.png" class="w-32 h-32 mx-auto mb-8 drop-shadow-2xl hover:scale-105 transition-transform duration-500" alt="App Logo">
                <h2 class="text-4xl font-extrabold text-white mb-6 leading-tight">ุดุฑููู ุงูุฐูู ูู<br/>ุงูุฅุฏุงุฑุฉ ุงููุฏุฑุณูุฉ</h2>
                <p class="text-slate-300 text-lg font-medium leading-relaxed">
                    ููุตุฉ ูุชูุงููุฉ ุชุฌูุน ุจูู ููุฉ ุงูุจูุงูุงุช ูุณูููุฉ ุงูุงุณุชุฎุฏุงูุ ูุฏุนููุฉ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุฑูุน ููุงุกุฉ ุงูุฃุฏุงุก ุงููุฏุฑุณู.
                </p>
                
                <!-- Trust Badges -->
                <div class="flex items-center justify-center gap-6 mt-12 opacity-70">
                    <div class="flex flex-col items-center gap-2">
                        <i class="fas fa-shield-alt text-2xl text-emerald-400"></i>
                        <span class="text-xs text-white font-bold">ุขูู ููุญูู</span>
                    </div>
                    <div class="flex flex-col items-center gap-2">
                        <i class="fas fa-bolt text-2xl text-amber-400"></i>
                        <span class="text-xs text-white font-bold">ุฃุฏุงุก ููุฑู</span>
                    </div>
                    <div class="flex flex-col items-center gap-2">
                        <i class="fas fa-brain text-2xl text-purple-400"></i>
                        <span class="text-xs text-white font-bold">ุฐูุงุก ุงุตุทูุงุนู</span>
                    </div>
                </div>
            </div>
            
            <!-- Bottom Copyright -->
            <div class="absolute bottom-6 text-slate-500 text-xs font-mono dir-ltr">
                ยฉ 2024 School Manager Pro
            </div>
        </div>

        <!-- Right Section (Form) -->
        <div class="w-full lg:w-1/2 flex items-center justify-center bg-white p-6 md:p-12 relative">
             <!-- Mobile Background Elements -->
            <div class="absolute lg:hidden top-0 left-0 w-full h-2 bg-gradient-to-r from-[rgb(var(--color-primary-500))] to-purple-600"></div>
            
            <div class="w-full max-w-md space-y-8">
                <!-- Mobile Logo -->
                <div class="text-center lg:text-right">
                     <img src="/favicon_180x180.png" class="w-16 h-16 mx-auto lg:mx-0 lg:hidden mb-4 rounded-xl shadow-md" alt="Logo">
                     <h1 class="text-3xl md:text-4xl font-black text-slate-900 tracking-tight">ูุฑุญุจุงู ุจู ๐</h1>
                     <p class="text-slate-500 mt-2 font-medium">ุณุฌู ุงูุฏุฎูู ูููุชุงุจุนุฉ ุฅูู ููุญุฉ ุงูุชุญูู</p>
                </div>

                <div class="space-y-4 pt-4">
                    <!-- Google Login Button -->
                    <button onclick="window.app.handleGoogleLogin()" class="w-full group relative flex items-center justify-center gap-3 bg-white text-slate-700 hover:text-slate-900 border border-slate-200 hover:border-slate-300 hover:bg-slate-50 py-4 rounded-2xl font-bold transition-all duration-300 shadow-sm hover:shadow-md cursor-pointer overflow-hidden">
                        <div class="absolute inset-y-0 left-0 w-1 bg-slate-900 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <img src="https://www.google.com/favicon.ico" class="w-6 h-6" alt="Google">
                        <span class="text-base">ูุฏูุฑ ุงููุฏุฑุณุฉ (Google)</span>
                    </button>

                    <!-- Staff Login Button (NEW) -->
                    <button onclick="document.getElementById('modal-staff-login').classList.remove('hidden-view')" class="w-full group relative flex items-center justify-center gap-3 bg-indigo-50 text-indigo-700 hover:text-indigo-900 border border-indigo-200 hover:border-indigo-300 hover:bg-indigo-100 py-4 rounded-2xl font-bold transition-all duration-300 shadow-sm hover:shadow-md cursor-pointer overflow-hidden">
                        <i class="fas fa-users-cog text-xl"></i>
                        <span class="text-base">ุฏุฎูู ุงููุงุฏุฑ ุงูุฅุฏุงุฑู / ุงููุนูููู</span>
                    </button>

                    <div class="relative flex py-2 items-center">
                        <div class="flex-grow border-t border-slate-100"></div>
                        <span class="flex-shrink-0 mx-4 text-slate-300 text-xs font-bold uppercase">ุฃู</span>
                        <div class="flex-grow border-t border-slate-100"></div>
                    </div>

                    <!-- Visitor Button -->
                    <button onclick="window.app.skipLogin()" class="w-full flex items-center justify-center gap-3 bg-slate-50 text-slate-500 hover:text-slate-700 hover:bg-slate-100 py-3.5 rounded-2xl font-bold transition-all duration-200 cursor-pointer text-sm">
                        <i class="fas fa-user-secret"></i>
                        <span>ุชุฌุฑุจุฉ ุงูุฒุงุฆุฑ (Offline)</span>
                    </button>
                </div>

                <!-- Info Box -->
                <div class="bg-[rgb(var(--color-primary-50))] rounded-xl p-4 flex gap-3 items-start border border-[rgb(var(--color-primary-100))]">
                    <i class="fas fa-info-circle text-[rgb(var(--color-primary-500))] mt-0.5"></i>
                    <p class="text-xs text-[rgb(var(--color-primary-800))] font-bold leading-relaxed">
                        ูุชู ุญูุธ ุจูุงูุงุช ุงูุฏุฎูู ูุญููุงู ูุถูุงู ุงุณุชูุฑุงุฑูุฉ ุงูุงุชุตุงู ุจุฎุฏูุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุชูููุฏ ุงูุชูุงุฑูุฑ ุฏูู ุงููุทุงุน.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- App View -->
    <div id="app-view" class="hidden-view">
    
    <!-- Header -->
    <header class="glass-panel sticky top-0 z-40 shadow-sm no-print transition-all duration-300">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 text-slate-800 select-none">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center shadow-sm overflow-hidden bg-white">
                            <img src="/favicon_180x180.png" class="w-full h-full object-cover" alt="Logo">
                        </div>
                        <h1 class="font-extrabold text-lg hidden md:block tracking-tight text-slate-900">ูุฏูุฑ ุงููุฏุฑุณุฉ</h1>
                    </div>
                    <div class="h-6 w-px bg-slate-300 hidden md:block"></div>
                    <div id="user-profile-container" class="flex items-center gap-3"></div>
                </div>

                <div class="flex gap-3 items-center">
                    <div class="hidden md:flex bg-slate-100 px-4 py-2 rounded-xl border border-slate-200 items-center gap-2 shadow-inner">
                        <i class="fas fa-clock text-slate-500 text-sm animate-pulse"></i>
                        <span id="clockDisplay" class="font-mono font-bold text-slate-900 dir-ltr text-sm tracking-widest">00:00:00</span>
                    </div>
                    <div id="cloudStatusIndicator" class="hidden sm:flex items-center"></div>
                    <div class="flex bg-slate-100 p-1 rounded-xl gap-1 border border-slate-200">
                        <button onclick="window.app.simulateRandomPeriod()" class="px-3 py-1.5 rounded-lg text-[10px] md:text-xs font-bold transition flex items-center gap-2 cursor-pointer bg-white text-indigo-700 shadow-sm hover:shadow hover:bg-indigo-50 border border-slate-200" title="ุชุฌุฑุจุฉ ุญุตุฉ ุนุดูุงุฆูุฉ">
                            <i class="fas fa-dice text-amber-500"></i><span class="hidden sm:inline">ูุญุงูุงุฉ</span>
                        </button>
                        <button onclick="window.app.resetTimeToReal()" class="px-3 py-1.5 rounded-lg text-[10px] md:text-xs font-bold transition flex items-center gap-2 cursor-pointer text-slate-600 hover:text-slate-900 hover:bg-white/80" title="ุงูุนูุฏุฉ ููููุช ุงููุนูู">
                            <i class="fas fa-sync-alt"></i><span class="hidden sm:inline">ูุนูู</span>
                        </button>
                    </div>
                    <button id="btn-settings-main" onclick="window.app.openSettings()" class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-800 text-white hover:bg-slate-700 transition shadow-lg shadow-slate-300 cursor-pointer" title="ุงูุฅุนุฏุงุฏุงุช">
                        <i class="fas fa-cog fa-spin-hover"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-6 space-y-8 max-w-7xl">
        <!-- Content remains same as before, truncated for brevity in diff but full in logic -->
        <!-- View: Current Classes -->
        <section id="view-now" class="fade-in space-y-6">
            <div class="relative overflow-hidden bg-gradient-to-r from-[rgb(var(--color-primary-700))] to-[rgb(var(--color-primary-900))] p-6 md:p-8 rounded-3xl shadow-xl text-white">
                <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full -mr-16 -mt-16 blur-2xl"></div>
                <div class="absolute bottom-0 left-0 w-40 h-40 bg-[rgb(var(--color-primary-500))] opacity-20 rounded-full -ml-10 -mb-10 blur-xl"></div>
                <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="flex items-center gap-5">
                        <div class="bg-white/20 backdrop-blur-sm p-4 rounded-2xl shadow-inner border border-white/10"><i class="fas fa-chalkboard-user text-3xl text-white"></i></div>
                        <div>
                            <h2 class="text-2xl md:text-3xl font-extrabold mb-1 text-white tracking-tight">ููุญุฉ ุงูููุงุฏุฉ ุงููุฏุฑุณูุฉ</h2>
                            <p class="text-white/90 text-sm font-bold">ูุชุงุจุนุฉ ุญูุฉ ูุณูุฑ ุงูููู ุงูุฏุฑุงุณู</p>
                        </div>
                    </div>
                    <div id="currentPeriodInfo" class="bg-white/10 backdrop-blur-md rounded-2xl p-2 border border-white/10"></div>
                </div>
            </div>
            <div>
                <div class="flex items-center justify-between mb-4 px-2">
                    <h3 class="font-extrabold text-slate-800 text-lg flex items-center gap-2"><i class="fas fa-layer-group text-[rgb(var(--color-primary-600))]"></i> ุงูุญุตุต ุงููุงุฆูุฉ</h3>
                    <span class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-lg border border-slate-200">ูุจุงุดุฑ</span>
                </div>
                <!-- Updated grid cols for larger cards -->
                <div id="activeClassesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
            </div>
            <div id="dailyDutyWidget" class="bg-white rounded-3xl shadow-soft border border-slate-200 p-6 hidden-view">
                <h3 class="text-lg font-extrabold text-slate-900 mb-6 flex items-center gap-3">
                    <div class="w-9 h-9 rounded-xl bg-amber-100 text-amber-700 flex items-center justify-center shadow-sm"><i class="fas fa-user-shield"></i></div>
                    <div>ููุงูุจุฉ ุงูููู<span id="dailyDutyDate" class="block text-xs text-slate-500 font-bold mt-0.5"></span></div>
                </h3>
                <div id="dailyDutyGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
            </div>
        </section>

        <!-- View: Substitution -->
        <section id="view-reserve" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col md:flex-row justify-between gap-6 bg-white p-8 rounded-3xl shadow-soft border border-slate-200 items-center">
                <div class="flex items-center gap-5 w-full md:w-auto">
                    <div class="bg-gradient-to-br from-red-500 to-rose-600 text-white w-16 h-16 rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-red-200"><i class="fas fa-user-clock"></i></div>
                    <div><h2 class="text-2xl font-extrabold text-slate-900">ุฅุฏุงุฑุฉ ุงูุงุญุชูุงุท</h2><p class="text-slate-600 font-medium text-sm mt-1">ุชูุฒูุน ุญุตุต ุงูุบูุงุจ ุจุฐูุงุก ูุนุฏุงูุฉ</p></div>
                </div>
                <div class="relative w-full md:w-96 bg-slate-50 p-2 rounded-2xl border border-slate-200">
                    <label class="text-[10px] font-bold text-slate-500 block px-3 mb-1 uppercase tracking-wider">ุงููุนูู ุงูุบุงุฆุจ</label>
                    <select id="absentTeacherSelect" onchange="window.app.handleAbsentSelection(this.value)" class="w-full bg-white border-0 rounded-xl p-3 text-slate-800 font-extrabold outline-none focus:ring-2 focus:ring-[rgb(var(--color-primary-300))] shadow-sm cursor-pointer appearance-none"><option value>-- ุงุฎุชุฑ ูู ุงููุงุฆูุฉ --</option></select>
                    <div class="absolute left-4 bottom-4 text-slate-500 pointer-events-none"><i class="fas fa-chevron-down"></i></div>
                </div>
            </div>
            <div id="absentScheduleContainer" class="space-y-4 min-h-[300px]"></div>
            <div class="bg-white rounded-3xl shadow-soft border border-slate-200 overflow-hidden mt-8">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <h3 class="font-extrabold text-slate-800 text-lg flex items-center gap-2"><i class="fas fa-list-ol text-[rgb(var(--color-primary-600))]"></i> ุณุฌู ุงูุงุญุชูุงุท ุงููููู</h3>
                    <button onclick="window.app.printSubstitutions()" class="bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 px-4 py-2 rounded-xl font-bold text-xs flex items-center gap-2 transition shadow-sm"><i class="fas fa-print"></i> ุทุจุงุนุฉ / PDF</button>
                </div>
                <div id="dailySubstitutionsList" class="divide-y divide-slate-100"></div>
            </div>
        </section>

        <!-- View: Teachers -->
        <section id="view-teachers" class="fade-in space-y-6 hidden-view">
            <div class="sticky top-24 z-30 bg-white/95 backdrop-blur-md p-4 rounded-2xl shadow-sm border border-slate-200 mb-6 flex flex-col md:flex-row gap-4 justify-between items-center">
                <div class="flex items-center gap-3">
                    <h2 class="text-xl font-extrabold text-slate-900">ุณุฌู ุงููุนูููู</h2>
                    <span class="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded-md border border-slate-200" id="teachersCountBadge">0</span>
                </div>
                <div class="relative w-full md:w-80 group">
                    <input type="text" id="teacherSearch" onkeyup="window.app.renderTeachers()" placeholder="ุจุญุซ ุณุฑูุน..." class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-[rgb(var(--color-primary-500))] focus:ring-4 focus:ring-[rgb(var(--color-primary-100))] transition-all outline-none text-sm font-medium text-slate-800 placeholder:text-slate-400">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-[rgb(var(--color-primary-600))] transition-colors"></i>
                </div>
            </div>
            <div id="teachersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 pb-20"></div>
        </section>

        <!-- View: Duty Schedule -->
        <section id="view-duty" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col md:flex-row justify-between gap-4 bg-white p-8 rounded-3xl shadow-soft border border-slate-200">
                <div class="flex items-center gap-5">
                    <div class="bg-gradient-to-br from-amber-400 to-orange-500 text-white w-16 h-16 rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-orange-200"><i class="fas fa-calendar-check"></i></div>
                    <div><h2 class="text-2xl font-extrabold text-slate-900">ุฌุฏูู ุงูููุงูุจุฉ ุงูุฃุณุจูุนู</h2><p class="text-slate-600 font-medium text-sm mt-1">ุชูุฒูุน ููุชุงุจุนุฉ ููุงุท ุงูููุงูุจุฉ</p></div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="window.app.addDutyLocationPrompt()" class="bg-slate-800 hover:bg-slate-700 text-white px-5 py-3 rounded-xl font-bold flex items-center gap-2 transition shadow-lg cursor-pointer text-sm"><i class="fas fa-plus"></i><span>ูููุน ุฌุฏูุฏ</span></button>
                    <button onclick="window.app.printDutySchedule()" class="bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 px-5 py-3 rounded-xl font-bold flex items-center gap-2 transition shadow-sm cursor-pointer text-sm"><i class="fas fa-print"></i><span>ุทุจุงุนุฉ</span></button>
                </div>
            </div>
            <div class="bg-white rounded-3xl shadow-soft border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-right duty-table table-auto">
                        <thead class="bg-slate-50 border-b border-slate-200 text-slate-600 text-xs font-bold uppercase tracking-wider">
                            <tr id="dutyHeaderRow"></tr>
                        </thead>
                        <tbody id="dutyBody" class="divide-y divide-slate-100 text-sm font-bold text-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- View: Periods -->
        <section id="view-periods" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col md:flex-row justify-between gap-4 bg-white p-8 rounded-3xl shadow-soft border border-slate-200">
                <div class="flex items-center gap-5">
                    <div class="bg-gradient-to-br from-sky-400 to-blue-500 text-white w-16 h-16 rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-blue-200"><i class="fas fa-hourglass-half"></i></div>
                    <div><h2 class="text-2xl font-extrabold text-slate-900">ุถุจุท ุชูููุช ุงูุญุตุต</h2><p class="text-slate-600 font-medium text-sm mt-1">ุชุนุฏูู ุฃููุงุช ุจุฏุก ูุงูุชูุงุก ุงูููู ุงูุฏุฑุงุณู</p></div>
                </div>
            </div>
            <div id="periodsListContainer" class="space-y-3"></div>
            <div class="mt-6"><button onclick="window.app.addPeriod()" class="w-full bg-slate-50 hover:bg-slate-100 text-slate-700 border-2 border-dashed border-slate-200 hover:border-slate-300 px-5 py-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition cursor-pointer text-sm"><i class="fas fa-plus"></i><span>ุฅุถุงูุฉ ุญุตุฉ ุฌุฏูุฏุฉ</span></button></div>
        </section>
        
        <!-- View: Instructions (RESTORED) -->
        <section id="view-instructions" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col md:flex-row justify-between gap-4 bg-white p-8 rounded-3xl shadow-soft border border-slate-200">
                <div class="flex items-center gap-5">
                    <div class="bg-gradient-to-br from-sky-400 to-blue-500 text-white w-16 h-16 rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-blue-200">
                        <i class="fas fa-question-circle"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-extrabold text-slate-900">ูุฑูุฒ ุงููุณุงุนุฏุฉ ูุงูุชุนูููุงุช</h2>
                        <p class="text-slate-600 font-medium text-sm mt-1">ุฏููู ุงุณุชุฎุฏุงู ูุฒุงูุง ุงูุชุทุจูู ุงููุชูุฏูุฉ</p>
                    </div>
                </div>
                <button onclick="window.app.setView('now')" class="bg-slate-50 hover:bg-slate-100 text-slate-700 border border-slate-200 px-5 py-3 rounded-xl font-bold flex items-center gap-2 transition shadow-sm cursor-pointer text-sm">
                    <i class="fas fa-arrow-right"></i><span>ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</span>
                </button>
            </div>

            <!-- Instruction Cards (4 Items) -->
            <div class="space-y-5">
                <!-- Card 1 -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                    <h3 class="font-extrabold text-slate-900 mb-4 text-lg">1. ุงุณุชูุฑุงุฏ ุฌุฏูู ุงูุญุตุต (ููู XML)</h3>
                    <ol class="list-decimal list-inside space-y-2 text-sm text-slate-700 font-medium">
                        <li>ูู ุจุฑูุงูุฌ ุงูุฌุฏุงูู ุงููุฏุฑุณูุฉ aSc Timetablesุ ูู ุจุชุตุฏูุฑ ุงูุฌุฏูู ุจุตูุบุฉ XML.</li>
                        <li>ุงูุชุญ <span class="font-bold">ุงูุฅุนุฏุงุฏุงุช</span> <i class="fas fa-cog"></i> ูู ูุฐุง ุงูุชุทุจูู.</li>
                        <li>ุถูู ูุณู "ุฃุฏูุงุช ุงูุจูุงูุงุช"ุ ุงุถุบุท ุนูู ุฒุฑ "ุฑูุน ููู XML".</li>
                        <li>ุงุฎุชุฑ ุงูููู ุงูุฐู ููุช ุจุชุตุฏูุฑู. ุณูุชู ุงุณุชูุฑุงุฏ ุจูุงูุงุช ุงููุนูููู ูุงูุญุตุต ูุงูุชูููุช ุชููุงุฆูุงู.</li>
                    </ol>
                </div>
                <!-- Card 2 -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                    <h3 class="font-extrabold text-slate-900 mb-4 text-lg">2. ุงุณุชูุฑุงุฏ ูุงุฆูุฉ ุงููุนูููู (ุฎุงุต ุจุงููุดุฑู ุงูุชุฑุจูู)</h3>
                     <ol class="list-decimal list-inside space-y-2 text-sm text-slate-700 font-medium">
                        <li>ุงูุชุญ <span class="font-bold">ุงูุฅุนุฏุงุฏุงุช</span> <i class="fas fa-cog"></i>.</li>
                        <li>ุถูู "ุฃุฏูุงุช ุงููุดุฑู ุงูุชุฑุจูู"ุ ุงุถุบุท ุนูู ุฒุฑ "ูููุฐุฌ ุงููุดุฑู" ูุชูุฒูู ููู Excel.</li>
                        <li>ุงููุฃ ุงูููู ุจุจูุงูุงุช ุงููุนูููู ุงูุฐูู ุชุดุฑู ุนูููู (ุงูุงุณูุ ุงููุฏุฑุณุฉุ ุงูุชุฎุตุต...).</li>
                        <li>ุนุฏ ุฅูู ููุณ ุงููุณู ูุงุถุบุท "ุงุณุชูุฑุงุฏ ุงููุงุฆูุฉ" ูุฑูุน ุงูููู ุจุนุฏ ุชุนุจุฆุชู.</li>
                    </ol>
                    <button onclick="window.app.exportTeacherTemplate()" class="mt-4 bg-orange-600 hover:bg-orange-700 text-white text-xs font-bold py-2 px-4 rounded-lg transition shadow-sm cursor-pointer"><i class="fas fa-download mr-1"></i> ุชูุฒูู ูููุฐุฌ ุงููุดุฑู (Excel)</button>
                </div>
                <!-- Card 3 -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                    <h3 class="font-extrabold text-slate-900 mb-4 text-lg">3. ุงุณุชูุฑุงุฏ ุฃุฑูุงู ููุงุชู ุงููุนูููู</h3>
                     <ol class="list-decimal list-inside space-y-2 text-sm text-slate-700 font-medium">
                        <li>ุงุถุบุท ุนูู ุงูุฒุฑ ุฃุฏูุงู ูุชูุฒูู ูุงูุจ Excel ุฌุงูุฒ ูุญุชูู ุนูู ุฃุณูุงุก ูุฃุฑูุงู ูููุฉ ุงููุนูููู.</li>
                        <li>ุงููุฃ ุนููุฏ `Phone` ุจุฃุฑูุงู ุงูููุงุชู ุงูุตุญูุญุฉ ููู ูุนูู.</li>
                        <li>ูู <span class="font-bold">ุงูุฅุนุฏุงุฏุงุช</span> <i class="fas fa-cog"></i>ุ ูุณู "ุจูุงูุงุช ุงููุนูููู (Excel)"ุ ุงุถุบุท "ุงุณุชูุฑุงุฏ Excel" ููู ุจุฑูุน ุงูููู ุจุนุฏ ุชุนุฏููู.</li>
                    </ol>
                    <button onclick="window.app.exportPhoneTemplate()" class="mt-4 bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold py-2 px-4 rounded-lg transition shadow-sm cursor-pointer"><i class="fas fa-download mr-1"></i> ุชูุฒูู ูุงูุจ ุฃุฑูุงู ุงูููุงุชู</button>
                </div>
                <!-- Card 4 -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                    <h3 class="font-extrabold text-slate-900 mb-4 text-lg">4. ุชุนุฏูู ุนุจุงุฑุงุช ุงูุชูููู ููุฒูุงุฑุงุช ุงูุฅุดุฑุงููุฉ</h3>
                     <ol class="list-decimal list-inside space-y-2 text-sm text-slate-700 font-medium">
                        <li>ุงุถุบุท ุนูู ุงูุฒุฑ ุฃุฏูุงู ูุชูุฒูู ููู `Evaluation_Criteria_Template.xlsx` ุงูุฐู ูุญุชูู ุนูู ุงูุนุจุงุฑุงุช ุงูุงูุชุฑุงุถูุฉ.</li>
                        <li>ุงูุชุญ ุงูููู ุจุงุณุชุฎุฏุงู ุจุฑูุงูุฌ Excel ููู ุจุชุนุฏูู ุงูุนุจุงุฑุงุช ุจูุง ููุงุณุจู ูุน ุงูุญูุงุธ ุนูู ูููู ุงูุฃุนูุฏุฉ.</li>
                        <li>ุงูุชุญ <span class="font-bold">ุงูุฅุนุฏุงุฏุงุช</span> <i class="fas fa-cog"></i>.</li>
                        <li>ุถูู "ูุงุนุฏุฉ ุจูุงูุงุช ุงูุฒูุงุฑุงุช"ุ ุงุถุบุท ุนูู ุฒุฑ "ุงุณุชูุฑุงุฏ ูุงุนุฏุฉ ุงููุนุงููุฑ (Excel)" ููู ุจุฑูุน ุงูููู ุงููุนุฏู.</li>
                    </ol>
                    <button onclick="window.app.downloadCriteriaTemplateExcel()" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold py-2 px-4 rounded-lg transition shadow-sm cursor-pointer"><i class="fas fa-download mr-1"></i> ุชูุฒูู ูุงูุจ ุงูุนุจุงุฑุงุช (Excel)</button>
                </div>
            </div>
        </section>

        <!-- Supervision Hub -->
        <section id="view-supervision-hub" class="fade-in space-y-8 hidden-view">
             <div class="flex flex-col md:flex-row justify-between gap-6 bg-white p-8 rounded-3xl shadow-soft border border-slate-200 items-center">
                <div class="flex items-center gap-5">
                    <div class="bg-gradient-to-br from-purple-500 to-indigo-600 text-white w-16 h-16 rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-purple-200"><i class="fas fa-clipboard-check"></i></div>
                    <div><h2 class="text-2xl font-extrabold text-slate-900">ูุฑูุฒ ุงูุฅุดุฑุงู ุงูููู</h2><p class="text-slate-600 font-medium text-sm mt-1">ุฅุฏุงุฑุฉ ุงูุฒูุงุฑุงุช ุงูุตููุฉ ูุชูุงุฑูุฑ ุงูุฃุฏุงุก</p></div>
                </div>
                <button onclick="window.app.startSupervision()" class="bg-[rgb(var(--color-primary-600))] hover:bg-[rgb(var(--color-primary-700))] text-white px-8 py-4 rounded-2xl font-bold flex items-center gap-3 transition shadow-xl hover:shadow-2xl hover:-translate-y-1 cursor-pointer"><i class="fas fa-plus-circle text-xl"></i><span>ุจุฏุก ุฒูุงุฑุฉ ุฌุฏูุฏุฉ</span></button>
            </div>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-between h-40 card-hover">
                    <div class="flex justify-between items-start"><div class="bg-blue-50 text-blue-600 w-12 h-12 rounded-2xl flex items-center justify-center text-xl"><i class="fas fa-chart-pie"></i></div><span class="text-xs font-bold text-slate-500 bg-slate-50 px-2 py-1 rounded-lg border border-slate-100">ุชุฑุงููู</span></div>
                    <div><div class="text-3xl font-extrabold text-slate-900" id="hubTotalVisits">0</div><span class="text-xs text-slate-500 font-bold">ุฅุฌูุงูู ุงูุฒูุงุฑุงุช</span></div>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-between h-40 card-hover">
                    <div class="flex justify-between items-start"><div class="bg-emerald-50 text-emerald-600 w-12 h-12 rounded-2xl flex items-center justify-center text-xl"><i class="fas fa-star"></i></div><span class="text-xs font-bold text-slate-500 bg-slate-50 px-2 py-1 rounded-lg border border-slate-100">ูุชูุณุท</span></div>
                    <div><div class="text-3xl font-extrabold text-slate-900" id="hubAvgScore">0%</div><span class="text-xs text-slate-500 font-bold">ุงูุฃุฏุงุก ุงูุนุงู</span></div>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-center gap-3 h-40">
                    <button onclick="window.app.setView('supervision-history')" class="w-full bg-slate-50 hover:bg-slate-100 text-slate-700 py-2.5 rounded-xl font-bold text-xs transition flex items-center justify-between px-4 cursor-pointer border border-slate-200 hover:border-slate-300"><span>ุณุฌู ุงูุฒูุงุฑุงุช ุงููุงูู</span><i class="fas fa-arrow-left text-slate-400"></i></button>
                    <button onclick="window.app.setView('reports')" class="w-full bg-slate-50 hover:bg-slate-100 text-slate-700 py-2.5 rounded-xl font-bold text-xs transition flex items-center justify-between px-4 cursor-pointer border border-slate-200 hover:border-slate-300"><span>ุชูุงุฑูุฑ ุงูุฃุฏุงุก ุงูุนุงู</span><i class="fas fa-arrow-left text-slate-400"></i></button>
                </div>
            </div>
            <div class="bg-white rounded-3xl shadow-soft border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50"><h3 class="font-extrabold text-slate-800 text-lg">ุฃุญุฏุซ ุงูุฒูุงุฑุงุช ุงููุณุฌูุฉ</h3><i class="fas fa-history text-slate-300"></i></div>
                <div id="hubRecentList" class="divide-y divide-slate-100"></div>
            </div>
        </section>

        <!-- Supervision Form -->
        <section id="view-supervision" class="fade-in space-y-6 hidden-view pb-24">
             <div class="flex items-center gap-2 mb-4 text-sm text-slate-500 font-bold cursor-pointer hover:text-[rgb(var(--color-primary-600))] transition" onclick="window.app.setView('supervision-hub')"><i class="fas fa-arrow-right"></i> ุนูุฏุฉ ููุฑูุฒ ุงูุฅุดุฑุงู</div>
            <div class="bg-white p-8 rounded-3xl shadow-soft border border-slate-200">
                <h2 class="text-2xl font-extrabold text-slate-900 mb-8 flex items-center gap-3 pb-4 border-b border-slate-100">
                    <span class="bg-[rgb(var(--color-primary-50))] text-[rgb(var(--color-primary-700))] w-10 h-10 rounded-xl flex items-center justify-center text-lg border border-[rgb(var(--color-primary-100))]"><i class="fas fa-magic"></i></span> ุฒูุงุฑุฉ ุฅุดุฑุงููุฉ ุฐููุฉ
                </h2>
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div class="space-y-1"><label class="text-xs font-bold text-slate-600 mr-1">ุงููุนูู</label><input type="text" id="supTeacherName" readonly class="hidden w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-slate-800 font-extrabold"><div class="relative"><select id="supTeacherSelect" onchange="window.app.onTeacherSelectChange()" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-slate-800 focus:border-[rgb(var(--color-primary-500))] focus:bg-white focus:ring-4 focus:ring-[rgb(var(--color-primary-50))] outline-none appearance-none font-extrabold transition-all cursor-pointer"><option value>ุงุฎุชุฑ ุงููุนูู...</option></select><i class="fas fa-chevron-down absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i></div></div>
                    <div class="space-y-1"><label class="text-xs font-bold text-slate-600 mr-1">ุงูุชุฎุตุต</label><div class="relative"><select id="supSpecialization" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-slate-800 focus:border-[rgb(var(--color-primary-500))] focus:bg-white focus:ring-4 focus:ring-[rgb(var(--color-primary-50))] outline-none appearance-none font-extrabold transition-all cursor-pointer"><option value>ุงุฎุชุฑ ุงูุชุฎุตุต...</option></select><i class="fas fa-chevron-down absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i></div></div>
                    <div class="space-y-1"><label class="text-xs font-bold text-slate-600 mr-1">ุงูุตู</label><input type="text" id="supClassName" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-slate-800 focus:border-[rgb(var(--color-primary-500))] focus:bg-white focus:ring-4 focus:ring-[rgb(var(--color-primary-50))] outline-none font-extrabold transition-all"></div>
                    <div class="space-y-1"><label class="text-xs font-bold text-slate-600 mr-1">ุนููุงู ุงูุฏุฑุณ</label><input type="text" id="supLessonTopic" placeholder="ุฃุฏุฎู ุนููุงู ุงูุฏุฑุณ..." class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-slate-800 focus:border-[rgb(var(--color-primary-500))] focus:bg-white focus:ring-4 focus:ring-[rgb(var(--color-primary-50))] outline-none font-extrabold transition-all"></div>
                    <div class="md:col-span-2 space-y-2"><label class="text-xs font-bold text-slate-600 mr-1">ููุน ุงููุฏุฑุณุฉ</label><div class="flex gap-4 items-center bg-slate-50 border border-slate-200 rounded-xl p-2 w-fit"><label class="flex items-center gap-2 cursor-pointer px-3 py-1 hover:bg-white rounded-lg transition"><input type="radio" id="supGenderMale" name="supSchoolGender" value="male" class="accent-[rgb(var(--color-primary-600))]" checked><span class="text-sm font-bold text-slate-700">ุจููู</span></label><label class="flex items-center gap-2 cursor-pointer px-3 py-1 hover:bg-white rounded-lg transition"><input type="radio" id="supGenderFemale" name="supSchoolGender" value="female" class="accent-pink-600"><span class="text-sm font-bold text-slate-700">ุจูุงุช</span></label></div></div>
                </div>
                <div id="supervisionCriteriaList" class="space-y-6"></div>
                <button onclick="window.app.generateReport()" class="w-full bg-gradient-to-r from-[rgb(var(--color-primary-600))] to-indigo-600 hover:from-[rgb(var(--color-primary-700))] hover:to-indigo-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-indigo-200 transition-all transform hover:-translate-y-1 mt-10 flex items-center justify-center gap-2 cursor-pointer text-lg"><i class="fas fa-wand-magic-sparkles"></i> ุชูููุฏ ุงูุชูุฑูุฑ ุงูุฐูู</button>
            </div>
        </section>

        <!-- NEW Report View -->
        <section id="view-supervision-report" class="fade-in space-y-6 hidden-view bg-slate-100 p-4 md:p-8">
            <div class="flex flex-wrap gap-2 mt-4 no-print max-w-4xl mx-auto">
                <button onclick="window.app.printSupervisionReport()" class="flex-1 bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 cursor-pointer shadow-lg text-xs md:text-sm"><i class="fas fa-print"></i> ุทุจุงุนุฉ</button>
                <button id="btn-enhance-ai" class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-700 hover:from-purple-700 hover:to-indigo-800 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 cursor-pointer shadow-lg shadow-indigo-200/50 text-xs md:text-sm relative">
                    <i class="fas fa-wand-magic-sparkles"></i>
                    <span>ุชุญุณูู</span>
                    <span id="btn-enhance-ai-badge" class="absolute -top-2 -right-2 bg-amber-400 text-slate-900 text-[9px] font-bold px-2 py-0.5 rounded-full border-2 border-white shadow-md">
                        <i class="fas fa-star text-amber-600 text-xs"></i> 5 ูุฌุงูุงู
                    </span>
                </button>
                <button onclick="window.app.copyToClipboardPrompt()" class="flex-1 bg-sky-600 hover:bg-sky-700 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 cursor-pointer shadow-lg shadow-sky-100 text-xs md:text-sm">
                    <i class="fas fa-copy"></i> ูุณุฎ ุงููุต
                </button>
                <button onclick="window.app.saveVisit()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 cursor-pointer shadow-lg shadow-emerald-100 text-xs md:text-sm"><i class="fas fa-save"></i> ุญูุธ</button>
                <button onclick="window.app.setView('supervision')" class="flex-1 bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 py-3 rounded-xl font-bold transition cursor-pointer text-xs md:text-sm">ุชุนุฏูู</button>
                <button onclick="window.app.setView('supervision-history')" class="flex-1 bg-red-50 border border-red-100 text-red-600 hover:bg-red-100 py-3 rounded-xl font-bold transition cursor-pointer text-xs md:text-sm">ุฅุบูุงู</button>
            </div>
            <div id="report-document-container" class="bg-white max-w-4xl mx-auto shadow-2xl rounded-lg border border-slate-200">
                <!-- PAGE 1 -->
                <div class="p-10">
                    <header class="text-center pb-4 border-b-2 border-black">
                        <img src="./oman-emblem.png" alt="ุดุนุงุฑ ุณูุทูุฉ ุนูุงู" class="h-16 w-auto object-contain mx-auto mb-2"/>
                        <div class="text-xs space-y-1 font-bold text-slate-800">
                            <p>ุณูุทูุฉ ุนููุงู</p>
                            <p>ูุฒุงุฑุฉ ุงูุชุฑุจูุฉ ูุงูุชุนููู</p>
                            <p id="repDirectorate">ุงููุฏูุฑูุฉ ุงูุนุงูุฉ ููุชุฑุจูุฉ ูุงูุชุนููู ุจูุญุงูุธุฉ ูุณูุท</p>
                        </div>
                    </header>

                    <h1 class="text-center text-xl font-extrabold my-6 text-slate-900">ุงุณุชูุงุฑุฉ ุงูุฒูุงุฑุฉ ุงูุฅุดุฑุงููุฉ ููุนูู ูุฌุงู/ ูุงุฏุฉ</h1>
                    
                    <div class="grid grid-cols-2 gap-x-8 gap-y-2 border border-slate-500 rounded-lg p-4 text-sm mb-4">
                        <div><strong>ุงูุงุณู:</strong> <span id="repTeacherName" class="font-medium"></span></div>
                        <div><strong>ุงููุฏุฑุณุฉ:</strong> <span id="repSchoolName" class="font-medium"></span></div>
                        <div><strong>ุชุงุฑูุฎ ุงูุฒูุงุฑุฉ:</strong> <span id="repVisitDate" class="font-medium font-mono"></span></div>
                        <div><strong>ุฑูู ุงูููู:</strong> <span class="font-medium font-mono">16210112</span></div>
                        <div><strong>ุงููุฑุญูุฉ:</strong> <span class="font-medium">ุฃุณุงุณู (5 - 10)</span></div>
                        <div><strong>ุฑูู ุงูุฒูุงุฑุฉ:</strong> <span class="font-medium">1</span></div>
                        <div class="col-span-2 grid grid-cols-3 gap-x-8">
                            <div><strong>ุงูุตู:</strong> <span id="repClassName" class="font-medium"></span></div>
                            <div><strong>ุงููุตู:</strong> <span class="font-medium">2</span></div>
                            <div><strong>ุงูุญุตุฉ:</strong> <span class="font-medium">7</span></div>
                        </div>
                        <div><strong>ุงููุฌุงู / ุงููุงุฏุฉ:</strong> <span id="repSpecialization" class="font-medium"></span></div>
                        <div class="col-span-2"><strong>ุนููุงู ุงูุฏุฑุณ:</strong> <span id="repLessonTopic" class="font-medium"></span></div>
                    </div>

                    <p class="text-center text-xs font-bold text-slate-600 mb-3 p-2 bg-slate-100 rounded-md border border-slate-200">
                        ูุชููุฒ (1) &nbsp;&nbsp;&nbsp; ุฌูุฏ (2) &nbsp;&nbsp;&nbsp; ููุงุฆู (3) &nbsp;&nbsp;&nbsp; ุบูุฑ ููุงุฆู (4) &nbsp;&nbsp;&nbsp; ูุญุชุงุฌ ุฅูู ุชุฏุฎู (5)
                    </p>

                    <table class="w-full border-collapse border border-slate-500 text-sm">
                        <thead>
                            <tr class="bg-slate-100 font-extrabold text-slate-800">
                                <th class="border border-slate-500 p-1.5 text-right">ุจููุฏ ุงูุชูููู</th>
                                <th class="border border-slate-500 p-1.5 w-20">ุงููุณุชูู</th>
                            </tr>
                        </thead>
                        <tbody id="repDetailsBody"></tbody>
                    </table>

                     <footer class="mt-12 grid grid-cols-2 gap-x-16 text-sm font-bold text-slate-900">
                        <div class="text-center">
                            <p id="repFooterTeacherName_p1" class="mt-2 font-medium min-h-6"></p>
                            <div class="h-12 mt-2 border-b border-slate-500"></div>
                            <p class="mt-1">ุงููุนูู/ูุฉ</p>
                        </div>
                        <div class="text-center">
                            <p id="repFooterVisitorName_p1" class="mt-2 font-medium min-h-6"></p>
                            <div class="h-12 mt-2 border-b border-slate-500"></div>
                            <p class="mt-1">ูุฏูุฑ ุงููุฏุฑุณุฉ</p>
                        </div>
                    </footer>
                </div>
                
                <!-- PAGE 2 -->
                <div class="p-10 page-break">
                    <div id="aiReportContentWrapper" class="relative">
                        <div id="aiReportContent" class="space-y-6 text-slate-800 font-medium leading-relaxed"></div>
                        <div id="aiLoadingOverlay" class="absolute inset-0 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center z-10 hidden-view rounded-3xl">
                            <div class="relative w-16 h-16 mb-4"><div class="absolute inset-0 rounded-full border-4 border-slate-100"></div><div class="absolute inset-0 rounded-full border-4 border-[rgb(var(--color-primary-600))] border-t-transparent animate-spin"></div></div>
                            <span class="text-sm font-bold text-slate-800">ุฌุงุฑู ุตูุงุบุฉ ุงูุชูุฑูุฑ ุงูุงุญุชุฑุงูู...</span><span class="text-xs text-slate-500 mt-1">ูุชู ุงูุงุชุตุงู ุจุงููุนุงูุฌ ุงูุฐูู</span>
                        </div>
                    </div>
                    <footer class="mt-12 grid grid-cols-2 gap-x-16 text-sm font-bold text-slate-900">
                        <div class="text-center">
                            <p id="repFooterTeacherName_p2" class="mt-2 font-medium min-h-6"></p>
                            <div class="h-12 mt-2 border-b border-slate-500"></div>
                            <p class="mt-1">ุงููุนูู/ูุฉ</p>
                        </div>
                        <div class="text-center">
                            <p id="repFooterVisitorName_p2" class="mt-2 font-medium min-h-6"></p>
                            <div class="h-12 mt-2 border-b border-slate-500"></div>
                            <p class="mt-1">ูุฏูุฑ ุงููุฏุฑุณุฉ</p>
                        </div>
                    </footer>
                </div>
            </div>
        </section>


        <!-- View: Supervision History -->
        <section id="view-supervision-history" class="fade-in space-y-6 hidden-view">
            <div class="flex justify-between items-center bg-white p-6 rounded-3xl shadow-soft border border-slate-200">
                <div class="flex items-center gap-3">
                    <button onclick="window.app.setView('supervision-hub')" class="bg-slate-50 hover:bg-slate-100 text-slate-600 w-10 h-10 rounded-xl flex items-center justify-center transition cursor-pointer border border-slate-200"><i class="fas fa-arrow-right"></i></button>
                    <h2 class="text-xl font-extrabold text-slate-900">ุณุฌู ุงูุฒูุงุฑุงุช</h2>
                </div>
            </div>
            <div id="supervisionHistoryGrid" class="space-y-4"></div>
        </section>

        <!-- View: Reports (General) -->
        <section id="view-reports" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-6 rounded-3xl shadow-soft border border-slate-200">
                <div class="flex items-center gap-4">
                    <div class="bg-indigo-50 text-indigo-600 w-12 h-12 rounded-2xl flex items-center justify-center text-xl"><i class="fas fa-file-invoice"></i></div>
                    <div><h2 class="text-2xl font-extrabold text-slate-900">ุชูุงุฑูุฑ ุงูุฃุฏุงุก</h2><p class="text-slate-500 font-medium text-sm">ุชุญููู ุดุงูู ูุจูุงูุงุช ุงููุนูููู</p></div>
                </div>
                <div class="flex gap-3 w-full md:w-auto">
                    <button onclick="window.app.setView('supervision-history')" class="flex-1 md:flex-none bg-white text-slate-700 hover:bg-slate-50 border border-slate-200 px-5 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition cursor-pointer text-sm shadow-sm"><i class="fas fa-history text-slate-400"></i><span>ุงูุณุฌู</span></button>
                    <button onclick="window.app.exportReports()" class="flex-1 md:flex-none bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition shadow-lg shadow-emerald-100 cursor-pointer text-sm"><i class="fas fa-file-excel"></i><span>ุชุตุฏูุฑ Excel</span></button>
                </div>
            </div>
            <div class="bg-white rounded-3xl shadow-soft border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-right"><thead class="bg-slate-50 border-b border-slate-200 text-slate-600 text-xs font-extrabold uppercase tracking-wider"><tr><th class="p-5">ุงููุนูู</th><th class="p-5 text-center">ุงูุชูููู</th><th class="p-5 text-center">ุงููุงุชู</th><th class="p-5 text-center">ุงูุญุงูุฉ</th></tr></thead><tbody id="reportsBody" class="divide-y divide-slate-100 text-sm font-bold text-slate-700"></tbody></table>
                </div>
            </div>
        </section>

        <!-- View: Tasks -->
        <section id="view-tasks" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col gap-6 bg-white p-8 rounded-3xl shadow-soft border border-slate-200">
                <div class="flex justify-between items-center"><div><h2 class="text-2xl font-extrabold text-slate-900">ููุงู ุงููุฏูุฑ</h2><p class="text-slate-500 font-medium text-sm">ูุงุฆูุฉ ุงูููุงู ุงูููููุฉ</p></div><div class="bg-[rgb(var(--color-primary-50))] px-4 py-2 rounded-xl border border-[rgb(var(--color-primary-100))]"><span class="text-sm font-bold text-[rgb(var(--color-primary-800))]" id="tasksProgressText">0/0</span></div></div>
                <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden"><div id="tasksProgressBar" class="h-full bg-gradient-to-r from-[rgb(var(--color-primary-500))] to-purple-500 transition-all duration-700 ease-out w-0 rounded-full"></div></div>
                <div class="flex gap-3 items-center bg-slate-50 p-2 rounded-2xl border border-slate-200 focus-within:ring-2 focus-within:ring-[rgb(var(--color-primary-200))] focus-within:border-[rgb(var(--color-primary-400))] transition-all">
                    <input type="text" id="newTaskInput" placeholder="ุฃุถู ูููุฉ ุฌุฏูุฏุฉ..." class="flex-1 bg-transparent border-none outline-none px-4 text-sm text-slate-800 font-bold placeholder:text-slate-400" onkeypress="if(event.key === 'Enter') window.app.addTask()">
                    <select id="newTaskPriority" class="text-xs bg-white border border-slate-200 rounded-xl px-3 py-2.5 outline-none text-slate-700 font-bold shadow-sm"><option value="normal">ุนุงุฏู</option><option value="urgent">ุนุงุฌู</option></select>
                    <button onclick="window.app.addTask()" class="bg-[rgb(var(--color-primary-600))] hover:bg-[rgb(var(--color-primary-700))] text-white w-10 h-10 rounded-xl flex items-center justify-center transition cursor-pointer shadow-md"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div id="tasksList" class="grid gap-3"></div>
        </section>

    </main>

    <!-- Hidden Printable Sections -->
    <div id="printable-substitution-sheet" class="hidden-view bg-white p-8">
        <div class="text-center mb-8 border-b-2 border-slate-800 pb-4"><h1 class="text-3xl font-extrabold text-slate-900 mb-2">ูุดู ุญุตุต ุงูุงุญุชูุงุท ุงููููู</h1><p id="printDate" class="text-lg font-bold text-slate-600"></p></div>
        <table class="w-full text-right border-collapse border border-slate-300">
            <thead><tr class="bg-slate-100 text-slate-800"><th class="p-3 border border-slate-300 font-extrabold">ุงูุญุตุฉ</th><th class="p-3 border border-slate-300 font-extrabold">ุงูุตู</th><th class="p-3 border border-slate-300 font-extrabold">ุงููุนูู ุงูุบุงุฆุจ</th><th class="p-3 border border-slate-300 font-extrabold">ุงููุนูู ุงูุจุฏูู</th><th class="p-3 border border-slate-300 font-extrabold">ุงูุชูููุน</th></tr></thead>
            <tbody id="printSubstitutionBody" class="text-sm font-bold text-slate-700"></tbody>
        </table>
        <div class="mt-12 flex justify-between px-10"><div class="text-center font-bold"><p>ูุฏูุฑ ุงููุฏุฑุณุฉ</p><div class="h-16"></div></div><div class="text-center font-bold"><p>ูุนุชูุฏุ</p><div class="h-16"></div></div></div>
    </div>

    <div id="printable-duty-sheet" class="hidden-view bg-white p-8">
        <div class="text-center mb-8 border-b-2 border-slate-800 pb-4">
            <h1 class="text-3xl font-extrabold text-slate-900 mb-2">ุฌุฏูู ุงูููุงูุจุฉ ุงูุฃุณุจูุนู</h1>
            <p id="printDutyDate" class="text-lg font-bold text-slate-600"></p>
        </div>
        <table id="printDutyTable" class="w-full text-right border-collapse border border-slate-300"></table>
        <div class="mt-12 flex justify-between px-10">
            <div class="text-center font-bold"><p>ูุฏูุฑ ุงููุฏุฑุณุฉ</p><div class="h-16"></div></div>
            <div class="text-center font-bold"><p>ูุนุชูุฏุ</p><div class="h-16"></div></div>
        </div>
    </div>


    <!-- Modals -->
    <!-- Staff Login Modal (NEW) -->
    <div id="modal-staff-login" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden-view">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="document.getElementById('modal-staff-login').classList.add('hidden-view')"></div>
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 relative animate-scale-in">
            <h3 class="text-xl font-bold text-slate-800 mb-4 text-center">ุฏุฎูู ุงููุงุฏุฑ ุงูุฅุฏุงุฑู / ุงููุนูููู</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 mb-1 block">ุฑูุฒ ุงููุฏุฑุณุฉ (School ID)</label>
                    <input type="text" id="staff-school-id" placeholder="ุงุทูุจ ุงูุฑูุฒ ูู ุงููุฏูุฑ..." class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-bold text-center outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 mb-1 block">ุฑูุฒ ุงูุฏุฎูู (PIN)</label>
                    <input type="password" id="staff-pin" placeholder="****" maxlength="4" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-bold text-center outline-none focus:ring-2 focus:ring-indigo-500 tracking-widest">
                </div>
                <button onclick="window.app.handleStaffLogin()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition cursor-pointer">
                    ุฏุฎูู
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal (Restored Full Version) -->
    <div id="modal-settings" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden-view">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm modal-backdrop" onclick="window.app.closeModal('modal-settings')"></div>
        <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden animate-scale-in flex flex-col max-h-[85vh] modal-content">
            <div class="bg-slate-800 text-white p-6 flex justify-between items-center shrink-0">
                <h3 class="text-xl font-bold flex items-center gap-3"><i class="fas fa-cog text-slate-400"></i> ุงูุฅุนุฏุงุฏุงุช</h3>
                <button type="button" onclick="window.app.closeModal('modal-settings')" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scrollbar space-y-8">
                <!-- Staff Access Settings (NEW) -->
                <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100">
                    <h4 class="font-extrabold text-indigo-900 text-sm mb-3 flex items-center gap-2"><i class="fas fa-users-cog"></i> ุฅุนุฏุงุฏุงุช ุฏุฎูู ุงููุนูููู</h4>
                    <div class="space-y-3">
                        <div class="bg-white p-3 rounded-xl border border-indigo-100">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">ุฑูุฒ ุงููุฏุฑุณุฉ (ูุดุงุฑูุฉ ูุน ุงููุนูููู)</label>
                            <div class="flex items-center gap-2 mt-1">
                                <code id="display-school-id" class="flex-1 bg-slate-100 p-2 rounded-lg text-xs font-mono font-bold text-slate-700 select-all text-center">Loading...</code>
                                <button onclick="navigator.clipboard.writeText(document.getElementById('display-school-id').innerText); alert('ุชู ุงููุณุฎ')" class="bg-indigo-100 text-indigo-600 p-2 rounded-lg text-xs font-bold"><i class="fas fa-copy"></i></button>
                            </div>
                        </div>
                        <div class="flex gap-2 items-end">
                            <div class="flex-1">
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block">ุชุนููู ุฑูุฒ ุฏุฎูู ุงููุงุฏุฑ (PIN)</label>
                                <input type="text" id="setting-staff-pin" placeholder="4 ุฃุฑูุงู" maxlength="4" class="w-full bg-white border border-slate-200 rounded-xl p-2 text-sm font-bold text-center outline-none focus:border-indigo-500">
                            </div>
                            <button onclick="window.app.saveStaffPin()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold h-10">ุญูุธ ุงูุฑูุฒ</button>
                        </div>
                        <p class="text-[10px] text-indigo-800 font-medium leading-relaxed">
                            * ุนูุฏ ุชูุนูู ูุฐุง ุงูุฎูุงุฑุ ูููู ูููุนูููู ุงูุฏุฎูู ุจุงุณุชุฎุฏุงู "ุฑูุฒ ุงููุฏุฑุณุฉ" ู "ุงูุฑูุฒ ุงูุณุฑู" ููุงุทูุงุน ุนูู ุงูุฌุฏูู ูุงูููุงูุจุฉ ููุท (ุจุฏูู ุชููููุงุช).
                        </p>
                    </div>
                </div>

                <!-- Help Center -->
                <div class="space-y-3">
                    <h4 class="font-extrabold text-slate-800 text-sm border-b border-slate-100 pb-2">ูุฑูุฒ ุงููุณุงุนุฏุฉ</h4>
                    <button onclick="window.app.setView('instructions'); window.app.closeModal('modal-settings');" class="w-full bg-sky-50 hover:bg-sky-100 text-sky-700 border border-sky-200 py-3 rounded-xl font-bold text-xs transition flex items-center justify-center gap-2 cursor-pointer">
                        <i class="fas fa-question-circle"></i> ุนุฑุถ ุชุนูููุงุช ุงูุงุณุชุฎุฏุงู
                    </button>
                </div>
                
                <!-- Theme -->
                <div class="space-y-3">
                    <h4 class="font-extrabold text-slate-800 text-sm border-b border-slate-100 pb-2">ุงููุธูุฑ ุงูุนุงู</h4>
                    <div id="themeSelectorContainer" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                </div>
                
                <!-- Gender -->
                <div class="space-y-3">
                    <h4 class="font-extrabold text-slate-800 text-sm border-b border-slate-100 pb-2">ููุน ุงููุฏุฑุณุฉ ุงูุงูุชุฑุงุถู</h4>
                    <div id="schoolGenderSelectorContainer" class="flex gap-4 items-center bg-slate-50 border border-slate-200 rounded-xl p-3">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="defaultSchoolGender" value="male" onchange="window.app.setDefaultSchoolGender('male')" class="accent-[rgb(var(--color-primary-600))]"><span class="text-sm font-bold text-slate-700">ุจููู</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="defaultSchoolGender" value="female" onchange="window.app.setDefaultSchoolGender('female')" class="accent-pink-600"><span class="text-sm font-bold text-slate-700">ุจูุงุช</span></label>
                    </div>
                </div>
                
                <!-- Report Settings -->
                <div class="space-y-3">
                    <h4 class="font-extrabold text-slate-800 text-sm border-b border-slate-100 pb-2">ุฅุนุฏุงุฏุงุช ุงูุชูุฑูุฑ</h4>
                    <div class="space-y-1">
                        <label for="settingDirectorate" class="text-xs font-bold text-slate-600 mr-1">ุงููุฏูุฑูุฉ ุงูุชุนููููุฉ</label>
                        <input type="text" id="settingDirectorate" onchange="window.app.setDirectorate(this.value)" class="w-full text-sm p-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-[rgb(var(--color-primary-500))] focus:ring-4 focus:ring-[rgb(var(--color-primary-100))] transition-all outline-none font-bold text-slate-700">
                    </div>
                </div>

                <!-- Violations -->
                <div class="space-y-3">
                    <h4 class="font-extrabold text-slate-800 text-sm border-b border-slate-100 pb-2">ุฅุฏุงุฑุฉ ุงููุฎุงููุงุช</h4>
                    <div class="flex gap-2 bg-slate-50 p-3 rounded-xl border border-slate-200 items-end">
                        <div class="flex-1 space-y-1">
                            <label class="text-[10px] font-bold text-slate-500">ุงุณู ุงููุฎุงููุฉ</label>
                            <input type="text" id="newViolationLabel" placeholder="ูุซูุงู: ุนุฏู ุชุญุถูุฑ" class="w-full text-sm p-2 bg-white rounded-lg border border-slate-200 outline-none focus:border-[rgb(var(--color-primary-500))] font-bold text-slate-700">
                        </div>
                        <div class="w-20 space-y-1">
                            <label class="text-[10px] font-bold text-slate-500">ุงูุฎุตู</label>
                            <input type="number" id="newViolationPoints" value="5" class="w-full text-sm p-2 bg-white rounded-lg border border-slate-200 outline-none focus:border-[rgb(var(--color-primary-500))] text-center font-bold text-slate-700">
                        </div>
                        <button type="button" onclick="window.app.addViolation()" class="bg-slate-800 hover:bg-slate-900 text-white p-2 rounded-lg h-[38px] w-10 flex items-center justify-center transition cursor-pointer"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="violationsList" class="space-y-2"></div>
                </div>
                
                <!-- Specializations -->
                <div class="space-y-3">
                    <h4 class="font-extrabold text-slate-800 text-sm border-b border-slate-100 pb-2">ุฅุฏุงุฑุฉ ุงูุชุฎุตุตุงุช</h4>
                    <div class="flex gap-2 bg-slate-50 p-3 rounded-xl border border-slate-200 items-center">
                        <input type="text" id="newSpecInput" placeholder="ุฃุถู ุชุฎุตุต ุฌุฏูุฏ..." class="flex-1 text-sm p-2 bg-white rounded-lg border border-slate-200 outline-none focus:border-[rgb(var(--color-primary-500))] font-bold text-slate-700">
                        <button type="button" onclick="window.app.addSpecialization()" class="bg-slate-800 hover:bg-slate-900 text-white p-2 rounded-lg h-[38px] w-10 flex items-center justify-center transition cursor-pointer"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="specializationsList" class="flex flex-wrap gap-2"></div>
                </div>
                
                <!-- Import/Export Tools -->
                <div class="space-y-3">
                    <h4 class="font-extrabold text-slate-800 text-sm border-b border-slate-100 pb-2">ุฃุฏูุงุช ุงูุจูุงูุงุช</h4>
                    
                    <!-- Supervisor Tools -->
                    <div class="bg-orange-50 p-4 rounded-2xl border border-orange-100">
                        <h5 class="text-xs font-bold text-orange-800 mb-2 flex items-center gap-2"><i class="fas fa-user-tie"></i> ุฃุฏูุงุช ุงููุดุฑู ุงูุชุฑุจูู</h5>
                        <div class="flex gap-2">
                            <button type="button" onclick="window.app.exportTeacherTemplate()" class="flex-1 bg-white border border-orange-200 text-orange-700 hover:bg-orange-100 py-2 rounded-lg font-bold text-xs transition cursor-pointer"><i class="fas fa-download mr-1"></i> ูููุฐุฌ ุงููุดุฑู</button>
                            <button type="button" onclick="document.getElementById('excelInput').click()" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white py-2 rounded-lg font-bold text-xs transition cursor-pointer shadow-sm"><i class="fas fa-upload mr-1"></i> ุงุณุชูุฑุงุฏ ุงููุงุฆูุฉ</button>
                        </div>
                    </div>
                    
                    <!-- Criteria DB -->
                    <div class="bg-purple-50 p-4 rounded-2xl border border-purple-100">
                        <h5 class="text-xs font-bold text-purple-800 mb-2 flex items-center gap-2"><i class="fas fa-database"></i> ูุงุนุฏุฉ ุจูุงูุงุช ุงูุฒูุงุฑุงุช</h5>
                        <button type="button" onclick="document.getElementById('criteriaExcelInput').click()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-bold text-xs transition cursor-pointer shadow-sm">
                            <i class="fas fa-upload mr-1"></i> ุงุณุชูุฑุงุฏ ูุงุนุฏุฉ ุงููุนุงููุฑ (Excel)
                        </button>
                        <input type="file" id="criteriaExcelInput" accept=".xlsx, .xls" class="hidden" onchange="window.app.handleCriteriaExcel(event)">
                    </div>

                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-[rgb(var(--color-primary-50))] p-4 rounded-2xl border border-[rgb(var(--color-primary-100))]">
                            <h5 class="font-bold text-[rgb(var(--color-primary-900))] mb-2 flex items-center gap-2 text-xs"><i class="fas fa-calendar-alt"></i> ุฌุฏูู ุงูุญุตุต (XML)</h5>
                            <button type="button" onclick="document.getElementById('xmlInput').click()" class="w-full bg-white hover:bg-[rgb(var(--color-primary-50))] text-[rgb(var(--color-primary-700))] border border-[rgb(var(--color-primary-200))] py-2 rounded-lg font-bold text-xs transition cursor-pointer">ุฑูุน ููู XML</button>
                            <input type="file" id="xmlInput" accept=".xml" class="hidden" onchange="window.app.handleXml(event)">
                        </div>
                        <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                            <h5 class="font-bold text-emerald-900 mb-2 flex items-center gap-2 text-xs"><i class="fas fa-users"></i> ุจูุงูุงุช ุงููุนูููู (Excel)</h5>
                            <button type="button" onclick="document.getElementById('excelInput').click()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg font-bold text-xs transition cursor-pointer shadow-sm"><i class="fas fa-upload mr-1"></i> ุงุณุชูุฑุงุฏ Excel</button>
                            <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden" onchange="window.app.handleExcel(event)">
                        </div>
                    </div>
                </div>

                <!-- Support Section -->
                <div class="mt-8 pt-4 border-t border-slate-100 space-y-3">
                    <h4 class="font-extrabold text-slate-800 text-sm">ุงูุฏุนู ุงูููู</h4>
                    <button onclick="window.app.contactSupport()" class="w-full bg-emerald-50 hover:bg-emerald-100 text-emerald-700 border border-emerald-200 py-3 rounded-xl font-bold text-xs transition flex items-center justify-center gap-2 cursor-pointer">
                        <i class="fab fa-whatsapp"></i> ุงูุฏุนู ุงูููู (ุนุงุฏู ุงูุบุฒููู)
                    </button>
                </div>
                
                <!-- Danger Zone -->
                <div class="mt-4 pt-4 border-t border-slate-100">
                    <button onclick="window.app.deleteData()" class="w-full bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 py-3 rounded-xl font-bold text-xs transition flex items-center justify-center gap-2 cursor-pointer">
                        <i class="fas fa-trash-alt"></i> ุญุฐู ุฌููุน ุงูุจูุงูุงุช ูุฅุนุงุฏุฉ ุชุนููู
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Action Modal -->
    <div id="modal-action" class="fixed inset-0 z-50 flex items-end md:items-center justify-center p-0 md:p-4 hidden-view">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm modal-backdrop" onclick="window.app.closeModal('modal-action')"></div>
        <div class="bg-white w-full md:max-w-md rounded-t-3xl md:rounded-3xl shadow-2xl overflow-hidden animate-scale-in modal-content mb-0 md:mb-20">
            <div class="bg-slate-800 p-5 text-white flex justify-between items-start">
                <div><h3 class="text-xl font-bold flex items-center gap-2" id="actionModalTitle"></h3><p id="actionModalSubtitle" class="text-slate-300 text-xs mt-1 flex items-center gap-1 font-medium"></p></div>
                <button type="button" onclick="window.app.closeModal('modal-action')" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5 space-y-5 max-h-[70vh] overflow-y-auto custom-scrollbar">
                <button type="button" id="btn-evaluate" class="w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-700 border border-indigo-200 p-4 rounded-2xl font-bold text-sm flex items-center justify-center gap-3 transition cursor-pointer group shadow-sm"><span class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm group-hover:scale-110 transition"><i class="fas fa-clipboard-list text-lg"></i></span><span>ุจุฏุก ุชูููู ุฒูุงุฑุฉ ุฅุดุฑุงููุฉ</span></button>
                <div class="space-y-2"><label class="text-[10px] font-extrabold text-slate-400 uppercase tracking-wider px-1">ุงูุชูุงุตู ุงูุณุฑูุน</label><div class="grid grid-cols-2 gap-3"><button type="button" onclick="window.app.sendWhatsApp('summon')" class="bg-emerald-50 hover:bg-emerald-100 text-emerald-700 border border-emerald-100 p-3 rounded-2xl font-bold text-xs flex flex-col items-center gap-2 transition cursor-pointer"><i class="fab fa-whatsapp text-2xl"></i><span>ุงุณุชุฏุนุงุก ููุฅุฏุงุฑุฉ</span></button><button type="button" id="btn-remind" onclick="window.app.sendWhatsApp('remind')" class="bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-100 p-3 rounded-2xl font-bold text-xs flex flex-col items-center gap-2 transition cursor-pointer disabled:opacity-50"><i class="fas fa-bell text-2xl"></i><span>ุชุฐููุฑ ุจุงูุญุตุฉ</span></button></div></div>
                
                <!-- Violation Section -->
                <div class="space-y-2" id="violation-section">
                    <label class="text-[10px] font-extrabold text-slate-400 uppercase tracking-wider px-1">ุชุณุฌูู ูุฎุงููุฉ ุฌุฏูุฏุฉ</label>
                    <div id="violationButtonsContainer" class="space-y-2"></div>
                </div>

                <!-- History Log Section -->
                <div class="space-y-2 pt-2 border-t border-slate-100" id="violation-history-section">
                    <label class="text-[10px] font-extrabold text-slate-400 uppercase tracking-wider px-1">ุณุฌู ุงููุฎุงููุงุช ุงูุณุงุจู</label>
                    <div id="violationHistoryLog" class="bg-slate-50 rounded-xl p-3 max-h-40 overflow-y-auto space-y-2 text-xs border border-slate-100">
                        <div class="text-center text-slate-400 py-2">ูุง ุชูุฌุฏ ูุฎุงููุงุช ูุณุฌูุฉ</div>
                    </div>
                </div>
            </div>
             <div class="bg-slate-50 p-4 text-center border-t border-slate-100 flex justify-between items-center px-6"><span class="text-xs text-slate-500 font-bold">ุงูุชูููู ุงูุญุงูู</span><span class="text-xl font-extrabold text-slate-800" id="currentScoreDisplay"></span></div>
        </div>
    </div>

    <!-- Substitute Selection Modal (NEW) -->
    <div id="modal-substitute" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden-view">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm modal-backdrop" onclick="window.app.closeModal('modal-substitute')"></div>
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-scale-in relative flex flex-col max-h-[85vh] modal-content">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center shrink-0">
                <h3 class="font-bold flex items-center gap-2 text-lg"><i class="fas fa-user-clock text-amber-400"></i> ุงุฎุชูุงุฑ ูุนูู ุจุฏูู</h3>
                <button type="button" onclick="window.app.closeModal('modal-substitute')" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="bg-indigo-50 p-3 text-center border-b border-indigo-100 shrink-0">
                <span id="subModalPeriodInfo" class="font-extrabold text-indigo-900 text-sm"></span>
            </div>
            <div id="substituteList" class="p-4 overflow-y-auto custom-scrollbar space-y-2 flex-1"></div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="fixed bottom-4 left-4 right-4 z-40 no-print flex justify-center pointer-events-none">
        <nav class="bg-white/90 backdrop-blur-xl border border-white/40 shadow-[0_8px_30px_rgb(0,0,0,0.12)] rounded-2xl pointer-events-auto max-w-lg w-full">
            <div class="flex justify-around items-center h-16 px-2">
                <button onclick="window.app.setView('now')" id="btn-now" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-[rgb(var(--color-primary-700))] transition-all duration-300 group relative">
                    <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-[rgb(var(--color-primary-50))] group-hover:scale-110 transition-transform"><i class="fas fa-chalkboard text-lg"></i></div><span class="text-[10px] font-bold">ุงูุญุตุต</span>
                </button>
                <button onclick="window.app.setView('reserve')" id="btn-reserve" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group">
                    <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors"><i class="fas fa-user-clock text-lg"></i></div><span class="text-[10px] font-bold">ุงูุงุญุชูุงุท</span>
                </button>
                <button onclick="window.app.setView('teachers')" id="btn-teachers" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group">
                    <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors"><i class="fas fa-users-cog text-lg"></i></div><span class="text-[10px] font-bold">ุงููุนูููู</span>
                </button>
                <button onclick="window.app.setView('supervision-hub')" id="btn-supervision-hub" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group">
                    <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors"><i class="fas fa-clipboard-user text-lg"></i></div><span class="text-[10px] font-bold">ุงูุฒูุงุฑุงุช</span>
                </button>
                <button onclick="window.app.setView('duty')" id="btn-duty" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group">
                    <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors"><i class="fas fa-user-shield text-lg"></i></div><span class="text-[10px] font-bold">ุงูููุงูุจุฉ</span>
                </button>
                <button onclick="window.app.setView('periods')" id="btn-periods" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group">
                    <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors"><i class="fas fa-clock text-lg"></i></div><span class="text-[10px] font-bold">ุงูุชูููุช</span>
                </button>
                <button onclick="window.app.setView('reports')" id="btn-reports" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-600 transition-all duration-300 group">
                    <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-slate-50 transition-colors"><i class="fas fa-file-invoice text-lg"></i></div><span class="text-[10px] font-bold">ุงูุชูุงุฑูุฑ</span>
                </button>
            </div>
        </nav>
    
    </div>

    <!-- Developer Tools -->
    <button id="dev-toggle-button" onclick="document.getElementById('debug-log-panel').classList.toggle('hidden-view')" class="hidden-view fixed bottom-20 right-4 z-[100] w-12 h-12 bg-amber-400 hover:bg-amber-500 text-slate-900 rounded-full shadow-lg flex items-center justify-center transition no-print">
        <i class="fas fa-bug"></i>
    </button>
    <div id="debug-log-panel" class="hidden-view fixed bottom-36 right-4 z-[100] w-full max-w-md h-80 bg-slate-900/90 backdrop-blur-sm text-white rounded-2xl shadow-2xl p-4 flex flex-col no-print">
        <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
            <h3 class="font-bold text-sm text-amber-300 flex items-center gap-2"><i class="fas fa-bug"></i> ุณุฌู ุงููุทูุฑ</h3>
            <button onclick="document.getElementById('debug-log-panel').classList.add('hidden-view')" class="text-slate-400 hover:text-white text-2xl">&times;</button>
        </div>
        <div id="debug-log-content" class="flex-1 overflow-y-auto text-xs font-mono space-y-1 pr-2 custom-scrollbar-dark">
            <!-- Log messages will be injected here -->
        </div>
    </div>


    <!-- Script Implementation -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        class SchoolApp {
            constructor() {
                this.state = {
                    currentUser: null, teachers: [], periods: [], classes: {}, tasks: [], agenda: [], 
                    violationTypes: [{ id: 'late', label: 'ุชุฃุฎุฑ ุนู ุงูุญุตุฉ', points: 5, icon: 'fa-clock' }, { id: 'absent', label: 'ุบูุงุจ ุนู ุงูุญุตุฉ', points: 15, icon: 'fa-user-slash' }],
                    specializations: ["ุชุฑุจูุฉ ุงุณูุงููุฉ", "ูุบุฉ ุนุฑุจูุฉ", "ุนููู", "ุฃุญูุงุก", "ููููุงุก", "ููุฒูุงุก", "ุงูุฏุฑุงุณุงุช ุงูุงุฌุชูุงุนูุฉ", "ุงููุบุฉ ุงูุงูุฌููุฒูุฉ", "ุงูููุงุฑุงุช ุงูุญูุงุชูุฉ", "ุงูุฑูุงุถุฉ ุงููุฏุฑุณูุฉ", "ุงููููู ุงูุชุดููููุฉ", "ุงููููู ุงูููุณูููุฉ"],
                    simulationOffset: 0, selectedTeacherId: null, selectedClassName: null, supervisionData: { ratings: {}, notes: {}, gender: 'male' }, supervisionHistory: [], evaluationCriteria: [],
                    // Duty System Data
                    dutyLocations: ["ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ", "ุงูุณุงุญุฉ ุงูุฃูุงููุฉ", "ุงูููุตู", "ุงูููุฑุงุช"],
                    dutySchedule: {}, 
                    substitutions: {}, // Key: "Date_Period_Class" -> Value: SubstituteTeacherID
                    selectedAbsentTeacherId: null, // Persist selection across re-renders
                    
                    theme: 'default', defaultSchoolGender: 'male', directorate: 'ุงููุฏูุฑูุฉ ุงูุนุงูุฉ ููุชุฑุจูุฉ ูุงูุชุนููู ุจูุญุงูุธุฉ ูุณูุท', cloudStatus: 'offline', unsubscribe: null, aiReportData: null,
                    
                    // Staff Mode
                    userMode: 'admin', // 'admin' | 'staff'
                    staffPin: '',
                    targetUid: null, // if staff, load this UID's data
                    
                    // View State
                    currentView: 'now'
                };
                this.db = null; this.auth = null; this.functions = null;
                this.initDefaultCriteria();
                this.loadLocalData();
                this.initFirebaseAndAuth();
                this.startClock();
            }

            loadLocalData() {
                const stored = localStorage.getItem('school_data_v1');
                if (stored) {
                    try {
                        const data = JSON.parse(stored);
                        if (data.teachers) this.state.teachers = data.teachers;
                        if (data.periods) this.state.periods = data.periods;
                        if (data.classes) this.state.classes = data.classes;
                        if (data.tasks) this.state.tasks = data.tasks;
                        if (data.agenda) this.state.agenda = data.agenda;
                        if (data.violationTypes) this.state.violationTypes = data.violationTypes;
                        if (data.specializations) this.state.specializations = data.specializations;
                        if (data.supervisionHistory) this.state.supervisionHistory = data.supervisionHistory;
                        if (data.theme) this.state.theme = data.theme;
                        if (data.defaultSchoolGender) this.state.defaultSchoolGender = data.defaultSchoolGender;
                        if (data.directorate) this.state.directorate = data.directorate;
                        if (data.evaluationCriteria && data.evaluationCriteria.length > 0) this.state.evaluationCriteria = data.evaluationCriteria;
                        if (data.dutyLocations) this.state.dutyLocations = data.dutyLocations;
                        if (data.dutySchedule) this.state.dutySchedule = data.dutySchedule;
                        if (data.substitutions) this.state.substitutions = data.substitutions;
                        
                        if (data.staffPin) this.state.staffPin = data.staffPin; // Load pin locally

                        this.applyTheme();
                    } catch(e) { console.error('Local Load Error', e); }
                }
            }

            initFirebaseAndAuth() {
                const firebaseConfig = { apiKey: "AIzaSyC4NddjijF29YNhowy4SqgRaMPn01oSSEg", authDomain: "school-9416e.firebaseapp.com", projectId: "school-9416e", storageBucket: "school-9416e.firebasestorage.app", messagingSenderId: "680872052240", appId: "1:680872052240:web:96d2e544166ab5f8096c95", measurementId: "G-5EBTV0MV83" };
                try {
                    if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                         firebase.initializeApp(firebaseConfig);
                    }
                    
                    if (typeof firebase !== 'undefined') {
                        this.db = firebase.firestore(); 
                        this.auth = firebase.auth();
                        this.functions = firebase.functions();
                        this.auth.onAuthStateChanged(user => {
                            if (user) {
                                this.state.currentUser = { uid: user.uid, name: user.displayName, photoURL: user.photoURL, email: user.email, isPremium: false };
                                document.getElementById('login-view')?.classList.add('hidden-view'); 
                                document.getElementById('app-view')?.classList.remove('hidden-view');
                                
                                // Default to Admin Mode on regular login
                                this.state.userMode = 'admin';
                                this.renderUserProfile(); 
                                this.loadUserData();
                            }
                        });
                    }
                } catch (e) { console.error("Firebase Init Error:", e); }
            }

            handleGoogleLogin() { 
                // Set persistence to LOCAL to ensure the token survives page refreshes and is always available for Cloud Functions
                if(this.auth) {
                    this.auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                    .then(() => {
                        const provider = new firebase.auth.GoogleAuthProvider(); 
                        return this.auth.signInWithPopup(provider);
                    })
                    .catch(e => {
                        console.error("Login Error:", e);
                        alert("ูุดู ุชุณุฌูู ุงูุฏุฎูู: " + e.message);
                    });
                }
            }
            
            async handleStaffLogin() {
                const id = document.getElementById('staff-school-id').value.trim();
                const pin = document.getElementById('staff-pin').value.trim();
                
                if (!id || !pin) return alert('ูุฑุฌู ุชุนุจุฆุฉ ุฌููุน ุงูุญููู');
                
                // Loading UI
                const btn = document.querySelector('#modal-staff-login button');
                const originalText = btn.innerText;
                btn.innerText = 'ุฌุงุฑู ุงูุชุญูู...';
                btn.disabled = true;

                try {
                    // Try to fetch data from the target ID
                    const doc = await this.db.collection("users").doc(id).get();
                    if (doc.exists) {
                        const data = doc.data();
                        
                        // Verify PIN
                        if (data.staffPin === pin) {
                            // Success
                            this.state.targetUid = id;
                            this.state.userMode = 'staff';
                            this.state.currentUser = { uid: 'staff', name: 'ูุงุฏุฑ ุฅุฏุงุฑู', photoURL: null, email: null }; // Mock user
                            
                            // Load data from TARGET
                            this.loadUserData(id); // Pass target ID
                            
                            document.getElementById('modal-staff-login').classList.add('hidden-view');
                            document.getElementById('login-view').classList.add('hidden-view'); 
                            document.getElementById('app-view').classList.remove('hidden-view');
                            
                            this.renderUserProfile();
                            
                        } else {
                            alert('ุฑูุฒ ุงูุฏุฎูู (PIN) ุบูุฑ ุตุญูุญ.');
                        }
                    } else {
                        alert('ุฑูุฒ ุงููุฏุฑุณุฉ ุบูุฑ ุตุญูุญ.');
                    }
                } catch (e) {
                    console.error(e);
                    alert('ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู. ุชุฃูุฏ ูู ุตุญุฉ ุฑูุฒ ุงููุฏุฑุณุฉ.');
                } finally {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }

            saveStaffPin() {
                const pin = document.getElementById('setting-staff-pin').value.trim();
                if (pin.length !== 4) return alert('ูุฌุจ ุฃู ูุชููู ุงูุฑูุฒ ูู 4 ุฃุฑูุงู');
                this.state.staffPin = pin;
                this.saveData();
                alert('ุชู ุญูุธ ุฑูุฒ ุงููุงุฏุฑ ุจูุฌุงุญ. ุดุงุฑูู ูุน ุงููุนูููู.');
            }

            
            skipLogin() { document.getElementById('login-view')?.classList.add('hidden-view'); document.getElementById('app-view')?.classList.remove('hidden-view'); this.renderAll(); document.getElementById('user-profile-container').innerHTML = `<div class="flex items-center gap-3 bg-white/50 px-3 py-1.5 rounded-xl border border-slate-200"><div class="text-xs font-bold text-slate-600 flex items-center gap-2"><i class="fas fa-user-shield text-slate-500"></i><span>ุฒุงุฆุฑ</span></div><div class="h-4 w-px bg-slate-300 mx-1"></div><button onclick="window.app.handleLogout()" class="text-red-500 hover:text-red-700 transition cursor-pointer" title="ุฎุฑูุฌ"><i class="fas fa-sign-out-alt"></i></button></div>`; }
            handleLogout() { 
                if(confirm('ูู ุชุฑูุฏ ุชุณุฌูู ุงูุฎุฑูุฌุ')) { 
                    if(this.auth && this.state.currentUser && this.state.userMode === 'admin') this.auth.signOut().catch(()=>{}); 
                    this.state.currentUser = null; 
                    this.state.userMode = 'admin'; // Reset
                    this.state.targetUid = null;
                    document.getElementById('app-view')?.classList.add('hidden-view'); 
                    document.getElementById('login-view')?.classList.remove('hidden-view'); 
                    document.getElementById('user-profile-container').innerHTML = ''; 
                    document.getElementById('dev-toggle-button')?.classList.add('hidden-view');
                    document.getElementById('debug-log-panel')?.classList.add('hidden-view');
                } 
            }
            
            isDeveloper() {
                return this.state.currentUser?.email === 'alsaher9@gmail.com';
            }

            logDebug(message, data = null) {
                if (!this.isDeveloper()) return;

                const panel = document.getElementById('debug-log-panel');
                const content = document.getElementById('debug-log-content');
                if (!content) return;
                
                if (panel && panel.classList.contains('hidden-view')) {
                    panel.classList.remove('hidden-view');
                }

                const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
                const logEntry = document.createElement('div');
                logEntry.className = 'p-1.5 bg-slate-800 rounded';
                
                let html = `<div class="flex justify-between items-center"><span class="text-emerald-400 font-bold">${message}</span><span class="text-slate-500 text-[10px]">${timestamp}</span></div>`;

                if (data) {
                    try {
                        const dataStr = JSON.stringify(data, null, 2);
                        html += `<pre class="text-sky-300 text-[10px] bg-black/20 p-2 rounded mt-1 overflow-x-auto">${dataStr.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>`;
                    } catch (e) {
                         html += `<pre class="text-red-400">Could not stringify data.</pre>`;
                    }
                }

                logEntry.innerHTML = html;
                content.appendChild(logEntry);
                content.scrollTop = content.scrollHeight;

                console.log(`[DEV LOG] ${message}`, data);
            }


            renderUserProfile() {
                const container = document.getElementById('user-profile-container'); if(!container) return;
                if (this.state.currentUser) {
                    const modeLabel = this.state.userMode === 'staff' ? 'ูุงุฏุฑ ุฅุฏุงุฑู' : 'ูุฏูุฑ';
                    const modeColor = this.state.userMode === 'staff' ? 'text-indigo-600' : 'text-slate-800';
                    
                    container.innerHTML = `
                        <div class="flex items-center gap-3 bg-slate-100 px-3 py-1.5 rounded-xl border border-slate-200">
                            <div class="w-8 h-8 rounded-full border-2 border-white shadow-sm bg-slate-300 flex items-center justify-center overflow-hidden">
                                ${this.state.currentUser.photoURL ? `<img src="${this.state.currentUser.photoURL}" class="w-full h-full">` : `<i class="fas fa-user text-slate-500"></i>`}
                            </div>
                            <div class="hidden md:block text-xs font-bold">
                                <div class="${modeColor}">${this.state.currentUser.name || modeLabel}</div>
                            </div>
                            <div class="h-4 w-px bg-slate-300 mx-1"></div>
                            <button onclick="window.app.handleLogout()" class="text-red-500 hover:text-red-700 transition cursor-pointer" title="ุชุณุฌูู ุฎุฑูุฌ">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>`;
                } else {
                    container.innerHTML = '';
                }
            }

            loadUserData(targetId = null) {
                // Determine ID to fetch: explicit target (staff mode) or current authenticated user (admin mode)
                const uidToFetch = targetId || (this.state.currentUser ? this.state.currentUser.uid : null);
                
                if (!uidToFetch || uidToFetch === 'staff') { // 'staff' is mock UID
                     if(this.state.userMode === 'staff' && this.state.targetUid) {
                         // Re-fetch using stored target
                         this.loadUserData(this.state.targetUid);
                         return;
                     }
                     return; 
                }

                if (this.state.unsubscribe) this.state.unsubscribe();
                this.updateCloudStatus('connecting');
                
                this.state.unsubscribe = this.db.collection("users").doc(uidToFetch).onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        // ... (Standard Data Loading)
                        this.state.teachers = data.teachers || []; this.state.periods = data.periods || []; this.state.classes = data.classes || {}; this.state.tasks = data.tasks || []; this.state.agenda = data.agenda || [];
                        if (data.violationTypes) this.state.violationTypes = data.violationTypes; if (data.specializations) this.state.specializations = data.specializations; if (data.supervisionHistory) this.state.supervisionHistory = data.supervisionHistory;
                        if (data.theme) this.state.theme = data.theme; if (data.defaultSchoolGender) this.state.defaultSchoolGender = data.defaultSchoolGender; if (data.directorate) this.state.directorate = data.directorate;
                        if (data.evaluationCriteria) this.state.evaluationCriteria = data.evaluationCriteria;
                        if (data.dutyLocations) this.state.dutyLocations = data.dutyLocations;
                        if (data.dutySchedule) this.state.dutySchedule = data.dutySchedule;
                        if (data.substitutions) this.state.substitutions = data.substitutions;
                        if (data.staffPin) this.state.staffPin = data.staffPin;

                        if (this.isDeveloper()) {
                            document.getElementById('dev-toggle-button')?.classList.remove('hidden-view');
                        }

                        this.applyTheme(); 
                        this.applyPermissions(); // Apply View Restrictions
                        this.renderAll(); 
                        this.updateCloudStatus('connected'); 
                        
                        // Save local backup ONLY if Admin. Staff shouldn't overwrite local storage easily or rely on it for security.
                        if (this.state.userMode === 'admin') {
                            this.saveDataToLocal();
                        }
                    } else { 
                        if (this.state.userMode === 'admin') this.saveData(); 
                    }
                }, e => this.updateCloudStatus('error'));
            }
            
            applyPermissions() {
                const isStaff = this.state.userMode === 'staff';
                
                // 1. Hide Restricted Tabs in Bottom Nav
                const reportsBtn = document.getElementById('btn-reports');
                const supervisionBtn = document.getElementById('btn-supervision-hub');
                
                if (reportsBtn) reportsBtn.style.display = isStaff ? 'none' : 'flex';
                if (supervisionBtn) supervisionBtn.style.display = isStaff ? 'none' : 'flex';
                
                // 2. Hide Settings Button in Header
                const settingsBtn = document.getElementById('btn-settings-main');
                if (settingsBtn) settingsBtn.style.display = isStaff ? 'none' : 'flex';
                
                // 3. Populate Settings Display
                if (!isStaff) {
                    const idDisplay = document.getElementById('display-school-id');
                    if (idDisplay && this.state.currentUser) {
                        idDisplay.innerText = this.state.currentUser.uid;
                    }
                    const pinInput = document.getElementById('setting-staff-pin');
                    if (pinInput) pinInput.value = this.state.staffPin || '';
                }
            }

            saveDataToLocal() { localStorage.setItem('school_data_v1', JSON.stringify({ teachers: this.state.teachers, periods: this.state.periods, classes: this.state.classes, tasks: this.state.tasks, agenda: this.state.agenda, violationTypes: this.state.violationTypes, specializations: this.state.specializations, supervisionHistory: this.state.supervisionHistory, theme: this.state.theme, defaultSchoolGender: this.state.defaultSchoolGender, directorate: this.state.directorate, evaluationCriteria: this.state.evaluationCriteria, dutyLocations: this.state.dutyLocations, dutySchedule: this.state.dutySchedule, substitutions: this.state.substitutions, staffPin: this.state.staffPin })); }
            async saveData() {
                // If STAFF mode, DO NOT SAVE to overwrite admin data directly unless strictly allowed (e.g. duty).
                // For simplicity in this version, we allow writes because Firestore rules usually allow authenticated writes to own doc.
                // Since Staff mode uses "targetUid", we must write to that doc.
                // NOTE: This requires Firestore Rules to allow the authenticated staff user to write to the Admin's doc.
                // If using shared login (Admin gives PIN), we are simulating read-only UI logic mostly.
                
                const uidToWrite = this.state.userMode === 'staff' ? this.state.targetUid : (this.state.currentUser ? this.state.currentUser.uid : null);
                
                if (!uidToWrite) { this.updateCloudStatus('local'); return; }
                
                this.updateCloudStatus('saving');
                try { 
                    await this.db.collection("users").doc(uidToWrite).set({ 
                        teachers: this.state.teachers, 
                        periods: this.state.periods, 
                        classes: this.state.classes, 
                        tasks: this.state.tasks, 
                        agenda: this.state.agenda, 
                        violationTypes: this.state.violationTypes, 
                        specializations: this.state.specializations, 
                        supervisionHistory: this.state.supervisionHistory, 
                        theme: this.state.theme, 
                        defaultSchoolGender: this.state.defaultSchoolGender, 
                        directorate: this.state.directorate, 
                        evaluationCriteria: this.state.evaluationCriteria, 
                        dutyLocations: this.state.dutyLocations, 
                        dutySchedule: this.state.dutySchedule, 
                        substitutions: this.state.substitutions, 
                        staffPin: this.state.staffPin,
                        lastSync: new Date()
                        // Don't overwrite email/name
                    }, { merge: true }); 
                    this.updateCloudStatus('connected'); 
                } catch (e) { 
                    this.updateCloudStatus('error'); 
                }
            }

            updateCloudStatus(status) { const el = document.getElementById('cloudStatusIndicator'); if(!el) return; if(status === 'connected') el.innerHTML = '<span class="text-emerald-600 bg-emerald-50 px-2 py-1 rounded-lg text-[10px] font-bold border border-emerald-100 flex items-center gap-1"><i class="fas fa-check-circle"></i> ูุชุตู</span>'; else if(status === 'saving') el.innerHTML = '<span class="text-amber-600 bg-amber-50 px-2 py-1 rounded-lg text-[10px] font-bold border border-amber-100 flex items-center gap-1"><i class="fas fa-sync fa-spin"></i> ุญูุธ...</span>'; else if(status === 'local') el.innerHTML = '<span class="text-slate-600 bg-slate-50 px-2 py-1 rounded-lg text-[10px] font-bold border border-slate-200 flex items-center gap-1"><i class="fas fa-hdd"></i> ูุญูู</span>'; else el.innerHTML = '<span class="text-red-600 bg-red-50 px-2 py-1 rounded-lg text-[10px] font-bold border border-red-100 flex items-center gap-1"><i class="fas fa-exclamation-triangle"></i> ุฎุทุฃ</span>'; }

            initDefaultCriteria() {
                this.state.evaluationCriteria = [
                    { id: 1, title: "ุงูุชุญุตูู ุงูุฏุฑุงุณู", subtitle: "(ุชุญุตูู ุงูุทูุจุฉ ูู ุงูุฃุนูุงู ุงูุตููุฉ ูุบูุฑ ุงูุตููุฉ)", items: { 1: { desc: "ุงูุชุณุจ ุฌููุน ุงูุทูุจุฉ ุงูููุงุฑุงุช ุงูุฃุณุงุณูุฉ ูุงููุนุงุฑู ุจุตูุฑุฉ ูุนุงูุฉ.", rec: "ุชูููุฐ ูุจุงุฏุฑุฉ ุชุฑุจููุฉ ุชุนุฒุฒ ูู ุงูุชุณุงุจ ุงูุทูุจุฉ ููููุงุฑุงุช ูุงููุนุงุฑู." }, 2: { desc: "ููุชุณุจ ูุนุธู ุงูุทูุจุฉ ุงูููุงุฑุงุช ุงูุฃุณุงุณูุฉ ูุงููุนุงุฑู ุจุตูุฑุฉ ูุงุนูุฉ.", rec: "ุชูุซูู ุงูุฃูุดุทุฉ ุงูุฅุซุฑุงุฆูุฉ ุงูุชู ุชุณุชูุฏู ุงูุทูุจุฉ ุฐูู ุงููุณุชูู ุงููุฑุชูุน." }, 3: { desc: "ููุชุณุจ ุฃุบูุจ ุงูุทูุจุฉ ุงูููุงุฑุงุช ุงูุฃุณุงุณูุฉ ุจุตูุฑุฉ ููุงุฆูุฉ.", rec: "ุงูุชุฑููุฒ ุนูู ุชุตููู ุฃูุดุทุฉ ุตููุฉ ูุชูุงูุฒุฉ ุชุถูู ุงูุชุณุงุจ ุฌููุน ุงูุทูุจุฉ ููููุงุฑุงุช." }, 4: { desc: "ุงูุชุณุจ ููุฉ ูู ุงูุทูุจุฉ ุงูููุงุฑุงุช ุงูุฃุณุงุณูุฉ ุจุตูุฑุฉ ูุญุฏูุฏุฉ.", rec: "ุชูููุฐ ุญุตุต ุชูููุฉ ููุทูุจุฉ ูุงุณุชุบูุงู ุญุตุต ุงูุงุญุชูุงุทู ูุชูุซูู ุงูุฎุทุท ุงูุนูุงุฌูุฉ." }, 5: { desc: "ููุชุณุจ ุนุฏุฏ ูุงุฏุฑ ูู ุงูุทูุจุฉ ุงูููุงุฑุงุช ุงูุฃุณุงุณูุฉ.", rec: "ูุถุน ุฎุทุฉ ุนูุงุฌูุฉ ููุฑูุฉ ูุดุงููุฉ ูุญุตุฑ ุงูููุงุฑุงุช ุงููุชุฃุฎุฑุฉ." } } },
                    { id: 2, title: "ุงูุชูุฏู ุงูุฏุฑุงุณู", subtitle: "(ุงูุชูุฏู ูู ุงููุนุงุฑู ูุงูููุงุฑุงุช ุฃุซูุงุก ุงูุญุตุฉ)", items: { 1: { desc: "ูุชูุฏู ุฌููุน ุงูุทูุจุฉ ูู ุงููุนุงุฑู ูุงูููุงููู ูุงูููุงุฑุงุช ุจุตูุฑุฉ ูุชููุฒุฉ.", rec: "ุชูููุฐ ูุฑุงุกุฉ ููุฌูุฉ ูุฒููุงุก ุงูุนูู ูุขููุฉ ุชุทุจูู ูุฑู ุจููู." }, 2: { desc: "ูุชูุฏู ูุนุธู ุงูุทูุจุฉ ุฏุฑุงุณูุงู ุฃุซูุงุก ุงูุญุตุฉ ุจุตูุฑุฉ ูุงุนูุฉ.", rec: "ุงูุญุฑุต ุนูู ูุฑุงุฌุนุฉ ุขููุงุช ุชูุฑูุฏ ุงูุชุนููู ุงูููุฏูุฉ ููุทูุจุฉ." }, 3: { desc: "ูุชูุฏู ุฃุบูุจ ุงูุทูุจุฉ ุฏุฑุงุณูุงู ุฃุซูุงุก ุงูุญุตุฉ ุจุตูุฑุฉ ููุงุฆูุฉ.", rec: "ุถูุงู ุชูุธูู ูุฑู ุจููู ููุฃูุฏุงู ุจูุงุนููุฉ ูู ุตูุงุบุฉ ุฃุณุฆูุฉ ุงูุญุตุฉ." }, 4: { desc: "ุงูุชุณุจ ุจุนุถ ุงูุทูุจุฉ ุงููุนุงุฑู ูุงูููุงููู ุจุตูุฑุฉ ูุญุฏูุฏุฉ.", rec: "ุชุทุจูู ูุดุฑูุน ุชูุฑูุฏ ุงูุชุนูู ูุชูููุฐ ุงูุฎุทุท ุงููุฑุฏูุฉ." }, 5: { desc: "ูุชูุฏู ุนุฏุฏ ูุงุฏุฑ ูู ุงูุทูุจุฉ ุฏุฑุงุณูุงู ุจุตูุฑุฉ ูุญุฏูุฏุฉ ุฌุฏุงู.", rec: "ุงูุจุฏุก ููุฑุงู ูู ุชูููุฐ ุงูุฎุทุท ุงููุฑุฏูุฉ ูุชูุฑูุฏ ุงูุชุนูู." } } },
                    { id: 3, title: "ููุงุฑุงุช ุงูุชุนูู", subtitle: "(ุงูุชุนูู ุงูุฐุงุชูุ ุงูุชุนุงูููุ ูุงูุฑููู)", items: { 1: { desc: "ูุทุจู ุฌููุน ุงูุทูุจุฉ ููุงุฑุงุช ุงูุชุนูู ุงูุฐุงุชู ูุงูุชุนุงููู ูุงูุฑููู ุจุตูุฑุฉ ูุชููุฒุฉ.", rec: "ุชูููุฐ ูุฑุงุกุฉ ููุฌูุฉ ูุขููุฉ ุทุฑุญ ุฃุณุฆูุฉ ูุซูุฑุฉ ููุชูููุฑ." }, 2: { desc: "ูุทุจู ูุนุธู ุงูุทูุจุฉ ููุงุฑุงุช ุงูุชุนูู ุจูุณุชูู ูุงุนู.", rec: "ุชุนุฒูุฒ ุชูุธูู ุงูููุตุงุช ุงูุฑูููุฉ ูุชุฏุฑูุจ ุงูุทูุจุฉ ุนูู ุงูุชุนูู ุงูุฐุงุชู." }, 3: { desc: "ูุทุจู ุฃุบูุจ ุงูุทูุจุฉ ููุงุฑุงุช ุงูุชุนูู ุจูุณุชูู ููุงุฆู.", rec: "ุฅุฏุฑุงุฌ ุฃูุดุทุฉ ุตููุฉ ูุญุฏุฏุฉ ุชูุฏู ูุชูููุฉ ููุงุฑุงุช ุงูุชูููุฑ ุงููุงูุฏ." }, 4: { desc: "ุงูุชุณุจ ุจุนุถ ุงูุทูุจุฉ ููุงุฑุงุช ุงูุชุนูู ุงูุฐุงุชู ุจุตูุฑุฉ ูุญุฏูุฏุฉ.", rec: "ุชูููุฐ ูุดุฑูุน ููุฏู ุฅูู ุชูููุฉ ููุงุฑุงุช ุงูุชุนูู ุงูุฐุงุชู ูุงูุฑููู." }, 5: { desc: "ูุทุจู ุนุฏุฏ ูุงุฏุฑ ูู ุงูุทูุจุฉ ููุงุฑุงุช ุงูุชุนูู ุจูุณุชูู ูุญุฏูุฏ ุฌุฏุงู.", rec: "ุงูุชุฑููุฒ ุนูู ุชุฏุฑูุจ ุงูุทูุจุฉ ุนูู ุฃุจุณุท ููุงุฑุงุช ุงูุชุนูู ูุฏูุฌูุง ูู ุงูุฏุฑุณ." } } },
                    { id: 4, title: "ุงูููู ูุงูุณููู", subtitle: "(ุงูุงูุถุจุงุทุ ุงููููุฉ ุงููุทููุฉุ ุงูููู ุงูุฅูุณุงููุฉ)", items: { 1: { desc: "ูุฏุฑู ุฌููุน ุงูุทูุจุฉ ููุญููู ูุงููุงุฌุจุงุช ููุนุชุฒูู ุจูููุชูู ุงูุนูุงููุฉ.", rec: "ุชุนุฒูุฒ ูุชุญููุฒ ุงูุทูุจุฉ ุจููุงุฐุฌ ูููุตูุงุช ุชุนุจุฑ ุนู ุงููููุฉ ุงูุนูุงููุฉ." }, 2: { desc: "ููุชุฒู ูุนุธู ุงูุทูุจุฉ ุจุงูููู ุงูุฅูุณุงููุฉ ุงููุดุชุฑูุฉ ุจูุณุชูู ูุงุนู.", rec: "ุชุตููู ุฃูุดุทุฉ ุฅุซุฑุงุฆูุฉ ูุชุนุฒูุฒ ุงูููู ุงูุฅูุฌุงุจูุฉ ูุฏู ุงูุทูุจุฉ." }, 3: { desc: "ููุชุฒู ุฃุบูุจ ุงูุทูุจุฉ ุจุงูููู ุงูุฅูุณุงููุฉ ุงููุดุชุฑูุฉ ุจูุณุชูู ููุงุฆู.", rec: "ุชูููุฑ ูุฑุต ููุทูุจุฉ ูููุงุฑุณุฉ ุงูุชุนุจูุฑ ุนู ุงูุฐุงุช ูุงูุญูุงุฑ ุจุซูุฉ." }, 4: { desc: "ูุฏุฑู ุจุนุถ ุงูุทูุจุฉ ุงูุญููู ูุงููุงุฌุจุงุช ุจุตูุฑุฉ ูุญุฏูุฏุฉ.", rec: "ุชูููุฐ ูุดุฑูุน ููุฏู ุฅูู ุชูููุฉ ุงูููู ูุงูุณููู ูุชุนุฒูุฒ ุงููููุฉ." }, 5: { desc: "ููุชุฒู ุนุฏุฏ ูุงุฏุฑ ูู ุงูุทูุจุฉ ุจุงูููู ุงูุฅูุณุงููุฉ.", rec: "ูุถุน ุฎุทุฉ ุณููููุฉ ูุฑูุฒุฉ ูุนูุงุฌ ุญุงูุงุช ุนุฏู ุงูุงูุถุจุงุท ูู ุงูุญุตุฉ." } } },
                    { id: 5, title: "ุฌูุฏุฉ ุจูุฆุฉ ุงูุชุนูู", subtitle: "(ุงูุฃูู ูุงูุณูุงูุฉุ ุงููุธุงูุฉุ ุงูุฌุงุฐุจูุฉ)", items: { 1: { desc: "ูุชุงุจุน ุงููุนูู ุฌููุน ุฌูุงูุจ ุงูุฃูู ูุงูุณูุงูุฉ ูุงููุธุงูุฉ ุจุตูุฑุฉ ูุชููุฒุฉ.", rec: "ุชูููุฐ ุญุตุฉ ุชุทุจูููุฉ ุญูู ุฌูุงูุจ ุงูุฃูู ูุงูุณูุงูุฉ ูู ุงูุจูุฆุฉ ุงูุตููุฉ." }, 2: { desc: "ูุชุงุจุน ุงููุนูู ุฌูุงูุจ ุงูุฃูู ูุงูุณูุงูุฉ ุจุตูุฑุฉ ุฌูุฏุฉ.", rec: "ุชูุซูู ุงูููุงุฑุณุงุช ุงููุชููุฒุฉ ูู ุฌูุงูุจ ุงูุฃูู ูุงูุณูุงูุฉ ูุชุนููููุง." }, 3: { desc: "ูุชุงุจุน ุงููุนูู ุฌูุงูุจ ุงูุฃูู ูุงูุณูุงูุฉ ุจุตูุฑุฉ ููุงุณุจุฉ.", rec: "ุงูุชุฃูุฏ ูู ุชุทุจูู ุณูุงุณุงุช ุงูุฃูู ูุงูุณูุงูุฉ ูู ุฌููุน ุงูุฃูุดุทุฉ ุงูุตููุฉ." }, 4: { desc: "ูุชุงุจุน ุจุนุถ ุฌูุงูุจ ุงูุฃูู ูุงูุณูุงูุฉ ุจุตูุฑุฉ ูุญุฏูุฏุฉ.", rec: "ุงูุงูุชุฒุงู ุจุชุฏุงุจูุฑ ุงูุฃูู ูุงูุณูุงูุฉ ูู ุงูุจูุฆุฉ ุงูุตููุฉ (ุฃุณูุงู ููุดููุฉ..)." }, 5: { desc: "ูุชุงุจุน ุงููุนูู ุฌูุงูุจ ุงูุฃูู ูุงูุณูุงูุฉ ุจุตูุฑุฉ ูุงุฏุฑุฉ.", rec: "ุงุชุฎุงุฐ ุฅุฌุฑุงุกุงุช ุชุตุญูุญูุฉ ููุฑูุฉ ูุถูุงู ุณูุงูุฉ ุงูุทูุจุฉ." } } },
                    { id: 6, title: "ุชุฎุทูุท ุงููููุงุฌ ุงูุฏุฑุงุณู", subtitle: "(ุงูุชุณูุณูุ ุงุฑุชุจุงุท ุงูุฃูุฏุงูุ ุงูููุงุชุฌ)", items: { 1: { desc: "ูุฎุทุท ูุฌููุน ุฏุฑูุณู ูุชุณูุณูุงู ูู ุชููุน ุงูุฃูุฏุงู ุจุตูุฑุฉ ูุชููุฒุฉ.", rec: "ุชูููุฐ ูุฑุดุฉ ุชุฏุฑูุจูุฉ ูููููุฉ ุงูุชุฎุทูุท ููุฏุฑุณ ุจูุง ูุชูุงูู ูุน ุงูุฎุทุฉ ุงููุตููุฉ." }, 2: { desc: "ูุฎุทุท ุงููุนูู ูุนุธู ุฏุฑูุณู ุจุตูุฑุฉ ุฌูุฏุฉ.", rec: "ุชุทููุฑ ุงูุชุฎุทูุท ุงููููู ุนุจุฑ ุฅุถุงูุฉ ุฃูุดุทุฉ ุฅุซุฑุงุฆูุฉ ูุฎุทุท ุนูุงุฌูุฉ ูุงุถุญุฉ." }, 3: { desc: "ูุฎุทุท ุงููุนูู ุฃุบูุจ ุฏุฑูุณู ุจุตูุฑุฉ ููุงุณุจุฉ.", rec: "ูุฑุงุฌุนุฉ ุงูุชุฎุทูุท ููุชุฃูุฏ ูู ุฑุจุท ุงูุฃูุฏุงู ุจููุงุชุฌ ุงูุชุนูู ุงููุญุฏุฏุฉ." }, 4: { desc: "ูุฎุทุท ูุจุนุถ ุฏุฑูุณู ุจุตูุฑุฉ ูุญุฏูุฏุฉ.", rec: "ุงูุงูุชุฒุงู ุจุชูุงูู ุฃูุฏุงู ุฎุทุฉ ุงูุฏุฑุณ ูุน ุงูุฎุทุฉ ุงููุตููุฉ." }, 5: { desc: "ูุฎุทุท ุงููุนูู ุนุฏุฏ ูุญุฏูุฏ ุฌุฏุงู ูู ุฏุฑูุณู ุจุตูุฑุฉ ูุงุฏุฑุฉ.", rec: "ุงูุงูุชุฒุงู ุงูููุฑู ุจุฅุนุฏุงุฏ ุฎุทุท ุงูุฏุฑูุณ ุงูููููุฉ ุจุดูู ูุชูุงูู." } } },
                    { id: 7, title: "ุฅุฏุงุฑุฉ ุงูุตู", subtitle: "(ุฅุฏุงุฑุฉ ุงูููุชุ ุงูุณูููุ ุงูุฏุงูุนูุฉ)", items: { 1: { desc: "ูููู ุจุฅุฏุงุฑุฉ ุฒูู ุงูุชุนูู ูุฅุฏุงุฑุฉ ุณููููุงุช ุฌููุน ุงูุทูุจุฉ ุจุตูุฑุฉ ูุนุงูุฉ.", rec: "ุงูุนูู ุนูู ุชุญููู ูุชุงุฆุฌ ุงูุทูุจุฉ ูุชูุซูู ุงูุฃุณุฆูุฉ ุงูุนุงุตูุฉ ููุฐูู." }, 2: { desc: "ูููู ุงููุนูู ุจุฅุฏุงุฑุฉ ุฒูู ุงูุชุนูู ุจุตูุฑุฉ ุฌูุฏุฉ.", rec: "ุฅุฏุฑุงุฌ ุงุณุชุฑุงุชูุฌูุงุช ูุจุชูุฑุฉ ูุฅุฏุงุฑุฉ ุณููููุงุช ุงูุทูุจุฉ ูุชุนุฒูุฒ ุฏุงูุนูุชูู." }, 3: { desc: "ูููู ุงููุนูู ุจุฅุฏุงุฑุฉ ุฒูู ุงูุชุนูู ูุณููู ุทูุจุชู ุจุตูุฑุฉ ููุงุฆูุฉ.", rec: "ุงูุงุณุชูุฑุงุฑ ูู ุงูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ููุญุตุฉ ูุงูุชุฑููุฒ ุนูู ุชุญููู ุงูุณููููุงุช ุงูุณูุจูุฉ." }, 4: { desc: "ูููู ุจุฅุฏุงุฑุฉ ุฒูู ุงูุชุนูู ุจุตูุฑุฉ ูุญุฏูุฏุฉ.", rec: "ุงูุงูุชุฒุงู ุจุฒูู ุงูุชุนูู ูุงูุนูู ุนูู ุฅุฏุงุฑุฉ ููุช ุงูุญุตุฉ ุจุดูู ูุนุงู." }, 5: { desc: "ูููู ุงููุนูู ุจุฅุฏุงุฑุฉ ุฒูู ุงูุชุนูู ูุณููู ุทูุจุชู ุจุตูุฑุฉ ูุงุฏุฑุฉ.", rec: "ุชุทุจูู ููุงุนุฏ ุตุงุฑูุฉ ูุฅุฏุงุฑุฉ ุงูุตู ูุงูุงูุชุฒุงู ุจุงูุฎุทุฉ ุงูุฒูููุฉ." } } },
                    { id: 8, title: "ูุงุนููุฉ ุงูุชุฏุฑูุณ", subtitle: "(ุงุณุชุฑุงุชูุฌูุงุช ุงูุชุฏุฑูุณุ ุงูุชูุงูุฒุ ุงูุชุนูู ุงููุดุท)", items: { 1: { desc: "ููุธู ุงุณุชุฑุงุชูุฌูุงุช ุงูุชุฏุฑูุณ ูุงูุชูููุงุช ุงูุญุฏูุซุฉ ุจุตูุฑุฉ ูุนุงูุฉ.", rec: "ุชุตููู ุฏููู ุฑููู ูุจุนุถ ุงูููุตุงุช ุงูุฑูููุฉ ูุจุฑุงูุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู." }, 2: { desc: "ููุธู ุงููุนูู ุงุณุชุฑุงุชูุฌูุงุช ุชุฏุฑูุณ ูุนุงูุฉ ูุณุชููุฏ ูููุง ูุนุธู ุงูุทูุจุฉ.", rec: "ุชูุณูุน ูุทุงู ุชูุธูู ุจุฑุงูุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูู ุชุตููู ุงูุฃูุดุทุฉ ุงููุชูุงูุฒุฉ." }, 3: { desc: "ููุธู ุงููุนูู ุงุณุชุฑุงุชูุฌูุงุช ุชุฏุฑูุณ ูุณุชููุฏ ูููุง ุฃุบูุจ ุงูุทูุจุฉ.", rec: "ุงูุชูููุน ูู ุงุณุชุฑุงุชูุฌูุงุช ุงูุชุฏุฑูุณ ูุถูุงู ุชูุจูุฉ ุงุญุชูุงุฌุงุช ุฌููุน ุงูุทูุจุฉ." }, 4: { desc: "ููุธู ุงุณุชุฑุงุชูุฌูุงุช ุงูุชุฏุฑูุณ ุจุตูุฑุฉ ูุญุฏูุฏุฉ (ุงูุชูููู).", rec: "ุงูุนูู ุนูู ุงูุชูููุน ูู ูุตุงุฏุฑ ุงูุชุนูู ูุชุญุฏูุฏูุง ูููุงู ูุงุญุชูุงุฌุงุช ุงูุทูุจุฉ." }, 5: { desc: "ููุธู ุงุณุชุฑุงุชูุฌูุงุช ุชุฏุฑูุณ ูุณุชููุฏ ูููุง ุนุฏุฏ ูููู ุฌุฏุงู.", rec: "ุงุณุชุจุฏุงู ุงุณุชุฑุงุชูุฌูุงุช ุงูุชูููู ุจุงุณุชุฑุงุชูุฌูุงุช ุงูุชุนูู ุงููุดุท." } } },
                    { id: 9, title: "ุชูุนูู ุงููุตุงุฏุฑ ูุงูููุงุฑุฏ", subtitle: "(ุงูุชูููุงุช ุงูุฑูููุฉุ ุงููุณุงุฆู ุงูุชุนููููุฉ)", items: { 1: { desc: "ููุนู ุงููุนูู ุงูุชูููุงุช ุงูุฑูููุฉ ุจุญูุซ ูุณุชููุฏ ูููุง ุฌููุน ุงูุทูุจุฉ.", rec: "ุชูุซูู ุฃูุถู ููุงุฑุณุงุช ุชูุธูู ุงูุชูููุงุช ุงูุฑูููุฉ ูุงูุฐูุงุก ุงูุงุตุทูุงุนู." }, 2: { desc: "ููุนู ุงููุนูู ุงูุชูููุงุช ุงูุฑูููุฉ ุจุญูุซ ูุณุชููุฏ ูููุง ูุนุธู ุงูุทูุจุฉ.", rec: "ุชุดุฌูุน ุงูุทูุจุฉ ุนูู ุงุณุชุฎุฏุงู ุงูุชูููุงุช ุงูุฑูููุฉ ูุฃุฏุงุฉ ููุฅูุชุงุฌ ุงููุนุฑูู." }, 3: { desc: "ููุนู ุงููุนูู ุงูุชูููุงุช ุงูุฑูููุฉ ุจุญูุซ ูุณุชููุฏ ูููุง ุฃุบูุจ ุงูุทูุจุฉ.", rec: "ุงูุนูู ุนูู ุฏูุฌ ุงููุตุงุฏุฑ ุงูุฑูููุฉ ูุงูุชูููุฏูุฉ ูู ุฎุทุฉ ุงูุฏุฑุณ ุจุทุฑููุฉ ูุนุงูุฉ." }, 4: { desc: "ููุนู ุงููุนูู ุงูุชูููุงุช ุงูุฑูููุฉ ุจุตูุฑุฉ ูุญุฏูุฏุฉ.", rec: "ุงูุนูู ุนูู ุชูููุน ุงููุตุงุฏุฑ ูุงูููุงุฑุฏ ุงูุชุนููููุฉ ูุฏูุฌ ุงูููุตุงุช." }, 5: { desc: "ููุนู ุงููุนูู ุงูุชูููุงุช ุงูุฑูููุฉ ุจุตูุฑุฉ ูุงุฏุฑุฉ ุฃู ููุนุฏูุฉ.", rec: "ุงูุจุฏุก ููุฑุงู ูู ุชูุนูู ุงููุตุงุฏุฑ ูุงูููุงุฑุฏ ุงูุชุนููููุฉ ุงููุชุงุญุฉ." } } },
                    { id: 10, title: "ุงูุชูููู ููุณุงูุฏุฉ ุงูุชูุฏู", subtitle: "(ุชููุน ุงูุฃุณุงููุจุ ุงูุชุบุฐูุฉ ุงูุฑุงุฌุนุฉุ ูุฑุงุนุงุฉ ุงููุฑูู)", items: { 1: { desc: "ููุธู ุฃุณุงููุจ ุชูููู ูุชููุนุฉ ุชุฑุงุนู ุงูุชูุงูุฒ ุจูู ุฌููุน ุงูุทูุจุฉ.", rec: "ุชุดููู ูุฑูู ุนูู ูุตูุงุบุฉ ูุฌููุนุฉ ุฃูุดุทุฉ ุตููุฉ ุชุฑุงุนู ุงููุณุชููุงุช ุงูุซูุงุซุฉ." }, 2: { desc: "ููุธู ุงููุนูู ุฃุณุงููุจ ุชูููู ูุชููุนุฉ ุชุฑุงุนู ุงูุชูุงูุฒ ุจูู ูุนุธู ุงูุทูุจุฉ.", rec: "ุชุนููู ุชุฌุฑุจุฉ ุชูุธูู ุฃุณุงููุจ ุงูุชูููู ุงููุชููุนุฉ ุนูู ุงูุฒููุงุก." }, 3: { desc: "ููุธู ุงููุนูู ุฃุณุงููุจ ุชูููู ูุชููุนุฉ ุชุฑุงุนู ุงูุชูุงูุฒ ุจูู ุฃุบูุจ ุงูุทูุจุฉ.", rec: "ูุฑุงุฌุนุฉ ุฃุฏูุงุช ุงูุชูููู ุงููุณุชุฎุฏูุฉ ููุชุฃูุฏ ูู ุชุบุทูุชูุง ุงููุณุชููุงุช ุงููุนุฑููุฉ." }, 4: { desc: "ููุธู ุงููุนูู ุฃุณุงููุจ ุชูููู ุชุฑุงุนู ุงูุชูุงูุฒ ุจุตูุฑุฉ ูุญุฏูุฏุฉ.", rec: "ุงูุชูููุน ูู ุฃุณุงููุจ ุชูููู ุชุฑุงุนู ุงูุชูุงูุฒ ุจูู ุฌููุน ุงูุทูุจุฉ." }, 5: { desc: "ููุธู ุงููุนูู ุฃุณุงููุจ ุชูููู ุชุฑุงุนู ุงูุชูุงูุฒ ุจุตูุฑุฉ ูุงุฏุฑุฉ.", rec: "ุงูุชูููุน ุงูููุฑู ูู ุฃุณุงููุจ ุงูุชูููู (ุงูุดูููุ ุงููุชุงุจูุ ุงูุฃุฏุงุก)." } } },
                    { id: 11, title: "ููุงุฏุฉ ุงูุชุบููุฑ", subtitle: "(ุงูุชูููู ุงูุฐุงุชูุ ุงูุชูููุฉ ุงูููููุฉ)", items: { 1: { desc: "ููุฌุฑู ุชููููุงู ูุฃุฏุงุฆู ุฐุงุชูุงู ูููุธูู ูู ุชุญุณูู ุชุนูู ุฌููุน ุงูุทูุจุฉ.", rec: "ุชูููุฐ ูุดุบู ุชุฏุฑูุจู ููุฒููุงุก ุญูู ุฃุญุฏ ุฌูุงูุจ ุงูุฅุฌุงุฏุฉ." }, 2: { desc: "ููุฌุฑู ุงููุนูู ุชููููุงู ูุฃุฏุงุฆู ุฐุงุชูุงู ูููุธูู ุจุตูุฑุฉ ุฌูุฏุฉ.", rec: "ุชุดุฌูุน ุงูุฒููุงุก ุนูู ุชุจูู ููุงุฑุณุงุชู ุงููุชููุฒุฉ ูู ุงูุชูููู ุงูุฐุงุชู." }, 3: { desc: "ููุฌุฑู ุงููุนูู ุชููููุงู ูุฃุฏุงุฆู ุฐุงุชูุงู ูููุธูู ุจุตูุฑุฉ ููุจููุฉ.", rec: "ุงูุงูุชุฒุงู ุจุจุฑุงูุฌ ุงูุชุทููุฑ ุงููููู ุงููุชุงุญุฉ ูุชุทุจูู ุงูููุชุณุจ ูููุง." }, 4: { desc: "ููุฌุฑู ุชููููุงู ูุฃุฏุงุฆู ุฐุงุชูุงู ุจุดูู ูุญุฏูุฏ.", rec: "ุงูุงูุชุฒุงู ุจุงููุดุงุฑูุฉ ุงูููููุฉ ูุญุถูุฑ ุงููุฑุด ูุงููุญุงุถุฑุงุช." }, 5: { desc: "ููุฌุฑู ุงููุนูู ุชููููุงู ูุฃุฏุงุฆู ุฐุงุชูุงู ุจุตูุฑุฉ ูุงุฏุฑุฉ.", rec: "ุงูุงูุชุฒุงู ุจุญุถูุฑ ุงููุฑุด ูุงูุจุฏุก ูู ุชูุซูู ููุงุฑุณุงุชู ุงูููููุฉ." } } },
                    { id: 12, title: "ุงูุญูููุฉ", subtitle: "(ุงูุงูุชุฒุงู ุจุงูููุงุฆุญ ูุงูุฃูุธูุฉ ูุงูููุช)", items: { 1: { desc: "ูุทุจู ุงูุณูุงุณุงุช ูุงูุฃูุธูุฉ ูุงูููุงุฆุญ ุงูููุธูุฉ ููุนูู ุจุตูุฑุฉ ูุนุงูุฉ.", rec: "ุงูุงุณุชูุฑุงุฑ ุจุชุทุจูู ุงูููุงุฆุญ ููุชุงุจุนุฉ ุฃุซุฑ ุงูุงูุถุจุงุท ุนูู ุงููุชุงุฆุฌ." }, 2: { desc: "ูุทุจู ุงูุณูุงุณุงุช ูุงูุฃูุธูุฉ ูุงูููุงุฆุญ ุงูููุธูุฉ ููุนูู ุจุตูุฑุฉ ูุงุนูุฉ.", rec: "ุชูุซูู ุงูููุงุฑุณุงุช ุงููุชููุฒุฉ ูู ุชุทุจูู ุงูุฃูุธูุฉ ูุชุนููููุง." }, 3: { desc: "ูุทุจู ุงูุณูุงุณุงุช ูุงูุฃูุธูุฉ ูุงูููุงุฆุญ ุจุตูุฑุฉ ููุงุณุจุฉ.", rec: "ุงูุชุฃูุฏ ูู ุฃู ุงูุงูุชุฒุงู ุจุงูููุงุฆุญ ููุนูุณ ุฅูุฌุงุจุงู ุนูู ุฃุฏุงุก ุงูุทูุจุฉ." }, 4: { desc: "ูุทุจู ุงูุณูุงุณุงุช ูุงูุฃูุธูุฉ ุจุตูุฑุฉ ูุญุฏูุฏุฉ.", rec: "ุงูุงูุชุฒุงู ุจุงูููุงุฆุญ ูุงูุฃูุธูุฉ ูุถุฑูุฑุฉ ุงููุญุงูุธุฉ ุนูู ุฒูู ุงูุชุนูู." }, 5: { desc: "ูุทุจู ุงูุณูุงุณุงุช ูุงูุฃูุธูุฉ ุจุตูุฑุฉ ูุงุฏุฑุฉ.", rec: "ุงูุงูุชุฒุงู ุงูุชุงู ุจุงูุฏูุงู ุงูุฑุณูู ูุถุจุท ุฒูู ุงูุชุนูู ูุชุทุจูู ูุงูุฉ ุงูุฃูุธูุฉ." } } },
                    { id: 13, title: "ุงููุจุงุฏุฑุงุช ูุงูุฃูุดุทุฉ", subtitle: "(ุงููุดุงุฑูุนุ ุงูุชูุงุนู ูุน ุงููุฌุชูุน ุงููุฏุฑุณู)", items: { 1: { desc: "ููุฏู ูุจุงุฏุฑุงุช ูุนุงูุฉ ููุชููุฒ ุจุงูุชูุงุนู ุงูุฅูุฌุงุจู ูู ุฌููุน ุงูุฃูุดุทุฉ.", rec: "ุชูุซูู ูุจุงุฏุฑุฉ ุงูุชุญุตูู ุงูุฏุฑุงุณู ุจุทุฑููุฉ ุนูููุฉ ูููุดุงุฑูุฉ ุจูุง." }, 2: { desc: "ููุฏู ูุจุงุฏุฑุงุช ูุงุนูุฉ ููุชูุงุนู ุฅูุฌุงุจูุงู ูู ูุนุธู ุงูุฃูุดุทุฉ.", rec: "ุงูุชูุณุน ูู ูุฌุงู ุงููุจุงุฏุฑุฉ ูุงูุนูู ุนูู ุชูุซูู ุฃุซุฑูุง." }, 3: { desc: "ููุฏู ูุจุงุฏุฑุงุช ููุงุฆูุฉ ููุชูุงุนู ุฅูุฌุงุจูุงู ูู ุฃุบูุจ ุงูุฃูุดุทุฉ.", rec: "ุงูุงุณุชูุฑุงุฑ ูู ุชูุฏูู ุงููุจุงุฏุฑุงุช ูููุงุฏุฉ ูุฑูู ุนูู ูุชูููุฐ ุฅุญุฏุงูุง." }, 4: { desc: "ููุฏู ูุจุงุฏุฑุงุช ูุญุฏูุฏุฉ ููุชูุงุนู ุจุตูุฑุฉ ูุญุฏูุฏุฉ.", rec: "ุงูุงูุชุฒุงู ุจุญุถูุฑ ุงูุงุฌุชูุงุนุงุช ูุงูุจุฑุงูุฌ ูุงููุจุงุฏุฑุฉ ุจุชูุฏูู ููุชุฑุญ." }, 5: { desc: "ูุงุฏุฑุงู ูุง ููุฏู ูุจุงุฏุฑุงุช ูุชูุงุนูู ูุญุฏูุฏ ุฌุฏุงู.", rec: "ุงูุงูุชุฒุงู ุงูุชุงู ุจุญุถูุฑ ุงูุงุฌุชูุงุนุงุช ูุงูุฃูุดุทุฉ ุงููุฏุฑุณูุฉ." } } }
                ];
            }

            setView(v) { 
                this.state.currentView = v;
                
                ['now', 'teachers', 'reports', 'supervision', 'supervision-report', 'supervision-history', 'tasks', 'agenda', 'supervision-hub', 'duty', 'reserve', 'periods', 'instructions'].forEach(x => { 
                    document.getElementById(`view-${x}`)?.classList.add('hidden-view'); 
                    const b = document.getElementById(`btn-${x}`); 
                    if(b) { 
                        b.classList.remove('text-[rgb(var(--color-primary-700))]'); 
                        b.classList.add('text-slate-400'); 
                        const iconContainer = b.querySelector('div');
                        if (iconContainer) {
                            iconContainer.classList.remove('bg-[rgb(var(--color-primary-50))]'); 
                            iconContainer.classList.add('bg-transparent'); 
                        }
                    } 
                }); 
                
                document.getElementById(`view-${v}`)?.classList.remove('hidden-view'); 
                
                const ab = document.getElementById(`btn-${v}`); 
                if(ab) { 
                    ab.classList.add('text-[rgb(var(--color-primary-700))]'); 
                    ab.classList.remove('text-slate-400'); 
                    const iconContainer = ab.querySelector('div');
                    if(iconContainer) {
                        iconContainer.classList.add('bg-[rgb(var(--color-primary-50))]'); 
                        iconContainer.classList.remove('bg-transparent'); 
                    }
                } 
                
                if(v==='teachers') this.renderTeachers(); 
                else if(v==='reports') this.renderReports(); 
                else if(v==='supervision-history') this.renderHistory(); 
                else if(v==='tasks') this.renderTasks(); 
                else if(v==='agenda') this.renderAgenda(); 
                else if(v==='supervision-hub') this.renderSupervisionHub(); 
                else if(v==='duty') this.renderDutyTable(); 
                else if(v==='reserve') this.renderReserve(); 
                else if(v==='periods') this.renderPeriods();
                else if(v==='now') { 
                    this.renderCurrentPeriod(new Date(new Date().getTime() + this.state.simulationOffset)); 
                    this.renderDailyDutyWidget(new Date(new Date().getTime() + this.state.simulationOffset)); 
                } 
            }

            renderAll() { 
                const v = this.state.currentView;
                this.setView(v);
            }

            contactSupport() {
                const phone = '96898882855';
                const message = 'ูุฑุญุจุงูุ ุฃุฑุบุจ ูู ุฒูุงุฏุฉ ุงูุญุฏ ุงููููู ูููุญุงููุงุช ุงููุฌุงููุฉ ูุฎุฏูุฉ ุชุญุณูู ุงูุชูุงุฑูุฑ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู.';
                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
            }

            exportPhoneTemplate() {
                const data = [['Teacher_ID', 'Teacher_Name', 'Phone']];
                this.state.teachers.forEach(t => {
                    data.push([t.id, t.name, t.phone || '']);
                });
                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{wch:12}, {wch:30}, {wch:15}];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Phone_Numbers");
                XLSX.writeFile(wb, "Teachers_Phone_Template_With_Names.xlsx");
                alert('ุชู ุชูุฒูู ูุงูุจ ุฃุฑูุงู ุงูููุงุชู ูุน ุฃุณูุงุก ุงููุนูููู.\nูุฑุฌู ููุก ุนููุฏ "Phone" ููุท ุซู ุฅุนุงุฏุฉ ุงุณุชูุฑุงุฏ ุงูููู.');
            }

            downloadCriteriaTemplateExcel() {
                const headers = ["ุงููุนูุงุฑ", "ูุตู ุงููุนูุงุฑ", "ุงูุญูู (1-5)", "ุงููุตู ุงูุณูููู", "ุงูุชูุตูุงุช"];
                const data = [headers];
                this.state.evaluationCriteria.forEach(criterion => {
                    Object.keys(criterion.items).sort().forEach(rating => {
                        const item = criterion.items[rating];
                        data.push([criterion.title, criterion.subtitle, `ูุณุชูู ${rating}`, item.desc, item.rec]);
                    });
                });
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Evaluation Criteria");
                XLSX.writeFile(wb, "Evaluation_Criteria_Template.xlsx");
            }

            // --- Periods Management ---
            renderPeriods() {
                const container = document.getElementById('periodsListContainer');
                if (!container) return;
                const sortedPeriods = [...this.state.periods].sort((a, b) => parseInt(a.id) - parseInt(b.id));
                container.innerHTML = sortedPeriods.map(p => `
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col md:flex-row items-center justify-between gap-4">
                        <div class="font-extrabold text-slate-800 flex items-center gap-3">
                            <span class="bg-slate-100 text-slate-500 w-10 h-10 rounded-xl flex items-center justify-center font-black text-lg">${p.id}</span>
                            <span>ุงูุญุตุฉ ${p.id}</span>
                        </div>
                        <div class="flex items-center gap-2 bg-slate-50 border border-slate-200 p-2 rounded-xl">
                            <input type="time" value="${p.start}" onchange="window.app.updatePeriodTime('${p.id}', 'start', this.value)" class="bg-white p-2 rounded-lg border border-slate-200 text-sm font-bold text-slate-700 w-28 text-center">
                            <span class="font-bold text-slate-400">-</span>
                            <input type="time" value="${p.end}" onchange="window.app.updatePeriodTime('${p.id}', 'end', this.value)" class="bg-white p-2 rounded-lg border border-slate-200 text-sm font-bold text-slate-700 w-28 text-center">
                        </div>
                        <button onclick="window.app.deletePeriod('${p.id}')" class="text-red-300 hover:text-red-600 bg-red-50 hover:bg-red-100 w-10 h-10 rounded-xl flex items-center justify-center transition" title="ุญุฐู ุงูุญุตุฉ"><i class="fas fa-trash"></i></button>
                    </div>
                `).join('');
            }

            updatePeriodTime(id, type, value) {
                const period = this.state.periods.find(p => p.id === id);
                if (period) {
                    if (type === 'start') period.start = value;
                    if (type === 'end') period.end = value;
                    this.saveData();
                }
            }

            addPeriod() {
                const sortedPeriods = [...this.state.periods].sort((a, b) => parseInt(a.id) - parseInt(b.id));
                const lastPeriod = sortedPeriods[sortedPeriods.length - 1];
                const newId = lastPeriod ? parseInt(lastPeriod.id) + 1 : 1;
                let newStart = "08:00"; let newEnd = "08:45";
                if (lastPeriod && lastPeriod.end) {
                    const [h, m] = lastPeriod.end.split(':').map(Number);
                    const d = new Date();
                    d.setHours(h, m + 5, 0, 0); // Add 5 min break
                    newStart = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                    d.setHours(d.getHours(), d.getMinutes() + 45, 0, 0); // Add 45 min duration
                    newEnd = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                }
                this.state.periods.push({ id: String(newId), start: newStart, end: newEnd });
                this.saveData();
                this.renderPeriods();
            }

            deletePeriod(id) {
                if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุญุตุฉ ุฑูู ${id}ุ ุณูุชู ุฅุนุงุฏุฉ ุชุฑููู ุงูุญุตุต ุงูุชุงููุฉ.`)) return;
                this.state.periods = this.state.periods.filter(p => p.id !== id);
                this.state.periods.sort((a,b) => parseInt(a.id) - parseInt(b.id)).forEach((p, index) => { p.id = String(index + 1); });
                this.saveData();
                this.renderPeriods();
            }

            // --- Reserve System Logic ---
            renderReserve() {
                const select = document.getElementById('absentTeacherSelect');
                if(!select) return;
                select.innerHTML = '<option value="">-- ุงุฎุชุฑ ูู ุงููุงุฆูุฉ --</option>';
                const sortedTeachers = [...this.state.teachers].sort((a,b) => a.name.localeCompare(b.name, 'ar'));
                sortedTeachers.forEach(t => { const opt = document.createElement('option'); opt.value = t.id; opt.text = t.name; select.add(opt); });
                if (this.state.selectedAbsentTeacherId) {
                    select.value = this.state.selectedAbsentTeacherId;
                    this.renderAbsentSchedule();
                } else {
                    document.getElementById('absentScheduleContainer').innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-400 bg-white rounded-3xl border-2 border-dashed border-slate-200"><i class="fas fa-chalkboard-teacher text-5xl mb-4 opacity-50"></i><p class="text-sm font-bold text-slate-500">ูุฑุฌู ุงุฎุชูุงุฑ ุงููุนูู ุงูุบุงุฆุจ ูุนุฑุถ ุฌุฏูู ุญุตุตู ููููู</p></div>`;
                }
                this.renderDailySubstitutions();
            }

            handleAbsentSelection(val) {
                this.state.selectedAbsentTeacherId = val;
                this.renderAbsentSchedule();
            }

            renderDailySubstitutions() {
                const container = document.getElementById('dailySubstitutionsList');
                if (!container) return;
                const simulatedDate = new Date(new Date().getTime() + this.state.simulationOffset);
                const dateKey = simulatedDate.toISOString().split('T')[0];
                const subs = this.state.substitutions || {};
                const todaySubs = [];
                Object.keys(subs).forEach(key => {
                    if(key.startsWith(dateKey)) {
                        const parts = key.split('_');
                        const period = parseInt(parts[1].replace('p',''));
                        const className = parts[2];
                        const subId = subs[key];
                        const subTeacher = this.state.teachers.find(t => t.id === subId);
                        const dayIndex = simulatedDate.getDay() + 1; 
                        const originalTeacher = this.state.teachers.find(t => t.lessons.some(l => l.day === dayIndex && l.period === period && l.className === className));
                        if(originalTeacher && subTeacher) {
                            todaySubs.push({ period: period, className: className, absent: originalTeacher.name, sub: subTeacher.name, key: key });
                        }
                    }
                });
                if(todaySubs.length === 0) {
                    container.innerHTML = `<div class="p-8 text-center text-slate-400 text-sm">ูุง ุชูุฌุฏ ุญุตุต ุงุญุชูุงุท ูุณุฌูุฉ ููุฐุง ุงูููู.</div>`;
                    return;
                }
                todaySubs.sort((a,b) => a.period - b.period);
                container.innerHTML = todaySubs.map(item => `
                    <div class="p-4 flex items-center justify-between hover:bg-slate-50 transition border-b border-slate-50 last:border-0">
                        <div class="flex items-center gap-4">
                            <div class="bg-[rgb(var(--color-primary-50))] text-[rgb(var(--color-primary-700))] w-10 h-10 rounded-xl flex flex-col items-center justify-center font-bold text-sm border border-[rgb(var(--color-primary-100))]">
                                <span class="text-[8px] uppercase text-[rgb(var(--color-primary-400))]">ุญุตุฉ</span>${item.period}
                            </div>
                            <div>
                                <div class="font-bold text-slate-800 text-sm flex items-center gap-2"><span class="text-slate-500 font-normal">ุงูุตู:</span> ${item.className}</div>
                                <div class="text-xs text-slate-500 mt-1 flex items-center gap-2">
                                    <span class="bg-red-50 text-red-600 px-1.5 py-0.5 rounded border border-red-100">ุบ: ${item.absent}</span>
                                    <i class="fas fa-arrow-left text-slate-300 text-[10px]"></i>
                                    <span class="bg-emerald-50 text-emerald-600 px-1.5 py-0.5 rounded border border-emerald-100">ุจ: ${item.sub}</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="window.app.deleteSubstitution('${item.key}')" class="text-slate-300 hover:text-red-500 transition px-2" title="ุญุฐู"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `).join('');
            }

            deleteSubstitution(key) {
                if(confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅูุบุงุก ุญุตุฉ ุงูุงุญุชูุงุท ูุฐูุ')) {
                    delete this.state.substitutions[key];
                    this.saveData();
                    this.renderReserve();
                }
            }

            printSubstitutions() {
                const simulatedDate = new Date(new Date().getTime() + this.state.simulationOffset);
                const dateKey = simulatedDate.toISOString().split('T')[0];
                const displayDate = simulatedDate.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                document.getElementById('printDate').innerText = displayDate;
                const tbody = document.getElementById('printSubstitutionBody');
                tbody.innerHTML = '';
                const subs = this.state.substitutions || {};
                const todaySubs = [];
                Object.keys(subs).forEach(key => {
                    if(key.startsWith(dateKey)) {
                        const parts = key.split('_');
                        const period = parseInt(parts[1].replace('p',''));
                        const className = parts[2];
                        const subId = subs[key];
                        const subTeacher = this.state.teachers.find(t => t.id === subId);
                        const dayIndex = simulatedDate.getDay() + 1; 
                        const originalTeacher = this.state.teachers.find(t => t.lessons.some(l => l.day === dayIndex && l.period === period && l.className === className));
                        if(originalTeacher && subTeacher) {
                            todaySubs.push({ period: period, className: className, absent: originalTeacher.name, sub: subTeacher.name });
                        }
                    }
                });
                todaySubs.sort((a,b) => a.period - b.period);
                if(todaySubs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center border border-slate-300">ูุง ููุฌุฏ ุงุญุชูุงุท ุงูููู</td></tr>';
                } else {
                    todaySubs.forEach(item => {
                        tbody.innerHTML += `<tr><td class="p-3 border border-slate-300 text-center bg-slate-50 font-extrabold">${item.period}</td><td class="p-3 border border-slate-300 text-center">${item.className}</td><td class="p-3 border border-slate-300 text-red-600">${item.absent}</td><td class="p-3 border border-slate-300 text-emerald-700">${item.sub}</td><td class="p-3 border border-slate-300"></td></tr>`;
                    });
                }
                document.body.classList.add('printing-subs');
                window.addEventListener('afterprint', () => { document.body.classList.remove('printing-subs'); }, { once: true });
                window.print();
            }

            renderAbsentSchedule() {
                const absentId = this.state.selectedAbsentTeacherId;
                const container = document.getElementById('absentScheduleContainer');
                if(!absentId) {
                    if(!document.getElementById('absentTeacherSelect').value) {
                         container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-400 bg-white rounded-3xl border-2 border-dashed border-slate-200"><i class="fas fa-chalkboard-teacher text-5xl mb-4 opacity-50"></i><p class="text-sm font-bold text-slate-500">ูุฑุฌู ุงุฎุชูุงุฑ ุงููุนูู ุงูุบุงุฆุจ ูุนุฑุถ ุฌุฏูู ุญุตุตู ููููู</p></div>`;
                    }
                    return;
                }
                const t = this.state.teachers.find(x => x.id === absentId);
                if(!t) return;
                const simulatedDate = new Date(new Date().getTime() + this.state.simulationOffset);
                const dayIndex = simulatedDate.getDay() + 1; 
                const dateKey = simulatedDate.toISOString().split('T')[0];
                if(dayIndex > 5) {
                    container.innerHTML = `<div class="text-center p-8 text-amber-600 bg-amber-50 rounded-2xl border border-amber-100 font-bold flex flex-col items-center justify-center gap-3 h-40"><i class="fas fa-coffee text-2xl"></i><span>ุงูููู ุนุทูุฉ ููุงูุฉ ุงูุฃุณุจูุน</span></div>`;
                    return;
                }
                const todayLessons = t.lessons.filter(l => l.day === dayIndex).sort((a,b) => a.period - b.period);
                if(todayLessons.length === 0) {
                    container.innerHTML = `<div class="text-center p-8 text-emerald-600 bg-emerald-50 rounded-2xl border border-emerald-100 font-bold flex flex-col items-center justify-center gap-3 h-40"><i class="fas fa-check-circle text-2xl"></i><span>ูุง ุชูุฌุฏ ุญุตุต ููุฐุง ุงููุนูู ุงูููู.</span></div>`;
                    return;
                }
                container.innerHTML = todayLessons.map(l => {
                    const periodInfo = this.state.periods.find(p => parseInt(p.id) === l.period);
                    const timeStr = periodInfo ? `<span class="text-xs font-mono text-slate-400 bg-slate-100 px-2 py-0.5 rounded-md ml-2">${periodInfo.start} - ${periodInfo.end}</span>` : '';
                    const subKey = `${dateKey}_p${l.period}_${l.className}`;
                    const subId = this.state.substitutions[subKey];
                    const subTeacher = subId ? this.state.teachers.find(st => st.id === subId) : null;
                    return `
                    <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4 hover:shadow-md transition">
                        <div class="flex items-center gap-5 w-full md:w-auto">
                            <div class="bg-[rgb(var(--color-primary-50))] text-[rgb(var(--color-primary-600))] w-14 h-14 rounded-2xl flex flex-col items-center justify-center font-bold border border-[rgb(var(--color-primary-100))] shadow-inner">
                                <span class="text-[10px] uppercase opacity-70">ุงูุญุตุฉ</span><span class="text-xl leading-none font-black">${l.period}</span>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800 text-lg">${l.className}</h4>
                                <div class="flex items-center gap-2 mt-1">
                                    ${timeStr}
                                    <span class="bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-0.5 rounded-lg border border-slate-200">${t.specialization || 'ุนุงู'}</span>
                                    ${subTeacher ? `<span class="bg-amber-100 text-amber-700 text-[10px] font-bold px-2 py-0.5 rounded-lg border border-amber-200 flex items-center gap-1"><i class="fas fa-user-check"></i> ุจุฏูู: ${subTeacher.name}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <button onclick="window.app.findSubstitutes('${absentId}', ${l.period}, '${l.className}')" class="w-full md:w-auto bg-white hover:bg-slate-50 text-[rgb(var(--color-primary-600))] border border-[rgb(var(--color-primary-100))] px-6 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition cursor-pointer shadow-sm hover:shadow">
                            <i class="fas fa-search"></i> <span>${subTeacher ? 'ุชุบููุฑ ุงูุจุฏูู' : 'ุฅูุฌุงุฏ ุจุฏูู'}</span>
                        </button>
                    </div>`;
                }).join('');
            }

            calculateWeeklyLoad(teacher) { return teacher.lessons ? teacher.lessons.length : 0; }

            findSubstitutes(absentId, period, className) {
                const simulatedDate = new Date(new Date().getTime() + this.state.simulationOffset);
                const dayIndex = simulatedDate.getDay() + 1;
                const absentTeacher = this.state.teachers.find(t => t.id === absentId);
                const dateKey = simulatedDate.toISOString().split('T')[0];
                const busySubIds = [];
                const subs = this.state.substitutions || {};
                Object.keys(subs).forEach(key => {
                    if(key.startsWith(`${dateKey}_p${period}_`)) { busySubIds.push(subs[key]); }
                });
                let available = this.state.teachers.filter(t => {
                    if (t.id === absentId) return false; 
                    if (busySubIds.includes(t.id)) return false;
                    const hasClass = t.lessons.some(l => l.day === dayIndex && l.period === period);
                    return !hasClass;
                });
                available.sort((a,b) => this.calculateWeeklyLoad(a) - this.calculateWeeklyLoad(b));
                const list = document.getElementById('substituteList');
                document.getElementById('subModalPeriodInfo').innerText = `ุงูุญุตุฉ ${period} - ${className}`;
                list.innerHTML = available.map(t => {
                    const load = this.calculateWeeklyLoad(t);
                    let loadColor = load < 10 ? 'text-emerald-700 bg-emerald-50 border-emerald-100' : (load < 18 ? 'text-amber-700 bg-amber-50 border-amber-100' : 'text-rose-700 bg-rose-50 border-rose-100');
                    return `
                    <div class="flex items-center justify-between p-3 bg-white rounded-xl border border-slate-100 shadow-sm hover:shadow transition group mb-2">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-sm font-bold text-slate-500 border-2 border-white shadow-sm">${t.short[0] || '?'}</div>
                            <div>
                                <div class="font-bold text-sm text-slate-800">${t.name}</div>
                                <div class="text-[10px] text-slate-400 font-medium">${t.specialization || 'ุบูุฑ ูุญุฏุฏ'}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="text-[10px] font-bold px-2 py-1 rounded-lg border ${loadColor}">ูุตุงุจ: ${load}</div>
                            <button onclick="window.app.assignSubstitute('${t.id}', '${absentId}', ${period}, '${className}')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition shadow-sm" title="ุชุซุจูุช ุงูุจุฏูู">ุชุซุจูุช</button>
                            <button onclick="window.app.sendSubstituteMessage('${t.id}', ${period}, '${className}', '${absentTeacher.name}')" class="bg-emerald-50 hover:bg-emerald-100 text-emerald-600 border border-emerald-100 w-8 h-8 rounded-lg flex items-center justify-center transition shadow-sm" title="ุฅุฑุณุงู ูุงุชุณุงุจ"><i class="fab fa-whatsapp text-lg"></i></button>
                        </div>
                    </div>`;
                }).join('');
                document.getElementById('modal-substitute').classList.remove('hidden-view');
            }

            assignSubstitute(subId, originalId, period, className) {
                if(!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุชุนููู ูุฐุง ุงููุนูู ูุจุฏููุ')) return;
                const simulatedDate = new Date(new Date().getTime() + this.state.simulationOffset);
                const dateKey = simulatedDate.toISOString().split('T')[0];
                const key = `${dateKey}_p${period}_${className}`;
                if(!this.state.substitutions) this.state.substitutions = {};
                this.state.substitutions[key] = subId;
                this.saveData();
                this.closeModal('modal-substitute');
                this.renderAbsentSchedule(); 
                this.renderDailySubstitutions(); 
            }

            sendSubstituteMessage(subId, period, className, absentName) {
                const t = this.state.teachers.find(x => x.id === subId);
                if(!t || !t.phone) return alert('ูุฑุฌู ุฅุถุงูุฉ ุฑูู ูุงุชู ูููุนูู ุงูุจุฏูู ุฃููุงู ูู ุณุฌู ุงููุนูููู.');
                const msg = `ุงูุณูุงู ุนูููู ุฃุณุชุงุฐ ${t.name}ุ\nูุฑุฌู ุงูุชูุฑู ุจุฏุฎูู ุญุตุฉ ุงุญุชูุงุท:\n๐ ุงูุญุตุฉ: ${period}\n๐ซ ุงูุตู: ${className}\n๐ค ุจุฏูุงู ูู: ุงูุฃุณุชุงุฐ ${absentName}\n\nุดูุฑุงู ูุชุนุงูููู.`;
                window.open(`https://wa.me/${t.phone}?text=${encodeURIComponent(msg)}`, '_blank');
            }

            renderSupervisionHub() {
                const select = document.getElementById('supTeacherSelect');
                if(select) {
                    select.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุนูู...</option>';
                    const sortedTeachers = [...this.state.teachers].sort((a,b) => a.name.localeCompare(b.name, 'ar'));
                    sortedTeachers.forEach(t => { const opt = document.createElement('option'); opt.value = t.id; opt.text = t.name; select.add(opt); });
                }
                const history = this.state.supervisionHistory || [];
                document.getElementById('hubTotalVisits').innerText = history.length;
                let totalScore = 0; let count = 0;
                history.forEach(h => { let visitTotal = 0; let visitItems = 0; Object.values(h.ratings).forEach(r => { visitTotal += (6 - parseInt(r)); visitItems++; }); if(visitItems > 0) { totalScore += (visitTotal / visitItems) * 20; count++; } });
                document.getElementById('hubAvgScore').innerText = count > 0 ? Math.round(totalScore/count) + '%' : '0%';
                const list = document.getElementById('hubRecentList'); if(!list) return;
                const recent = [...history].sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime()).slice(0, 5);
                list.innerHTML = recent.length === 0 ? `<div class="p-8 text-center text-slate-400 text-sm flex flex-col items-center gap-2"><i class="fas fa-inbox text-2xl opacity-50"></i>ูุง ุชูุฌุฏ ุฒูุงุฑุงุช ุญุฏูุซุฉ</div>` : recent.map(v => `<div class="p-4 flex justify-between items-center hover:bg-slate-50 transition border-b border-slate-50 last:border-0"><div><div class="font-bold text-slate-800 text-sm">${v.teacherName}</div><div class="text-[10px] text-slate-400 font-medium mt-0.5">${v.date} <span class="mx-1">โข</span> ${v.topic}</div></div><button onclick="window.app.loadVisitByDate('${v.id}')" class="bg-white hover:bg-slate-50 text-[rgb(var(--color-primary-600))] border border-slate-200 px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition shadow-sm">ุนุฑุถ</button></div>`).join('');
            }
            
            loadVisitByDate(id) { const visit = this.state.supervisionHistory.find(v => v.id === id); if(visit) { this.state.supervisionData = { ratings: visit.ratings, notes: visit.notes || {}, gender: visit.gender || 'male' }; this.generateReport(true, visit); } }

            startSupervision(teacherId, className) {
                const nameInput = document.getElementById('supTeacherName');
                const selectParent = document.getElementById('supTeacherSelect')?.parentElement;
                
                if (!teacherId) {
                    this.state.supervisionData = { ratings: {}, notes: {}, gender: this.state.defaultSchoolGender };
                    this.renderSupervisionHub(); 
                    
                    nameInput?.classList.add('hidden'); 
                    selectParent?.classList.remove('hidden');
                    
                    const select = document.getElementById('supTeacherSelect');
                    if(select) select.value = "";
                    
                    const cName = document.getElementById('supClassName');
                    if(cName) cName.value = "";
                    
                    const topic = document.getElementById('supLessonTopic');
                    if(topic) topic.value = "";
                    
                    this.renderCriteria(); 
                    this.setView('supervision'); 
                    return;
                }
                
                const t = this.state.teachers.find(x => x.id === teacherId); 
                if(!t) return;
                
                selectParent?.classList.add('hidden'); 
                nameInput?.classList.remove('hidden'); 
                if(nameInput) nameInput.value = t.name;
                
                const cName = document.getElementById('supClassName');
                if(cName) cName.value = className || '';
                
                const topic = document.getElementById('supLessonTopic');
                if(topic) topic.value = '';
                
                if (this.state.defaultSchoolGender === 'female') {
                    const rf = document.getElementById('supGenderFemale');
                    if(rf) rf.checked = true;
                } else {
                    const rm = document.getElementById('supGenderMale');
                    if(rm) rm.checked = true;
                }
                
                const specSelect = document.getElementById('supSpecialization'); 
                if(specSelect) {
                    specSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุชุฎุตุต...</option>';
                    const specs = this.state.specializations || []; 
                    specs.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.text = s; specSelect.add(opt); }); 
                    if (t.specialization) specSelect.value = t.specialization;
                }
                
                this.state.supervisionData = { ratings: {}, notes: {}, gender: this.state.defaultSchoolGender }; 
                this.renderCriteria(); 
                this.setView('supervision');
            }

            renderCriteria() {
                const list = document.getElementById('supervisionCriteriaList');
                list.innerHTML = this.state.evaluationCriteria.map((criterion, index) => `<div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm"><div class="mb-5 border-b border-slate-50 pb-3"><h3 class="font-bold text-slate-800 text-lg flex items-center gap-3"><span class="bg-[rgb(var(--color-primary-100))] text-[rgb(var(--color-primary-700))] w-8 h-8 rounded-xl flex items-center justify-center text-sm font-bold shadow-inner">${index + 1}</span>${criterion.title}</h3><p class="text-xs text-slate-400 mr-11 mt-1 font-medium">${criterion.subtitle}</p></div><div class="space-y-3">${[1,2,3,4,5].map(rating => { const item = criterion.items[rating]; const desc = item ? item.desc : ''; return `<label class="relative flex items-start gap-4 p-4 border border-slate-100 rounded-2xl cursor-pointer bg-slate-50 hover:bg-white hover:border-[rgb(var(--color-primary-200))] transition-all group"><input type="radio" name="criteria_${criterion.id}" value="${rating}" onchange="window.app.setRating(${criterion.id}, ${rating})" class="sup-radio peer mt-1 accent-[rgb(var(--color-primary-600))]"><div class="flex-1"><div class="flex items-center gap-2 mb-1.5"><span class="font-bold text-[rgb(var(--color-primary-700))] bg-[rgb(var(--color-primary-50))] px-2.5 py-0.5 rounded-lg text-xs">ูุณุชูู ${rating}</span></div><p class="text-xs text-slate-500 leading-relaxed font-medium">${desc}</p></div><div class="check-icon hidden text-[rgb(var(--color-primary-600))] absolute top-4 left-4 text-lg"><i class="fas fa-check-circle"></i></div></label>`; }).join('')}</div><div class="mt-4"><input type="text" onchange="window.app.setNote(${criterion.id}, this.value)" placeholder="ุงูุชุจ ููุงุญุธุฉ ูุญุฏุฏุฉ ุญูู ูุฐุง ุงูุจูุฏ (ุงุฎุชูุงุฑู)..." class="w-full text-xs p-3 rounded-xl border border-slate-200 bg-white focus:border-[rgb(var(--color-primary-500))] focus:ring-4 focus:ring-[rgb(var(--color-primary-50))] outline-none transition-all"></div></div>`).join('');
            }

            onTeacherSelectChange() {
                const select = document.getElementById('supTeacherSelect'); const tId = select.value; const t = this.state.teachers.find(x => x.id === tId);
                const specSelect = document.getElementById('supSpecialization'); specSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุชุฎุตุต...</option>';
                const specs = this.state.specializations || []; specs.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.text = s; specSelect.add(opt); });
                if(t && t.specialization) specSelect.value = t.specialization;
            }

            setRating(criteriaId, rating) { this.state.supervisionData.ratings[criteriaId] = rating; }
            setNote(criteriaId, text) { if(!this.state.supervisionData.notes) this.state.supervisionData.notes = {}; this.state.supervisionData.notes[criteriaId] = text; }

            generateReport(isLoad = false, existingData = null) {
                const ratings = existingData ? existingData.ratings : this.state.supervisionData.ratings;
                if (!isLoad && Object.keys(ratings).length < this.state.evaluationCriteria.length) {
                    alert('ูุฑุฌู ุงุณุชููุงู ุชูููู ุฌููุน ุงูุจููุฏ');
                    return;
                }

                const now = new Date();
                
                let tName = "";
                if (isLoad) {
                    tName = existingData.teacherName;
                } else {
                    const nameInput = document.getElementById('supTeacherName');
                    if (nameInput && !nameInput.classList.contains('hidden')) {
                        tName = nameInput.value;
                    } else {
                        const select = document.getElementById('supTeacherSelect');
                        tName = select.options[select.selectedIndex].text;
                    }
                }
                const t = this.state.teachers.find(t => t.name === tName);

                const spec = isLoad ? existingData.specialization : document.getElementById('supSpecialization').value;
                const cName = isLoad ? existingData.className : document.getElementById('supClassName').value;
                const lTopic = isLoad ? existingData.topic : document.getElementById('supLessonTopic').value || '-';
                const schoolGender = isLoad ? existingData.gender : document.querySelector('input[name="supSchoolGender"]:checked').value;
                const visitDate = isLoad ? existingData.date : now.toLocaleDateString('en-CA');

                this.state.supervisionData.gender = schoolGender;

                document.getElementById('repTeacherName').innerText = tName;
                document.getElementById('repSchoolName').innerText = t?.school || 'ูุฏุฑุณุฉ ุงูุดูุฎ ูุญูุฏ ุจู ุดุงูุณ ุงูุจุทุงุดู';
                document.getElementById('repVisitDate').innerText = visitDate;
                document.getElementById('repClassName').innerText = cName;
                document.getElementById('repSpecialization').innerText = spec || 'ุนุงู';
                document.getElementById('repLessonTopic').innerText = lTopic;
                const visitorName = this.state.currentUser?.name || "ูุฏูุฑ ุงููุฏุฑุณุฉ";
                document.getElementById('repDirectorate').innerText = this.state.directorate || 'ุงููุฏูุฑูุฉ ุงูุนุงูุฉ ููุชุฑุจูุฉ ูุงูุชุนููู ุจูุญุงูุธุฉ ูุณูุท';

                const detailsBody = document.getElementById('repDetailsBody');
                const sortedCriteria = [...this.state.evaluationCriteria].sort((a, b) => a.id - b.id);
                
                detailsBody.innerHTML = sortedCriteria.map((c, index) => {
                    const r = ratings[c.id];
                    return `
                        <tr class="hover:bg-slate-50 text-sm">
                            <td class="border border-slate-500 p-2">
                                <div class="font-bold text-slate-800">${c.title}</div>
                                <div class="text-xs text-slate-500 mt-0.5">${c.subtitle}</div>
                            </td>
                            <td class="border border-slate-500 p-2 text-center font-extrabold text-slate-800 align-middle w-20">${r || '-'}</td>
                        </tr>
                    `;
                }).join('');


                document.getElementById('repFooterTeacherName_p1').innerText = tName;
                document.getElementById('repFooterVisitorName_p1').innerText = visitorName;
                document.getElementById('repFooterTeacherName_p2').innerText = tName;
                document.getElementById('repFooterVisitorName_p2').innerText = visitorName;

                if (isLoad && existingData.aiReportContent) {
                    document.getElementById('aiReportContent').innerHTML = existingData.aiReportContent;
                } else {
                    const allRatedItems = this.state.evaluationCriteria
                        .filter(c => ratings[c.id] !== undefined)
                        .map(c => ({ criterion: c, rating: ratings[c.id] }));

                    const strengths = [...allRatedItems]
                        .sort((a, b) => a.rating - b.rating)
                        .slice(0, 4);

                    const improvements = allRatedItems
                        .filter(item => item.rating > 2)
                        .sort((a, b) => b.rating - a.rating);

                    const strengthsHTML = strengths.map(s => `<li>${s.criterion.items[s.rating].desc}</li>`).join('');
                    const improvementsHTML = improvements.map(s => `<li>${s.criterion.items[s.rating].desc}</li>`).join('');
                    const recommendationsHTML = improvements.map(s => `<li>${s.criterion.items[s.rating].rec}</li>`).join('');
                    const supportText = schoolGender === 'female' ? 'ุชุจุงุฏู ุฒูุงุฑุงุช ูุน ูุนููุฉ ุฐุงุช ุฎุจุฑุฉ.' : 'ุชุจุงุฏู ุฒูุงุฑุงุช ูุน ูุนูู ุฐู ุฎุจุฑุฉ.';

                    document.getElementById('aiReportContent').innerHTML = `
                <div class="report-section">
                    <h3>ุฌูุงูุจ ุงูุฅุฌุงุฏุฉ ูู ุงูุฃุฏุงุก ูุฃุฏูุชูุง</h3>
                    <ul>${strengthsHTML || '<li>ูุธูุฑ ุงููุนูู ุฃุฏุงุกู ูุชูุงุฒููุง ูู ูุงูุฉ ุงูุฌูุงูุจ.</li>'}</ul>
                </div>
                <div class="report-section">
                    <h3>ุงูุฌูุงูุจ ุงูุชู ุชุญุชุงุฌ ุฅูู ุชุทููุฑ ูู ุงูุฃุฏุงุก ูุฃุฏูุชูุง</h3>
                    <ul>${improvementsHTML || '<li>ูุง ุชูุฌุฏ ููุงุท ุถุนู ููุญูุธุฉ ุชุณุชุฏุนู ุงูุชุฏุฎู ุงูุนุงุฌู.</li>'}</ul>
                </div>
                <div class="report-section">
                     <h3>ุงูุฏุนู ุงูููุฏู</h3>
                     <ul><li>${supportText}</li></ul>
                </div>
                <div class="report-section">
                    <h3>ุงูุชูุตูุงุช</h3>
                    <ul>${recommendationsHTML || '<li>ุงูุงุณุชูุฑุงุฑ ูู ุงูุฃุฏุงุก ุงููุชููุฒ ููุดุงุฑูุฉ ุงูุฎุจุฑุงุช ูุน ุงูุฒููุงุก.</li>'}</ul>
                </div>
            `;
                }

                // New Logic: Always allow attempt (server checks limit)
                const enhanceButton = document.getElementById('btn-enhance-ai');
                if (enhanceButton) {
                    enhanceButton.disabled = false;
                    enhanceButton.onclick = () => this.enhanceReportWithAI();
                }

                this.setView('supervision-report');
            }


            saveVisit() {
                const visitData = { id: Date.now().toString(), teacherName: document.getElementById('repTeacherName').innerText, specialization: document.getElementById('repSpecialization').innerText, className: document.getElementById('repClassName').innerText, topic: document.getElementById('repLessonTopic').innerText, date: document.getElementById('repVisitDate').innerText, gender: this.state.supervisionData.gender, ratings: {...this.state.supervisionData.ratings}, notes: {...this.state.supervisionData.notes}, aiReportContent: document.getElementById('aiReportContent').innerHTML };
                if(!this.state.supervisionHistory) this.state.supervisionHistory = []; const existingIndex = this.state.supervisionHistory.findIndex(v => v.id === visitData.id); if (existingIndex > -1) { this.state.supervisionHistory[existingIndex] = visitData; } else { this.state.supervisionHistory.push(visitData); } this.saveData(); alert('ุชู ุญูุธ ุงูุฒูุงุฑุฉ ูู ุงูุณุฌู ุจูุฌุงุญ');
            }

            printSupervisionReport() {
                document.body.classList.add('printing-supervision');
                window.addEventListener('afterprint', () => {
                    document.body.classList.remove('printing-supervision');
                }, { once: true });
                window.print();
            }

            buildReportContextText() {
                let rawData = "";
                const ratings = this.state.supervisionData.ratings;
                const allRatedItems = this.state.evaluationCriteria
                    .filter(c => ratings[c.id] !== undefined)
                    .map(c => ({ criterion: c, rating: ratings[c.id], note: this.state.supervisionData.notes[c.id] || '' }));

                const strengths = [...allRatedItems]
                    .sort((a, b) => a.rating - b.rating)
                    .slice(0, 4);

                const improvements = allRatedItems
                    .filter(item => item.rating > 2)
                    .sort((a, b) => b.rating - a.rating);

                rawData += "--- ุฌูุงูุจ ุงูุฅุฌุงุฏุฉ (ุฃูุถู 4 ุจููุฏ) ---\n";
                strengths.forEach(item => {
                    const desc = item.criterion.items[item.rating]?.desc || '';
                    rawData += `- ${item.criterion.title}: (${desc}) ${item.note ? '- ููุงุญุธุฉ: ' + item.note : ''}\n`;
                });

                rawData += "\n--- ุงูุฌูุงูุจ ุงูุชู ุชุญุชุงุฌ ุฅูู ุชุทููุฑ (ูู ุงูุจููุฏ ุจุชูููู ุฃุนูู ูู 2) ---\n";
                if (improvements.length > 0) {
                    improvements.forEach(item => {
                        const desc = item.criterion.items[item.rating]?.desc || '';
                        const rec = item.criterion.items[item.rating]?.rec || '';
                        rawData += `- ${item.criterion.title}: (${desc}) - ุชูุตูุฉ ููุชุฑุญุฉ: (${rec}) ${item.note ? '- ููุงุญุธุฉ: ' + item.note : ''}\n`;
                    });
                } else {
                    rawData += "ูุง ุชูุฌุฏ ุจููุฏ ุชุญุชุงุฌ ุฅูู ุชุทููุฑ ููุญูุธ.\n";
                }
                return rawData;
            }

            buildPlainTextReport() {
                const teacherName = document.getElementById('repTeacherName').innerText;
                const specialization = document.getElementById('repSpecialization').innerText;
                const className = document.getElementById('repClassName').innerText;
                const topic = document.getElementById('repLessonTopic').innerText;
                const gender = this.state.supervisionData.gender;
                const isMale = gender === 'male';
                
                let prompt = `ุฃุนูู ูููุฌู ููู ุชุฑุจูู ุฎุจูุฑ ููุงุฏุฉ ${specialization}.\n`;
                const genderInstruction = isMale ? "" : "ูุฑุฌู ุงุณุชุฎุฏุงู ุตูุบุฉ ุงููุคูุซ ูู ุงูุชูุฑูุฑ (ูุนููุฉุ ุทุงูุจุงุชุ ูุงูุช...).";
                prompt += `ุงููุทููุจ: ุตูุงุบุฉ ุชูุฑูุฑ ุฒูุงุฑุฉ ุตููุฉ ุงุญุชุฑุงููุ ุชุฑุจููุ ููุญูุฒ ุจูุงุกู ุนูู ุงูุจูุงูุงุช ุงูุชุงููุฉ. ${genderInstruction}\n\n`;
                prompt += `--- ุจูุงูุงุช ุงูุฒูุงุฑุฉ ---\n`;
                prompt += `- ุงููุนูู/ุฉ: ${teacherName}\n`;
                prompt += `- ุงูุชุฎุตุต: ${specialization}\n`;
                prompt += `- ุงูุตู: ${className}\n`;
                prompt += `- ุนููุงู ุงูุฏุฑุณ: ${topic}\n`;
                prompt += `- ููุน ุงููุฏุฑุณุฉ: ${gender === 'male' ? 'ุจููู' : 'ุจูุงุช'}\n\n`;

                const rawData = this.buildReportContextText();
                prompt += rawData;

                prompt += `\n--- ูููู ุงูุชูุฑูุฑ ุงููุทููุจ ---\n`;
                prompt += `ูุฑุฌู ูุชุงุจุฉ ุงูุชูุฑูุฑ ุจุญูุซ ูุชุถูู ุงูุฃูุณุงู ุงูุชุงููุฉ ูุน ุงุณุชุฎุฏุงู ุงูุนูุงููู ุงูุฏูููุฉ:\n`;
                prompt += `1. ุฌูุงูุจ ุงูุฅุฌุงุฏุฉ ูู ุงูุฃุฏุงุก ูุฃุฏูุชูุง.\n`;
                prompt += `2. ุงูุฌูุงูุจ ุงูุชู ุชุญุชุงุฌ ุฅูู ุชุทููุฑ ูู ุงูุฃุฏุงุก ูุฃุฏูุชูุง.\n`;
                prompt += `3. ุงูุฏุนู ุงูููุฏู.\n`;
                prompt += `4. ุงูุชูุตูุงุช (ุจูุงุกู ุนูู ุงูุชูุตูุงุช ุงููุฐููุฑุฉ ูู ุงูุจูุงูุงุช ุงูุฎุงู).\n`;
                
                return prompt;
            }

            async copyToClipboardPrompt() {
                const prompt = this.buildPlainTextReport();
                try {
                    await navigator.clipboard.writeText(prompt);
                    alert("ุชู ูุณุฎ ูุงูุฉ ุชูุงุตูู ุงูุฒูุงุฑุฉ ููุนุงููุฑ ุงูุชูููู ุฅูู ุงูุญุงูุธุฉ ุจูุฌุงุญ!\n\nููููู ุงูุขู ุงูุชูุฌู ุฅูู ChatGPT ุฃู Gemini ููุตู ุงููุต ููุญุตูู ุนูู ุงูุชูุฑูุฑ.");
                } catch (err) {
                    console.error('Failed to copy: ', err);
                    alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุณุฎ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.");
                }
            }


            renderAIReport(content) { const cleanHtml = (content || "").replace(/```html/g, '').replace(/```/g, '').trim(); document.getElementById('aiReportContent').innerHTML = cleanHtml; }

            async enhanceReportWithAI() {
                this.logDebug('enhanceReportWithAI: Initiated.');

                // 1. Check Login
                if (!this.state.currentUser) {
                    return alert('ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ูุงุณุชุฎุฏุงู ูุฐู ุงูููุฒุฉ.');
                }

                // 2. Client-Side Validation
                const topic = document.getElementById('repLessonTopic').innerText;
                const specialization = document.getElementById('repSpecialization').innerText;

                if (!topic || topic === '-' || topic === 'ุนุงู') {
                    return alert('ูุฑุฌู ุชุญุฏูุฏ ุนููุงู ุงูุฏุฑุณ ูุชุฎุตุต ุงููุนูู ุจุฏูุฉ ููุญุตูู ุนูู ุชูุฑูุฑ ุฐูู.');
                }
                
                if (!this.functions) {
                    return alert('ุฎุฏูุฉ ุงูุณุญุงุจุฉ ุบูุฑ ูุชุงุญุฉ. ูุฑุฌู ุงูุชุฃูุฏ ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช.');
                }

                const reportContext = this.buildReportContextText();
                
                if (reportContext.length > 25000) {
                    return alert("ุงููุต ุงููุฏุฎู ุทููู ุฌุฏุงู (ุฃูุซุฑ ูู 25,000 ุญุฑู). ูุฑุฌู ุชูููู ูููุฉ ุงูููุงุญุธุงุช ูุจู ุงูุฅุฑุณุงู.");
                }

                document.getElementById('aiLoadingOverlay').classList.remove('hidden-view');

                try {
                    const gender = this.state.supervisionData.gender;
                    
                    const payload = { reportContext, specialization, topic, gender };
                    this.logDebug('enhanceReportWithAI: Calling cloud function with payload:', payload);

                    const generateAiReportFunction = this.functions.httpsCallable('generateAiReport');
                    const result = await generateAiReportFunction(payload);
                    
                    this.logDebug('enhanceReportWithAI: Cloud function success. Received data:', result.data);
                    
                    const jsonResponse = result.data;

                    const buildSection = (section) => {
                        if (!section || !section.title) return '';
                        const points = Array.isArray(section.points) ? section.points : [];
                        if (points.length === 0) return '';
                        
                        const pointsHtml = points.map(p => `<li>${p}</li>`).join('');
                        return `<div class="report-section"><h3>${section.title}</h3><ul>${pointsHtml}</ul></div>`;
                    };

                    const htmlResult = `
                        ${buildSection(jsonResponse.strengths)}
                        ${buildSection(jsonResponse.improvements)}
                        ${buildSection(jsonResponse.support)}
                        ${buildSection(jsonResponse.recommendations)}
                    `;

                    this.renderAIReport(htmlResult.trim());
                    this.logDebug('enhanceReportWithAI: Report rendering complete.');

                } catch (e) {
                    console.error("Cloud Function Error:", e);
                    
                    // HANDLE LIMIT REACHED SPECIFICALLY
                    if (e.message.includes('LIMIT_REACHED') || e.code === 'resource-exhausted') {
                        if(confirm("๐ ููุฐุช ูุญุงููุงุชู ุงููุฌุงููุฉ ุงูููู (5 ูุญุงููุงุช).\n\nูุฒูุงุฏุฉ ุงูุญุฏ ุงูููููุ ูุฑุฌู ุงูุชูุงุตู ูุน ุงููุทูุฑ.\n\nูู ุชุฑูุฏ ุงูุชูุงุตู ุงูุขู ุนุจุฑ ูุงุชุณุงุจุ")) {
                            this.contactSupport();
                        }
                    } else {
                        // General Error
                        let errorMsg = "ูุดู ุงููุนุงูุฌุฉ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู.";
                        if (e.code === 'invalid-argument') {
                            errorMsg = "ุฎุทุฃ ูู ุงูุจูุงูุงุช ุงููุฑุณูุฉ: ุงููุต ุทููู ุฌุฏุงู ุฃู ุบูุฑ ููุชูู.";
                        }
                        alert(`${errorMsg}\n(${e.message})`);
                    }
                    
                    this.logDebug('enhanceReportWithAI: Cloud function ERROR!', { message: e.message, code: e.code, details: e.details });
                } finally {
                    document.getElementById('aiLoadingOverlay')?.classList.add('hidden-view');
                }
            }
            
            handleCriteriaExcel(e) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        // We use header:1 to get array of arrays (rows)
                        const json = XLSX.utils.sheet_to_json(ws, {header: 1});
                        
                        // Parse logic for structure: Criteria | DescCriteria | Rating | BehaviorDesc | Recs
                        const criteriaMap = {};
                        let importCount = 0;

                        // Skip header row (index 0), start from 1
                        for (let i = 1; i < json.length; i++) {
                            const row = json[i];
                            if (!row || row.length < 3) continue;

                            const title = row[0]; // Col A: ุงููุนูุงุฑ
                            if (!title) continue;

                            const subtitle = row[1] || ""; // Col B: ูุตู ุงููุนูุงุฑ
                            let ratingVal = row[2]; // Col C: ุงูุญูู (1-5)
                            const desc = row[3] || ""; // Col D: ุงููุตู ุงูุณูููู
                            const rec = row[4] || ""; // Col E: ุงูุชูุตูุงุช

                            // Extract number from rating (e.g., "ูุณุชูู 5" -> 5)
                            const ratingMatch = String(ratingVal).match(/\d+/);
                            const rating = ratingMatch ? parseInt(ratingMatch[0]) : 0;

                            if (!criteriaMap[title]) {
                                criteriaMap[title] = {
                                    id: Date.now() + i, // Unique ID gen
                                    title: title,
                                    subtitle: subtitle,
                                    items: {}
                                };
                            }

                            if (rating >= 1 && rating <= 5) {
                                criteriaMap[title].items[rating] = { desc, rec };
                                importCount++;
                            }
                        }

                        const newCriteriaList = Object.values(criteriaMap);
                        if (newCriteriaList.length > 0) {
                            this.state.evaluationCriteria = newCriteriaList;
                            this.saveData();
                            alert(`ุชู ุงุณุชูุฑุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ!\nุนุฏุฏ ุงููุนุงููุฑ: ${newCriteriaList.length}\nุนุฏุฏ ุงูุจููุฏ: ${importCount}`);
                            this.closeModal('modal-settings');
                        } else {
                            alert("ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ุตุงูุญุฉ ูู ุงูููู. ูุฑุฌู ุงูุชุฃูุฏ ูู ุชุฑุชูุจ ุงูุฃุนูุฏุฉ.");
                        }

                    } catch (err) {
                        console.error("Excel Import Error:", err);
                        alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุฑุงุกุฉ ุงูููู. ุชุฃูุฏ ูู ุฃูู ููู Excel ุตุงูุญ.");
                    }
                };
                reader.readAsArrayBuffer(e.target.files[0]);
            }

            deleteData() {
                if (confirm('ุชุญุฐูุฑ: ุณูุชู ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงููุฎุฒูุฉ (ุงููุนููููุ ุงูุณุฌูุ ุงูููุงู) ูุฅุนุงุฏุฉ ุงูุชุทุจูู ูุญุงูุฉ ุงููุตูุน.\n\nูู ุฃูุช ูุชุฃูุฏ ุชูุงูุงูุ')) {
                    if (confirm('ุชุฃููุฏ ููุงุฆู: ูู ุชุฑุบุจ ุจุญุฐู ูู ุดูุกุ')) {
                        localStorage.removeItem('school_data_v1');
                        if (this.state.currentUser && this.db) {
                            this.db.collection("users").doc(this.state.currentUser.uid).set({
                                teachers: [], periods: [], classes: {}, tasks: [], agenda: [],
                                violationTypes: this.state.violationTypes, 
                                supervisionHistory: [],
                                evaluationCriteria: [],
                                dutyLocations: [],
                                dutySchedule: {}
                            }, { merge: true });
                        }
                        alert('ุชู ุญุฐู ุงูุจูุงูุงุช ุจูุฌุงุญ.');
                        location.reload();
                    }
                }
            }

            // --- Updated Render All Logic ---
            renderAll() { 
                const v = this.state.currentView; // Use state variable instead of fragile DOM selector
                this.setView(v);
            }
            
            renderCurrentPeriod(now) { 
                const mins = now.getHours() * 60 + now.getMinutes(); 
                const currentPeriod = this.state.periods.find(p => { 
                    const [sh, sm] = p.start.split(':').map(Number); 
                    const [eh, em] = p.end.split(':').map(Number); 
                    return mins >= (sh*60+sm) && mins <= (eh*60+em); 
                }); 
                const infoDiv = document.getElementById('currentPeriodInfo'); 
                if(infoDiv) {
                    if (currentPeriod) {
                        const [eh, em] = currentPeriod.end.split(':').map(Number);
                        const endTime = new Date(now);
                        endTime.setHours(eh, em, 0, 0);
                        const diff = Math.floor((endTime.getTime() - now.getTime()) / 1000);
                        const m = Math.floor(diff / 60);
                        const s = diff % 60;
                        const countdown = `${m}:${s < 10 ? '0'+s : s}`;
                        infoDiv.innerHTML = `<div class="flex items-center gap-3"><div class="flex flex-col"><span class="text-[rgb(var(--color-primary-100))] text-xs font-bold uppercase tracking-wider">ุงูุญุตุฉ ุงูุญุงููุฉ</span><span class="text-white text-2xl font-bold font-mono leading-none">${currentPeriod.id}</span></div><div class="h-8 w-px bg-white/20 mx-1"></div><div class="flex flex-col items-end"><span class="text-white font-mono text-sm tracking-wide opacity-90">${currentPeriod.start} - ${currentPeriod.end}</span><span class="text-red-300 font-mono font-bold text-xs flex items-center gap-1 mt-0.5"><i class="fas fa-hourglass-end text-[10px]"></i> ${countdown}</span></div></div>`; 
                    } else {
                        infoDiv.innerHTML = `<div class="flex items-center gap-2 text-white/80 font-bold text-sm bg-white/10 px-3 py-1.5 rounded-lg"><i class="fas fa-coffee"></i> ูุง ุชูุฌุฏ ุญุตุต ูุดุทุฉ</div>`;
                    }
                } 
                this.renderActiveClasses(now, currentPeriod); 
            }
            
            renderActiveClasses(now, period) { 
                const grid = document.getElementById('activeClassesGrid'); 
                if(!grid) return; 
                
                if(!period) { 
                    grid.innerHTML = `<div class="col-span-full py-20 text-center text-slate-400 bg-slate-50/50 rounded-3xl border-2 border-dashed border-slate-200"><i class="fas fa-school text-4xl mb-4 text-slate-300"></i><p class="text-sm font-medium">ูุง ุชูุฌุฏ ุญุตุต ูู ุงูููุช ุงูุญุงูู</p></div>`; 
                    return; 
                } 
                
                const dayId = now.getDay() + 1; 
                const pId = parseInt(period.id); 
                const dateKey = now.toISOString().split('T')[0];
                let active = []; 
                
                this.state.teachers.forEach(t => { 
                    const l = t.lessons.find(ls => ls.day === dayId && ls.period === pId); 
                    if(l) {
                        // Check Substitution
                        const subKey = `${dateKey}_p${pId}_${l.className}`;
                        const subId = this.state.substitutions[subKey];
                        
                        if (subId) {
                            const subTeacher = this.state.teachers.find(st => st.id === subId);
                            if (subTeacher) {
                                active.push({ t: subTeacher, className: l.className, isSub: true, original: t.name });
                            } else {
                                active.push({ t, className: l.className });
                            }
                        } else {
                            active.push({ t, className: l.className }); 
                        }
                    }
                }); 
                
                // Sorting Logic Update: Handle Arabic Grade Names
                const getGradeValue = (name) => {
                    const n = name.trim();
                    if (n.match(/(ุงูุซุงูู|ุซุงูู)\s*ุนุดุฑ/)) return 12;
                    if (n.match(/(ุงูุญุงุฏู|ุญุงุฏู)\s*ุนุดุฑ/)) return 11;
                    if (n.match(/ุงูุนุงุดุฑ|ุนุงุดุฑ/)) return 10;
                    if (n.match(/ุงูุชุงุณุน|ุชุงุณุน/)) return 9;
                    if (n.match(/ุงูุซุงูู|ุซุงูู/)) return 8;
                    if (n.match(/ุงูุณุงุจุน|ุณุงุจุน/)) return 7;
                    if (n.match(/ุงูุณุงุฏุณ|ุณุงุฏุณ/)) return 6;
                    if (n.match(/ุงูุฎุงูุณ|ุฎุงูุณ/)) return 5;
                    if (n.match(/ุงูุฑุงุจุน|ุฑุงุจุน/)) return 4;
                    if (n.match(/ุงูุซุงูุซ|ุซุงูุซ/)) return 3;
                    if (n.match(/ุงูุซุงูู|ุซุงูู/)) return 2;
                    if (n.match(/ุงูุฃูู|ุงูุงูู|ุงูู|ุฃูู/)) return 1;
                    
                    const match = n.match(/\d+/);
                    return match ? parseInt(match[0]) : 999;
                };

                active.sort((a, b) => { 
                    const valA = getGradeValue(a.className);
                    const valB = getGradeValue(b.className);
                    if (valA !== valB) return valA - valB;
                    return a.className.localeCompare(b.className, 'ar');
                }); 
                
                grid.innerHTML = active.map(item => {
                    const badgeClass = item.isSub ? 'bg-amber-100 text-amber-700 border-amber-200' : 'bg-slate-50 text-slate-700 border-slate-100';
                    const iconClass = item.isSub ? 'bg-amber-500 text-white border-amber-400' : 'bg-[rgb(var(--color-primary-50))] text-[rgb(var(--color-primary-600))] border-[rgb(var(--color-primary-100))]';
                    const subLabel = item.isSub ? `<div class="text-[9px] text-amber-600 font-bold mt-1 bg-amber-50 w-fit px-1.5 rounded">ุจุฏูุงู ูู: ${item.original}</div>` : '';

                    return `<div class="group bg-white rounded-2xl shadow-sm hover:shadow-lg transition-all duration-300 border border-slate-100 overflow-hidden relative flex flex-col card-hover min-h-[160px]">
                        <div class="h-1.5 w-full ${item.isSub ? 'bg-amber-500' : 'bg-gradient-to-r from-[rgb(var(--color-primary-500))] to-purple-500'}"></div>
                        <div class="p-5 flex-1 flex flex-col justify-between">
                            <div>
                                <div class="flex justify-between items-start mb-3">
                                    <span class="${badgeClass} px-3 py-1.5 rounded-lg text-sm font-black border truncate max-w-[75%] tracking-tight">${item.className}</span>
                                    <div class="w-9 h-9 rounded-full ${iconClass} flex items-center justify-center text-xs font-bold border ring-2 ring-white shadow-sm">${item.t.short[0] || '?'}</div>
                                </div>
                                <h3 class="font-extrabold text-base text-slate-800 mb-0 truncate leading-tight" title="${item.t.name}">${item.t.name}</h3>
                                ${subLabel}
                                <div class="flex items-center gap-1 text-[10px] text-slate-400 font-bold mb-1 mt-1.5">
                                    ${this.state.userMode === 'admin' ? `<i class="fas fa-star text-amber-400 text-xs"></i> <span>${item.t.score}%</span>` : ''}
                                </div>
                            </div>
                            ${this.state.userMode === 'admin' ? `
                            <button type="button" onclick="window.app.openActionModal('${item.t.id}', '${item.className}')" class="mt-4 w-full py-3 rounded-xl bg-slate-50 hover:bg-[rgb(var(--color-primary-50))] text-slate-600 hover:text-[rgb(var(--color-primary-700))] font-bold text-xs transition-colors flex justify-center items-center gap-2 cursor-pointer border border-slate-100 hover:border-[rgb(var(--color-primary-100))]">
                                <i class="fas fa-sliders-h"></i> ุฅุฌุฑุงุก
                            </button>` : ''}
                        </div>
                    </div>`; 
                }).join(''); 
            }
            renderTeachers() { 
                const term = document.getElementById('teacherSearch').value.toLowerCase(); 
                const grid = document.getElementById('teachersGrid'); 
                const countBadge = document.getElementById('teachersCountBadge');
                if(!grid) return; 
                let filtered = this.state.teachers.filter(t => t.name.toLowerCase().includes(term) || (t.school && t.school.toLowerCase().includes(term))); 
                filtered.sort((a,b) => a.name.localeCompare(b.name, 'ar')); 
                if(countBadge) countBadge.innerText = filtered.length;
                
                const isAdmin = this.state.userMode === 'admin';

                grid.innerHTML = filtered.map(t => { 
                    let scoreColor = t.score >= 90 ? "bg-emerald-50 text-emerald-600 border-emerald-100" : (t.score >= 70 ? "bg-amber-50 text-amber-600 border-amber-100" : "bg-rose-50 text-rose-600 border-rose-100"); 
                    const schoolBadge = t.school ? `<div class="text-[10px] text-slate-400 flex items-center gap-1 mt-1 bg-slate-50 px-2 py-0.5 rounded-md w-fit"><i class="fas fa-map-marker-alt text-slate-300"></i> ${t.school}</div>` : ''; 
                    
                    return `<div class="bg-white rounded-2xl shadow-sm hover:shadow-md transition border border-slate-100 p-5 flex flex-col gap-4 group"><div class="flex justify-between items-start"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-[rgb(var(--color-primary-500))] to-indigo-600 text-white flex items-center justify-center font-bold text-lg shadow-md shadow-indigo-100">${t.short[0] || '?'}</div><div><h3 class="font-bold text-slate-800 line-clamp-1 text-base">${t.name}</h3><p class="text-xs text-[rgb(var(--color-primary-600))] mt-0.5 font-bold bg-[rgb(var(--color-primary-50))] px-2 py-0.5 rounded-md w-fit">${t.specialization || 'ูุนูู ูุงุฏุฉ'}</p>${schoolBadge}</div></div>
                    ${isAdmin ? `<div class="font-black text-xs px-2.5 py-1.5 rounded-lg border ${scoreColor}">${t.score}%</div>` : ''}
                    </div><div class="relative group/input"><i class="fas fa-phone-alt absolute right-3.5 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within/input:text-[rgb(var(--color-primary-500))] transition-colors text-xs"></i><input type="tel" value="${t.phone || ''}" ${isAdmin ? `onchange="window.app.updatePhone('${t.id}', this.value)"` : 'readonly'} placeholder="ุฃุถู ุฑูู ุงููุงุชู" class="w-full pr-9 pl-3 py-2.5 text-sm rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-[rgb(var(--color-primary-500))] focus:ring-4 focus:ring-[rgb(var(--color-primary-100))] transition-all outline-none text-sm font-medium text-slate-800 placeholder:text-slate-400"></div><div class="flex gap-2 mt-auto pt-3 border-t border-slate-50">
                    ${isAdmin ? `<button type="button" onclick="window.app.openActionModal('${t.id}')" class="flex-1 bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 py-2.5 rounded-xl text-xs font-bold transition cursor-pointer shadow-sm">ุฅุฏุงุฑุฉ</button>` : ''}
                    <button type="button" onclick="window.app.openWhatsApp('${t.id}')" class="w-10 flex items-center justify-center bg-emerald-50 hover:bg-emerald-100 text-emerald-600 border border-emerald-100 rounded-xl transition cursor-pointer shadow-sm hover:shadow flex-none ml-auto"><i class="fab fa-whatsapp text-lg"></i></button></div></div>`; 
                }).join(''); 
            }
            renderAgenda() { const tbody = document.getElementById('agendaBody'); if(!tbody) return; const agenda = this.state.agenda || []; if(agenda.length === 0) { tbody.innerHTML = `<tr><td colspan="3" class="p-8 text-center text-slate-400 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200">ูุง ุชูุฌุฏ ุฃุญุฏุงุซ ูุณุฌูุฉ.</td></tr>`; return; } agenda.sort((a,b) => new Date(a.date).getTime() - new Date(b.date).getTime()); const todayStr = new Date().toISOString().split('T')[0]; tbody.innerHTML = agenda.map((item, index) => { const itemDateStr = new Date(item.date).toISOString().split('T')[0]; const isToday = itemDateStr === todayStr; return `<tr class="${isToday ? 'bg-yellow-50 border-r-4 border-yellow-400' : 'hover:bg-slate-50'} transition-colors border-b border-slate-100 last:border-0"><td class="p-4 text-center font-bold text-slate-400 text-xs font-mono">${index + 1}</td><td class="p-4 text-xs font-bold text-slate-500">${item.date}</td><td class="p-4 text-sm font-bold text-slate-700">${item.event}</td></tr>`; }).join(''); }
            verifyAdminAndImportAgenda() { if(prompt('PIN:') === '1234') document.getElementById('agendaInput').click(); else alert('ุฎุทุฃ'); }
            handleAgendaExcel(e) { const reader = new FileReader(); reader.onload = (evt) => { const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'}); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1}); const newAgenda = []; for(let i = 1; i < json.length; i++) { const row = json[i]; if(row && row.length >= 3) { let dateVal = row[1]; if(typeof dateVal === 'number') dateVal = new Date(Math.round((dateVal - 25569)*86400*1000)).toISOString().split('T')[0]; newAgenda.push({ id: Date.now() + i, date: dateVal, event: row[2] }); } } if(newAgenda.length > 0) { this.state.agenda = newAgenda; this.saveData(); this.renderAgenda(); alert('ุชู'); } else alert('ุชูุณูู ุบูุฑ ุตุงูุญ'); }; reader.readAsArrayBuffer(e.target.files[0]); }
            
            exportReports() { 
                const data = this.state.teachers.map(t => {
                    const violationsStr = (t.violations || [])
                        .map(v => `[${v.date}] ${v.label} (-${v.points})`)
                        .join(' \n ');

                    return { 
                        'ุงููุนูู': t.name, 
                        'ุงูุชูููู': t.score+'%', 
                        'ุงููุงุชู': t.phone||'-',
                        'ุณุฌู ุงููุฎุงููุงุช': violationsStr || 'ูุง ููุฌุฏ'
                    };
                }); 
                
                const ws = XLSX.utils.json_to_sheet(data); 
                ws['!cols'] = [{wch: 30}, {wch: 10}, {wch: 15}, {wch: 50}];

                const wb = XLSX.utils.book_new(); 
                XLSX.utils.book_append_sheet(wb, ws, "Reports"); 
                XLSX.writeFile(wb, "School_Report_Advanced.xlsx"); 
            }
            
            simulateRandomPeriod() { 
                if(!this.state.periods.length) return alert('ูุง ููุฌุฏ ุฌุฏูู'); 
                const r = this.state.periods[Math.floor(Math.random()*this.state.periods.length)]; 
                const [h,m] = r.start.split(':').map(Number); 
                let t = new Date();
                const currentDay = t.getDay(); 
                const targetDay = Math.floor(Math.random() * 5); 
                let diff = targetDay - currentDay;
                t.setDate(t.getDate() + diff);
                t.setHours(h, m, 0, 0);
                this.state.simulationOffset = t.getTime() - new Date().getTime(); 
                this.renderCurrentPeriod(t); 
                this.renderDailyDutyWidget(t); 
                 const clock = document.getElementById('clockDisplay');
                if(clock) {
                    clock.style.color = '#fbbf24';
                    setTimeout(() => clock.style.color = '', 500);
                }
            }

            resetTimeToReal() { this.state.simulationOffset = 0; const now = new Date(); this.renderCurrentPeriod(now); this.renderDailyDutyWidget(now); }
            startClock() { setInterval(() => { const n = new Date(new Date().getTime() + this.state.simulationOffset); document.getElementById('clockDisplay').innerText = n.toLocaleTimeString('en-GB'); this.renderCurrentPeriod(n); }, 1000); }
            renderViolationsSettings() { const list = document.getElementById('violationsList'); if(!list) return; list.innerHTML = this.state.violationTypes.map(v => `<div class="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-200 shadow-sm group hover:border-red-100 transition"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-white border border-slate-200 text-slate-400 flex items-center justify-center text-xs"><i class="fas ${v.icon}"></i></div><span class="font-bold text-xs text-slate-700">${v.label}</span></div><div class="flex items-center gap-3"><span class="bg-red-50 text-red-600 text-[10px] font-bold px-2 py-1 rounded-md border border-red-100">-${v.points}</span><button type="button" onclick="window.app.removeViolation('${v.id}')" class="text-slate-300 hover:text-red-500 transition px-2 cursor-pointer"><i class="fas fa-trash-alt"></i></button></div></div>`).join(''); }
            renderSpecializationsSettings() { const list = document.getElementById('specializationsList'); if(!list) return; list.innerHTML = (this.state.specializations || []).map((s, index) => `<div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-lg border border-slate-200 shadow-sm text-xs font-bold text-slate-700 group hover:border-[rgb(var(--color-primary-200))] transition">${s}<button onclick="window.app.removeSpecialization(${index})" class="text-slate-300 hover:text-red-500 transition cursor-pointer ml-1"><i class="fas fa-times"></i></button></div>`).join(''); }
            addSpecialization() { const input = document.getElementById('newSpecInput'); const val = input.value.trim(); if(val && !this.state.specializations.includes(val)) { this.state.specializations.push(val); input.value = ''; this.saveData(); this.renderSpecializationsSettings(); } }
            removeSpecialization(index) { if(confirm('ุญุฐู ูุฐุง ุงูุชุฎุตุตุ')) { this.state.specializations.splice(index, 1); this.saveData(); this.renderSpecializationsSettings(); } }
            addViolation() { const label = document.getElementById('newViolationLabel').value; const points = parseInt(document.getElementById('newViolationPoints').value); if(label && points) { this.state.violationTypes.push({ id: Date.now().toString(), label, points, icon: 'fa-exclamation-circle' }); document.getElementById('newViolationLabel').value=''; this.saveData(); this.renderViolationsSettings(); } }
            removeViolation(id) { this.state.violationTypes = this.state.violationTypes.filter(v => v.id !== id); this.saveData(); this.renderViolationsSettings(); }
            setTheme(themeName) { this.state.theme = themeName; this.applyTheme(); this.saveData(); this.renderThemeSelector(); }
            applyTheme() { document.body.classList.remove('theme-pink', 'theme-green', 'theme-dark', 'theme-indigo'); if (this.state.theme && this.state.theme !== 'default') document.body.classList.add(`theme-${this.state.theme}`); }
            renderThemeSelector() { const container = document.getElementById('themeSelectorContainer'); if (!container) return; const themes = [{ id: 'default', name: 'ุณูุงูู (ุฃุณุงุณู)', colorClass: 'bg-[#008ae6]', activeClass: 'ring-2 ring-[#008ae6] ring-offset-2' }, { id: 'indigo', name: 'ูููู', colorClass: 'bg-indigo-600', activeClass: 'ring-2 ring-indigo-500 ring-offset-2' }, { id: 'pink', name: 'ุฒูุฑู', colorClass: 'bg-pink-600', activeClass: 'ring-2 ring-pink-500 ring-offset-2' }, { id: 'green', name: 'ุฃุฎุถุฑ', colorClass: 'bg-green-600', activeClass: 'ring-2 ring-green-500 ring-offset-2' }, { id: 'dark', name: 'ูููู', colorClass: 'bg-slate-800', activeClass: 'ring-2 ring-slate-600 ring-offset-2' }]; container.innerHTML = themes.map(theme => { const isActive = this.state.theme === theme.id; const ringClass = isActive ? theme.activeClass : ''; return `<button onclick="window.app.setTheme('${theme.id}')" class="p-1 rounded-xl transition ${ringClass}"><div class="w-full h-12 rounded-lg ${theme.colorClass} shadow-sm"></div><span class="text-[10px] font-bold mt-1.5 block text-center text-slate-500">${theme.name}</span></button>`; }).join(''); }
            setDefaultSchoolGender(gender) { if (gender === 'male' || gender === 'female') { this.state.defaultSchoolGender = gender; this.saveData(); } }
            setDirectorate(value) {
                const val = value.trim();
                if(val) {
                    this.state.directorate = val;
                    this.saveData();
                }
            }
            renderSchoolGenderSettings() { const radios = document.getElementsByName('defaultSchoolGender'); for (const radio of radios) { if (radio.value === this.state.defaultSchoolGender) { radio.checked = true; } } }
            renderDirectorateSetting() {
                const input = document.getElementById('settingDirectorate');
                if (input) {
                    input.value = this.state.directorate || 'ุงููุฏูุฑูุฉ ุงูุนุงูุฉ ููุชุฑุจูุฉ ูุงูุชุนููู ุจูุญุงูุธุฉ ูุณูุท';
                }
            }
            openSettings() { 
                this.renderViolationsSettings(); 
                this.renderSpecializationsSettings(); 
                this.renderThemeSelector(); 
                this.renderSchoolGenderSettings(); 
                this.renderDirectorateSetting();
                document.getElementById('modal-settings')?.classList.remove('hidden-view'); 
            }

            addTask() { const text = document.getElementById('newTaskInput').value.trim(); if(text) { this.state.tasks.unshift({id:Date.now().toString(), text, priority: document.getElementById('newTaskPriority').value, completed:false}); this.saveData(); this.renderTasks(); document.getElementById('newTaskInput').value=''; } }
            toggleTask(id) { const t = this.state.tasks.find(x=>x.id===id); if(t) { t.completed=!t.completed; this.saveData(); this.renderTasks(); } }
            deleteTask(id) { if(confirm('ุญุฐูุ')) { this.state.tasks = this.state.tasks.filter(x=>x.id!==id); this.saveData(); this.renderTasks(); } }
            renderTasks() { const list = document.getElementById('tasksList'); if(!list) return; const completed = this.state.tasks.filter(t=>t.completed).length; document.getElementById('tasksProgressBar').style.width = (this.state.tasks.length ? Math.round((completed/this.state.tasks.length)*100) : 0) + '%'; document.getElementById('tasksProgressText').innerText = `${completed}/${this.state.tasks.length}`; list.innerHTML = this.state.tasks.length === 0 ? `<div class="text-center p-8 text-slate-400 bg-slate-50 rounded-2xl border border-dashed border-slate-200"><p class="text-xs font-medium">ูุง ุชูุฌุฏ ููุงู ุญุงููุงู.</p></div>` : this.state.tasks.map(t => `<div class="flex items-center gap-3 bg-white p-4 rounded-2xl border border-slate-100 shadow-sm transition hover:shadow-md group"><label class="relative flex items-center cursor-pointer"><input type="checkbox" class="task-checkbox sr-only peer" ${t.completed?'checked':''} onchange="window.app.toggleTask('${t.id}')"><div class="w-6 h-6 bg-slate-50 border-2 border-slate-200 rounded-full peer-checked:bg-emerald-500 peer-checked:border-emerald-500 transition-all flex items-center justify-center text-white"><i class="fas fa-check text-[10px] ${t.completed?'opacity-100':'opacity-0'}"></i></div></label><div class="flex-1 ${t.completed?'line-through text-slate-400':'text-slate-700'}"><p class="text-sm font-bold leading-snug">${t.text}</p></div><span class="text-[10px] px-2 py-1 rounded-lg font-bold ${t.priority==='urgent'?'bg-rose-50 text-rose-600 border border-rose-100':'bg-blue-50 text-blue-600 border border-blue-100'}">${t.priority==='urgent'?'ุนุงุฌู':'ุนุงุฏู'}</span><button onclick="window.app.deleteTask('${t.id}')" class="text-slate-300 hover:text-rose-500 transition px-2 opacity-0 group-hover:opacity-100"><i class="fas fa-trash-alt"></i></button></div>`).join(''); }
            renderHistory() { const grid = document.getElementById('supervisionHistoryGrid'); if(!grid) return; const history = this.state.supervisionHistory || []; if(history.length === 0) { grid.innerHTML = '<div class="text-center p-12 text-slate-400 bg-slate-50 rounded-3xl border border-dashed border-slate-200">ูุง ููุฌุฏ ุณุฌู ุฒูุงุฑุงุช ุญุชู ุงูุขู.</div>'; return; } history.sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime()); grid.innerHTML = history.map((v, i) => `<div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center gap-4 hover:border-[rgb(var(--color-primary-200))] transition group"><div class="flex-1"><div class="flex items-center gap-3 mb-1"><span class="font-bold text-slate-800 text-base">${v.teacherName}</span><span class="bg-slate-50 text-slate-500 text-[10px] px-2 py-0.5 rounded-md border border-slate-200 font-bold">${v.className}</span></div><p class="text-xs text-slate-500 mb-1 flex items-center gap-1"><i class="fas fa-book-open text-slate-300"></i> ${v.topic}</p><span class="text-[10px] text-slate-400 font-mono bg-slate-50 px-2 rounded">${v.date}</span></div><div class="flex gap-2 w-full md:w-auto opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="window.app.loadVisit(${i})" class="flex-1 md:flex-none bg-slate-50 text-slate-600 hover:bg-slate-100 hover:text-slate-800 px-4 py-2 rounded-xl font-bold text-xs transition cursor-pointer border border-slate-200">ุนุฑุถ ุงูุชูุงุตูู</button><button onclick="window.app.deleteVisit(${i})" class="md:flex-none text-rose-300 hover:text-rose-600 px-3 py-2 rounded-xl transition cursor-pointer hover:bg-rose-50"><i class="fas fa-trash"></i></button></div></div>`).join(''); }
            updatePhone(id, val) { const t = this.state.teachers.find(x => x.id === id); if(t) { t.phone = val; this.saveData(); } }
            openActionModal(tId, className = null) { this.state.selectedTeacherId = tId; this.state.selectedClassName = className; const t = this.state.teachers.find(x => x.id === tId); if(!t) return; document.getElementById('actionModalTitle').innerHTML = `<div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center text-lg">๐</div>${t.name}</div>`; document.getElementById('actionModalSubtitle').innerHTML = className && className !== 'undefined' ? `<span class="bg-white/10 px-2 py-0.5 rounded text-[10px]">ุงูุญุตุฉ: ${className}</span>` : 'ูุงุฆูุฉ ุงูุฅุฏุงุฑุฉ'; document.getElementById('currentScoreDisplay').innerText = t.score + '%'; const remind = document.getElementById('btn-remind'); const evalBtn = document.getElementById('btn-evaluate'); if(className && className !== 'undefined') { remind.disabled=false; remind.classList.remove('opacity-50','cursor-not-allowed'); evalBtn.onclick=()=>{this.closeModal('modal-action');this.startSupervision(tId,className);}; } else { remind.disabled=true; remind.classList.add('opacity-50','cursor-not-allowed'); evalBtn.onclick=()=>{this.closeModal('modal-action');this.startSupervision(tId,'ุฒูุงุฑุฉ ุนุงูุฉ');}; } document.getElementById('violationButtonsContainer').innerHTML = this.state.violationTypes.map(v => `<button type="button" onclick="window.app.dockScore('${v.id}')" class="w-full bg-slate-50 hover:bg-rose-50 text-slate-700 hover:text-rose-700 border border-slate-200 hover:border-rose-200 p-