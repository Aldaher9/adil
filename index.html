<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #1e3a5f; 
            --accent: #e67e22; 
            --success: #25d366; 
            --bg: #f4f7f6;
            /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
            --class-gradient: linear-gradient(135deg, #2c3e50 0%, #1e3a5f 100%);
        }
        * { font-family: 'Tajawal', sans-serif !important; box-sizing: border-box; }
        body { background: var(--bg); margin: 0; padding: 10px; color: #333; }
        
        .header { 
            background: var(--primary); color: white; padding: 15px; 
            border-radius: 12px; display: flex; justify-content: space-between; 
            align-items: center; margin-bottom: 10px;
        }
        
        .settings-btn { 
            background: var(--accent); border: none; color: white; 
            width: 50px; height: 50px; border-radius: 50%; 
            font-size: 24px; cursor: pointer; display: flex; 
            align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        #myModal { 
            display: none; position: fixed; z-index: 9999; 
            left: 0; top: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8);
        }
        .modal-content { 
            background: white; margin: 15% auto; padding: 20px; 
            border-radius: 15px; width: 90%; max-width: 350px; text-align: center;
        }

        .btn { display: block; width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: none; font-weight: bold; font-size: 16px; }
        .btn-sim { background: #8e44ad; color: white; }
        .btn-export { background: #2c3e50; color: white; }
        .btn-import { background: #27ae60; color: white; }
        .btn-reset { background: #e74c3c; color: white; }
        .btn-close { background: #666; color: white; margin-top: 20px; }

        .status-bar { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-right: 6px solid var(--accent); }
        .table-container { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 12px; font-size: 14px; border-bottom: 2px solid #eee; color: #666; }
        td { padding: 15px 8px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; }

        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØµÙ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
        .class-box {
            background: var(--class-gradient);
            color: white;
            padding: 10px 6px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            display: inline-block;
            min-width: 60px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255,255,255,0.1);
            letter-spacing: 0.5px;
        }

        .wa-link { background: var(--success); color: white; text-decoration: none; padding: 10px 14px; border-radius: 8px; font-size: 14px; display: inline-block; font-weight: bold; }
        
        /* ØªØ¬Ù…ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… */
        .teacher-name { font-weight: 700; font-size: 15px; color: #2c3e50; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0;">ğŸ“ Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯</h2>
    <button class="settings-btn" onclick="openSettings()">âš™ï¸</button>
</div>

<div class="status-bar">
    <div id="info">--</div>
    <div id="txtPeriod" style="font-size: 20px; font-weight: bold; color: var(--accent);">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..</div>
</div>

<div id="myModal">
    <div class="modal-content">
        <h3 style="margin-top:0;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
        <div style="background:#f9f9f9; padding:10px; border-radius:10px; border:1px dashed #ccc">
            <label>Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ (XML)</label>
            <input type="file" id="xmlFile" accept=".xml" onchange="handleXML(this)" style="width:100%">
        </div>
        <button class="btn btn-sim" onclick="doSim()">ğŸ² ØªØ¬Ø±Ø¨Ø© Ù…Ø­Ø§ÙƒØ§Ø©</button>
        <button class="btn btn-export" onclick="doExport()">ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <label class="btn btn-import">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£Ø±Ù‚Ø§Ù… (CSV)<input type="file" accept=".csv" onchange="handleCSV(this)" style="display:none"></label>
        <button class="btn btn-reset" onclick="doReset()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø´Ø§Ù…Ù„</button>
        <button class="btn btn-close" onclick="closeSettings()">Ø¥ØºÙ„Ø§Ù‚ âœ–</button>
    </div>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th width="25%">Ø§Ù„ØµÙ</th>
                <th width="40%">Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                <th width="35%">ØªÙˆØ§ØµÙ„</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="3" style="padding:40px; color:#999;">Ø§Ø¶ØºØ· âš™ï¸ Ù„Ø±ÙØ¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„</td></tr>
        </tbody>
    </table>
</div>

<script>
let phones = {};
let data = { teachers: {}, classes: {}, subjects: {}, lessons: [], periods: [] };
let isSim = false;
let sDay, sTime;

function openSettings() { document.getElementById('myModal').style.display = 'block'; }
function closeSettings() { document.getElementById('myModal').style.display = 'none'; }

window.onload = function() {
    const st = localStorage.getItem('schoolData');
    const ph = localStorage.getItem('teacherPhones');
    if (ph) phones = JSON.parse(ph);
    if (st) { data = JSON.parse(st); refresh(); setInterval(refresh, 20000); }
};

function handleXML(input) {
    const reader = new FileReader();
    reader.readAsText(input.files[0], "windows-1256");
    reader.onload = function(e) {
        const xml = new DOMParser().parseFromString(e.target.result, "text/xml");
        data.teachers = {}; data.periods = [];
        Array.from(xml.getElementsByTagName('teacher')).forEach(t => data.teachers[t.getAttribute('id')] = t.getAttribute('name'));
        Array.from(xml.getElementsByTagName('class')).forEach(c => data.classes[c.getAttribute('id')] = c.getAttribute('short'));
        Array.from(xml.getElementsByTagName('subject')).forEach(s => data.subjects[s.getAttribute('id')] = s.getAttribute('name'));
        Array.from(xml.getElementsByTagName('period')).forEach(p => data.periods.push({id: p.getAttribute('period'), s: p.getAttribute('starttime'), e: p.getAttribute('endtime')}));
        data.lessons = Array.from(xml.getElementsByTagName('TimeTableSchedule')).map(l => ({
            d: l.getAttribute('DayID'), p: l.getAttribute('Period'), c: l.getAttribute('ClassID'), t: l.getAttribute('TeacherID'), s: l.getAttribute('SubjectGradeID')
        }));
        localStorage.setItem('schoolData', JSON.stringify(data));
        closeSettings(); refresh();
    };
}

function doExport() {
    let csv = "\ufeffØ§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…,Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\n";
    for (let id in data.teachers) csv += `"${data.teachers[id]}","${phones[data.teachers[id]] || ""}"\n`;
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob); a.download = "teachers_data.csv"; a.click();
}

function handleCSV(input) {
    const reader = new FileReader();
    reader.onload = function(e) {
        e.target.result.split('\n').forEach((row, i) => {
            if (i === 0) return;
            const c = row.split(',').map(x => x.replace(/"/g, '').trim());
            if (c[0]) phones[c[0]] = c[1];
        });
        localStorage.setItem('teacherPhones', JSON.stringify(phones));
        closeSettings(); refresh();
    };
    reader.readAsText(input.files[0]);
}

function doSim() {
    isSim = true;
    sDay = Math.floor(Math.random() * 5) + 1;
    sTime = data.periods[Math.floor(Math.random() * data.periods.length)].s;
    closeSettings(); refresh();
}

function doReset() { if(confirm("Ù…Ø³Ø­ØŸ")) { localStorage.clear(); location.reload(); } }

function refresh() {
    const now = new Date();
    const days = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"];
    let d = isSim ? sDay : (now.getDay() === 0 ? 1 : now.getDay() + 1);
    let t = isSim ? sTime : now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0');
    
    document.getElementById('info').innerText = days[isSim ? (sDay==1?0:sDay-1) : now.getDay()] + " | " + t;

    const p = data.periods.find(p => { 
        const cur = toM(t), s = toM(p.s), e = toM(p.e); 
        return cur >= s && cur <= e; 
    });

    const tbody = document.getElementById('tableBody');
    if (p) {
        document.getElementById('txtPeriod').innerText = "Ø§Ù„Ø­ØµØ©: " + p.id;
        
        // Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø°ÙƒÙŠ
        const current = data.lessons.filter(l => l.d == d && l.p == p.id).sort((a, b) => {
            const nameA = data.classes[a.c] || "";
            const nameB = data.classes[b.c] || "";
            return nameA.localeCompare(nameB, 'ar', {numeric: true});
        });

        tbody.innerHTML = current.map(l => {
            let n = data.teachers[l.t];
            let ph = phones[n] || "";
            let className = data.classes[l.c];
            let msg = `Ø§Ù„Ø£Ø³ØªØ§Ø°/ ${n}\nÙ†Ø°ÙƒØ±ÙƒÙ… Ø¨Ø­ØµØªÙƒÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ©:\n- Ø§Ù„Ø­ØµØ©: ${p.id}\n- Ø§Ù„ØµÙ: ${className}\n- Ø§Ù„Ù…Ø§Ø¯Ø©: ${data.subjects[l.s]}`;
            return `<tr>
                <td><div class="class-box">${className}</div></td>
                <td class="teacher-name">${n}</td>
                <td>${ph ? `<a href="https://wa.me/${ph}?text=${encodeURIComponent(msg)}" target="_blank" class="wa-link">ÙˆØ§ØªØ³Ø§Ø¨</a>` : '---'}</td>
            </tr>`;
        }).join('');
    } else {
        document.getElementById('txtPeriod').innerText = "Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¯ÙˆØ§Ù…";
        tbody.innerHTML = "<tr><td colspan='3' style='padding:40px'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ù†Ø´Ø·Ø©</td></tr>";
    }
}

function toM(time) { const [h, m] = time.split(':'); return parseInt(h) * 60 + parseInt(m); }
</script>
</body>
</html>
