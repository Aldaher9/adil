<!DOCTYPE html>
<html lang="ar" dir="rtl" data-beasties-container>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
    <title>مدير المدرسة الذكي</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap');
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        brand: { 50:'#eff6ff', 100:'#dbeafe', 500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8', 900:'#1e3a8a' },
                        primary: { DEFAULT: '#4f46e5', 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
                        surface: { DEFAULT: '#ffffff', 50: '#f8fafc', 100: '#f1f5f9' }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(79, 70, 229, 0.3)'
                    }
                }
            }
        }
    </script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    
    <!-- Excel Export/Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            /* Default Theme: Sky Blue */
            --color-primary-50: 224 242 254; --color-primary-100: 186 230 253; --color-primary-500: 14 165 233; --color-primary-600: 0 138 230; --color-primary-700: 3 105 161; --color-primary-900: 12 74 110;
            --bg-body: #f8fafc; --text-main: #0f172a; --text-muted: #475569;
        }
        .theme-pink { --color-primary-50: 253 242 248; --color-primary-100: 252 231 243; --color-primary-500: 236 72 153; --color-primary-600: 219 39 119; --color-primary-700: 190 24 93; --color-primary-900: 131 24 67; }
        .theme-green { --color-primary-50: 240 253 244; --color-primary-100: 220 252 231; --color-primary-500: 34 197 94; --color-primary-600: 22 163 74; --color-primary-700: 21 128 61; --color-primary-900: 20 83 45; }
        .theme-indigo { --color-primary-50: 238 242 255; --color-primary-100: 224 231 255; --color-primary-500: 99 102 241; --color-primary-600: 79 70 229; --color-primary-700: 67 56 202; --color-primary-900: 49 46 129; }
        .theme-dark { --color-primary-50: 30 41 59; --color-primary-100: 51 65 85; --color-primary-500: 99 102 241; --color-primary-600: 129 140 248; --color-primary-700: 165 180 252; --color-primary-900: 49 46 129; --bg-body: #0f172a; --text-main: #f1f5f9; --text-muted: #94a3b8; }

        body { background-color: var(--bg-body); color: var(--text-main); transition: background-color 0.3s, color 0.3s; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .hidden-view { display: none !important; }
        .modal-content { z-index: 60; position: relative; }
        .modal-backdrop { z-index: 50; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }

        .print-only { display: none; }
        @media print {
            @page { margin: 0.5cm; size: auto; }
            body { background-color: #fff; }
            body * { visibility: hidden; }
            .no-print { display: none !important; }
            .print-only { display: block; }
            /* Specific print visibility logic */
            body.printing-subs #printable-substitution-sheet, body.printing-subs #printable-substitution-sheet * { visibility: visible; position: absolute; left: 0; top: 0; width: 100%; }
            body.printing-duty #printable-duty-sheet, body.printing-duty #printable-duty-sheet * { visibility: visible; position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
    
    <!-- Import Map for potential future modules -->
    <script type="importmap">
{
  "imports": {
    "rxjs": "https://esm.sh/rxjs@^7.8.2?conditions=es2015",
    "@angular/core": "https://esm.sh/@angular/core@^21.1.0?external=rxjs",
    "@angular/common": "https://esm.sh/@angular/common@^21.1.0?external=rxjs",
    "@angular/forms": "https://esm.sh/@angular/forms@^21.1.0?external=rxjs"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="antialiased selection:bg-[rgb(var(--color-primary-100))] selection:text-[rgb(var(--color-primary-900))] pb-32">

    <!-- App View (Directly Visible for simplicity based on request) -->
    <div id="app-view">
    
    <!-- Header -->
    <header class="glass-panel sticky top-0 z-40 shadow-sm no-print transition-all duration-300">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 text-slate-800 select-none">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center shadow-sm overflow-hidden bg-white">
                            <img src="/favicon_180x180.png" class="w-full h-full object-cover" alt="Logo">
                        </div>
                        <h1 class="font-extrabold text-lg hidden md:block tracking-tight text-slate-900">مدير المدرسة</h1>
                    </div>
                </div>

                <div class="flex gap-3 items-center">
                    <button onclick="window.app.setView('teachers')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl font-bold text-xs shadow-sm transition"><i class="fas fa-users"></i> المعلمين</button>
                    <button onclick="window.app.openSettings()" class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-800 text-white hover:bg-slate-700 transition shadow-lg cursor-pointer"><i class="fas fa-cog"></i></button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-6 space-y-8 max-w-7xl">
        
        <!-- View: Teachers (Primary View requested) -->
        <section id="view-teachers" class="fade-in space-y-6">
            <div class="sticky top-24 z-30 bg-white/95 backdrop-blur-md p-4 rounded-2xl shadow-sm border border-slate-200 mb-6 flex flex-col md:flex-row gap-4 justify-between items-center">
                <div class="flex items-center gap-3">
                    <h2 class="text-xl font-extrabold text-slate-900">سجل المعلمين</h2>
                    <span class="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded-md border border-slate-200" id="teachersCountBadge">0</span>
                </div>
                <div class="relative w-full md:w-80 group">
                    <input type="text" id="teacherSearch" onkeyup="window.app.renderTeachers()" placeholder="بحث عن معلم..." class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all outline-none text-sm font-bold text-slate-800 placeholder:text-slate-400">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                </div>
            </div>
            
            <div id="teachersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 pb-20">
                <!-- Teachers injected here -->
            </div>
        </section>

        <!-- Other views hidden by default for this simplified request, but structure remains for compatibility -->
        <section id="view-now" class="hidden-view"></section>
        <section id="view-reports" class="hidden-view"></section>
        <!-- ... other sections ... -->

    </main>

    <!-- Action Modal (With Tabs & History) -->
    <div id="modal-action" class="fixed inset-0 z-50 flex items-end md:items-center justify-center p-0 md:p-4 hidden-view">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm modal-backdrop" onclick="window.app.closeModal('modal-action')"></div>
        <div class="bg-white w-full md:max-w-lg rounded-t-3xl md:rounded-3xl shadow-2xl overflow-hidden animate-scale-in modal-content mb-0 md:mb-20 flex flex-col max-h-[90vh]">
            
            <!-- Header -->
            <div class="bg-slate-800 p-5 text-white flex justify-between items-start shrink-0">
                <div>
                    <h3 class="text-xl font-bold flex items-center gap-2" id="actionModalTitle"></h3>
                    <p id="actionModalSubtitle" class="text-slate-300 text-xs mt-1 flex items-center gap-1 font-medium"></p>
                </div>
                <button type="button" onclick="window.app.closeModal('modal-action')" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white transition"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- Tabs Navigation -->
            <div class="flex border-b border-slate-100 shrink-0 bg-slate-50">
                <button onclick="window.app.switchActionTab('negative')" id="tab-negative" class="flex-1 py-3 font-bold text-sm transition flex items-center justify-center gap-2 text-slate-500 hover:bg-white border-b-2 border-transparent">
                    <i class="fas fa-exclamation-circle text-red-500"></i> المخالفات
                </button>
                <button onclick="window.app.switchActionTab('positive')" id="tab-positive" class="flex-1 py-3 font-bold text-sm transition flex items-center justify-center gap-2 text-slate-500 hover:bg-white border-b-2 border-transparent">
                    <i class="fas fa-star text-emerald-500"></i> التميز
                </button>
                <button onclick="window.app.switchActionTab('history')" id="tab-history" class="flex-1 py-3 font-bold text-sm transition flex items-center justify-center gap-2 text-slate-500 hover:bg-white border-b-2 border-transparent">
                    <i class="fas fa-history text-indigo-500"></i> السجل
                </button>
            </div>

            <!-- Dynamic Content Area -->
            <div id="actionModalContent" class="p-5 overflow-y-auto custom-scrollbar flex-1 bg-white">
                <!-- Content injected by JS -->
            </div>

             <div class="bg-slate-50 p-4 border-t border-slate-200 shrink-0 flex justify-between items-center px-6">
                 <span class="text-xs font-bold text-slate-500">نقاط الأداء الحالية</span>
                 <span class="text-2xl font-black text-slate-800" id="currentScoreDisplay">100%</span>
             </div>
        </div>
    </div>

    <!-- Settings Modal (Simplified for Import/Export) -->
    <div id="modal-settings" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden-view">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm modal-backdrop" onclick="window.app.closeModal('modal-settings')"></div>
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-scale-in flex flex-col max-h-[85vh] modal-content">
            <div class="bg-slate-800 text-white p-5 flex justify-between items-center shrink-0">
                <h3 class="text-lg font-bold"><i class="fas fa-cog"></i> الإعدادات</h3>
                <button type="button" onclick="window.app.closeModal('modal-settings')" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-6">
                <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                    <h5 class="font-bold text-emerald-900 mb-2 flex items-center gap-2 text-sm"><i class="fas fa-users"></i> بيانات المعلمين (Excel)</h5>
                    <button type="button" onclick="document.getElementById('excelInput').click()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg font-bold text-xs transition shadow-sm"><i class="fas fa-upload mr-1"></i> استيراد ملف Excel</button>
                    <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden" onchange="window.app.handleExcel(event)">
                </div>
                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                    <h5 class="font-bold text-indigo-900 mb-2 flex items-center gap-2 text-sm"><i class="fas fa-calendar-alt"></i> الجدول المدرسي (XML)</h5>
                    <button type="button" onclick="document.getElementById('xmlInput').click()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-bold text-xs transition shadow-sm">استيراد aSc Timetables</button>
                    <input type="file" id="xmlInput" accept=".xml" class="hidden" onchange="window.app.handleXml(event)">
                </div>
                <button onclick="window.app.deleteData()" class="w-full bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 py-3 rounded-xl font-bold text-xs transition flex items-center justify-center gap-2">
                    <i class="fas fa-trash-alt"></i> حذف جميع البيانات
                </button>
            </div>
        </div>
    </div>

    </div> <!-- End App View -->

    <!-- Script Implementation -->
    <script>
        class SchoolApp {
            constructor() {
                this.state = {
                    teachers: [], 
                    violationTypes: [{ id: 'late', label: 'تأخر عن الحصة', points: 5, icon: 'fa-clock' }, { id: 'absent', label: 'غياب عن الحصة', points: 15, icon: 'fa-user-slash' }],
                    rewardTypes: [
                        { id: 'initiative', label: 'معلم مبادر', points: 5, icon: 'fa-hand-sparkles' },
                        { id: 'distinguished', label: 'أداء مميز', points: 5, icon: 'fa-star' },
                        { id: 'dedication', label: 'تفاني بالعمل', points: 3, icon: 'fa-heart' },
                        { id: 'creative', label: 'وسائل تعليمية مميزة', points: 4, icon: 'fa-lightbulb' },
                        { id: 'coop', label: 'تعاون مع الإدارة', points: 2, icon: 'fa-users' }
                    ],
                    activeActionTab: 'negative',
                    selectedTeacherId: null
                };
                this.loadLocalData();
            }

            loadLocalData() {
                const stored = localStorage.getItem('school_data_v1');
                if (stored) {
                    try {
                        const data = JSON.parse(stored);
                        if (data.teachers) this.state.teachers = data.teachers;
                        if (data.violationTypes) this.state.violationTypes = data.violationTypes;
                        if (data.rewardTypes) this.state.rewardTypes = data.rewardTypes;
                        this.renderTeachers();
                    } catch(e) { console.error('Local Load Error', e); }
                } else {
                    this.renderTeachers();
                }
            }

            saveData() {
                localStorage.setItem('school_data_v1', JSON.stringify({ 
                    teachers: this.state.teachers, 
                    violationTypes: this.state.violationTypes,
                    rewardTypes: this.state.rewardTypes
                }));
            }

            setView(v) {
                // Simplified navigation for this request
                if(v === 'teachers') {
                    document.getElementById('view-teachers').classList.remove('hidden-view');
                    this.renderTeachers();
                }
            }

            renderTeachers() {
                const grid = document.getElementById('teachersGrid');
                if (!grid) return;
                
                const term = (document.getElementById('teacherSearch')?.value || '').toLowerCase();
                const teachers = this.state.teachers || [];
                const filtered = teachers.filter(t => t && (t.name || '').toLowerCase().includes(term));
                
                document.getElementById('teachersCountBadge').innerText = filtered.length;
                
                if (filtered.length === 0) {
                    grid.innerHTML = `<div class="col-span-full py-12 text-center text-slate-400 bg-white rounded-2xl border border-slate-100"><i class="fas fa-search text-3xl mb-3 opacity-50"></i><p>لا توجد بيانات معلمين. قم بالاستيراد من الإعدادات.</p></div>`;
                    return;
                }
                
                grid.innerHTML = filtered.map(t => {
                    const name = t.name || 'بدون اسم';
                    const score = t.score !== undefined ? t.score : 100;
                    let scoreColor = 'text-emerald-600 bg-emerald-50 border-emerald-100';
                    if(score < 90) scoreColor = 'text-amber-600 bg-amber-50 border-amber-100';
                    if(score < 70) scoreColor = 'text-red-600 bg-red-50 border-red-100';
                    
                    return `
                    <div class="bg-white rounded-2xl shadow-sm hover:shadow-md transition border border-slate-200 p-5 flex flex-col gap-4 group">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-2xl bg-slate-100 text-slate-600 flex items-center justify-center font-bold text-lg shadow-inner">
                                    ${name.substring(0,2)}
                                </div>
                                <div>
                                    <h3 class="font-bold text-slate-900 text-sm">${name}</h3>
                                    <p class="text-xs text-slate-500 font-medium">${t.specialization || 'عام'}</p>
                                </div>
                            </div>
                            <div class="${scoreColor} px-2 py-1 rounded-lg border text-xs font-bold shadow-sm">${score}%</div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-auto pt-2 border-t border-slate-50">
                            <button onclick="window.app.openActionModal('${t.id}')" class="bg-slate-50 hover:bg-slate-100 text-slate-700 border border-slate-200 py-2 rounded-xl text-xs font-bold transition flex items-center justify-center gap-2">
                                <i class="fas fa-sliders-h"></i> السجل
                            </button>
                            <button onclick="window.app.openWhatsApp('${t.id}')" class="bg-emerald-50 hover:bg-emerald-100 text-emerald-700 border border-emerald-200 py-2 rounded-xl text-xs font-bold transition flex items-center justify-center gap-2">
                                <i class="fab fa-whatsapp text-lg"></i> تواصل
                            </button>
                        </div>
                    </div>`;
                }).join('');
            }

            openActionModal(tId) {
                this.state.selectedTeacherId = tId;
                this.state.activeActionTab = 'negative';
                const t = this.state.teachers.find(x => x.id === tId);
                if(!t) return;
                
                document.getElementById('actionModalTitle').innerText = t.name;
                document.getElementById('actionModalSubtitle').innerText = t.specialization || 'عام';
                document.getElementById('currentScoreDisplay').innerText = (t.score !== undefined ? t.score : 100) + '%';
                
                this.renderActionModalContent();
                document.getElementById('modal-action').classList.remove('hidden-view');
            }

            switchActionTab(tab) {
                this.state.activeActionTab = tab;
                this.renderActionModalContent();
            }

            renderActionModalContent() {
                const tab = this.state.activeActionTab;
                const container = document.getElementById('actionModalContent');
                const tId = this.state.selectedTeacherId;
                const t = this.state.teachers.find(x => x.id === tId);
                if (!t || !container) return;

                // Update UI state for tabs
                ['negative', 'positive', 'history'].forEach(tx => {
                    const btn = document.getElementById(`tab-${tx}`);
                    if(btn) {
                        if(tx === tab) {
                            btn.className = 'flex-1 py-3 font-bold text-sm transition flex items-center justify-center gap-2 border-b-2 bg-white ' + 
                                            (tx==='negative'?'text-red-600 border-red-500':(tx==='positive'?'text-emerald-600 border-emerald-500':'text-indigo-600 border-indigo-500'));
                        } else {
                            btn.className = 'flex-1 py-3 font-bold text-sm transition flex items-center justify-center gap-2 text-slate-400 hover:bg-white border-b-2 border-transparent';
                        }
                    }
                });

                if (tab === 'negative') {
                    let html = `<div class="space-y-2 animate-fade-in"><label class="text-[10px] font-extrabold text-slate-400 uppercase tracking-wider px-1">تسجيل تقصير / مخالفة</label>`;
                    html += (this.state.violationTypes || []).map(v => `
                        <button onclick="window.app.logActivity('${tId}', '${v.id}', 'negative')" class="w-full bg-white hover:bg-red-50 text-slate-700 hover:text-red-700 border border-slate-200 hover:border-red-200 p-3 rounded-xl flex items-center justify-between transition group shadow-sm">
                            <span class="flex items-center gap-3 font-bold text-xs"><i class="fas ${v.icon} text-slate-400 group-hover:text-red-500"></i> ${v.label}</span>
                            <span class="bg-red-50 px-2 py-1 rounded-lg text-xs font-bold text-red-600 border border-red-100">-${v.points}</span>
                        </button>`).join('');
                    html += `</div>`;
                    container.innerHTML = html;
                } else if (tab === 'positive') {
                    let html = `<div class="space-y-2 animate-fade-in"><label class="text-[10px] font-extrabold text-slate-400 uppercase tracking-wider px-1">نقاط التميز</label>`;
                    html += (this.state.rewardTypes || []).map(r => `
                        <button onclick="window.app.logActivity('${tId}', '${r.id}', 'positive')" class="w-full bg-white hover:bg-emerald-50 text-slate-700 hover:text-emerald-700 border border-slate-200 hover:border-emerald-200 p-3 rounded-xl flex items-center justify-between transition group shadow-sm">
                            <span class="flex items-center gap-3 font-bold text-xs"><i class="fas ${r.icon} text-slate-400 group-hover:text-emerald-500"></i> ${r.label}</span>
                            <span class="bg-emerald-50 px-2 py-1 rounded-lg text-xs font-bold text-emerald-600 border border-emerald-100">+${r.points}</span>
                        </button>`).join('');
                    html += `</div>`;
                    container.innerHTML = html;
                } else if (tab === 'history') {
                    const logs = t.violations || [];
                    let html = `<div class="space-y-3 animate-fade-in"><div class="flex justify-between items-center"><h4 class="font-bold text-slate-800 text-sm">سجل النشاط التفصيلي</h4><button onclick="window.app.exportTeacherLog('${tId}')" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-lg font-bold transition"><i class="fas fa-file-export"></i> تصدير</button></div>`;
                    
                    if (logs.length > 0) {
                        html += logs.map(l => {
                            const isPos = l.type === 'positive';
                            return `
                            <div class="flex items-center justify-between p-3 rounded-xl border shadow-sm bg-white ${isPos ? 'border-emerald-100' : 'border-red-100'}">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${isPos ? 'bg-emerald-50 text-emerald-600' : 'bg-red-50 text-red-600'}"><i class="fas ${isPos ? 'fa-check' : 'fa-exclamation'}"></i></div>
                                    <div><div class="text-xs font-bold text-slate-800">${l.label}</div><div class="text-[10px] text-slate-400 font-mono">${l.date}</div></div>
                                </div>
                                <span class="text-xs font-bold px-2 py-1 rounded-lg ${isPos ? 'text-emerald-600 bg-emerald-50' : 'text-red-600 bg-red-50'}">${isPos ? '+' : '-'}${l.points}</span>
                            </div>`;
                        }).join('');
                    } else {
                        html += `<div class="text-center py-8 text-slate-400 text-xs">لا يوجد نشاط مسجل.</div>`;
                    }
                    html += `</div>`;
                    container.innerHTML = html;
                }
            }

            logActivity(tId, itemId, type) {
                const t = this.state.teachers.find(x => x.id === tId);
                let item = (type === 'negative') ? this.state.violationTypes.find(x => x.id === itemId) : this.state.rewardTypes.find(x => x.id === itemId);
                if(!t || !item) return;

                if(confirm(type === 'negative' ? `خصم ${item.points} نقاط؟` : `إضافة ${item.points} نقاط؟`)) {
                    if(t.score === undefined) t.score = 100;
                    t.score = type === 'negative' ? Math.max(0, t.score - item.points) : Math.min(100, t.score + item.points);
                    
                    if (!t.violations) t.violations = [];
                    t.violations.unshift({ date: new Date().toLocaleDateString('en-CA'), label: item.label, points: item.points, type: type });

                    this.saveData();
                    this.renderTeachers(); 
                    document.getElementById('currentScoreDisplay').innerText = t.score + '%';
                    this.switchActionTab('history');
                }
            }

            exportTeacherLog(tId) {
                const t = this.state.teachers.find(x => x.id === tId);
                if(!t || !t.violations || t.violations.length === 0) return alert('لا يوجد سجل.');
                
                const data = t.violations.map(v => ({
                    "التاريخ": v.date, "النوع": v.type === 'positive' ? 'إيجابي' : 'سلبي', "الوصف": v.label, "النقاط": (v.type === 'positive' ? '+' : '-') + v.points
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Log");
                XLSX.writeFile(wb, `${t.name}_Report.xlsx`);
            }

            handleExcel(e) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    // Simple mapper: assuming headers "Name", "ID", "Phone" etc or just mapping nicely
                    // Fallback to simpler structure if needed. For now, assume user knows format or uses template.
                    // Minimal logic to just get names:
                    this.state.teachers = json.map((row, idx) => ({
                        id: String(Date.now() + idx),
                        name: row['Name'] || row['الاسم'] || row['name'] || 'Unknown',
                        phone: row['Phone'] || row['الهاتف'] || '',
                        score: 100,
                        lessons: [],
                        violations: []
                    }));
                    this.saveData();
                    this.renderTeachers();
                    this.closeModal('modal-settings');
                    alert(`تم استيراد ${this.state.teachers.length} معلم.`);
                };
                reader.readAsArrayBuffer(e.target.files[0]);
            }
            
            handleXml(e) {
                // Placeholder for XML logic (aSc Timetables) if needed again
                alert('ميزة استيراد الجدول XML متاحة في النسخة الكاملة.');
            }

            deleteData() {
                if(confirm('حذف جميع البيانات؟')) { localStorage.removeItem('school_data_v1'); location.reload(); }
            }

            closeModal(id) { document.getElementById(id).classList.add('hidden-view'); }
            openSettings() { document.getElementById('modal-settings').classList.remove('hidden-view'); }
            openWhatsApp(tId) { 
                const t = this.state.teachers.find(x => x.id === tId);
                if(t && t.phone) window.open(`https://wa.me/${t.phone}`, '_blank');
                else alert('لا يوجد رقم هاتف');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
             window.app = new SchoolApp();
        });
    </script>
</body>
</html>