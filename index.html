<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø·ÙˆØ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #1e3a5f; --accent: #e67e22; --success: #25d366; --bg: #f4f7f6;
            --class-gradient: linear-gradient(135deg, #2c3e50 0%, #1e3a5f 100%);
        }
        * { font-family: 'Tajawal', sans-serif !important; box-sizing: border-box; }
        body { background: var(--bg); margin: 0; padding: 10px; color: #333; }
        
        .header { 
            background: var(--primary); color: white; padding: 15px; 
            border-radius: 12px; display: flex; justify-content: space-between; 
            align-items: center; margin-bottom: 10px;
        }

        .action-bar { display: flex; gap: 10px; margin-bottom: 10px; }
        .edit-toggle { 
            flex: 1; background: white; border: 2px solid var(--primary); color: var(--primary);
            padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer;
        }
        .edit-active { background: var(--primary); color: white; }

        .settings-btn { 
            background: var(--accent); border: none; color: white; width: 45px; height: 45px; 
            border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        #myModal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: white; margin: 15% auto; padding: 20px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; }

        .status-bar { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-right: 6px solid var(--accent); }
        .table-container { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 12px; font-size: 13px; border-bottom: 2px solid #eee; }
        td { padding: 12px 8px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; }

        .class-box {
            background: var(--class-gradient); color: white; padding: 8px 4px; border-radius: 8px;
            font-weight: 700; font-size: 0.95rem; display: inline-block; min-width: 55px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
        }

        .wa-link { background: var(--success); color: white; text-decoration: none; padding: 8px 12px; border-radius: 6px; font-size: 13px; font-weight: bold; }
        
        /* ØªØµÙ…ÙŠÙ… Ø­Ù‚Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
        .phone-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; text-align: center; font-size: 14px; }
        .save-btn { background: var(--primary); color: white; border: none; padding: 5px 10px; border-radius: 5px; margin-top: 5px; cursor: pointer; width: 100%; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0; font-size: 18px;">ğŸ“ Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯</h2>
    <button class="settings-btn" onclick="openSettings()">âš™ï¸</button>
</div>

<div class="action-bar">
    <button id="toggleEditBtn" class="edit-toggle" onclick="toggleEditMode()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</button>
</div>

<div class="status-bar">
    <div id="info">--</div>
    <div id="txtPeriod" style="font-weight: bold; color: var(--accent);">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„..</div>
</div>

<div id="myModal">
    <div class="modal-content">
        <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
        <input type="file" id="xmlFile" accept=".xml" onchange="handleXML(this)" style="width:100%; margin-bottom:10px;">
        <button style="width:100%; padding:10px; margin-bottom:5px;" onclick="doSim()">ğŸ² Ù…Ø­Ø§ÙƒØ§Ø©</button>
        <button style="width:100%; padding:10px; margin-bottom:5px;" onclick="doExport()">ğŸ“Š ØªØµØ¯ÙŠØ± CSV</button>
        <button style="width:100%; padding:10px; color:red;" onclick="doReset()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        <button style="width:100%; padding:10px; margin-top:15px;" onclick="closeSettings()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th width="20%">Ø§Ù„ØµÙ</th>
                <th width="45%">Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                <th width="35%">ØªÙˆØ§ØµÙ„ / ØªØ¹Ø¯ÙŠÙ„</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
let phones = {};
let data = { teachers: {}, classes: {}, subjects: {}, lessons: [], periods: [] };
let isSim = false, sDay, sTime, isEditMode = false;

function openSettings() { document.getElementById('myModal').style.display = 'block'; }
function closeSettings() { document.getElementById('myModal').style.display = 'none'; }

function toggleEditMode() {
    isEditMode = !isEditMode;
    const btn = document.getElementById('toggleEditBtn');
    btn.classList.toggle('edit-active');
    btn.innerText = isEditMode ? "âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„" : "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†";
    refresh();
}

window.onload = function() {
    const st = localStorage.getItem('schoolData'), ph = localStorage.getItem('teacherPhones');
    if (ph) phones = JSON.parse(ph);
    if (st) { data = JSON.parse(st); refresh(); setInterval(refresh, 30000); }
};

function handleXML(input) {
    const reader = new FileReader();
    reader.readAsText(input.files[0], "windows-1256");
    reader.onload = function(e) {
        const xml = new DOMParser().parseFromString(e.target.result, "text/xml");
        data.teachers = {}; data.periods = [];
        Array.from(xml.getElementsByTagName('teacher')).forEach(t => data.teachers[t.getAttribute('id')] = t.getAttribute('name'));
        Array.from(xml.getElementsByTagName('class')).forEach(c => data.classes[c.getAttribute('id')] = c.getAttribute('short'));
        Array.from(xml.getElementsByTagName('subject')).forEach(s => data.subjects[s.getAttribute('id')] = s.getAttribute('name'));
        Array.from(xml.getElementsByTagName('period')).forEach(p => data.periods.push({id: p.getAttribute('period'), s: p.getAttribute('starttime'), e: p.getAttribute('endtime')}));
        data.lessons = Array.from(xml.getElementsByTagName('TimeTableSchedule')).map(l => ({
            d: l.getAttribute('DayID'), p: l.getAttribute('Period'), c: l.getAttribute('ClassID'), t: l.getAttribute('TeacherID'), s: l.getAttribute('SubjectGradeID')
        }));
        localStorage.setItem('schoolData', JSON.stringify(data));
        closeSettings(); refresh();
    };
}

function savePhone(teacherName, inputId) {
    const newPhone = document.getElementById(inputId).value.trim();
    phones[teacherName] = newPhone;
    localStorage.setItem('teacherPhones', JSON.stringify(phones));
    alert("ØªÙ… Ø­ÙØ¸ Ø±Ù‚Ù… " + teacherName);
}

function refresh() {
    const now = new Date(), days = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"];
    let d = isSim ? sDay : (now.getDay() === 0 ? 1 : now.getDay() + 1);
    let t = isSim ? sTime : now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0');
    document.getElementById('info').innerText = days[isSim ? (sDay==1?0:sDay-1) : now.getDay()] + " | " + t;

    const p = data.periods.find(p => { 
        const cur = toM(t), s = toM(p.s), e = toM(p.e); 
        return cur >= s && cur <= e; 
    });

    const tbody = document.getElementById('tableBody');
    if (p) {
        document.getElementById('txtPeriod').innerText = "Ø§Ù„Ø­ØµØ©: " + p.id;
        const current = data.lessons.filter(l => l.d == d && l.p == p.id).sort((a, b) => (data.classes[a.c] || "").localeCompare(data.classes[b.c] || "", 'ar', {numeric: true}));
        
        tbody.innerHTML = current.map((l, idx) => {
            let n = data.teachers[l.t], ph = phones[n] || "";
            let msg = `Ø§Ù„Ø£Ø³ØªØ§Ø°/ ${n}\nÙ†Ø°ÙƒØ±ÙƒÙ… Ø¨Ø­ØµØªÙƒÙ…:\nØ§Ù„ØµÙ: ${data.classes[l.c]}\nØ§Ù„Ø­ØµØ©: ${p.id}`;
            
            let actionCell = isEditMode ? 
                `<input type="tel" id="inp${idx}" class="phone-input" value="${ph}" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù…">
                 <button class="save-btn" onclick="savePhone('${n}', 'inp${idx}')">Ø­ÙØ¸</button>` :
                (ph ? `<a href="https://wa.me/${ph}?text=${encodeURIComponent(msg)}" target="_blank" class="wa-link">ÙˆØ§ØªØ³Ø§Ø¨</a>` : '---');

            return `<tr>
                <td><div class="class-box">${data.classes[l.c]}</div></td>
                <td style="font-weight:bold; font-size:14px;">${n}</td>
                <td>${actionCell}</td>
            </tr>`;
        }).join('');
    } else {
        document.getElementById('txtPeriod').innerText = "Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¯ÙˆØ§Ù…";
        tbody.innerHTML = "<tr><td colspan='3' style='padding:40px'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>";
    }
}

function toM(time) { const [h, m] = time.split(':'); return parseInt(h) * 60 + parseInt(m); }
function doSim() { isSim = true; sDay = Math.floor(Math.random() * 5) + 1; sTime = data.periods[0].s; closeSettings(); refresh(); }
function doReset() { if(confirm("Ø­Ø°Ù Ø§Ù„ÙƒÙ„ØŸ")) { localStorage.clear(); location.reload(); } }
function doExport() {
    let csv = "\ufeffØ§Ù„Ù…Ø¹Ù„Ù…,Ø§Ù„Ù‡Ø§ØªÙ\n";
    for(let id in data.teachers) csv += `"${data.teachers[id]}","${phones[data.teachers[id]]||""}"\n`;
    const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "phones.csv"; a.click();
}
</script>
</body>
</html>
