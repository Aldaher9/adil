<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مدير المدرسة الذكي</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        // Omani/Gulf Palette
                        omani: {
                            green: '#006442', // Omani Flag Green
                            red: '#DA291C',   // Omani Flag Red
                            gold: '#C4A76A',  // Sand/Gold
                            silver: '#E6E7E8',
                            dark: '#1F2937'
                        },
                        brand: { 50:'#f0fdf4', 100:'#dcfce7', 500:'#006442', 600:'#166534', 700:'#15803d', 900:'#064e3b' }
                    },
                    backgroundImage: {
                        'islamic-pattern': "url('data:image/svg+xml,%3Csvg width=\\'60\\' height=\\'60\\' viewBox=\\'0 0 60 60\\' xmlns=\\'http://www.w3.org/2000/svg\\' %3E%3Cg fill=\\'none\\' fill-rule=\\'evenodd\\' %3E%3Cg fill=\\'%23c4a76a\\' fill-opacity=\\'0.08\\' %3E%3Cpath d=\\'M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\\' /%3E%3C/g%3E%3C/g%3E%3C/svg%3E')"
                    }
                }
            }
        }
    </script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Excel Export/Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            /* Theme Variables synced with new palette */
            --color-primary-50: 240 253 244; 
            --color-primary-100: 220 252 231; 
            --color-primary-200: 187 247 208; 
            --color-primary-500: 0 100 66; /* Omani Green */
            --color-primary-600: 22 163 74; 
            --color-primary-700: 21 128 61; 
            --color-primary-900: 6 78 59;
            
            --color-gold: 196 167 106;
            --color-red: 218 41 28;

            --color-bg-base: 250 250 249; /* Warm off-white */
            --color-text-base: 30 41 59; 
            --color-text-muted: 100 116 139; 
            --color-surface-base: 255 255 255; 
            --color-border-base: 231 229 228; 
            --color-border-muted: 214 211 209;
        }

        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #C4A76A; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a38b55; }

        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .hidden-view { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .modal-content { z-index: 60; position: relative; backdrop-filter: blur(0); }
        .modal-backdrop { z-index: 50; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Omani Identity Specifics */
        .omani-card {
            background: white;
            border: 1px solid rgba(196, 167, 106, 0.2); /* Subtle Gold Border */
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
            border-radius: 1rem;
        }
        
        .omani-gradient {
            background: linear-gradient(135deg, #006442 0%, #004d32 100%);
        }
        
        .gold-text { color: #C4A76A; }
        
        .glass-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(196, 167, 106, 0.15);
        }

        /* Logic Helpers */
        .sup-radio:checked + div { background-color: rgb(var(--color-primary-50)); border-color: rgb(var(--color-primary-500)); box-shadow: 0 0 0 1px rgb(var(--color-primary-500)); }
        .sup-radio:checked + div .check-icon { display: block; }
        .print-only { display: none; }
        
        @media print {
            body { background: white; }
            body * { visibility: hidden; }
            #view-supervision-report, #view-supervision-report * { visibility: visible; }
            #view-supervision-report { position: absolute; left: 0; top: 0; width: 100%; display: block !important; padding: 0; margin: 0; box-shadow: none; border: none; }
            .no-print { display: none !important; }
            .print-only { display: block; }
        }
        
        .task-checkbox:checked + div { text-decoration: line-through; color: rgb(var(--color-text-muted)); opacity: 0.7; }
        .today-row { background-color: #fefce8 !important; border-right: 4px solid #C4A76A !important; }
        
        /* Duty Table */
        .duty-table th, .duty-table td { white-space: nowrap; min-width: 140px; }
        .duty-cell:hover .duty-actions { opacity: 1; }
        .duty-actions { opacity: 0; transition: opacity 0.2s; }
        @media (max-width: 768px) { .duty-actions { opacity: 1; } }
    </style>
<script type="importmap">
{
  "imports": {
    "rxjs": "https://esm.sh/rxjs@^7.8.2?conditions=es2015",
    "rxjs/operators": "https://esm.sh/rxjs@^7.8.2/operators?conditions=es2015",
    "rxjs/ajax": "https://esm.sh/rxjs@^7.8.2/ajax?conditions=es2015",
    "rxjs/webSocket": "https://esm.sh/rxjs@^7.8.2/webSocket?conditions=es2015",
    "rxjs/testing": "https://esm.sh/rxjs@^7.8.2/testing?conditions=es2015",
    "rxjs/fetch": "https://esm.sh/rxjs@^7.8.2/fetch?conditions=es2015",
    "@angular/core": "https://esm.sh/@angular/core@^21.0.8?external=rxjs",
    "@angular/common": "https://esm.sh/@angular/common@^21.0.8?external=rxjs",
    "@angular/forms": "https://esm.sh/@angular/forms@^21.0.8?external=rxjs"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-stone-50 bg-islamic-pattern text-slate-800 antialiased selection:bg-omani-gold selection:text-white pb-28 min-h-screen">

    <!-- Login View -->
    <div id="login-view" class="min-h-screen flex flex-col items-center justify-center p-6 relative overflow-hidden">
        <!-- Abstract Omani Background Elements -->
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-omani-red via-white to-omani-green z-20"></div>
        <div class="absolute -top-24 -right-24 w-64 h-64 bg-omani-gold/10 rounded-full blur-3xl"></div>
        <div class="absolute bottom-0 left-0 w-full h-1/2 bg-gradient-to-t from-white to-transparent z-0"></div>

        <div class="w-full max-w-sm text-center relative z-10 bg-white/80 backdrop-blur-xl p-8 rounded-3xl border border-white/50 shadow-2xl">
            <div class="w-20 h-20 mx-auto bg-omani-green rounded-2xl flex items-center justify-center text-4xl text-white shadow-lg shadow-omani-green/30 mb-6 rotate-3">
                <i class="fas fa-school-flag"></i>
            </div>
            <h1 class="text-3xl font-extrabold text-slate-800 mb-2">مدير المدرسة <span class="text-omani-gold">الذكي</span></h1>
            <p class="text-slate-500 mb-8 font-medium">منصة القيادة والإشراف التربوي المتكاملة</p>
            
            <button onclick="window.app.handleGoogleLogin()" class="w-full bg-white hover:bg-slate-50 text-slate-700 font-bold py-4 px-6 rounded-2xl shadow-lg border border-slate-100 flex items-center justify-center gap-4 transition transform hover:-translate-y-1 cursor-pointer group">
                <img src="https://www.google.com/favicon.ico" class="w-5 h-5 group-hover:scale-110 transition" alt="Google">
                <span>تسجيل الدخول باستخدام جوجل</span>
            </button>
            <button onclick="window.app.skipLogin()" class="w-full mt-4 text-slate-400 hover:text-omani-green font-bold text-sm transition cursor-pointer flex items-center justify-center gap-2">
                <span>الدخول كزائر (نسخة تجريبية)</span>
                <i class="fas fa-arrow-left text-xs"></i>
            </button>
        </div>
        <div class="absolute bottom-6 text-slate-400 text-xs font-mono">School Manager Pro v2.5</div>
    </div>
    
    <!-- App View -->
    <div id="app-view" class="hidden-view">
    <!-- Header -->
    <header class="omani-gradient text-white shadow-lg sticky top-0 z-40 no-print border-b border-white/10 backdrop-blur-md bg-opacity-95">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
             <div id="user-profile-container" class="flex items-center gap-3"></div>
            <div class="flex gap-2 items-center">
                <div class="bg-black/20 px-3 py-1.5 rounded-xl border border-white/10 backdrop-blur-sm flex items-center gap-2 shadow-inner">
                    <i class="fas fa-clock text-omani-gold text-xs"></i>
                    <span id="clockDisplay" class="font-mono font-bold text-white dir-ltr text-sm tracking-wider">00:00:00</span>
                </div>
                <div id="cloudStatusIndicator" class="text-[9px] bg-white/10 px-2 py-1 rounded-lg text-slate-100 border border-white/5"></div>
                <button onclick="window.app.simulateRandomPeriod()" class="text-xs bg-white/10 hover:bg-white/20 w-8 h-8 flex items-center justify-center rounded-lg transition text-omani-gold hover:text-white cursor-pointer border border-white/5" title="محاكاة حصة"><i class="fas fa-wand-magic-sparkles"></i></button>
                <button onclick="window.app.resetTimeToReal()" class="text-xs bg-white/10 hover:bg-white/20 w-8 h-8 flex items-center justify-center rounded-lg transition text-omani-gold hover:text-white cursor-pointer border border-white/5" title="الوقت الفعلي"><i class="fas fa-clock-rotate-left"></i></button>
                 <button onclick="window.app.openSettings()" class="text-xs bg-white/10 hover:bg-white/20 w-8 h-8 flex items-center justify-center rounded-lg transition text-white cursor-pointer border border-white/5" title="الإعدادات"><i class="fas fa-cog"></i></button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-6 space-y-8">
        
        <!-- View: Current Classes -->
        <section id="view-now" class="fade-in space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 omani-card p-5 relative overflow-hidden">
                <div class="absolute right-0 top-0 w-2 h-full bg-omani-green"></div>
                <div class="flex items-center gap-4 z-10">
                    <div class="bg-stone-50 text-omani-green w-12 h-12 rounded-2xl flex items-center justify-center text-xl shadow-sm border border-stone-100"><i class="fas fa-chalkboard-user"></i></div>
                    <div><h2 class="text-xl font-bold text-slate-800">الحصص القائمة الآن</h2><p class="text-xs text-slate-500">متابعة مباشرة للجدول الدراسي</p></div>
                </div>
                <div id="currentPeriodInfo" class="z-10 w-full md:w-auto"></div>
            </div>
            <div id="activeClassesGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
            
            <!-- Daily Duty Widget -->
            <div id="dailyDutyWidget" class="mt-8 pt-6 border-t border-dashed border-stone-300 hidden-view">
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span class="w-8 h-8 rounded-lg bg-omani-gold/10 flex items-center justify-center text-omani-gold"><i class="fas fa-user-shield"></i></span>
                    مناوبة اليوم
                    <span id="dailyDutyDate" class="text-xs text-slate-400 font-normal mr-2 bg-white px-2 py-1 rounded border border-stone-200"></span>
                </h3>
                <div id="dailyDutyGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
            </div>
        </section>

        <!-- View: Teachers -->
        <section id="view-teachers" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col md:flex-row justify-between gap-4 omani-card p-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">سجل المعلمين</h2>
                    <p class="text-slate-500 text-sm mt-1">قاعدة بيانات الكادر التدريسي</p>
                </div>
                <div class="relative w-full md:w-96 group">
                    <input type="text" id="teacherSearch" onkeyup="window.app.renderTeachers()" placeholder="بحث بالاسم..." class="w-full pl-4 pr-10 py-3 rounded-xl border border-stone-200 outline-none bg-stone-50 focus:bg-white focus:border-omani-green focus:ring-1 focus:ring-omani-green transition-all">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-omani-green transition"></i>
                </div>
            </div>
            <div id="teachersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
        </section>

        <!-- View: Duty Schedule -->
        <section id="view-duty" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col md:flex-row justify-between gap-4 omani-card p-6">
                <div class="flex items-center gap-3">
                    <div class="bg-amber-50 text-amber-600 w-12 h-12 rounded-2xl flex items-center justify-center text-xl border border-amber-100"><i class="fas fa-calendar-week"></i></div>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">جدول المناوبة</h2>
                        <p class="text-slate-500 text-sm">توزيع المهام اليومية</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.app.addDutyLocationPrompt()" class="bg-white hover:bg-stone-50 text-slate-700 px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 transition cursor-pointer text-sm border border-stone-200 shadow-sm">
                        <i class="fas fa-map-marker-alt text-omani-gold"></i><span>موقع جديد</span>
                    </button>
                </div>
            </div>

            <div class="omani-card overflow-hidden">
                <div class="overflow-x-auto pb-4">
                    <table class="w-full text-right duty-table">
                        <thead class="bg-stone-50 border-b border-stone-200 text-slate-500 text-sm font-bold">
                            <tr>
                                <th class="p-4 sticky right-0 bg-stone-50 z-10 w-24 border-l border-stone-200">اليوم</th>
                                <!-- Dynamic Headers -->
                                <template id="dutyHeaderTemplate"></template>
                                <tr id="dutyHeaderRow"></tr>
                            </tr>
                        </thead>
                        <tbody id="dutyBody" class="divide-y divide-stone-100">
                            <!-- Rows generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- View: Supervision Hub -->
        <section id="view-supervision-hub" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col md:flex-row justify-between gap-4 omani-card p-6 relative overflow-hidden">
                <div class="absolute left-0 bottom-0 w-32 h-32 bg-omani-gold/5 rounded-full blur-2xl"></div>
                <div class="flex items-center gap-4 relative z-10">
                    <div class="bg-omani-green/10 text-omani-green w-14 h-14 rounded-2xl flex items-center justify-center text-2xl border border-omani-green/20"><i class="fas fa-clipboard-check"></i></div>
                    <div><h2 class="text-2xl font-bold text-slate-800">مركز الإشراف</h2><p class="text-slate-500 text-sm">إدارة الزيارات الفنية والتقارير</p></div>
                </div>
                <button onclick="window.app.startSupervision()" class="bg-omani-green hover:bg-emerald-800 text-white px-8 py-4 rounded-xl font-bold flex items-center gap-3 transition shadow-lg shadow-omani-green/20 cursor-pointer hover:-translate-y-0.5"><i class="fas fa-plus-circle"></i><span>زيارة جديدة</span></button>
            </div>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="omani-card p-6 flex flex-col justify-between group hover:border-omani-green/30 transition">
                    <div class="flex justify-between items-start mb-4"><div class="bg-blue-50 text-blue-600 w-10 h-10 rounded-lg flex items-center justify-center"><i class="fas fa-chart-pie"></i></div><span class="text-xs font-bold text-slate-400">إجمالي الزيارات</span></div>
                    <div class="text-4xl font-extrabold text-slate-800 group-hover:text-omani-green transition" id="hubTotalVisits">0</div>
                </div>
                <div class="omani-card p-6 flex flex-col justify-between group hover:border-omani-gold/50 transition">
                    <div class="flex justify-between items-start mb-4"><div class="bg-amber-50 text-amber-600 w-10 h-10 rounded-lg flex items-center justify-center"><i class="fas fa-star"></i></div><span class="text-xs font-bold text-slate-400">متوسط الأداء</span></div>
                    <div class="text-4xl font-extrabold text-slate-800 group-hover:text-omani-gold transition" id="hubAvgScore">0%</div>
                </div>
                <div class="omani-card p-6 flex flex-col justify-center gap-3 bg-stone-50">
                    <button onclick="window.app.setView('supervision-history')" class="w-full bg-white hover:bg-white text-slate-700 py-3 rounded-xl font-bold text-sm transition flex items-center justify-between px-4 cursor-pointer border border-stone-200 hover:border-omani-green shadow-sm"><span>سجل الزيارات الكامل</span><i class="fas fa-arrow-left text-slate-400"></i></button>
                    <button onclick="window.app.setView('reports')" class="w-full bg-white hover:bg-white text-slate-700 py-3 rounded-xl font-bold text-sm transition flex items-center justify-between px-4 cursor-pointer border border-stone-200 hover:border-omani-gold shadow-sm"><span>تقارير الأداء العام</span><i class="fas fa-arrow-left text-slate-400"></i></button>
                </div>
            </div>
            <div class="omani-card overflow-hidden">
                <div class="p-5 border-b border-stone-100 flex justify-between items-center"><h3 class="font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-history text-slate-400"></i> أحدث النشاطات</h3></div>
                <div id="hubRecentList" class="divide-y divide-stone-50"></div>
            </div>
        </section>

        <!-- View: Tasks -->
        <section id="view-tasks" class="fade-in space-y-6 hidden-view">
            <div class="flex flex-col gap-4 omani-card p-6 border-t-4 border-t-omani-gold">
                <div class="flex justify-between items-center"><div><h2 class="text-2xl font-bold text-slate-800">مهام المدير</h2></div><div class="bg-stone-100 px-3 py-1 rounded-lg border border-stone-200"><span class="text-xs font-bold text-slate-600" id="tasksProgressText">0/0 مكتمل</span></div></div>
                <div class="w-full h-2 bg-stone-100 rounded-full overflow-hidden"><div id="tasksProgressBar" class="h-full bg-omani-gold transition-all duration-500 w-0"></div></div>
                <div class="flex gap-2 items-center bg-stone-50 p-2 rounded-xl border border-stone-200 focus-within:ring-2 focus-within:ring-omani-gold/20 transition"><input type="text" id="newTaskInput" placeholder="أضف مهمة جديدة..." class="flex-1 bg-transparent border-none outline-none px-2 text-sm text-slate-800" onkeypress="if(event.key === 'Enter') window.app.addTask()"><select id="newTaskPriority" class="text-xs bg-white border border-stone-200 rounded-lg px-3 py-2 outline-none text-slate-700 font-bold"><option value="normal">عادي</option><option value="urgent">عاجل</option></select><button onclick="window.app.addTask()" class="bg-omani-gold hover:bg-yellow-600 text-white w-10 h-10 rounded-lg flex items-center justify-center transition cursor-pointer shadow-md"><i class="fas fa-plus"></i></button></div>
            </div>
            <div id="tasksList" class="grid gap-3"></div>
        </section>

        <!-- View: Reports -->
        <section id="view-reports" class="fade-in space-y-6 hidden-view">
            <div class="flex justify-between items-center omani-card p-6">
                <div><h2 class="text-2xl font-bold text-slate-800">تقارير الأداء</h2></div>
                <div class="flex gap-2"><button onclick="window.app.setView('supervision-history')" class="bg-white hover:bg-stone-50 text-slate-700 border border-stone-200 px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 transition cursor-pointer"><i class="fas fa-history text-slate-400"></i><span>سجل الزيارات</span></button><button onclick="window.app.exportReports()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 transition shadow-lg cursor-pointer"><i class="fas fa-file-excel"></i><span>تصدير</span></button></div>
            </div>
            <div class="omani-card overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-right"><thead class="bg-stone-50 border-b border-stone-200 text-slate-500 text-sm uppercase"><tr><th class="p-5 font-bold">المعلم</th><th class="p-5 font-bold text-center">التقييم</th><th class="p-5 font-bold text-center">الهاتف</th><th class="p-5 font-bold text-center">الحالة</th></tr></thead><tbody id="reportsBody" class="divide-y divide-stone-100"></tbody></table></div></div>
        </section>

        <!-- View: Supervision History -->
        <section id="view-supervision-history" class="fade-in space-y-6 hidden-view">
            <div class="flex justify-between items-center omani-card p-6">
                <div><h2 class="text-2xl font-bold text-slate-800">سجل الزيارات الإشرافية</h2></div>
                <button onclick="window.app.setView('supervision-hub')" class="bg-stone-100 hover:bg-stone-200 text-slate-600 px-4 py-2 rounded-lg font-bold text-xs transition cursor-pointer"><i class="fas fa-arrow-right"></i> عودة</button>
            </div>
            <div id="supervisionHistoryGrid" class="space-y-3"></div>
        </section>

        <!-- View: Supervision Form -->
        <section id="view-supervision" class="fade-in space-y-6 hidden-view pb-20">
            <div class="flex items-center gap-2 mb-4 text-sm text-slate-500 cursor-pointer hover:text-omani-green transition font-bold" onclick="window.app.setView('supervision-hub')"><i class="fas fa-arrow-right"></i> عودة لمركز الإشراف</div>
            <div class="omani-card p-8">
                <div class="flex items-center gap-3 mb-8 border-b border-stone-100 pb-6">
                    <div class="w-12 h-12 bg-omani-green text-white rounded-xl flex items-center justify-center text-xl shadow-lg shadow-omani-green/20"><i class="fas fa-clipboard-check"></i></div>
                    <h2 class="text-2xl font-bold text-slate-800">استمارة الزيارة الصفية</h2>
                </div>
                
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div><label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">المعلم</label><input type="text" id="supTeacherName" readonly class="hidden w-full bg-stone-50 border border-stone-200 rounded-xl p-3 text-slate-800 font-bold"><div class="relative"><select id="supTeacherSelect" onchange="window.app.onTeacherSelectChange()" class="w-full bg-stone-50 border border-stone-200 rounded-xl p-3 text-slate-800 focus:border-omani-green outline-none appearance-none font-bold transition"><option value="">اختر المعلم...</option></select><i class="fas fa-chevron-down absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i></div></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">تخصص المعلم</label><div class="relative"><select id="supSpecialization" class="w-full bg-stone-50 border border-stone-200 rounded-xl p-3 text-slate-800 focus:border-omani-green outline-none appearance-none transition"><option value="">اختر التخصص...</option></select><i class="fas fa-chevron-down absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i></div></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">الصف</label><input type="text" id="supClassName" class="w-full bg-stone-50 border border-stone-200 rounded-xl p-3 text-slate-800 focus:border-omani-green outline-none transition"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">عنوان الدرس</label><input type="text" id="supLessonTopic" placeholder="أدخل عنوان الدرس..." class="w-full bg-stone-50 border border-stone-200 rounded-xl p-3 text-slate-800 focus:border-omani-green outline-none transition"></div>
                    <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">نوع المدرسة</label><div class="flex gap-4 items-center bg-stone-50 border border-stone-200 rounded-xl p-3"><label class="flex items-center gap-2 cursor-pointer"><input type="radio" id="supGenderMale" name="supSchoolGender" value="male" class="accent-omani-green" checked><span class="text-sm font-bold text-slate-700">بنين</span></label><label class="flex items-center gap-2 cursor-pointer"><input type="radio" id="supGenderFemale" name="supSchoolGender" value="female" class="accent-pink-600"><span class="text-sm font-bold text-slate-700">بنات</span></label></div></div>
                </div>
                <div id="supervisionCriteriaList" class="space-y-6"></div>
                <button onclick="window.app.generateReport()" class="w-full bg-gradient-to-r from-omani-green to-emerald-700 hover:to-emerald-800 text-white font-bold py-4 rounded-xl shadow-xl shadow-omani-green/20 transition mt-10 flex items-center justify-center gap-3 cursor-pointer transform hover:-translate-y-1 text-lg"><i class="fas fa-magic"></i> توليد التقرير الذكي</button>
            </div>
        </section>

        <!-- View: Supervision Report -->
        <section id="view-supervision-report" class="fade-in space-y-6 hidden-view bg-white p-8 md:p-12 rounded-none md:rounded-xl shadow-none md:shadow-2xl min-h-screen md:min-h-0 print:min-h-0 max-w-5xl mx-auto border-t-8 border-omani-gold">
            <div class="border-b-2 border-stone-800 pb-6 mb-8 flex justify-between items-end">
                <div>
                    <div class="text-xs font-bold text-omani-green uppercase tracking-widest mb-1">وزارة التربية والتعليم</div>
                    <h1 class="text-4xl font-extrabold text-slate-900 font-serif">تقرير زيارة فنية</h1>
                </div>
                <div class="text-left text-sm text-slate-500 font-mono" id="reportDate"></div>
            </div>
            
            <div class="bg-stone-50 rounded-xl p-8 border border-stone-200 mb-10 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-20 h-20 bg-omani-green/10 rounded-bl-full"></div>
                <div class="grid grid-cols-2 gap-y-6 gap-x-12 text-sm relative z-10">
                    <div><span class="block text-xs font-bold text-slate-400 uppercase mb-1">المعلم/ة</span> <span id="repTeacherName" class="font-bold text-slate-900 text-xl font-serif"></span></div>
                    <div><span class="block text-xs font-bold text-slate-400 uppercase mb-1">التخصص</span> <span id="repSpecialization" class="font-bold text-slate-900 text-lg"></span></div>
                    <div><span class="block text-xs font-bold text-slate-400 uppercase mb-1">الصف</span> <span id="repClassName" class="font-bold text-slate-900 text-lg"></span></div>
                    <div><span class="block text-xs font-bold text-slate-400 uppercase mb-1">الدرس</span> <span id="repLessonTopic" class="font-bold text-slate-900 text-lg"></span></div>
                    <div class="col-span-2 border-t border-stone-200 pt-4 mt-2 flex gap-2"><span class="text-xs font-bold text-slate-400 uppercase">نوع المدرسة:</span> <span id="repSchoolGender" class="font-bold text-slate-900"></span></div>
                </div>
            </div>

            <div class="mb-10">
                <h3 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-3"><span class="w-8 h-8 rounded bg-omani-gold text-white flex items-center justify-center text-sm shadow-md">1</span> تفاصيل التقييم</h3>
                <div class="overflow-hidden rounded-xl border border-stone-200 shadow-sm">
                    <table class="w-full text-right text-sm">
                        <thead class="bg-stone-100 text-slate-600 font-bold border-b border-stone-200"><tr><th class="p-4 w-1/2">البند</th><th class="p-4 text-center w-24">التقييم</th><th class="p-4">الملاحظات</th></tr></thead>
                        <tbody id="repDetailsBody" class="divide-y divide-stone-100 bg-white"></tbody>
                    </table>
                </div>
            </div>

            <div class="mb-8 relative p-8 rounded-2xl border border-omani-green/20 bg-gradient-to-b from-white to-green-50/30">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h3 class="text-xl font-bold text-omani-green flex items-center gap-3"><span class="w-8 h-8 rounded bg-omani-green text-white flex items-center justify-center text-sm shadow-md">2</span> التحليل النوعي والتوصيات</h3>
                    <div class="flex gap-2">
                        <button onclick="window.app.copyToClipboardPrompt()" class="text-xs bg-white text-slate-700 border border-slate-200 px-4 py-2.5 rounded-full flex items-center gap-2 shadow-sm hover:bg-stone-50 transition cursor-pointer no-print font-bold group">
                            <i class="fas fa-copy text-omani-gold group-hover:scale-110 transition"></i><span>نسخ للأداة الخارجية</span>
                        </button>
                        <button onclick="window.app.enhanceReportWithAI()" class="text-xs bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-5 py-2.5 rounded-full flex items-center gap-2 shadow-md hover:shadow-lg transition cursor-pointer no-print font-bold group">
                            <i class="fas fa-wand-magic-sparkles group-hover:rotate-12 transition"></i><span>تحسين بالذكاء الاصطناعي</span>
                        </button>
                    </div>
                </div>
                <div id="aiReportContent" class="space-y-6 text-slate-700 leading-relaxed text-justify"></div>
                <div id="aiLoadingOverlay" class="absolute inset-0 bg-white/95 backdrop-blur-sm flex flex-col items-center justify-center z-10 hidden-view rounded-2xl">
                    <div class="w-16 h-16 border-4 border-stone-100 border-t-omani-green rounded-full animate-spin mb-4"></div>
                    <span class="text-base font-bold text-omani-green">جاري صياغة التقرير الاحترافي...</span>
                    <span class="text-xs text-slate-400 mt-1">يتم الآن الاتصال بمحرك الذكاء الاصطناعي</span>
                </div>
            </div>

            <div class="flex gap-4 mt-12 no-print border-t border-stone-200 pt-8">
                <button onclick="window.print()" class="flex-1 bg-slate-800 hover:bg-slate-900 text-white py-4 rounded-xl font-bold transition flex items-center justify-center gap-2 cursor-pointer shadow-lg"><i class="fas fa-print"></i> طباعة / PDF</button>
                <button onclick="window.app.saveVisit()" class="flex-1 bg-omani-green hover:bg-emerald-800 text-white py-4 rounded-xl font-bold transition flex items-center justify-center gap-2 cursor-pointer shadow-lg shadow-green-900/20"><i class="fas fa-save"></i> حفظ في السجل</button>
                <button onclick="window.app.setView('supervision')" class="flex-1 bg-white border border-stone-300 text-slate-600 hover:bg-stone-50 py-4 rounded-xl font-bold transition cursor-pointer">تعديل</button>
                <button onclick="window.app.setView('supervision-history')" class="flex-1 bg-red-50 border border-red-100 text-red-600 hover:bg-red-100 py-4 rounded-xl font-bold transition cursor-pointer">إغلاق</button>
            </div>
        </section>

    </main>

    <!-- Bottom Navigation (Floating Glass) -->
    <nav class="fixed bottom-4 left-4 right-4 glass-nav rounded-2xl shadow-2xl shadow-black/10 z-40 pb-0 no-print border border-white/40">
        <div class="flex justify-around items-center h-16 px-2">
            <button onclick="window.app.setView('now')" id="btn-now" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-omani-green transition-all duration-300 group">
                <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-emerald-50 group-hover:bg-emerald-100 transition-colors"><i class="fas fa-chalkboard text-lg mb-0.5"></i></div><span class="text-[10px] font-bold">الحصص</span>
            </button>
            <button onclick="window.app.setView('duty')" id="btn-duty" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-800 transition-all duration-300 group">
                <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-stone-100 transition-colors"><i class="fas fa-user-shield text-lg mb-0.5"></i></div><span class="text-[10px] font-bold">المناوبة</span>
            </button>
            
            <div class="relative -top-5">
                <button onclick="window.app.setView('supervision-hub')" id="btn-supervision-hub" class="w-14 h-14 bg-gradient-to-br from-omani-gold to-amber-600 text-white rounded-full flex items-center justify-center shadow-lg shadow-amber-600/30 transform active:scale-95 transition border-4 border-stone-50">
                    <i class="fas fa-clipboard-check text-xl"></i>
                </button>
            </div>

            <button onclick="window.app.setView('teachers')" id="btn-teachers" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-800 transition-all duration-300 group">
                <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-stone-100 transition-colors"><i class="fas fa-users-cog text-lg mb-0.5"></i></div><span class="text-[10px] font-bold">المعلمين</span>
            </button>
            <button onclick="window.app.setView('reports')" id="btn-reports" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 py-1 text-slate-400 hover:text-slate-800 transition-all duration-300 group">
                <div class="w-10 h-8 flex items-center justify-center rounded-xl bg-transparent group-hover:bg-stone-100 transition-colors"><i class="fas fa-file-invoice text-lg mb-0.5"></i></div><span class="text-[10px] font-bold">التقارير</span>
            </button>
        </div>
    </nav>
    </div>

    <!-- Modals -->
    <div id="modal-action" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden-view">
        <div class="absolute inset-0 bg-stone-900/60 backdrop-blur-sm modal-backdrop transition-opacity" onclick="window.app.closeModal('modal-action')"></div>
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden animate-scale-in modal-content mb-20 border border-white/20">
            <div class="bg-stone-800 p-6 text-white flex justify-between items-start relative overflow-hidden">
                <div class="absolute top-0 right-0 w-24 h-24 bg-white/5 rounded-full -mr-8 -mt-8"></div>
                <div class="relative z-10">
                    <h3 class="text-xl font-bold flex items-center gap-3" id="actionModalTitle"></h3>
                    <p id="actionModalSubtitle" class="text-stone-400 text-xs mt-1 font-mono"></p>
                </div>
                <button type="button" onclick="window.app.closeModal('modal-action')" class="text-white/50 hover:text-white cursor-pointer relative z-10"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="p-6 space-y-5 max-h-[60vh] overflow-y-auto custom-scrollbar bg-stone-50">
                <button type="button" id="btn-evaluate" class="w-full bg-white hover:bg-stone-100 text-omani-green border border-stone-200 p-4 rounded-2xl font-bold text-sm flex items-center justify-center gap-3 transition cursor-pointer shadow-sm group">
                    <span class="w-8 h-8 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600 group-hover:bg-emerald-100"><i class="fas fa-clipboard-list text-lg"></i></span>
                    <span>تقييم زيارة إشرافية</span>
                </button>
                
                <div class="space-y-3">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-2">التواصل المباشر</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" onclick="window.app.sendWhatsApp('summon')" class="bg-white hover:bg-emerald-50 text-emerald-700 border border-stone-200 p-3 rounded-xl font-bold text-xs flex flex-col items-center gap-2 transition cursor-pointer shadow-sm hover:border-emerald-200"><i class="fab fa-whatsapp text-2xl text-emerald-500"></i><span>استدعاء</span></button>
                        <button type="button" id="btn-remind" onclick="window.app.sendWhatsApp('remind')" class="bg-white hover:bg-blue-50 text-blue-700 border border-stone-200 p-3 rounded-xl font-bold text-xs flex flex-col items-center gap-2 transition cursor-pointer shadow-sm hover:border-blue-200"><i class="fas fa-bell text-2xl text-blue-500"></i><span>تذكير</span></button>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-2">تسجيل مخالفة سريعة</label>
                    <div id="violationButtonsContainer" class="space-y-2"></div>
                </div>
            </div>
             <div class="bg-white p-4 text-center border-t border-stone-200 flex justify-between items-center px-8 shadow-[0_-5px_20px_rgba(0,0,0,0.02)]">
                 <span class="text-xs text-slate-400 font-bold">التقييم الحالي</span>
                 <span class="text-2xl font-extrabold text-slate-800 font-sans" id="currentScoreDisplay"></span>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="modal-settings" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden-view">
        <div class="absolute inset-0 bg-stone-900/60 backdrop-blur-sm modal-backdrop" onclick="window.app.closeModal('modal-settings')"></div>
        <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden animate-scale-in flex flex-col max-h-[85vh] modal-content mb-10">
            <div class="bg-stone-800 text-white p-6 flex justify-between items-center shrink-0 border-b border-stone-700">
                <h3 class="text-xl font-bold flex items-center gap-3"><i class="fas fa-cog text-omani-gold"></i> الإعدادات</h3>
                <button type="button" onclick="window.app.closeModal('modal-settings')" class="text-white/50 hover:text-white cursor-pointer w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-8 overflow-y-auto custom-scrollbar space-y-8 bg-stone-50">
                <div class="space-y-4">
                    <div class="flex items-center justify-between pb-2 border-b border-stone-200"><h4 class="font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-palette text-omani-gold"></i> المظهر</h4></div>
                    <div id="themeSelectorContainer" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                </div>
                
                <div class="space-y-4">
                    <div class="flex items-center justify-between pb-2 border-b border-stone-200"><h4 class="font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-venus-mars text-omani-gold"></i> نوع المدرسة (افتراضي)</h4></div>
                    <div id="schoolGenderSelectorContainer" class="flex gap-4 items-center bg-white border border-stone-200 rounded-xl p-4 shadow-sm">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="defaultSchoolGender" value="male" onchange="window.app.setDefaultSchoolGender('male')" class="accent-omani-green"><span class="text-sm font-bold text-slate-700">بنين</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="defaultSchoolGender" value="female" onchange="window.app.setDefaultSchoolGender('female')" class="accent-pink-600"><span class="text-sm font-bold text-slate-700">بنات</span></label>
                    </div>
                </div>
                
                <!-- Secure Developer Settings -->
                <div id="developerSettingsSection" class="hidden-view space-y-4 bg-red-50 p-5 rounded-2xl border border-red-100 relative">
                    <div class="flex items-center justify-between pb-2 border-b border-red-200">
                        <h4 class="font-bold text-red-900 flex items-center gap-2"><i class="fas fa-shield-alt text-red-500"></i> إعدادات المطور (آمن)</h4>
                        <div class="flex gap-2">
                             <button onclick="window.app.enableDevEdit()" class="text-xs bg-white text-red-600 px-3 py-1.5 rounded-lg border border-red-200 hover:bg-red-50 transition cursor-pointer font-bold shadow-sm" title="تفعيل التعديل"><i class="fas fa-lock-open"></i> تعديل</button>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <label class="text-[10px] font-bold text-red-800 uppercase">رابط الدالة السحابية (Cloud Function URL)</label>
                        <input type="text" id="settingCloudUrl" disabled class="w-full text-xs p-3 rounded-lg border border-red-200 bg-white text-slate-600 dir-ltr text-left disabled:opacity-70 disabled:cursor-not-allowed shadow-inner font-mono">
                        
                        <label class="text-[10px] font-bold text-red-800 mt-2 block uppercase">مفتاح API (Gemini Direct)</label>
                        <input type="password" id="settingApiKey" disabled placeholder="AIzaSy..." class="w-full text-xs p-3 rounded-lg border border-red-200 bg-white text-slate-600 dir-ltr text-left disabled:opacity-70 disabled:cursor-not-allowed shadow-inner font-mono">
                        
                        <button onclick="window.app.saveDevSettings()" class="w-full mt-2 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl text-xs shadow-md transition cursor-pointer"><i class="fas fa-save"></i> حفظ الإعدادات الأمنية</button>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="flex items-center justify-between pb-2 border-b border-stone-200"><h4 class="font-bold text-slate-800 text-sm flex items-center gap-2"><i class="fas fa-gavel text-red-500"></i> إدارة المخالفات</h4></div>
                    <div class="flex gap-2 bg-white p-3 rounded-xl border border-stone-200 items-end shadow-sm">
                        <div class="flex-1 space-y-1"><label class="text-[10px] font-bold text-slate-400">اسم المخالفة</label><input type="text" id="newViolationLabel" placeholder="مثلاً: عدم تحضير" class="w-full text-sm p-2 rounded-lg border border-stone-200 focus:border-omani-green outline-none bg-stone-50"></div>
                        <div class="w-24 space-y-1"><label class="text-[10px] font-bold text-slate-400">الخصم</label><input type="number" id="newViolationPoints" value="5" class="w-full text-sm p-2 rounded-lg border border-stone-200 focus:border-omani-green outline-none text-center bg-stone-50"></div>
                        <button type="button" onclick="window.app.addViolation()" class="bg-omani-green hover:bg-emerald-800 text-white p-2 rounded-lg h-[38px] w-10 flex items-center justify-center transition cursor-pointer"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="violationsList" class="space-y-2"></div>
                </div>

                <div class="space-y-4">
                    <div class="flex items-center justify-between pb-2 border-b border-stone-200"><h4 class="font-bold text-slate-800 text-sm flex items-center gap-2"><i class="fas fa-graduation-cap text-indigo-500"></i> إدارة التخصصات</h4></div>
                    <div class="flex gap-2 bg-white p-3 rounded-xl border border-stone-200 items-center shadow-sm">
                        <input type="text" id="newSpecInput" placeholder="أضف تخصص جديد..." class="flex-1 text-sm p-2 rounded-lg border border-stone-200 focus:border-omani-green outline-none bg-stone-50">
                        <button type="button" onclick="window.app.addSpecialization()" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-lg h-[38px] w-10 flex items-center justify-center transition cursor-pointer"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="specializationsList" class="flex flex-wrap gap-2"></div>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-white p-5 rounded-2xl border border-stone-200 shadow-sm hover:border-omani-green transition group">
                        <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2 text-sm"><i class="fas fa-calendar-alt text-blue-500"></i> جدول الحصص (XML)</h4>
                        <button type="button" onclick="document.getElementById('xmlInput').click()" class="w-full bg-stone-50 hover:bg-blue-50 text-slate-600 hover:text-blue-700 border border-stone-200 hover:border-blue-200 py-3 rounded-xl font-bold text-xs transition cursor-pointer">رفع ملف XML</button>
                        <input type="file" id="xmlInput" accept=".xml" class="hidden" onchange="window.app.handleXml(event)">
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-stone-200 shadow-sm hover:border-omani-green transition group">
                        <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2 text-sm"><i class="fas fa-users text-emerald-500"></i> بيانات المعلمين (Excel)</h4>
                        <button type="button" onclick="document.getElementById('excelInput').click()" class="w-full bg-stone-50 hover:bg-emerald-50 text-slate-600 hover:text-emerald-700 border border-stone-200 hover:border-emerald-200 py-3 rounded-xl font-bold text-xs transition cursor-pointer">استيراد ملف Excel</button>
                        <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden" onchange="window.app.handleExcel(event)">
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="flex items-center justify-between pb-2 border-b border-stone-200">
                        <h4 class="font-bold text-slate-800 text-sm flex items-center gap-2"><i class="fas fa-database text-purple-500"></i> قاعدة بيانات الزيارات (Excel)</h4>
                    </div>
                    <div class="bg-purple-50 p-5 rounded-2xl border border-purple-100">
                        <p class="text-xs text-purple-800 mb-4 leading-relaxed font-medium">استيراد معايير الزيارات الإشرافية المخصصة.</p>
                        <button type="button" onclick="document.getElementById('criteriaExcelInput').click()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-bold text-xs transition cursor-pointer shadow-md shadow-purple-200"><i class="fas fa-upload"></i> استيراد قاعدة المعايير</button>
                        <input type="file" id="criteriaExcelInput" accept=".xlsx, .xls" class="hidden" onchange="window.app.handleCriteriaExcel(event)">
                    </div>
                </div>
                
                <div class="mt-8 pt-6 border-t border-stone-200">
                    <h4 class="font-bold text-red-600 mb-3 flex items-center gap-2 text-sm"><i class="fas fa-exclamation-triangle"></i> منطقة الخطر</h4>
                    <button onclick="window.app.deleteData()" class="w-full bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 py-4 rounded-xl font-bold text-xs transition flex items-center justify-center gap-2 cursor-pointer"><i class="fas fa-trash-alt"></i> حذف جميع البيانات وإعادة تعيين</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        // Keep Logic 100% Intact
        class SchoolApp {
            constructor() {
                this.state = {
                    currentUser: null, teachers: [], periods: [], classes: {}, tasks: [], agenda: [], 
                    violationTypes: [{ id: 'late', label: 'تأخر عن الحصة', points: 5, icon: 'fa-clock' }, { id: 'absent', label: 'غياب عن الحصة', points: 15, icon: 'fa-user-slash' }],
                    specializations: ["تربية اسلامية", "لغة عربية", "علوم", "أحياء", "كيمياء", "فيزياء", "الدراسات الاجتماعية", "اللغة الانجليزية", "المهارات الحياتية", "الرياضة المدرسية", "الفنون التشكيلية", "الفنون الموسيقية"],
                    simulationOffset: 0, selectedTeacherId: null, selectedClassName: null, supervisionData: { ratings: {}, notes: {}, gender: 'male' }, supervisionHistory: [], evaluationCriteria: [],
                    // Duty System Data
                    dutyLocations: ["البوابة الرئيسية", "الساحة الأمامية", "المقصف", "الممرات"],
                    dutySchedule: {}, // Structure: { dayIndex (0-4): { locationIndex: teacherId } }
                    
                    theme: 'default', defaultSchoolGender: 'male', cloudStatus: 'offline', unsubscribe: null, aiReportData: null, cloudFunctionUrl: "https://improvetext-cewovb6fwq-uc.a.run.app", apiKey: ""
                };
                this.db = null; this.auth = null;
                this.initDefaultCriteria();
                this.loadLocalData();
                this.initFirebaseAndAuth();
                this.startClock();
            }

            loadLocalData() {
                const stored = localStorage.getItem('school_data_v1');
                if (stored) {
                    try {
                        const data = JSON.parse(stored);
                        if (data.teachers) this.state.teachers = data.teachers;
                        if (data.periods) this.state.periods = data.periods;
                        if (data.classes) this.state.classes = data.classes;
                        if (data.tasks) this.state.tasks = data.tasks;
                        if (data.agenda) this.state.agenda = data.agenda;
                        if (data.violationTypes) this.state.violationTypes = data.violationTypes;
                        if (data.specializations) this.state.specializations = data.specializations;
                        if (data.supervisionHistory) this.state.supervisionHistory = data.supervisionHistory;
                        if (data.theme) this.state.theme = data.theme;
                        if (data.defaultSchoolGender) this.state.defaultSchoolGender = data.defaultSchoolGender;
                        if (data.cloudFunctionUrl) this.state.cloudFunctionUrl = data.cloudFunctionUrl;
                        if (data.apiKey) this.state.apiKey = data.apiKey;
                        if (data.evaluationCriteria && data.evaluationCriteria.length > 0) this.state.evaluationCriteria = data.evaluationCriteria;
                        if (data.dutyLocations) this.state.dutyLocations = data.dutyLocations;
                        if (data.dutySchedule) this.state.dutySchedule = data.dutySchedule;
                        this.applyTheme();
                    } catch(e) { console.error('Local Load Error', e); }
                }
            }

            initFirebaseAndAuth() {
                const firebaseConfig = { apiKey: "AIzaSyC4NddjijF29YNhowy4SqgRaMPn01oSSEg", authDomain: "school-9416e.firebaseapp.com", projectId: "school-9416e", storageBucket: "school-9416e.firebasestorage.app", messagingSenderId: "680872052240", appId: "1:680872052240:web:96d2e544166ab5f8096c95", measurementId: "G-5EBTV0MV83" };
                try {
                    if (typeof firebase !== 'undefined' && !firebase.apps.length) firebase.initializeApp(firebaseConfig);
                    if (typeof firebase !== 'undefined') {
                        this.db = firebase.firestore(); this.auth = firebase.auth();
                        this.auth.onAuthStateChanged(user => {
                            if (user) {
                                this.state.currentUser = { uid: user.uid, name: user.displayName, photoURL: user.photoURL, email: user.email };
                                document.getElementById('login-view').classList.add('hidden-view'); document.getElementById('app-view').classList.remove('hidden-view');
                                this.renderUserProfile(); this.loadUserData();
                            }
                        });
                    }
                } catch (e) { console.error("Firebase Init Error:", e); }
            }

            handleGoogleLogin() { const provider = new firebase.auth.GoogleAuthProvider(); this.auth.signInWithPopup(provider).catch(e => alert("فشل تسجيل الدخول")); }
            skipLogin() { document.getElementById('login-view').classList.add('hidden-view'); document.getElementById('app-view').classList.remove('hidden-view'); this.renderAll(); document.getElementById('user-profile-container').innerHTML = `<div class="flex items-center gap-3 bg-white/10 px-3 py-1 rounded-lg border border-white/10 backdrop-blur-md"><div class="text-xs text-slate-300 flex items-center gap-2"><i class="fas fa-user-shield"></i><span>زائر</span></div><div class="h-4 w-px bg-white/20 mx-1"></div><button onclick="window.app.handleLogout()" class="text-red-300 hover:text-red-100 transition cursor-pointer" title="خروج"><i class="fas fa-sign-out-alt"></i></button></div>`; }
            handleLogout() { if(confirm('هل تريد تسجيل الخروج؟')) { if(this.auth && this.state.currentUser) this.auth.signOut().catch(()=>{}); this.state.currentUser = null; document.getElementById('app-view').classList.add('hidden-view'); document.getElementById('login-view').classList.remove('hidden-view'); document.getElementById('user-profile-container').innerHTML = ''; } }
            
            renderUserProfile() {
                const container = document.getElementById('user-profile-container'); if(!container) return;
                if (this.state.currentUser) {
                    container.innerHTML = `
                        <div class="flex items-center gap-3 bg-white/10 px-3 py-1 rounded-lg border border-white/10 backdrop-blur-md">
                            <img src="${this.state.currentUser.photoURL || 'https://ui-avatars.com/api/?name='+this.state.currentUser.name}" class="w-8 h-8 rounded-full border border-[rgb(var(--color-primary-200))]">
                            <div class="hidden md:block text-xs text-white">
                                <div class="font-bold">${this.state.currentUser.name}</div>
                            </div>
                            <div class="h-4 w-px bg-white/20 mx-1"></div>
                            <button onclick="window.app.handleLogout()" class="text-red-300 hover:text-red-100 transition cursor-pointer" title="تسجيل خروج">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>`;
                } else {
                    container.innerHTML = '';
                }
            }

            loadUserData() {
                if (!this.state.currentUser) return;
                if (this.state.unsubscribe) this.state.unsubscribe();
                this.updateCloudStatus('connecting');
                this.state.unsubscribe = this.db.collection("users").doc(this.state.currentUser.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        this.state.teachers = data.teachers || []; this.state.periods = data.periods || []; this.state.classes = data.classes || {}; this.state.tasks = data.tasks || []; this.state.agenda = data.agenda || [];
                        if (data.violationTypes) this.state.violationTypes = data.violationTypes; if (data.specializations) this.state.specializations = data.specializations; if (data.supervisionHistory) this.state.supervisionHistory = data.supervisionHistory;
                        if (data.theme) this.state.theme = data.theme; if (data.defaultSchoolGender) this.state.defaultSchoolGender = data.defaultSchoolGender;
                        if (data.evaluationCriteria) this.state.evaluationCriteria = data.evaluationCriteria;
                        if (data.dutyLocations) this.state.dutyLocations = data.dutyLocations;
                        if (data.dutySchedule) this.state.dutySchedule = data.dutySchedule;
                        this.applyTheme(); this.renderAll(); this.updateCloudStatus('connected'); this.saveDataToLocal();
                    } else { this.saveData(); }
                }, e => this.updateCloudStatus('error'));
            }

            saveDataToLocal() { localStorage.setItem('school_data_v1', JSON.stringify({ teachers: this.state.teachers, periods: this.state.periods, classes: this.state.classes, tasks: this.state.tasks, agenda: this.state.agenda, violationTypes: this.state.violationTypes, specializations: this.state.specializations, supervisionHistory: this.state.supervisionHistory, theme: this.state.theme, defaultSchoolGender: this.state.defaultSchoolGender, cloudFunctionUrl: this.state.cloudFunctionUrl, apiKey: this.state.apiKey, evaluationCriteria: this.state.evaluationCriteria, dutyLocations: this.state.dutyLocations, dutySchedule: this.state.dutySchedule })); }
            async saveData() {
                this.saveDataToLocal(); if (!this.state.currentUser) { this.updateCloudStatus('local'); return; }
                this.updateCloudStatus('saving');
                try { await this.db.collection("users").doc(this.state.currentUser.uid).set({ teachers: this.state.teachers, periods: this.state.periods, classes: this.state.classes, tasks: this.state.tasks, agenda: this.state.agenda, violationTypes: this.state.violationTypes, specializations: this.state.specializations, supervisionHistory: this.state.supervisionHistory, theme: this.state.theme, defaultSchoolGender: this.state.defaultSchoolGender, evaluationCriteria: this.state.evaluationCriteria, dutyLocations: this.state.dutyLocations, dutySchedule: this.state.dutySchedule, lastSync: new Date(), userName: this.state.currentUser.name }, { merge: true }); this.updateCloudStatus('connected'); } catch (e) { this.updateCloudStatus('error'); }
            }

            updateCloudStatus(status) { const el = document.getElementById('cloudStatusIndicator'); if(!el) return; if(status === 'connected') el.innerHTML = '<span class="text-green-400"><i class="fas fa-check-circle"></i> متصل</span>'; else if(status === 'saving') el.innerHTML = '<span class="text-yellow-400"><i class="fas fa-sync fa-spin"></i> جاري الحفظ...</span>'; else if(status === 'local') el.innerHTML = '<span class="text-slate-400"><i class="fas fa-hdd"></i> حفظ محلي</span>'; else el.innerHTML = '<span class="text-red-400"><i class="fas fa-exclamation-triangle"></i> خطأ</span>'; }

            initDefaultCriteria() {
                this.state.evaluationCriteria = [
                    { id: 1, title: "التحصيل الدراسي", subtitle: "(تحصيل الطلبة في الأعمال الصفية وغير الصفية)", items: { 1: { desc: "اكتسب جميع الطلبة المهارات الأساسية والمعارف بصورة فعالة.", rec: "تنفيذ مبادرة تربوية تعزز من اكتساب الطلبة للمهارات والمعارف." }, 2: { desc: "يكتسب معظم الطلبة المهارات الأساسية والمعارف بصورة فاعلة.", rec: "تكثيف الأنشطة الإثرائية التي تستهدف الطلبة ذوي المستوى المرتفع." }, 3: { desc: "يكتسب أغلب الطلبة المهارات الأساسية بصورة ملائمة.", rec: "التركيز على تصميم أنشطة صفية متمايزة تضمن اكتساب جميع الطلبة للمهارات." }, 4: { desc: "اكتسب قلة من الطلبة المهارات الأساسية بصورة محدودة.", rec: "تنفيذ حصص تقوية للطلبة واستغلال حصص الاحتياطي لتكثيف الخطط العلاجية." }, 5: { desc: "يكتسب عدد نادر من الطلبة المهارات الأساسية.", rec: "وضع خطة علاجية فورية وشاملة وحصر المهارات المتأخرة." } } },
                    { id: 2, title: "التقدم الدراسي", subtitle: "(التقدم في المعارف والمهارات أثناء الحصة)", items: { 1: { desc: "يتقدم جميع الطلبة في المعارف والمفاهيم والمهارات بصورة متميزة.", rec: "تنفيذ قراءة موجهة لزملاء العمل لآلية تطبيق هرم بلوم." }, 2: { desc: "يتقدم معظم الطلبة دراسياً أثناء الحصة بصورة فاعلة.", rec: "الحرص على مراجعة آليات تفريد التعليم المقدمة للطلبة." }, 3: { desc: "يتقدم أغلب الطلبة دراسياً أثناء الحصة بصورة ملائمة.", rec: "ضمان توظيف هرم بلوم للأهداف بفاعلية في صياغة أسئلة الحصة." }, 4: { desc: "اكتسب بعض الطلبة المعارف والمفاهيم بصورة محدودة.", rec: "تطبيق مشروع تفريد التعلم وتنفيذ الخطط الفردية." }, 5: { desc: "يتقدم عدد نادر من الطلبة دراسياً بصورة محدودة جداً.", rec: "البدء فوراً في تنفيذ الخطط الفردية وتفريد التعلم." } } },
                    { id: 3, title: "مهارات التعلم", subtitle: "(التعلم الذاتي، التعاوني، والرقمي)", items: { 1: { desc: "يطبق جميع الطلبة مهارات التعلم الذاتي والتعاوني والرقمي بصورة متميزة.", rec: "تنفيذ قراءة موجهة لآلية طرح أسئلة مثيرة للتفكير." }, 2: { desc: "يطبق معظم الطلبة مهارات التعلم بمستوى فاعل.", rec: "تعزيز توظيف المنصات الرقمية لتدريب الطلبة على التعلم الذاتي." }, 3: { desc: "يطبق أغلب الطلبة مهارات التعلم بمستوى ملائم.", rec: "إدراج أنشطة صفية محددة تهدف لتنمية مهارات التفكير الناقد." }, 4: { desc: "اكتسب بعض الطلبة مهارات التعلم الذاتي بصورة محدودة.", rec: "تنفيذ مشروع يهدف إلى تنمية مهارات التعلم الذاتي والرقمي." }, 5: { desc: "يطبق عدد نادر من الطلبة مهارات التعلم بمستوى محدود جداً.", rec: "التركيز على تدريب الطلبة على أبسط مهارات التعلم ودمجها في الدرس." } } },
                    { id: 4, title: "القيم والسلوك", subtitle: "(الانضباط، الهوية الوطنية، القيم الإنسانية)", items: { 1: { desc: "يدرك جميع الطلبة للحقوق والواجبات ويعتزون بهويتهم العمانية.", rec: "تعزيز وتحفيز الطلبة بنماذج وملصقات تعبر عن الهوية العمانية." }, 2: { desc: "يلتزم معظم الطلبة بالقيم الإنسانية المشتركة بمستوى فاعل.", rec: "تصميم أنشطة إثرائية لتعزيز القيم الإيجابية لدى الطلبة." }, 3: { desc: "يلتزم أغلب الطلبة بالقيم الإنسانية المشتركة بمستوى ملائم.", rec: "توفير فرص للطلبة لممارسة التعبير عن الذات والحوار بثقة." }, 4: { desc: "يدرك بعض الطلبة الحقوق والواجبات بصورة محدودة.", rec: "تنفيذ مشروع يهدف إلى تنمية القيم والسلوك وتعزيز الهوية." }, 5: { desc: "يلتزم عدد محدود جداً من الطلبة بالقيم الإنسانية.", rec: "وضع خطة سلوكية مركزة لعلاج حالات عدم الانضباط في الحصة." } } },
                    { id: 5, title: "جودة بيئة التعلم", subtitle: "(الأمن والسلامة، النظافة، الجاذبية)", items: { 1: { desc: "يتابع المعلم جميع جوانب الأمن والسلامة والنظافة بصورة متميزة.", rec: "تنفيذ حصة تطبيقية حول جوانب الأمن والسلامة في البيئة الصفية." }, 2: { desc: "يتابع المعلم جوانب الأمن والسلامة بصورة جيدة.", rec: "توثيق الممارسات المتميزة في جوانب الأمن والسلامة وتعميمها." }, 3: { desc: "يتابع المعلم جوانب الأمن والسلامة بصورة مناسبة.", rec: "التأكد من تطبيق سياسات الأمن والسلامة في جميع الأنشطة الصفية." }, 4: { desc: "يتابع بعض جوانب الأمن والسلامة بصورة محدودة.", rec: "الالتزام بتدابير الأمن والسلامة في البيئة الصفية (أسلاك مكشوفة..)." }, 5: { desc: "يتابع المعلم جوانب الأمن والسلامة بصورة نادرة.", rec: "اتخاذ إجراءات تصحيحية فورية لضمان سلامة الطلبة." } } },
                    { id: 6, title: "تخطيط المنهاج الدراسي", subtitle: "(التسلسل، ارتباط الأهداف، النواتج)", items: { 1: { desc: "يخطط لجميع دروسه متسلسلاً في تنوع الأهداف بصورة متميزة.", rec: "تنفيذ ورشة تدريبية لكيفية التخطيط للدرس بما يتوافق مع الخطة الفصلية." }, 2: { desc: "يخطط المعلم معظم دروسه بصورة جيدة.", rec: "تطوير التخطيط اليومي عبر إضافة أنشطة إثرائية وخطط علاجية واضحة." }, 3: { desc: "يخطط المعلم أغلب دروسه بصورة مناسبة.", rec: "مراجعة التخطيط للتأكد من ربط الأهداف بنواتج التعلم المحددة." }, 4: { desc: "يخطط لبعض دروسه بصورة محدودة.", rec: "الالتزام بتوافق أهداف خطة الدرس مع الخطة الفصلية." }, 5: { desc: "يخطط المعلم عدد محدود جداً من دروسه بصورة نادرة.", rec: "الالتزام الفوري بإعداد خطط الدروس اليومية بشكل متكامل." } } },
                    { id: 7, title: "إدارة الصف", subtitle: "(إدارة الوقت، السلوك، الدافعية)", items: { 1: { desc: "يقوم بإدارة زمن التعلم وإدارة سلوكيات جميع الطلبة بصورة فعالة.", rec: "العمل على تحليل نتائج الطلبة وتوثيق الأسئلة العاصفة للذهن." }, 2: { desc: "يقوم المعلم بإدارة زمن التعلم بصورة جيدة.", rec: "إدراج استراتيجيات مبتكرة لإدارة سلوكيات الطلبة وتعزيز دافعيتهم." }, 3: { desc: "يقوم المعلم بإدارة زمن التعلم وسلوك طلبته بصورة ملائمة.", rec: "الاستمرار في الإدارة الجيدة للحصة والتركيز على تحويل السلوكيات السلبية." }, 4: { desc: "يقوم بإدارة زمن التعلم بصورة محدودة.", rec: "الالتزام بزمن التعلم والعمل على إدارة وقت الحصة بشكل فعال." }, 5: { desc: "يقوم المعلم بإدارة زمن التعلم وسلوك طلبته بصورة نادرة.", rec: "تطبيق قواعد صارمة لإدارة الصف والالتزام بالخطة الزمنية." } } },
                    { id: 8, title: "فاعلية التدريس", subtitle: "(استراتيجيات التدريس، التمايز، التعلم النشط)", items: { 1: { desc: "يوظف استراتيجيات التدريس والتقنيات الحديثة بصورة فعالة.", rec: "تصميم دليل رقمي لبعض المنصات الرقمية وبرامج الذكاء الاصطناعي." }, 2: { desc: "يوظف المعلم استراتيجيات تدريس فعالة يستفيد منها معظم الطلبة.", rec: "توسيع نطاق توظيف برامج الذكاء الاصطناعي في تصميم الأنشطة المتمايزة." }, 3: { desc: "يوظف المعلم استراتيجيات تدريس يستفيد منها أغلب الطلبة.", rec: "التنويع في استراتيجيات التدريس لضمان تلبية احتياجات جميع الطلبة." }, 4: { desc: "يوظف استراتيجيات التدريس بصورة محدودة (التلقين).", rec: "العمل على التنويع من مصادر التعلم وتحديدها وفقاً لاحتياجات الطلبة." }, 5: { desc: "يوظف استراتيجيات تدريس يستفيد منها عدد قليل جداً.", rec: "استبدال استراتيجيات التلقين باستراتيجيات التعلم النشط." } } },
                    { id: 9, title: "تفعيل المصادر والموارد", subtitle: "(التقنيات الرقمية، الوسائل التعليمية)", items: { 1: { desc: "يفعل المعلم التقنيات الرقمية بحيث يستفيد منها جميع الطلبة.", rec: "توثيق أفضل ممارسات توظيف التقنيات الرقمية والذكاء الاصطناعي." }, 2: { desc: "يفعل المعلم التقنيات الرقمية بحيث يستفيد منها معظم الطلبة.", rec: "تشجيع الطلبة على استخدام التقنيات الرقمية كأداة للإنتاج المعرفي." }, 3: { desc: "يفعل المعلم التقنيات الرقمية بحيث يستفيد منها أغلب الطلبة.", rec: "العمل على دمج المصادر الرقمية والتقليدية في خطة الدرس بطريقة فعالة." }, 4: { desc: "يفعل المعلم التقنيات الرقمية بصورة محدودة.", rec: "العمل على تنويع المصادر والموارد التعليمية ودمج المنصات." }, 5: { desc: "يفعل المعلم التقنيات الرقمية بصورة نادرة أو منعدمة.", rec: "البدء فوراً في تفعيل المصادر والموارد التعليمية المتاحة." } } },
                    { id: 10, title: "التقويم ومساندة التقدم", subtitle: "(تنوع الأساليب، التغذية الراجعة، مراعاة الفروق)", items: { 1: { desc: "يوظف أساليب تقويم متنوعة تراعي التمايز بين جميع الطلبة.", rec: "تشكيل فريق عمل لصياغة مجموعة أنشطة صفية تراعي المستويات الثلاثة." }, 2: { desc: "يوظف المعلم أساليب تقويم متنوعة تراعي التمايز بين معظم الطلبة.", rec: "تعميم تجربة توظيف أساليب التقويم المتنوعة على الزملاء." }, 3: { desc: "يوظف المعلم أساليب تقويم متنوعة تراعي التمايز بين أغلب الطلبة.", rec: "مراجعة أدوات التقويم المستخدمة للتأكد من تغطيتها المستويات المعرفية." }, 4: { desc: "يوظف المعلم أساليب تقويم تراعي التمايز بصورة محدودة.", rec: "التنويع من أساليب تقويم تراعي التمايز بين جميع الطلبة." }, 5: { desc: "يوظف المعلم أساليب تقويم تراعي التمايز بصورة نادرة.", rec: "التنويع الفوري في أساليب التقويم (الشفوي، الكتابي، الأداء)." } } },
                    { id: 11, title: "قيادة التغيير", subtitle: "(التقويم الذاتي، التنمية المهنية)", items: { 1: { desc: "يُجري تقويماً لأدائه ذاتياً ويوظفه في تحسين تعلم جميع الطلبة.", rec: "تنفيذ مشغل تدريبي للزملاء حول أحد جوانب الإجادة." }, 2: { desc: "يُجري المعلم تقويماً لأدائه ذاتياً ويوظفه بصورة جيدة.", rec: "تشجيع الزملاء على تبني ممارساته المتميزة في التقويم الذاتي." }, 3: { desc: "يُجري المعلم تقويماً لأدائه ذاتياً ويوظفه بصورة مقبولة.", rec: "الالتزام ببرامج التطوير المهني المتاحة وتطبيق المكتسب منها." }, 4: { desc: "يُجري تقويماً لأدائه ذاتياً بشكل محدود.", rec: "الالتزام بالمشاركة المهنية وحضور الورش والمحاضرات." }, 5: { desc: "يُجري المعلم تقويماً لأدائه ذاتياً بصورة نادرة.", rec: "الالتزام بحضور الورش والبدء في توثيق ممارساته المهنية." } } },
                    { id: 12, title: "الحوكمة", subtitle: "(الالتزام باللوائح والأنظمة والوقت)", items: { 1: { desc: "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة فعالة.", rec: "الاستمرار بتطبيق اللوائح ومتابعة أثر الانضباط على النتائج." }, 2: { desc: "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة فاعلة.", rec: "توثيق الممارسات المتميزة في تطبيق الأنظمة وتعميمها." }, 3: { desc: "يطبق السياسات والأنظمة واللوائح بصورة مناسبة.", rec: "التأكد من أن الالتزام باللوائح ينعكس إيجاباً على أداء الطلبة." }, 4: { desc: "يطبق السياسات والأنظمة بصورة محدودة.", rec: "الالتزام باللوائح والأنظمة وضرورة المحافظة على زمن التعلم." }, 5: { desc: "يطبق السياسات والأنظمة بصورة نادرة.", rec: "الالتزام التام بالدوام الرسمي وضبط زمن التعلم وتطبيق كافة الأنظمة." } } },
                    { id: 13, title: "المبادرات والأنشطة", subtitle: "(المشاريع، التفاعل مع المجتمع المدرسي)", items: { 1: { desc: "يقدم مبادرات فعالة ويتميز بالتفاعل الإيجابي في جميع الأنشطة.", rec: "توثيق مبادرة التحصيل الدراسي بطريقة علمية للمشاركة بها." }, 2: { desc: "يقدم مبادرات فاعلة ويتفاعل إيجابياً في معظم الأنشطة.", rec: "التوسع في مجال المبادرة والعمل على توثيق أثرها." }, 3: { desc: "يقدم مبادرات ملائمة ويتفاعل إيجابياً في أغلب الأنشطة.", rec: "الاستمرار في تقديم المبادرات وقيادة فريق عمل لتنفيذ إحداها." }, 4: { desc: "يقدم مبادرات محدودة ويتفاعل بصورة محدودة.", rec: "الالتزام بحضور الاجتماعات والبرامج والمبادرة بتقديم مقترح." }, 5: { desc: "نادراً ما يقدم مبادرات وتفاعله محدود جداً.", rec: "الالتزام التام بحضور الاجتماعات والأنشطة المدرسية." } } }
                ];
            }

            setView(v) { 
                ['now', 'teachers', 'reports', 'supervision', 'supervision-report', 'supervision-history', 'tasks', 'agenda', 'supervision-hub', 'duty'].forEach(x => { 
                    document.getElementById(`view-${x}`)?.classList.add('hidden-view'); 
                    const b = document.getElementById(`btn-${x}`); 
                    if(b) { 
                        b.classList.remove('text-omani-green', 'text-slate-800'); 
                        b.classList.add('text-slate-400'); 
                        b.querySelector('div').classList.remove('bg-emerald-50', 'text-emerald-700'); 
                        b.querySelector('div').classList.add('bg-transparent'); 
                    } 
                }); 
                document.getElementById(`view-${v}`)?.classList.remove('hidden-view'); 
                const ab = document.getElementById(`btn-${v}`); 
                if(ab) { 
                    ab.classList.remove('text-slate-400'); 
                    ab.classList.add('text-omani-green'); 
                    ab.querySelector('div').classList.remove('bg-transparent'); 
                    ab.querySelector('div').classList.add('bg-emerald-50', 'text-emerald-700'); 
                } 
                if(v==='teachers') this.renderTeachers(); if(v==='reports') this.renderReports(); if(v==='supervision-history') this.renderHistory(); if(v==='tasks') this.renderTasks(); if(v==='agenda') this.renderAgenda(); if(v==='supervision-hub') this.renderSupervisionHub(); if(v==='duty') this.renderDutyTable();
                if(v==='now') { this.renderCurrentPeriod(new Date(new Date().getTime() + this.state.simulationOffset)); this.renderDailyDutyWidget(new Date(new Date().getTime() + this.state.simulationOffset)); } 
            }

            renderSupervisionHub() {
                const select = document.getElementById('supTeacherSelect');
                if(select) {
                    select.innerHTML = '<option value="">اختر المعلم...</option>';
                    const sortedTeachers = [...this.state.teachers].sort((a,b) => a.name.localeCompare(b.name, 'ar'));
                    sortedTeachers.forEach(t => { const opt = document.createElement('option'); opt.value = t.id; opt.text = t.name; select.add(opt); });
                }
                const history = this.state.supervisionHistory || [];
                document.getElementById('hubTotalVisits').innerText = history.length;
                let totalScore = 0; let count = 0;
                history.forEach(h => { let visitTotal = 0; let visitItems = 0; Object.values(h.ratings).forEach(r => { visitTotal += (6 - parseInt(r)); visitItems++; }); if(visitItems > 0) { totalScore += (visitTotal / visitItems) * 20; count++; } });
                document.getElementById('hubAvgScore').innerText = count > 0 ? Math.round(totalScore/count) + '%' : '0%';
                const list = document.getElementById('hubRecentList'); if(!list) return;
                const recent = [...history].sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime()).slice(0, 5);
                list.innerHTML = recent.length === 0 ? `<div class="p-4 text-center text-slate-400 text-xs">لا توجد زيارات حديثة</div>` : recent.map(v => `<div class="p-4 flex justify-between items-center hover:bg-stone-50 transition"><div><div class="font-bold text-slate-800 text-sm">${v.teacherName}</div><div class="text-[10px] text-slate-500">${v.date} - ${v.topic}</div></div><button onclick="window.app.loadVisitByDate('${v.id}')" class="bg-white hover:bg-stone-100 text-omani-green border border-stone-200 px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer shadow-sm">عرض</button></div>`).join('');
            }
            
            loadVisitByDate(id) { const visit = this.state.supervisionHistory.find(v => v.id === id); if(visit) { this.state.supervisionData = { ratings: visit.ratings, notes: visit.notes || {}, gender: visit.gender || 'male' }; this.generateReport(true, visit); } }

            startSupervision(teacherId, className) {
                if (!teacherId) {
                    this.state.supervisionData = { ratings: {}, notes: {}, gender: this.state.defaultSchoolGender };
                    this.renderSupervisionHub(); document.getElementById('supTeacherName').classList.add('hidden'); document.getElementById('supTeacherSelect').parentElement.classList.remove('hidden');
                    document.getElementById('supTeacherSelect').value = ""; document.getElementById('supClassName').value = ""; document.getElementById('supLessonTopic').value = "";
                    this.renderCriteria(); this.setView('supervision'); return;
                }
                const t = this.state.teachers.find(x => x.id === teacherId); if(!t) return;
                document.getElementById('supTeacherSelect').parentElement.classList.add('hidden'); document.getElementById('supTeacherName').classList.remove('hidden'); document.getElementById('supTeacherName').value = t.name;
                document.getElementById('supClassName').value = className || ''; document.getElementById('supLessonTopic').value = '';
                if (this.state.defaultSchoolGender === 'female') document.getElementById('supGenderFemale').checked = true; else document.getElementById('supGenderMale').checked = true;
                const specSelect = document.getElementById('supSpecialization'); specSelect.innerHTML = '<option value="">اختر التخصص...</option>';
                const specs = this.state.specializations || []; specs.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.text = s; specSelect.add(opt); }); if (t.specialization) specSelect.value = t.specialization;
                this.state.supervisionData = { ratings: {}, notes: {}, gender: this.state.defaultSchoolGender }; this.renderCriteria(); this.setView('supervision');
            }

            renderCriteria() {
                const list = document.getElementById('supervisionCriteriaList');
                list.innerHTML = this.state.evaluationCriteria.map((criterion, index) => `<div class="bg-white p-5 rounded-xl border border-stone-200 shadow-sm hover:border-omani-green/30 transition duration-300"><div class="mb-4 border-b border-stone-100 pb-3"><h3 class="font-bold text-slate-800 text-base flex items-center gap-2"><span class="bg-omani-green text-white w-6 h-6 rounded-md flex items-center justify-center text-xs font-serif">${index + 1}</span>${criterion.title}</h3><p class="text-xs text-slate-500 mr-8 mt-1">${criterion.subtitle}</p></div><div class="space-y-3">${[1,2,3,4,5].map(rating => { const item = criterion.items[rating]; const desc = item ? item.desc : ''; return `<label class="relative flex items-start gap-3 p-3 border border-stone-200 rounded-lg cursor-pointer bg-stone-50 hover:bg-white transition-all group"><input type="radio" name="criteria_${criterion.id}" value="${rating}" onchange="window.app.setRating(${criterion.id}, ${rating})" class="sup-radio peer mt-1 accent-omani-green opacity-0 absolute"><div class="w-4 h-4 rounded-full border-2 border-slate-300 peer-checked:border-omani-green peer-checked:bg-omani-green mt-1 flex-shrink-0 transition"></div><div class="flex-1"><div class="flex items-center gap-2 mb-1"><span class="font-bold text-slate-700 text-xs">مستوى ${rating}</span></div><p class="text-xs text-slate-500 leading-relaxed font-light">${desc}</p></div></label>`; }).join('')}</div><div class="mt-4"><input type="text" onchange="window.app.setNote(${criterion.id}, this.value)" placeholder="اكتب ملاحظة توجيهية خاصة بهذا البند (اختياري)..." class="w-full text-xs p-3 rounded-lg border border-stone-200 bg-stone-50 focus:border-omani-green focus:bg-white outline-none transition"></div></div>`).join('');
            }

            onTeacherSelectChange() {
                const select = document.getElementById('supTeacherSelect'); const tId = select.value; const t = this.state.teachers.find(x => x.id === tId);
                const specSelect = document.getElementById('supSpecialization'); specSelect.innerHTML = '<option value="">اختر التخصص...</option>';
                const specs = this.state.specializations || []; specs.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.text = s; specSelect.add(opt); });
                if(t && t.specialization) specSelect.value = t.specialization;
            }

            setRating(criteriaId, rating) { this.state.supervisionData.ratings[criteriaId] = rating; }
            setNote(criteriaId, text) { if(!this.state.supervisionData.notes) this.state.supervisionData.notes = {}; this.state.supervisionData.notes[criteriaId] = text; }

            generateReport(isLoad = false, existingData = null) {
                const ratings = existingData ? existingData.ratings : this.state.supervisionData.ratings; const notes = existingData ? (existingData.notes || {}) : (this.state.supervisionData.notes || {});
                if(!isLoad && Object.keys(ratings).length < this.state.evaluationCriteria.length) { alert('يرجى استكمال تقييم جميع البنود'); return; }
                let tName = ""; if(isLoad) { tName = existingData.teacherName; } else { const nameInput = document.getElementById('supTeacherName'); if (!nameInput.classList.contains('hidden')) { tName = nameInput.value; } else { const select = document.getElementById('supTeacherSelect'); tName = select.options[select.selectedIndex].text; } }
                const spec = isLoad ? existingData.specialization : document.getElementById('supSpecialization').value; const cName = isLoad ? existingData.className : document.getElementById('supClassName').value; const lTopic = isLoad ? existingData.topic : document.getElementById('supLessonTopic').value || '-';
                const schoolGender = isLoad ? existingData.gender : document.querySelector('input[name="supSchoolGender"]:checked').value; const rDate = isLoad ? existingData.date : new Date().toLocaleDateString('ar-EG');
                this.state.supervisionData.gender = schoolGender;
                document.getElementById('repTeacherName').innerText = tName; document.getElementById('repSpecialization').innerText = spec || 'عام'; document.getElementById('repClassName').innerText = cName; document.getElementById('repLessonTopic').innerText = lTopic; document.getElementById('reportDate').innerText = rDate; document.getElementById('repSchoolGender').innerText = schoolGender === 'male' ? 'بنين' : 'بنات';
                const analysis = []; const detailsBody = document.getElementById('repDetailsBody'); detailsBody.innerHTML = ''; 
                this.state.evaluationCriteria.forEach(c => { const r = ratings[c.id]; const noteText = notes[c.id] || '-'; const itemData = c.items[r] || { desc: "", rec: "" }; analysis.push({ id: c.id, title: c.title, rating: r, desc: itemData.desc, rec: itemData.rec, note: notes[c.id] || '' }); let ratingBadge = r === 1 ? 'text-emerald-700 bg-emerald-100' : (r === 2 ? 'text-green-600 bg-green-50' : (r === 3 ? 'text-yellow-600 bg-yellow-50' : (r === 4 ? 'text-orange-600 bg-orange-50' : 'text-red-600 bg-red-50'))); detailsBody.innerHTML += `<tr class="hover:bg-stone-50 transition-colors"><td class="p-4 border-b border-stone-100 align-top"><div class="font-bold text-slate-800 mb-1">${c.title}</div><div class="text-[10px] text-slate-400 mb-2 font-bold">${c.subtitle}</div><div class="text-xs text-slate-500 leading-relaxed bg-stone-50 p-2 rounded border border-stone-200">${itemData.desc}</div></td><td class="p-4 border-b border-stone-100 text-center align-top pt-5"><span class="font-bold px-3 py-1 rounded text-xs border border-transparent ${ratingBadge}">${r}/5</span></td><td class="p-4 border-b border-stone-100 text-slate-500 italic text-xs align-top pt-5">${noteText}</td></tr>`; });
                if (isLoad && existingData.aiReportContent) { document.getElementById('aiReportContent').innerHTML = existingData.aiReportContent; } else {
                    const strengths = [...analysis].sort((a,b) => a.rating - b.rating).slice(0, 4); const improvements = [...analysis].filter(a => a.rating > 2).sort((a,b) => b.rating - a.rating).slice(0, 4);
                    const repStrengthsHTML = strengths.map(s => `<li><span class="font-bold text-emerald-700">${s.title}:</span> ${s.desc}</li>`).join(''); const repImprovementsHTML = improvements.length > 0 ? improvements.map(s => `<li><span class="font-bold text-orange-700">${s.title}:</span> ${s.desc}</li>`).join('') : '<li>لا توجد نقاط ضعف ملحوظة تستدعي التدخل العاجل.</li>'; const repRecommendationsHTML = improvements.length > 0 ? improvements.map(s => `<li>${s.rec || `تحسين مستوى ${s.title} من خلال اتباع استراتيجيات حديثة.`}</li>`).join('') : '<li>الاستمرار في الأداء المتميز ومشاركة الخبرات مع الزملاء.</li>';
                    document.getElementById('aiReportContent').innerHTML = `<div class="ai-report-section mb-6"><h4><i class="fas fa-star text-omani-green"></i> أبرز جوانب الإجادة</h4><ul class="list-disc pr-5 text-sm text-slate-700">${repStrengthsHTML}</ul></div><div class="ai-report-section mb-6"><h4><i class="fas fa-chart-line text-amber-600"></i> نقاط تحتاج إلى تحسين</h4><ul class="list-disc pr-5 text-sm text-slate-700">${repImprovementsHTML}</ul></div><div class="ai-report-section bg-stone-50 p-5 rounded-xl border border-stone-200"><h4><i class="fas fa-lightbulb text-omani-gold"></i> التوصيات والمقترحات الفنية</h4><ul class="list-decimal pr-5 text-sm text-slate-700 space-y-2">${repRecommendationsHTML}</ul></div>`;
                }
                this.setView('supervision-report');
            }

            saveVisit() {
                const visitData = { id: Date.now().toString(), teacherName: document.getElementById('repTeacherName').innerText, specialization: document.getElementById('repSpecialization').innerText, className: document.getElementById('repClassName').innerText, topic: document.getElementById('repLessonTopic').innerText, date: document.getElementById('reportDate').innerText, gender: this.state.supervisionData.gender, ratings: {...this.state.supervisionData.ratings}, notes: {...this.state.supervisionData.notes}, aiReportContent: document.getElementById('aiReportContent').innerHTML };
                if(!this.state.supervisionHistory) this.state.supervisionHistory = []; const existingIndex = this.state.supervisionHistory.findIndex(v => v.id === visitData.id); if (existingIndex > -1) { this.state.supervisionHistory[existingIndex] = visitData; } else { this.state.supervisionHistory.push(visitData); } this.saveData(); alert('تم حفظ الزيارة في السجل بنجاح');
            }

            buildPlainTextReport() {
                const topic = document.getElementById('repLessonTopic').innerText; const specialization = document.getElementById('repSpecialization').innerText; const gender = this.state.supervisionData.gender; const isMale = gender === 'male';
                const context = { teacher: isMale ? "المعلم" : "المعلمة", student: isMale ? "الطالب" : "الطالبة", students: isMale ? "الطلاب" : "الطالبات", address: isMale ? "مدرسة بنين" : "مدرسة بنات" };
                let reportText = `الدور: تصرف بصفتك موجه فني خبير لمادة ${specialization}. المهمة: كتابة تقرير زيارة صفية فني واحترافي. معلومات الزيارة: - المعلم: ${context.teacher} - عنوان الدرس: "${topic}" - نوع المدرسة: ${context.address}. التقييمات التفصيلية:\n`;
                this.state.evaluationCriteria.forEach(c => { const r = this.state.supervisionData.ratings[c.id]; const note = this.state.supervisionData.notes[c.id]; if (r) { const itemDesc = c.items[r]?.desc || ''; reportText += `- ${c.title}: مستوى ${r}/5. (${itemDesc}) ${note ? '- ملاحظة إضافية: ' + note : ''}\n`; } });
                reportText += `\nالمطلوب (HTML Format Only): يرجى صياغة التقرير بتنسيق HTML جاهز للعرض، يتضمن الأقسام التالية داخل divs بclass "ai-report-section": وصف عام للأداء، أبرز جوانب الإجادة، نقاط التحسين، توصيات فنية.`;
                return reportText;
            }

            async copyToClipboardPrompt() {
                const teacherName = document.getElementById('repTeacherName').innerText;
                const specialization = document.getElementById('repSpecialization').innerText;
                const className = document.getElementById('repClassName').innerText;
                const topic = document.getElementById('repLessonTopic').innerText;
                const schoolType = document.getElementById('repSchoolGender').innerText;
                
                let prompt = `أعمل كموجه فني تربوي خبير لمادة ${specialization}.\n`;
                prompt += `المطلوب: صياغة تقرير زيارة صفية احترافي، تربوي، ومحفز بناءً على البيانات التالية:\n\n`;
                prompt += `--- بيانات الزيارة ---\n`;
                prompt += `- المعلم: ${teacherName}\n`;
                prompt += `- التخصص: ${specialization}\n`;
                prompt += `- الصف: ${className}\n`;
                prompt += `- عنوان الدرس: ${topic}\n`;
                prompt += `- نوع المدرسة: ${schoolType}\n\n`;
                prompt += `--- تفاصيل التقييم والملاحظات ---\n`;

                this.state.evaluationCriteria.forEach(c => {
                    const r = this.state.supervisionData.ratings[c.id];
                    const note = this.state.supervisionData.notes[c.id];
                    if (r) {
                        const itemDesc = c.items[r]?.desc || '';
                        prompt += `* المعيار: ${c.title}\n`;
                        prompt += `  - التقييم: ${r} من 5\n`;
                        prompt += `  - الوصف: ${itemDesc}\n`;
                        if(note && note.length > 1) prompt += `  - ملاحظات المشرف: ${note}\n`;
                    }
                });

                prompt += `\n--- هيكل التقرير المطلوب ---\n`;
                prompt += `يرجى كتابة التقرير بحيث يتضمن:\n`;
                prompt += `1. مقدمة عامة تصف سياق الحصة.\n`;
                prompt += `2. نقاط القوة (أبرز جوانب الإجادة).\n`;
                prompt += `3. فرص التحسين (نقاط الضعف إن وجدت).\n`;
                prompt += `4. توصيات فنية عملية للمعلم للارتقاء بالأداء.\n`;
                prompt += `5. خاتمة تشجيعية.\n`;

                try {
                    await navigator.clipboard.writeText(prompt);
                    alert("تم نسخ كافة تفاصيل الزيارة ومعايير التقييم إلى الحافظة بنجاح!\n\nيمكنك الآن التوجه إلى ChatGPT أو Gemini ولصق النص للحصول على التقرير.");
                } catch (err) {
                    console.error('Failed to copy: ', err);
                    alert("حدث خطأ أثناء النسخ. يرجى المحاولة مرة أخرى.");
                }
            }

            renderAIReport(content) { const cleanHtml = (content || "").replace(/```html/g, '').replace(/```/g, ''); document.getElementById('aiReportContent').innerHTML = cleanHtml; }

            async enhanceReportWithAI() {
                const topic = document.getElementById('repLessonTopic').innerText; 
                const specialization = document.getElementById('repSpecialization').innerText; 
                
                if(!topic || topic === '-' || topic === 'عام') return alert('يرجى تحديد عنوان الدرس وتخصص المعلم بدقة للحصول على تقرير ذكي.');

                try {
                    document.getElementById('aiLoadingOverlay').classList.remove('hidden-view');
                    const reportText = this.buildPlainTextReport(); 
                    const gender = this.state.supervisionData.gender;

                    if (!this.auth || !this.auth.currentUser) {
                         throw new Error("يجب تسجيل الدخول لاستخدام الميزات السحابية المتقدمة.");
                    }

                    const token = await this.auth.currentUser.getIdToken(true);
                    const url = this.state.cloudFunctionUrl || "https://improvetext-cewovb6fwq-uc.a.run.app";
                    
                    const response = await fetch(url, { 
                        method: "POST", 
                        headers: { 
                            "Content-Type": "application/json", 
                            "Authorization": `Bearer ${token}` 
                        }, 
                        body: JSON.stringify({ 
                            text: reportText, 
                            gender: gender, 
                            specialization: specialization, 
                            topic: topic 
                        }) 
                    });

                    if (!response.ok) { 
                        const errJson = await response.json().catch(() => ({}));
                        console.warn("Cloud Function Failed:", errJson);
                        throw new Error(errJson.message || errJson.error || "خطأ في الاتصال بالخدمة السحابية"); 
                    }
                    
                    const data = await response.json(); 
                    const resultHtml = data.result || data.text;

                    if (!resultHtml) throw new Error("لم يتم استلام أي نص من الذكاء الاصطناعي.");
                    
                    this.renderAIReport(resultHtml);

                } catch (e) { 
                    console.error("AI Process Error:", e); 
                    alert("فشل المعالجة السحابية: " + e.message); 
                } finally { 
                    document.getElementById('aiLoadingOverlay').classList.add('hidden-view'); 
                }
            }

            saveAISettings() { /* Deprecated for auto-save, logic moved to saveDevSettings */ }
            
            enableDevEdit() {
                const inputs = document.querySelectorAll('#developerSettingsSection input');
                inputs.forEach(input => input.disabled = false);
            }

            saveDevSettings() {
                this.state.cloudFunctionUrl = document.getElementById('settingCloudUrl').value;
                this.state.apiKey = document.getElementById('settingApiKey').value;
                this.saveData();
                const inputs = document.querySelectorAll('#developerSettingsSection input');
                inputs.forEach(input => input.disabled = true);
                alert('تم تحديث الإعدادات الأمنية بنجاح.');
            }
            
            handleCriteriaExcel(e) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(ws, {header: 1});
                        const criteriaMap = {};
                        let importCount = 0;
                        for (let i = 1; i < json.length; i++) {
                            const row = json[i];
                            if (!row || row.length < 3) continue;
                            const title = row[0]; // Col A
                            if (!title) continue;
                            const subtitle = row[1] || ""; // Col B
                            let ratingVal = row[2]; // Col C
                            const desc = row[3] || ""; // Col D
                            const rec = row[4] || ""; // Col E
                            const ratingMatch = String(ratingVal).match(/\d+/);
                            const rating = ratingMatch ? parseInt(ratingMatch[0]) : 0;
                            if (!criteriaMap[title]) {
                                criteriaMap[title] = {
                                    id: Date.now() + i,
                                    title: title,
                                    subtitle: subtitle,
                                    items: {}
                                };
                            }
                            if (rating >= 1 && rating <= 5) {
                                criteriaMap[title].items[rating] = { desc, rec };
                                importCount++;
                            }
                        }
                        const newCriteriaList = Object.values(criteriaMap);
                        if (newCriteriaList.length > 0) {
                            this.state.evaluationCriteria = newCriteriaList;
                            this.saveData();
                            alert(`تم استيراد قاعدة البيانات بنجاح!\nعدد المعايير: ${newCriteriaList.length}\nعدد البنود: ${importCount}`);
                            this.closeModal('modal-settings');
                        } else {
                            alert("لم يتم العثور على بيانات صالحة في الملف. يرجى التأكد من ترتيب الأعمدة.");
                        }
                    } catch (err) {
                        console.error("Excel Import Error:", err);
                        alert("حدث خطأ أثناء قراءة الملف. تأكد من أنه ملف Excel صالح.");
                    }
                };
                reader.readAsArrayBuffer(e.target.files[0]);
            }

            deleteData() {
                if (confirm('تحذير: سيتم حذف جميع البيانات المخزنة (المعلمين، السجل، المهام) وإعادة التطبيق لحالة المصنع.\n\nهل أنت متأكد تماماً؟')) {
                    if (confirm('تأكيد نهائي: هل ترغب بحذف كل شيء؟')) {
                        localStorage.removeItem('school_data_v1');
                        if (this.state.currentUser && this.db) {
                            this.db.collection("users").doc(this.state.currentUser.uid).set({
                                teachers: [], periods: [], classes: {}, tasks: [], agenda: [],
                                violationTypes: this.state.violationTypes, 
                                supervisionHistory: [],
                                evaluationCriteria: [],
                                dutyLocations: [],
                                dutySchedule: {}
                            }, { merge: true });
                        }
                        alert('تم حذف البيانات بنجاح.');
                        location.reload();
                    }
                }
            }

            renderAll() { const activeBtn = document.querySelector('.nav-btn.text-omani-green'); let currentView = activeBtn ? activeBtn.id.replace('btn-', '') : 'now'; if(currentView === 'now') { this.renderCurrentPeriod(new Date(new Date().getTime() + this.state.simulationOffset)); this.renderDailyDutyWidget(new Date(new Date().getTime() + this.state.simulationOffset)); } else if (currentView === 'teachers') this.renderTeachers(); else if (currentView === 'reports') this.renderReports(); else if (currentView === 'tasks') this.renderTasks(); else if (currentView === 'agenda') this.renderAgenda(); else if (currentView === 'supervision-hub') this.renderSupervisionHub(); else if (currentView === 'duty') this.renderDutyTable(); }
            
            renderCurrentPeriod(now) { 
                const mins = now.getHours() * 60 + now.getMinutes(); 
                const currentPeriod = this.state.periods.find(p => { 
                    const [sh, sm] = p.start.split(':').map(Number); 
                    const [eh, em] = p.end.split(':').map(Number); 
                    return mins >= (sh*60+sm) && mins <= (eh*60+em); 
                }); 
                const infoDiv = document.getElementById('currentPeriodInfo'); 
                if(infoDiv) {
                    if (currentPeriod) {
                        const [eh, em] = currentPeriod.end.split(':').map(Number);
                        const endTime = new Date(now);
                        endTime.setHours(eh, em, 0, 0);
                        const diff = Math.floor((endTime.getTime() - now.getTime()) / 1000);
                        const m = Math.floor(diff / 60);
                        const s = diff % 60;
                        const countdown = `${m}:${s < 10 ? '0'+s : s}`;
                        infoDiv.innerHTML = `<div class="flex items-center gap-4 bg-emerald-50 px-5 py-3 rounded-xl border border-emerald-100 shadow-inner"><span class="text-omani-green font-bold text-lg">الحصة ${currentPeriod.id}</span><span class="text-emerald-300">|</span><span class="text-emerald-700 font-mono text-base tracking-widest">${currentPeriod.start} - ${currentPeriod.end}</span><span class="text-emerald-300">|</span><span class="text-red-500 font-mono font-bold text-sm flex items-center gap-1 animate-pulse"><i class="fas fa-hourglass-half text-xs"></i> ${countdown}</span></div>`; 
                    } else {
                        infoDiv.innerHTML = `<div class="bg-stone-50 text-stone-500 px-5 py-3 rounded-xl border border-stone-200 font-bold text-sm flex items-center gap-2"><i class="fas fa-coffee"></i> لا توجد حصص نشطة حالياً</div>`;
                    }
                } 
                this.renderActiveClasses(now, currentPeriod); 
            }
            
            renderActiveClasses(now, period) { 
                const grid = document.getElementById('activeClassesGrid'); 
                if(!grid) return; 
                
                if(!period) { 
                    grid.innerHTML = `<div class="col-span-full py-20 text-center text-slate-400 bg-white rounded-3xl border border-dashed border-stone-200 shadow-sm flex flex-col items-center justify-center gap-4"><div class="w-16 h-16 bg-stone-50 rounded-full flex items-center justify-center text-2xl"><i class="fas fa-school-circle-xmark text-stone-300"></i></div><p class="text-sm font-medium">لا توجد حصص في الوقت الحالي</p></div>`; 
                    return; 
                } 
                
                const dayId = now.getDay() + 1; 
                const pId = parseInt(period.id); 
                let active = []; 
                
                this.state.teachers.forEach(t => { 
                    const l = t.lessons.find(ls => ls.day === dayId && ls.period === pId); 
                    if(l) active.push({ t, className: l.className }); 
                }); 
                
                active.sort((a, b) => { 
                    const gA = (a.className.match(/\\d+/) || [999])[0], gB = (b.className.match(/\\d+/) || [999])[0]; 
                    return parseInt(gA) - parseInt(gB); 
                }); 
                
                grid.innerHTML = active.map(item => `<div class="group bg-white rounded-2xl shadow-sm hover:shadow-lg transition-all duration-300 border border-stone-100 overflow-hidden relative flex flex-col hover:-translate-y-1"><div class="h-1.5 w-full bg-omani-green"></div><div class="p-4 flex-1 flex flex-col"><div class="flex justify-between items-center mb-3"><span class="bg-stone-50 text-slate-700 px-3 py-1 rounded-lg text-xs font-bold border border-stone-200 truncate max-w-[70%]">${item.className}</span><div class="w-8 h-8 rounded-full bg-emerald-50 text-omani-green flex items-center justify-center text-xs font-bold border border-emerald-100 shadow-sm">${item.t.short[0] || '?'}</div></div><h3 class="font-bold text-sm text-slate-800 mb-1 truncate">${item.t.name}</h3><div class="flex items-center gap-1 text-[10px] text-slate-400 mb-4"><i class="fas fa-star text-yellow-400"></i> <span>${item.t.score}%</span></div><button type="button" onclick="window.app.openActionModal('${item.t.id}', '${item.className}')" class="mt-auto w-full py-2.5 rounded-xl bg-stone-50 hover:bg-emerald-50 text-slate-600 hover:text-emerald-700 font-bold text-xs transition-colors flex justify-center items-center gap-2 cursor-pointer border border-stone-200 hover:border-emerald-200"><i class="fas fa-cog"></i> إجراء سريع</button></div></div>`).join(''); 
            }
            renderTeachers() { const term = document.getElementById('teacherSearch').value.toLowerCase(); const grid = document.getElementById('teachersGrid'); if(!grid) return; let filtered = this.state.teachers.filter(t => t.name.toLowerCase().includes(term) || (t.school && t.school.toLowerCase().includes(term))); filtered.sort((a,b) => a.name.localeCompare(b.name, 'ar')); grid.innerHTML = filtered.map(t => { let scoreColor = t.score >= 90 ? "bg-emerald-50 text-emerald-600 border-emerald-100" : (t.score >= 70 ? "bg-yellow-50 text-yellow-600 border-yellow-100" : "bg-red-50 text-red-600 border-red-100"); const schoolBadge = t.school ? `<div class="text-[10px] text-slate-500 flex items-center gap-1 mt-1 bg-white px-2 py-0.5 rounded w-fit border border-stone-100"><i class="fas fa-school text-indigo-400"></i> ${t.school}</div>` : ''; return `<div class="bg-white rounded-2xl shadow-sm hover:shadow-lg transition border border-stone-100 p-5 flex flex-col gap-4 group hover:-translate-y-1"><div class="flex justify-between items-start"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-omani-green to-teal-700 text-white flex items-center justify-center font-bold text-lg shadow-md shadow-emerald-900/10">${t.short[0] || '?'}</div><div><h3 class="font-bold text-slate-800 line-clamp-1 text-sm">${t.name}</h3><p class="text-xs text-omani-green mt-0.5 font-bold">${t.specialization || 'معلم مادة'}</p>${schoolBadge}</div></div><div class="font-bold text-xs px-2 py-1 rounded-lg border ${scoreColor}">${t.score}%</div></div><div class="relative group/input"><i class="fas fa-phone absolute right-3 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within/input:text-omani-green transition-colors"></i><input type="tel" value="${t.phone || ''}" onchange="window.app.updatePhone('${t.id}', this.value)" placeholder="أضف رقم الهاتف" class="w-full pr-9 pl-3 py-2.5 text-sm rounded-xl border border-stone-200 bg-stone-50 focus:bg-white focus:border-omani-green focus:ring-1 focus:ring-omani-green outline-none transition-all dir-rtl font-mono"></div><div class="flex gap-2 mt-auto pt-3 border-t border-stone-50"><button type="button" onclick="window.app.openActionModal('${t.id}')" class="flex-1 bg-white hover:bg-stone-50 text-slate-500 hover:text-slate-800 border border-stone-200 py-2 rounded-lg text-xs font-bold transition cursor-pointer">خيارات</button><button type="button" onclick="window.app.openWhatsApp('${t.id}')" class="w-10 flex items-center justify-center bg-emerald-50 hover:bg-emerald-100 text-emerald-600 border border-emerald-200 rounded-lg transition cursor-pointer"><i class="fab fa-whatsapp text-lg"></i></button></div></div>`; }).join(''); }
            renderAgenda() { const tbody = document.getElementById('agendaBody'); if(!tbody) return; const agenda = this.state.agenda || []; if(agenda.length === 0) { tbody.innerHTML = `<tr><td colspan="3" class="p-8 text-center text-slate-400 bg-stone-50 rounded-lg border-2 border-dashed border-stone-200">لا توجد أحداث مسجلة.</td></tr>`; return; } agenda.sort((a,b) => new Date(a.date).getTime() - new Date(b.date).getTime()); const todayStr = new Date().toISOString().split('T')[0]; tbody.innerHTML = agenda.map((item, index) => { const itemDateStr = new Date(item.date).toISOString().split('T')[0]; const isToday = itemDateStr === todayStr; return `<tr class="${isToday ? 'today-row' : 'hover:bg-stone-50'} transition-colors border-b border-stone-100 last:border-0"><td class="p-4 text-center font-bold text-slate-400">${index + 1}</td><td class="p-4 font-mono text-sm text-omani-green">${item.date}</td><td class="p-4 font-bold text-slate-800">${item.event}</td></tr>`; }).join(''); }
            verifyAdminAndImportAgenda() { if(prompt('PIN:') === '1234') document.getElementById('agendaInput').click(); else alert('خطأ'); }
            handleAgendaExcel(e) { const reader = new FileReader(); reader.onload = (evt) => { const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'}); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1}); const newAgenda = []; for(let i = 1; i < json.length; i++) { const row = json[i]; if(row && row.length >= 3) { let dateVal = row[1]; if(typeof dateVal === 'number') dateVal = new Date(Math.round((dateVal - 25569)*86400*1000)).toISOString().split('T')[0]; newAgenda.push({ id: Date.now() + i, date: dateVal, event: row[2] }); } } if(newAgenda.length > 0) { this.state.agenda = newAgenda; this.saveData(); this.renderAgenda(); alert('تم'); } else alert('تنسيق غير صالح'); }; reader.readAsArrayBuffer(e.target.files[0]); }
            renderReports() { const tbody = document.getElementById('reportsBody'); if(!tbody) return; tbody.innerHTML = this.state.teachers.map(t => { let badge = t.score >= 90 ? "bg-emerald-50 text-emerald-700 border border-emerald-100" : (t.score >= 70 ? "bg-yellow-50 text-yellow-700 border border-yellow-100" : "bg-red-50 text-red-700 border border-red-100"); return `<tr class="hover:bg-stone-50 transition-colors group"><td class="p-5 font-semibold text-slate-700"><div class="flex items-center gap-4"><div class="w-10 h-10 rounded-xl bg-stone-100 text-slate-500 flex items-center justify-center text-xs font-bold shadow-sm">${t.short[0] || '?'}</div><div><div class="text-sm font-bold">${t.name}</div><div class="text-[10px] text-slate-400 font-normal mt-0.5">${t.school || ''}</div></div></div></td><td class="p-5 text-center"><span class="inline-block px-3 py-1 rounded-full text-xs font-bold ${badge}">${t.score}%</span></td><td class="p-5 text-center text-slate-500 font-mono text-sm tracking-wider">${t.phone || '-'}</td><td class="p-5 text-center">${t.score < 80 ? '<span class="text-[10px] text-red-500 font-bold bg-red-50 px-2 py-1 rounded border border-red-100 flex items-center justify-center gap-1 w-fit mx-auto"><i class="fas fa-circle text-[6px]"></i> يحتاج متابعة</span>' : '<span class="text-[10px] text-emerald-600 font-bold bg-emerald-50 px-2 py-1 rounded border border-emerald-100 flex items-center justify-center gap-1 w-fit mx-auto"><i class="fas fa-check-circle text-xs"></i> ممتاز</span>'}</td></tr>`; }).join(''); }
            addTask() { const text = document.getElementById('newTaskInput').value.trim(); if(text) { this.state.tasks.unshift({id:Date.now().toString(), text, priority: document.getElementById('newTaskPriority').value, completed:false}); this.saveData(); this.renderTasks(); document.getElementById('newTaskInput').value=''; } }
            toggleTask(id) { const t = this.state.tasks.find(x=>x.id===id); if(t) { t.completed=!t.completed; this.saveData(); this.renderTasks(); } }
            deleteTask(id) { if(confirm('حذف؟')) { this.state.tasks = this.state.tasks.filter(x=>x.id!==id); this.saveData(); this.renderTasks(); } }
            renderTasks() { const list = document.getElementById('tasksList'); if(!list) return; const completed = this.state.tasks.filter(t=>t.completed).length; document.getElementById('tasksProgressBar').style.width = (this.state.tasks.length ? Math.round((completed/this.state.tasks.length)*100) : 0) + '%'; document.getElementById('tasksProgressText').innerText = `${completed}/${this.state.tasks.length} مكتمل`; list.innerHTML = this.state.tasks.length === 0 ? `<div class="text-center p-8 text-slate-400 bg-stone-50 rounded-xl border border-dashed border-stone-200"><p class="text-xs">لا توجد مهام.</p></div>` : this.state.tasks.map(t => `<div class="flex items-center gap-3 bg-white p-4 rounded-xl border border-stone-200 shadow-sm transition hover:shadow-md group hover:border-omani-green/30"><label class="relative flex items-center cursor-pointer"><input type="checkbox" class="task-checkbox sr-only peer" ${t.completed?'checked':''} onchange="window.app.toggleTask('${t.id}')"><div class="w-6 h-6 bg-stone-50 border-2 border-stone-300 rounded-full peer-checked:bg-omani-green peer-checked:border-omani-green transition-all flex items-center justify-center text-white shadow-sm"><i class="fas fa-check text-xs ${t.completed?'opacity-100':'opacity-0'}"></i></div></label><div class="flex-1 ${t.completed?'line-through text-slate-400':'text-slate-800'}"><p class="text-sm font-bold">${t.text}</p></div><span class="text-[10px] px-2 py-0.5 rounded border ${t.priority==='urgent'?'bg-red-50 text-red-600 border-red-100':'bg-blue-50 text-blue-600 border-blue-100'} font-bold shadow-sm">${t.priority==='urgent'?'عاجل':'عادي'}</span><button onclick="window.app.deleteTask('${t.id}')" class="text-slate-300 hover:text-red-500 transition px-2 opacity-0 group-hover:opacity-100"><i class="fas fa-trash-alt"></i></button></div>`).join(''); }
            renderHistory() { const grid = document.getElementById('supervisionHistoryGrid'); if(!grid) return; const history = this.state.supervisionHistory || []; if(history.length === 0) { grid.innerHTML = '<div class="text-center p-10 text-slate-400 bg-stone-50 rounded-xl border border-dashed border-stone-200">لا يوجد سجل.</div>'; return; } history.sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime()); grid.innerHTML = history.map((v, i) => `<div class="bg-white p-5 rounded-2xl border border-stone-200 shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center gap-4 hover:border-omani-green/30 transition hover:shadow-md"><div class="flex-1"><div class="flex items-center gap-3 mb-1"><span class="font-bold text-slate-800 text-lg">${v.teacherName}</span><span class="bg-stone-50 text-slate-500 text-xs px-2 py-0.5 rounded border border-stone-200 font-bold">${v.className}</span></div><p class="text-sm text-slate-500 mb-1 flex items-center gap-2"><i class="fas fa-book-open text-omani-gold text-xs"></i> ${v.topic}</p><span class="text-xs text-slate-400 font-mono bg-stone-50 px-2 py-0.5 rounded">${v.date}</span></div><div class="flex gap-2 w-full md:w-auto"><button onclick="window.app.loadVisit(${i})" class="flex-1 md:flex-none bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-100 px-5 py-2.5 rounded-xl font-bold text-xs transition cursor-pointer shadow-sm"><i class="fas fa-eye"></i> عرض</button><button onclick="window.app.deleteVisit(${i})" class="md:flex-none text-red-400 hover:text-red-600 px-3 py-2 rounded-xl transition cursor-pointer hover:bg-red-50"><i class="fas fa-trash"></i></button></div></div>`).join(''); }
            updatePhone(id, val) { const t = this.state.teachers.find(x => x.id === id); if(t) { t.phone = val; this.saveData(); } }
            openActionModal(tId, className = null) { this.state.selectedTeacherId = tId; this.state.selectedClassName = className; const t = this.state.teachers.find(x => x.id === tId); if(!t) return; document.getElementById('actionModalTitle').innerHTML = `${t.name}`; document.getElementById('actionModalSubtitle').innerText = className && className !== 'undefined' ? `الحصة الحالية: ${className}` : 'قائمة الإدارة'; document.getElementById('currentScoreDisplay').innerText = t.score + '%'; const remind = document.getElementById('btn-remind'); const evalBtn = document.getElementById('btn-evaluate'); if(className && className !== 'undefined') { remind.disabled=false; remind.classList.remove('opacity-50','cursor-not-allowed'); evalBtn.onclick=()=>{this.closeModal('modal-action');this.startSupervision(tId,className);}; } else { remind.disabled=true; remind.classList.add('opacity-50','cursor-not-allowed'); evalBtn.onclick=()=>{this.closeModal('modal-action');this.startSupervision(tId,'زيارة عامة');}; } document.getElementById('violationButtonsContainer').innerHTML = this.state.violationTypes.map(v => `<button type="button" onclick="window.app.dockScore('${v.id}')" class="w-full bg-white hover:bg-red-50 text-slate-700 hover:text-red-700 border border-stone-200 hover:border-red-200 p-3 rounded-xl flex items-center justify-between transition group cursor-pointer shadow-sm"><span class="flex items-center gap-3 font-bold text-sm"><div class="w-8 h-8 rounded-full bg-stone-50 border border-stone-200 flex items-center justify-center text-slate-400 group-hover:text-red-500 group-hover:border-red-200 transition"><i class="fas ${v.icon}"></i></div>${v.label}</span><span class="bg-white px-2 py-1 rounded text-xs font-bold text-red-500 border border-stone-200 group-hover:border-red-200 shadow-sm font-mono">-${v.points}</span></button>`).join(''); document.getElementById('modal-action').classList.remove('hidden-view'); }
            closeModal(id) { document.getElementById(id)?.classList.add('hidden-view'); }
            loadVisit(index) { const sorted = [...this.state.supervisionHistory].sort((a,b)=>new Date(b.date).getTime()-new Date(a.date).getTime()); const visit=sorted[index]; if(visit){this.state.supervisionData={ratings:visit.ratings,notes:visit.notes||{}, gender: visit.gender || 'male' };this.generateReport(true,visit);} }
            deleteVisit(index) { if(confirm('حذف؟')) { const sorted = [...this.state.supervisionHistory].sort((a,b)=>new Date(b.date).getTime()-new Date(a.date).getTime()); const id=sorted[index].id; this.state.supervisionHistory=this.state.supervisionHistory.filter(x=>x.id!==id); this.saveData(); this.renderHistory(); } }
            sendWhatsApp(type) { const t = this.state.teachers.find(x => x.id === this.state.selectedTeacherId); if(!t || !t.phone) return alert('أضف الهاتف أولاً'); let msg = type === 'summon' ? `السلام عليكم أستاذ ${t.name}، يرجى التكرم بزيارة مكتب الإدارة.` : `السلام عليكم أستاذ ${t.name}، تذكير بموعد حصتكم الحالية في الصف ${this.state.selectedClassName}.`; window.open(`https://wa.me/${t.phone}?text=${encodeURIComponent(msg)}`, '_blank'); }
            openWhatsApp(id) { const t = this.state.teachers.find(x => x.id === id); if(t && t.phone) window.open(`https://wa.me/${t.phone}`, '_blank'); else alert('أضف الهاتف أولاً'); }
            dockScore(vId) { const v = this.state.violationTypes.find(x => x.id === vId); if(v && confirm(`خصم ${v.points}؟`)) { const t = this.state.teachers.find(x => x.id === this.state.selectedTeacherId); if(t) { t.score = Math.max(0, t.score - v.points); this.saveData(); this.closeModal('modal-action'); } } }
            handleXml(e) { const reader = new FileReader(); reader.readAsText(e.target.files[0], "windows-1256"); reader.onload = (evt) => { try { const xml = new DOMParser().parseFromString(evt.target.result, "text/xml"); this.state.periods = Array.from(xml.querySelectorAll('periods period')).map(p => ({ id: p.getAttribute('period'), start: p.getAttribute('starttime'), end: p.getAttribute('endtime') })); const classes = {}; xml.querySelectorAll('classes class').forEach(c => classes[c.getAttribute('id')] = c.getAttribute('name')); this.state.classes = classes; this.state.teachers = Array.from(xml.querySelectorAll('teachers teacher')).map(t => ({ id: t.getAttribute('id'), name: t.getAttribute('name'), short: t.getAttribute('short'), score: 100, phone: '', lessons: [] })); xml.querySelectorAll('TimeTableSchedules TimeTableSchedule').forEach(sch => { const t = this.state.teachers.find(x => x.id === sch.getAttribute('TeacherID')); if(t) t.lessons.push({ day: parseInt(sch.getAttribute('DayID')), period: parseInt(sch.getAttribute('Period')), className: classes[sch.getAttribute('ClassID')] || 'نشاط' }); }); this.saveData(); this.closeModal('modal-settings'); alert('تم'); } catch(err) { alert('خطأ'); } }; }
            exportTeacherTemplate() { const data = this.state.teachers.map(t => ({ 'Teacher_ID': t.id, 'Short_Name': t.short, 'Full_Name': t.name, 'Phone': t.phone, 'School_Name': t.school || '', 'Specialization': t.specialization || '' })); const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Teachers_Data"); XLSX.writeFile(wb, "Teachers_Supervisor_Data.xlsx"); }
            handleExcel(e) { 
                const reader = new FileReader(); 
                reader.onload = (evt) => { 
                    try {
                        const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'}); 
                        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); 
                        let added = 0; let updated = 0;
                        json.forEach(row => {
                            const tId = row['Teacher_ID'] || row['الرقم_الوظيفي'] || row['id'];
                            if (!tId) return;
                            const idStr = String(tId).trim();
                            const existingIndex = this.state.teachers.findIndex(t => t.id === idStr);
                            const name = row['Full_Name'] || row['الاسم_الكامل'] || row['name'] || 'معلم بدون اسم';
                            const phone = row['Phone'] || row['الهاتف'] || '';
                            const school = row['School_Name'] || row['المدرسة'] || '';
                            const spec = row['Specialization'] || row['التخصص'] || '';
                            const short = row['Short_Name'] || name.split(' ').slice(0, 2).join(' ');
                            if (existingIndex > -1) { const t = this.state.teachers[existingIndex]; t.name = name; if (phone) t.phone = String(phone); if (spec) t.specialization = spec; if (school) t.school = school; updated++; } 
                            else { this.state.teachers.push({ id: idStr, name: name, short: short, phone: String(phone), specialization: spec, school: school, score: 100, lessons: [] }); added++; }
                        });
                        this.saveData(); this.renderTeachers(); 
                        alert(`تمت العملية بنجاح.\n- تم تحديث: ${updated} معلم.\n- تم إضافة: ${added} معلم جديد.`); 
                        this.closeModal('modal-settings'); document.getElementById('excelInput').value = '';
                    } catch (err) { console.error(err); alert('حدث خطأ أثناء معالجة الملف. تأكد من صحة التنسيق.'); }
                }; 
                reader.readAsArrayBuffer(e.target.files[0]); 
            }
            exportReports() { const data = this.state.teachers.map(t => ({ 'المعلم': t.name, 'التقييم': t.score+'%', 'الهاتف': t.phone||'-' })); const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Reports"); XLSX.writeFile(wb, "School_Report.xlsx"); }
            
            simulateRandomPeriod() { 
                if(!this.state.periods.length) return alert('لا يوجد جدول'); 
                
                // Select random period
                const r = this.state.periods[Math.floor(Math.random()*this.state.periods.length)]; 
                const [h,m] = r.start.split(':').map(Number); 
                
                let t = new Date();
                
                // Force weekday (Sunday=0 to Thursday=4)
                const currentDay = t.getDay(); 
                
                // We pick a random target day index (0=Sun, 4=Thu)
                const targetDay = Math.floor(Math.random() * 5); 
                
                // Calculate difference to shift date
                let diff = targetDay - currentDay;
                
                // Adjust date
                t.setDate(t.getDate() + diff);
                t.setHours(h, m, 0, 0);

                // Simulation offset
                this.state.simulationOffset = t.getTime() - new Date().getTime(); 
                
                this.renderCurrentPeriod(t); 
                this.renderDailyDutyWidget(t); 
                
                // Visual feedback
                 const clock = document.getElementById('clockDisplay');
                if(clock) {
                    clock.style.color = '#fbbf24';
                    setTimeout(() => clock.style.color = '', 500);
                }
            }

            resetTimeToReal() { this.state.simulationOffset = 0; const now = new Date(); this.renderCurrentPeriod(now); this.renderDailyDutyWidget(now); }
            startClock() { setInterval(() => { const n = new Date(new Date().getTime() + this.state.simulationOffset); document.getElementById('clockDisplay').innerText = n.toLocaleTimeString('en-US',{hour12:false}); this.renderCurrentPeriod(n); }, 1000); }
            renderViolationsSettings() { const list = document.getElementById('violationsList'); if(!list) return; list.innerHTML = this.state.violationTypes.map(v => `<div class="flex items-center justify-between bg-white p-3 rounded-lg border border-stone-200 shadow-sm group hover:border-red-100 transition"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded bg-stone-100 text-slate-400 flex items-center justify-center"><i class="fas ${v.icon}"></i></div><span class="font-bold text-sm text-slate-700">${v.label}</span></div><div class="flex items-center gap-3"><span class="bg-red-50 text-red-600 text-xs font-bold px-2 py-1 rounded border border-red-100 font-mono">-${v.points}</span><button type="button" onclick="window.app.removeViolation('${v.id}')" class="text-slate-300 hover:text-red-500 transition px-2 cursor-pointer"><i class="fas fa-trash-alt"></i></button></div></div>`).join(''); }
            renderSpecializationsSettings() { const list = document.getElementById('specializationsList'); if(!list) return; list.innerHTML = (this.state.specializations || []).map((s, index) => `<div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-full border border-stone-200 shadow-sm text-xs font-bold text-slate-700 group hover:border-omani-green/30">${s}<button onclick="window.app.removeSpecialization(${index})" class="text-slate-400 hover:text-red-500 transition cursor-pointer"><i class="fas fa-times"></i></button></div>`).join(''); }
            addSpecialization() { const input = document.getElementById('newSpecInput'); const val = input.value.trim(); if(val && !this.state.specializations.includes(val)) { this.state.specializations.push(val); input.value = ''; this.saveData(); this.renderSpecializationsSettings(); } }
            removeSpecialization(index) { if(confirm('حذف هذا التخصص؟')) { this.state.specializations.splice(index, 1); this.saveData(); this.renderSpecializationsSettings(); } }
            addViolation() { const label = document.getElementById('newViolationLabel').value; const points = parseInt(document.getElementById('newViolationPoints').value); if(label && points) { this.state.violationTypes.push({ id: Date.now().toString(), label, points, icon: 'fa-exclamation-circle' }); document.getElementById('newViolationLabel').value=''; this.saveData(); this.renderViolationsSettings(); } }
            removeViolation(id) { this.state.violationTypes = this.state.violationTypes.filter(v => v.id !== id); this.saveData(); this.renderViolationsSettings(); }
            setTheme(themeName) { this.state.theme = themeName; this.applyTheme(); this.saveData(); this.renderThemeSelector(); }
            applyTheme() { document.body.classList.remove('theme-pink', 'theme-green', 'theme-dark'); if (this.state.theme && this.state.theme !== 'default') document.body.classList.add(`theme-${this.state.theme}`); }
            renderThemeSelector() { const container = document.getElementById('themeSelectorContainer'); if (!container) return; const themes = [{ id: 'default', name: 'أساسي', colorClass: 'bg-indigo-600', activeClass: 'border-indigo-500' }, { id: 'pink', name: 'زهري', colorClass: 'bg-pink-600', activeClass: 'border-pink-500' }, { id: 'green', name: 'أخضر', colorClass: 'bg-green-600', activeClass: 'border-green-500' }, { id: 'dark', name: 'داكن', colorClass: 'bg-slate-800 border border-slate-600', activeClass: 'border-slate-300' }]; container.innerHTML = themes.map(theme => { const isActive = this.state.theme === theme.id; const borderClass = isActive ? theme.activeClass : 'border-transparent'; return `<button onclick="window.app.setTheme('${theme.id}')" class="p-2 rounded-lg border-2 transition ${borderClass}"><div class="w-full h-10 rounded ${theme.colorClass}"></div><span class="text-xs font-bold mt-2 block text-center text-slate-500">${theme.name}</span></button>`; }).join(''); }
            setDefaultSchoolGender(gender) { if (gender === 'male' || gender === 'female') { this.state.defaultSchoolGender = gender; this.saveData(); } }
            renderSchoolGenderSettings() { const radios = document.getElementsByName('defaultSchoolGender'); for (const radio of radios) { if (radio.value === this.state.defaultSchoolGender) { radio.checked = true; } } }
            openSettings() { 
                this.renderViolationsSettings(); 
                this.renderSpecializationsSettings(); 
                this.renderThemeSelector(); 
                this.renderSchoolGenderSettings(); 
                const devSection = document.getElementById('developerSettingsSection');
                if (this.state.currentUser && this.state.currentUser.email === 'alsaher9@gmail.com') {
                    devSection.classList.remove('hidden-view');
                    document.getElementById('settingCloudUrl').value = this.state.cloudFunctionUrl || '';
                    document.getElementById('settingApiKey').value = this.state.apiKey || '';
                } else {
                    devSection.classList.add('hidden-view');
                }
                document.getElementById('modal-settings').classList.remove('hidden-view'); 
            }

            // --- Duty System Methods ---

            renderDutyTable() {
                const headerRow = document.getElementById('dutyHeaderRow');
                const dutyBody = document.getElementById('dutyBody');
                if (!headerRow || !dutyBody) return;

                // Render Headers
                headerRow.innerHTML = '';
                this.state.dutyLocations.forEach((loc, index) => {
                    const th = document.createElement('th');
                    th.className = "p-4 font-bold text-center border-l border-stone-200 text-slate-600";
                    th.innerText = loc;
                    headerRow.appendChild(th);
                });

                // Render Rows
                dutyBody.innerHTML = '';
                const days = ["الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس"];
                
                days.forEach((day, dayIndex) => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-stone-50 transition-colors border-b border-stone-100 group";
                    
                    // Day Cell (Sticky)
                    const tdDay = document.createElement('td');
                    tdDay.className = "p-4 font-bold text-omani-green bg-stone-50 group-hover:bg-stone-50 sticky right-0 z-10 border-l border-stone-200";
                    tdDay.innerText = day;
                    tr.appendChild(tdDay);

                    // Location Cells
                    this.state.dutyLocations.forEach((loc, locIndex) => {
                        const td = document.createElement('td');
                        td.className = "p-2 duty-cell relative group border-l border-stone-100";
                        
                        // Get current teacher
                        const teacherId = this.state.dutySchedule[dayIndex]?.[locIndex] || "";
                        
                        // Teacher Select
                        const select = document.createElement('select');
                        select.className = "w-full bg-transparent border-none outline-none text-xs font-bold text-slate-700 appearance-none cursor-pointer p-2 rounded hover:bg-stone-100 transition";
                        select.onchange = (e) => this.updateDuty(dayIndex, locIndex, e.target.value);
                        
                        const defaultOpt = document.createElement('option');
                        defaultOpt.value = "";
                        defaultOpt.text = "- اختر -";
                        select.add(defaultOpt);

                        const sortedTeachers = [...this.state.teachers].sort((a,b) => a.name.localeCompare(b.name, 'ar'));
                        sortedTeachers.forEach(t => {
                            const opt = document.createElement('option');
                            opt.value = t.id;
                            opt.text = t.name;
                            if(t.id === teacherId) opt.selected = true;
                            select.add(opt);
                        });
                        td.appendChild(select);

                        // Actions (Only if teacher selected)
                        if(teacherId) {
                            const actionDiv = document.createElement('div');
                            actionDiv.className = "duty-actions absolute top-1/2 -translate-y-1/2 left-2 flex gap-1 bg-white/95 backdrop-blur shadow-md p-1 rounded-lg border border-stone-100 z-20";
                            
                            // WhatsApp Button
                            const msgBtn = document.createElement('button');
                            msgBtn.className = "text-green-500 hover:text-green-700 w-7 h-7 flex items-center justify-center rounded-lg hover:bg-green-50 transition";
                            msgBtn.innerHTML = '<i class="fab fa-whatsapp"></i>';
                            msgBtn.title = "استفسار عن الغياب";
                            msgBtn.onclick = () => this.sendDutyMessage(teacherId, day, loc);
                            
                            // Flag Button
                            const flagBtn = document.createElement('button');
                            flagBtn.className = "text-red-400 hover:text-red-600 w-7 h-7 flex items-center justify-center rounded-lg hover:bg-red-50 transition";
                            flagBtn.innerHTML = '<i class="fas fa-user-times"></i>';
                            flagBtn.title = "تقييم / غياب";
                            flagBtn.onclick = () => this.handleDutyAbsence(teacherId, loc);

                            actionDiv.appendChild(msgBtn);
                            actionDiv.appendChild(flagBtn);
                            td.appendChild(actionDiv);
                        }

                        tr.appendChild(td);
                    });
                    dutyBody.appendChild(tr);
                });
            }

            updateDuty(dayIndex, locIndex, teacherId) {
                if(!this.state.dutySchedule[dayIndex]) this.state.dutySchedule[dayIndex] = {};
                this.state.dutySchedule[dayIndex][locIndex] = teacherId;
                this.saveData();
                this.renderDutyTable(); // Re-render to show actions
            }

            addDutyLocationPrompt() {
                const name = prompt("أدخل اسم موقع المناوبة الجديد:");
                if(name) {
                    this.state.dutyLocations.push(name);
                    this.saveData();
                    this.renderDutyTable();
                }
            }

            sendDutyMessage(teacherId, day, location) {
                const t = this.state.teachers.find(x => x.id === teacherId);
                if(!t || !t.phone) return alert('يرجى إضافة رقم الهاتف للمعلم أولاً');
                
                const msg = `السلام عليكم أستاذ ${t.name}،\nلوحظ عدم تواجدكم في مناوبة (${location}) ليوم ${day}.\nيرجى التكرم بالإفادة حول سبب التأخر أو الغياب.\nشكراً لتعاونكم.`;
                window.open(`https://wa.me/${t.phone}?text=${encodeURIComponent(msg)}`, '_blank');
            }

            handleDutyAbsence(teacherId, location) {
                const t = this.state.teachers.find(x => x.id === teacherId);
                if(!t) return;
                
                // Open standard action modal but configured for duty
                this.openActionModal(teacherId, `مناوبة: ${location}`);
                
                // Optional: Auto-scroll to violations in modal or highlight specific duty violation
            }

            renderDailyDutyWidget(date) {
                const widget = document.getElementById('dailyDutyWidget');
                const grid = document.getElementById('dailyDutyGrid');
                const dateEl = document.getElementById('dailyDutyDate');
                
                if(!widget || !grid) return;

                // Adjust JS day (0=Sun) to match our array
                const dayIndex = date.getDay();
                
                if(dayIndex > 4) { // Fri/Sat
                    widget.classList.add('hidden-view');
                    return;
                }

                widget.classList.remove('hidden-view');
                dateEl.innerText = date.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                const schedule = this.state.dutySchedule[dayIndex] || {};
                
                grid.innerHTML = this.state.dutyLocations.map((loc, index) => {
                    const teacherId = schedule[index];
                    const teacher = this.state.teachers.find(t => t.id === teacherId);
                    
                    return `
                    <div class="bg-white p-3 rounded-xl border border-stone-200 flex items-center justify-between group shadow-sm hover:border-omani-green/30 transition">
                        <div>
                            <div class="text-[10px] font-bold text-slate-400 mb-1">${loc}</div>
                            <div class="font-bold text-slate-800 text-sm">
                                ${teacher ? teacher.name : '<span class="text-slate-300 italic">غير محدد</span>'}
                            </div>
                        </div>
                        ${teacher ? `
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                             <button onclick="window.app.sendDutyMessage('${teacher.id}', '${date.toLocaleDateString('ar-EG', {weekday:'long'})}', '${loc}')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-emerald-50 text-emerald-600 hover:bg-emerald-100 transition cursor-pointer"><i class="fab fa-whatsapp"></i></button>
                             <button onclick="window.app.handleDutyAbsence('${teacher.id}', '${loc}')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-red-50 text-red-500 hover:bg-red-100 transition cursor-pointer"><i class="fas fa-exclamation"></i></button>
                        </div>
                        ` : ''}
                    </div>
                    `;
                }).join('');
            }
        }
        window.app = new SchoolApp();
    </script>
</body>
</html>