<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مدير المدرسة الذكي | Dashboard</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' },
                        primary: { 50:'#eff6ff', 100:'#dbeafe', 500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8', 900:'#1e3a8a' }
                    }
                }
            }
        }
    </script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { background-color: #f1f5f9; color: #1e293b; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Sidebar & Layout */
        .sidebar { transition: transform 0.3s ease; width: 280px; }
        .main-content { transition: margin-right 0.3s ease; }
        @media (min-width: 1024px) {
            .main-content { margin-right: 280px; }
        }
        @media (max-width: 1023px) {
            .sidebar { transform: translateX(100%); }
            .sidebar.active { transform: translateX(0); }
        }

        /* Utilities */
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .hidden-view { display: none !important; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Report Paper Style */
        .report-paper {
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            min-height: 29.7cm;
            padding: 2cm;
            margin: auto;
        }
        @media print {
            body * { visibility: hidden; }
            #view-supervision-report, #view-supervision-report * { visibility: visible; }
            #view-supervision-report { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; box-shadow: none; }
            .no-print { display: none !important; }
        }
        
        .nav-item.active { background-color: #eff6ff; color: #2563eb; border-right: 3px solid #2563eb; }
        
        /* Loading Spinner */
        .spinner { border: 3px solid rgba(0,0,0,0.1); border-radius: 50%; border-top: 3px solid #3b82f6; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
<script type="importmap">
{
  "imports": {
    "rxjs": "https://esm.sh/rxjs@^7.8.2?conditions=es2015",
    "rxjs/operators": "https://esm.sh/rxjs@^7.8.2/operators?conditions=es2015",
    "rxjs/ajax": "https://esm.sh/rxjs@^7.8.2/ajax?conditions=es2015",
    "rxjs/webSocket": "https://esm.sh/rxjs@^7.8.2/webSocket?conditions=es2015",
    "rxjs/testing": "https://esm.sh/rxjs@^7.8.2/testing?conditions=es2015",
    "rxjs/fetch": "https://esm.sh/rxjs@^7.8.2/fetch?conditions=es2015",
    "@angular/core": "https://esm.sh/@angular/core@^21.0.8?external=rxjs",
    "@angular/common": "https://esm.sh/@angular/common@^21.0.8?external=rxjs",
    "@angular/forms": "https://esm.sh/@angular/forms@^21.0.8?external=rxjs"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="antialiased overflow-x-hidden">

    <!-- Login View -->
    <div id="login-view" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-slate-900 bg-[url('https://images.unsplash.com/photo-1524178232363-1fb2b075b655?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80')] bg-cover bg-center">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm"></div>
        <div class="relative w-full max-w-md p-8 bg-white/10 backdrop-blur-md rounded-3xl border border-white/10 shadow-2xl text-center">
            <div class="w-20 h-20 mx-auto bg-blue-600 rounded-2xl flex items-center justify-center text-3xl text-white shadow-lg mb-6 transform -rotate-3 hover:rotate-0 transition duration-500">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h1 class="text-3xl font-extrabold text-white mb-2">مدير المدرسة <span class="text-blue-400">Pro</span></h1>
            <p class="text-slate-300 mb-8 font-light">منصة القيادة والإشراف التربوي الذكية</p>
            
            <button onclick="window.app.handleGoogleLogin()" class="w-full bg-white hover:bg-slate-50 text-slate-900 font-bold py-4 rounded-xl flex items-center justify-center gap-3 transition transform hover:-translate-y-1 shadow-lg cursor-pointer mb-4">
                <img src="https://www.google.com/favicon.ico" class="w-5 h-5" alt="Google">
                <span>تسجيل الدخول بحساب جوجل</span>
            </button>
            <button onclick="window.app.skipLogin()" class="w-full bg-white/10 hover:bg-white/20 text-white font-medium py-3 rounded-xl transition cursor-pointer border border-white/10">
                تجربة النظام كزائر
            </button>
        </div>
        <div class="absolute bottom-6 text-slate-500 text-xs font-mono">School Manager Pro v2.0</div>
    </div>

    <!-- Main App Wrapper -->
    <div id="app-view" class="hidden-view min-h-screen flex">
        
        <!-- Sidebar (Desktop) -->
        <aside class="sidebar fixed top-0 right-0 h-full bg-white border-l border-slate-200 z-30 flex flex-col shadow-xl lg:shadow-none">
            <div class="p-6 border-b border-slate-100 flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white text-lg shadow-blue-200 shadow-lg">
                    <i class="fas fa-school"></i>
                </div>
                <div>
                    <h2 class="font-bold text-slate-800 leading-tight">مدير المدرسة</h2>
                    <span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-bold">Pro</span>
                </div>
            </div>

            <nav class="flex-1 overflow-y-auto p-4 space-y-2">
                <p class="text-xs font-bold text-slate-400 px-4 mb-2 uppercase tracking-wider">القائمة الرئيسية</p>
                <button onclick="window.app.setView('now')" id="nav-now" class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition-all group font-medium">
                    <i class="fas fa-clock w-6 text-center group-hover:text-blue-600 transition-colors"></i> الحصص الحالية
                </button>
                <button onclick="window.app.setView('teachers')" id="nav-teachers" class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition-all group font-medium">
                    <i class="fas fa-chalkboard-teacher w-6 text-center group-hover:text-blue-600 transition-colors"></i> المعلمون
                </button>
                <button onclick="window.app.setView('supervision-hub')" id="nav-supervision-hub" class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition-all group font-medium">
                    <i class="fas fa-clipboard-check w-6 text-center group-hover:text-blue-600 transition-colors"></i> الإشراف والزيارات
                </button>
                <button onclick="window.app.setView('reports')" id="nav-reports" class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition-all group font-medium">
                    <i class="fas fa-chart-pie w-6 text-center group-hover:text-blue-600 transition-colors"></i> التقارير والإحصاء
                </button>
                <button onclick="window.app.setView('duty')" id="nav-duty" class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition-all group font-medium">
                    <i class="fas fa-shield-alt w-6 text-center group-hover:text-blue-600 transition-colors"></i> المناوبة
                </button>
                
                <div class="mt-8 border-t border-slate-100 pt-4">
                     <p class="text-xs font-bold text-slate-400 px-4 mb-2 uppercase tracking-wider">النظام</p>
                     <button onclick="window.app.openSettings()" class="w-full flex items-center gap-4 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition-all group font-medium">
                        <i class="fas fa-cog w-6 text-center group-hover:text-slate-900"></i> الإعدادات
                    </button>
                </div>
            </nav>

            <div class="p-4 border-t border-slate-100">
                <div id="user-profile-sidebar" class="bg-slate-50 rounded-xl p-3 flex items-center gap-3">
                    <!-- User content injected by JS -->
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content flex-1 flex flex-col min-h-screen relative w-full">
            
            <!-- Top Header -->
            <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-20 px-6 py-4 flex justify-between items-center no-print">
                <div class="flex items-center gap-4 lg:hidden">
                    <button onclick="document.querySelector('.sidebar').classList.toggle('active')" class="w-10 h-10 bg-white border border-slate-200 rounded-xl flex items-center justify-center text-slate-600 shadow-sm">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="font-bold text-slate-800">مدير المدرسة</h1>
                </div>
                <div class="hidden lg:block">
                     <h2 id="page-title" class="text-xl font-bold text-slate-800">لوحة التحكم</h2>
                </div>

                <div class="flex items-center gap-3">
                     <div class="bg-slate-100 px-4 py-2 rounded-xl border border-slate-200 flex items-center gap-2">
                        <i class="fas fa-clock text-slate-400"></i>
                        <span id="clockDisplay" class="font-mono font-bold text-slate-700 dir-ltr">00:00:00</span>
                    </div>
                    <div id="cloudStatusIndicator"></div>
                </div>
            </header>

            <!-- Views Container -->
            <div class="p-4 md:p-8 space-y-8 flex-1 overflow-y-auto pb-24 lg:pb-8">

                <!-- View: Dashboard (Now) -->
                <section id="view-now" class="fade-in space-y-6">
                    <!-- Header Card -->
                    <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl p-8 text-white shadow-xl shadow-blue-200 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full -mr-16 -mt-16 blur-3xl"></div>
                        <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-6">
                            <div>
                                <h2 class="text-3xl font-bold mb-2">متابعة اليوم الدراسي</h2>
                                <p class="text-blue-100 opacity-90">نظرة شاملة على سير الحصص والمناوبة الآن.</p>
                            </div>
                            <div id="currentPeriodInfo" class="bg-white/10 backdrop-blur-md border border-white/20 px-6 py-4 rounded-2xl text-center min-w-[180px]">
                                <!-- Injected by JS -->
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                            <i class="fas fa-chalkboard text-blue-500"></i> الحصص القائمة
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="window.app.simulateRandomPeriod()" class="bg-white border border-slate-200 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-slate-50 transition">محاكاة</button>
                            <button onclick="window.app.resetTimeToReal()" class="bg-white border border-slate-200 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-slate-50 transition">الوقت الفعلي</button>
                        </div>
                    </div>

                    <div id="activeClassesGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                        <!-- Classes Cards -->
                    </div>

                    <!-- Duty Widget -->
                    <div id="dailyDutyWidget" class="mt-8 border-t border-slate-200 pt-8 hidden-view">
                         <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2 mb-4">
                            <i class="fas fa-user-shield text-amber-500"></i> مناوبة اليوم
                        </h3>
                        <div id="dailyDutyGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    </div>
                </section>

                <!-- View: Teachers -->
                <section id="view-teachers" class="fade-in space-y-6 hidden-view">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                         <div class="relative w-full md:w-96 group">
                            <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition"></i>
                            <input type="text" id="teacherSearch" onkeyup="window.app.renderTeachers()" placeholder="بحث باسم المعلم أو التخصص..." class="w-full pr-10 pl-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-blue-500 outline-none transition-all">
                        </div>
                        <div class="flex gap-2">
                             <button onclick="document.getElementById('excelInput').click()" class="bg-emerald-50 text-emerald-600 hover:bg-emerald-100 px-4 py-2 rounded-xl font-bold text-sm transition flex items-center gap-2 border border-emerald-100">
                                <i class="fas fa-file-excel"></i> استيراد
                            </button>
                        </div>
                    </div>
                    <div id="teachersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
                </section>

                <!-- View: Supervision Hub -->
                <section id="view-supervision-hub" class="fade-in space-y-6 hidden-view">
                    <div class="grid md:grid-cols-3 gap-6">
                        <!-- Stat Cards -->
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden group hover:-translate-y-1 transition duration-300">
                            <div class="absolute right-0 top-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-blue-100"></div>
                            <div class="relative z-10">
                                <p class="text-slate-500 text-sm font-medium mb-1">إجمالي الزيارات</p>
                                <h3 class="text-4xl font-extrabold text-slate-800" id="hubTotalVisits">0</h3>
                                <div class="mt-4 flex items-center gap-2 text-blue-600 text-xs font-bold cursor-pointer" onclick="window.app.setView('supervision-history')">
                                    <span>عرض السجل</span> <i class="fas fa-arrow-left"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden group hover:-translate-y-1 transition duration-300">
                            <div class="absolute right-0 top-0 w-24 h-24 bg-green-50 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-green-100"></div>
                            <div class="relative z-10">
                                <p class="text-slate-500 text-sm font-medium mb-1">متوسط الأداء</p>
                                <h3 class="text-4xl font-extrabold text-slate-800" id="hubAvgScore">0%</h3>
                                <div class="mt-4 flex items-center gap-2 text-green-600 text-xs font-bold cursor-pointer" onclick="window.app.setView('reports')">
                                    <span>التقارير التفصيلية</span> <i class="fas fa-arrow-left"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-indigo-600 to-purple-700 p-6 rounded-2xl shadow-lg text-white flex flex-col justify-center items-center text-center">
                            <h3 class="font-bold text-xl mb-2">زيارة صفية جديدة</h3>
                            <p class="text-indigo-200 text-xs mb-4">ابدأ تقييم جديد باستخدام المعايير الذكية</p>
                            <button onclick="window.app.startSupervision()" class="bg-white text-indigo-700 px-6 py-3 rounded-xl font-bold hover:bg-indigo-50 transition w-full shadow-lg">
                                <i class="fas fa-plus-circle"></i> بدء زيارة
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-bold text-slate-800">آخر النشاطات الإشرافية</h3>
                        </div>
                        <div id="hubRecentList" class="divide-y divide-slate-50"></div>
                    </div>
                </section>

                <!-- View: Supervision Form -->
                <section id="view-supervision" class="fade-in hidden-view max-w-4xl mx-auto">
                    <div class="mb-4 flex items-center gap-2 text-slate-500 text-sm cursor-pointer hover:text-blue-600 transition" onclick="window.app.setView('supervision-hub')">
                        <i class="fas fa-arrow-right"></i> عودة
                    </div>
                    
                    <div class="bg-white rounded-3xl shadow-lg border border-slate-200 overflow-hidden">
                        <div class="bg-slate-50 p-8 border-b border-slate-200">
                            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
                                <span class="w-10 h-10 bg-indigo-600 text-white rounded-lg flex items-center justify-center text-lg"><i class="fas fa-clipboard-check"></i></span>
                                نموذج الزيارة الصفية
                            </h2>
                        </div>
                        
                        <div class="p-8 space-y-8">
                            <!-- Basic Info -->
                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-slate-500 uppercase">المعلم</label>
                                    <select id="supTeacherSelect" onchange="window.app.onTeacherSelectChange()" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-200 outline-none transition font-bold"></select>
                                    <input type="text" id="supTeacherName" readonly class="hidden w-full bg-slate-100 border border-slate-200 rounded-xl p-3 font-bold text-slate-500">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-slate-500 uppercase">عنوان الدرس</label>
                                    <input type="text" id="supLessonTopic" placeholder="موضوع الدرس..." class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-200 outline-none transition">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-slate-500 uppercase">الصف</label>
                                    <input type="text" id="supClassName" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-200 outline-none transition">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-slate-500 uppercase">التخصص</label>
                                    <select id="supSpecialization" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-200 outline-none transition"></select>
                                </div>
                            </div>

                            <!-- Criteria -->
                            <div class="border-t border-slate-100 pt-6">
                                <h3 class="font-bold text-slate-800 mb-4">بنود التقييم</h3>
                                <div id="supervisionCriteriaList" class="space-y-6">
                                    <!-- Dynamic Items -->
                                </div>
                            </div>

                            <button onclick="window.app.generateReport()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 transition transform active:scale-95 flex items-center justify-center gap-2">
                                <i class="fas fa-wand-magic-sparkles"></i> إنشاء التقرير
                            </button>
                        </div>
                    </div>
                </section>

                <!-- View: Report Result (Paper) -->
                <section id="view-supervision-report" class="fade-in hidden-view">
                    <div class="flex justify-between mb-4 max-w-4xl mx-auto no-print">
                         <button onclick="window.app.setView('supervision')" class="text-slate-500 hover:text-slate-800 font-bold text-sm"><i class="fas fa-arrow-right"></i> تعديل</button>
                         <div class="flex gap-2">
                            <button onclick="window.app.saveVisit()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-emerald-700 transition shadow-lg shadow-emerald-200"><i class="fas fa-save"></i> حفظ</button>
                            <button onclick="window.print()" class="bg-slate-800 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-slate-900 transition"><i class="fas fa-print"></i> طباعة</button>
                         </div>
                    </div>

                    <div class="report-paper rounded-none md:rounded-sm">
                        <!-- Header -->
                        <div class="flex justify-between items-end border-b-2 border-slate-900 pb-6 mb-8">
                            <div>
                                <h1 class="text-3xl font-extrabold text-slate-900 mb-1">تقرير زيارة فنية</h1>
                                <p class="text-slate-500 text-sm">نظام الإدارة المدرسية الذكي</p>
                            </div>
                            <div class="text-left text-sm font-mono text-slate-500" id="reportDate"></div>
                        </div>

                        <!-- Meta Data -->
                        <div class="bg-slate-50 border border-slate-200 p-6 rounded-xl mb-8 grid grid-cols-2 gap-y-4 gap-x-8">
                            <div><span class="block text-xs text-slate-400 uppercase font-bold mb-1">المعلم</span><span id="repTeacherName" class="font-bold text-lg text-slate-800"></span></div>
                            <div><span class="block text-xs text-slate-400 uppercase font-bold mb-1">التخصص</span><span id="repSpecialization" class="font-bold text-slate-800"></span></div>
                            <div><span class="block text-xs text-slate-400 uppercase font-bold mb-1">الصف</span><span id="repClassName" class="font-bold text-slate-800"></span></div>
                            <div><span class="block text-xs text-slate-400 uppercase font-bold mb-1">عنوان الدرس</span><span id="repLessonTopic" class="font-bold text-slate-800"></span></div>
                        </div>

                        <!-- Ratings Table -->
                        <div class="mb-8">
                            <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2"><i class="fas fa-list-ol text-blue-500"></i> تفاصيل الأداء</h3>
                            <table class="w-full text-sm border-collapse">
                                <thead class="bg-slate-100 text-slate-600">
                                    <tr>
                                        <th class="p-3 text-right border border-slate-200 rounded-tr-lg">المعيار</th>
                                        <th class="p-3 text-center w-20 border border-slate-200">الدرجة</th>
                                        <th class="p-3 text-right border border-slate-200 rounded-tl-lg">الملاحظات والتوصيات</th>
                                    </tr>
                                </thead>
                                <tbody id="repDetailsBody"></tbody>
                            </table>
                        </div>

                        <!-- AI Section -->
                        <div class="relative bg-white border border-indigo-100 rounded-xl p-6 shadow-[0_0_30px_rgba(99,102,241,0.05)]">
                            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 border-b border-indigo-50 pb-3 gap-3">
                                <h3 class="font-bold text-indigo-900 flex items-center gap-2">
                                    <i class="fas fa-robot text-indigo-500"></i> التحليل النوعي الذكي
                                </h3>
                                <div class="flex gap-2 no-print">
                                    <button onclick="window.app.copyToClipboardPrompt()" id="btnCopyPrompt" class="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-full text-xs font-bold hover:bg-slate-50 transition flex items-center gap-2">
                                        <i class="fas fa-copy"></i> نسخ للأداة الخارجية
                                    </button>
                                    <button onclick="window.app.enhanceReportWithAI()" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-4 py-2 rounded-full text-xs font-bold hover:shadow-lg transition flex items-center gap-2">
                                        <i class="fas fa-sparkles"></i> تحسين تلقائي
                                    </button>
                                </div>
                            </div>
                            
                            <div id="aiReportContent" class="text-slate-700 leading-relaxed text-sm min-h-[100px]">
                                سيظهر هنا التحليل الذكي للتوصيات ونقاط القوة والضعف...
                            </div>

                            <!-- Loader -->
                            <div id="aiLoadingOverlay" class="absolute inset-0 bg-white/90 backdrop-blur-sm hidden-view flex flex-col items-center justify-center z-10 rounded-xl">
                                <div class="spinner mb-3"></div>
                                <span class="text-sm font-bold text-indigo-800">جاري الاتصال بالذكاء الاصطناعي...</span>
                                <span class="text-xs text-slate-500">Gemini 1.5 Flash</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- View: Reports Data -->
                <section id="view-reports" class="fade-in hidden-view">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h2 class="font-bold text-lg text-slate-800">سجل الأداء العام</h2>
                            <button onclick="window.app.exportReports()" class="text-emerald-600 hover:bg-emerald-50 px-3 py-1.5 rounded-lg font-bold text-sm transition"><i class="fas fa-download"></i> تصدير</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right">
                                <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold">
                                    <tr>
                                        <th class="p-4">المعلم</th>
                                        <th class="p-4 text-center">التقييم</th>
                                        <th class="p-4 text-center">التصنيف</th>
                                        <th class="p-4 text-center">رقم الهاتف</th>
                                    </tr>
                                </thead>
                                <tbody id="reportsBody" class="divide-y divide-slate-50 text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- View: Duty -->
                <section id="view-duty" class="fade-in hidden-view">
                     <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h2 class="font-bold text-lg text-slate-800">جدول المناوبة</h2>
                             <button onclick="window.app.addDutyLocationPrompt()" class="bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1.5 rounded-lg font-bold text-xs transition"><i class="fas fa-plus"></i> موقع</button>
                        </div>
                         <div class="overflow-x-auto">
                            <table class="w-full text-right">
                                <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold">
                                    <tr>
                                        <th class="p-4 w-32 border-l border-slate-200 bg-slate-100 sticky right-0">اليوم</th>
                                        <tr id="dutyHeaderRow"></tr>
                                    </tr>
                                </thead>
                                <tbody id="dutyBody" class="divide-y divide-slate-100 text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

            </div>
        </main>

        <!-- Mobile Bottom Nav -->
        <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 z-40 pb-safe shadow-[0_-5px_15px_rgba(0,0,0,0.05)] no-print">
            <div class="flex justify-around items-center h-16">
                <button onclick="window.app.setView('now')" class="flex-1 flex flex-col items-center justify-center text-slate-400 hover:text-blue-600 active:text-blue-600 gap-1">
                    <i class="fas fa-clock text-xl"></i>
                    <span class="text-[10px] font-bold">الرئيسية</span>
                </button>
                <button onclick="window.app.setView('teachers')" class="flex-1 flex flex-col items-center justify-center text-slate-400 hover:text-blue-600 active:text-blue-600 gap-1">
                    <i class="fas fa-users text-xl"></i>
                    <span class="text-[10px] font-bold">المعلمين</span>
                </button>
                <div class="relative -top-5">
                    <button onclick="window.app.setView('supervision-hub')" class="w-14 h-14 bg-blue-600 text-white rounded-full flex items-center justify-center shadow-lg shadow-blue-300 transform active:scale-95 transition">
                        <i class="fas fa-plus text-xl"></i>
                    </button>
                </div>
                <button onclick="window.app.setView('reports')" class="flex-1 flex flex-col items-center justify-center text-slate-400 hover:text-blue-600 active:text-blue-600 gap-1">
                    <i class="fas fa-chart-bar text-xl"></i>
                    <span class="text-[10px] font-bold">التقارير</span>
                </button>
                <button onclick="window.app.openSettings()" class="flex-1 flex flex-col items-center justify-center text-slate-400 hover:text-slate-800 gap-1">
                    <i class="fas fa-cog text-xl"></i>
                    <span class="text-[10px] font-bold">الإعدادات</span>
                </button>
            </div>
        </nav>

    </div>

    <!-- Modals -->
    
    <!-- Action Modal -->
    <div id="modal-action" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden-view">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="window.app.closeModal('modal-action')"></div>
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden relative z-10 transform transition-all scale-100">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl font-bold border border-blue-100 shadow-sm">
                    <span id="actionModalIcon">?</span>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-1" id="actionModalTitle">اسم المعلم</h3>
                <p class="text-slate-500 text-sm mb-6" id="actionModalSubtitle">الإجراء المطلوب</p>
                
                <div class="space-y-3">
                    <button id="btn-evaluate" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200 transition">
                        <i class="fas fa-clipboard-check"></i> تقييم زيارة
                    </button>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="window.app.sendWhatsApp('summon')" class="bg-emerald-50 text-emerald-700 border border-emerald-100 py-3 rounded-xl font-bold hover:bg-emerald-100 transition">
                            <i class="fab fa-whatsapp"></i> استدعاء
                        </button>
                        <button id="btn-remind" onclick="window.app.sendWhatsApp('remind')" class="bg-indigo-50 text-indigo-700 border border-indigo-100 py-3 rounded-xl font-bold hover:bg-indigo-100 transition">
                            <i class="fas fa-bell"></i> تذكير
                        </button>
                    </div>
                </div>
                
                <div class="mt-6 pt-6 border-t border-slate-100 text-left">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-3">تسجيل مخالفة سريعة</p>
                    <div id="violationButtonsContainer" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
            <div class="bg-slate-50 p-4 border-t border-slate-100 text-center">
                <button onclick="window.app.closeModal('modal-action')" class="text-slate-400 hover:text-slate-600 text-sm font-bold">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="modal-error" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden-view">
        <div class="absolute inset-0 bg-red-900/40 backdrop-blur-sm" onclick="window.app.closeModal('modal-error')"></div>
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative z-10 animate-fade-in border border-red-100">
            <div class="bg-red-50 p-6 flex items-start gap-4">
                <div class="text-red-500 text-3xl"><i class="fas fa-exclamation-circle"></i></div>
                <div>
                    <h3 class="text-lg font-bold text-red-800" id="errorTitle">خطأ</h3>
                    <p class="text-red-600 text-sm mt-1" id="errorMessage">تفاصيل الخطأ</p>
                </div>
            </div>
            <div class="p-6 bg-slate-50 border-t border-slate-100">
                <p class="text-xs font-mono bg-slate-800 text-green-400 p-3 rounded-lg overflow-x-auto mb-4" id="errorDebug">Raw Error Code</p>
                <button onclick="window.app.closeModal('modal-error')" class="w-full bg-white border border-slate-300 text-slate-700 font-bold py-3 rounded-xl hover:bg-slate-50">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="modal-settings" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden-view">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="window.app.closeModal('modal-settings')"></div>
        <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl relative z-10 flex flex-col max-h-[85vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center shrink-0">
                <h3 class="text-xl font-bold text-slate-800">الإعدادات</h3>
                <button onclick="window.app.closeModal('modal-settings')" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center hover:bg-slate-200"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-8 custom-scrollbar">
                
                <!-- Section: Violations -->
                <div class="space-y-4">
                     <div class="flex items-center justify-between pb-2 border-b border-slate-100">
                        <h4 class="font-bold text-slate-700 text-sm uppercase tracking-wide">إدارة المخالفات</h4>
                        <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded-full">تخصيص النقاط</span>
                    </div>

                    <!-- Add New -->
                    <div class="flex gap-2 bg-slate-50 p-2 rounded-xl border border-slate-200 items-end">
                        <div class="flex-1">
                            <input type="text" id="settingNewVioLabel" placeholder="اسم المخالفة (مثلاً: عدم تحضير)" class="w-full text-sm p-2 rounded-lg border border-slate-200 focus:border-blue-500 outline-none bg-white">
                        </div>
                        <div class="w-20">
                            <input type="number" id="settingNewVioPoints" value="5" class="w-full text-sm p-2 rounded-lg border border-slate-200 focus:border-blue-500 outline-none bg-white text-center">
                        </div>
                        <button onclick="window.app.addViolation()" class="bg-blue-600 hover:bg-blue-700 text-white w-10 h-10 rounded-lg flex items-center justify-center transition shadow-sm">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>

                    <!-- List -->
                    <div id="settingsViolationsList" class="space-y-2 max-h-48 overflow-y-auto pr-1">
                        <!-- Dynamic Content -->
                    </div>
                </div>

                <!-- Section: Data Management -->
                <div class="space-y-4">
                    <h4 class="font-bold text-slate-700 text-sm uppercase tracking-wide border-b pb-2">البيانات الأساسية</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 cursor-pointer hover:bg-blue-100 transition group" onclick="document.getElementById('xmlInput').click()">
                            <div class="flex justify-between items-start mb-2">
                                <i class="fas fa-calendar-alt text-blue-600 text-2xl group-hover:scale-110 transition"></i>
                                <i class="fas fa-upload text-blue-300"></i>
                            </div>
                            <div class="font-bold text-blue-900">جدول الحصص</div>
                            <div class="text-xs text-blue-700">ملف aSc Timetables (XML)</div>
                        </div>
                        
                        <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100 cursor-pointer hover:bg-emerald-100 transition group" onclick="document.getElementById('excelInput').click()">
                             <div class="flex justify-between items-start mb-2">
                                <i class="fas fa-users text-emerald-600 text-2xl group-hover:scale-110 transition"></i>
                                <i class="fas fa-upload text-emerald-300"></i>
                            </div>
                            <div class="font-bold text-emerald-900">بيانات المعلمين</div>
                            <div class="text-xs text-emerald-700">ملف Excel</div>
                        </div>

                        <div class="bg-purple-50 p-4 rounded-xl border border-purple-100 cursor-pointer hover:bg-purple-100 transition group md:col-span-2" onclick="document.getElementById('criteriaExcelInput').click()">
                             <div class="flex justify-between items-start mb-2">
                                <i class="fas fa-clipboard-list text-purple-600 text-2xl group-hover:scale-110 transition"></i>
                                <i class="fas fa-upload text-purple-300"></i>
                            </div>
                            <div class="font-bold text-purple-900">معايير التقييم (Excel)</div>
                            <div class="text-xs text-purple-700">تحديث بنود الزيارات</div>
                        </div>
                    </div>
                </div>
                
                 <!-- Dev Settings -->
                 <div class="space-y-2 bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold text-slate-500">رابط الدالة السحابية (Cloud Function)</label>
                        <button onclick="window.app.enableDevEdit()" class="text-xs text-blue-600 font-bold">تعديل</button>
                    </div>
                    <input type="text" id="settingCloudUrl" disabled class="w-full text-xs p-2 rounded border border-slate-300 bg-white font-mono dir-ltr">
                    <button onclick="window.app.saveDevSettings()" class="w-full bg-slate-800 text-white py-2 rounded-lg text-xs font-bold mt-2">حفظ التكوين</button>
                </div>

                <button onclick="window.app.deleteData()" class="w-full text-red-600 font-bold text-sm bg-red-50 hover:bg-red-100 py-4 rounded-xl border border-red-100 transition">
                    <i class="fas fa-trash-alt"></i> حذف جميع البيانات وإعادة تعيين
                </button>
            </div>
             <!-- Hidden Inputs -->
             <input type="file" id="xmlInput" accept=".xml" class="hidden" onchange="window.app.handleXml(event)">
             <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden" onchange="window.app.handleExcel(event)">
             <input type="file" id="criteriaExcelInput" accept=".xlsx, .xls" class="hidden" onchange="window.app.handleCriteriaExcel(event)">
        </div>
    </div>

    <script>
        class SchoolApp {
            constructor() {
                this.state = {
                    currentUser: null, teachers: [], periods: [], classes: {}, tasks: [], 
                    violationTypes: [{ id: 'late', label: 'تأخر', points: 5, icon: 'fa-clock' }, { id: 'absent', label: 'غياب', points: 15, icon: 'fa-user-slash' }],
                    specializations: ["لغة عربية", "رياضيات", "علوم", "لغة انجليزية", "تربية اسلامية"],
                    simulationOffset: 0, selectedTeacherId: null, selectedClassName: null, 
                    supervisionHistory: [], evaluationCriteria: [],
                    cloudFunctionUrl: "https://us-central1-school-9416e.cloudfunctions.net/improveText" // Default
                };
                
                this.db = null; this.auth = null;
                this.initFirebase();
                this.initCriteria();
                this.loadLocal();
                this.startClock();
            }

            initCriteria() {
                // Default Criteria if empty
                if(this.state.evaluationCriteria.length === 0) {
                    this.state.evaluationCriteria = [
                        { id: 1, title: "التمكن العلمي", items: { 1: {desc: "متمكن جداً", rec: "نشر الخبرة"}, 3: {desc: "متوسط", rec: "يحتاج اطلاع"}, 5: {desc: "ضعيف", rec: "خطة علاجية"} } },
                        { id: 2, title: "إدارة الصف", items: { 1: {desc: "ممتاز", rec: ""}, 5: {desc: "فوضى", rec: "ضبط انفعالي"} } }
                    ];
                }
            }

            initFirebase() {
                const firebaseConfig = { apiKey: "AIzaSyC4NddjijF29YNhowy4SqgRaMPn01oSSEg", authDomain: "school-9416e.firebaseapp.com", projectId: "school-9416e", storageBucket: "school-9416e.firebasestorage.app", messagingSenderId: "680872052240", appId: "1:680872052240:web:96d2e544166ab5f8096c95", measurementId: "G-5EBTV0MV83" };
                if (typeof firebase !== 'undefined' && !firebase.apps.length) firebase.initializeApp(firebaseConfig);
                if (typeof firebase !== 'undefined') {
                    this.db = firebase.firestore(); this.auth = firebase.auth();
                    this.auth.onAuthStateChanged(user => {
                        if (user) {
                            this.state.currentUser = user;
                            document.getElementById('login-view').classList.add('fade-out'); // Add fade out
                            setTimeout(() => {
                                document.getElementById('login-view').classList.add('hidden-view');
                                document.getElementById('app-view').classList.remove('hidden-view');
                            }, 300);
                            this.renderUserProfile();
                            this.loadCloudData();
                        }
                    });
                }
            }

            handleGoogleLogin() { 
                const provider = new firebase.auth.GoogleAuthProvider(); 
                this.auth.signInWithPopup(provider).catch(e => alert("خطأ في تسجيل الدخول: " + e.message)); 
            }
            
            skipLogin() { 
                document.getElementById('login-view').classList.add('hidden-view'); 
                document.getElementById('app-view').classList.remove('hidden-view');
                this.renderAll(); 
            }

            loadLocal() {
                const d = localStorage.getItem('school_data_pro');
                if(d) {
                    const parsed = JSON.parse(d);
                    this.state = { ...this.state, ...parsed };
                }
                // Apply cloud URL to input
                const input = document.getElementById('settingCloudUrl');
                if(input) input.value = this.state.cloudFunctionUrl;
            }

            saveLocal() {
                localStorage.setItem('school_data_pro', JSON.stringify(this.state));
            }

            loadCloudData() {
                if(!this.state.currentUser) return;
                this.updateCloudIndicator('loading');
                this.db.collection('users').doc(this.state.currentUser.uid).onSnapshot(doc => {
                    if(doc.exists) {
                        const data = doc.data();
                        // Merge fields safely
                        if(data.teachers) this.state.teachers = data.teachers;
                        if(data.periods) this.state.periods = data.periods;
                        if(data.classes) this.state.classes = data.classes;
                        if(data.supervisionHistory) this.state.supervisionHistory = data.supervisionHistory;
                        if(data.cloudFunctionUrl) this.state.cloudFunctionUrl = data.cloudFunctionUrl;
                        if(data.violationTypes) this.state.violationTypes = data.violationTypes;
                        if(data.evaluationCriteria) this.state.evaluationCriteria = data.evaluationCriteria;

                        this.saveLocal();
                        this.renderAll();
                        this.updateCloudIndicator('online');
                    } else {
                        this.updateCloudIndicator('online'); // New user
                    }
                });
            }

            async saveData() {
                this.saveLocal();
                if(!this.state.currentUser) return;
                this.updateCloudIndicator('saving');
                try {
                    await this.db.collection('users').doc(this.state.currentUser.uid).set({
                        teachers: this.state.teachers,
                        periods: this.state.periods,
                        classes: this.state.classes,
                        supervisionHistory: this.state.supervisionHistory,
                        cloudFunctionUrl: this.state.cloudFunctionUrl,
                        violationTypes: this.state.violationTypes,
                        evaluationCriteria: this.state.evaluationCriteria,
                        lastUpdate: new Date()
                    }, {merge: true});
                    this.updateCloudIndicator('online');
                } catch(e) {
                    console.error(e);
                    this.updateCloudIndicator('error');
                }
            }

            updateCloudIndicator(status) {
                const el = document.getElementById('cloudStatusIndicator');
                if(!el) return;
                if(status === 'online') el.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"></span>';
                if(status === 'saving') el.innerHTML = '<span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span>';
                if(status === 'error') el.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span>';
                if(status === 'loading') el.innerHTML = '<span class="w-2 h-2 rounded-full bg-blue-400 animate-ping"></span>';
            }

            startClock() {
                setInterval(() => {
                    const now = new Date(new Date().getTime() + this.state.simulationOffset);
                    document.getElementById('clockDisplay').innerText = now.toLocaleTimeString('en-US', {hour12: false});
                    if(this.currentView === 'now') this.renderCurrentPeriod(now);
                }, 1000);
            }

            // --- Navigation ---
            setView(viewId) {
                this.currentView = viewId;
                document.querySelectorAll('section').forEach(el => el.classList.add('hidden-view'));
                document.getElementById(`view-${viewId}`).classList.remove('hidden-view');
                
                // Update Nav States
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'bg-blue-50', 'text-blue-600'));
                const navBtn = document.getElementById(`nav-${viewId}`);
                if(navBtn) navBtn.classList.add('active', 'bg-blue-50', 'text-blue-600');
                
                // Update Titles
                const titles = { 'now': 'لوحة التحكم', 'teachers': 'سجل المعلمين', 'reports': 'التقارير والإحصاء', 'supervision-hub': 'مركز الإشراف', 'duty': 'جدول المناوبة' };
                document.getElementById('page-title').innerText = titles[viewId] || 'مدير المدرسة';

                // Render specific view data
                if(viewId === 'now') this.renderCurrentPeriod(new Date(new Date().getTime() + this.state.simulationOffset));
                if(viewId === 'teachers') this.renderTeachers();
                if(viewId === 'reports') this.renderReports();
                if(viewId === 'supervision-hub') this.renderHub();
                if(viewId === 'duty') this.renderDuty();
            }

            // --- Render Logic ---
            renderCurrentPeriod(now) {
                const grid = document.getElementById('activeClassesGrid');
                if(!grid) return;
                grid.innerHTML = '';
                
                if(!this.state.teachers.length) {
                    grid.innerHTML = `<div class="col-span-full text-center py-10 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl">لا توجد بيانات.. قم باستيراد جدول الحصص من الإعدادات</div>`;
                    return;
                }

                const currentMins = now.getHours() * 60 + now.getMinutes();
                const dayId = now.getDay() + 1;

                const currentPeriod = this.state.periods.find(p => {
                    const [sh, sm] = p.start.split(':').map(Number);
                    const [eh, em] = p.end.split(':').map(Number);
                    return currentMins >= (sh*60+sm) && currentMins <= (eh*60+em);
                });

                if(currentPeriod) {
                    document.getElementById('currentPeriodInfo').innerHTML = `<span class="font-bold text-lg text-white">الحصة ${currentPeriod.id}</span><br><span class="text-sm text-blue-100">${currentPeriod.start} - ${currentPeriod.end}</span>`;
                    
                    const active = this.state.teachers.filter(t => t.lessons.some(l => l.day == dayId && l.period == currentPeriod.id));
                    
                    if(active.length === 0) {
                        grid.innerHTML = `<div class="col-span-full text-center py-10 text-slate-400">لا توجد حصص مسجلة لهذه الفترة</div>`;
                    } else {
                        grid.innerHTML = active.map(t => {
                            const lesson = t.lessons.find(l => l.day == dayId && l.period == currentPeriod.id);
                            return `
                                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 border-t-4 border-t-indigo-500 hover:shadow-md transition">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-xs font-bold">${lesson.className}</span>
                                        <span class="text-[10px] text-slate-400">${t.score}%</span>
                                    </div>
                                    <h4 class="font-bold text-slate-700 text-sm mb-3 truncate">${t.name}</h4>
                                    <button onclick="window.app.openActionModal('${t.id}', '${lesson.className}')" class="w-full bg-slate-50 hover:bg-slate-100 text-slate-600 py-2 rounded-lg text-xs font-bold transition">إجراء سريع</button>
                                </div>
                            `;
                        }).join('');
                    }
                } else {
                    document.getElementById('currentPeriodInfo').innerHTML = `<span class="font-bold text-white">خارج الدوام</span>`;
                    grid.innerHTML = `<div class="col-span-full text-center py-10 text-slate-400">لا توجد حصة حالياً</div>`;
                }
            }

            renderTeachers() {
                const grid = document.getElementById('teachersGrid');
                if(!grid) return;
                const term = document.getElementById('teacherSearch')?.value.toLowerCase() || '';
                grid.innerHTML = this.state.teachers
                    .filter(t => t.name.toLowerCase().includes(term))
                    .sort((a,b) => a.name.localeCompare(b.name, 'ar'))
                    .map(t => `
                    <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition group">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center font-bold text-sm border border-slate-200">${t.name[0]}</div>
                                <div>
                                    <h4 class="font-bold text-slate-800 text-sm line-clamp-1">${t.name}</h4>
                                    <p class="text-[10px] text-slate-400">${t.phone || 'لا يوجد هاتف'}</p>
                                </div>
                            </div>
                            <span class="text-xs font-bold ${t.score < 80 ? 'text-red-500 bg-red-50' : 'text-green-500 bg-green-50'} px-2 py-1 rounded-lg">${t.score || 100}%</span>
                        </div>
                        <div class="flex gap-2 mt-2">
                             <button onclick="window.app.openActionModal('${t.id}')" class="flex-1 bg-slate-50 hover:bg-slate-100 text-slate-600 py-2 rounded-lg text-xs font-bold transition">خيارات</button>
                             <button onclick="window.open('https://wa.me/${t.phone}', '_blank')" class="w-8 h-8 flex items-center justify-center bg-emerald-50 text-emerald-600 rounded-lg hover:bg-emerald-100"><i class="fab fa-whatsapp"></i></button>
                        </div>
                    </div>`).join('');
            }
            
            // --- Handlers: Import Logic Restored ---
            
            handleXml(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(evt.target.result, "text/xml");
                    
                    const periods = Array.from(xmlDoc.getElementsByTagName('period')).map(p => ({
                        id: p.getAttribute('name'),
                        start: p.getAttribute('starttime'),
                        end: p.getAttribute('endtime')
                    }));

                    const teachersMap = {};
                    Array.from(xmlDoc.getElementsByTagName('teacher')).forEach(t => {
                        teachersMap[t.getAttribute('id')] = {
                            id: t.getAttribute('id'),
                            name: t.getAttribute('name'),
                            short: t.getAttribute('short'),
                            score: 100,
                            phone: "",
                            lessons: []
                        };
                    });
                    
                    const classesMap = {};
                    Array.from(xmlDoc.getElementsByTagName('class')).forEach(c => {
                        classesMap[c.getAttribute('id')] = c.getAttribute('name');
                    });
                    
                    Array.from(xmlDoc.getElementsByTagName('lesson')).forEach(l => {
                        const tIds = l.getAttribute('teacherids').split(',');
                        const cIds = l.getAttribute('classids').split(',');
                        const periodAttr = l.getAttribute('periods') || l.getAttribute('period'); // Some XMLs vary
                        if(!periodAttr) return; // Skip if no period info
                        
                        // Parse period string (e.g., "1,1001,1002")
                        // Usually format: day,period,day,period...
                        // Note: aSc XML structure for 'periods' attribute is complex. 
                        // Simplified Assumption: <lesson ... ><lesson_period id=".." period="1" day="1" /></lesson> OR extracting from cards.
                        // Let's check for <card> children which is standard aSc export.
                    });
                    
                    // Robust aSc Logic: Iterate Cards
                    Array.from(xmlDoc.getElementsByTagName('card')).forEach(card => {
                        const lessonId = card.getAttribute('lessonid');
                        const period = card.getAttribute('period');
                        const day = parseInt(card.getAttribute('day')) + 1; // 0-based to 1-based (Sunday=1)
                        
                        // Find lesson parent
                        const lessonNode = Array.from(xmlDoc.getElementsByTagName('lesson')).find(l => l.getAttribute('id') === lessonId);
                        if(lessonNode) {
                            const tIds = lessonNode.getAttribute('teacherids').split(',');
                            const cIds = lessonNode.getAttribute('classids').split(',');
                            
                            tIds.forEach(tid => {
                                if(teachersMap[tid]) {
                                    cIds.forEach(cid => {
                                        if(classesMap[cid]) {
                                            teachersMap[tid].lessons.push({
                                                day: day,
                                                period: parseInt(period),
                                                className: classesMap[cid]
                                            });
                                        }
                                    });
                                }
                            });
                        }
                    });

                    this.state.periods = periods;
                    this.state.teachers = Object.values(teachersMap);
                    this.state.classes = classesMap;
                    this.saveData();
                    this.renderAll();
                    alert('تم استيراد الجدول بنجاح!');
                };
                reader.readAsText(file);
                e.target.value = '';
            }

            handleExcel(e) {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const workbook = XLSX.read(evt.target.result, {type: 'binary'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    
                    let count = 0;
                    json.forEach(row => {
                        // Try to find teacher by name
                        const name = row['الاسم'] || row['name'] || row['Name'];
                        const phone = row['الهاتف'] || row['phone'] || row['Phone'];
                        
                        if(name) {
                            const teacher = this.state.teachers.find(t => t.name.includes(name) || name.includes(t.name));
                            if(teacher) {
                                teacher.phone = phone || '';
                                count++;
                            }
                        }
                    });
                    this.saveData();
                    this.renderTeachers();
                    alert(`تم تحديث بيانات ${count} معلم.`);
                };
                reader.readAsBinaryString(file);
                e.target.value = '';
            }

            handleCriteriaExcel(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const workbook = XLSX.read(evt.target.result, {type: 'binary'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    
                    // Expected Format: Title | 1-Desc | 1-Rec | 2-Desc | 2-Rec ... 
                    // Or simple vertical: ID, MainTitle, SubTitle, Level1, Rec1, Level2, Rec2...
                    
                    const newCriteria = [];
                    json.forEach((row, idx) => {
                        // Flexible Key Matching
                        const title = row['المعيار'] || row['المجال'] || row['Title'];
                        if(title) {
                            const criterion = {
                                id: idx + 1,
                                title: title,
                                items: {}
                            };
                            
                            // Map levels 1 to 5
                            [1, 2, 3, 4, 5].forEach(level => {
                                const desc = row[`وصف ${level}`] || row[`Desc ${level}`] || row[level];
                                const rec = row[`توصية ${level}`] || row[`Rec ${level}`] || "";
                                if(desc) {
                                    criterion.items[level] = { desc: desc, rec: rec };
                                }
                            });
                            
                            if(Object.keys(criterion.items).length > 0) {
                                newCriteria.push(criterion);
                            }
                        }
                    });

                    if(newCriteria.length > 0) {
                        this.state.evaluationCriteria = newCriteria;
                        this.saveData();
                        alert(`تم استيراد ${newCriteria.length} معيار تقييم بنجاح.`);
                    } else {
                        alert('لم يتم العثور على بيانات مطابقة. تأكد من أسماء الأعمدة (المعيار، وصف 1، توصية 1...).');
                    }
                };
                reader.readAsBinaryString(file);
                e.target.value = '';
            }

            // --- Other UI Logic ---
            openActionModal(tId, className = null) {
                const t = this.state.teachers.find(x => x.id === tId);
                if(!t) return;
                this.state.selectedTeacherId = tId;
                this.state.selectedClassName = className;
                
                document.getElementById('actionModalTitle').innerText = t.name;
                document.getElementById('actionModalSubtitle').innerText = className ? `حصة حالية: ${className}` : 'قائمة المعلمين';
                document.getElementById('actionModalIcon').innerText = t.name[0];
                
                // Violation buttons
                const vCont = document.getElementById('violationButtonsContainer');
                vCont.innerHTML = this.state.violationTypes.map(v => `
                    <button onclick="window.app.applyViolation('${v.id}')" class="bg-red-50 text-red-600 border border-red-100 px-3 py-2 rounded-lg text-xs font-bold hover:bg-red-100 transition flex items-center gap-1">
                        <i class="fas ${v.icon}"></i> ${v.label} (-${v.points})
                    </button>
                `).join('');

                // Setup evaluate button
                document.getElementById('btn-evaluate').onclick = () => {
                    this.startSupervision(tId);
                    this.closeModal('modal-action');
                };

                document.getElementById('modal-action').classList.remove('hidden-view');
            }

            closeModal(id) { document.getElementById(id).classList.add('hidden-view'); }
            
            // --- AI & Cloud Functions ---
            
            async enhanceReportWithAI() {
                const loader = document.getElementById('aiLoadingOverlay');
                const contentDiv = document.getElementById('aiReportContent');
                
                if (!this.state.cloudFunctionUrl) {
                    this.showError('إعدادات النظام ناقصة', 'لم يتم ضبط رابط Cloud Function. يرجى الذهاب للإعدادات.');
                    return;
                }

                // Gather Data
                const tName = document.getElementById('repTeacherName').innerText;
                const items = []; 
                document.querySelectorAll('#repDetailsBody tr').forEach(tr => {
                   const txt = tr.querySelector('td:last-child').innerText;
                   if(txt && txt.length > 5) items.push(txt);
                });
                
                const textPayload = `المعلم: ${tName}. الملاحظات الحالية: ${items.join('. ')}.`;

                loader.classList.remove('hidden-view');
                
                try {
                    const response = await fetch(this.state.cloudFunctionUrl, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.state.currentUser ? await this.state.currentUser.getIdToken() : ''}`
                        },
                        body: JSON.stringify({
                            text: textPayload,
                            gender: 'male', // Can be dynamic
                            specialization: document.getElementById('repSpecialization').innerText,
                            topic: document.getElementById('repLessonTopic').innerText
                        })
                    });

                    if (!response.ok) {
                        const errData = await response.json().catch(() => ({}));
                        throw { 
                            title: errData.error || 'Server Error', 
                            message: errData.message || response.statusText,
                            raw: errData.debug || errData.raw || 'No debug info'
                        };
                    }

                    const data = await response.json();
                    contentDiv.innerHTML = `<div class="ai-generated-content space-y-2 fade-in">${data.result}</div>`;

                } catch (error) {
                    console.error("AI Error:", error);
                    this.showError(
                        error.title || 'فشل الاتصال بالذكاء الاصطناعي', 
                        error.message || 'تأكد من الاتصال بالإنترنت.',
                        error.raw || error.toString()
                    );
                } finally {
                    loader.classList.add('hidden-view');
                }
            }

            async copyToClipboardPrompt() {
                const btn = document.getElementById('btnCopyPrompt');
                const originalText = btn.innerHTML;
                
                const tName = document.getElementById('repTeacherName').innerText;
                const spec = document.getElementById('repSpecialization').innerText;
                const topic = document.getElementById('repLessonTopic').innerText;
                const className = document.getElementById('repClassName').innerText;
                
                let notes = [];
                document.querySelectorAll('#repDetailsBody tr').forEach(tr => {
                    const criteria = tr.querySelector('td:first-child')?.innerText;
                    const note = tr.querySelector('td:last-child')?.innerText;
                    if(note && note.length > 2) notes.push(`- ${criteria}: ${note}`);
                });
                
                if(notes.length === 0) return alert('لا توجد ملاحظات لنسخها');
                
                const prompt = `
أعمل كموجه فني تربوي خبير.
قم بإعادة صياغة تقرير الزيارة التالي بشكل احترافي، تربوي، ومحفز.
البيانات الأساسية:
- المعلم: ${tName}
- التخصص: ${spec}
- الصف: ${className}
- عنوان الدرس: ${topic}

الملاحظات الأولية التي تم رصدها:
${notes.join('\n')}

المطلوب:
صياغة تقرير زيارة يتضمن نقاط القوة، وفرص التحسين، وتوصيات عملية قابلة للتطبيق، بصياغة مهنية راقية.
                `;
                
                try {
                    await navigator.clipboard.writeText(prompt);
                    btn.innerHTML = '<i class="fas fa-check"></i> تم النسخ!';
                    btn.classList.add('bg-green-50', 'text-green-600', 'border-green-200');
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('bg-green-50', 'text-green-600', 'border-green-200');
                    }, 2000);
                } catch(err) {
                    alert('تعذر النسخ تلقائياً. يرجى التحديد والنسخ يدوياً.');
                    console.error(err);
                }
            }

            showError(title, msg, debug) {
                document.getElementById('errorTitle').innerText = title;
                document.getElementById('errorMessage').innerText = msg;
                document.getElementById('errorDebug').innerText = debug || '';
                document.getElementById('modal-error').classList.remove('hidden-view');
            }

            // --- Settings ---
            openSettings() { 
                this.renderSettingsViolations();
                document.getElementById('modal-settings').classList.remove('hidden-view'); 
            }
            
            renderSettingsViolations() {
                const list = document.getElementById('settingsViolationsList');
                if(!list) return;
                if(this.state.violationTypes.length === 0) {
                    list.innerHTML = '<div class="text-center text-slate-400 text-xs py-2">لا توجد مخالفات مضافة</div>';
                    return;
                }
                list.innerHTML = this.state.violationTypes.map(v => `
                    <div class="flex items-center justify-between bg-white p-3 rounded-lg border border-slate-100 shadow-sm hover:border-red-100 transition group">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center border border-slate-100 group-hover:text-red-500 transition">
                                <i class="fas ${v.icon}"></i>
                            </div>
                            <span class="font-bold text-sm text-slate-700">${v.label}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="bg-red-50 text-red-600 text-xs font-bold px-2 py-1 rounded border border-red-100">-${v.points}</span>
                            <button onclick="window.app.removeViolation('${v.id}')" class="text-slate-300 hover:text-red-500 transition px-2">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            addViolation() {
                const labelInp = document.getElementById('settingNewVioLabel');
                const pointsInp = document.getElementById('settingNewVioPoints');
                const label = labelInp.value;
                const points = parseInt(pointsInp.value);
                
                if(!label) return alert('الرجاء إدخال اسم المخالفة');
                
                const newV = {
                    id: 'vio_' + Date.now(),
                    label: label,
                    points: points || 5,
                    icon: 'fa-exclamation-circle'
                };
                
                this.state.violationTypes.push(newV);
                this.saveData();
                this.renderSettingsViolations();
                
                // Reset inputs
                labelInp.value = '';
                pointsInp.value = '5';
            }

            removeViolation(id) {
                if(confirm('هل أنت متأكد من حذف هذا النوع من المخالفات؟')) {
                    this.state.violationTypes = this.state.violationTypes.filter(v => v.id !== id);
                    this.saveData();
                    this.renderSettingsViolations();
                }
            }

            enableDevEdit() { document.getElementById('settingCloudUrl').disabled = false; document.getElementById('settingCloudUrl').focus(); }
            saveDevSettings() {
                this.state.cloudFunctionUrl = document.getElementById('settingCloudUrl').value;
                this.saveData();
                alert('تم حفظ الإعدادات');
            }
            
            // --- Helpers ---
            applyViolation(vId) {
                const v = this.state.violationTypes.find(x => x.id === vId);
                const t = this.state.teachers.find(x => x.id === this.state.selectedTeacherId);
                if(t && v) {
                    if(confirm(`خصم ${v.points} درجات من ${t.name}؟`)) {
                        t.score = Math.max(0, (t.score || 100) - v.points);
                        this.saveData();
                        this.closeModal('modal-action');
                        this.renderAll();
                    }
                }
            }
            
            renderAll() {
                if(this.currentView) this.setView(this.currentView);
            }
        }

        // Init
        window.app = new SchoolApp();
    </script>
</body>
</html>